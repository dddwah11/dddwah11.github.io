{"meta":{"title":"å°åˆ˜","subtitle":"å°åˆ˜","description":"å°åˆ˜çš„ä¸ªäººåšå®¢","author":"61åˆ†","url":"https://dddwah11.github.io","root":"/"},"pages":[{"title":"about","date":"2025-05-24T06:56:13.000Z","updated":"2025-05-24T07:00:20.452Z","comments":false,"path":"about/index.html","permalink":"https://dddwah11.github.io/about/index.html","excerpt":"","text":"æ¬¢è¿æ¥åˆ°å°åˆ˜çš„åšå®¢ï¼Œæ¯å¤©è¿›æ­¥ä¸€ç‚¹ç‚¹ğŸ“"}],"posts":[{"title":"æµ‹è¯•æ–‡ç« ","slug":"æµ‹è¯•æ–‡ç« ","date":"2025-05-24T07:46:22.000Z","updated":"2025-05-24T08:07:04.929Z","comments":true,"path":"2025/05/24/æµ‹è¯•æ–‡ç« /","link":"","permalink":"https://dddwah11.github.io/2025/05/24/%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0/","excerpt":"","text":"æµ‹è¯•æ–‡ç« ","categories":[],"tags":[]},{"title":"","slug":"å°åˆ˜çš„åšå®¢","date":"2025-05-21T03:32:02.888Z","updated":"2025-05-21T03:35:14.295Z","comments":true,"path":"2025/05/21/å°åˆ˜çš„åšå®¢/","link":"","permalink":"https://dddwah11.github.io/2025/05/21/%E5%B0%8F%E5%88%98%E7%9A%84%E5%8D%9A%E5%AE%A2/","excerpt":"","text":"æµ‹è¯•","categories":[],"tags":[]},{"title":"","slug":"èµ„æºæ–‡æ¡£","date":"2025-05-21T03:23:59.320Z","updated":"2022-06-09T14:50:33.093Z","comments":true,"path":"2025/05/21/èµ„æºæ–‡æ¡£/","link":"","permalink":"https://dddwah11.github.io/2025/05/21/%E8%B5%84%E6%BA%90%E6%96%87%E6%A1%A3/","excerpt":"","text":"Vuecdn12&lt;script src=&quot;https://unpkg.com/vue@3&quot;&gt;&lt;/script&gt;--vue3&lt;script src=&quot;https://unpkg.com/vue-router@4&quot;&gt;&lt;/script&gt;--router vue cli1npm install -g @vue/cli Typescript1npm install -g typescript åˆ›å»ºä¸€ä¸ªvueé¡¹ç›®1vue create project-name Vite123456789# npm 6.x$ npm init vite@latest &lt;project-name&gt; --template vue# npm 7+ï¼Œéœ€è¦åŠ ä¸Šé¢å¤–çš„åŒçŸ­æ¨ªçº¿$ npm init vite@latest &lt;project-name&gt; -- --template vue$ cd &lt;project-name&gt;$ npm install$ npm run serve/dev axios1npm install axios 1import axios from &#x27;axios&#x27; vue2æ‰¾åˆ°ä¸‹é¢çš„request.jsæ–¹æ³• main.js 12345678910import request from &#x27;@/utils/request&#x27;Vue.config.productionTip = falseVue.prototype.request=requestnew Vue(&#123; el: &#x27;#app&#x27;, render: h =&gt; h(App)&#125;).$mount(&#x27;#app&#x27;); vue-routervue3 1npm install vue-router@4 -s å®‰è£…åœ¨æœ¬åœ°é¡¹ç›®ï¼Œåœ¨packge.jsonä¸­ vue2 1npm install --legacy-peer-deps vue-router@3.5.2 ä½¿ç”¨cdn 12345678910111213141516&lt;script src=&quot;https://unpkg.com/vue@3&quot;&gt;&lt;/script&gt;&lt;script src=&quot;https://unpkg.com/vue-router@4&quot;&gt;&lt;/script&gt;&lt;div id=&quot;app&quot;&gt; &lt;h1&gt;Hello App!&lt;/h1&gt; &lt;p&gt; &lt;!-- use the router-link component for navigation. --&gt; &lt;!-- specify the link by passing the `to` prop. --&gt; &lt;!-- `&lt;router-link&gt;` will render an `&lt;a&gt;` tag with the correct `href` attribute --&gt; &lt;router-link to=&quot;/&quot;&gt;Go to Home&lt;/router-link&gt; &lt;router-link to=&quot;/about&quot;&gt;Go to About&lt;/router-link&gt; &lt;/p&gt; &lt;!-- route outlet --&gt; &lt;!-- component matched by the route will render here --&gt; &lt;router-view&gt;&lt;/router-view&gt;&lt;/div&gt; Vue3main.jså¼•å…¥ 12import router from &#x27;@/router&#x27;app.use(router) router&#x2F;index.jsä¸­ 12345678910111213141516import &#123; createRouter, createWebHashHistory &#125; from &#x27;vue-router&#x27;const routes = [ &#123; path: &#x27;&#x27;, name: &#x27;&#x27;, component: () =&gt; import(&#x27;&#x27;) &#125;,]const router = createRouter(&#123; // 4. å†…éƒ¨æä¾›äº† history æ¨¡å¼çš„å®ç°ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨ hash æ¨¡å¼ã€‚ history: createWebHashHistory(), routes, // `routes: routes` çš„ç¼©å†™&#125;)export default router Vue2main.js 12345678910import router from &#x27;@/router&#x27;Vue.config.productionTip = falsenew Vue(&#123; el: &#x27;#app&#x27;, router, render: h =&gt; h(App)&#125;).$mount(&#x27;#app&#x27;); index.js 123456789101112131415161718192021222324252627import Vue from &#x27;vue&#x27;import VueRouter from &#x27;vue-router&#x27;Vue.use(VueRouter)const routes = [ &#123; path: &#x27;/&#x27;, name: &#x27;&#x27;, component: () =&gt; import(&#x27;xxx&#x27;), chilren: [ &#123; path: &#x27;/&#x27;, name: &#x27;&#x27;, component: () =&gt; import(&#x27;xxx&#x27;) &#125;, ] &#125;, ]const router = new VueRouter(&#123; routes&#125;)export default router æŠ¥é”™error Component name â€œAboutâ€ should always be multi-word vue&#x2F;multi-word-component-names åœ¨vue.config.jsæ–‡ä»¶ä¸­æ·»åŠ  12345const &#123; defineConfig &#125; = require(&#x27;@vue/cli-service&#x27;)module.exports = defineConfig(&#123; transpileDependencies: true, lintOnSave:false&#125;) Uncaught (in promise) NavigationDuplicated: Avoided redundant navigation to current location 1234567891011121314import VueRouter from &quot;vue-router&quot;;//pushconst VueRouterPush = VueRouter.prototype.pushVueRouter.prototype.push = function push (to) &#123; return VueRouterPush.call(this, to).catch(err =&gt; err)&#125;//replaceconst VueRouterReplace = VueRouter.prototype.replaceVueRouter.prototype.replace = function replace (to) &#123; return VueRouterReplace.call(this, to).catch(err =&gt; err)&#125; npmä½¿ç”¨npm6 12npx -p npm@6 npm i --legacy-peer-depsnpm i --legacy-peer-deps Vuexvue3 1npm install vuex@next --save vue2 1npm install vuex@3.6.2 --save main.jsä¸­å¼•å…¥ 12import store from &#x27;@/store&#x27;app.use(store) store&#x2F;index.jsä¸­ 12345678910111213141516import &#123; createStore &#125; from &#x27;vuex&#x27;// åˆ›å»ºä¸€ä¸ªæ–°çš„ store å®ä¾‹const store = createStore(&#123; state () &#123; return &#123; count: 0 &#125; &#125;, mutations: &#123; increment (state) &#123; state.count++ &#125; &#125;&#125;) SASSå®‰è£…loader123npm install -g sassnpm install --save-dev sass-loadercnpm install node-sass swiper1npm install swiper@3 --save-dev main.jsä¸­å¼•å…¥ 1234import &#x27;swiper/dist/css/swiper.min.css&#x27;import &#x27;swiper/dist/js/swiper.min&#x27;Vue.config.productionTip = false ä¾‹å­ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657&lt;template&gt; &lt;div&gt; &lt;swiper :options=&quot;swiperOption&quot; ref=&quot;mySwiper&quot;&gt; &lt;swiper-slide :key=&quot;i&quot; v-for=&quot;(item, i) in imgList&quot; &gt; &lt;img :src=&quot;item.src&quot; class=&quot;home_swiper_img&quot; /&gt; &lt;/swiper-slide&gt; &lt;/swiper&gt; &lt;/div&gt;&lt;/template&gt; &lt;script&gt;import &#123; Swiper, SwiperSlide &#125; from &quot;vue-awesome-swiper&quot;;import SwiperCore, &#123; Autoplay,EffectCube&#125; from &#x27;swiper&#x27;;SwiperCore.use([Autoplay,EffectCube]); export default &#123; data() &#123; return &#123; imgList: [ &#123; src: require(&quot;../assets/timg.jpg&quot;)&#125;, &#123; src: require(&quot;../assets/timg.jpg&quot;)&#125; ], swiperOption: &#123; effect: &#x27;cube&#x27;, grabCursor: true, loop: true, autoplay: &#123; delay: 2000, disableOnInteraction: false, &#125;, coverflowEffect: &#123; rotate: 0, // æ—‹è½¬çš„è§’åº¦ stretch: 100, // æ‹‰ä¼¸ å›¾ç‰‡é—´å·¦å³çš„é—´è·å’Œå¯†é›†åº¦ depth: 150, // æ·±åº¦ åˆ‡æ¢å›¾ç‰‡é—´ä¸Šä¸‹çš„é—´è·å’Œå¯†é›†åº¦ modifier: 3, // ä¿®æ­£å€¼ è¯¥å€¼è¶Šå¤§å‰é¢çš„æ•ˆæœè¶Šæ˜æ˜¾ slideShadows: false, // é¡µé¢é˜´å½±æ•ˆæœ &#125;, &#125;, &#125;; &#125;, components: &#123; Swiper, SwiperSlide, &#125;,&#125;;&lt;/script&gt; &lt;style lang=&#x27;scss&#x27; scoped&gt; .home_swiper_img &#123; width: 400px; height: 400px;&#125; &lt;/style&gt; vue-awesome-swiper1npm install vue-awesome-swiper@3 --save-dev Vue-particles1npm install vue-particles --save-dev mai.jsä¸­ 12import VueParticles from &#x27;vue-particles&#x27;Vue.use(VueParticles) ç»„ä»¶ä¸­ 12345678910111213141516171819202122&lt;template&gt; &lt;div id=&quot;app&quot;&gt; &lt;vue-particles color=&quot;#dedede&quot; :particleOpacity=&quot;0.7&quot; :particlesNumber=&quot;80&quot; shapeType=&quot;circle&quot; :particleSize=&quot;4&quot; linesColor=&quot;#dedede&quot; :linesWidth=&quot;1&quot; :lineLinked=&quot;true&quot; :lineOpacity=&quot;0.4&quot; :linesDistance=&quot;150&quot; :moveSpeed=&quot;3&quot; :hoverEffect=&quot;true&quot; hoverMode=&quot;grab&quot; :clickEffect=&quot;true&quot; clickMode=&quot;push&quot; &gt; &lt;/vue-particles&gt; &lt;/div&gt; &lt;/template&gt; å±æ€§ï¼š color: Stringç±»å‹ã€‚é»˜è®¤â€™#dededeâ€™ã€‚ç²’â¼¦é¢œâ¾Šã€‚ particleOpacity: Numberç±»å‹ã€‚é»˜è®¤0.7ã€‚ç²’â¼¦é€æ˜åº¦ã€‚ particlesNumber: Numberç±»å‹ã€‚é»˜è®¤80ã€‚ç²’â¼¦æ•°é‡ã€‚ shapeType: Stringç±»å‹ã€‚é»˜è®¤â€™circleâ€™ã€‚å¯â½¤çš„ç²’â¼¦å¤–è§‚ç±»å‹ æœ‰ï¼šâ€œcircleâ€,â€œedgeâ€,â€œtriangleâ€, â€œpolygonâ€,â€œstarâ€ã€‚ particleSize: Numberç±»å‹ã€‚é»˜è®¤80ã€‚å•ä¸ªç²’â¼¦â¼¤â¼©ã€‚ linesColor: Stringç±»å‹ã€‚é»˜è®¤â€™#dededeâ€™ã€‚çº¿æ¡é¢œâ¾Šã€‚ linesWidth: Numberç±»å‹ã€‚é»˜è®¤1ã€‚çº¿æ¡å®½åº¦ã€‚ lineLinked: å¸ƒå°”ç±»å‹ã€‚é»˜è®¤trueã€‚è¿æ¥çº¿æ˜¯å¦å¯â½¤ã€‚ lineOpacity: Numberç±»å‹ã€‚é»˜è®¤0.4ã€‚çº¿æ¡é€æ˜åº¦ã€‚ linesDistance: Numberç±»å‹ã€‚é»˜è®¤150ã€‚çº¿æ¡è·ç¦»ã€‚ moveSpeed: Numberç±»å‹ã€‚é»˜è®¤3ã€‚ç²’â¼¦è¿åŠ¨é€Ÿåº¦ã€‚ hoverEffect: å¸ƒå°”ç±»å‹ã€‚é»˜è®¤trueã€‚æ˜¯å¦æœ‰hoverç‰¹æ•ˆã€‚ hoverMode: Stringç±»å‹ã€‚é»˜è®¤trueã€‚å¯â½¤çš„hoveræ¨¡å¼æœ‰: â€œgrabâ€, â€œrepulseâ€, + â€œbubbleâ€ã€‚ clickEffect: å¸ƒå°”ç±»å‹ã€‚é»˜è®¤trueã€‚æ˜¯å¦æœ‰clickç‰¹æ•ˆã€‚ clickMode: Stringç±»å‹ã€‚é»˜è®¤trueã€‚å¯â½¤çš„clickæ¨¡å¼æœ‰: â€œpushâ€, â€œremoveâ€, â€œrepulseâ€, â€œbubbleâ€ã€‚ Element-ui1npm i element-ui -S main.jså¼•å…¥ 123456import ElementUI from &#x27;element-ui&#x27;;import &#x27;element-ui/lib/theme-chalk/index.css&#x27;;Vue.use(ElementUI); Element-pluså®‰è£…ï¼š 1npm install element-plus --save main.jséœ€å¯¼å…¥ä¸¤ä¸ªæ–‡ä»¶ 1234import ElementPlus from &#x27;element-plus&#x27;import &#x27;element-plus/dist/index.css&#x27;app.use(ElementPlus) less-loaderå®‰è£… 1npm install --save-dev less-loader less 1&lt;style lang=&quot;less&quot;&gt;&lt;/style&gt; å…¨å±€æ³¨å†Œå›¾æ ‡ç»„ä»¶Vue3vue3 elementplus 1npm install @element-plus/icons-vue main.jsä¸­ 1234import * as ElementPlusIconsVue from &#x27;@element-plus/icons-vue&#x27;for (const [key, component] of Object.entries(ElementPlusIconsVue)) &#123; app.component(key, component)&#125; ä½¿ç”¨iconçš„æ–¹æ³• 1import &#123; Avatar, Lock &#125; from &quot;@element-plus/icons-vue&quot;; 123456setup()&#123; return &#123; Avatar, Lock &#125; &#125; è¾“å…¥æ¡†ä¸­å¼•ç”¨ 12è´¦å· prefix-icon=&quot;Avatar&quot;å¯†ç  prefix-icon=&quot;Lock&quot; vue3è§£å†³ç»„ä»¶æ˜¾ç¤ºä¸­æ–‡APP.vueä¸­ 12345678910111213141516171819202122&lt;template&gt; &lt;el-config-provider :locale=&quot;locale&quot;&gt; &lt;router-view&gt;&lt;/router-view&gt; &lt;/el-config-provider&gt;&lt;/template&gt;&lt;script&gt;import &#123; ElConfigProvider &#125; from &#x27;element-plus&#x27;import zhCn from &#x27;element-plus/lib/locale/lang/zh-cn&#x27;export default &#123; name: &#x27;App&#x27;, components: &#123; ElConfigProvider &#125;, setup() &#123; return &#123; locale: zhCn &#125; &#125;&#125;&lt;/script&gt; è§£å†³å¯¼èˆªæ æœ‰ç®­å¤´element-uiå¯¼èˆªèœå•æœ‰ç®­å¤´æ˜¯scopedä½œç”¨åŸŸçš„é—®é¢˜ 12345&lt;style&gt;.el-menu--collapse .el-submenu &gt; .el-submenu__title i.el-submenu__icon-arrow &#123; display: none;&#125;&lt;/style&gt; è§£å†³element-uiä¾§è¾¹æ ä¸å¹³æ•´æ³¨æ„ï¼šå»é™¤ä¾§è¾¹æ å±•å¼€å¤šå‡ºçš„è¾¹ç¼˜ï¼Œ 123.el-menu-vertical-demo&#123; border-right: none;&#125; VUEéŸ³é¢‘æ’­æ”¾æ’ä»¶1ã€å®‰è£…1npm install aplayer --save 2ã€main.jsé¡µé¢ä¸­å¼•å…¥12import APlayer from &#x27;APlayer&#x27;;import &#x27;APlayer/dist/APlayer.min.css&#x27;; 3ã€å…·ä½“ä½¿ç”¨ï¼Œæºä»£ç ï¼ˆ1ï¼‰å°è£… aPlayer.vue 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173&lt;template&gt; &lt;div class=&quot;mainPage&quot; ref=&quot;playerRef&quot;&gt;&lt;/div&gt;&lt;/template&gt;&lt;script setup&gt; import APlayer from &#x27;APlayer&#x27;; import &#x27;APlayer/dist/APlayer.min.css&#x27;; import &#123;reactive,nextTick, onBeforeUnmount,getCurrentInstance, onMounted, ref&#125; from &#x27;vue&#x27; const playerRef = ref() const &#123; proxy &#125; = getCurrentInstance() const state = reactive(&#123; instance:null &#125;) // APlayeræ­Œæ›²ä¿¡æ¯ class Audio &#123; // éŸ³é¢‘è‰ºæœ¯å®¶ // artist: String; // éŸ³é¢‘åç§° // name: String; // éŸ³é¢‘é“¾æ¥ // url: String; // éŸ³é¢‘å°é¢ // cover: String; // æ­Œè¯ // lrc: String; constructor(artist, name, url, cover, lrc) &#123; this.artist = artist; this.name = name; this.url = url; this.cover = cover; this.lrc = lrc; &#125; &#125; const props = defineProps(&#123; // å¼€å¯å¸åº•æ¨¡å¼ fixed: &#123; type: Boolean, default: false &#125;, // å¼€å¯è¿·ä½ æ¨¡å¼ mini: &#123; type: Boolean, default: false &#125;, // éŸ³é¢‘è‡ªåŠ¨æ’­æ”¾ autoplay: &#123; type: Boolean, default: false &#125;, // ä¸»é¢˜è‰² theme: &#123; type: String, default: &#x27;rgba(255,255,255,0.2)&#x27; &#125;, // éŸ³é¢‘å¾ªç¯æ’­æ”¾ loop: &#123; type: String, default: &#x27;all&#x27; //&#x27;all&#x27; | &#x27;one&#x27; | &#x27;none&#x27; &#125;, // éŸ³é¢‘å¾ªç¯é¡ºåº order: &#123; type: String, default: &#x27;random&#x27; //&#x27;list&#x27; | &#x27;random&#x27; &#125;, // é¢„åŠ è½½ preload: &#123; type: String, default: &#x27;auto&#x27; //&#x27;auto&#x27; | &#x27;metadata&#x27; | &#x27;none&#x27; &#125;, // é»˜è®¤éŸ³é‡ volume: &#123; type: Number, default: 0.7, validator: (value) =&gt; &#123; return value &gt;= 0 &amp;&amp; value &lt;= 1; &#125; &#125;, // æ­Œæ›²æœåŠ¡å™¨(netease-ç½‘æ˜“äº‘, tencent-qqéŸ³ä¹, kugou-é…·ç‹—, xiami-å°ç±³éŸ³ä¹, baidu-ç™¾åº¦éŸ³ä¹) songServer: &#123; type: String, default: &#x27;netease&#x27; //&#x27;netease&#x27; | &#x27;tencent&#x27; | &#x27;kugou&#x27; | &#x27;xiami&#x27; | &#x27;baidu&#x27; &#125;, // æ’­æ”¾ç±»å‹(song-æ­Œæ›², playlist-æ’­æ”¾åˆ—è¡¨, album-ä¸“è¾‘, search-æœç´¢, artist-è‰ºæœ¯å®¶) songType: &#123; type: String, default: &#x27;playlist&#x27; &#125;, // æ­Œçš„id songId: &#123; type: String, default: &#x27;19723756&#x27; &#125;, // äº’æ–¥ï¼Œé˜»æ­¢å¤šä¸ªæ’­æ”¾å™¨åŒæ—¶æ’­æ”¾ï¼Œå½“å‰æ’­æ”¾å™¨æ’­æ”¾æ—¶æš‚åœå…¶ä»–æ’­æ”¾å™¨ mutex: &#123; type: Boolean, default: true &#125;, // ä¼ é€’æ­Œè¯æ–¹å¼ lrcType: &#123; type: Number, default: 3 &#125;, // åˆ—è¡¨æ˜¯å¦é»˜è®¤æŠ˜å  listFolded: &#123; type: Boolean, default: true &#125;, // åˆ—è¡¨æœ€å¤§é«˜åº¦ listMaxHeight: &#123; type: String, default: &#x27;100px&#x27; &#125;, // å­˜å‚¨æ’­æ”¾å™¨è®¾ç½®çš„ localStorage key storageName: &#123; type: String, default: &#x27;aplayer-setting&#x27; &#125; &#125;) onMounted(() =&gt; &#123; let str = &#123; server:props.songServer, type:props.songType, id:props.songId &#125; proxy.$api.common.getSongSheet(str).then(res=&gt;&#123; let audioList = res.data.map(value =&gt; new Audio(value.author, value.title, value.url, value.pic, value.lrc)); state.instance = new APlayer(&#123; container: playerRef.value, fixed: props.fixed, mini: props.mini, autoplay: props.autoplay, theme: props.theme, loop: props.loop, order: props.order, preload: props.preload, volume: props.volume, mutex: props.mutex, lrcType: props.lrcType, listFolded: props.listFolded, listMaxHeight: props.listMaxHeight, storageName: props.storageName, audio: audioList &#125;) &#125;) // é”€æ¯ onBeforeUnmount(() =&gt; &#123; state.instance.destroy() &#125;) &#125;)&lt;/script&gt;&lt;style lang=&#x27;scss&#x27; scoped&gt; .mainPage&#123; @include wh(100%,auto); background: #FCFCFC; border: 1px solid #E0E0E0; border-radius: 4px; &#125;&lt;/style&gt; ï¼ˆ2ï¼‰çˆ¶ç»„ä»¶è°ƒç”¨ 1&lt;a-player&gt;&lt;/a-player&gt; npmé™çº§åˆ°npm61npx -p npm@6 npm i --legacy-peer-deps cssèƒŒæ™¯å®ç°æ¸å˜1background-imge: linear-gradient(to bottom rigth,#FC466B,#3F5EFB) å‰ç«¯è·¨åŸŸrequest.jså°è£…1234567891011121314151617181920212223242526272829303132333435363738394041424344import axios from &#x27;axios&#x27;const request = axios.create(&#123; baseURL: &#x27;/api&#x27;, // æ³¨æ„ï¼ï¼ è¿™é‡Œæ˜¯å…¨å±€ç»Ÿä¸€åŠ ä¸Šäº† &#x27;/api&#x27; å‰ç¼€ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰æ¥å£éƒ½ä¼šåŠ ä¸Š&#x27;/api&#x27;å‰ç¼€åœ¨ï¼Œé¡µé¢é‡Œé¢å†™æ¥å£çš„æ—¶å€™å°±ä¸è¦åŠ  &#x27;/api&#x27;äº†ï¼Œå¦åˆ™ä¼šå‡ºç°2ä¸ª&#x27;/api&#x27;ï¼Œç±»ä¼¼ &#x27;/api/api/user&#x27;è¿™æ ·çš„æŠ¥é”™ï¼Œåˆ‡è®°ï¼ï¼ï¼ timeout: 3000&#125;)// request æ‹¦æˆªå™¨// å¯ä»¥è‡ªè¯·æ±‚å‘é€å‰å¯¹è¯·æ±‚åšä¸€äº›å¤„ç†// æ¯”å¦‚ç»Ÿä¸€åŠ tokenï¼Œå¯¹è¯·æ±‚å‚æ•°ç»Ÿä¸€åŠ å¯†request.interceptors.request.use(config =&gt; &#123; config.headers[&#x27;Content-Type&#x27;] = &#x27;application/json;charset=utf-8&#x27;; // config.headers[&#x27;token&#x27;] = user.token; // è®¾ç½®è¯·æ±‚å¤´ return config&#125;, error =&gt; &#123; return Promise.reject(error)&#125;);// response æ‹¦æˆªå™¨// å¯ä»¥åœ¨æ¥å£å“åº”åç»Ÿä¸€å¤„ç†ç»“æœrequest.interceptors.response.use( response =&gt; &#123; let res = response.data; // å¦‚æœæ˜¯è¿”å›çš„æ–‡ä»¶ if (response.config.responseType === &#x27;blob&#x27;) &#123; return res &#125; // å…¼å®¹æœåŠ¡ç«¯è¿”å›çš„å­—ç¬¦ä¸²æ•°æ® if (typeof res === &#x27;string&#x27;) &#123; res = res ? JSON.parse(res) : res &#125; return res; &#125;, error =&gt; &#123; console.log(&#x27;err&#x27; + error) // for debug return Promise.reject(error) &#125;)export default request vue.config.js 12345678910111213141516// è·¨åŸŸé…ç½®module.exports = &#123; devServer: &#123; //è®°ä½ï¼Œåˆ«å†™é”™äº†devServer//è®¾ç½®æœ¬åœ°é»˜è®¤ç«¯å£ é€‰å¡« port: 9876, proxy: &#123; //è®¾ç½®ä»£ç†ï¼Œå¿…é¡»å¡« &#x27;/api&#x27;: &#123; //è®¾ç½®æ‹¦æˆªå™¨ æ‹¦æˆªå™¨æ ¼å¼ æ–œæ +æ‹¦æˆªå™¨åå­—ï¼Œåå­—å¯ä»¥è‡ªå·±å®š target: &#x27;http://localhost:9999&#x27;, //ä»£ç†çš„ç›®æ ‡åœ°å€ changeOrigin: true, //æ˜¯å¦è®¾ç½®åŒæºï¼Œè¾“å…¥æ˜¯çš„ pathRewrite: &#123; //è·¯å¾„é‡å†™ &#x27;^/api&#x27;: &#x27;&#x27; //é€‰æ‹©å¿½ç•¥æ‹¦æˆªå™¨é‡Œé¢çš„å†…å®¹ &#125; &#125; &#125; &#125;&#125; åç«¯è®¾ç½®è·¨åŸŸrequest.jså°è£…1234567891011121314151617181920212223242526272829303132333435363738394041424344import axios from &#x27;axios&#x27;const request = axios.create(&#123; baseURL: &#x27;http://localhost:9090&#x27;, // æ³¨æ„ï¼ï¼ è¿™é‡Œæ˜¯å…¨å±€ç»Ÿä¸€åŠ ä¸Šäº† åç«¯æ¥å£å‰ç¼€ å‰ç¼€ï¼Œåç«¯å¿…é¡»è¿›è¡Œè·¨åŸŸé…ç½®ï¼ timeout: 5000&#125;)// request æ‹¦æˆªå™¨// å¯ä»¥è‡ªè¯·æ±‚å‘é€å‰å¯¹è¯·æ±‚åšä¸€äº›å¤„ç†// æ¯”å¦‚ç»Ÿä¸€åŠ tokenï¼Œå¯¹è¯·æ±‚å‚æ•°ç»Ÿä¸€åŠ å¯†request.interceptors.request.use(config =&gt; &#123; config.headers[&#x27;Content-Type&#x27;] = &#x27;application/json;charset=utf-8&#x27;; // config.headers[&#x27;token&#x27;] = user.token; // è®¾ç½®è¯·æ±‚å¤´ return config&#125;, error =&gt; &#123; return Promise.reject(error)&#125;);// response æ‹¦æˆªå™¨// å¯ä»¥åœ¨æ¥å£å“åº”åç»Ÿä¸€å¤„ç†ç»“æœrequest.interceptors.response.use( response =&gt; &#123; let res = response.data; // å¦‚æœæ˜¯è¿”å›çš„æ–‡ä»¶ if (response.config.responseType === &#x27;blob&#x27;) &#123; return res &#125; // å…¼å®¹æœåŠ¡ç«¯è¿”å›çš„å­—ç¬¦ä¸²æ•°æ® if (typeof res === &#x27;string&#x27;) &#123; res = res ? JSON.parse(res) : res &#125; return res; &#125;, error =&gt; &#123; console.log(&#x27;err&#x27; + error) // for debug return Promise.reject(error) &#125;)export default request main.js ElementUIèµ°é©¬ç¯è½®æ’­åŠ¨ç”»(é™æ€)1234567891011121314151617181920212223242526 &lt;el-carousel trigger=&quot;click&quot; height=&quot;500px&quot; style=&quot;border-radius: 1%; rad&quot; &gt; &lt;el-carousel-item v-for=&quot;item in banners&quot; :key=&quot;item.imageUrl&quot;&gt; &lt;img :src=&quot;item.imageUrl&quot; width=&quot;100%&quot; height=&quot;100%&quot;&gt; &lt;/el-carousel-item&gt; &lt;/el-carousel&gt; data() &#123; return &#123; banners:[ &#123; imageUrl: require(&quot;@/assets/å»ºå·¥.jpg&quot;) &#125;, &#123; imageUrl: require(&quot;@/assets/jg.png&quot;) &#125;, &#123; imageUrl: require(&quot;@/assets/sky.png&quot;) &#125;, &#123; imageUrl: require(&quot;@/assets/330.jpg&quot;) &#125; ],&#125; å®ç°è§†é¢‘èƒŒæ™¯1234&lt;div class=&quot;videocontainer&quot;&gt; &lt;video class=&quot;fullscreenvideo&quot; poster=&quot;@/assets/1654171841120.jpeg&quot; id=&quot;bgvid&quot; playsinline=&quot;&quot; autoplay=&quot;&quot; loop=&quot;&quot;&gt; &lt;source src=&quot;@/assets/polina.mp4&quot; type=&quot;video/mp4&quot;&gt; &lt;/video&gt; cssæ ·å¼ 12345678910111213141516171819202122232425262728293031323334.fullscreenvideo &#123; position: absolute; top: 50%; left: 50%; min-width: 100%; min-height: 100%; width: auto; height: auto; z-index: -100; -webkit-transform: translateX(-50%) translateY(-50%); transform: translateX(-50%) translateY(-50%); -webkit-transition: 1s opacity; transition: 1s opacity;&#125;.videocontainer&#123; position: fixed; width: 100%; height: 100%; overflow: hidden; z-index: -100; &#125;.videocontainer:before&#123; content: &quot;&quot;; position: absolute; width: 100%; height: 100%; display: block; z-index: -1; top: 0; left: 0; background: rgba(25,29,34,.65);&#125; å®ç°å¤©æ°”æ’ä»¶1234567891011121314151617181920212223242526272829303132333435363738&lt;div class=&quot;whether&quot;&gt; &lt;div id=&quot;he-plugin-simple&quot;&gt;hi&lt;/div&gt; &lt;/div&gt;mounted() &#123; window.WIDGET = &#123; CONFIG: &#123; modules: &quot;01234&quot;, background: &quot;1&quot;, tmpColor: &quot;FFFFFF&quot;, tmpSize: &quot;16&quot;, cityColor: &quot;FFFFFF&quot;, citySize: &quot;16&quot;, aqiColor: &quot;FFFFFF&quot;, aqiSize: &quot;16&quot;, weatherIconSize: &quot;24&quot;, alertIconSize: &quot;18&quot;, padding: &quot;10px 10px 10px 10px&quot;, shadow: &quot;1&quot;, language: &quot;auto&quot;, borderRadius: &quot;10&quot;, fixed: &quot;false&quot;, vertical: &quot;top&quot;, horizontal: &quot;right&quot;, city: &quot;CN101260101&quot;, key: &quot;66a855861d724908b73de62ceadfe971&quot;, &#125;, &#125;; let script = document.createElement(&quot;script&quot;); script.type = &quot;text/javascript&quot;; script.src = &quot;https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0&quot;; document.getElementsByTagName(&quot;head&quot;)[0].appendChild(script); &#125;,.whether &#123; position: relative; z-index: 9999; left: 20%;&#125;","categories":[],"tags":[]},{"title":"","slug":"æ•°æ®åº“ä¸­çš„4ç§éš”ç¦»çº§åˆ«","date":"2025-05-21T03:23:59.317Z","updated":"2024-05-07T03:45:44.373Z","comments":true,"path":"2025/05/21/æ•°æ®åº“ä¸­çš„4ç§éš”ç¦»çº§åˆ«/","link":"","permalink":"https://dddwah11.github.io/2025/05/21/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%844%E7%A7%8D%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB/","excerpt":"","text":"æ•°æ®åº“ä¸­çš„4ç§éš”ç¦»çº§åˆ« 1.è¯»æœªæäº¤ï¼šä¸€ä¸ªäº‹åŠ¡å¯ä»¥è¯»å–åˆ°å¦ä¸€ä¸ªäº‹åŠ¡æœªæäº¤çš„æ•°æ®ï¼Œä½†å¯èƒ½ä¼šå¯¼è‡´è„è¯»çš„é—®é¢˜ã€‚ 2.è¯»å·²æäº¤ï¼šä¸€ä¸ªäº‹åŠ¡å¯ä»¥è¯»å–åˆ°å¦ä¸€ä¸ªäº‹åŠ¡å·²æäº¤çš„æ•°æ®ï¼Œè¿™ä¸ªå¯ä»¥è§£å†³è„è¯»çš„é—®é¢˜ï¼Œä½†æ˜¯å¯èƒ½ä¼šå¯¼è‡´ä¸å¯é‡å¤è¯»çš„é—®é¢˜ï¼Œå³è¯»å–åŒä¸€è¡Œæ•°æ®ä¸ä¸€è‡´ï¼Œè¿™æ˜¯å¦ä¸€ä¸ªäº‹åŠ¡åœ¨ä¸€ä¸ªäº‹åŠ¡è¯»å–è¿‡ç¨‹ä¸­å¯¹æ•°æ®è¿›è¡Œäº†ä¿®æ”¹ã€‚ 3.å¯é‡å¤è¯»ï¼šä¸€ä¸ªäº‹åŠ¡å¯ä»¥è¯»å–åˆ°åŒä¸€æ¡é‡å¤çš„æ•°æ®ï¼Œä½†å¯èƒ½ä¼šé€ æˆå¹»è¯»ï¼Œå³è®¿é—®æ•°æ®ä¼šæœ‰ä¸åŒè¡Œçš„è®°å½•ã€‚ 4.ä¸²è¡ŒåŒ–ï¼šå¯è§£å†³å¹»è¯»ï¼Œä½†ä¼šå¯¹æ€§èƒ½é€ æˆå½±å“ã€‚","categories":[],"tags":[]},{"title":"","slug":"SpringSecurity-ä»å…¥é—¨åˆ°ç²¾é€š-ä¸‰æ›´è‰å ‚","date":"2025-05-21T03:23:59.311Z","updated":"2022-02-07T13:11:20.000Z","comments":true,"path":"2025/05/21/SpringSecurity-ä»å…¥é—¨åˆ°ç²¾é€š-ä¸‰æ›´è‰å ‚/","link":"","permalink":"https://dddwah11.github.io/2025/05/21/SpringSecurity-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A-%E4%B8%89%E6%9B%B4%E8%8D%89%E5%A0%82/","excerpt":"","text":"SpringSecurityä»å…¥é—¨åˆ°ç²¾é€šè¯¾ç¨‹ä»‹ç» 0. ç®€ä»‹â€‹ Spring Security æ˜¯ Spring å®¶æ—ä¸­çš„ä¸€ä¸ªå®‰å…¨ç®¡ç†æ¡†æ¶ã€‚ç›¸æ¯”ä¸å¦å¤–ä¸€ä¸ªå®‰å…¨æ¡†æ¶Shiroï¼Œå®ƒæä¾›äº†æ›´ä¸°å¯Œçš„åŠŸèƒ½ï¼Œç¤¾åŒºèµ„æºä¹Ÿæ¯”Shiroä¸°å¯Œã€‚ â€‹ ä¸€èˆ¬æ¥è¯´ä¸­å¤§å‹çš„é¡¹ç›®éƒ½æ˜¯ä½¿ç”¨SpringSecurity æ¥åšå®‰å…¨æ¡†æ¶ã€‚å°é¡¹ç›®æœ‰Shiroçš„æ¯”è¾ƒå¤šï¼Œå› ä¸ºç›¸æ¯”ä¸SpringSecurityï¼ŒShiroçš„ä¸Šæ‰‹æ›´åŠ çš„ç®€å•ã€‚ â€‹ ä¸€èˆ¬Webåº”ç”¨çš„éœ€è¦è¿›è¡Œè®¤è¯å’Œæˆæƒã€‚ â€‹ è®¤è¯ï¼šéªŒè¯å½“å‰è®¿é—®ç³»ç»Ÿçš„æ˜¯ä¸æ˜¯æœ¬ç³»ç»Ÿçš„ç”¨æˆ·ï¼Œå¹¶ä¸”è¦ç¡®è®¤å…·ä½“æ˜¯å“ªä¸ªç”¨æˆ· â€‹ æˆæƒï¼šç»è¿‡è®¤è¯ååˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è¿›è¡ŒæŸä¸ªæ“ä½œ â€‹ è€Œè®¤è¯å’Œæˆæƒä¹Ÿæ˜¯SpringSecurityä½œä¸ºå®‰å…¨æ¡†æ¶çš„æ ¸å¿ƒåŠŸèƒ½ã€‚ 1. å¿«é€Ÿå…¥é—¨1.1 å‡†å¤‡å·¥ä½œâ€‹ æˆ‘ä»¬å…ˆè¦æ­å»ºä¸€ä¸ªç®€å•çš„SpringBootå·¥ç¨‹ â‘  è®¾ç½®çˆ¶å·¥ç¨‹ æ·»åŠ ä¾èµ– 12345678910111213141516&lt;parent&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt; &lt;version&gt;2.5.0&lt;/version&gt;&lt;/parent&gt;&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;optional&gt;true&lt;/optional&gt; &lt;/dependency&gt;&lt;/dependencies&gt; â‘¡ åˆ›å»ºå¯åŠ¨ç±» 12345678@SpringBootApplicationpublic class SecurityApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(SecurityApplication.class,args); &#125;&#125; â‘¢ åˆ›å»ºController 12345678910111213import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.RestController;@RestControllerpublic class HelloController &#123; @RequestMapping(&quot;/hello&quot;) public String hello()&#123; return &quot;hello&quot;; &#125;&#125; 1.2 å¼•å…¥SpringSecurityâ€‹ åœ¨SpringBooté¡¹ç›®ä¸­ä½¿ç”¨SpringSecurityæˆ‘ä»¬åªéœ€è¦å¼•å…¥ä¾èµ–å³å¯å®ç°å…¥é—¨æ¡ˆä¾‹ã€‚ 1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;&lt;/dependency&gt; â€‹ å¼•å…¥ä¾èµ–åæˆ‘ä»¬åœ¨å°è¯•å»è®¿é—®ä¹‹å‰çš„æ¥å£å°±ä¼šè‡ªåŠ¨è·³è½¬åˆ°ä¸€ä¸ªSpringSecurityçš„é»˜è®¤ç™»é™†é¡µé¢ï¼Œé»˜è®¤ç”¨æˆ·åæ˜¯user,å¯†ç ä¼šè¾“å‡ºåœ¨æ§åˆ¶å°ã€‚ â€‹ å¿…é¡»ç™»é™†ä¹‹åæ‰èƒ½å¯¹æ¥å£è¿›è¡Œè®¿é—®ã€‚ 2. è®¤è¯2.1 ç™»é™†æ ¡éªŒæµç¨‹ 2.2 åŸç†åˆæ¢â€‹ æƒ³è¦çŸ¥é“å¦‚ä½•å®ç°è‡ªå·±çš„ç™»é™†æµç¨‹å°±å¿…é¡»è¦å…ˆçŸ¥é“å…¥é—¨æ¡ˆä¾‹ä¸­SpringSecurityçš„æµç¨‹ã€‚ 2.2.1 SpringSecurityå®Œæ•´æµç¨‹â€‹ SpringSecurityçš„åŸç†å…¶å®å°±æ˜¯ä¸€ä¸ªè¿‡æ»¤å™¨é“¾ï¼Œå†…éƒ¨åŒ…å«äº†æä¾›å„ç§åŠŸèƒ½çš„è¿‡æ»¤å™¨ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹å…¥é—¨æ¡ˆä¾‹ä¸­çš„è¿‡æ»¤å™¨ã€‚ â€‹ å›¾ä¸­åªå±•ç¤ºäº†æ ¸å¿ƒè¿‡æ»¤å™¨ï¼Œå…¶å®ƒçš„éæ ¸å¿ƒè¿‡æ»¤å™¨å¹¶æ²¡æœ‰åœ¨å›¾ä¸­å±•ç¤ºã€‚ UsernamePasswordAuthenticationFilter:è´Ÿè´£å¤„ç†æˆ‘ä»¬åœ¨ç™»é™†é¡µé¢å¡«å†™äº†ç”¨æˆ·åå¯†ç åçš„ç™»é™†è¯·æ±‚ã€‚å…¥é—¨æ¡ˆä¾‹çš„è®¤è¯å·¥ä½œä¸»è¦æœ‰å®ƒè´Ÿè´£ã€‚ ExceptionTranslationFilterï¼šå¤„ç†è¿‡æ»¤å™¨é“¾ä¸­æŠ›å‡ºçš„ä»»ä½•AccessDeniedExceptionå’ŒAuthenticationException ã€‚ FilterSecurityInterceptorï¼šè´Ÿè´£æƒé™æ ¡éªŒçš„è¿‡æ»¤å™¨ã€‚ â€‹ â€‹ æˆ‘ä»¬å¯ä»¥é€šè¿‡DebugæŸ¥çœ‹å½“å‰ç³»ç»Ÿä¸­SpringSecurityè¿‡æ»¤å™¨é“¾ä¸­æœ‰å“ªäº›è¿‡æ»¤å™¨åŠå®ƒä»¬çš„é¡ºåºã€‚ 2.2.2 è®¤è¯æµç¨‹è¯¦è§£ æ¦‚å¿µé€ŸæŸ¥: Authenticationæ¥å£: å®ƒçš„å®ç°ç±»ï¼Œè¡¨ç¤ºå½“å‰è®¿é—®ç³»ç»Ÿçš„ç”¨æˆ·ï¼Œå°è£…äº†ç”¨æˆ·ç›¸å…³ä¿¡æ¯ã€‚ AuthenticationManageræ¥å£ï¼šå®šä¹‰äº†è®¤è¯Authenticationçš„æ–¹æ³• UserDetailsServiceæ¥å£ï¼šåŠ è½½ç”¨æˆ·ç‰¹å®šæ•°æ®çš„æ ¸å¿ƒæ¥å£ã€‚é‡Œé¢å®šä¹‰äº†ä¸€ä¸ªæ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯çš„æ–¹æ³•ã€‚ UserDetailsæ¥å£ï¼šæä¾›æ ¸å¿ƒç”¨æˆ·ä¿¡æ¯ã€‚é€šè¿‡UserDetailsServiceæ ¹æ®ç”¨æˆ·åè·å–å¤„ç†çš„ç”¨æˆ·ä¿¡æ¯è¦å°è£…æˆUserDetailså¯¹è±¡è¿”å›ã€‚ç„¶åå°†è¿™äº›ä¿¡æ¯å°è£…åˆ°Authenticationå¯¹è±¡ä¸­ã€‚ 2.3 è§£å†³é—®é¢˜2.3.1 æ€è·¯åˆ†æç™»å½• â€‹ â‘ è‡ªå®šä¹‰ç™»å½•æ¥å£ â€‹ è°ƒç”¨ProviderManagerçš„æ–¹æ³•è¿›è¡Œè®¤è¯ å¦‚æœè®¤è¯é€šè¿‡ç”Ÿæˆjwt â€‹ æŠŠç”¨æˆ·ä¿¡æ¯å­˜å…¥redisä¸­ â€‹ â‘¡è‡ªå®šä¹‰UserDetailsService â€‹ åœ¨è¿™ä¸ªå®ç°ç±»ä¸­å»æŸ¥è¯¢æ•°æ®åº“ æ ¡éªŒï¼š â€‹ â‘ å®šä¹‰Jwtè®¤è¯è¿‡æ»¤å™¨ â€‹ è·å–token â€‹ è§£ætokenè·å–å…¶ä¸­çš„userid â€‹ ä»redisä¸­è·å–ç”¨æˆ·ä¿¡æ¯ â€‹ å­˜å…¥SecurityContextHolder 2.3.2 å‡†å¤‡å·¥ä½œâ‘ æ·»åŠ ä¾èµ– 1234567891011121314151617&lt;!--redisä¾èµ–--&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;&lt;/dependency&gt;&lt;!--fastjsonä¾èµ–--&gt;&lt;dependency&gt; &lt;groupId&gt;com.alibaba&lt;/groupId&gt; &lt;artifactId&gt;fastjson&lt;/artifactId&gt; &lt;version&gt;1.2.33&lt;/version&gt;&lt;/dependency&gt;&lt;!--jwtä¾èµ–--&gt;&lt;dependency&gt; &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt; &lt;artifactId&gt;jjwt&lt;/artifactId&gt; &lt;version&gt;0.9.0&lt;/version&gt;&lt;/dependency&gt; â‘¡ æ·»åŠ Redisç›¸å…³é…ç½® 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263import com.alibaba.fastjson.JSON;import com.alibaba.fastjson.serializer.SerializerFeature;import com.fasterxml.jackson.databind.JavaType;import com.fasterxml.jackson.databind.ObjectMapper;import com.fasterxml.jackson.databind.type.TypeFactory;import org.springframework.data.redis.serializer.RedisSerializer;import org.springframework.data.redis.serializer.SerializationException;import com.alibaba.fastjson.parser.ParserConfig;import org.springframework.util.Assert;import java.nio.charset.Charset;/** * Redisä½¿ç”¨FastJsonåºåˆ—åŒ– * * @author sg */public class FastJsonRedisSerializer&lt;T&gt; implements RedisSerializer&lt;T&gt;&#123; public static final Charset DEFAULT_CHARSET = Charset.forName(&quot;UTF-8&quot;); private Class&lt;T&gt; clazz; static &#123; ParserConfig.getGlobalInstance().setAutoTypeSupport(true); &#125; public FastJsonRedisSerializer(Class&lt;T&gt; clazz) &#123; super(); this.clazz = clazz; &#125; @Override public byte[] serialize(T t) throws SerializationException &#123; if (t == null) &#123; return new byte[0]; &#125; return JSON.toJSONString(t, SerializerFeature.WriteClassName).getBytes(DEFAULT_CHARSET); &#125; @Override public T deserialize(byte[] bytes) throws SerializationException &#123; if (bytes == null || bytes.length &lt;= 0) &#123; return null; &#125; String str = new String(bytes, DEFAULT_CHARSET); return JSON.parseObject(str, clazz); &#125; protected JavaType getJavaType(Class&lt;?&gt; clazz) &#123; return TypeFactory.defaultInstance().constructType(clazz); &#125;&#125; 12345678910111213141516171819202122232425262728293031import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.data.redis.connection.RedisConnectionFactory;import org.springframework.data.redis.core.RedisTemplate;import org.springframework.data.redis.serializer.StringRedisSerializer;@Configurationpublic class RedisConfig &#123; @Bean @SuppressWarnings(value = &#123; &quot;unchecked&quot;, &quot;rawtypes&quot; &#125;) public RedisTemplate&lt;Object, Object&gt; redisTemplate(RedisConnectionFactory connectionFactory) &#123; RedisTemplate&lt;Object, Object&gt; template = new RedisTemplate&lt;&gt;(); template.setConnectionFactory(connectionFactory); FastJsonRedisSerializer serializer = new FastJsonRedisSerializer(Object.class); // ä½¿ç”¨StringRedisSerializeræ¥åºåˆ—åŒ–å’Œååºåˆ—åŒ–redisçš„keyå€¼ template.setKeySerializer(new StringRedisSerializer()); template.setValueSerializer(serializer); // Hashçš„keyä¹Ÿé‡‡ç”¨StringRedisSerializerçš„åºåˆ—åŒ–æ–¹å¼ template.setHashKeySerializer(new StringRedisSerializer()); template.setHashValueSerializer(serializer); template.afterPropertiesSet(); return template; &#125;&#125; â‘¢ å“åº”ç±» 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061import com.fasterxml.jackson.annotation.JsonInclude;/** * @Author ä¸‰æ›´ Bç«™ï¼š https://space.bilibili.com/663528522 */@JsonInclude(JsonInclude.Include.NON_NULL)public class ResponseResult&lt;T&gt; &#123; /** * çŠ¶æ€ç  */ private Integer code; /** * æç¤ºä¿¡æ¯ï¼Œå¦‚æœæœ‰é”™è¯¯æ—¶ï¼Œå‰ç«¯å¯ä»¥è·å–è¯¥å­—æ®µè¿›è¡Œæç¤º */ private String msg; /** * æŸ¥è¯¢åˆ°çš„ç»“æœæ•°æ®ï¼Œ */ private T data; public ResponseResult(Integer code, String msg) &#123; this.code = code; this.msg = msg; &#125; public ResponseResult(Integer code, T data) &#123; this.code = code; this.data = data; &#125; public Integer getCode() &#123; return code; &#125; public void setCode(Integer code) &#123; this.code = code; &#125; public String getMsg() &#123; return msg; &#125; public void setMsg(String msg) &#123; this.msg = msg; &#125; public T getData() &#123; return data; &#125; public void setData(T data) &#123; this.data = data; &#125; public ResponseResult(Integer code, String msg, T data) &#123; this.code = code; this.msg = msg; this.data = data; &#125;&#125; â‘£å·¥å…·ç±» 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112import io.jsonwebtoken.Claims;import io.jsonwebtoken.JwtBuilder;import io.jsonwebtoken.Jwts;import io.jsonwebtoken.SignatureAlgorithm;import javax.crypto.SecretKey;import javax.crypto.spec.SecretKeySpec;import java.util.Base64;import java.util.Date;import java.util.UUID;/** * JWTå·¥å…·ç±» */public class JwtUtil &#123; //æœ‰æ•ˆæœŸä¸º public static final Long JWT_TTL = 60 * 60 *1000L;// 60 * 60 *1000 ä¸€ä¸ªå°æ—¶ //è®¾ç½®ç§˜é’¥æ˜æ–‡ public static final String JWT_KEY = &quot;sangeng&quot;; public static String getUUID()&#123; String token = UUID.randomUUID().toString().replaceAll(&quot;-&quot;, &quot;&quot;); return token; &#125; /** * ç”Ÿæˆjtw * @param subject tokenä¸­è¦å­˜æ”¾çš„æ•°æ®ï¼ˆjsonæ ¼å¼ï¼‰ * @return */ public static String createJWT(String subject) &#123; JwtBuilder builder = getJwtBuilder(subject, null, getUUID());// è®¾ç½®è¿‡æœŸæ—¶é—´ return builder.compact(); &#125; /** * ç”Ÿæˆjtw * @param subject tokenä¸­è¦å­˜æ”¾çš„æ•°æ®ï¼ˆjsonæ ¼å¼ï¼‰ * @param ttlMillis tokenè¶…æ—¶æ—¶é—´ * @return */ public static String createJWT(String subject, Long ttlMillis) &#123; JwtBuilder builder = getJwtBuilder(subject, ttlMillis, getUUID());// è®¾ç½®è¿‡æœŸæ—¶é—´ return builder.compact(); &#125; private static JwtBuilder getJwtBuilder(String subject, Long ttlMillis, String uuid) &#123; SignatureAlgorithm signatureAlgorithm = SignatureAlgorithm.HS256; SecretKey secretKey = generalKey(); long nowMillis = System.currentTimeMillis(); Date now = new Date(nowMillis); if(ttlMillis==null)&#123; ttlMillis=JwtUtil.JWT_TTL; &#125; long expMillis = nowMillis + ttlMillis; Date expDate = new Date(expMillis); return Jwts.builder() .setId(uuid) //å”¯ä¸€çš„ID .setSubject(subject) // ä¸»é¢˜ å¯ä»¥æ˜¯JSONæ•°æ® .setIssuer(&quot;sg&quot;) // ç­¾å‘è€… .setIssuedAt(now) // ç­¾å‘æ—¶é—´ .signWith(signatureAlgorithm, secretKey) //ä½¿ç”¨HS256å¯¹ç§°åŠ å¯†ç®—æ³•ç­¾å, ç¬¬äºŒä¸ªå‚æ•°ä¸ºç§˜é’¥ .setExpiration(expDate); &#125; /** * åˆ›å»ºtoken * @param id * @param subject * @param ttlMillis * @return */ public static String createJWT(String id, String subject, Long ttlMillis) &#123; JwtBuilder builder = getJwtBuilder(subject, ttlMillis, id);// è®¾ç½®è¿‡æœŸæ—¶é—´ return builder.compact(); &#125; public static void main(String[] args) throws Exception &#123; String token = &quot;eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiJjYWM2ZDVhZi1mNjVlLTQ0MDAtYjcxMi0zYWEwOGIyOTIwYjQiLCJzdWIiOiJzZyIsImlzcyI6InNnIiwiaWF0IjoxNjM4MTA2NzEyLCJleHAiOjE2MzgxMTAzMTJ9.JVsSbkP94wuczb4QryQbAke3ysBDIL5ou8fWsbt_ebg&quot;; Claims claims = parseJWT(token); System.out.println(claims); &#125; /** * ç”ŸæˆåŠ å¯†åçš„ç§˜é’¥ secretKey * @return */ public static SecretKey generalKey() &#123; byte[] encodedKey = Base64.getDecoder().decode(JwtUtil.JWT_KEY); SecretKey key = new SecretKeySpec(encodedKey, 0, encodedKey.length, &quot;AES&quot;); return key; &#125; /** * è§£æ * * @param jwt * @return * @throws Exception */ public static Claims parseJWT(String jwt) throws Exception &#123; SecretKey secretKey = generalKey(); return Jwts.parser() .setSigningKey(secretKey) .parseClaimsJws(jwt) .getBody(); &#125;&#125; 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230import java.util.*;import java.util.concurrent.TimeUnit;@SuppressWarnings(value = &#123; &quot;unchecked&quot;, &quot;rawtypes&quot; &#125;)@Componentpublic class RedisCache&#123; @Autowired public RedisTemplate redisTemplate; /** * ç¼“å­˜åŸºæœ¬çš„å¯¹è±¡ï¼ŒIntegerã€Stringã€å®ä½“ç±»ç­‰ * * @param key ç¼“å­˜çš„é”®å€¼ * @param value ç¼“å­˜çš„å€¼ */ public &lt;T&gt; void setCacheObject(final String key, final T value) &#123; redisTemplate.opsForValue().set(key, value); &#125; /** * ç¼“å­˜åŸºæœ¬çš„å¯¹è±¡ï¼ŒIntegerã€Stringã€å®ä½“ç±»ç­‰ * * @param key ç¼“å­˜çš„é”®å€¼ * @param value ç¼“å­˜çš„å€¼ * @param timeout æ—¶é—´ * @param timeUnit æ—¶é—´é¢—ç²’åº¦ */ public &lt;T&gt; void setCacheObject(final String key, final T value, final Integer timeout, final TimeUnit timeUnit) &#123; redisTemplate.opsForValue().set(key, value, timeout, timeUnit); &#125; /** * è®¾ç½®æœ‰æ•ˆæ—¶é—´ * * @param key Redisé”® * @param timeout è¶…æ—¶æ—¶é—´ * @return true=è®¾ç½®æˆåŠŸï¼›false=è®¾ç½®å¤±è´¥ */ public boolean expire(final String key, final long timeout) &#123; return expire(key, timeout, TimeUnit.SECONDS); &#125; /** * è®¾ç½®æœ‰æ•ˆæ—¶é—´ * * @param key Redisé”® * @param timeout è¶…æ—¶æ—¶é—´ * @param unit æ—¶é—´å•ä½ * @return true=è®¾ç½®æˆåŠŸï¼›false=è®¾ç½®å¤±è´¥ */ public boolean expire(final String key, final long timeout, final TimeUnit unit) &#123; return redisTemplate.expire(key, timeout, unit); &#125; /** * è·å¾—ç¼“å­˜çš„åŸºæœ¬å¯¹è±¡ã€‚ * * @param key ç¼“å­˜é”®å€¼ * @return ç¼“å­˜é”®å€¼å¯¹åº”çš„æ•°æ® */ public &lt;T&gt; T getCacheObject(final String key) &#123; ValueOperations&lt;String, T&gt; operation = redisTemplate.opsForValue(); return operation.get(key); &#125; /** * åˆ é™¤å•ä¸ªå¯¹è±¡ * * @param key */ public boolean deleteObject(final String key) &#123; return redisTemplate.delete(key); &#125; /** * åˆ é™¤é›†åˆå¯¹è±¡ * * @param collection å¤šä¸ªå¯¹è±¡ * @return */ public long deleteObject(final Collection collection) &#123; return redisTemplate.delete(collection); &#125; /** * ç¼“å­˜Listæ•°æ® * * @param key ç¼“å­˜çš„é”®å€¼ * @param dataList å¾…ç¼“å­˜çš„Listæ•°æ® * @return ç¼“å­˜çš„å¯¹è±¡ */ public &lt;T&gt; long setCacheList(final String key, final List&lt;T&gt; dataList) &#123; Long count = redisTemplate.opsForList().rightPushAll(key, dataList); return count == null ? 0 : count; &#125; /** * è·å¾—ç¼“å­˜çš„listå¯¹è±¡ * * @param key ç¼“å­˜çš„é”®å€¼ * @return ç¼“å­˜é”®å€¼å¯¹åº”çš„æ•°æ® */ public &lt;T&gt; List&lt;T&gt; getCacheList(final String key) &#123; return redisTemplate.opsForList().range(key, 0, -1); &#125; /** * ç¼“å­˜Set * * @param key ç¼“å­˜é”®å€¼ * @param dataSet ç¼“å­˜çš„æ•°æ® * @return ç¼“å­˜æ•°æ®çš„å¯¹è±¡ */ public &lt;T&gt; BoundSetOperations&lt;String, T&gt; setCacheSet(final String key, final Set&lt;T&gt; dataSet) &#123; BoundSetOperations&lt;String, T&gt; setOperation = redisTemplate.boundSetOps(key); Iterator&lt;T&gt; it = dataSet.iterator(); while (it.hasNext()) &#123; setOperation.add(it.next()); &#125; return setOperation; &#125; /** * è·å¾—ç¼“å­˜çš„set * * @param key * @return */ public &lt;T&gt; Set&lt;T&gt; getCacheSet(final String key) &#123; return redisTemplate.opsForSet().members(key); &#125; /** * ç¼“å­˜Map * * @param key * @param dataMap */ public &lt;T&gt; void setCacheMap(final String key, final Map&lt;String, T&gt; dataMap) &#123; if (dataMap != null) &#123; redisTemplate.opsForHash().putAll(key, dataMap); &#125; &#125; /** * è·å¾—ç¼“å­˜çš„Map * * @param key * @return */ public &lt;T&gt; Map&lt;String, T&gt; getCacheMap(final String key) &#123; return redisTemplate.opsForHash().entries(key); &#125; /** * å¾€Hashä¸­å­˜å…¥æ•°æ® * * @param key Redisé”® * @param hKey Hashé”® * @param value å€¼ */ public &lt;T&gt; void setCacheMapValue(final String key, final String hKey, final T value) &#123; redisTemplate.opsForHash().put(key, hKey, value); &#125; /** * è·å–Hashä¸­çš„æ•°æ® * * @param key Redisé”® * @param hKey Hashé”® * @return Hashä¸­çš„å¯¹è±¡ */ public &lt;T&gt; T getCacheMapValue(final String key, final String hKey) &#123; HashOperations&lt;String, String, T&gt; opsForHash = redisTemplate.opsForHash(); return opsForHash.get(key, hKey); &#125; /** * åˆ é™¤Hashä¸­çš„æ•°æ® * * @param key * @param hkey */ public void delCacheMapValue(final String key, final String hkey) &#123; HashOperations hashOperations = redisTemplate.opsForHash(); hashOperations.delete(key, hkey); &#125; /** * è·å–å¤šä¸ªHashä¸­çš„æ•°æ® * * @param key Redisé”® * @param hKeys Hashé”®é›†åˆ * @return Hashå¯¹è±¡é›†åˆ */ public &lt;T&gt; List&lt;T&gt; getMultiCacheMapValue(final String key, final Collection&lt;Object&gt; hKeys) &#123; return redisTemplate.opsForHash().multiGet(key, hKeys); &#125; /** * è·å¾—ç¼“å­˜çš„åŸºæœ¬å¯¹è±¡åˆ—è¡¨ * * @param pattern å­—ç¬¦ä¸²å‰ç¼€ * @return å¯¹è±¡åˆ—è¡¨ */ public Collection&lt;String&gt; keys(final String pattern) &#123; return redisTemplate.keys(pattern); &#125;&#125; 12345678910111213141516171819202122232425262728import javax.servlet.http.HttpServletResponse;import java.io.IOException;public class WebUtils&#123; /** * å°†å­—ç¬¦ä¸²æ¸²æŸ“åˆ°å®¢æˆ·ç«¯ * * @param response æ¸²æŸ“å¯¹è±¡ * @param string å¾…æ¸²æŸ“çš„å­—ç¬¦ä¸² * @return null */ public static String renderString(HttpServletResponse response, String string) &#123; try &#123; response.setStatus(200); response.setContentType(&quot;application/json&quot;); response.setCharacterEncoding(&quot;utf-8&quot;); response.getWriter().print(string); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; return null; &#125;&#125; â‘¤å®ä½“ç±» 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576import java.io.Serializable;import java.util.Date;/** * ç”¨æˆ·è¡¨(User)å®ä½“ç±» * * @author ä¸‰æ›´ */@Data@AllArgsConstructor@NoArgsConstructorpublic class User implements Serializable &#123; private static final long serialVersionUID = -40356785423868312L; /** * ä¸»é”® */ private Long id; /** * ç”¨æˆ·å */ private String userName; /** * æ˜µç§° */ private String nickName; /** * å¯†ç  */ private String password; /** * è´¦å·çŠ¶æ€ï¼ˆ0æ­£å¸¸ 1åœç”¨ï¼‰ */ private String status; /** * é‚®ç®± */ private String email; /** * æ‰‹æœºå· */ private String phonenumber; /** * ç”¨æˆ·æ€§åˆ«ï¼ˆ0ç”·ï¼Œ1å¥³ï¼Œ2æœªçŸ¥ï¼‰ */ private String sex; /** * å¤´åƒ */ private String avatar; /** * ç”¨æˆ·ç±»å‹ï¼ˆ0ç®¡ç†å‘˜ï¼Œ1æ™®é€šç”¨æˆ·ï¼‰ */ private String userType; /** * åˆ›å»ºäººçš„ç”¨æˆ·id */ private Long createBy; /** * åˆ›å»ºæ—¶é—´ */ private Date createTime; /** * æ›´æ–°äºº */ private Long updateBy; /** * æ›´æ–°æ—¶é—´ */ private Date updateTime; /** * åˆ é™¤æ ‡å¿—ï¼ˆ0ä»£è¡¨æœªåˆ é™¤ï¼Œ1ä»£è¡¨å·²åˆ é™¤ï¼‰ */ private Integer delFlag;&#125; 2.3.3 å®ç°2.3.3.1 æ•°æ®åº“æ ¡éªŒç”¨æˆ·â€‹ ä»ä¹‹å‰çš„åˆ†ææˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªUserDetailsService,è®©SpringSecurityä½¿ç”¨æˆ‘ä»¬çš„UserDetailsServiceã€‚æˆ‘ä»¬è‡ªå·±çš„UserDetailsServiceå¯ä»¥ä»æ•°æ®åº“ä¸­æŸ¥è¯¢ç”¨æˆ·åå’Œå¯†ç ã€‚ å‡†å¤‡å·¥ä½œâ€‹ æˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªç”¨æˆ·è¡¨ï¼Œ å»ºè¡¨è¯­å¥å¦‚ä¸‹ï¼š 123456789101112131415161718CREATE TABLE `sys_user` ( `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;ä¸»é”®&#x27;, `user_name` VARCHAR(64) NOT NULL DEFAULT &#x27;NULL&#x27; COMMENT &#x27;ç”¨æˆ·å&#x27;, `nick_name` VARCHAR(64) NOT NULL DEFAULT &#x27;NULL&#x27; COMMENT &#x27;æ˜µç§°&#x27;, `password` VARCHAR(64) NOT NULL DEFAULT &#x27;NULL&#x27; COMMENT &#x27;å¯†ç &#x27;, `status` CHAR(1) DEFAULT &#x27;0&#x27; COMMENT &#x27;è´¦å·çŠ¶æ€ï¼ˆ0æ­£å¸¸ 1åœç”¨ï¼‰&#x27;, `email` VARCHAR(64) DEFAULT NULL COMMENT &#x27;é‚®ç®±&#x27;, `phonenumber` VARCHAR(32) DEFAULT NULL COMMENT &#x27;æ‰‹æœºå·&#x27;, `sex` CHAR(1) DEFAULT NULL COMMENT &#x27;ç”¨æˆ·æ€§åˆ«ï¼ˆ0ç”·ï¼Œ1å¥³ï¼Œ2æœªçŸ¥ï¼‰&#x27;, `avatar` VARCHAR(128) DEFAULT NULL COMMENT &#x27;å¤´åƒ&#x27;, `user_type` CHAR(1) NOT NULL DEFAULT &#x27;1&#x27; COMMENT &#x27;ç”¨æˆ·ç±»å‹ï¼ˆ0ç®¡ç†å‘˜ï¼Œ1æ™®é€šç”¨æˆ·ï¼‰&#x27;, `create_by` BIGINT(20) DEFAULT NULL COMMENT &#x27;åˆ›å»ºäººçš„ç”¨æˆ·id&#x27;, `create_time` DATETIME DEFAULT NULL COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;, `update_by` BIGINT(20) DEFAULT NULL COMMENT &#x27;æ›´æ–°äºº&#x27;, `update_time` DATETIME DEFAULT NULL COMMENT &#x27;æ›´æ–°æ—¶é—´&#x27;, `del_flag` INT(11) DEFAULT &#x27;0&#x27; COMMENT &#x27;åˆ é™¤æ ‡å¿—ï¼ˆ0ä»£è¡¨æœªåˆ é™¤ï¼Œ1ä»£è¡¨å·²åˆ é™¤ï¼‰&#x27;, PRIMARY KEY (`id`)) ENGINE=INNODB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;ç”¨æˆ·è¡¨&#x27; â€‹ å¼•å…¥MybatisPulså’Œmysqlé©±åŠ¨çš„ä¾èµ– 123456789&lt;dependency&gt; &lt;groupId&gt;com.baomidou&lt;/groupId&gt; &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt; &lt;version&gt;3.4.3&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;mysql&lt;/groupId&gt; &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;&lt;/dependency&gt; â€‹ é…ç½®æ•°æ®åº“ä¿¡æ¯ 123456spring: datasource: url: jdbc:mysql://localhost:3306/sg_security?characterEncoding=utf-8&amp;serverTimezone=UTC username: root password: root driver-class-name: com.mysql.cj.jdbc.Driver â€‹ å®šä¹‰Mapperæ¥å£ 12public interface UserMapper extends BaseMapper&lt;User&gt; &#123;&#125; â€‹ ä¿®æ”¹Userå®ä½“ç±» 1ç±»åä¸ŠåŠ @TableName(value = &quot;sys_user&quot;) ,idå­—æ®µä¸ŠåŠ  @TableId â€‹ é…ç½®Mapperæ‰«æ 12345678@SpringBootApplication@MapperScan(&quot;com.sangeng.mapper&quot;)public class SimpleSecurityApplication &#123; public static void main(String[] args) &#123; ConfigurableApplicationContext run = SpringApplication.run(SimpleSecurityApplication.class); System.out.println(run); &#125;&#125; â€‹ æ·»åŠ junitä¾èµ– 1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;&lt;/dependency&gt; â€‹ æµ‹è¯•MPæ˜¯å¦èƒ½æ­£å¸¸ä½¿ç”¨ 123456789101112131415/** * @Author ä¸‰æ›´ Bç«™ï¼š https://space.bilibili.com/663528522 */@SpringBootTestpublic class MapperTest &#123; @Autowired private UserMapper userMapper; @Test public void testUserMapper()&#123; List&lt;User&gt; users = userMapper.selectList(null); System.out.println(users); &#125;&#125; æ ¸å¿ƒä»£ç å®ç°åˆ›å»ºä¸€ä¸ªç±»å®ç°UserDetailsServiceæ¥å£ï¼Œé‡å†™å…¶ä¸­çš„æ–¹æ³•ã€‚æ›´åŠ ç”¨æˆ·åä»æ•°æ®åº“ä¸­æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ 12345678910111213141516171819202122232425/** * @Author ä¸‰æ›´ Bç«™ï¼š https://space.bilibili.com/663528522 */@Servicepublic class UserDetailsServiceImpl implements UserDetailsService &#123; @Autowired private UserMapper userMapper; @Override public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123; //æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ LambdaQueryWrapper&lt;User&gt; wrapper = new LambdaQueryWrapper&lt;&gt;(); wrapper.eq(User::getUserName,username); User user = userMapper.selectOne(wrapper); //å¦‚æœæŸ¥è¯¢ä¸åˆ°æ•°æ®å°±é€šè¿‡æŠ›å‡ºå¼‚å¸¸æ¥ç»™å‡ºæç¤º if(Objects.isNull(user))&#123; throw new RuntimeException(&quot;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯&quot;); &#125; //TODO æ ¹æ®ç”¨æˆ·æŸ¥è¯¢æƒé™ä¿¡æ¯ æ·»åŠ åˆ°LoginUserä¸­ //å°è£…æˆUserDetailså¯¹è±¡è¿”å› return new LoginUser(user); &#125;&#125; å› ä¸ºUserDetailsServiceæ–¹æ³•çš„è¿”å›å€¼æ˜¯UserDetailsç±»å‹ï¼Œæ‰€ä»¥éœ€è¦å®šä¹‰ä¸€ä¸ªç±»ï¼Œå®ç°è¯¥æ¥å£ï¼ŒæŠŠç”¨æˆ·ä¿¡æ¯å°è£…åœ¨å…¶ä¸­ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546/** * @Author ä¸‰æ›´ Bç«™ï¼š https://space.bilibili.com/663528522 */@Data@NoArgsConstructor@AllArgsConstructorpublic class LoginUser implements UserDetails &#123; private User user; @Override public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() &#123; return null; &#125; @Override public String getPassword() &#123; return user.getPassword(); &#125; @Override public String getUsername() &#123; return user.getUserName(); &#125; @Override public boolean isAccountNonExpired() &#123; return true; &#125; @Override public boolean isAccountNonLocked() &#123; return true; &#125; @Override public boolean isCredentialsNonExpired() &#123; return true; &#125; @Override public boolean isEnabled() &#123; return true; &#125;&#125; æ³¨æ„ï¼šå¦‚æœè¦æµ‹è¯•ï¼Œéœ€è¦å¾€ç”¨æˆ·è¡¨ä¸­å†™å…¥ç”¨æˆ·æ•°æ®ï¼Œå¹¶ä¸”å¦‚æœä½ æƒ³è®©ç”¨æˆ·çš„å¯†ç æ˜¯æ˜æ–‡å­˜å‚¨ï¼Œéœ€è¦åœ¨å¯†ç å‰åŠ {noop}ã€‚ä¾‹å¦‚ è¿™æ ·ç™»é™†çš„æ—¶å€™å°±å¯ä»¥ç”¨sgä½œä¸ºç”¨æˆ·åï¼Œ1234ä½œä¸ºå¯†ç æ¥ç™»é™†äº†ã€‚ 2.3.3.2 å¯†ç åŠ å¯†å­˜å‚¨â€‹ å®é™…é¡¹ç›®ä¸­æˆ‘ä»¬ä¸ä¼šæŠŠå¯†ç æ˜æ–‡å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚ â€‹ é»˜è®¤ä½¿ç”¨çš„PasswordEncoderè¦æ±‚æ•°æ®åº“ä¸­çš„å¯†ç æ ¼å¼ä¸ºï¼š{id}password ã€‚å®ƒä¼šæ ¹æ®idå»åˆ¤æ–­å¯†ç çš„åŠ å¯†æ–¹å¼ã€‚ä½†æ˜¯æˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šé‡‡ç”¨è¿™ç§æ–¹å¼ã€‚æ‰€ä»¥å°±éœ€è¦æ›¿æ¢PasswordEncoderã€‚ â€‹ æˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨SpringSecurityä¸ºæˆ‘ä»¬æä¾›çš„BCryptPasswordEncoderã€‚ â€‹ æˆ‘ä»¬åªéœ€è¦ä½¿ç”¨æŠŠBCryptPasswordEncoderå¯¹è±¡æ³¨å…¥Springå®¹å™¨ä¸­ï¼ŒSpringSecurityå°±ä¼šä½¿ç”¨è¯¥PasswordEncoderæ¥è¿›è¡Œå¯†ç æ ¡éªŒã€‚ â€‹ æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªSpringSecurityçš„é…ç½®ç±»ï¼ŒSpringSecurityè¦æ±‚è¿™ä¸ªé…ç½®ç±»è¦ç»§æ‰¿WebSecurityConfigurerAdapterã€‚ 12345678910111213/** * @Author ä¸‰æ›´ Bç«™ï¼š https://space.bilibili.com/663528522 */@Configurationpublic class SecurityConfig extends WebSecurityConfigurerAdapter &#123; @Bean public PasswordEncoder passwordEncoder()&#123; return new BCryptPasswordEncoder(); &#125;&#125; 2.3.3.3 ç™»é™†æ¥å£â€‹ æ¥ä¸‹æˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ç™»é™†æ¥å£ï¼Œç„¶åè®©SpringSecurityå¯¹è¿™ä¸ªæ¥å£æ”¾è¡Œ,è®©ç”¨æˆ·è®¿é—®è¿™ä¸ªæ¥å£çš„æ—¶å€™ä¸ç”¨ç™»å½•ä¹Ÿèƒ½è®¿é—®ã€‚ â€‹ åœ¨æ¥å£ä¸­æˆ‘ä»¬é€šè¿‡AuthenticationManagerçš„authenticateæ–¹æ³•æ¥è¿›è¡Œç”¨æˆ·è®¤è¯,æ‰€ä»¥éœ€è¦åœ¨SecurityConfigä¸­é…ç½®æŠŠAuthenticationManageræ³¨å…¥å®¹å™¨ã€‚ â€‹ è®¤è¯æˆåŠŸçš„è¯è¦ç”Ÿæˆä¸€ä¸ªjwtï¼Œæ”¾å…¥å“åº”ä¸­è¿”å›ã€‚å¹¶ä¸”ä¸ºäº†è®©ç”¨æˆ·ä¸‹å›è¯·æ±‚æ—¶èƒ½é€šè¿‡jwtè¯†åˆ«å‡ºå…·ä½“çš„æ˜¯å“ªä¸ªç”¨æˆ·ï¼Œæˆ‘ä»¬éœ€è¦æŠŠç”¨æˆ·ä¿¡æ¯å­˜å…¥redisï¼Œå¯ä»¥æŠŠç”¨æˆ·idä½œä¸ºkeyã€‚ 123456789101112@RestControllerpublic class LoginController &#123; @Autowired private LoginServcie loginServcie; @PostMapping(&quot;/user/login&quot;) public ResponseResult login(@RequestBody User user)&#123; return loginServcie.login(user); &#125;&#125; 123456789101112131415161718192021222324252627282930313233/** * @Author ä¸‰æ›´ Bç«™ï¼š https://space.bilibili.com/663528522 */@Configurationpublic class SecurityConfig extends WebSecurityConfigurerAdapter &#123; @Bean public PasswordEncoder passwordEncoder()&#123; return new BCryptPasswordEncoder(); &#125; @Override protected void configure(HttpSecurity http) throws Exception &#123; http //å…³é—­csrf .csrf().disable() //ä¸é€šè¿‡Sessionè·å–SecurityContext .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS) .and() .authorizeRequests() // å¯¹äºç™»å½•æ¥å£ å…è®¸åŒ¿åè®¿é—® .antMatchers(&quot;/user/login&quot;).anonymous() // é™¤ä¸Šé¢å¤–çš„æ‰€æœ‰è¯·æ±‚å…¨éƒ¨éœ€è¦é‰´æƒè®¤è¯ .anyRequest().authenticated(); &#125; @Bean @Override public AuthenticationManager authenticationManagerBean() throws Exception &#123; return super.authenticationManagerBean(); &#125;&#125; â€‹ 12345678910111213141516171819202122232425262728@Servicepublic class LoginServiceImpl implements LoginServcie &#123; @Autowired private AuthenticationManager authenticationManager; @Autowired private RedisCache redisCache; @Override public ResponseResult login(User user) &#123; UsernamePasswordAuthenticationToken authenticationToken = new UsernamePasswordAuthenticationToken(user.getUserName(),user.getPassword()); Authentication authenticate = authenticationManager.authenticate(authenticationToken); if(Objects.isNull(authenticate))&#123; throw new RuntimeException(&quot;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯&quot;); &#125; //ä½¿ç”¨useridç”Ÿæˆtoken LoginUser loginUser = (LoginUser) authenticate.getPrincipal(); String userId = loginUser.getUser().getId().toString(); String jwt = JwtUtil.createJWT(userId); //authenticateå­˜å…¥redis redisCache.setCacheObject(&quot;login:&quot;+userId,loginUser); //æŠŠtokenå“åº”ç»™å‰ç«¯ HashMap&lt;String,String&gt; map = new HashMap&lt;&gt;(); map.put(&quot;token&quot;,jwt); return new ResponseResult(200,&quot;ç™»é™†æˆåŠŸ&quot;,map); &#125;&#125; 2.3.3.4 è®¤è¯è¿‡æ»¤å™¨â€‹ æˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œè¿™ä¸ªè¿‡æ»¤å™¨ä¼šå»è·å–è¯·æ±‚å¤´ä¸­çš„tokenï¼Œå¯¹tokenè¿›è¡Œè§£æå–å‡ºå…¶ä¸­çš„useridã€‚ â€‹ ä½¿ç”¨useridå»redisä¸­è·å–å¯¹åº”çš„LoginUserå¯¹è±¡ã€‚ â€‹ ç„¶åå°è£…Authenticationå¯¹è±¡å­˜å…¥SecurityContextHolder 123456789101112131415161718192021222324252627282930313233343536373839@Componentpublic class JwtAuthenticationTokenFilter extends OncePerRequestFilter &#123; @Autowired private RedisCache redisCache; @Override protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException &#123; //è·å–token String token = request.getHeader(&quot;token&quot;); if (!StringUtils.hasText(token)) &#123; //æ”¾è¡Œ filterChain.doFilter(request, response); return; &#125; //è§£ætoken String userid; try &#123; Claims claims = JwtUtil.parseJWT(token); userid = claims.getSubject(); &#125; catch (Exception e) &#123; e.printStackTrace(); throw new RuntimeException(&quot;tokenéæ³•&quot;); &#125; //ä»redisä¸­è·å–ç”¨æˆ·ä¿¡æ¯ String redisKey = &quot;login:&quot; + userid; LoginUser loginUser = redisCache.getCacheObject(redisKey); if(Objects.isNull(loginUser))&#123; throw new RuntimeException(&quot;ç”¨æˆ·æœªç™»å½•&quot;); &#125; //å­˜å…¥SecurityContextHolder //TODO è·å–æƒé™ä¿¡æ¯å°è£…åˆ°Authenticationä¸­ UsernamePasswordAuthenticationToken authenticationToken = new UsernamePasswordAuthenticationToken(loginUser,null,null); SecurityContextHolder.getContext().setAuthentication(authenticationToken); //æ”¾è¡Œ filterChain.doFilter(request, response); &#125;&#125; 1234567891011121314151617181920212223242526272829303132333435363738394041/** * @Author ä¸‰æ›´ Bç«™ï¼š https://space.bilibili.com/663528522 */@Configurationpublic class SecurityConfig extends WebSecurityConfigurerAdapter &#123; @Bean public PasswordEncoder passwordEncoder()&#123; return new BCryptPasswordEncoder(); &#125; @Autowired JwtAuthenticationTokenFilter jwtAuthenticationTokenFilter; @Override protected void configure(HttpSecurity http) throws Exception &#123; http //å…³é—­csrf .csrf().disable() //ä¸é€šè¿‡Sessionè·å–SecurityContext .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS) .and() .authorizeRequests() // å¯¹äºç™»å½•æ¥å£ å…è®¸åŒ¿åè®¿é—® .antMatchers(&quot;/user/login&quot;).anonymous() // é™¤ä¸Šé¢å¤–çš„æ‰€æœ‰è¯·æ±‚å…¨éƒ¨éœ€è¦é‰´æƒè®¤è¯ .anyRequest().authenticated(); //æŠŠtokenæ ¡éªŒè¿‡æ»¤å™¨æ·»åŠ åˆ°è¿‡æ»¤å™¨é“¾ä¸­ http.addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class); &#125; @Bean @Override public AuthenticationManager authenticationManagerBean() throws Exception &#123; return super.authenticationManagerBean(); &#125;&#125; 2.3.3.5 é€€å‡ºç™»é™†â€‹ æˆ‘ä»¬åªéœ€è¦å®šä¹‰ä¸€ä¸ªç™»é™†æ¥å£ï¼Œç„¶åè·å–SecurityContextHolderä¸­çš„è®¤è¯ä¿¡æ¯ï¼Œåˆ é™¤redisä¸­å¯¹åº”çš„æ•°æ®å³å¯ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940/** * @Author ä¸‰æ›´ Bç«™ï¼š https://space.bilibili.com/663528522 */@Servicepublic class LoginServiceImpl implements LoginServcie &#123; @Autowired private AuthenticationManager authenticationManager; @Autowired private RedisCache redisCache; @Override public ResponseResult login(User user) &#123; UsernamePasswordAuthenticationToken authenticationToken = new UsernamePasswordAuthenticationToken(user.getUserName(),user.getPassword()); Authentication authenticate = authenticationManager.authenticate(authenticationToken); if(Objects.isNull(authenticate))&#123; throw new RuntimeException(&quot;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯&quot;); &#125; //ä½¿ç”¨useridç”Ÿæˆtoken LoginUser loginUser = (LoginUser) authenticate.getPrincipal(); String userId = loginUser.getUser().getId().toString(); String jwt = JwtUtil.createJWT(userId); //authenticateå­˜å…¥redis redisCache.setCacheObject(&quot;login:&quot;+userId,loginUser); //æŠŠtokenå“åº”ç»™å‰ç«¯ HashMap&lt;String,String&gt; map = new HashMap&lt;&gt;(); map.put(&quot;token&quot;,jwt); return new ResponseResult(200,&quot;ç™»é™†æˆåŠŸ&quot;,map); &#125; @Override public ResponseResult logout() &#123; Authentication authentication = SecurityContextHolder.getContext().getAuthentication(); LoginUser loginUser = (LoginUser) authentication.getPrincipal(); Long userid = loginUser.getUser().getId(); redisCache.deleteObject(&quot;login:&quot;+userid); return new ResponseResult(200,&quot;é€€å‡ºæˆåŠŸ&quot;); &#125;&#125; 3. æˆæƒ3.0 æƒé™ç³»ç»Ÿçš„ä½œç”¨â€‹ ä¾‹å¦‚ä¸€ä¸ªå­¦æ ¡å›¾ä¹¦é¦†çš„ç®¡ç†ç³»ç»Ÿï¼Œå¦‚æœæ˜¯æ™®é€šå­¦ç”Ÿç™»å½•å°±èƒ½çœ‹åˆ°å€Ÿä¹¦è¿˜ä¹¦ç›¸å…³çš„åŠŸèƒ½ï¼Œä¸å¯èƒ½è®©ä»–çœ‹åˆ°å¹¶ä¸”å»ä½¿ç”¨æ·»åŠ ä¹¦ç±ä¿¡æ¯ï¼Œåˆ é™¤ä¹¦ç±ä¿¡æ¯ç­‰åŠŸèƒ½ã€‚ä½†æ˜¯å¦‚æœæ˜¯ä¸€ä¸ªå›¾ä¹¦é¦†ç®¡ç†å‘˜çš„è´¦å·ç™»å½•äº†ï¼Œåº”è¯¥å°±èƒ½çœ‹åˆ°å¹¶ä½¿ç”¨æ·»åŠ ä¹¦ç±ä¿¡æ¯ï¼Œåˆ é™¤ä¹¦ç±ä¿¡æ¯ç­‰åŠŸèƒ½ã€‚ â€‹ æ€»ç»“èµ·æ¥å°±æ˜¯ä¸åŒçš„ç”¨æˆ·å¯ä»¥ä½¿ç”¨ä¸åŒçš„åŠŸèƒ½ã€‚è¿™å°±æ˜¯æƒé™ç³»ç»Ÿè¦å»å®ç°çš„æ•ˆæœã€‚ â€‹ æˆ‘ä»¬ä¸èƒ½åªä¾èµ–å‰ç«¯å»åˆ¤æ–­ç”¨æˆ·çš„æƒé™æ¥é€‰æ‹©æ˜¾ç¤ºå“ªäº›èœå•å“ªäº›æŒ‰é’®ã€‚å› ä¸ºå¦‚æœåªæ˜¯è¿™æ ·ï¼Œå¦‚æœæœ‰äººçŸ¥é“äº†å¯¹åº”åŠŸèƒ½çš„æ¥å£åœ°å€å°±å¯ä»¥ä¸é€šè¿‡å‰ç«¯ï¼Œç›´æ¥å»å‘é€è¯·æ±‚æ¥å®ç°ç›¸å…³åŠŸèƒ½æ“ä½œã€‚ â€‹ æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦åœ¨åå°è¿›è¡Œç”¨æˆ·æƒé™çš„åˆ¤æ–­ï¼Œåˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰ç›¸åº”çš„æƒé™ï¼Œå¿…é¡»å…·æœ‰æ‰€éœ€æƒé™æ‰èƒ½è¿›è¡Œç›¸åº”çš„æ“ä½œã€‚ â€‹ 3.1 æˆæƒåŸºæœ¬æµç¨‹â€‹ åœ¨SpringSecurityä¸­ï¼Œä¼šä½¿ç”¨é»˜è®¤çš„FilterSecurityInterceptoræ¥è¿›è¡Œæƒé™æ ¡éªŒã€‚åœ¨FilterSecurityInterceptorä¸­ä¼šä»SecurityContextHolderè·å–å…¶ä¸­çš„Authenticationï¼Œç„¶åè·å–å…¶ä¸­çš„æƒé™ä¿¡æ¯ã€‚å½“å‰ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰è®¿é—®å½“å‰èµ„æºæ‰€éœ€çš„æƒé™ã€‚ â€‹ æ‰€ä»¥æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­åªéœ€è¦æŠŠå½“å‰ç™»å½•ç”¨æˆ·çš„æƒé™ä¿¡æ¯ä¹Ÿå­˜å…¥Authenticationã€‚ â€‹ ç„¶åè®¾ç½®æˆ‘ä»¬çš„èµ„æºæ‰€éœ€è¦çš„æƒé™å³å¯ã€‚ 3.2 æˆæƒå®ç°3.2.1 é™åˆ¶è®¿é—®èµ„æºæ‰€éœ€æƒé™â€‹ SpringSecurityä¸ºæˆ‘ä»¬æä¾›äº†åŸºäºæ³¨è§£çš„æƒé™æ§åˆ¶æ–¹æ¡ˆï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬é¡¹ç›®ä¸­ä¸»è¦é‡‡ç”¨çš„æ–¹å¼ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ³¨è§£å»æŒ‡å®šè®¿é—®å¯¹åº”çš„èµ„æºæ‰€éœ€çš„æƒé™ã€‚ â€‹ ä½†æ˜¯è¦ä½¿ç”¨å®ƒæˆ‘ä»¬éœ€è¦å…ˆå¼€å¯ç›¸å…³é…ç½®ã€‚ 1@EnableGlobalMethodSecurity(prePostEnabled = true) â€‹ ç„¶åå°±å¯ä»¥ä½¿ç”¨å¯¹åº”çš„æ³¨è§£ã€‚@PreAuthorize 123456789@RestControllerpublic class HelloController &#123; @RequestMapping(&quot;/hello&quot;) @PreAuthorize(&quot;hasAuthority(&#x27;test&#x27;)&quot;) public String hello()&#123; return &quot;hello&quot;; &#125;&#125; 3.2.2 å°è£…æƒé™ä¿¡æ¯â€‹ æˆ‘ä»¬å‰é¢åœ¨å†™UserDetailsServiceImplçš„æ—¶å€™è¯´è¿‡ï¼Œåœ¨æŸ¥è¯¢å‡ºç”¨æˆ·åè¿˜è¦è·å–å¯¹åº”çš„æƒé™ä¿¡æ¯ï¼Œå°è£…åˆ°UserDetailsä¸­è¿”å›ã€‚ â€‹ æˆ‘ä»¬å…ˆç›´æ¥æŠŠæƒé™ä¿¡æ¯å†™æ­»å°è£…åˆ°UserDetailsä¸­è¿›è¡Œæµ‹è¯•ã€‚ â€‹ æˆ‘ä»¬ä¹‹å‰å®šä¹‰äº†UserDetailsçš„å®ç°ç±»LoginUserï¼Œæƒ³è¦è®©å…¶èƒ½å°è£…æƒé™ä¿¡æ¯å°±è¦å¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980package com.sangeng.domain;import com.alibaba.fastjson.annotation.JSONField;import lombok.AllArgsConstructor;import lombok.Data;import lombok.NoArgsConstructor;import org.springframework.security.core.GrantedAuthority;import org.springframework.security.core.authority.SimpleGrantedAuthority;import org.springframework.security.core.userdetails.UserDetails;import java.util.Collection;import java.util.List;import java.util.stream.Collectors;/** * @Author ä¸‰æ›´ Bç«™ï¼š https://space.bilibili.com/663528522 */@Data@NoArgsConstructorpublic class LoginUser implements UserDetails &#123; private User user; //å­˜å‚¨æƒé™ä¿¡æ¯ private List&lt;String&gt; permissions; public LoginUser(User user,List&lt;String&gt; permissions) &#123; this.user = user; this.permissions = permissions; &#125; //å­˜å‚¨SpringSecurityæ‰€éœ€è¦çš„æƒé™ä¿¡æ¯çš„é›†åˆ @JSONField(serialize = false) private List&lt;GrantedAuthority&gt; authorities; @Override public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() &#123; if(authorities!=null)&#123; return authorities; &#125; //æŠŠpermissionsä¸­å­—ç¬¦ä¸²ç±»å‹çš„æƒé™ä¿¡æ¯è½¬æ¢æˆGrantedAuthorityå¯¹è±¡å­˜å…¥authoritiesä¸­ authorities = permissions.stream(). map(SimpleGrantedAuthority::new) .collect(Collectors.toList()); return authorities; &#125; @Override public String getPassword() &#123; return user.getPassword(); &#125; @Override public String getUsername() &#123; return user.getUserName(); &#125; @Override public boolean isAccountNonExpired() &#123; return true; &#125; @Override public boolean isAccountNonLocked() &#123; return true; &#125; @Override public boolean isCredentialsNonExpired() &#123; return true; &#125; @Override public boolean isEnabled() &#123; return true; &#125;&#125; â€‹ LoginUserä¿®æ”¹å®Œåæˆ‘ä»¬å°±å¯ä»¥åœ¨UserDetailsServiceImplä¸­å»æŠŠæƒé™ä¿¡æ¯å°è£…åˆ°LoginUserä¸­äº†ã€‚æˆ‘ä»¬å†™æ­»æƒé™è¿›è¡Œæµ‹è¯•ï¼Œåé¢æˆ‘ä»¬å†ä»æ•°æ®åº“ä¸­æŸ¥è¯¢æƒé™ä¿¡æ¯ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142package com.sangeng.service.impl;import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;import com.baomidou.mybatisplus.extension.conditions.query.LambdaQueryChainWrapper;import com.sangeng.domain.LoginUser;import com.sangeng.domain.User;import com.sangeng.mapper.UserMapper;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.security.core.userdetails.UserDetails;import org.springframework.security.core.userdetails.UserDetailsService;import org.springframework.security.core.userdetails.UsernameNotFoundException;import org.springframework.stereotype.Service;import java.util.ArrayList;import java.util.Arrays;import java.util.List;import java.util.Objects;/** * @Author ä¸‰æ›´ Bç«™ï¼š https://space.bilibili.com/663528522 */@Servicepublic class UserDetailsServiceImpl implements UserDetailsService &#123; @Autowired private UserMapper userMapper; @Override public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123; LambdaQueryWrapper&lt;User&gt; wrapper = new LambdaQueryWrapper&lt;&gt;(); wrapper.eq(User::getUserName,username); User user = userMapper.selectOne(wrapper); if(Objects.isNull(user))&#123; throw new RuntimeException(&quot;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯&quot;); &#125; //TODO æ ¹æ®ç”¨æˆ·æŸ¥è¯¢æƒé™ä¿¡æ¯ æ·»åŠ åˆ°LoginUserä¸­ List&lt;String&gt; list = new ArrayList&lt;&gt;(Arrays.asList(&quot;test&quot;)); return new LoginUser(user,list); &#125;&#125; 3.2.3 ä»æ•°æ®åº“æŸ¥è¯¢æƒé™ä¿¡æ¯3.2.3.1 RBACæƒé™æ¨¡å‹â€‹ RBACæƒé™æ¨¡å‹ï¼ˆRole-Based Access Controlï¼‰å³ï¼šåŸºäºè§’è‰²çš„æƒé™æ§åˆ¶ã€‚è¿™æ˜¯ç›®å‰æœ€å¸¸è¢«å¼€å‘è€…ä½¿ç”¨ä¹Ÿæ˜¯ç›¸å¯¹æ˜“ç”¨ã€é€šç”¨æƒé™æ¨¡å‹ã€‚ â€‹ 3.2.3.2 å‡†å¤‡å·¥ä½œ12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788CREATE DATABASE /*!32312 IF NOT EXISTS*/`sg_security` /*!40100 DEFAULT CHARACTER SET utf8mb4 */;USE `sg_security`;/*Table structure for table `sys_menu` */DROP TABLE IF EXISTS `sys_menu`;CREATE TABLE `sys_menu` ( `id` bigint(20) NOT NULL AUTO_INCREMENT, `menu_name` varchar(64) NOT NULL DEFAULT &#x27;NULL&#x27; COMMENT &#x27;èœå•å&#x27;, `path` varchar(200) DEFAULT NULL COMMENT &#x27;è·¯ç”±åœ°å€&#x27;, `component` varchar(255) DEFAULT NULL COMMENT &#x27;ç»„ä»¶è·¯å¾„&#x27;, `visible` char(1) DEFAULT &#x27;0&#x27; COMMENT &#x27;èœå•çŠ¶æ€ï¼ˆ0æ˜¾ç¤º 1éšè—ï¼‰&#x27;, `status` char(1) DEFAULT &#x27;0&#x27; COMMENT &#x27;èœå•çŠ¶æ€ï¼ˆ0æ­£å¸¸ 1åœç”¨ï¼‰&#x27;, `perms` varchar(100) DEFAULT NULL COMMENT &#x27;æƒé™æ ‡è¯†&#x27;, `icon` varchar(100) DEFAULT &#x27;#&#x27; COMMENT &#x27;èœå•å›¾æ ‡&#x27;, `create_by` bigint(20) DEFAULT NULL, `create_time` datetime DEFAULT NULL, `update_by` bigint(20) DEFAULT NULL, `update_time` datetime DEFAULT NULL, `del_flag` int(11) DEFAULT &#x27;0&#x27; COMMENT &#x27;æ˜¯å¦åˆ é™¤ï¼ˆ0æœªåˆ é™¤ 1å·²åˆ é™¤ï¼‰&#x27;, `remark` varchar(500) DEFAULT NULL COMMENT &#x27;å¤‡æ³¨&#x27;, PRIMARY KEY (`id`)) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;èœå•è¡¨&#x27;;/*Table structure for table `sys_role` */DROP TABLE IF EXISTS `sys_role`;CREATE TABLE `sys_role` ( `id` bigint(20) NOT NULL AUTO_INCREMENT, `name` varchar(128) DEFAULT NULL, `role_key` varchar(100) DEFAULT NULL COMMENT &#x27;è§’è‰²æƒé™å­—ç¬¦ä¸²&#x27;, `status` char(1) DEFAULT &#x27;0&#x27; COMMENT &#x27;è§’è‰²çŠ¶æ€ï¼ˆ0æ­£å¸¸ 1åœç”¨ï¼‰&#x27;, `del_flag` int(1) DEFAULT &#x27;0&#x27; COMMENT &#x27;del_flag&#x27;, `create_by` bigint(200) DEFAULT NULL, `create_time` datetime DEFAULT NULL, `update_by` bigint(200) DEFAULT NULL, `update_time` datetime DEFAULT NULL, `remark` varchar(500) DEFAULT NULL COMMENT &#x27;å¤‡æ³¨&#x27;, PRIMARY KEY (`id`)) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;è§’è‰²è¡¨&#x27;;/*Table structure for table `sys_role_menu` */DROP TABLE IF EXISTS `sys_role_menu`;CREATE TABLE `sys_role_menu` ( `role_id` bigint(200) NOT NULL AUTO_INCREMENT COMMENT &#x27;è§’è‰²ID&#x27;, `menu_id` bigint(200) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;èœå•id&#x27;, PRIMARY KEY (`role_id`,`menu_id`)) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4;/*Table structure for table `sys_user` */DROP TABLE IF EXISTS `sys_user`;CREATE TABLE `sys_user` ( `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;ä¸»é”®&#x27;, `user_name` varchar(64) NOT NULL DEFAULT &#x27;NULL&#x27; COMMENT &#x27;ç”¨æˆ·å&#x27;, `nick_name` varchar(64) NOT NULL DEFAULT &#x27;NULL&#x27; COMMENT &#x27;æ˜µç§°&#x27;, `password` varchar(64) NOT NULL DEFAULT &#x27;NULL&#x27; COMMENT &#x27;å¯†ç &#x27;, `status` char(1) DEFAULT &#x27;0&#x27; COMMENT &#x27;è´¦å·çŠ¶æ€ï¼ˆ0æ­£å¸¸ 1åœç”¨ï¼‰&#x27;, `email` varchar(64) DEFAULT NULL COMMENT &#x27;é‚®ç®±&#x27;, `phonenumber` varchar(32) DEFAULT NULL COMMENT &#x27;æ‰‹æœºå·&#x27;, `sex` char(1) DEFAULT NULL COMMENT &#x27;ç”¨æˆ·æ€§åˆ«ï¼ˆ0ç”·ï¼Œ1å¥³ï¼Œ2æœªçŸ¥ï¼‰&#x27;, `avatar` varchar(128) DEFAULT NULL COMMENT &#x27;å¤´åƒ&#x27;, `user_type` char(1) NOT NULL DEFAULT &#x27;1&#x27; COMMENT &#x27;ç”¨æˆ·ç±»å‹ï¼ˆ0ç®¡ç†å‘˜ï¼Œ1æ™®é€šç”¨æˆ·ï¼‰&#x27;, `create_by` bigint(20) DEFAULT NULL COMMENT &#x27;åˆ›å»ºäººçš„ç”¨æˆ·id&#x27;, `create_time` datetime DEFAULT NULL COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;, `update_by` bigint(20) DEFAULT NULL COMMENT &#x27;æ›´æ–°äºº&#x27;, `update_time` datetime DEFAULT NULL COMMENT &#x27;æ›´æ–°æ—¶é—´&#x27;, `del_flag` int(11) DEFAULT &#x27;0&#x27; COMMENT &#x27;åˆ é™¤æ ‡å¿—ï¼ˆ0ä»£è¡¨æœªåˆ é™¤ï¼Œ1ä»£è¡¨å·²åˆ é™¤ï¼‰&#x27;, PRIMARY KEY (`id`)) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;ç”¨æˆ·è¡¨&#x27;;/*Table structure for table `sys_user_role` */DROP TABLE IF EXISTS `sys_user_role`;CREATE TABLE `sys_user_role` ( `user_id` bigint(200) NOT NULL AUTO_INCREMENT COMMENT &#x27;ç”¨æˆ·id&#x27;, `role_id` bigint(200) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;è§’è‰²id&#x27;, PRIMARY KEY (`user_id`,`role_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4; 1234567891011SELECT DISTINCT m.`perms`FROM sys_user_role ur LEFT JOIN `sys_role` r ON ur.`role_id` = r.`id` LEFT JOIN `sys_role_menu` rm ON ur.`role_id` = rm.`role_id` LEFT JOIN `sys_menu` m ON m.`id` = rm.`menu_id`WHERE user_id = 2 AND r.`status` = 0 AND m.`status` = 0 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273package com.sangeng.domain;import com.baomidou.mybatisplus.annotation.TableId;import com.baomidou.mybatisplus.annotation.TableName;import com.fasterxml.jackson.annotation.JsonInclude;import lombok.AllArgsConstructor;import lombok.Data;import lombok.NoArgsConstructor;import java.io.Serializable;import java.util.Date;/** * èœå•è¡¨(Menu)å®ä½“ç±» * * @author makejava * @since 2021-11-24 15:30:08 */@TableName(value=&quot;sys_menu&quot;)@Data@AllArgsConstructor@NoArgsConstructor@JsonInclude(JsonInclude.Include.NON_NULL)public class Menu implements Serializable &#123; private static final long serialVersionUID = -54979041104113736L; @TableId private Long id; /** * èœå•å */ private String menuName; /** * è·¯ç”±åœ°å€ */ private String path; /** * ç»„ä»¶è·¯å¾„ */ private String component; /** * èœå•çŠ¶æ€ï¼ˆ0æ˜¾ç¤º 1éšè—ï¼‰ */ private String visible; /** * èœå•çŠ¶æ€ï¼ˆ0æ­£å¸¸ 1åœç”¨ï¼‰ */ private String status; /** * æƒé™æ ‡è¯† */ private String perms; /** * èœå•å›¾æ ‡ */ private String icon; private Long createBy; private Date createTime; private Long updateBy; private Date updateTime; /** * æ˜¯å¦åˆ é™¤ï¼ˆ0æœªåˆ é™¤ 1å·²åˆ é™¤ï¼‰ */ private Integer delFlag; /** * å¤‡æ³¨ */ private String remark;&#125; 3.2.3.3 ä»£ç å®ç°â€‹ æˆ‘ä»¬åªéœ€è¦æ ¹æ®ç”¨æˆ·idå»æŸ¥è¯¢åˆ°å…¶æ‰€å¯¹åº”çš„æƒé™ä¿¡æ¯å³å¯ã€‚ â€‹ æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…ˆå®šä¹‰ä¸ªmapperï¼Œå…¶ä¸­æä¾›ä¸€ä¸ªæ–¹æ³•å¯ä»¥æ ¹æ®useridæŸ¥è¯¢æƒé™ä¿¡æ¯ã€‚ 1234567891011import com.baomidou.mybatisplus.core.mapper.BaseMapper;import com.sangeng.domain.Menu;import java.util.List;/** * @Author ä¸‰æ›´ Bç«™ï¼š https://space.bilibili.com/663528522 */public interface MenuMapper extends BaseMapper&lt;Menu&gt; &#123; List&lt;String&gt; selectPermsByUserId(Long id);&#125; â€‹ å°¤å…¶æ˜¯è‡ªå®šä¹‰æ–¹æ³•ï¼Œæ‰€ä»¥éœ€è¦åˆ›å»ºå¯¹åº”çš„mapperæ–‡ä»¶ï¼Œå®šä¹‰å¯¹åº”çš„sqlè¯­å¥ 12345678910111213141516171819&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot; &gt;&lt;mapper namespace=&quot;com.sangeng.mapper.MenuMapper&quot;&gt; &lt;select id=&quot;selectPermsByUserId&quot; resultType=&quot;java.lang.String&quot;&gt; SELECT DISTINCT m.`perms` FROM sys_user_role ur LEFT JOIN `sys_role` r ON ur.`role_id` = r.`id` LEFT JOIN `sys_role_menu` rm ON ur.`role_id` = rm.`role_id` LEFT JOIN `sys_menu` m ON m.`id` = rm.`menu_id` WHERE user_id = #&#123;userid&#125; AND r.`status` = 0 AND m.`status` = 0 &lt;/select&gt;&lt;/mapper&gt; â€‹ åœ¨application.ymlä¸­é…ç½®mapperXMLæ–‡ä»¶çš„ä½ç½® 123456789101112spring: datasource: url: jdbc:mysql://localhost:3306/sg_security?characterEncoding=utf-8&amp;serverTimezone=UTC username: root password: root driver-class-name: com.mysql.cj.jdbc.Driver redis: host: localhost port: 6379mybatis-plus: mapper-locations: classpath*:/mapper/**/*.xml â€‹ ç„¶åæˆ‘ä»¬å¯ä»¥åœ¨UserDetailsServiceImplä¸­å»è°ƒç”¨è¯¥mapperçš„æ–¹æ³•æŸ¥è¯¢æƒé™ä¿¡æ¯å°è£…åˆ°LoginUserå¯¹è±¡ä¸­å³å¯ã€‚ 1234567891011121314151617181920212223242526/** * @Author ä¸‰æ›´ Bç«™ï¼š https://space.bilibili.com/663528522 */@Servicepublic class UserDetailsServiceImpl implements UserDetailsService &#123; @Autowired private UserMapper userMapper; @Autowired private MenuMapper menuMapper; @Override public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123; LambdaQueryWrapper&lt;User&gt; wrapper = new LambdaQueryWrapper&lt;&gt;(); wrapper.eq(User::getUserName,username); User user = userMapper.selectOne(wrapper); if(Objects.isNull(user))&#123; throw new RuntimeException(&quot;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯&quot;); &#125; List&lt;String&gt; permissionKeyList = menuMapper.selectPermsByUserId(user.getId());// //æµ‹è¯•å†™æ³•// List&lt;String&gt; list = new ArrayList&lt;&gt;(Arrays.asList(&quot;test&quot;)); return new LoginUser(user,permissionKeyList); &#125;&#125; 4. è‡ªå®šä¹‰å¤±è´¥å¤„ç†â€‹ æˆ‘ä»¬è¿˜å¸Œæœ›åœ¨è®¤è¯å¤±è´¥æˆ–è€…æ˜¯æˆæƒå¤±è´¥çš„æƒ…å†µä¸‹ä¹Ÿèƒ½å’Œæˆ‘ä»¬çš„æ¥å£ä¸€æ ·è¿”å›ç›¸åŒç»“æ„çš„jsonï¼Œè¿™æ ·å¯ä»¥è®©å‰ç«¯èƒ½å¯¹å“åº”è¿›è¡Œç»Ÿä¸€çš„å¤„ç†ã€‚è¦å®ç°è¿™ä¸ªåŠŸèƒ½æˆ‘ä»¬éœ€è¦çŸ¥é“SpringSecurityçš„å¼‚å¸¸å¤„ç†æœºåˆ¶ã€‚ â€‹ åœ¨SpringSecurityä¸­ï¼Œå¦‚æœæˆ‘ä»¬åœ¨è®¤è¯æˆ–è€…æˆæƒçš„è¿‡ç¨‹ä¸­å‡ºç°äº†å¼‚å¸¸ä¼šè¢«ExceptionTranslationFilteræ•è·åˆ°ã€‚åœ¨ExceptionTranslationFilterä¸­ä¼šå»åˆ¤æ–­æ˜¯è®¤è¯å¤±è´¥è¿˜æ˜¯æˆæƒå¤±è´¥å‡ºç°çš„å¼‚å¸¸ã€‚ â€‹ å¦‚æœæ˜¯è®¤è¯è¿‡ç¨‹ä¸­å‡ºç°çš„å¼‚å¸¸ä¼šè¢«å°è£…æˆAuthenticationExceptionç„¶åè°ƒç”¨AuthenticationEntryPointå¯¹è±¡çš„æ–¹æ³•å»è¿›è¡Œå¼‚å¸¸å¤„ç†ã€‚ â€‹ å¦‚æœæ˜¯æˆæƒè¿‡ç¨‹ä¸­å‡ºç°çš„å¼‚å¸¸ä¼šè¢«å°è£…æˆAccessDeniedExceptionç„¶åè°ƒç”¨AccessDeniedHandlerå¯¹è±¡çš„æ–¹æ³•å»è¿›è¡Œå¼‚å¸¸å¤„ç†ã€‚ â€‹ æ‰€ä»¥å¦‚æœæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†ï¼Œæˆ‘ä»¬åªéœ€è¦è‡ªå®šä¹‰AuthenticationEntryPointå’ŒAccessDeniedHandlerç„¶åé…ç½®ç»™SpringSecurityå³å¯ã€‚ â‘ è‡ªå®šä¹‰å®ç°ç±» 1234567891011@Componentpublic class AccessDeniedHandlerImpl implements AccessDeniedHandler &#123; @Override public void handle(HttpServletRequest request, HttpServletResponse response, AccessDeniedException accessDeniedException) throws IOException, ServletException &#123; ResponseResult result = new ResponseResult(HttpStatus.FORBIDDEN.value(), &quot;æƒé™ä¸è¶³&quot;); String json = JSON.toJSONString(result); WebUtils.renderString(response,json); &#125;&#125; 12345678910111213/** * @Author ä¸‰æ›´ Bç«™ï¼š https://space.bilibili.com/663528522 */@Componentpublic class AuthenticationEntryPointImpl implements AuthenticationEntryPoint &#123; @Override public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException) throws IOException, ServletException &#123; ResponseResult result = new ResponseResult(HttpStatus.UNAUTHORIZED.value(), &quot;è®¤è¯å¤±è´¥è¯·é‡æ–°ç™»å½•&quot;); String json = JSON.toJSONString(result); WebUtils.renderString(response,json); &#125;&#125; â‘¡é…ç½®ç»™SpringSecurity â€‹ â€‹ å…ˆæ³¨å…¥å¯¹åº”çš„å¤„ç†å™¨ 12345@Autowiredprivate AuthenticationEntryPoint authenticationEntryPoint;@Autowiredprivate AccessDeniedHandler accessDeniedHandler; â€‹ ç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨HttpSecurityå¯¹è±¡çš„æ–¹æ³•å»é…ç½®ã€‚ 12http.exceptionHandling().authenticationEntryPoint(authenticationEntryPoint). accessDeniedHandler(accessDeniedHandler); 5. è·¨åŸŸâ€‹ æµè§ˆå™¨å‡ºäºå®‰å…¨çš„è€ƒè™‘ï¼Œä½¿ç”¨ XMLHttpRequestå¯¹è±¡å‘èµ· HTTPè¯·æ±‚æ—¶å¿…é¡»éµå®ˆåŒæºç­–ç•¥ï¼Œå¦åˆ™å°±æ˜¯è·¨åŸŸçš„HTTPè¯·æ±‚ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯è¢«ç¦æ­¢çš„ã€‚ åŒæºç­–ç•¥è¦æ±‚æºç›¸åŒæ‰èƒ½æ­£å¸¸è¿›è¡Œé€šä¿¡ï¼Œå³åè®®ã€åŸŸåã€ç«¯å£å·éƒ½å®Œå…¨ä¸€è‡´ã€‚ â€‹ å‰åç«¯åˆ†ç¦»é¡¹ç›®ï¼Œå‰ç«¯é¡¹ç›®å’Œåç«¯é¡¹ç›®ä¸€èˆ¬éƒ½ä¸æ˜¯åŒæºçš„ï¼Œæ‰€ä»¥è‚¯å®šä¼šå­˜åœ¨è·¨åŸŸè¯·æ±‚çš„é—®é¢˜ã€‚ â€‹ æ‰€ä»¥æˆ‘ä»¬å°±è¦å¤„ç†ä¸€ä¸‹ï¼Œè®©å‰ç«¯èƒ½è¿›è¡Œè·¨åŸŸè¯·æ±‚ã€‚ â‘ å…ˆå¯¹SpringBooté…ç½®ï¼Œè¿è¡Œè·¨åŸŸè¯·æ±‚ 12345678910111213141516171819@Configurationpublic class CorsConfig implements WebMvcConfigurer &#123; @Override public void addCorsMappings(CorsRegistry registry) &#123; // è®¾ç½®å…è®¸è·¨åŸŸçš„è·¯å¾„ registry.addMapping(&quot;/**&quot;) // è®¾ç½®å…è®¸è·¨åŸŸè¯·æ±‚çš„åŸŸå .allowedOriginPatterns(&quot;*&quot;) // æ˜¯å¦å…è®¸cookie .allowCredentials(true) // è®¾ç½®å…è®¸çš„è¯·æ±‚æ–¹å¼ .allowedMethods(&quot;GET&quot;, &quot;POST&quot;, &quot;DELETE&quot;, &quot;PUT&quot;) // è®¾ç½®å…è®¸çš„headerå±æ€§ .allowedHeaders(&quot;*&quot;) // è·¨åŸŸå…è®¸æ—¶é—´ .maxAge(3600); &#125;&#125; â‘¡å¼€å¯SpringSecurityçš„è·¨åŸŸè®¿é—® ç”±äºæˆ‘ä»¬çš„èµ„æºéƒ½ä¼šæ”¶åˆ°SpringSecurityçš„ä¿æŠ¤ï¼Œæ‰€ä»¥æƒ³è¦è·¨åŸŸè®¿é—®è¿˜è¦è®©SpringSecurityè¿è¡Œè·¨åŸŸè®¿é—®ã€‚ 123456789101112131415161718192021222324252627@Overrideprotected void configure(HttpSecurity http) throws Exception &#123; http //å…³é—­csrf .csrf().disable() //ä¸é€šè¿‡Sessionè·å–SecurityContext .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS) .and() .authorizeRequests() // å¯¹äºç™»å½•æ¥å£ å…è®¸åŒ¿åè®¿é—® .antMatchers(&quot;/user/login&quot;).anonymous() // é™¤ä¸Šé¢å¤–çš„æ‰€æœ‰è¯·æ±‚å…¨éƒ¨éœ€è¦é‰´æƒè®¤è¯ .anyRequest().authenticated(); //æ·»åŠ è¿‡æ»¤å™¨ http.addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class); //é…ç½®å¼‚å¸¸å¤„ç†å™¨ http.exceptionHandling() //é…ç½®è®¤è¯å¤±è´¥å¤„ç†å™¨ .authenticationEntryPoint(authenticationEntryPoint) .accessDeniedHandler(accessDeniedHandler); //å…è®¸è·¨åŸŸ http.cors();&#125; 6. é—ç•™å°é—®é¢˜å…¶å®ƒæƒé™æ ¡éªŒæ–¹æ³•â€‹ æˆ‘ä»¬å‰é¢éƒ½æ˜¯ä½¿ç”¨@PreAuthorizeæ³¨è§£ï¼Œç„¶ååœ¨åœ¨å…¶ä¸­ä½¿ç”¨çš„æ˜¯hasAuthorityæ–¹æ³•è¿›è¡Œæ ¡éªŒã€‚SpringSecurityè¿˜ä¸ºæˆ‘ä»¬æä¾›äº†å…¶å®ƒæ–¹æ³•ä¾‹å¦‚ï¼šhasAnyAuthorityï¼ŒhasRoleï¼ŒhasAnyRoleç­‰ã€‚ â€‹ â€‹ è¿™é‡Œæˆ‘ä»¬å…ˆä¸æ€¥ç€å»ä»‹ç»è¿™äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆå»ç†è§£hasAuthorityçš„åŸç†ï¼Œç„¶åå†å»å­¦ä¹ å…¶ä»–æ–¹æ³•ä½ å°±æ›´å®¹æ˜“ç†è§£ï¼Œè€Œä¸æ˜¯æ­»è®°ç¡¬èƒŒåŒºåˆ«ã€‚å¹¶ä¸”æˆ‘ä»¬ä¹Ÿå¯ä»¥é€‰æ‹©å®šä¹‰æ ¡éªŒæ–¹æ³•ï¼Œå®ç°æˆ‘ä»¬è‡ªå·±çš„æ ¡éªŒé€»è¾‘ã€‚ â€‹ hasAuthorityæ–¹æ³•å®é™…æ˜¯æ‰§è¡Œåˆ°äº†SecurityExpressionRootçš„hasAuthorityï¼Œå¤§å®¶åªè¦æ–­ç‚¹è°ƒè¯•æ—¢å¯çŸ¥é“å®ƒå†…éƒ¨çš„æ ¡éªŒåŸç†ã€‚ â€‹ å®ƒå†…éƒ¨å…¶å®æ˜¯è°ƒç”¨authenticationçš„getAuthoritiesæ–¹æ³•è·å–ç”¨æˆ·çš„æƒé™åˆ—è¡¨ã€‚ç„¶ååˆ¤æ–­æˆ‘ä»¬å­˜å…¥çš„æ–¹æ³•å‚æ•°æ•°æ®åœ¨æƒé™åˆ—è¡¨ä¸­ã€‚ â€‹ hasAnyAuthorityæ–¹æ³•å¯ä»¥ä¼ å…¥å¤šä¸ªæƒé™ï¼Œåªæœ‰ç”¨æˆ·æœ‰å…¶ä¸­ä»»æ„ä¸€ä¸ªæƒé™éƒ½å¯ä»¥è®¿é—®å¯¹åº”èµ„æºã€‚ 1234@PreAuthorize(&quot;hasAnyAuthority(&#x27;admin&#x27;,&#x27;test&#x27;,&#x27;system:dept:list&#x27;)&quot;)public String hello()&#123; return &quot;hello&quot;;&#125; â€‹ hasRoleè¦æ±‚æœ‰å¯¹åº”çš„è§’è‰²æ‰å¯ä»¥è®¿é—®ï¼Œä½†æ˜¯å®ƒå†…éƒ¨ä¼šæŠŠæˆ‘ä»¬ä¼ å…¥çš„å‚æ•°æ‹¼æ¥ä¸Š ROLE_ åå†å»æ¯”è¾ƒã€‚æ‰€ä»¥è¿™ç§æƒ…å†µä¸‹è¦ç”¨ç”¨æˆ·å¯¹åº”çš„æƒé™ä¹Ÿè¦æœ‰ ROLE_ è¿™ä¸ªå‰ç¼€æ‰å¯ä»¥ã€‚ 1234@PreAuthorize(&quot;hasRole(&#x27;system:dept:list&#x27;)&quot;)public String hello()&#123; return &quot;hello&quot;;&#125; â€‹ hasAnyRole æœ‰ä»»æ„çš„è§’è‰²å°±å¯ä»¥è®¿é—®ã€‚å®ƒå†…éƒ¨ä¹Ÿä¼šæŠŠæˆ‘ä»¬ä¼ å…¥çš„å‚æ•°æ‹¼æ¥ä¸Š ROLE_ åå†å»æ¯”è¾ƒã€‚æ‰€ä»¥è¿™ç§æƒ…å†µä¸‹è¦ç”¨ç”¨æˆ·å¯¹åº”çš„æƒé™ä¹Ÿè¦æœ‰ ROLE_ è¿™ä¸ªå‰ç¼€æ‰å¯ä»¥ã€‚ 1234@PreAuthorize(&quot;hasAnyRole(&#x27;admin&#x27;,&#x27;system:dept:list&#x27;)&quot;)public String hello()&#123; return &quot;hello&quot;;&#125; è‡ªå®šä¹‰æƒé™æ ¡éªŒæ–¹æ³•â€‹ æˆ‘ä»¬ä¹Ÿå¯ä»¥å®šä¹‰è‡ªå·±çš„æƒé™æ ¡éªŒæ–¹æ³•ï¼Œåœ¨@PreAuthorizeæ³¨è§£ä¸­ä½¿ç”¨æˆ‘ä»¬çš„æ–¹æ³•ã€‚ 123456789101112@Component(&quot;ex&quot;)public class SGExpressionRoot &#123; public boolean hasAuthority(String authority)&#123; //è·å–å½“å‰ç”¨æˆ·çš„æƒé™ Authentication authentication = SecurityContextHolder.getContext().getAuthentication(); LoginUser loginUser = (LoginUser) authentication.getPrincipal(); List&lt;String&gt; permissions = loginUser.getPermissions(); //åˆ¤æ–­ç”¨æˆ·æƒé™é›†åˆä¸­æ˜¯å¦å­˜åœ¨authority return permissions.contains(authority); &#125;&#125; â€‹ åœ¨SPELè¡¨è¾¾å¼ä¸­ä½¿ç”¨ @exç›¸å½“äºè·å–å®¹å™¨ä¸­beançš„åå­—æœªexçš„å¯¹è±¡ã€‚ç„¶åå†è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„hasAuthorityæ–¹æ³• 12345@RequestMapping(&quot;/hello&quot;)@PreAuthorize(&quot;@ex.hasAuthority(&#x27;system:dept:list&#x27;)&quot;)public String hello()&#123; return &quot;hello&quot;;&#125; åŸºäºé…ç½®çš„æƒé™æ§åˆ¶â€‹ æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨é…ç½®ç±»ä¸­ä½¿ç”¨ä½¿ç”¨é…ç½®çš„æ–¹å¼å¯¹èµ„æºè¿›è¡Œæƒé™æ§åˆ¶ã€‚ 123456789101112131415161718192021222324252627@Overrideprotected void configure(HttpSecurity http) throws Exception &#123; http //å…³é—­csrf .csrf().disable() //ä¸é€šè¿‡Sessionè·å–SecurityContext .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS) .and() .authorizeRequests() // å¯¹äºç™»å½•æ¥å£ å…è®¸åŒ¿åè®¿é—® .antMatchers(&quot;/user/login&quot;).anonymous() .antMatchers(&quot;/testCors&quot;).hasAuthority(&quot;system:dept:list222&quot;) // é™¤ä¸Šé¢å¤–çš„æ‰€æœ‰è¯·æ±‚å…¨éƒ¨éœ€è¦é‰´æƒè®¤è¯ .anyRequest().authenticated(); //æ·»åŠ è¿‡æ»¤å™¨ http.addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class); //é…ç½®å¼‚å¸¸å¤„ç†å™¨ http.exceptionHandling() //é…ç½®è®¤è¯å¤±è´¥å¤„ç†å™¨ .authenticationEntryPoint(authenticationEntryPoint) .accessDeniedHandler(accessDeniedHandler); //å…è®¸è·¨åŸŸ http.cors();&#125; CSRFâ€‹ CSRFæ˜¯æŒ‡è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆCross-site request forgeryï¼‰ï¼Œæ˜¯webå¸¸è§çš„æ”»å‡»ä¹‹ä¸€ã€‚ â€‹ https://blog.csdn.net/freeking101/article/details/86537087 â€‹ SpringSecurityå»é˜²æ­¢CSRFæ”»å‡»çš„æ–¹å¼å°±æ˜¯é€šè¿‡csrf_tokenã€‚åç«¯ä¼šç”Ÿæˆä¸€ä¸ªcsrf_tokenï¼Œå‰ç«¯å‘èµ·è¯·æ±‚çš„æ—¶å€™éœ€è¦æºå¸¦è¿™ä¸ªcsrf_token,åç«¯ä¼šæœ‰è¿‡æ»¤å™¨è¿›è¡Œæ ¡éªŒï¼Œå¦‚æœæ²¡æœ‰æºå¸¦æˆ–è€…æ˜¯ä¼ªé€ çš„å°±ä¸å…è®¸è®¿é—®ã€‚ â€‹ æˆ‘ä»¬å¯ä»¥å‘ç°CSRFæ”»å‡»ä¾é çš„æ˜¯cookieä¸­æ‰€æºå¸¦çš„è®¤è¯ä¿¡æ¯ã€‚ä½†æ˜¯åœ¨å‰åç«¯åˆ†ç¦»çš„é¡¹ç›®ä¸­æˆ‘ä»¬çš„è®¤è¯ä¿¡æ¯å…¶å®æ˜¯tokenï¼Œè€Œtokenå¹¶ä¸æ˜¯å­˜å‚¨ä¸­cookieä¸­ï¼Œå¹¶ä¸”éœ€è¦å‰ç«¯ä»£ç å»æŠŠtokenè®¾ç½®åˆ°è¯·æ±‚å¤´ä¸­æ‰å¯ä»¥ï¼Œæ‰€ä»¥CSRFæ”»å‡»ä¹Ÿå°±ä¸ç”¨æ‹…å¿ƒäº†ã€‚ è®¤è¯æˆåŠŸå¤„ç†å™¨â€‹ å®é™…ä¸Šåœ¨UsernamePasswordAuthenticationFilterè¿›è¡Œç™»å½•è®¤è¯çš„æ—¶å€™ï¼Œå¦‚æœç™»å½•æˆåŠŸäº†æ˜¯ä¼šè°ƒç”¨AuthenticationSuccessHandlerçš„æ–¹æ³•è¿›è¡Œè®¤è¯æˆåŠŸåçš„å¤„ç†çš„ã€‚AuthenticationSuccessHandlerå°±æ˜¯ç™»å½•æˆåŠŸå¤„ç†å™¨ã€‚ â€‹ æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±å»è‡ªå®šä¹‰æˆåŠŸå¤„ç†å™¨è¿›è¡ŒæˆåŠŸåçš„ç›¸åº”å¤„ç†ã€‚ 123456789@Componentpublic class SGSuccessHandler implements AuthenticationSuccessHandler &#123; @Override public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException &#123; System.out.println(&quot;è®¤è¯æˆåŠŸäº†&quot;); &#125;&#125; 1234567891011121314@Configurationpublic class SecurityConfig extends WebSecurityConfigurerAdapter &#123; @Autowired private AuthenticationSuccessHandler successHandler; @Override protected void configure(HttpSecurity http) throws Exception &#123; http.formLogin().successHandler(successHandler); http.authorizeRequests().anyRequest().authenticated(); &#125;&#125; è®¤è¯å¤±è´¥å¤„ç†å™¨â€‹ å®é™…ä¸Šåœ¨UsernamePasswordAuthenticationFilterè¿›è¡Œç™»å½•è®¤è¯çš„æ—¶å€™ï¼Œå¦‚æœè®¤è¯å¤±è´¥äº†æ˜¯ä¼šè°ƒç”¨AuthenticationFailureHandlerçš„æ–¹æ³•è¿›è¡Œè®¤è¯å¤±è´¥åçš„å¤„ç†çš„ã€‚AuthenticationFailureHandlerå°±æ˜¯ç™»å½•å¤±è´¥å¤„ç†å™¨ã€‚ â€‹ æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±å»è‡ªå®šä¹‰å¤±è´¥å¤„ç†å™¨è¿›è¡Œå¤±è´¥åçš„ç›¸åº”å¤„ç†ã€‚ 1234567@Componentpublic class SGFailureHandler implements AuthenticationFailureHandler &#123; @Override public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception) throws IOException, ServletException &#123; System.out.println(&quot;è®¤è¯å¤±è´¥äº†&quot;); &#125;&#125; 123456789101112131415161718192021@Configurationpublic class SecurityConfig extends WebSecurityConfigurerAdapter &#123; @Autowired private AuthenticationSuccessHandler successHandler; @Autowired private AuthenticationFailureHandler failureHandler; @Override protected void configure(HttpSecurity http) throws Exception &#123; http.formLogin()// é…ç½®è®¤è¯æˆåŠŸå¤„ç†å™¨ .successHandler(successHandler)// é…ç½®è®¤è¯å¤±è´¥å¤„ç†å™¨ .failureHandler(failureHandler); http.authorizeRequests().anyRequest().authenticated(); &#125;&#125; ç™»å‡ºæˆåŠŸå¤„ç†å™¨12345678@Componentpublic class SGLogoutSuccessHandler implements LogoutSuccessHandler &#123; @Override public void onLogoutSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException &#123; System.out.println(&quot;æ³¨é”€æˆåŠŸ&quot;); &#125;&#125; 123456789101112131415161718192021222324252627@Configurationpublic class SecurityConfig extends WebSecurityConfigurerAdapter &#123; @Autowired private AuthenticationSuccessHandler successHandler; @Autowired private AuthenticationFailureHandler failureHandler; @Autowired private LogoutSuccessHandler logoutSuccessHandler; @Override protected void configure(HttpSecurity http) throws Exception &#123; http.formLogin()// é…ç½®è®¤è¯æˆåŠŸå¤„ç†å™¨ .successHandler(successHandler)// é…ç½®è®¤è¯å¤±è´¥å¤„ç†å™¨ .failureHandler(failureHandler); http.logout() //é…ç½®æ³¨é”€æˆåŠŸå¤„ç†å™¨ .logoutSuccessHandler(logoutSuccessHandler); http.authorizeRequests().anyRequest().authenticated(); &#125;&#125; å…¶ä»–è®¤è¯æ–¹æ¡ˆç•…æƒ³7. æºç è®²è§£â€‹ æŠ•ç¥¨è¿‡50æ›´æ–°æºç è®²è§£","categories":[],"tags":[]},{"title":"","slug":"RabbitMQ","date":"2025-05-21T03:23:59.308Z","updated":"2023-07-19T02:40:45.146Z","comments":true,"path":"2025/05/21/RabbitMQ/","link":"","permalink":"https://dddwah11.github.io/2025/05/21/RabbitMQ/","excerpt":"","text":"1.ä¸ºä»€ä¹ˆè¦ä½¿ç”¨RabbtiMQ1.1ç®€ä»‹ ä»€ä¹ˆæ˜¯åŒæ­¥é€šå¸¸è€Œè¨€ï¼Œåœ¨å…¬å¸å¯èƒ½å­˜åœ¨å¤šä¸ªä¸šåŠ¡ç³»ç»Ÿï¼Œè¿™äº›ä¸šåŠ¡ç³»ç»Ÿä¹‹é—´çš„é€šä¿¡éƒ½æ˜¯è¿›è¡Œæ¥å£è°ƒç”¨çš„ ç°åœ¨å‡è®¾ç³»ç»ŸAæ”¶åˆ°ä¸€ä¸ªè¯·æ±‚ï¼Œå¯èƒ½æ˜¯ç”¨æˆ·é€šè¿‡æµè§ˆå™¨æˆ–è€…APPå‘èµ·çš„ï¼Œè¿™ä¸ªæ—¶å€™ç³»ç»ŸAæ”¶åˆ°è¯·æ±‚ä¹‹åå°±ä¼šç«‹é©¬å»è°ƒç”¨ç³»ç»ŸBï¼Œç„¶åç³»ç»ŸBè¿”å›ç»“æœç»™ç³»ç»ŸAä¹‹åï¼Œç³»ç»ŸAæ‰èƒ½è¿”å›ç»“æœç»™ç”¨æˆ·é‚£ä¹ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”¨æˆ·å‘èµ·ä¸€ä¸ªè¯·æ±‚ï¼Œç³»ç»ŸAæ”¶åˆ°è¯·æ±‚ï¼Œæ¥ç€ç³»ç»ŸAå¿…é¡»é©¬ä¸Šå»è°ƒç”¨ç³»ç»ŸBï¼ŒçŸ¥é“ç³»ç»ŸBè¿”å›äº†ï¼Œç³»ç»ŸAæ‰èƒ½ç»™ç”¨æˆ·è¿”å›ç»“æœï¼Œè¿™ç§æ¨¡å¼å°±æ˜¯â€œåŒæ­¥è°ƒç”¨â€ ä¾é æ¶ˆæ¯ä¸­é—´ä»¶å®ç°å¼‚æ­¥è°ƒç”¨ åŠ å…¥äº†æ¶ˆæ¯ä¸­é—´ä»¶ä¹‹åï¼Œç³»ç»ŸAä¼šå‘é€æ¶ˆæ¯ç»™MQæ¥ç€ç³»ç»ŸAå°±è®¤ä¸ºè‡ªå·±çš„å·¥ä½œåšå®Œäº†ï¼Œç„¶åç›´æ¥è¿”å›ç»“æœç»™ç”¨æˆ·äº†ã€‚è¿™ä¸ªæ—¶å€™ç³»ç»ŸAä¸ç³»ç»ŸBå°±æ²¡ä»€ä¹ˆå…³ç³»äº†ï¼Œå› ä¸ºç³»ç»ŸAè¦åšçš„äº‹æƒ…åªæ˜¯æ¥æ”¶è¯·æ±‚ï¼Œå‘é€æ¶ˆæ¯åˆ°MQï¼Œç„¶åå°±è¿”å›ç»“æœç»™ç”¨æˆ·ï¼Œç³»ç»ŸBçš„äº‹æƒ…ä»–å°±ä¸ç®¡äº†ã€‚ç„¶åç³»ç»ŸBæ ¹æ®è‡ªå·±çš„æƒ…å†µï¼Œå¯èƒ½ä¼šåœ¨ç³»ç»ŸAæŠ•é€’æ¶ˆæ¯åˆ°MQä¹‹å1ç§’å†…ï¼Œä¹Ÿå¯èƒ½æ˜¯1åˆ†é’Ÿï¼Œä¹Ÿå¯èƒ½æ˜¯1å°æ—¶ä¹‹åï¼Œå¤šé•¿æ—¶é—´éƒ½æœ‰å¯èƒ½ï¼Œä½†æ˜¯ä¸ç®¡å¤šé•¿æ—¶é—´åï¼Œç³»ç»ŸBè‚¯å®šä¼šä»MQé‚£è·å–åˆ°ä¸€æ¡å±äºè‡ªå·±çš„æ¶ˆæ¯ã€‚ç„¶åè·å–åˆ°æ¶ˆæ¯ä¹‹åï¼Œæ ¹æ®æ¶ˆæ¯çš„æŒ‡ç¤ºå®Œæˆè‡ªå·±çš„å·¥ä½œã€‚æ‰€ä»¥æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå…¶å®å°±æ˜¯ä¸€ç§ç³»ç»Ÿï¼Œä»–æ˜¯ç‹¬ç«‹éƒ¨ç½²çš„ï¼Œç„¶åè®©æˆ‘ä»¬çš„ä¸¤ä¸ªç³»ç»Ÿä¹‹é—´é€šè¿‡å‘é€æ¶ˆæ¯å’Œæ¥æ”¶æ¶ˆæ¯æ¥è¿›è¡Œå¼‚æ­¥çš„è°ƒç”¨æ¶ˆæ¯ä¸­é—´ä»¶çš„å¥½å¤„ï¼šå¼‚æ­¥æå‡æ€§èƒ½ï¼Œé™ä½ç³»ç»Ÿä¹‹é—´çš„è€¦åˆï¼Œæµé‡å‰Šå³° 1.2å¼‚æ­¥åŒ–æå‡æ€§èƒ½æ¡ˆä¾‹å‡è®¾Aç³»ç»Ÿè¦è°ƒç”¨ç³»ç»ŸBåšä¸€ä»¶äº‹ï¼Œç„¶åAå…ˆæ‰§è¡Œä¸€äº›æ“ä½œï¼Œéœ€è¦æ¶ˆè€—20ms,æ¥ç€ç³»ç»Ÿbæ‰§è¡Œä¸€äº›æ“ä½œéœ€è¦æ‰§è¡Œ200msè¿™ä¸ªæ—¶å€™ç³»ç»ŸAå’Œç³»ç»ŸBéƒ½å¹²å®Œæ´»æ‰èƒ½ç»™ç”¨æˆ·è¿”å›ç»“æœï¼Œç”¨æˆ·éœ€è¦ç­‰å¾…çš„æ—¶é—´æ˜¯220mså¦‚æœåœ¨Aå’ŒBç³»ç»Ÿé—´åŠ å…¥MQï¼Œç³»ç»ŸAå¹²å®Œè‡ªå·±çš„äº‹æƒ…ï¼Œå°±20msï¼Œç„¶åå‘é€ä¸€ä¸ªæ¶ˆæ¯åˆ°MQï¼Œå°±5msï¼Œç„¶åç›´æ¥è¿”å›ç»“æœç»™ç”¨æˆ·ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·åªéœ€è¦ç­‰å¾…25msã€‚ç„¶åç³»ç»ŸBä»MQé‡Œè·å–åˆ°æ¶ˆæ¯ï¼Œæ¥ç€èŠ±è´¹200mså»æ‰§è¡Œï¼Œä½†æ˜¯è¿™ä¸ª200mså°±ä¸ç”¨æˆ·æ²¡æœ‰å…³ç³»äº†ã€‚ 1.3æµé‡å‰Šå³°æ¡ˆä¾‹ï¼šå‡è®¾ç³»ç»ŸAæ˜¯ä¸æ“ä½œæ•°æ®åº“çš„ï¼Œå› æ­¤åªè¦å¤šéƒ¨ç½²å‡ å°æœºå™¨ï¼Œå°±å¯ä»¥æŠ—ä¸‹æ¯ç§’1ä¸‡çš„è¯·æ±‚ï¼Œä¾‹å¦‚éƒ¨ç½²ä¸ª20å°æœºå™¨ï¼Œå°±å¯ä»¥è½»æ¾æŠ—ä¸‹æ¯ç§’ä¸Šä¸‡çš„è¯·æ±‚ã€‚ç„¶åBç³»ç»Ÿæ˜¯è¦æ“ä½œä¸€å°æ•°æ®åº“æœåŠ¡å™¨çš„ï¼Œé‚£å°æ•°æ®åº“çš„ä¸Šé™æ˜¯æ¯ç§’æ¥æ”¶6000ä¸ªè¯·æ±‚ï¼Œé‚£ä¹ˆæ— è®ºç³»ç»ŸBéƒ¨ç½²å¤šå°‘å°æœºå™¨éƒ½æ²¡ç”¨ï¼Œå› ä¸ºä»–ä¾èµ–çš„æ•°æ®åº“æœ€å¤šåªèƒ½æ¥æ”¶æ¯ç§’6000ä¸ªè¯·æ±‚ã€‚ç°åœ¨å‡è®¾å¤§é‡ç”¨æˆ·åŒæ—¶å‘èµ·è®¿é—®ï¼Œç³»ç»ŸAå°±æ˜¯æ”¶åˆ°äº†1ä¸‡QPSæ€ä¹ˆåŠï¼Ÿè¿™æ—¶å€™ï¼Œç³»ç»ŸAä¼šç¬é—´æŠŠ1ä¸‡QPSè½¬å‘ç»™ç³»ç»ŸB,å‡è®¾Bç³»ç»Ÿä¹Ÿéƒ¨ç½²20å°æœºå™¨ï¼Œç³»ç»ŸBè‡ªå·±å¯ä»¥æŠ—ä½1ä¸‡QPSï¼Œä½†æ˜¯æ•°æ®åº“å‘¢ï¼Ÿæ•°æ®åº“æ˜¯æŠ—ä¸ä¸‹1ä¸‡çš„QPSçš„ï¼Œæ­¤æ—¶å¦‚æœç³»ç»ŸBå¯¹æ•°æ®åº“å‘èµ·äº†1Wçš„QPSçš„è¯·æ±‚ï¼Œä¸€å®šä¼šç¬é—´å‹å®æ•°æ®åº“çš„ã€‚æ‰€ä»¥è¿™ä¸ªæ—¶å€™å¼•å…¥MQï¼Œå°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜äº†ã€‚MQè¿™ä¸ªæŠ€æœ¯æŠ—é«˜å¹¶å‘çš„èƒ½åŠ›è¿œè¿œé«˜äºæ•°æ®åº“ï¼ŒåŒæ ·é…ç½®çš„æœºå™¨ï¼Œå¦‚æœæ•°æ®åº“å¯ä»¥æ¯ç§’æŠ—ä½6000è¯·æ±‚ï¼ŒMQè‡³å°‘æ¯ç§’å¯ä»¥æŠ—ä½å‡ ä¸‡çš„è¯·æ±‚ã€‚åŸå› å°±æ˜¯å› ä¸ºæ•°æ®åº“å¤æ‚ï¼Œä»–éœ€è¦èƒ½æ‰§è¡Œå¤æ‚çš„SQLçš„æŸ¥è¯¢ï¼Œæ”¯æŒäº‹åŠ¡çš„æœºåˆ¶ï¼Œæ”¯æŒä½ å¯¹æ•°æ®åº“çš„CRUDï¼Œè¿™äº›æ“ä½œå®Œæˆèµ·æ¥éƒ½æ˜¯æ¯”è¾ƒå¤æ‚çš„ã€‚æ‰€ä»¥ä¸€èˆ¬æ•°æ®åº“å•æœåŠ¡å™¨ä¹Ÿå°±èƒ½æ”¯æ’‘æ¯ç§’å‡ åƒçš„è¯·æ±‚ã€‚ä½†æ˜¯MQä¸ä¸€æ ·ï¼ŒMQè®¾è®¡çš„æ ¸å¿ƒåŠŸèƒ½å°±æ˜¯è®©ä½ ç»™ä»–å‘æ¶ˆæ¯ï¼Œå†è®©åˆ«äººä»ä»–è¿™é‡Œè·å–æ¶ˆæ¯ï¼Œç›¸æ¯”æ•°æ®åº“è€Œè¨€è¿™ç§è®¾è®¡ç®€å•å¤ªå¤šï¼Œæ‰€ä»¥åŒç­‰é…ç½®çš„æœºå™¨ï¼ŒMQä¸€èˆ¬èƒ½æŠ—ä½å‡ ä¸‡çš„å¹¶å‘è¯·æ±‚ã€‚ æ‰€ä»¥åªè¦å¼•å…¥MQï¼Œé‚£ä¹ˆå°±å¯ä»¥è®©ç³»ç»ŸAæŠŠæ¯ç§’1ä¸‡çš„è¯·æ±‚éƒ½ä½œä¸ºæ¶ˆæ¯å‘é€åˆ°MQé‡Œï¼ŒMQå¯ä»¥è½»æ¾çš„æŠ—ä¸‹æ¥ç€æ¯ç§’1ä¸‡çš„è¯·æ±‚ï¼Œæ¥ç€ç³»ç»ŸBåªè¦æ…¢æ…¢çš„ä»MQé‡Œè·å–æ¶ˆæ¯ï¼Œç„¶åæ‰§è¡Œæ•°æ®åº“è¯»å†™æ“ä½œå³å¯ï¼Œè¿™ä¸ªè·å–æ¶ˆæ¯çš„é€Ÿåº¦æ˜¯ç³»ç»ŸBè‡ªå·±å¯ä»¥æ§åˆ¶çš„ï¼Œæ‰€ä»¥ç³»ç»ŸBå®Œå…¨å¯ä»¥ç”¨ä¸€ä¸ªæ¯”è¾ƒä½çš„é€Ÿç‡è·å–æ¶ˆæ¯åå†™å…¥æ•°æ®åº“ï¼Œä¿è¯å¯¹æ•°æ®åº“çš„QPSä¸è¦è¶…è¿‡ä»–çš„æé™å€¼6000.è¿™ä¸ªæ—¶å€™å› ä¸ºç³»ç»ŸAå‘é€æ¶ˆæ¯åˆ°MQå¾ˆå¿«ï¼Œç³»ç»ŸBä»MQæ¶ˆè´¹æ¶ˆæ¯å¾ˆæ…¢ï¼Œæ‰€ä»¥MQé‡Œè‡ªç„¶ä¼šç§¯å‹ä¸€äº›æ¶ˆæ¯ï¼Œä¸è¿‡MQçš„æ¶ˆæ¯ä¸€èˆ¬éƒ½æ˜¯åŸºäºç£ç›˜æ¥å­˜å‚¨çš„ï¼Œæ‰€ä»¥é€‚å½“çš„ç§¯å‹ä¸€äº›æ¶ˆæ¯æ˜¯å¯ä»¥çš„ã€‚å½“ç³»ç»ŸAçš„é«˜å³°è¿‡å»ï¼Œæ¯ç§’å°±å¯èƒ½æ¢å¤åˆ°1000çš„QPSäº†ï¼Œæ­¤æ—¶ç³»ç»ŸBè¿˜æ˜¯ä»¥æ¯ç§’6000QPSçš„é€Ÿåº¦è¯»å–æ¶ˆæ¯å†™å…¥æ•°æ®åº“ï¼Œé‚£ä¹ˆè‡ªç„¶MQé‡Œç§¯å‹çš„æ¶ˆæ¯å°±æ…¢æ…¢è¢«æ¶ˆåŒ–æ‰äº†ã€‚æ‰€ä»¥è¿™å°±æ˜¯MQè¿›è¡Œæµé‡å‰Šå³°çš„æ•ˆæœï¼Œç³»ç»ŸAå‘é€è¿‡æ¥æ¯ç§’1ä¸‡è¯·æ±‚æ˜¯ä¸€ä¸ªæµé‡æ´ªå³°ï¼Œç„¶åMQç›´æ¥æŠ—äº†ä¸‹æ¥ï¼Œéƒ½å­˜å‚¨åˆ°è‡ªå·±æœ¬åœ°ç£ç›˜ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯æµé‡å‰Šå³°çš„è¿‡ç¨‹ï¼Œç¬é—´æŠŠä¸€ä¸ªæ´ªå³°å‰Šä¸‹æ¥äº†ï¼Œè®©ç³»ç»ŸBåç»­æ…¢æ…¢è·å–æ¶ˆæ¯æ¥å¤„ç†ã€‚ 1.4é™ä½ç³»ç»Ÿè€¦åˆæ¡ˆä¾‹ï¼šå¦‚æœæ²¡æœ‰ä½¿ç”¨MQï¼Œç³»ç»ŸAç›´æ¥è°ƒç”¨ç³»ç»ŸBï¼Œé‚£ä¹ˆABç³»ç»Ÿä¹‹é—´å°±å±äºè€¦åˆåœ¨ä¸€èµ·çš„ã€‚äº’ç›¸ä¹‹é—´ä¼šæœ‰å½±å“ï¼Œä¾‹å¦‚Bç³»ç»Ÿå¿½ç„¶å‡ºç°äº†æ•…éšœï¼Œé‚£ä¹ˆAç³»ç»Ÿä¼šæ„ŸçŸ¥åˆ°Bç³»ç»Ÿçš„æ•…éšœï¼Œå› ä¸ºç³»ç»ŸAè°ƒç³»ç»ŸBè‚¯å®šæ˜¯ä¼šè¿”å›å¼‚å¸¸çš„ã€‚æ­¤æ—¶ç³»ç»ŸAå°±ä¼šæŠŠå¼‚å¸¸è¿”å›ç»™ç”¨æˆ·ï¼Œè€Œä¸”Aä¹Ÿéœ€è¦å»å¤„ç†è¿™ä¸ªå¼‚å¸¸ã€‚è¿™ä¸€åˆ‡éƒ½æ˜¯å› ä¸ºABç³»ç»Ÿè€¦åˆåœ¨ä¸€èµ·ï¼Œæ‰€ä»¥ä¸€æ—¦Bç³»ç»Ÿå‡ºç°æ•…éšœï¼Œå¾ˆå¯èƒ½å½±å“Aç³»ç»Ÿä¹Ÿå‡ºç°æ•…éšœã€‚è€ŒAç³»ç»Ÿè¿˜å¾—å»å…³å¿ƒBç³»ç»Ÿå‡ºç°çš„æ•…éšœï¼Œå»å¤„ç†å¯¹åº”çš„å¼‚å¸¸ã€‚å‡å¦‚å¼•å…¥äº†MQï¼Œé‚£ä¹ˆAç³»ç»Ÿå¯¹Bç³»ç»Ÿçš„è°ƒç”¨ä»…ä»…æ˜¯ç»™MQå‘é€ä¸ªæ¶ˆæ¯å°±ä¸ç®¡äº†ï¼Œç„¶åç›´æ¥æŠŠç»“æœè¿”å›ç»™ç”¨æˆ·ï¼Œå¯¹Bç³»ç»Ÿå°±ä¸éœ€è¦ç®¡äº†ã€‚æ­¤æ—¶å¦‚æœBç³»ç»Ÿå‡ºç°äº†æ•…éšœï¼Œå¯¹Aç³»ç»Ÿæ ¹æœ¬æ²¡æœ‰å½±å“ï¼Œç³»ç»ŸAä¹Ÿæ„Ÿè§‰ä¸åˆ°ã€‚ 2.å®‰è£…1.é€šè¿‡dockerå®‰è£…1docker pull rabbitmq:3-management 2.å¯åŠ¨1.æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œå¯åŠ¨ 123456789docker run \\ -e RABBITMQ_DEFAULT_USER=root \\ -e RABBITMQ_DEFAULT_PASS=root \\ --name mq \\ --hostname mq1 \\ -p 15672:15672 \\ -p 5672:5672 \\ -d \\ rabbitmq:3-management 2.è®¿é—®åœ°å€:http:&#x2F;&#x2F;ä½ çš„ipåœ°å€:15672&#x2F;æ•ˆæœå¦‚ä¸‹è¾“å…¥åˆšåˆšè®¾ç½®çš„ç”¨æˆ·åroot å¯†ç rootè¿›è¡Œç™»å½• 3.AMQPå·¥ä½œæ¨¡å‹åŸºæœ¬æ¦‚å¿µAMQPåè®®ä¸­çš„åŸºæœ¬æ¦‚å¿µâ€¢ Broker: broker æŒ‡çš„æ˜¯æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨ï¼Œæ˜¯è´Ÿè´£æ¥æ”¶æ¥è‡ªç”Ÿäº§è€…çš„æ¶ˆæ¯å¹¶å°†å…¶æ·»åŠ åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç„¶åç­‰å¾…æ¥è‡ªæ¶ˆè´¹è€…çš„è¯·æ±‚å¹¶å°†å·²æ’é˜Ÿçš„æ¶ˆæ¯å‘é€ç»™æ¶ˆè´¹è€…çš„æœåŠ¡å™¨ã€‚ç®€è€Œè¨€ä¹‹ï¼ŒBroker æ˜¯å¤„ç†æ¶ˆæ¯çš„æœåŠ¡å™¨ã€‚â€¢ Virtual host: å‡ºäºå¤šç§Ÿæˆ·å’Œå®‰å…¨å› ç´ è®¾è®¡çš„ï¼Œç±»ä¼¼äºnamespaceæ¦‚å¿µã€‚å½“å¤šä¸ªä¸åŒçš„ç”¨æˆ·ä½¿ç”¨åŒä¸€ä¸ªRabbitMQ serveræä¾›çš„æœåŠ¡æ—¶ï¼Œå¯ä»¥åˆ’åˆ†å‡ºå¤šä¸ªvhostï¼Œæ¯ä¸ªç”¨æˆ·åœ¨è‡ªå·±çš„vhoståˆ›å»ºexchangeï¼queueç­‰ã€‚ï¼ˆä¹Ÿå¯ä»¥ç†è§£æˆå¤šä¸ªç”¨æˆ·å¦‚æœéƒ½ä½¿ç”¨ä¸€ä¸ªhostçš„ï¼Œé‚£ä¹ˆåˆ›å»ºå‡ºæ¥çš„exchangeä¸queueè¿›è¡Œæ•°æ®å­˜å‚¨æ—¶ï¼Œæ•°æ®å¯èƒ½ä¼šäº’ç›¸å¹²æ‰°ï¼‰â€¢ Connection: publisherï¼consumerå’Œbrokerä¹‹é—´çš„TCPè¿æ¥ã€‚æ–­å¼€è¿æ¥çš„æ“ä½œåªä¼šåœ¨clientç«¯è¿›è¡Œï¼ŒBrokerä¸ä¼šæ–­å¼€è¿æ¥ï¼Œé™¤éå‡ºç°ç½‘ç»œæ•…éšœæˆ–brokeræœåŠ¡å‡ºç°é—®é¢˜ã€‚â€¢ Channel: é€šä¿¡ç®¡é“ï¼Œå¦‚æœæ¯ä¸€æ¬¡è®¿é—®RabbitMQéƒ½å»ºç«‹ä¸€ä¸ªConnectionï¼Œåœ¨æ¶ˆæ¯é‡å¤§çš„æ—¶å€™å»ºç«‹TCP Connectionçš„å¼€é”€å°†æ˜¯å·¨å¤§çš„ï¼Œæ•ˆç‡ä¹Ÿè¾ƒä½ã€‚Channelæ˜¯åœ¨connectionå†…éƒ¨å»ºç«‹çš„é€»è¾‘è¿æ¥ï¼Œå¦‚æœåº”ç”¨ç¨‹åºæ”¯æŒå¤šçº¿ç¨‹ï¼Œé€šå¸¸æ¯ä¸ªthreadåˆ›å»ºå•ç‹¬çš„channelè¿›è¡Œé€šè®¯ï¼ŒAMQP methodåŒ…å«äº†channel idå¸®åŠ©å®¢æˆ·ç«¯å’Œmessage brokerè¯†åˆ«channelï¼Œæ‰€ä»¥channelä¹‹é—´æ˜¯å®Œå…¨éš”ç¦»çš„ã€‚Channelä½œä¸ºè½»é‡çº§çš„Connectionæå¤§å‡å°‘äº†æ“ä½œç³»ç»Ÿå»ºç«‹TCP connectionçš„å¼€é”€ã€‚â€¢ Exchange: messageåˆ°è¾¾brokerçš„ç¬¬ä¸€ç«™ï¼Œæ ¹æ®åˆ†å‘è§„åˆ™ï¼ŒåŒ¹é…æŸ¥è¯¢è¡¨ä¸­çš„routing keyï¼Œåˆ†å‘æ¶ˆæ¯åˆ°queueä¸­å»ã€‚å¸¸ç”¨çš„ç±»å‹æœ‰ï¼šdirect (point-to-point), topic (publish-subscribe) and fanout (multicast)ã€‚â€¢ Queue: æ¶ˆæ¯æœ€ç»ˆè¢«é€åˆ°è¿™é‡Œç­‰å¾…consumerå–èµ°ã€‚ä¸€ä¸ªmessageå¯ä»¥è¢«åŒæ—¶æ‹·è´åˆ°å¤šä¸ªqueueä¸­ã€‚Binding: exchangeå’Œqueueä¹‹é—´çš„è™šæ‹Ÿè¿æ¥ï¼Œbindingä¸­å¯ä»¥åŒ…å«routing keyã€‚Bindingä¿¡æ¯è¢«ä¿å­˜åˆ°exchangeä¸­çš„æŸ¥è¯¢è¡¨ä¸­ï¼Œç”¨äºmessageçš„åˆ†å‘ä¾æ®ã€‚ 4.å¿«é€Ÿå…¥é—¨1.å®˜ç½‘https://www.rabbitmq.com/ 2.rabbitmqçš„æ¶ˆæ¯æ¨¡å‹ç½‘é¡µæ¨¡æ‹Ÿå™¨ç½‘å€:https://tryrabbitmq.com/RabbitMQå®˜æ–¹æä¾›äº†5ä¸ªä¸åŒçš„Demoç¤ºä¾‹ï¼Œå¯¹åº”äº†ä¸åŒçš„æ¶ˆæ¯æ¨¡å‹ï¼š1.åŸºæœ¬æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆBasicQueueï¼‰2.å·¥ä½œæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆWorkQueueï¼‰3.å‘å¸ƒè®¢é˜…(Publishã€Subscribe)3.1å¹¿æ’­(Fanout Exchange)3.2è·¯ç”±(Direct Exchange)3.3ä¸»é¢˜(Topic Exchange) 3.å…¥é—¨æ¡ˆä¾‹1.ç®€å•é˜Ÿåˆ—æ¨¡å¼ç®€å•é˜Ÿåˆ—æ¨¡å¼çš„æ¨¡å‹å›¾ï¼šå®˜æ–¹çš„HelloWorldæ˜¯åŸºäºæœ€åŸºç¡€çš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹æ¥å®ç°çš„ï¼ŒåªåŒ…æ‹¬ä¸‰ä¸ªè§’è‰²ï¼š publisherï¼šæ¶ˆæ¯å‘å¸ƒè€…ï¼Œå°†æ¶ˆæ¯å‘é€åˆ°é˜Ÿåˆ—queue queueï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè´Ÿè´£æ¥å—å¹¶ç¼“å­˜æ¶ˆæ¯ consumerï¼šè®¢é˜…é˜Ÿåˆ—ï¼Œå¤„ç†é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ ä»£ç å®ç°ï¼š1.åˆ›å»ºçˆ¶å·¥ç¨‹2.å¯¼å…¥ä¾èµ– 1234567891011121314151617181920212223242526272829303132333435363738394041424344&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;groupId&gt;com.baidu&lt;/groupId&gt; &lt;artifactId&gt;RabbitMQ-Parent&lt;/artifactId&gt; &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt; &lt;parent&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt; &lt;version&gt;2.3.9.RELEASE&lt;/version&gt; &lt;relativePath/&gt; &lt;/parent&gt; &lt;properties&gt; &lt;maven.compiler.source&gt;8&lt;/maven.compiler.source&gt; &lt;maven.compiler.target&gt;8&lt;/maven.compiler.target&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;/dependency&gt; &lt;!--AMQPä¾èµ–ï¼ŒåŒ…å«RabbitMQ--&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-amqp&lt;/artifactId&gt; &lt;/dependency&gt; &lt;!--å•å…ƒæµ‹è¯•--&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt; &lt;/dependency&gt; &lt;/dependencies&gt;&lt;/project&gt; 3.åˆ›å»ºç”Ÿäº§è€…æ¨¡å—4.ç¼–å†™æµ‹è¯•ç±»è¯¥æ¡ˆä¾‹å¤§æ¦‚ç†è§£æ„æ€å³å¯ 1234567891011121314151617181920212223242526272829303132public class Publisher01Test &#123; @Test public void testSendMessage() throws IOException, TimeoutException &#123; // 1.å»ºç«‹è¿æ¥ ConnectionFactory factory = new ConnectionFactory(); // 1.1.è®¾ç½®è¿æ¥å‚æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼šä¸»æœºåã€ç«¯å£å·ã€vhostã€ç”¨æˆ·åã€å¯†ç  factory.setHost(&quot;ä½ çš„ip&quot;); factory.setPort(5672); factory.setVirtualHost(&quot;/&quot;); factory.setUsername(&quot;root&quot;); factory.setPassword(&quot;root&quot;); // 1.2.å»ºç«‹è¿æ¥ Connection connection = factory.newConnection(); // 2.åˆ›å»ºé€šé“Channel Channel channel = connection.createChannel(); // 3.åˆ›å»ºé˜Ÿåˆ— String queueName = &quot;basic.queue&quot;; channel.queueDeclare(queueName, false, false, false, null); // 4.å‘é€æ¶ˆæ¯ String message = &quot;hello, yjf!&quot;; channel.basicPublish(&quot;&quot;, queueName, null, message.getBytes()); System.out.println(&quot;å‘é€æ¶ˆæ¯æˆåŠŸï¼šã€&quot; + message + &quot;ã€‘&quot;); // 5.å…³é—­é€šé“å’Œè¿æ¥ channel.close(); connection.close(); &#125;&#125; æ³¨æ„ï¼šè¯¥æ¡ˆä¾‹ä¸­ä½¿ç”¨äº†é»˜è®¤çš„exchangeè¿è¡Œè¯¥æ¡ˆä¾‹çš„æ—¶å€™ï¼Œå»ºè®®debugè¿è¡Œï¼Œä¸€è¾¹è¿è¡Œä¸€è¾¹è§‚å¯Ÿä¸‹å›¾çš„å˜åŒ–è¿è¡Œç»“æŸå¯ä»¥è§‚å¯Ÿåˆ°ï¼ˆç›®å‰å› ä¸ºç”Ÿäº§è€…å·²ç»å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œæ‰€ä»¥ç°åœ¨é˜Ÿåˆ—ä¸­æœ‰ä¸€æ¡æ¶ˆæ¯å¤„äºç­‰å¾…æ¶ˆè´¹çš„çŠ¶æ€ï¼‰åˆ©ç”¨ç½‘é¡µæ¨¡æ‹Ÿå™¨è¿›è¡Œæ¨¡æ‹Ÿå› ä¸ºæ¡ˆä¾‹ä½¿ç”¨çš„æ˜¯é»˜è®¤çš„exchange,æ‰€ä»¥åœ¨æ¨¡æ‹Ÿå™¨é€‰æ‹©exchangeç±»å‹çš„æ—¶å€™æˆ‘ä»¬åº”è¯¥é€‰æ‹©Direct Exchange ç±»å‹æ¥ä¸‹æ¥ç¼–å†™æ¶ˆè´¹è€…ä»£ç 5.åˆ›å»ºæ¶ˆè´¹è€…æ¨¡å—6.ç¼–å†™æµ‹è¯•ä»£ç  1234567891011121314151617181920212223242526272829303132333435363738394041package com.baidu;import com.rabbitmq.client.*;import java.io.IOException;import java.util.concurrent.TimeoutException;public class Consumer01Test &#123; public static void main(String[] args) throws IOException, TimeoutException &#123; // 1.å»ºç«‹è¿æ¥ ConnectionFactory factory = new ConnectionFactory(); // 1.1.è®¾ç½®è¿æ¥å‚æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼šä¸»æœºåã€ç«¯å£å·ã€vhostã€ç”¨æˆ·åã€å¯†ç  factory.setHost(&quot;182.42.138.115&quot;); factory.setPort(5672); factory.setVirtualHost(&quot;/&quot;); factory.setUsername(&quot;root&quot;); factory.setPassword(&quot;root&quot;); // 1.2.å»ºç«‹è¿æ¥ Connection connection = factory.newConnection(); // 2.åˆ›å»ºé€šé“Channel Channel channel = connection.createChannel(); // 3.åˆ›å»ºé˜Ÿåˆ— String queueName = &quot;basic.queue&quot;; channel.queueDeclare(queueName, false, false, false, null); // 4.è®¢é˜…æ¶ˆæ¯ channel.basicConsume(queueName, true, new DefaultConsumer(channel) &#123; @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123; // 5.å¤„ç†æ¶ˆæ¯ String message = new String(body); System.out.println(&quot;æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€&quot; + message + &quot;ã€‘&quot;); &#125; &#125;); System.out.println(&quot;ç­‰å¾…æ¥æ”¶æ¶ˆæ¯ã€‚ã€‚ã€‚ã€‚&quot;); &#125;&#125; æ•ˆæœ:å¹¶ä¸”æ‰§è¡Œå®Œä¹‹åï¼Œè¯¥ç¨‹åºä¼šä¸€ç›´å¤„äºç­‰å¾…ç›‘å¬çŠ¶æ€ï¼Œä¸€æ—¦ç›‘å¬åˆ°é˜Ÿåˆ—æœ‰æ¶ˆæ¯ï¼Œå°±ä¼šç»§ç»­æ¶ˆè´¹æ­¤æ—¶å¯ä»¥çœ‹åˆ°ï¼Œæ¶ˆæ¯å·²ç»è¢«æ¶ˆè´¹åˆ©ç”¨ç½‘é¡µæ¨¡æ‹Ÿå™¨è¿›è¡Œæ¨¡æ‹Ÿæ­¤æ—¶å¯ä»¥åˆ°ç”Ÿäº§è€…ä»£ç ä¸­ï¼Œç»§ç»­å‘é€æ¶ˆæ¯ï¼Œç„¶åè§‚å¯Ÿæ¶ˆè´¹è€…çš„æ‰“å° 7.ä½¿ç”¨SpringAMQPæ¥å®Œæˆä¸Šé¢çš„æ¡ˆä¾‹SpringAMQPæä¾›äº†ä¸‰ä¸ªåŠŸèƒ½ï¼š è‡ªåŠ¨å£°æ˜é˜Ÿåˆ—ã€äº¤æ¢æœºåŠå…¶ç»‘å®šå…³ç³» åŸºäºæ³¨è§£çš„ç›‘å¬å™¨æ¨¡å¼ï¼Œå¼‚æ­¥æ¥æ”¶æ¶ˆæ¯ å°è£…äº†RabbitTemplateå·¥å…·ï¼Œç”¨äºå‘é€æ¶ˆæ¯ å…·ä½“å®ç°ï¼šåœ¨çˆ¶å·¥ç¨‹å¯¼å…¥ä¾èµ–ï¼ˆæˆ‘ä»¬åœ¨æœ€åˆå·²ç»åšè¿‡ï¼‰ 12345&lt;!--AMQPä¾èµ–ï¼ŒåŒ…å«RabbitMQ--&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-amqp&lt;/artifactId&gt;&lt;/dependency&gt; å‘é€æ¶ˆæ¯1.åœ¨publisheræœåŠ¡çš„application.ymlä¸­æ·»åŠ é…ç½®ï¼š 1234567spring: rabbitmq: host: ä½ çš„ip # ä¸»æœºå port: 5672 # ç«¯å£ virtual-host: / # è™šæ‹Ÿä¸»æœº username: root # ç”¨æˆ·å password: root # å¯†ç  2.ç¼–å†™å¯åŠ¨ç±» 123456@SpringBootApplicationpublic class PublisherApplication01 &#123; public static void main(String[] args) &#123; SpringApplication.run(PublisherApplication01.class); &#125;&#125; 3.ç„¶ååœ¨publisheræœåŠ¡ä¸­ç¼–å†™æµ‹è¯•ç±»SpringAmqpTestï¼Œå¹¶åˆ©ç”¨RabbitTemplateå®ç°æ¶ˆæ¯å‘é€ï¼š 123456789101112131415161718192021222324252627package com.baidu;import org.junit.Test;import org.junit.runner.RunWith;import org.springframework.amqp.rabbit.core.RabbitTemplate;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.test.context.SpringBootTest;import org.springframework.test.context.junit4.SpringRunner;@RunWith(SpringRunner.class)@SpringBootTestpublic class SpringAmqpTest &#123; @Autowired private RabbitTemplate rabbitTemplate; @Test public void testBasicQueue() &#123; // é˜Ÿåˆ—åç§° String queueName = &quot;basic.queue&quot;; // æ¶ˆæ¯ String message = &quot;yjf, spring amqp!&quot;; // å‘é€æ¶ˆæ¯ rabbitTemplate.convertAndSend(queueName, message); &#125;&#125; æ¥æ”¶æ¶ˆæ¯1.åœ¨consumeræœåŠ¡çš„application.ymlä¸­æ·»åŠ é…ç½®ï¼š 1234567spring: rabbitmq: host: ä½ çš„ip # ä¸»æœºå port: 5672 # ç«¯å£ virtual-host: / # è™šæ‹Ÿä¸»æœº username: root # ç”¨æˆ·å password: root # å¯†ç  2.ç„¶ååœ¨consumeræœåŠ¡çš„com.baidu.mq.listeneråŒ…ä¸­æ–°å»ºä¸€ä¸ªç±»SpringRabbitListenerï¼Œä»£ç å¦‚ä¸‹ï¼š 12345678@Componentpublic class SpringRabbitListener &#123; @RabbitListener(queues = &quot;basic.queue&quot;) public void listenSimpleQueueMessage(String msg) throws InterruptedException &#123; System.out.println(&quot;spring æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€&quot; + msg + &quot;ã€‘&quot;); &#125;&#125; 3.ç¼–å†™å¯åŠ¨ç±» 12345678910111213package com.baidu;import org.springframework.boot.SpringApplication;import org.springframework.boot.autoconfigure.SpringBootApplication;@SpringBootApplicationpublic class ConsumerApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(ConsumerApplication.class); &#125;&#125; å¯åŠ¨consumeræœåŠ¡ï¼Œç„¶ååœ¨publisheræœåŠ¡ä¸­è¿è¡Œæµ‹è¯•ä»£ç ï¼Œå‘é€MQæ¶ˆæ¯ 2.å·¥ä½œæ¶ˆæ¯é˜Ÿåˆ—Work queuesï¼Œä¹Ÿè¢«ç§°ä¸ºï¼ˆTask queuesï¼‰ï¼Œä»»åŠ¡æ¨¡å‹ã€‚ç®€å•æ¥è¯´å°±æ˜¯è®©å¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå…±åŒæ¶ˆè´¹é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ã€‚å½“æ¶ˆæ¯å¤„ç†æ¯”è¾ƒè€—æ—¶çš„æ—¶å€™ï¼Œå¯èƒ½ç”Ÿäº§æ¶ˆæ¯çš„é€Ÿåº¦ä¼šè¿œè¿œå¤§äºæ¶ˆæ¯çš„æ¶ˆè´¹é€Ÿåº¦ã€‚é•¿æ­¤ä»¥å¾€ï¼Œæ¶ˆæ¯å°±ä¼šå †ç§¯è¶Šæ¥è¶Šå¤šï¼Œæ— æ³•åŠæ—¶å¤„ç†ã€‚æ­¤æ—¶å°±å¯ä»¥ä½¿ç”¨work æ¨¡å‹ï¼Œå¤šä¸ªæ¶ˆè´¹è€…å…±åŒå¤„ç†æ¶ˆæ¯å¤„ç†ï¼Œé€Ÿåº¦å°±èƒ½å¤§å¤§æé«˜äº†ã€‚1.åˆ›å»ºä¸¤ä¸ªæ¨¡å—æ¶ˆæ¯å‘é€ï¼šè¿™æ¬¡æˆ‘ä»¬å¾ªç¯å‘é€ï¼Œæ¨¡æ‹Ÿå¤§é‡æ¶ˆæ¯å †ç§¯ç°è±¡ã€‚åœ¨publisheræœåŠ¡ä¸­çš„SpringAmqpTestç±»ä¸­æ·»åŠ ä¸€ä¸ªæµ‹è¯•æ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233package com.baidu;import org.junit.Test;import org.junit.runner.RunWith;import org.springframework.amqp.rabbit.core.RabbitTemplate;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.test.context.SpringBootTest;import org.springframework.test.context.junit4.SpringRunner;@RunWith(SpringRunner.class)@SpringBootTestpublic class SpringAmqpTest &#123; @Autowired private RabbitTemplate rabbitTemplate; /** * workQueue * å‘é˜Ÿåˆ—ä¸­ä¸åœå‘é€æ¶ˆæ¯ï¼Œæ¨¡æ‹Ÿæ¶ˆæ¯å †ç§¯ã€‚ */ @Test public void testWorkQueue() throws InterruptedException &#123; // é˜Ÿåˆ—åç§° String queueName = &quot;work.queue&quot;; // æ¶ˆæ¯ String message = &quot;hello, message_&quot;; for (int i = 0; i &lt; 50; i++) &#123; // å‘é€æ¶ˆæ¯ rabbitTemplate.convertAndSend(queueName, message + i); Thread.sleep(20); &#125; &#125;&#125; æ³¨æ„ï¼šä»¥ä¸Šæ–¹æ³•ä»…åœ¨work.queueé˜Ÿåˆ—å·²ç»å­˜åœ¨çš„æƒ…å†µä¸‹å¯ä»¥å‘é€æ¶ˆæ¯ï¼Œå¦‚æœwork.queueé˜Ÿåˆ—ä¸å­˜åœ¨ï¼Œåˆ™æ— æ³•å‘é€æ¶ˆæ¯ã€‚å› æ­¤è¿˜éœ€è¦æ·»åŠ ä¸€ä¸ªé…ç½®ç±» 12345678910111213package com.baidu.config;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.amqp.core.Queue;@Configurationpublic class QueueConfig &#123; @Bean public Queue workQueue() &#123; return new Queue(&quot;work.queue&quot;); &#125;&#125; è‡³æ­¤ï¼Œå¯ä»¥è¿è¡Œæµ‹è¯•ç±»è¿›è¡Œæµ‹è¯•æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹æ¶ˆæ¯æ˜¯å¦å‘é€æˆåŠŸ æ¶ˆæ¯æ¥æ”¶:(è¿™ä¸ªæµ‹è¯•æˆ‘ä»¬å…ˆå¯åŠ¨æ¶ˆè´¹è€…ï¼Œå†å¯åŠ¨ç”Ÿäº§è€…)è¦æ¨¡æ‹Ÿå¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œæˆ‘ä»¬åœ¨consumeræœåŠ¡çš„SpringRabbitListenerä¸­æ·»åŠ 2ä¸ªæ–°çš„æ–¹æ³•ï¼š 123456789101112131415161718192021222324package com.baidu.listener;import org.springframework.amqp.rabbit.annotation.Queue;import org.springframework.amqp.rabbit.annotation.RabbitListener;import org.springframework.stereotype.Component;import java.time.LocalTime;@Componentpublic class SpringRabbitListener &#123; @RabbitListener(queuesToDeclare = @Queue(&quot;work.queue&quot;)) public void listenWorkQueue1(String msg) throws InterruptedException &#123; System.out.println(&quot;æ¶ˆè´¹è€…1æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€&quot; + msg + &quot;ã€‘&quot; + LocalTime.now()); Thread.sleep(20); &#125; @RabbitListener(queuesToDeclare = @Queue(&quot;work.queue&quot;)) public void listenWorkQueue2(String msg) throws InterruptedException &#123; System.err.println(&quot;æ¶ˆè´¹è€…2........æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€&quot; + msg + &quot;ã€‘&quot; + LocalTime.now()); Thread.sleep(200); &#125;&#125; æ³¨æ„ï¼šåœ¨è¿™é‡Œæˆ‘ä½¿ç”¨äº†queuesToDeclareè€Œä¸æ˜¯ä¸Šä¸€ä¸ªæ¡ˆä¾‹ä¸­ä½¿ç”¨çš„queueså®ƒä»¬çš„åŒºåˆ«åœ¨äºï¼š-queuesï¼šç”¨äºæŒ‡å®šå·²ç»å­˜åœ¨çš„é˜Ÿåˆ—åç§°ï¼Œè¿™äº›é˜Ÿåˆ—å·²ç»è¢«å®šä¹‰åœ¨ RabbitMQ ä¸­ï¼Œå¹¶ä¸”å¯ç”¨äºæ¶ˆæ¯å‘é€å’Œæ¥æ”¶ã€‚-queuesToDeclareï¼šç”¨äºå£°æ˜é˜Ÿåˆ—å¹¶æŒ‡å®šé˜Ÿåˆ—åç§°ï¼Œå¦‚æœé˜Ÿåˆ—åœ¨ RabbitMQ ä¸­ä¸å­˜åœ¨ï¼Œåˆ™ä¼šè‡ªåŠ¨åˆ›å»ºï¼Œç„¶åå°†å…¶ç”¨äºæ¶ˆæ¯å‘é€å’Œæ¥æ”¶ã€‚å› ä¸ºåœ¨å¼€å‘çš„æ—¶å€™ï¼Œä¸ç¡®å®šç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…æœåŠ¡å“ªä¸ªæœåŠ¡ä¼šå…ˆå¯åŠ¨ï¼Œå› æ­¤ä¸èƒ½æŒ‡æœ›å…ˆå¯åŠ¨ç”Ÿäº§è€…åˆ›å»ºå¥½é˜Ÿåˆ— æµ‹è¯•ï¼šå¯åŠ¨ConsumerApplicationåï¼Œåœ¨æ‰§è¡ŒpublisheræœåŠ¡ä¸­åˆšåˆšç¼–å†™çš„å‘é€æµ‹è¯•æ–¹æ³•testWorkQueueã€‚å¯ä»¥çœ‹åˆ°æ¶ˆè´¹è€…1å¾ˆå¿«å®Œæˆäº†è‡ªå·±çš„25æ¡æ¶ˆæ¯ã€‚æ¶ˆè´¹è€…2å´åœ¨ç¼“æ…¢çš„å¤„ç†è‡ªå·±çš„25æ¡æ¶ˆæ¯ã€‚ä¹Ÿå°±æ˜¯è¯´æ¶ˆæ¯æ˜¯å¹³å‡åˆ†é…ç»™æ¯ä¸ªæ¶ˆè´¹è€…ï¼Œå¹¶æ²¡æœ‰è€ƒè™‘åˆ°æ¶ˆè´¹è€…çš„å¤„ç†èƒ½åŠ›ã€‚è¿™æ ·æ˜¾ç„¶æ˜¯æœ‰é—®é¢˜çš„ã€‚ ä¹‹æ‰€ä»¥ä¼šå‡ºç°ä¸Šé¢çš„é—®é¢˜ï¼Œæ˜¯å› ä¸ºæ¶ˆæ¯é¢„å–æœºåˆ¶ï¼Œä¾‹å¦‚å½“æœ‰10ä¸ªæ¶ˆæ¯å †ç§¯åˆ°é˜Ÿåˆ—ä¸­æ—¶ï¼Œæ¶ˆè´¹è€…1å’Œæ¶ˆè´¹è€…2åœ¨è¿›è¡Œæ¶ˆè´¹ä¹‹å‰ï¼Œä¼šå…ˆå¹³å‡è·å–åˆ°é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼ˆå…ˆå¹³å‡è·å–åˆ°ï¼Œè·å–äº†ä¹‹åå†è¿›è¡Œæ¶ˆè´¹ï¼‰å°±ç±»ä¼¼ç°åœ¨æœ‰4ä¸ªèœï¼Œä¸€ä¸ªå¤§äººå’Œä¸€ä¸ªå°å­©æ¥åˆ†ï¼Œç»“æœå¤§äººåˆ†åˆ°ä¸¤ä¸ªï¼Œå°å­©åˆ†åˆ°ä¸¤ä¸ªã€‚ç„¶åå¤§äººä¸å¤Ÿåƒï¼Œå°å­©åƒä¸å®Œã€‚ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µï¼Œå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®æ¶ˆæ¯é¢„å–çš„ä¸Šé™ 12345678910spring: rabbitmq: host: ä½ çš„ip # rabbitMQçš„ipåœ°å€ port: 5672 # ç«¯å£ username: root password: root virtual-host: / listener: simple: prefetch: 1 # æ¯æ¬¡åªèƒ½è·å–ä¸€æ¡æ¶ˆæ¯ï¼Œå¤„ç†å®Œæˆæ‰èƒ½è·å–ä¸‹ä¸€ä¸ªæ¶ˆæ¯ è®¾ç½®ä¹‹åå†æ¬¡æµ‹è¯• 3.å‘å¸ƒè®¢é˜…æ¨¡å¼å‘å¸ƒè®¢é˜…çš„æ¨¡å‹å¦‚å›¾ï¼šå¯ä»¥çœ‹åˆ°ï¼Œåœ¨è®¢é˜…æ¨¡å‹ä¸­ï¼Œå¤šäº†ä¸€ä¸ªexchangeè§’è‰²ï¼ˆä¹‹å‰ç”¨çš„æ˜¯é»˜è®¤çš„exchangeï¼‰ï¼Œè€Œä¸”è¿‡ç¨‹ç•¥æœ‰å˜åŒ–ï¼š Publisherï¼šç”Ÿäº§è€…ï¼Œä¹Ÿå°±æ˜¯è¦å‘é€æ¶ˆæ¯çš„ç¨‹åºï¼Œä½†æ˜¯ä¸å†å‘é€åˆ°é˜Ÿåˆ—ä¸­ï¼Œè€Œæ˜¯å‘ç»™exchangeï¼ˆäº¤æ¢æœºï¼‰ Exchangeï¼šäº¤æ¢æœºï¼Œå›¾ä¸­çš„exchangeã€‚ä¸€æ–¹é¢ï¼Œæ¥æ”¶ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ã€‚å¦ä¸€æ–¹é¢ï¼ŒçŸ¥é“å¦‚ä½•å¤„ç†æ¶ˆæ¯ï¼Œä¾‹å¦‚é€’äº¤ç»™æŸä¸ªç‰¹åˆ«é˜Ÿåˆ—ã€é€’äº¤ç»™æ‰€æœ‰é˜Ÿåˆ—ã€æˆ–æ˜¯å°†æ¶ˆæ¯ä¸¢å¼ƒã€‚åˆ°åº•å¦‚ä½•æ“ä½œï¼Œå–å†³äºExchangeçš„ç±»å‹ã€‚Exchangeæœ‰ä»¥ä¸‹3ç§ç±»å‹ï¼š Fanoutï¼šå¹¿æ’­ï¼Œå°†æ¶ˆæ¯äº¤ç»™æ‰€æœ‰ç»‘å®šåˆ°äº¤æ¢æœºçš„é˜Ÿåˆ— Directï¼šå®šå‘ï¼ŒæŠŠæ¶ˆæ¯äº¤ç»™ç¬¦åˆæŒ‡å®šrouting key çš„é˜Ÿåˆ— Topicï¼šé€šé…ç¬¦ï¼ŒæŠŠæ¶ˆæ¯äº¤ç»™ç¬¦åˆrouting patternï¼ˆè·¯ç”±æ¨¡å¼ï¼‰ çš„é˜Ÿåˆ— Consumerï¼šæ¶ˆè´¹è€…ï¼Œä¸ä»¥å‰ä¸€æ ·ï¼Œè®¢é˜…é˜Ÿåˆ—ï¼Œæ²¡æœ‰å˜åŒ– Queueï¼šæ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿä¸ä»¥å‰ä¸€æ ·ï¼Œæ¥æ”¶æ¶ˆæ¯ã€ç¼“å­˜æ¶ˆæ¯ã€‚ **Exchangeï¼ˆäº¤æ¢æœºï¼‰åªè´Ÿè´£è½¬å‘æ¶ˆæ¯ï¼Œä¸å…·å¤‡å­˜å‚¨æ¶ˆæ¯çš„èƒ½åŠ›ï¼Œå› æ­¤å¦‚æœæ²¡æœ‰ä»»ä½•é˜Ÿåˆ—ä¸Exchangeç»‘å®šï¼Œæˆ–è€…æ²¡æœ‰ç¬¦åˆè·¯ç”±è§„åˆ™çš„é˜Ÿåˆ—ï¼Œé‚£ä¹ˆæ¶ˆæ¯ä¼šä¸¢å¤±ï¼ 1.FanoutFanoutï¼Œè‹±æ–‡ç¿»è¯‘æ˜¯æ‰‡å‡ºï¼Œæˆ‘è§‰å¾—åœ¨MQä¸­å«å¹¿æ’­æ›´åˆé€‚ã€‚åœ¨å¹¿æ’­æ¨¡å¼ä¸‹ï¼Œæ¶ˆæ¯å‘é€æµç¨‹æ˜¯è¿™æ ·çš„ï¼š 1ï¼‰ å¯ä»¥æœ‰å¤šä¸ªé˜Ÿåˆ— 2ï¼‰ æ¯ä¸ªé˜Ÿåˆ—éƒ½è¦ç»‘å®šåˆ°Exchangeï¼ˆäº¤æ¢æœºï¼‰ 3ï¼‰ ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ï¼Œåªèƒ½å‘é€åˆ°äº¤æ¢æœºï¼Œäº¤æ¢æœºæ¥å†³å®šè¦å‘ç»™å“ªä¸ªé˜Ÿåˆ—ï¼Œç”Ÿäº§è€…æ— æ³•å†³å®š 4ï¼‰ äº¤æ¢æœºæŠŠæ¶ˆæ¯å‘é€ç»™ç»‘å®šè¿‡çš„æ‰€æœ‰é˜Ÿåˆ— 5ï¼‰ è®¢é˜…é˜Ÿåˆ—çš„æ¶ˆè´¹è€…éƒ½èƒ½æ‹¿åˆ°æ¶ˆæ¯ æ¡ˆä¾‹: åˆ›å»ºä¸€ä¸ªäº¤æ¢æœº baidu.fanoutï¼Œç±»å‹æ˜¯Fanout åˆ›å»ºä¸¤ä¸ªé˜Ÿåˆ—fanout.queue1å’Œfanout.queue2ï¼Œç»‘å®šåˆ°äº¤æ¢æœºbaidu.fanout ä»£ç ç¼–å†™:åœ¨consumerä¸­åˆ›å»ºä¸€ä¸ªç±»ï¼Œå£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœºï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253package com.baidu.config;import org.springframework.amqp.core.Binding;import org.springframework.amqp.core.BindingBuilder;import org.springframework.amqp.core.FanoutExchange;import org.springframework.amqp.core.Queue;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;@Configurationpublic class FanoutConfig &#123; /** * å£°æ˜äº¤æ¢æœº * * @return Fanoutç±»å‹äº¤æ¢æœº */ @Bean public FanoutExchange fanoutExchange() &#123; return new FanoutExchange(&quot;baidu.fanout&quot;); &#125; /** * ç¬¬1ä¸ªé˜Ÿåˆ— */ @Bean public Queue fanoutQueue1() &#123; return new Queue(&quot;fanout.queue1&quot;); &#125; /** * ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº */ @Bean public Binding bindingQueue1(Queue fanoutQueue1, FanoutExchange fanoutExchange) &#123; return BindingBuilder.bind(fanoutQueue1).to(fanoutExchange); &#125; /** * ç¬¬2ä¸ªé˜Ÿåˆ— */ @Bean public Queue fanoutQueue2() &#123; return new Queue(&quot;fanout.queue2&quot;); &#125; /** * ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº */ @Bean public Binding bindingQueue2(Queue fanoutQueue2, FanoutExchange fanoutExchange) &#123; return BindingBuilder.bind(fanoutQueue2).to(fanoutExchange); &#125;&#125; åœ¨consumeræœåŠ¡çš„SpringRabbitListenerä¸­æ·»åŠ ä¸¤ä¸ªæ–¹æ³•ï¼Œä½œä¸ºæ¶ˆè´¹è€…ï¼š 12345678910111213141516171819package com.baidu.listener;import org.springframework.amqp.rabbit.annotation.RabbitListener;import org.springframework.stereotype.Component;@Componentpublic class SpringRabbitListener &#123; @RabbitListener(queues = &quot;fanout.queue1&quot;) public void listenFanoutQueue1(String msg) &#123; System.out.println(&quot;æ¶ˆè´¹è€…1æ¥æ”¶åˆ°Fanoutæ¶ˆæ¯ï¼šã€&quot; + msg + &quot;ã€‘&quot;); &#125; @RabbitListener(queues = &quot;fanout.queue2&quot;) public void listenFanoutQueue2(String msg) &#123; System.out.println(&quot;æ¶ˆè´¹è€…2æ¥æ”¶åˆ°Fanoutæ¶ˆæ¯ï¼šã€&quot; + msg + &quot;ã€‘&quot;); &#125;&#125; è‡³æ­¤ï¼Œå¯ä»¥è§‚å¯Ÿæ§åˆ¶å°ï¼Œæ˜¯å¦ç”Ÿæˆäº†æ–°çš„exchangeä¸é˜Ÿåˆ— åœ¨publisheræœåŠ¡çš„SpringAmqpTestç±»ä¸­æ·»åŠ æµ‹è¯•æ–¹æ³•ï¼š 1234567891011121314151617181920212223242526package com.baidu;import org.junit.Test;import org.junit.runner.RunWith;import org.springframework.amqp.rabbit.core.RabbitTemplate;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.test.context.SpringBootTest;import org.springframework.test.context.junit4.SpringRunner;@RunWith(SpringRunner.class)@SpringBootTestpublic class SpringAmqpTest03 &#123; @Autowired private RabbitTemplate rabbitTemplate; @Test public void testFanoutExchange() &#123; // é˜Ÿåˆ—åç§° String exchangeName = &quot;baidu.fanout&quot;; // æ¶ˆæ¯ String message = &quot;hello, yjf!&quot;; rabbitTemplate.convertAndSend(exchangeName, &quot;&quot;, message); &#125;&#125; è‡³æ­¤å¯ä»¥å¯åŠ¨æµ‹è¯•æ–¹æ³•è¿›è¡Œæµ‹è¯•ï¼Œè§‚å¯Ÿæ§åˆ¶å°æ˜¯å¦æœ‰è·å–åˆ°æ¶ˆæ¯ æ€»ç»“:äº¤æ¢æœºçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ æ¥æ”¶publisherå‘é€çš„æ¶ˆæ¯ å°†æ¶ˆæ¯æŒ‰ç…§è§„åˆ™è·¯ç”±åˆ°ä¸ä¹‹ç»‘å®šçš„é˜Ÿåˆ— ä¸èƒ½ç¼“å­˜æ¶ˆæ¯ï¼Œè·¯ç”±å¤±è´¥ï¼Œæ¶ˆæ¯ä¸¢å¤± FanoutExchangeçš„ä¼šå°†æ¶ˆæ¯è·¯ç”±åˆ°æ¯ä¸ªç»‘å®šçš„é˜Ÿåˆ— å£°æ˜é˜Ÿåˆ—ã€äº¤æ¢æœºã€ç»‘å®šå…³ç³»çš„Beanæ˜¯ä»€ä¹ˆï¼Ÿ Queue FanoutExchange Binding 2.Directåœ¨Fanoutæ¨¡å¼ä¸­ï¼Œä¸€æ¡æ¶ˆæ¯ï¼Œä¼šè¢«æ‰€æœ‰è®¢é˜…çš„é˜Ÿåˆ—éƒ½æ¶ˆè´¹ã€‚ä½†æ˜¯ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›ä¸åŒçš„æ¶ˆæ¯è¢«ä¸åŒçš„é˜Ÿåˆ—æ¶ˆè´¹ã€‚è¿™æ—¶å°±è¦ç”¨åˆ°Directç±»å‹çš„Exchangeã€‚åœ¨Directæ¨¡å‹ä¸‹ï¼š é˜Ÿåˆ—ä¸äº¤æ¢æœºçš„ç»‘å®šï¼Œä¸èƒ½æ˜¯ä»»æ„ç»‘å®šäº†ï¼Œè€Œæ˜¯è¦æŒ‡å®šä¸€ä¸ªRoutingKeyï¼ˆè·¯ç”±keyï¼‰ æ¶ˆæ¯çš„å‘é€æ–¹åœ¨ å‘ Exchangeå‘é€æ¶ˆæ¯æ—¶ï¼Œä¹Ÿå¿…é¡»æŒ‡å®šæ¶ˆæ¯çš„ RoutingKeyã€‚ Exchangeä¸å†æŠŠæ¶ˆæ¯äº¤ç»™æ¯ä¸€ä¸ªç»‘å®šçš„é˜Ÿåˆ—ï¼Œè€Œæ˜¯æ ¹æ®æ¶ˆæ¯çš„Routing Keyè¿›è¡Œåˆ¤æ–­ï¼Œåªæœ‰é˜Ÿåˆ—çš„Routingkeyä¸æ¶ˆæ¯çš„ Routing keyå®Œå…¨ä¸€è‡´ï¼Œæ‰ä¼šæ¥æ”¶åˆ°æ¶ˆæ¯ æ¡ˆä¾‹éœ€æ±‚å¦‚ä¸‹ï¼š åˆ©ç”¨@RabbitListenerå£°æ˜Exchangeã€Queueã€RoutingKey åœ¨consumeræœåŠ¡ä¸­ï¼Œç¼–å†™ä¸¤ä¸ªæ¶ˆè´¹è€…æ–¹æ³•ï¼Œåˆ†åˆ«ç›‘å¬direct.queue1å’Œdirect.queue2 åœ¨publisherä¸­ç¼–å†™æµ‹è¯•æ–¹æ³•ï¼Œå‘baidu. directå‘é€æ¶ˆæ¯ ä»£ç ç¼–å†™:åŸºäºæ³¨è§£å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœºåŸºäº@Beançš„æ–¹å¼å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœºæ¯”è¾ƒéº»çƒ¦ï¼ŒSpringè¿˜æä¾›äº†åŸºäºæ³¨è§£æ–¹å¼æ¥å£°æ˜ã€‚åœ¨consumerçš„SpringRabbitListenerä¸­æ·»åŠ ä¸¤ä¸ªæ¶ˆè´¹è€…ï¼ŒåŒæ—¶åŸºäºæ³¨è§£æ¥å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœºï¼š 1234567891011121314151617181920212223242526272829303132package com.baidu.listener;import org.springframework.amqp.core.ExchangeTypes;import org.springframework.amqp.rabbit.annotation.Exchange;import org.springframework.amqp.rabbit.annotation.Queue;import org.springframework.amqp.rabbit.annotation.QueueBinding;import org.springframework.amqp.rabbit.annotation.RabbitListener;import org.springframework.stereotype.Component;@Componentpublic class SpringRabbitListener &#123; @RabbitListener(bindings = @QueueBinding( value = @Queue(name = &quot;direct.queue1&quot;), exchange = @Exchange(name = &quot;baidu.direct&quot;, type = ExchangeTypes.DIRECT), key = &#123;&quot;red&quot;, &quot;blue&quot;&#125; )) public void listenDirectQueue1(String msg)&#123; System.out.println(&quot;æ¶ˆè´¹è€…æ¥æ”¶åˆ°direct.queue1çš„æ¶ˆæ¯ï¼šã€&quot; + msg + &quot;ã€‘&quot;); &#125; @RabbitListener(bindings = @QueueBinding( value = @Queue(name = &quot;direct.queue2&quot;), exchange = @Exchange(name = &quot;baidu.direct&quot;, type = ExchangeTypes.DIRECT), key = &#123;&quot;red&quot;, &quot;yellow&quot;&#125; )) public void listenDirectQueue2(String msg)&#123; System.out.println(&quot;æ¶ˆè´¹è€…æ¥æ”¶åˆ°direct.queue2çš„æ¶ˆæ¯ï¼šã€&quot; + msg + &quot;ã€‘&quot;); &#125;&#125; è‡³æ­¤å¯ä»¥å¯åŠ¨consumerï¼Œè§‚å¯Ÿæ§åˆ¶å°æ˜¯å¦ç”Ÿæˆç›¸åº”çš„exchangeä¸é˜Ÿåˆ—æ¶ˆæ¯å‘é€:åœ¨publisheræœåŠ¡çš„SpringAmqpTestç±»ä¸­æ·»åŠ æµ‹è¯•æ–¹æ³•ï¼š 123456789101112131415161718192021222324252627package com.baidu;import org.junit.Test;import org.junit.runner.RunWith;import org.springframework.amqp.rabbit.core.RabbitTemplate;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.test.context.SpringBootTest;import org.springframework.test.context.junit4.SpringRunner;@RunWith(SpringRunner.class)@SpringBootTestpublic class SpringAmqpTest03 &#123; @Autowired private RabbitTemplate rabbitTemplate; @Test public void testSendDirectExchange() &#123; // äº¤æ¢æœºåç§° String exchangeName = &quot;baidu.direct&quot;; // æ¶ˆæ¯ String message = &quot;ç«¯åˆå¥½å•Š&quot;; // å‘é€æ¶ˆæ¯ rabbitTemplate.convertAndSend(exchangeName, &quot;yellow&quot;, message); &#125;&#125; æ€»ç»“:æè¿°ä¸‹Directäº¤æ¢æœºä¸Fanoutäº¤æ¢æœºçš„å·®å¼‚ï¼Ÿ Fanoutäº¤æ¢æœºå°†æ¶ˆæ¯è·¯ç”±ç»™æ¯ä¸€ä¸ªä¸ä¹‹ç»‘å®šçš„é˜Ÿåˆ— Directäº¤æ¢æœºæ ¹æ®RoutingKeyåˆ¤æ–­è·¯ç”±ç»™å“ªä¸ªé˜Ÿåˆ— å¦‚æœå¤šä¸ªé˜Ÿåˆ—å…·æœ‰ç›¸åŒçš„RoutingKeyï¼Œåˆ™ä¸FanoutåŠŸèƒ½ç±»ä¼¼ åŸºäº@RabbitListeneræ³¨è§£å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœºæœ‰å“ªäº›å¸¸è§æ³¨è§£ï¼Ÿ @Queue @Exchange 3.TopicTopicç±»å‹çš„Exchangeä¸Directç›¸æ¯”ï¼Œéƒ½æ˜¯å¯ä»¥æ ¹æ®RoutingKeyæŠŠæ¶ˆæ¯è·¯ç”±åˆ°ä¸åŒçš„é˜Ÿåˆ—ã€‚åªä¸è¿‡Topicç±»å‹Exchangeå¯ä»¥è®©é˜Ÿåˆ—åœ¨ç»‘å®šRouting key çš„æ—¶å€™ä½¿ç”¨é€šé…ç¬¦ï¼Routingkey ä¸€èˆ¬éƒ½æ˜¯æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå•è¯ç»„æˆï¼Œå¤šä¸ªå•è¯ä¹‹é—´ä»¥â€.â€åˆ†å‰²ï¼Œä¾‹å¦‚ï¼š baidu.inserté€šé…ç¬¦è§„åˆ™ï¼š#ï¼šåŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªè¯*ï¼šåŒ¹é…ä¸å¤šä¸å°‘æ°å¥½1ä¸ªè¯ä¸¾ä¾‹ï¼šitem.#ï¼šèƒ½å¤ŸåŒ¹é…item.spu.insert æˆ–è€… item.spuitem.*ï¼šåªèƒ½åŒ¹é…item.spuå›¾ç¤ºï¼šæ¡ˆä¾‹éœ€æ±‚ï¼šè§£é‡Šï¼š Queue1ï¼šç»‘å®šçš„æ˜¯china.# ï¼Œå› æ­¤å‡¡æ˜¯ä»¥ china.å¼€å¤´çš„routing key éƒ½ä¼šè¢«åŒ¹é…åˆ°ã€‚åŒ…æ‹¬china.newså’Œchina.weather Queue2ï¼šç»‘å®šçš„æ˜¯#.news ï¼Œå› æ­¤å‡¡æ˜¯ä»¥ .newsç»“å°¾çš„ routing key éƒ½ä¼šè¢«åŒ¹é…ã€‚åŒ…æ‹¬china.newså’Œjapan.news å®ç°æ€è·¯å¦‚ä¸‹ï¼š åˆ©ç”¨@RabbitListenerå£°æ˜Exchangeã€Queueã€RoutingKey åœ¨consumeræœåŠ¡ä¸­ï¼Œç¼–å†™ä¸¤ä¸ªæ¶ˆè´¹è€…æ–¹æ³•ï¼Œåˆ†åˆ«ç›‘å¬topic.queue1å’Œtopic.queue2 åœ¨publisherä¸­ç¼–å†™æµ‹è¯•æ–¹æ³•ï¼Œå‘baidu. topicå‘é€æ¶ˆæ¯ ä»£ç å®ç°æ¶ˆæ¯æ¥æ”¶åœ¨consumeræœåŠ¡çš„SpringRabbitListenerä¸­æ·»åŠ æ–¹æ³•ï¼š 12345678910111213141516171819202122@Componentpublic class SpringRabbitListener &#123; @RabbitListener(bindings = @QueueBinding( value = @Queue(name = &quot;topic.queue1&quot;), exchange = @Exchange(name = &quot;baidu.topic&quot;, type = ExchangeTypes.TOPIC), key = &quot;china.#&quot; )) public void listenTopicQueue1(String msg)&#123; System.out.println(&quot;æ¶ˆè´¹è€…æ¥æ”¶åˆ°topic.queue1çš„æ¶ˆæ¯ï¼šã€&quot; + msg + &quot;ã€‘&quot;); &#125; @RabbitListener(bindings = @QueueBinding( value = @Queue(name = &quot;topic.queue2&quot;), exchange = @Exchange(name = &quot;baidu.topic&quot;, type = ExchangeTypes.TOPIC), key = &quot;#.news&quot; )) public void listenTopicQueue2(String msg)&#123; System.out.println(&quot;æ¶ˆè´¹è€…æ¥æ”¶åˆ°topic.queue2çš„æ¶ˆæ¯ï¼šã€&quot; + msg + &quot;ã€‘&quot;); &#125;&#125; è‡³æ­¤ï¼Œå¯ä»¥å¯åŠ¨consumeræœåŠ¡ï¼Œç„¶åè§‚å¯Ÿæ§åˆ¶å°çš„exchangeä¸é˜Ÿåˆ—æ¶ˆæ¯å‘é€åœ¨publisheræœåŠ¡çš„SpringAmqpTestç±»ä¸­æ·»åŠ æµ‹è¯•æ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829package com.baidu;import org.junit.Test;import org.junit.runner.RunWith;import org.springframework.amqp.rabbit.core.RabbitTemplate;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.test.context.SpringBootTest;import org.springframework.test.context.junit4.SpringRunner;@RunWith(SpringRunner.class)@SpringBootTestpublic class SpringAmqpTest05 &#123; @Autowired private RabbitTemplate rabbitTemplate; /** * topicExchange */ @Test public void testSendTopicExchange() &#123; // äº¤æ¢æœºåç§° String exchangeName = &quot;baidu.topic&quot;; // æ¶ˆæ¯ String message = &quot;å•Šå“ˆï¼Œæ²¡æƒ³åˆ°å§!&quot;; // å‘é€æ¶ˆæ¯ rabbitTemplate.convertAndSend(exchangeName, &quot;china.news&quot;, message); &#125;&#125; è‡³æ­¤ï¼Œå¯ä»¥å¯åŠ¨æµ‹è¯•ç±»ï¼Œè¿›è¡Œæµ‹è¯•ï¼Œè§‚å¯Ÿæ§åˆ¶å°çš„è¾“å‡º 3.6.4.æ€»ç»“æè¿°ä¸‹Directäº¤æ¢æœºä¸Topicäº¤æ¢æœºçš„å·®å¼‚ï¼Ÿ Topicäº¤æ¢æœºæ¥æ”¶çš„æ¶ˆæ¯RoutingKeyå¿…é¡»æ˜¯å¤šä¸ªå•è¯ï¼Œä»¥ **.** åˆ†å‰² Topicäº¤æ¢æœºä¸é˜Ÿåˆ—ç»‘å®šæ—¶çš„bindingKeyå¯ä»¥æŒ‡å®šé€šé…ç¬¦ #ï¼šä»£è¡¨0ä¸ªæˆ–å¤šä¸ªè¯ *ï¼šä»£è¡¨1ä¸ªè¯ 5.æ¶ˆæ¯è½¬æ¢å™¨ä¹‹å‰çš„æ¡ˆä¾‹ä¸­Springä¼šæŠŠä½ å‘é€çš„æ¶ˆæ¯åºåˆ—åŒ–ä¸ºå­—èŠ‚å‘é€ç»™MQï¼Œæ¥æ”¶æ¶ˆæ¯çš„æ—¶å€™ï¼Œè¿˜ä¼šæŠŠå­—èŠ‚ååºåˆ—åŒ–ä¸ºJavaå¯¹è±¡ã€‚åªä¸è¿‡ï¼Œé»˜è®¤æƒ…å†µä¸‹Springé‡‡ç”¨çš„åºåˆ—åŒ–æ–¹å¼æ˜¯JDKåºåˆ—åŒ–ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼ŒJDKåºåˆ—åŒ–å­˜åœ¨ä¸‹åˆ—é—®é¢˜ï¼š æ•°æ®ä½“ç§¯è¿‡å¤§ æœ‰å®‰å…¨æ¼æ´ å¯è¯»æ€§å·® æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ã€‚ æµ‹è¯•é»˜è®¤è½¬æ¢å™¨æˆ‘ä»¬å‘é€ä¸€ä¸ªMapå¯¹è±¡ï¼š 123456789101112131415161718192021222324252627282930package com.baidu;import org.junit.Test;import org.junit.runner.RunWith;import org.springframework.amqp.rabbit.core.RabbitTemplate;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.test.context.SpringBootTest;import org.springframework.test.context.junit4.SpringRunner;import java.util.HashMap;import java.util.Map;@RunWith(SpringRunner.class)@SpringBootTestpublic class SpringAmqpTest &#123; @Autowired private RabbitTemplate rabbitTemplate; @Test public void testSendMap() &#123; // å‡†å¤‡æ¶ˆæ¯ Map&lt;String,Object&gt; msg = new HashMap&lt;&gt;(); msg.put(&quot;name&quot;, &quot;Jack&quot;); msg.put(&quot;age&quot;, 21); // å‘é€æ¶ˆæ¯ rabbitTemplate.convertAndSend(&quot;basic.queue&quot;, msg); &#125;&#125; è‡³æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å¯åŠ¨æµ‹è¯•ç±»ï¼Œè¿›è¡Œæµ‹è¯•ï¼ˆæµ‹è¯•çš„æ—¶å€™ï¼Œéœ€è¦å…ˆåœæ­¢cosumeræœåŠ¡ï¼Œä¸ç„¶çœ‹ä¸åˆ°æ•ˆæœï¼‰åˆ°æ§åˆ¶å°æŸ¥çœ‹æ¶ˆæ¯é…ç½®jsonè½¬æ¢å™¨æ˜¾ç„¶ï¼ŒJDKåºåˆ—åŒ–æ–¹å¼å¹¶ä¸åˆé€‚ã€‚æˆ‘ä»¬å¸Œæœ›æ¶ˆæ¯ä½“çš„ä½“ç§¯æ›´å°ã€å¯è¯»æ€§æ›´é«˜ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨JSONæ–¹å¼æ¥åšåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚åœ¨publisherå’Œconsumerä¸¤ä¸ªæœåŠ¡ä¸­éƒ½å¼•å…¥ä¾èµ–ï¼š 12345&lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.dataformat&lt;/groupId&gt; &lt;artifactId&gt;jackson-dataformat-xml&lt;/artifactId&gt; &lt;version&gt;2.9.10&lt;/version&gt;&lt;/dependency&gt; é…ç½®æ¶ˆæ¯è½¬æ¢å™¨ã€‚åœ¨publisherå’Œconsumerä¸¤ä¸ªæœåŠ¡ä¸­å¯åŠ¨ç±»ä¸­æ·»åŠ ä¸€ä¸ªBeanå³å¯ï¼š 1234@Bean public MessageConverter jsonMessageConverter()&#123; return new Jackson2JsonMessageConverter(); &#125; åœ¨consumerçš„SpringRabbitListenerä¸­ï¼Œç›‘å¬çš„æ–¹æ³•å‚æ•°éœ€è¦ä¸å‘é€çš„å‚æ•°ä¸€æ ·ï¼ˆæˆ‘ä»¬å‘é€çš„æ—¶å€™ä½¿ç”¨mapï¼Œè¿™é‡Œå°±ä½¿ç”¨mapæ¥æ”¶ï¼‰ 1234@RabbitListener(queues = &quot;basic.queue&quot;)public void listenSimpleQueueMessage(Map&lt;String,String&gt; msg)&#123; System.out.println(&quot;spring æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€&quot; + msg + &quot;ã€‘&quot;);&#125; 6.æ¡ˆä¾‹éœ€æ±‚ï¼š ç”¨æˆ·è¿›è¡Œä¸‹å•æ“ä½œ ï¼Œ ä¸‹å®Œå•ä»¥åè¦è¿›è¡ŒåŠ ç§¯åˆ†æ“ä½œï¼Œ è¦æ±‚ä¸‹å®Œå•ä»¥ååŠ ç§¯åˆ†é‡‡ç”¨RabbitMQ è¿›è¡ŒåŠ ç§¯åˆ†æ¡ˆä¾‹åˆ†æï¼š1 : ä¸‹å®Œå•ä»¥åæŠŠæ•°æ®å°è£…æˆæ¶ˆæ¯åˆ©ç”¨ç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ°RabbitMQä¸­ã€‚2ï¼šåœ¨ç§¯åˆ†æœåŠ¡ç¼–å†™æ¶ˆè´¹è€…å®æ—¶ç›‘å¬RabbitMQé˜Ÿåˆ—ä¸­æ¶ˆæ¯ï¼Œç›‘å¬åˆ°å–å‡ºæ¶ˆæ¯æ¶ˆè´¹åŠ ç§¯åˆ†ã€‚æ²¡æœ‰RabbitMQä¹‹å‰æœ‰äº†RabbitMQä»¥å 7.æ¶ˆæ¯ç¡®è®¤æœºåˆ¶7.1 ä¸ºä»€ä¹ˆè¦è¿›è¡Œæ¶ˆæ¯ç¡®è®¤ï¼Ÿåœ¨mq ä¸­ï¼Œæ¶ˆè´¹è€…å’Œç”Ÿäº§è€…å¹¶ä¸ç›´æ¥è¿›è¡Œé€šä¿¡ï¼Œç”Ÿäº§è€…åªè´Ÿè´£æŠŠæ¶ˆæ¯å‘é€åˆ°é˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…åªè´Ÿè´£ä»é˜Ÿåˆ—è·å–æ¶ˆæ¯ æ¶ˆè´¹è€…ä»é˜Ÿåˆ—ä¸­è·å–åˆ°æ¶ˆæ¯ä¹‹åï¼Œè¿™æ¡æ¶ˆæ¯å°±ä¸å­˜åœ¨é˜Ÿåˆ—ä¸­äº†ï¼Œä½†æ˜¯å¦‚æœæ­¤æ—¶æ¶ˆè´¹è€…æ‰€åœ¨çš„ä¿¡é“å› ä¸ºç½‘ç»œä¸­æ–­æ²¡æœ‰æ¶ˆè´¹åˆ°ï¼Œé‚£è¿™æ¡æ¶ˆæ¯å°±è¢«æ°¸è¿œçš„ä¸¢å¤±äº†ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å¸Œæœ›ç­‰å¾…æ¶ˆè´¹è€…æˆåŠŸæ¶ˆè´¹æ‰è¿™ä¸ªæ¶ˆæ¯ä¹‹åå†åˆ é™¤è¿™æ¡æ¶ˆæ¯ã€‚ è€Œåœ¨å‘é€æ¶ˆæ¯çš„æ—¶å€™ä¹Ÿæ˜¯è¿™æ ·çš„ï¼Œç”Ÿäº§è€…å‘æ¶ˆæ¯ç»™äº¤æ¢æœºï¼Œä¹Ÿä¸èƒ½ä¿è¯æ¶ˆæ¯å‡†ç¡®å‘é€è¿‡å»äº†ï¼Œæ¶ˆæ¯å°±åƒçŸ³æ²‰å¤§æµ·ä¸€æ ·ï¼Œæ‰€ä»¥è¿™æ ·éœ€è¦ä¸€ä¸ªæ¶ˆæ¯ç¡®è®¤ã€‚ è¿™ä¸ªæœºåˆ¶å°±æ˜¯ æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ã€‚ 7.2 æ¶ˆæ¯ç¡®è®¤æµç¨‹åœ¨æµç¨‹å›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä¸çœ‹åˆ°æ¶ˆæ¯ç¡®è®¤æ˜¯åˆ†ä¸ºç”Ÿäº§è€…ç¡®è®¤å’Œæ¶ˆè´¹è€…ç¡®è®¤çš„ã€‚è¿™ä¸¤ä¸ªæœºåˆ¶éƒ½æ˜¯å—åˆ° TCP åè®®çš„å¯å‘ï¼Œå®ƒä»¬å¯¹æ•°æ®å®‰å…¨éå¸¸é‡è¦ã€‚ æ¶ˆæ¯ä»å‘é€ï¼Œåˆ°æ¶ˆè´¹è€…æ¥æ”¶ï¼Œä¼šç»å†å¤šä¸ªè¿‡ç¨‹ï¼šå…¶ä¸­çš„æ¯ä¸€æ­¥éƒ½å¯èƒ½å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼Œå¸¸è§çš„ä¸¢å¤±åŸå› åŒ…æ‹¬ï¼š å‘é€æ—¶ä¸¢å¤±ï¼š ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯æœªé€è¾¾exchange æ¶ˆæ¯åˆ°è¾¾exchangeåæœªåˆ°è¾¾queue MQå®•æœºï¼Œqueueå°†æ¶ˆæ¯ä¸¢å¤± consumeræ¥æ”¶åˆ°æ¶ˆæ¯åæœªæ¶ˆè´¹å°±å®•æœº é’ˆå¯¹è¿™äº›é—®é¢˜ï¼ŒRabbitMQåˆ†åˆ«ç»™å‡ºäº†è§£å†³æ–¹æ¡ˆï¼š ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ mqæŒä¹…åŒ– æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶ å¤±è´¥é‡è¯•æœºåˆ¶ 7.3ç”Ÿäº§è€…æ¶ˆæ¯ç¡®è®¤RabbitMQæä¾›äº†publisher confirmæœºåˆ¶æ¥é¿å…æ¶ˆæ¯å‘é€åˆ°MQè¿‡ç¨‹ä¸­ä¸¢å¤±ã€‚è¿™ç§æœºåˆ¶å¿…é¡»ç»™æ¯ä¸ªæ¶ˆæ¯æŒ‡å®šä¸€ä¸ªå”¯ä¸€IDã€‚æ¶ˆæ¯å‘é€åˆ°MQä»¥åï¼Œä¼šè¿”å›ä¸€ä¸ªç»“æœç»™å‘é€è€…ï¼Œè¡¨ç¤ºæ¶ˆæ¯æ˜¯å¦å¤„ç†æˆåŠŸã€‚ è¿”å›ç»“æœæœ‰ä¸¤ç§æ–¹å¼ï¼š publisher-confirmï¼Œå‘é€è€…ç¡®è®¤ æ¶ˆæ¯æˆåŠŸæŠ•é€’åˆ°äº¤æ¢æœºï¼Œè¿”å›ack æ¶ˆæ¯æœªæŠ•é€’åˆ°äº¤æ¢æœºï¼Œè¿”å›nack publisher-returnï¼Œå‘é€è€…å›æ‰§ æ¶ˆæ¯æŠ•é€’åˆ°äº¤æ¢æœºäº†ï¼Œä½†æ˜¯æ²¡æœ‰è·¯ç”±åˆ°é˜Ÿåˆ—ã€‚è¿”å›ACKï¼ŒåŠè·¯ç”±å¤±è´¥åŸå› ã€‚ åˆ›å»ºæ¨¡å—åœ¨publicsher-07æ¨¡å—çš„é…ç½®æ–‡ä»¶ä¸­æ·»åŠ é…ç½®æ–‡ä»¶ 123456789101112spring: rabbitmq: host: ä½ çš„ip # rabbitMQçš„ipåœ°å€ port: 5672 # ç«¯å£ username: ä½ çš„ç”¨æˆ·å password: ä½ çš„å¯†ç  virtual-host: / publisher-confirm-type: correlated publisher-returns: true template: mandatory: true è¯´æ˜ï¼š publish-confirm-typeï¼šå¼€å¯publisher-confirmï¼Œè¿™é‡Œæ”¯æŒä¸¤ç§ç±»å‹ï¼š simpleï¼šåŒæ­¥ç­‰å¾…confirmç»“æœï¼Œç›´åˆ°è¶…æ—¶ correlatedï¼šå¼‚æ­¥å›è°ƒï¼Œå®šä¹‰ConfirmCallbackï¼ŒMQè¿”å›ç»“æœæ—¶ä¼šå›è°ƒè¿™ä¸ªConfirmCallback publish-returnsï¼šå¼€å¯publish-returnåŠŸèƒ½ï¼ŒåŒæ ·æ˜¯åŸºäºcallbackæœºåˆ¶ï¼Œä¸è¿‡æ˜¯å®šä¹‰ReturnCallback template.mandatoryï¼šå®šä¹‰æ¶ˆæ¯è·¯ç”±å¤±è´¥æ—¶çš„ç­–ç•¥ã€‚trueï¼Œåˆ™è°ƒç”¨ReturnCallbackï¼›falseï¼šåˆ™ç›´æ¥ä¸¢å¼ƒæ¶ˆæ¯ åœ¨consumerä¸­ç¼–å†™ä»£ç  123456789101112@Componentpublic class SpringRabbitListener &#123; @RabbitListener(bindings = @QueueBinding( value = @Queue(name = &quot;direct.queue1&quot;), exchange = @Exchange(name = &quot;baidu.direct&quot;, type = ExchangeTypes.DIRECT), key = &#123;&quot;red&quot;, &quot;blue&quot;&#125; )) public void listenDirectQueue1(String msg)&#123; System.out.println(&quot;æ¶ˆè´¹è€…æ¥æ”¶åˆ°direct.queue1çš„æ¶ˆæ¯ï¼šã€&quot; + msg + &quot;ã€‘&quot;); &#125;&#125; ç¼–å†™å¯åŠ¨ç±» 1234567@SpringBootApplicationpublic class ConsumerApplication07 &#123; public static void main(String[] args) &#123; SpringApplication.run(ConsumerApplication07.class); &#125;&#125; ç¼–å†™é…ç½®æ–‡ä»¶ 12345678910spring: rabbitmq: host: ä½ çš„ip # rabbitMQçš„ipåœ°å€ port: 5672 # ç«¯å£ username: ä½ çš„ç”¨æˆ·å password: ä½ çš„å¯†ç  virtual-host: / listener: simple: prefetch: 1 # æ¯æ¬¡åªèƒ½è·å–ä¸€æ¡æ¶ˆæ¯ï¼Œå¤„ç†å®Œæˆæ‰èƒ½è·å–ä¸‹ä¸€ä¸ªæ¶ˆæ¯ è‡³æ­¤å¯ä»¥å¯åŠ¨consumerå·¥ç¨‹ï¼Œè¿›è€Œåˆ›å»ºäº¤æ¢æœºã€é˜Ÿåˆ— å®šä¹‰Returnå›è°ƒï¼šæ¯ä¸ªRabbitTemplateåªèƒ½é…ç½®ä¸€ä¸ªReturnCallbackï¼Œå› æ­¤éœ€è¦åœ¨é¡¹ç›®åŠ è½½æ—¶é…ç½®ï¼šåœ¨publicsherä¸­ç¼–å†™é…ç½®ç±» 1234567891011121314151617181920212223242526package com.baidu.config;import lombok.extern.slf4j.Slf4j;import org.springframework.amqp.rabbit.core.RabbitTemplate;import org.springframework.beans.BeansException;import org.springframework.context.ApplicationContext;import org.springframework.context.ApplicationContextAware;import org.springframework.context.annotation.Configuration;@Slf4j@Configurationpublic class CommonConfig implements ApplicationContextAware &#123; @Override public void setApplicationContext(ApplicationContext applicationContext) throws BeansException &#123; // è·å–RabbitTemplate RabbitTemplate rabbitTemplate = applicationContext.getBean(RabbitTemplate.class); // è®¾ç½®ReturnCallback rabbitTemplate.setReturnCallback((message, replyCode, replyText, exchange, routingKey) -&gt; &#123; // æŠ•é€’å¤±è´¥ï¼Œè®°å½•æ—¥å¿— System.err.println(&quot;æ¶ˆæ¯å‘é€åˆ°äº†äº¤æ¢æœºï¼Œä½†æ˜¯æ²¡æœ‰å‘é€åˆ°é˜Ÿåˆ—å°±ä¼šæ‰§è¡Œè¿™é‡Œ&quot;); log.info(&quot;æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œåº”ç­”ç &#123;&#125;ï¼ŒåŸå› &#123;&#125;ï¼Œäº¤æ¢æœº&#123;&#125;ï¼Œè·¯ç”±é”®&#123;&#125;,æ¶ˆæ¯&#123;&#125;&quot;, replyCode, replyText, exchange, routingKey, message.toString()); // å¦‚æœæœ‰ä¸šåŠ¡éœ€è¦ï¼Œå¯ä»¥é‡å‘æ¶ˆæ¯ &#125;); &#125;&#125; åœ¨publicsherä¸­å®šä¹‰ConfirmCallbackConfirmCallbackå¯ä»¥åœ¨å‘é€æ¶ˆæ¯æ—¶æŒ‡å®šï¼Œå› ä¸ºæ¯ä¸ªä¸šåŠ¡å¤„ç†confirmæˆåŠŸæˆ–å¤±è´¥çš„é€»è¾‘ä¸ä¸€å®šç›¸åŒã€‚åœ¨publisheræœåŠ¡çš„SpringAmqpTestç±»ä¸­ï¼Œå®šä¹‰ä¸€ä¸ªå•å…ƒæµ‹è¯•æ–¹æ³•ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152package com.baidu;import lombok.extern.slf4j.Slf4j;import org.junit.Test;import org.junit.runner.RunWith;import org.springframework.amqp.rabbit.connection.CorrelationData;import org.springframework.amqp.rabbit.core.RabbitTemplate;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.test.context.SpringBootTest;import org.springframework.test.context.junit4.SpringRunner;import java.util.UUID;@RunWith(SpringRunner.class)@SpringBootTest@Slf4jpublic class SpringAmqpTest &#123; @Autowired private RabbitTemplate rabbitTemplate; @Test public void testSendMap() throws InterruptedException &#123; // 1.æ¶ˆæ¯ä½“ String message = &quot;æµ‹è¯•ç”Ÿäº§è€…ç¡®è®¤!&quot;; // 2.å…¨å±€å”¯ä¸€çš„æ¶ˆæ¯IDï¼Œéœ€è¦å°è£…åˆ°CorrelationDataä¸­ CorrelationData correlationData = new CorrelationData(UUID.randomUUID().toString()); // 3.æ·»åŠ callback correlationData.getFuture().addCallback( result -&gt; &#123; if (result.isAck()) &#123; // 3.1.ackï¼Œæ¶ˆæ¯æˆåŠŸ System.out.println(&quot;æ¶ˆæ¯å‘é€åˆ°äº¤æ¢æœºå°±ä¼šæ‰§è¡Œè¿™é‡Œ&quot;); System.out.println(&quot;æ¶ˆæ¯å‘é€æˆåŠŸï¼š&quot; + correlationData.getId()); &#125; else &#123; // 3.2.nackï¼Œæ¶ˆæ¯å¤±è´¥ System.out.println(&quot;æ¶ˆæ¯æ²¡æœ‰å‘é€åˆ°äº¤æ¢æœºå°±ä¼šæ‰§è¡Œè¿™é‡Œ&quot;); System.out.println(&quot;æ¶ˆæ¯å‘é€å¤±è´¥ï¼š&quot; + correlationData.getId() + &quot;åŸå› æ˜¯ï¼š&quot; + result.getReason()); &#125; &#125;, ex -&gt; &#123; System.out.println(&quot;å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œä¸çŸ¥é“ä»€ä¹ˆåŸå› å‡ºç°äº†å¼‚å¸¸ï¼Œå¯¼è‡´æ²¡æ”¶åˆ°å›æ‰§ï¼Œå°±ä¼šè¿›å…¥è¿™é‡Œæ‰§è¡Œè¿™é‡Œçš„ä»£ç ï¼Œç±»ä¼¼axiosè¯·æ±‚ä¸€æ ·&quot;); System.out.println(&quot;æ¶ˆæ¯å‘é€å¼‚å¸¸ï¼š&quot; + correlationData.getId() + &quot;åŸå› æ˜¯ï¼š&quot; + ex.getMessage()); &#125; ); // 4.å‘é€æ¶ˆæ¯ rabbitTemplate.convertAndSend(&quot;baidu.direct&quot;, &quot;red&quot;, message, correlationData); // ä¼‘çœ ä¸€ä¼šå„¿ï¼Œç­‰å¾…ackå›æ‰§ Thread.sleep(2000); &#125;&#125; è‡³æ­¤å¯ä»¥å¯åŠ¨æµ‹è¯•ç±» è¿›è¡Œæµ‹è¯• 7.4æ¶ˆè´¹è€…æ¶ˆæ¯ç¡®è®¤rabbitmq æ¶ˆè´¹æ¶ˆæ¯æœ‰ä¸¤ç§æ¨¡å¼ï¼Œä¸€ä¸ªæ˜¯æ¨é€ push ï¼Œä¸€ä¸ªæ˜¯è‡ªå·±æ‹‰å–pullã€‚æ¨æ¨¡å¼ï¼šæ¶ˆæ¯ä¸­é—´ä»¶ä¸»åŠ¨å°†æ¶ˆæ¯æ¨é€ç»™æ¶ˆè´¹è€…æ‹‰æ¨¡å¼ï¼šæ¶ˆè´¹è€…ä¸»åŠ¨ä»æ¶ˆæ¯ä¸­é—´ä»¶æ‹‰å–æ¶ˆæ¯ã€‚ä½†å®é™…ä½¿ç”¨ä¸­ï¼Œæ‹‰å–æ¶ˆæ¯æ˜¯ä¼šé™ä½ç³»ç»Ÿååé‡çš„ï¼Œä»¥åŠæ¶ˆè´¹è€…å¾ˆéš¾å®æ—¶è·å–æ¶ˆæ¯ï¼Œå› æ­¤ï¼Œä¸€èˆ¬ä½¿ç”¨çš„æ˜¯push æ¨¡å¼ã€‚åœ¨ mq æ¨æ¶ˆæ¯ç»™æ¶ˆè´¹è€…ä¸æ˜¯ç­‰æ¶ˆè´¹è€…æ¶ˆè´¹å®Œä¸€ä¸ªå†æ¨ä¸€ä¸ªï¼Œè€Œæ˜¯æ ¹æ®prefetch_count å‚æ•°æ¥å†³å®šå¯ä»¥æ¨å¤šä¸ªæ¶ˆæ¯åˆ°æ¶ˆè´¹è€…çš„ç¼“å­˜é‡Œé¢ã€‚åœ¨æ¶ˆè´¹è€…ç¡®è®¤ä¸­ï¼Œæœ‰å¯èƒ½å‡ºç°æ¶ˆæ¯ä¸¢å¤±çš„åœºæ™¯: 1ï¼‰RabbitMQæŠ•é€’æ¶ˆæ¯ç»™æ¶ˆè´¹è€… 2ï¼‰æ¶ˆè´¹è€…è·å–æ¶ˆæ¯åï¼Œè¿”å›ACKç»™RabbitMQ 3ï¼‰RabbitMQåˆ é™¤æ¶ˆæ¯ 4ï¼‰æ¶ˆè´¹è€…å®•æœºï¼Œæ¶ˆæ¯å°šæœªå¤„ç† è¿™æ ·ï¼Œæ¶ˆæ¯å°±ä¸¢å¤±äº†ã€‚å› æ­¤æ¶ˆè´¹è€…è¿”å›ACKçš„æ—¶æœºéå¸¸é‡è¦ã€‚ è€ŒSpringAMQPåˆ™å…è®¸é…ç½®ä¸‰ç§ç¡®è®¤æ¨¡å¼ï¼š â€¢manualï¼šæ‰‹åŠ¨ackï¼Œéœ€è¦åœ¨ä¸šåŠ¡ä»£ç ç»“æŸåï¼Œè°ƒç”¨apiå‘é€ackã€‚ â€¢autoï¼šè‡ªåŠ¨ackï¼Œç”±springç›‘æµ‹listenerä»£ç æ˜¯å¦å‡ºç°å¼‚å¸¸ï¼Œæ²¡æœ‰å¼‚å¸¸åˆ™è¿”å›ackï¼›æŠ›å‡ºå¼‚å¸¸åˆ™è¿”å›nack â€¢noneï¼šå…³é—­ackï¼ŒMQå‡å®šæ¶ˆè´¹è€…è·å–æ¶ˆæ¯åä¼šæˆåŠŸå¤„ç†ï¼Œå› æ­¤æ¶ˆæ¯æŠ•é€’åç«‹å³è¢«åˆ é™¤ ç”±æ­¤å¯çŸ¥ï¼š noneæ¨¡å¼ä¸‹ï¼Œæ¶ˆæ¯æŠ•é€’æ˜¯ä¸å¯é çš„ï¼Œå¯èƒ½ä¸¢å¤± autoæ¨¡å¼ç±»ä¼¼äº‹åŠ¡æœºåˆ¶ï¼Œå‡ºç°å¼‚å¸¸æ—¶è¿”å›nackï¼Œæ¶ˆæ¯å›æ»šåˆ°mqï¼›æ²¡æœ‰å¼‚å¸¸ï¼Œè¿”å›ack manualï¼šè‡ªå·±æ ¹æ®ä¸šåŠ¡æƒ…å†µï¼Œåˆ¤æ–­ä»€ä¹ˆæ—¶å€™è¯¥ack ä¸€èˆ¬ï¼Œæˆ‘ä»¬éƒ½æ˜¯ä½¿ç”¨é»˜è®¤çš„autoå³å¯ã€‚æ³¨æ„ï¼šåœ¨springboot(2.3.9ç‰ˆæœ¬)+rabbitmq(3.9.11ç‰ˆæœ¬)ï¼Œé»˜è®¤çš„æ¨¡å¼æ˜¯auto ä¸‹é¢æ¼”ç¤ºnoneæ¨¡å¼ä¿®æ”¹consumeræ¨¡å—çš„application.ymlæ–‡ä»¶ï¼Œæ·»åŠ ä¸‹é¢å†…å®¹ï¼š 1234567891011spring: rabbitmq: host: ä½ çš„ip # rabbitMQçš„ipåœ°å€ port: 5672 # ç«¯å£ username: ä½ çš„ç”¨æˆ·å password: ä½ çš„å¯†ç  virtual-host: / listener: simple: prefetch: 1 # æ¯æ¬¡åªèƒ½è·å–ä¸€æ¡æ¶ˆæ¯ï¼Œå¤„ç†å®Œæˆæ‰èƒ½è·å–ä¸‹ä¸€ä¸ªæ¶ˆæ¯ acknowledge-mode: none ä¿®æ”¹SpringRabbitListenerçš„ä»£ç ï¼Œå¹¶ä¸”åœ¨ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ä¹‹åï¼Œç”¨æ–­ç‚¹çš„æ–¹å¼å¯åŠ¨æ¶ˆè´¹è€…æœåŠ¡å¯åŠ¨ä¹‹åè§‚å¯Ÿrabbtimqçš„æ§åˆ¶å°å¯ä»¥çœ‹åˆ°æµ‹è¯•å¯ä»¥å‘ç°ï¼Œå½“æ¶ˆæ¯å‘é€åˆ°æ¶ˆè´¹è€…ï¼Œæ¶ˆæ¯ç«‹å³è¢«RabbitMQåˆ é™¤äº†ã€‚ æ¥ä¸‹æ¥æµ‹è¯•autoæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰æŠ›å‡ºå¼‚å¸¸åï¼Œå› ä¸ºSpringä¼šè‡ªåŠ¨è¿”å›nackï¼Œæ‰€ä»¥æ¶ˆæ¯æ¢å¤è‡³ReadyçŠ¶æ€ï¼Œå¹¶ä¸”æ²¡æœ‰è¢«RabbitMQåˆ é™¤ï¼š 7.5 æ¶ˆè´¹å¤±è´¥é‡è¯•æœºåˆ¶å½“æ¶ˆè´¹è€…å‡ºç°å¼‚å¸¸åï¼Œæ¶ˆæ¯ä¼šä¸æ–­requeueï¼ˆé‡å…¥é˜Ÿï¼‰åˆ°é˜Ÿåˆ—ï¼Œå†é‡æ–°å‘é€ç»™æ¶ˆè´¹è€…ï¼Œç„¶åå†æ¬¡å¼‚å¸¸ï¼Œå†æ¬¡requeueï¼Œæ— é™å¾ªç¯ï¼Œå¯¼è‡´mqçš„æ¶ˆæ¯å¤„ç†é£™å‡ï¼Œå¸¦æ¥ä¸å¿…è¦çš„å‹åŠ›ï¼š 7.5.1 æœ¬åœ°é‡è¯•ç”±äºé»˜è®¤çš„å¤±è´¥é‡è¯•æœºåˆ¶ä¼šå¯¼è‡´mqçš„æ¶ˆæ¯å¤„ç†é£™å‡ï¼Œå¸¦æ¥ä¸å¿…è¦çš„å‹åŠ›ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨Springçš„retryæœºåˆ¶ï¼Œåœ¨æ¶ˆè´¹è€…å‡ºç°å¼‚å¸¸æ—¶åˆ©ç”¨æœ¬åœ°é‡è¯•ï¼Œè€Œä¸æ˜¯æ— é™åˆ¶çš„requeueåˆ°mqé˜Ÿåˆ—ã€‚ä¿®æ”¹consumeræœåŠ¡çš„application.ymlæ–‡ä»¶ï¼Œæ·»åŠ å†…å®¹ï¼š 12345678910111213141516171819202122232425spring: rabbitmq: listener: simple: retry: enabled: true # å¼€å¯æ¶ˆè´¹è€…å¤±è´¥é‡è¯•spring: rabbitmq: host: ä½ çš„ip # rabbitMQçš„ipåœ°å€ port: 5672 # ç«¯å£ username: ä½ çš„ç”¨æˆ·å password: ä½ çš„å¯†ç  virtual-host: / listener: simple: prefetch: 1 # æ¯æ¬¡åªèƒ½è·å–ä¸€æ¡æ¶ˆæ¯ï¼Œå¤„ç†å®Œæˆæ‰èƒ½è·å–ä¸‹ä¸€ä¸ªæ¶ˆæ¯ retry: enabled: true # å¼€å¯æ¶ˆè´¹è€…å¤±è´¥é‡è¯• initial-interval: 1000 # åˆè¯†çš„å¤±è´¥ç­‰å¾…æ—¶é•¿ä¸º1ç§’ multiplier: 3 # å¤±è´¥çš„ç­‰å¾…æ—¶é•¿å€æ•°ï¼Œä¸‹æ¬¡ç­‰å¾…æ—¶é•¿ = multiplier * last-interval max-attempts: 5 # æœ€å¤§é‡è¯•æ¬¡æ•° stateless: true # trueæ— çŠ¶æ€ï¼›falseæœ‰çŠ¶æ€ã€‚å¦‚æœä¸šåŠ¡ä¸­åŒ…å«äº‹åŠ¡ï¼Œè¿™é‡Œæ”¹ä¸ºfalse initial-interval: 1000 # åˆè¯†çš„å¤±è´¥ç­‰å¾…æ—¶é•¿ä¸º1ç§’ multiplier: 1 # å¤±è´¥çš„ç­‰å¾…æ—¶é•¿å€æ•°ï¼Œä¸‹æ¬¡ç­‰å¾…æ—¶é•¿ = multiplier * last-interval max-attempts: 3 # æœ€å¤§é‡è¯•æ¬¡æ•° stateless: true # trueæ— çŠ¶æ€ï¼›falseæœ‰çŠ¶æ€ã€‚å¦‚æœä¸šåŠ¡ä¸­åŒ…å«äº‹åŠ¡ï¼Œè¿™é‡Œæ”¹ä¸ºfalse é‡å¯consumeræœåŠ¡ï¼Œé‡å¤ä¹‹å‰çš„æµ‹è¯•ã€‚å¯ä»¥å‘ç°ï¼š åœ¨é‡è¯•è¾¾åˆ°æœ€å¤§æ¬¡æ•°åï¼ŒSpringAMQPä¼šæŠ›å‡ºå¼‚å¸¸AmqpRejectAndDontRequeueExceptionï¼Œè¯´æ˜æœ¬åœ°é‡è¯•è§¦å‘äº† æŸ¥çœ‹RabbitMQæ§åˆ¶å°ï¼Œå‘ç°æ¶ˆæ¯è¢«åˆ é™¤äº†ï¼Œè¯´æ˜æœ€åSpringAMQPè¿”å›çš„æ˜¯ackï¼Œmqåˆ é™¤æ¶ˆæ¯äº† ç»“è®ºï¼š å¼€å¯æœ¬åœ°é‡è¯•æ—¶ï¼Œæ¶ˆæ¯å¤„ç†è¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œä¸ä¼šrequeueåˆ°é˜Ÿåˆ—ï¼Œè€Œæ˜¯åœ¨æ¶ˆè´¹è€…æœ¬åœ°é‡è¯• é‡è¯•è¾¾åˆ°æœ€å¤§æ¬¡æ•°åï¼ŒSpringä¼šè¿”å›ackï¼Œæ¶ˆæ¯ä¼šè¢«ä¸¢å¼ƒ 7.5.2 å¤±è´¥ç­–ç•¥åœ¨ä¹‹å‰çš„æµ‹è¯•ä¸­ï¼Œè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°åï¼Œæ¶ˆæ¯ä¼šè¢«ä¸¢å¼ƒï¼Œè¿™æ˜¯ç”±Springå†…éƒ¨æœºåˆ¶å†³å®šçš„ã€‚ åœ¨å¼€å¯é‡è¯•æ¨¡å¼åï¼Œé‡è¯•æ¬¡æ•°è€—å°½ï¼Œå¦‚æœæ¶ˆæ¯ä¾ç„¶å¤±è´¥ï¼Œåˆ™éœ€è¦æœ‰MessageRecoveryæ¥å£æ¥å¤„ç†ï¼Œå®ƒåŒ…å«ä¸‰ç§ä¸åŒçš„å®ç°ï¼š RejectAndDontRequeueRecovererï¼šé‡è¯•è€—å°½åï¼Œç›´æ¥rejectï¼Œä¸¢å¼ƒæ¶ˆæ¯ã€‚é»˜è®¤å°±æ˜¯è¿™ç§æ–¹å¼ ImmediateRequeueMessageRecovererï¼šé‡è¯•è€—å°½åï¼Œè¿”å›nackï¼Œæ¶ˆæ¯é‡æ–°å…¥é˜Ÿ RepublishMessageRecovererï¼šé‡è¯•è€—å°½åï¼Œå°†å¤±è´¥æ¶ˆæ¯æŠ•é€’åˆ°æŒ‡å®šçš„äº¤æ¢æœº æ¯”è¾ƒä¼˜é›…çš„ä¸€ç§å¤„ç†æ–¹æ¡ˆæ˜¯RepublishMessageRecovererï¼Œå¤±è´¥åå°†æ¶ˆæ¯æŠ•é€’åˆ°ä¸€ä¸ªæŒ‡å®šçš„ï¼Œä¸“é—¨å­˜æ”¾å¼‚å¸¸æ¶ˆæ¯çš„é˜Ÿåˆ—ï¼Œåç»­ç”±äººå·¥é›†ä¸­å¤„ç†ã€‚1ï¼‰åœ¨consumeræœåŠ¡ä¸­å®šä¹‰å¤„ç†å¤±è´¥æ¶ˆæ¯çš„äº¤æ¢æœºå’Œé˜Ÿåˆ— 123456789101112@Beanpublic DirectExchange errorMessageExchange()&#123; return new DirectExchange(&quot;error.direct&quot;);&#125;@Beanpublic Queue errorQueue()&#123; return new Queue(&quot;error.queue&quot;, true);&#125;@Beanpublic Binding errorBinding(Queue errorQueue, DirectExchange errorMessageExchange)&#123; return BindingBuilder.bind(errorQueue).to(errorMessageExchange).with(&quot;error&quot;);&#125; 2ï¼‰å®šä¹‰ä¸€ä¸ªRepublishMessageRecovererï¼Œå…³è”é˜Ÿåˆ—å’Œäº¤æ¢æœº 1234@Beanpublic MessageRecoverer republishMessageRecoverer(RabbitTemplate rabbitTemplate)&#123; return new RepublishMessageRecoverer(rabbitTemplate, &quot;error.direct&quot;, &quot;error&quot;);&#125; å®Œæ•´ä»£ç ï¼š 123456789101112131415161718192021222324252627282930313233package com.baidu.mq.config;import org.springframework.amqp.core.Binding;import org.springframework.amqp.core.BindingBuilder;import org.springframework.amqp.core.DirectExchange;import org.springframework.amqp.core.Queue;import org.springframework.amqp.rabbit.core.RabbitTemplate;import org.springframework.amqp.rabbit.retry.MessageRecoverer;import org.springframework.amqp.rabbit.retry.RepublishMessageRecoverer;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;@Configurationpublic class ErrorMessageConfig &#123; @Bean public DirectExchange errorMessageExchange()&#123; return new DirectExchange(&quot;error.direct&quot;); &#125; @Bean public Queue errorQueue()&#123; return new Queue(&quot;error.queue&quot;, true); &#125; @Bean public Binding errorBinding(Queue errorQueue, DirectExchange errorMessageExchange)&#123; return BindingBuilder.bind(errorQueue).to(errorMessageExchange).with(&quot;error&quot;); &#125; @Bean public MessageRecoverer republishMessageRecoverer(RabbitTemplate rabbitTemplate)&#123; return new RepublishMessageRecoverer(rabbitTemplate, &quot;error.direct&quot;, &quot;error&quot;); &#125;&#125; 7.6 å¦‚ä½•ç¡®ä¿rabbitmqæ¶ˆæ¯å¯é æ€§ å¼€å¯ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ï¼Œç¡®ä¿ç”Ÿäº§è€…çš„æ¶ˆæ¯èƒ½åˆ°è¾¾é˜Ÿåˆ— å¼€å¯æŒä¹…åŒ–åŠŸèƒ½ï¼Œç¡®ä¿æ¶ˆæ¯æœªæ¶ˆè´¹å‰åœ¨é˜Ÿåˆ—ä¸­ä¸ä¼šä¸¢å¤± å¼€å¯æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶ä¸ºautoï¼Œç”±springç¡®è®¤æ¶ˆæ¯å¤„ç†æˆåŠŸåå®Œæˆack å¼€å¯æ¶ˆè´¹è€…å¤±è´¥é‡è¯•æœºåˆ¶ï¼Œå¹¶è®¾ç½®MessageRecovererï¼Œå¤šæ¬¡é‡è¯•å¤±è´¥åå°†æ¶ˆæ¯æŠ•é€’åˆ°å¼‚å¸¸äº¤æ¢æœºï¼Œäº¤ç”±äººå·¥å¤„ç† 8.æ­»ä¿¡äº¤æ¢æœº8.1 ä»€ä¹ˆæ˜¯æ­»ä¿¡äº¤æ¢æœºä»€ä¹ˆæ˜¯æ­»ä¿¡ï¼Ÿ å½“ä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æ»¡è¶³ä¸‹åˆ—æƒ…å†µä¹‹ä¸€æ—¶ï¼Œå¯ä»¥æˆä¸ºæ­»ä¿¡ï¼ˆdead letterï¼‰ï¼š æ¶ˆè´¹è€…ä½¿ç”¨basic.rejectæˆ– basic.nackå£°æ˜æ¶ˆè´¹å¤±è´¥ï¼Œå¹¶ä¸”æ¶ˆæ¯çš„requeueå‚æ•°è®¾ç½®ä¸ºfalse æ¶ˆæ¯æ˜¯ä¸€ä¸ªè¿‡æœŸæ¶ˆæ¯ï¼Œè¶…æ—¶æ— äººæ¶ˆè´¹ è¦æŠ•é€’çš„é˜Ÿåˆ—æ¶ˆæ¯æ»¡äº†ï¼Œæ— æ³•æŠ•é€’ å¦‚æœè¿™ä¸ªåŒ…å«æ­»ä¿¡çš„é˜Ÿåˆ—é…ç½®äº†dead-letter-exchangeå±æ€§ï¼ŒæŒ‡å®šäº†ä¸€ä¸ªäº¤æ¢æœºï¼Œé‚£ä¹ˆä¹ˆæŠ•é€’åˆ°è¿™ä¸ªäº¤æ¢æœºä¸­ï¼Œè€Œè¿™ä¸ªäº¤æ¢æœºç§°ä¸ºæ­»ä¿¡äº¤æ¢æœºï¼ˆDead Letter Exchangeï¼Œæ£€æŸ¥DLXï¼‰ã€‚å¦‚å›¾ï¼Œä¸€ä¸ªæ¶ˆæ¯è¢«æ¶ˆè´¹è€…æ‹’ç»äº†ï¼Œå˜æˆäº†æ­»ä¿¡ï¼šå› ä¸ºsimple.queueç»‘å®šäº†æ­»ä¿¡äº¤æ¢æœº dl.directï¼Œå› æ­¤æ­»ä¿¡ä¼šæŠ•é€’ç»™è¿™ä¸ªäº¤æ¢æœºï¼šå¦‚æœè¿™ä¸ªæ­»ä¿¡äº¤æ¢æœºä¹Ÿç»‘å®šäº†ä¸€ä¸ªé˜Ÿåˆ—ï¼Œåˆ™æ¶ˆæ¯æœ€ç»ˆä¼šè¿›å…¥è¿™ä¸ªå­˜æ”¾æ­»ä¿¡çš„é˜Ÿåˆ—ï¼šå¦å¤–ï¼Œé˜Ÿåˆ—å°†æ­»ä¿¡æŠ•é€’ç»™æ­»ä¿¡äº¤æ¢æœºæ—¶ï¼Œå¿…é¡»çŸ¥é“ä¸¤ä¸ªä¿¡æ¯ï¼š æ­»ä¿¡äº¤æ¢æœºåç§° æ­»ä¿¡äº¤æ¢æœºä¸æ­»ä¿¡é˜Ÿåˆ—ç»‘å®šçš„RoutingKey è¿™æ ·æ‰èƒ½ç¡®ä¿æŠ•é€’çš„æ¶ˆæ¯èƒ½åˆ°è¾¾æ­»ä¿¡äº¤æ¢æœºï¼Œå¹¶ä¸”æ­£ç¡®çš„è·¯ç”±åˆ°æ­»ä¿¡é˜Ÿåˆ—ã€‚ 8.2 åˆ©ç”¨æ­»ä¿¡äº¤æ¢æœºæ¥æ”¶æ­»ä¿¡åœ¨å¤±è´¥é‡è¯•ç­–ç•¥ä¸­ï¼Œé»˜è®¤çš„RejectAndDontRequeueRecovererä¼šåœ¨æœ¬åœ°é‡è¯•æ¬¡æ•°è€—å°½åï¼Œå‘é€rejectç»™RabbitMQï¼Œæ¶ˆæ¯å˜æˆæ­»ä¿¡ï¼Œè¢«ä¸¢å¼ƒã€‚æˆ‘ä»¬å¯ä»¥ç»™simple.queueæ·»åŠ ä¸€ä¸ªæ­»ä¿¡äº¤æ¢æœºï¼Œç»™æ­»ä¿¡äº¤æ¢æœºç»‘å®šä¸€ä¸ªé˜Ÿåˆ—ã€‚è¿™æ ·æ¶ˆæ¯å˜æˆæ­»ä¿¡åä¹Ÿä¸ä¼šä¸¢å¼ƒï¼Œè€Œæ˜¯æœ€ç»ˆæŠ•é€’åˆ°æ­»ä¿¡äº¤æ¢æœºï¼Œè·¯ç”±åˆ°ä¸æ­»ä¿¡äº¤æ¢æœºç»‘å®šçš„é˜Ÿåˆ—ã€‚ æ€»ç»“ï¼šä»€ä¹ˆæ ·çš„æ¶ˆæ¯ä¼šæˆä¸ºæ­»ä¿¡ï¼Ÿ æ¶ˆæ¯è¢«æ¶ˆè´¹è€…rejectæˆ–è€…è¿”å›nack æ¶ˆæ¯è¶…æ—¶æœªæ¶ˆè´¹ é˜Ÿåˆ—æ»¡äº† æ­»ä¿¡äº¤æ¢æœºçš„ä½¿ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ å¦‚æœé˜Ÿåˆ—ç»‘å®šäº†æ­»ä¿¡äº¤æ¢æœºï¼Œæ­»ä¿¡ä¼šæŠ•é€’åˆ°æ­»ä¿¡äº¤æ¢æœºï¼› å¯ä»¥åˆ©ç”¨æ­»ä¿¡äº¤æ¢æœºæ”¶é›†æ‰€æœ‰æ¶ˆè´¹è€…å¤„ç†å¤±è´¥çš„æ¶ˆæ¯ï¼ˆæ­»ä¿¡ï¼‰ï¼Œäº¤ç”±äººå·¥å¤„ç†ï¼Œè¿›ä¸€æ­¥æé«˜æ¶ˆæ¯é˜Ÿåˆ—çš„å¯é æ€§ã€‚ 8.3 TTLä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å¦‚æœè¶…æ—¶æœªæ¶ˆè´¹ï¼Œåˆ™ä¼šå˜ä¸ºæ­»ä¿¡ï¼Œè¶…æ—¶åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š æ¶ˆæ¯æ‰€åœ¨çš„é˜Ÿåˆ—è®¾ç½®äº†è¶…æ—¶æ—¶é—´ æ¶ˆæ¯æœ¬èº«è®¾ç½®äº†è¶…æ—¶æ—¶é—´ æ¥æ”¶è¶…æ—¶æ­»ä¿¡çš„æ­»ä¿¡äº¤æ¢æœºï¼šåœ¨consumeræœåŠ¡çš„SpringRabbitListenerä¸­ï¼Œå®šä¹‰ä¸€ä¸ªæ–°çš„æ¶ˆè´¹è€…ï¼Œå¹¶ä¸”å£°æ˜ æ­»ä¿¡äº¤æ¢æœºã€æ­»ä¿¡é˜Ÿåˆ—ï¼š 12345678@RabbitListener(bindings = @QueueBinding( value = @Queue(name = &quot;dl.ttl.queue&quot;, durable = &quot;true&quot;), exchange = @Exchange(name = &quot;dl.ttl.direct&quot;), key = &quot;ttl&quot;))public void listenDlQueue(String msg)&#123; log.info(&quot;æ¥æ”¶åˆ° dl.ttl.queueçš„å»¶è¿Ÿæ¶ˆæ¯ï¼š&#123;&#125;&quot;, msg);&#125; å£°æ˜ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå¹¶ä¸”æŒ‡å®šTTLè¦ç»™é˜Ÿåˆ—è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œéœ€è¦åœ¨å£°æ˜é˜Ÿåˆ—æ—¶é…ç½®x-message-ttlå±æ€§ï¼š 1234567@Beanpublic Queue ttlQueue()&#123; return QueueBuilder.durable(&quot;ttl.queue&quot;) // æŒ‡å®šé˜Ÿåˆ—åç§°ï¼Œå¹¶æŒä¹…åŒ– .ttl(10000) // è®¾ç½®é˜Ÿåˆ—çš„è¶…æ—¶æ—¶é—´ï¼Œ10ç§’ .deadLetterExchange(&quot;dl.ttl.direct&quot;) // æŒ‡å®šæ­»ä¿¡äº¤æ¢æœº .build();&#125; æ³¨æ„ï¼Œè¿™ä¸ªé˜Ÿåˆ—è®¾å®šäº†æ­»ä¿¡äº¤æ¢æœºä¸ºdl.ttl.direct å£°æ˜äº¤æ¢æœºï¼Œå°†ttlä¸äº¤æ¢æœºç»‘å®šï¼š 12345678@Beanpublic DirectExchange ttlExchange()&#123; return new DirectExchange(&quot;ttl.direct&quot;);&#125;@Beanpublic Binding ttlBinding()&#123; return BindingBuilder.bind(ttlQueue()).to(ttlExchange()).with(&quot;ttl&quot;);&#125; å‘é€æ¶ˆæ¯ï¼Œä½†æ˜¯ä¸è¦æŒ‡å®šTTLï¼š 12345678910@Testpublic void testTTLQueue() &#123; // åˆ›å»ºæ¶ˆæ¯ String message = &quot;hello, ttl queue&quot;; // æ¶ˆæ¯IDï¼Œéœ€è¦å°è£…åˆ°CorrelationDataä¸­ CorrelationData correlationData = new CorrelationData(UUID.randomUUID().toString()); // å‘é€æ¶ˆæ¯ rabbitTemplate.convertAndSend(&quot;ttl.direct&quot;, &quot;ttl&quot;, message, correlationData); // è®°å½•æ—¥å¿— è‡³æ­¤ï¼Œå¯ä»¥æ‰§è¡Œä»£ç è¿›è¡Œæµ‹è¯•ï¼Œæµ‹è¯•å¯ä»¥å‘ç°å› ä¸ºé˜Ÿåˆ—çš„TTLå€¼æ˜¯10000msï¼Œä¹Ÿå°±æ˜¯10ç§’ã€‚å¯ä»¥çœ‹åˆ°æ¶ˆæ¯å‘é€ä¸æ¥æ”¶ä¹‹é—´çš„æ—¶å·®åˆšå¥½æ˜¯10ç§’ã€‚ å‘é€æ¶ˆæ¯æ—¶ï¼Œè®¾å®šTTLåœ¨å‘é€æ¶ˆæ¯æ—¶ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šTTLï¼š 12345678910111213@Testpublic void testTTLMsg() &#123; // åˆ›å»ºæ¶ˆæ¯ Message message = MessageBuilder .withBody(&quot;hello, ttl message&quot;.getBytes(StandardCharsets.UTF_8)) .setExpiration(&quot;5000&quot;) .build(); // æ¶ˆæ¯IDï¼Œéœ€è¦å°è£…åˆ°CorrelationDataä¸­ CorrelationData correlationData = new CorrelationData(UUID.randomUUID().toString()); // å‘é€æ¶ˆæ¯ rabbitTemplate.convertAndSend(&quot;ttl.direct&quot;, &quot;ttl&quot;, message, correlationData); log.debug(&quot;å‘é€æ¶ˆæ¯æˆåŠŸ&quot;);&#125; æ‰§è¡Œæµ‹è¯•è¿™æ¬¡ï¼Œå‘é€ä¸æ¥æ”¶çš„å»¶è¿Ÿåªæœ‰5ç§’ã€‚è¯´æ˜å½“é˜Ÿåˆ—ã€æ¶ˆæ¯éƒ½è®¾ç½®äº†TTLæ—¶ï¼Œä»»æ„ä¸€ä¸ªåˆ°æœŸå°±ä¼šæˆä¸ºæ­»ä¿¡ã€‚ æ€»ç»“ï¼šæ¶ˆæ¯è¶…æ—¶çš„ä¸¤ç§æ–¹å¼æ˜¯ï¼Ÿ ç»™é˜Ÿåˆ—è®¾ç½®ttlå±æ€§ï¼Œè¿›å…¥é˜Ÿåˆ—åè¶…è¿‡ttlæ—¶é—´çš„æ¶ˆæ¯å˜ä¸ºæ­»ä¿¡ ç»™æ¶ˆæ¯è®¾ç½®ttlå±æ€§ï¼Œé˜Ÿåˆ—æ¥æ”¶åˆ°æ¶ˆæ¯è¶…è¿‡ttlæ—¶é—´åå˜ä¸ºæ­»ä¿¡ å¦‚ä½•å®ç°å‘é€ä¸€ä¸ªæ¶ˆæ¯20ç§’åæ¶ˆè´¹è€…æ‰æ”¶åˆ°æ¶ˆæ¯ï¼Ÿ ç»™æ¶ˆæ¯çš„ç›®æ ‡é˜Ÿåˆ—æŒ‡å®šæ­»ä¿¡äº¤æ¢æœº å°†æ¶ˆè´¹è€…ç›‘å¬çš„é˜Ÿåˆ—ç»‘å®šåˆ°æ­»ä¿¡äº¤æ¢æœº å‘é€æ¶ˆæ¯æ—¶ç»™æ¶ˆæ¯è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º20ç§’ 8.4 å»¶è¿Ÿé˜Ÿåˆ—åˆ©ç”¨TTLç»“åˆæ­»ä¿¡äº¤æ¢æœºï¼Œæˆ‘ä»¬å®ç°äº†æ¶ˆæ¯å‘å‡ºåï¼Œæ¶ˆè´¹è€…å»¶è¿Ÿæ”¶åˆ°æ¶ˆæ¯çš„æ•ˆæœã€‚è¿™ç§æ¶ˆæ¯æ¨¡å¼å°±ç§°ä¸ºå»¶è¿Ÿé˜Ÿåˆ—ï¼ˆDelay Queueï¼‰æ¨¡å¼ã€‚ å»¶è¿Ÿé˜Ÿåˆ—çš„ä½¿ç”¨åœºæ™¯åŒ…æ‹¬ï¼š å»¶è¿Ÿå‘é€çŸ­ä¿¡ ç”¨æˆ·ä¸‹å•ï¼Œå¦‚æœç”¨æˆ·åœ¨15 åˆ†é’Ÿå†…æœªæ”¯ä»˜ï¼Œåˆ™è‡ªåŠ¨å–æ¶ˆ é¢„çº¦å·¥ä½œä¼šè®®ï¼Œ20åˆ†é’Ÿåè‡ªåŠ¨é€šçŸ¥æ‰€æœ‰å‚ä¼šäººå‘˜","categories":[],"tags":[]},{"title":"","slug":"linuxæœåŠ¡å™¨","date":"2025-05-21T03:23:59.306Z","updated":"2022-06-12T15:25:44.795Z","comments":true,"path":"2025/05/21/linuxæœåŠ¡å™¨/","link":"","permalink":"https://dddwah11.github.io/2025/05/21/linux%E6%9C%8D%E5%8A%A1%E5%99%A8/","excerpt":"","text":"åå°å¯åŠ¨java 1nohup java -jar xxx.jar å…³é—­ 1kill -9 è¿›ç¨‹å· æŸ¥çœ‹è¿›ç¨‹å· 1ps -ef | grep java å®‰è£…nginxæ·»åŠ ç›¸å…³ä¾èµ–å’Œåº“ 12yum -y install gcc-c++ zlib-devel openssl-devel libtool ä¸‹è½½nginxå®‰è£…åŒ…å¹¶è§£å‹ é…ç½®å’Œå®‰è£… 12cd nginx-1.22.0/ 12./configure --prefix=/usr/local/nginxmake &amp;&amp; make install å¯åŠ¨nginx 12cd ../nginx/sbin./nginx æŸ¥çœ‹nginx 1ps -ef | grep nginx åœæ­¢å’Œé‡å¯ å»nginx&#x2F;sbinç›®å½• 12./nginx -s reload #é‡å¯./nginx -s stop #å…³é—­ vue dist nginxé…ç½® 123456location / &#123; root /home/server/dist; index index.html index.htm; try_files $uri $uri/ /index.html; &#125; æ“ä½œå®Œå esc-&gt;:wqä¿å­˜é‡å¯ nginxæ·»åŠ å¯¹icoçš„æ”¯æŒï¼š1234567891011location / &#123; root xxx; index index.html index.htm; rewrite ^/(.*)/(.*\\.js$) /$1/$2 break; rewrite ^/(.*)/(.*\\.map$) /$1/$2 break; rewrite ^/(.*)/(.*\\.css$) /$1/$2 break; rewrite ^/(.*)/(.*\\.(png|jpg|gif|ico)$) /$1/$2 break; rewrite ^/(.*)/(.*\\.(ttf|woff|woff2|svg|otf|eot)$) /$1/$2 break; rewrite ^/(.*)/ /$1/index.html break; # try_files $uri $uri/ /index.html;&#125; ç»™distæƒé™ 1chmod 777 * å®‰è£…è¯ä¹¦","categories":[],"tags":[]},{"title":"","slug":"Web","date":"2025-05-20T16:25:06.368Z","updated":"2023-04-07T03:39:44.000Z","comments":true,"path":"2025/05/21/Web/","link":"","permalink":"https://dddwah11.github.io/2025/05/21/Web/","excerpt":"","text":"HTMLHTMLå…¥é—¨æ¦‚è¿°HTMLï¼ˆè¶…æ–‡æœ¬æ ‡è®°è¯­è¨€â€”HyperText Markup Languageï¼‰æ˜¯æ„æˆ Web ä¸–ç•Œçš„åŸºç¡€ï¼Œæ˜¯ä¸€ç§ç”¨æ¥å‘ŠçŸ¥æµè§ˆå™¨å¦‚ä½•ç»„ç»‡é¡µé¢çš„æ ‡è®°è¯­è¨€ è¶…æ–‡æœ¬ Hypertextï¼Œæ˜¯æŒ‡è¿æ¥å•ä¸ªæˆ–è€…å¤šä¸ªç½‘ç«™é—´çš„ç½‘é¡µçš„é“¾æ¥ã€‚é€šè¿‡é“¾æ¥ï¼Œå°±èƒ½è®¿é—®äº’è”ç½‘ä¸­çš„å†…å®¹ æ ‡è®° Markup ï¼Œæ˜¯ç”¨æ¥æ³¨æ˜æ–‡æœ¬ï¼Œå›¾ç‰‡ç­‰å†…å®¹ï¼Œä»¥ä¾¿äºåœ¨æµè§ˆå™¨ä¸­æ˜¾ç¤ºï¼Œä¾‹å¦‚ &lt;head&gt;ï¼Œ&lt;body&gt; ç­‰ ç½‘é¡µçš„æ„æˆ HTMLï¼šé€šå¸¸ç”¨æ¥å®šä¹‰ç½‘é¡µå†…å®¹çš„å«ä¹‰å’ŒåŸºæœ¬ç»“æ„ CSSï¼šé€šå¸¸ç”¨æ¥æè¿°ç½‘é¡µçš„è¡¨ç°ä¸å±•ç¤ºæ•ˆæœ JavaScriptï¼šé€šå¸¸ç”¨æ¥æ‰§è¡Œç½‘é¡µçš„åŠŸèƒ½ä¸è¡Œä¸º å‚è€ƒè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV1Qf4y1T7Hx ç»„æˆæ ‡ç­¾HTML é¡µé¢ç”±ä¸€ç³»åˆ—çš„å…ƒç´ ï¼ˆelementsï¼‰ ç»„æˆï¼Œè€Œå…ƒç´ æ˜¯ä½¿ç”¨æ ‡ç­¾åˆ›å»ºçš„ ä¸€å¯¹æ ‡ç­¾ï¼ˆtagsï¼‰å¯ä»¥è®¾ç½®ä¸€æ®µæ–‡å­—æ ·å¼ï¼Œæ·»åŠ ä¸€å¼ å›¾ç‰‡æˆ–è€…æ·»åŠ è¶…é“¾æ¥ç­‰ç­‰ åœ¨ HTML ä¸­ï¼Œ&lt;h1&gt; æ ‡ç­¾è¡¨ç¤ºæ ‡é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¼€å§‹æ ‡ç­¾å’Œç»“æŸæ ‡ç­¾åŒ…å›´æ–‡æœ¬å†…å®¹ï¼Œè¿™æ ·å…¶ä¸­çš„å†…å®¹å°±ä»¥æ ‡é¢˜çš„å½¢å¼æ˜¾ç¤º 12&lt;h1&gt;å¼€å§‹å­¦ä¹ JavaWeb&lt;/h1&gt;&lt;h2&gt;äºŒçº§æ ‡é¢˜&lt;/h2&gt; å±æ€§HTML æ ‡ç­¾å¯ä»¥æ‹¥æœ‰å±æ€§ å±æ€§æ˜¯å±äºæ ‡ç­¾çš„ï¼Œä¿®é¥°æ ‡ç­¾ï¼Œè®©æ ‡ç­¾æœ‰æ›´å¤šçš„æ•ˆæœ å±æ€§ä¸€èˆ¬å®šä¹‰åœ¨èµ·å§‹æ ‡ç­¾é‡Œé¢ å±æ€§ä¸€èˆ¬ä»¥å±æ€§&#x3D;å±æ€§å€¼çš„å½¢å¼å‡ºç° å±æ€§å€¼ä¸€èˆ¬ç”¨ &#39;&#39; æˆ–è€… &quot;&quot; æ‹¬èµ·æ¥ã€‚ ä¸åŠ å¼•å·ä¹Ÿæ˜¯å¯ä»¥çš„(ä¸å»ºè®®ä½¿ç”¨)ã€‚æ¯”å¦‚ï¼šname&#x3D;â€™valueâ€™ 1&lt;h1 align=&quot;center&quot;&gt;å¼€å§‹å­¦ä¹ JavaWeb&lt;/h1&gt; åœ¨ HTML æ ‡ç­¾ä¸­ï¼Œalign å±æ€§è¡¨ç¤ºæ°´å¹³å¯¹é½æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥èµ‹å€¼ä¸º center è¡¨ç¤º å±…ä¸­ ã€‚ ç»“æ„ æ–‡æ¡£ç»“æ„ä»‹ç»ï¼š æ–‡æ¡£å£°æ˜ï¼šç”¨äºå£°æ˜å½“å‰ HTML çš„ç‰ˆæœ¬ï¼Œè¿™é‡Œçš„&lt;!DOCTYPE html&gt;æ˜¯ HTML5 çš„å£°æ˜ html æ ¹æ ‡ç­¾ï¼šé™¤æ–‡æ¡£å£°æ˜ä»¥å¤–ï¼Œå…¶å®ƒå†…å®¹å…¨éƒ¨è¦æ”¾åœ¨æ ¹æ ‡ç­¾ html å†…éƒ¨ æ–‡æ¡£å¤´éƒ¨é…ç½®ï¼šhead æ ‡ç­¾ï¼Œæ˜¯å½“å‰é¡µé¢çš„é…ç½®ä¿¡æ¯ï¼Œå¤–éƒ¨å¼•å…¥æ–‡ä»¶, ä¾‹å¦‚ç½‘é¡µæ ‡ç­¾ã€å­—ç¬¦é›†ç­‰ &lt;meta charset=&quot;utf-8&quot;&gt;ï¼šè¿™ä¸ªæ ‡ç­¾æ˜¯é¡µé¢çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œè®¾ç½®æ–‡æ¡£ä½¿ç”¨ utf-8 å­—ç¬¦é›†ç¼–ç  &lt;title&gt;ï¼šè¿™ä¸ªæ ‡ç­¾å®šä¹‰æ–‡æ¡£æ ‡é¢˜ï¼Œä½ç½®å‡ºç°åœ¨æµè§ˆå™¨æ ‡ç­¾ã€‚åœ¨æ”¶è—é¡µé¢æ—¶ï¼Œå®ƒå¯ç”¨æ¥æè¿°é¡µé¢ æ–‡æ¡£æ˜¾ç¤ºå†…å®¹ï¼šbody æ ‡ç­¾ï¼Œé‡Œè¾¹çš„å†…å®¹ä¼šæ˜¾ç¤ºåˆ°æµè§ˆå™¨é¡µé¢ä¸Š HTMLè¯­æ³•æ³¨é‡Šæ–¹å¼å°†ä¸€æ®µ HTML ä¸­çš„å†…å®¹ç½®ä¸ºæ³¨é‡Šï¼Œä½ éœ€è¦å°†å…¶ç”¨ç‰¹æ®Šçš„è®°å· åŒ…æ‹¬èµ·æ¥ 123&lt;p&gt;æˆ‘åœ¨æ³¨é‡Šå¤–ï¼&lt;/p&gt;&lt;!-- &lt;p&gt;æˆ‘åœ¨æ³¨é‡Šå†…ï¼&lt;/p&gt; --&gt; åŸºæœ¬å…ƒç´ ç©ºå…ƒç´ ä¸€äº›å…ƒç´ åªæœ‰ä¸€ä¸ªæ ‡ç­¾ï¼Œå«åšç©ºå…ƒç´ ã€‚å®ƒæ˜¯åœ¨å¼€å§‹æ ‡ç­¾ä¸­è¿›è¡Œå…³é—­çš„ã€‚ 12ç¬¬ä¸€è¡Œæ–‡æ¡£&lt;br/&gt; ç¬¬äºŒè¡Œæ–‡æ¡£&lt;br/&gt; åµŒå¥—å…ƒç´ æŠŠå…ƒç´ æ”¾åˆ°å…¶å®ƒå…ƒç´ ä¹‹ä¸­â€”â€”è¿™è¢«ç§°ä½œåµŒå¥—ã€‚ 1&lt;h2&gt;&lt;u&gt;äºŒçº§æ ‡é¢˜&lt;/u&gt;&lt;/h2&gt; å—å…ƒç´ åœ¨HTMLä¸­æœ‰ä¸¤ç§é‡è¦å…ƒç´ ç±»åˆ«ï¼Œå—çº§å…ƒç´ å’Œå†…è”å…ƒç´  å—çº§å…ƒç´ ï¼š ç‹¬å ä¸€è¡Œã€‚å—çº§å…ƒç´ ï¼ˆblockï¼‰åœ¨é¡µé¢ä¸­ä»¥å—çš„å½¢å¼å±•ç°ã€‚ç›¸å¯¹äºå…¶å‰é¢çš„å†…å®¹å®ƒä¼šå‡ºç°åœ¨æ–°çš„ä¸€è¡Œï¼Œå…¶åçš„å†…å®¹ä¹Ÿä¼šè¢«æŒ¤åˆ°ä¸‹ä¸€è¡Œå±•ç°ã€‚æ¯”å¦‚&lt;p&gt; ï¼Œ&lt;hr&gt;ï¼Œ&lt;li&gt; ï¼Œ&lt;div&gt;ç­‰ã€‚ è¡Œå†…å…ƒç´  è¡Œå†…æ˜¾ç¤ºã€‚è¡Œå†…å…ƒç´ ä¸ä¼šå¯¼è‡´æ¢è¡Œã€‚é€šå¸¸å‡ºç°åœ¨å—çº§å…ƒç´ ä¸­å¹¶ç¯ç»•æ–‡æ¡£å†…å®¹çš„ä¸€å°éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯ä¸€æ•´ä¸ªæ®µè½æˆ–è€…ä¸€ç»„å†…å®¹ã€‚æ¯”å¦‚&lt;b&gt;ï¼Œ&lt;a&gt;ï¼Œ&lt;i&gt;ï¼Œ&lt;span&gt; ç­‰ã€‚ æ³¨æ„ï¼šä¸€ä¸ªå—çº§å…ƒç´ ä¸ä¼šè¢«åµŒå¥—è¿›è¡Œå†…å…ƒç´ ä¸­ï¼Œä½†å¯ä»¥åµŒå¥—åœ¨å…¶å®ƒå—çº§å…ƒç´ ä¸­ã€‚ å¸¸ç”¨çš„ä¸¤ä¸ªæ ‡ç­¾ï¼šï¼ˆé‡è¦ï¼‰ &lt;div&gt; æ˜¯ä¸€ä¸ªé€šç”¨çš„å†…å®¹å®¹å™¨ï¼Œå¹¶æ²¡æœ‰ä»»ä½•ç‰¹æ®Šè¯­ä¹‰ã€‚å®ƒå¯ä»¥è¢«ç”¨æ¥å¯¹å…¶å®ƒå…ƒç´ è¿›è¡Œåˆ†ç»„ï¼Œä¸€èˆ¬ç”¨äºæ ·å¼åŒ–ç›¸å…³çš„éœ€æ±‚ã€‚å®ƒæ˜¯ä¸€ä¸ªå—çº§å…ƒç´ ã€‚ å±æ€§ï¼šidã€styleã€class &lt;span&gt; æ˜¯çŸ­è¯­å†…å®¹çš„é€šç”¨è¡Œå†…å®¹å™¨ï¼Œå¹¶æ²¡æœ‰ä»»ä½•ç‰¹æ®Šè¯­ä¹‰ã€‚å®ƒå¯ä»¥è¢«ç”¨æ¥ç¼–ç»„å…ƒç´ ä»¥è¾¾åˆ°æŸç§æ ·å¼ã€‚å®ƒæ˜¯ä¸€ä¸ªè¡Œå†…å…ƒç´  åŸºæœ¬å±æ€§æ ‡ç­¾å±æ€§ï¼Œä¸»è¦ç”¨äºæ‹“å±•æ ‡ç­¾ã€‚å±æ€§åŒ…å«å…ƒç´ çš„é¢å¤–ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯ä¸ä¼šå‡ºç°åœ¨å®é™…çš„å†…å®¹ä¸­ã€‚ä½†æ˜¯å¯ä»¥æ”¹å˜æ ‡ç­¾çš„ä¸€äº›è¡Œä¸ºæˆ–è€…æä¾›æ•°æ®ï¼Œå±æ€§æ€»æ˜¯ä»¥name = value&quot;çš„æ ¼å¼å±•ç°ã€‚ å±æ€§åï¼šåŒä¸€ä¸ªæ ‡ç­¾ä¸­ï¼Œå±æ€§åä¸å¾—é‡å¤ã€‚ å¤§å°å†™ï¼šå±æ€§å’Œå±æ€§å€¼å¯¹å¤§å°å†™ä¸æ•æ„Ÿã€‚ä¸è¿‡W3Cæ ‡å‡†ä¸­ï¼Œæ¨èä½¿ç”¨å°å†™çš„å±æ€§&#x2F;å±æ€§å€¼ã€‚ å¼•å·ï¼šåŒå¼•å·æ˜¯æœ€å¸¸ç”¨çš„ï¼Œä¸è¿‡ä½¿ç”¨å•å¼•å·ä¹Ÿæ²¡æœ‰é—®é¢˜ã€‚ å¸¸ç”¨å±æ€§ï¼š å±æ€§å ä½œç”¨ class å®šä¹‰å…ƒç´ ç±»åï¼Œç”¨æ¥é€‰æ‹©å’Œè®¿é—®ç‰¹å®šçš„å…ƒç´  id å®šä¹‰å…ƒç´ å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œåœ¨æ•´ä¸ªæ–‡æ¡£ä¸­å¿…é¡»æ˜¯å”¯ä¸€çš„ name å®šä¹‰å…ƒç´ åç§°ï¼Œå¯ä»¥ç”¨äºæäº¤æœåŠ¡å™¨çš„è¡¨å•å­—æ®µ value å®šä¹‰åœ¨å…ƒç´ å†…æ˜¾ç¤ºçš„é»˜è®¤å€¼ style å®šä¹‰CSSæ ·å¼ï¼Œè¿™äº›æ ·å¼ä¼šè¦†ç›–ä¹‹å‰è®¾ç½®çš„æ ·å¼ ç‰¹æ®Šå­—ç¬¦åœ¨HTMLä¸­ï¼Œå­—ç¬¦ &lt;, &gt;,&quot;,&#39; å’Œ &amp; æ˜¯ç‰¹æ®Šå­—ç¬¦ åŸä¹‰å­—ç¬¦ ç­‰ä»·å­—ç¬¦å¼•ç”¨ &lt; &amp;lt; &gt; &amp;gt; â€œ &amp;quot; â€˜ &amp;apos; &amp; &amp;amp; ç©ºæ ¼ &amp;nbsp; æ–‡æœ¬æ ‡ç­¾ä½¿ç”¨æ–‡æœ¬å†…å®¹æ ‡ç­¾è®¾ç½®æ–‡å­—åŸºæœ¬æ ·å¼ æ ‡ç­¾å ä½œç”¨ p è¡¨ç¤ºæ–‡æœ¬çš„ä¸€ä¸ªæ®µè½ h è¡¨ç¤ºæ–‡æ¡£æ ‡é¢˜ï¼Œ&lt;h1&gt;â€“&lt;h6&gt; ï¼Œå‘ˆç°äº†å…­ä¸ªä¸åŒçš„çº§åˆ«çš„æ ‡é¢˜ï¼Œ&lt;h1&gt; çº§åˆ«æœ€é«˜ï¼Œè€Œ &lt;h6&gt; çº§åˆ«æœ€ä½ hr è¡¨ç¤ºæ®µè½çº§å…ƒç´ ä¹‹é—´çš„ä¸»é¢˜è½¬æ¢ï¼Œä¸€èˆ¬æ˜¾ç¤ºä¸ºæ°´å¹³çº¿ li è¡¨ç¤ºåˆ—è¡¨é‡Œçš„æ¡ç›®ã€‚ï¼ˆå¸¸ç”¨åœ¨ul ol ä¸­ï¼‰ ul è¡¨ç¤ºä¸€ä¸ªæ— åºåˆ—è¡¨ï¼Œå¯å«å¤šä¸ªå…ƒç´ ï¼Œæ— ç¼–å·æ˜¾ç¤ºã€‚ ol è¡¨ç¤ºä¸€ä¸ªæœ‰åºåˆ—è¡¨ï¼Œé€šå¸¸æ¸²æŸ“ä¸ºæœ‰å¸¦ç¼–å·çš„åˆ—è¡¨ em è¡¨ç¤ºæ–‡æœ¬ç€é‡ï¼Œä¸€èˆ¬ç”¨æ–œä½“æ˜¾ç¤º strong è¡¨ç¤ºæ–‡æœ¬é‡è¦ï¼Œä¸€èˆ¬ç”¨ç²—ä½“æ˜¾ç¤º font è¡¨ç¤ºå­—ä½“ï¼Œå¯ä»¥è®¾ç½®æ ·å¼ï¼ˆå·²è¿‡æ—¶ï¼‰ i è¡¨ç¤ºæ–œä½“ b è¡¨ç¤ºåŠ ç²—æ–‡æœ¬ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;æ–‡æœ¬æ ‡ç­¾æ¼”ç¤º&lt;/title&gt;&lt;/head&gt;&lt;body&gt; &lt;!--æ®µè½æ ‡ç­¾ï¼š&lt;p&gt;--&gt; &lt;p&gt;è¿™äº›å¹´&lt;/p&gt; &lt;p&gt;æ”¯ä»˜å®çš„è¯ç”Ÿå°±æ˜¯ä¸ºäº†è§£å†³æ·˜å®ç½‘çš„å®¢æˆ·ä»¬çš„ä¹°å–é—®é¢˜&lt;/p&gt; &lt;!-- æ ‡é¢˜æ ‡ç­¾ï¼š&lt;h1&gt; ~ &lt;h6&gt; --&gt; &lt;h1&gt;ä¸€çº§æ ‡é¢˜&lt;/h1&gt; &lt;h2&gt;äºŒçº§æ ‡é¢˜&lt;/h2&gt; &lt;h3&gt;ä¸‰çº§æ ‡é¢˜&lt;/h3&gt; &lt;h4&gt;å››çº§æ ‡é¢˜&lt;/h4&gt; &lt;h5&gt;äº”çº§æ ‡é¢˜&lt;/h5&gt; &lt;h6&gt;å…­çº§æ ‡é¢˜&lt;/h6&gt; &lt;!--æ°´å¹³çº¿æ ‡ç­¾ï¼š&lt;hr/&gt; å±æ€§ï¼š size-å¤§å° color-é¢œè‰² --&gt; &lt;hr size=&quot;4&quot; color=&quot;red&quot;/&gt; &lt;!-- æ— åºåˆ—è¡¨ï¼š&lt;ul&gt; å±æ€§ï¼štype-åˆ—è¡¨æ ·å¼(discå®å¿ƒåœ†ã€circleç©ºå¿ƒåœ†ã€squareå®å¿ƒæ–¹å—) åˆ—è¡¨é¡¹ï¼š&lt;li&gt; --&gt; &lt;ul type=&quot;circle&quot;&gt; &lt;li&gt;javaEE&lt;/li&gt; &lt;li&gt;HTML&lt;/li&gt; &lt;/ul&gt; &lt;!-- æœ‰åºåˆ—è¡¨ï¼š&lt;ol&gt; å±æ€§ï¼štype-åˆ—è¡¨æ ·å¼(1æ•°å­—ã€Aæˆ–aå­—æ¯ã€Iæˆ–iç½—é©¬å­—ç¬¦) start-èµ·å§‹ä½ç½® åˆ—è¡¨é¡¹ï¼š&lt;li&gt; --&gt; &lt;ol type=&quot;1&quot; start=&quot;10&quot;&gt; &lt;li&gt;ä¼ æ™ºæ’­å®¢&lt;/li&gt; &lt;li&gt;é»‘é©¬ç¨‹åºå‘˜&lt;/li&gt; &lt;/ol&gt; &lt;!-- æ–œä½“æ ‡ç­¾ï¼š&lt;i&gt; &lt;em&gt; --&gt; &lt;i&gt;æˆ‘å€¾æ–œäº†&lt;/i&gt; &lt;em&gt;æˆ‘å€¾æ–œäº†&lt;/em&gt; &lt;br/&gt; &lt;!-- åŠ ç²—æ ‡ç­¾ï¼š&lt;strong&gt; &lt;b&gt; --&gt; &lt;strong&gt;åŠ ç²—æ–‡æœ¬&lt;/strong&gt; &lt;b&gt;åŠ ç²—æ–‡æœ¬&lt;/b&gt; &lt;br/&gt; &lt;!-- æ–‡å­—æ ‡ç­¾ï¼š&lt;font&gt; å±æ€§ï¼š size-å¤§å° color-é¢œè‰² --&gt; &lt;font size=&quot;5&quot; color=&quot;yellow&quot;&gt;è¿™æ˜¯ä¸€æ®µæ–‡å­—&lt;/font&gt;&lt;/body&gt;&lt;/html&gt; æ•ˆæœå¦‚ä¸‹ï¼š å›¾ç‰‡æ ‡ç­¾imgæ ‡ç­¾ä¸­çš„imgå…¶å®æ˜¯è‹±æ–‡imageçš„ç¼©å†™, imgæ ‡ç­¾çš„ä½œç”¨, å°±æ˜¯å‘Šè¯‰æµè§ˆå™¨æˆ‘ä»¬éœ€è¦æ˜¾ç¤ºä¸€å¼ å›¾ç‰‡ 1&lt;img src=&quot;../img/b.jpg&quot; width=&quot;400px&quot; height=&quot;200px&quot; alt=&quot;&quot; title=&quot;&quot;/&gt; å±æ€§å ä½œç”¨ src å›¾ç‰‡è·¯å¾„ title é¼ æ ‡æ‚¬åœï¼ˆhoverï¼‰æ—¶æ˜¾ç¤ºæ–‡æœ¬ã€‚ alt å›¾ç‰‡æè¿°ï¼Œå›¾å½¢ä¸æ˜¾ç¤ºæ—¶çš„æ›¿æ¢æ–‡æœ¬ã€‚ height å›¾åƒçš„é«˜åº¦ã€‚ width å›¾åƒçš„å®½åº¦ã€‚ è¶…é“¾æ¥è¶…é“¾æ¥æ ‡ç­¾çš„ä½œç”¨: å°±æ˜¯ç”¨äºæ§åˆ¶é¡µé¢ä¸é¡µé¢(æœåŠ¡å™¨èµ„æº)ä¹‹é—´è·³è½¬çš„ 1234&lt;a href=&quot;æŒ‡å®šéœ€è¦è·³è½¬çš„ç›®æ ‡è·¯å¾„&quot; target=&quot;æ‰“å¼€çš„æ–¹å¼&quot;&gt;éœ€è¦å±•ç°ç»™ç”¨æˆ·çš„å†…å®¹&lt;/a&gt;targetå±æ€§å–å€¼: _blankï¼šæ–°èµ·é¡µé¢ _selfï¼šå½“å‰é¡µé¢ï¼ˆé»˜è®¤ï¼‰ 1234567891011121314151617181920212223242526272829303132&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;è¶…é“¾æ¥æ ‡ç­¾æ¼”ç¤º&lt;/title&gt; &lt;style&gt; a&#123; /*å»æ‰è¶…é“¾æ¥çš„ä¸‹åˆ’çº¿*/ text-decoration: none; /*è¶…é“¾æ¥çš„é¢œè‰²*/ color: black; &#125; /*é¼ æ ‡æ‚¬æµ®çš„æ ·å¼æ§åˆ¶*/ a:hover&#123; color: red; &#125; &lt;/style&gt;&lt;/head&gt;&lt;body&gt; &lt;!-- è¶…é“¾æ¥æ ‡ç­¾ï¼š&lt;a&gt; å±æ€§ï¼š href-è·³è½¬çš„åœ°å€ target-è·³è½¬çš„æ–¹å¼(_selfå½“å‰é¡µé¢ã€_blankæ–°æ ‡ç­¾é¡µ) --&gt; &lt;a href=&quot;01æ¡ˆä¾‹äºŒï¼šæ ·å¼æ¼”ç¤º.html&quot; target=&quot;_blank&quot;&gt;ç‚¹æˆ‘è·³è½¬åˆ°æ ·å¼æ¼”ç¤º&lt;/a&gt; &lt;br/&gt; &lt;a href=&quot;http://www.itcast.cn&quot; target=&quot;_blank&quot;&gt;ä¼ æ™ºæ’­å®¢&lt;/a&gt; &lt;br/&gt; &lt;a href=&quot;http://www.itheima.com&quot; target=&quot;_self&quot;&gt;é»‘é©¬ç¨‹åºå‘˜&lt;/a&gt; &lt;br/&gt; &lt;a href=&quot;http://www.itheima.com&quot; target=&quot;_blank&quot;&gt;&lt;img src=&quot;../img/itheima.png&quot; width=&quot;150px&quot; height=&quot;50px&quot;/&gt;&lt;/a&gt;&lt;/body&gt;&lt;/html&gt; æ•ˆæœå›¾ï¼š è¡¨å•æ ‡ç­¾åŸºæœ¬ä»‹ç»form è¡¨ç¤ºè¡¨å•ï¼Œæ˜¯ç”¨æ¥æ”¶é›†ç”¨æˆ·è¾“å…¥ä¿¡æ¯å¹¶å‘ Web æœåŠ¡å™¨æäº¤çš„ä¸€ä¸ªå®¹å™¨ 123&lt;form &gt; //è¡¨å•å…ƒç´ &lt;/form&gt; å±æ€§å ä½œç”¨ action å¤„ç†æ­¤è¡¨å•ä¿¡æ¯çš„WebæœåŠ¡å™¨çš„URLåœ°å€ method æäº¤æ­¤è¡¨å•ä¿¡æ¯åˆ°WebæœåŠ¡å™¨çš„æ–¹å¼ï¼Œå¯èƒ½çš„å€¼æœ‰getå’Œpostï¼Œé»˜è®¤ä¸ºget autocomplete è‡ªåŠ¨è¡¥å…¨ï¼ŒæŒ‡ç¤ºè¡¨å•å…ƒç´ æ˜¯å¦èƒ½å¤Ÿæ‹¥æœ‰ä¸€ä¸ªé»˜è®¤å€¼ï¼Œé…åˆinputæ ‡ç­¾ä½¿ç”¨ getä¸poståŒºåˆ«ï¼š postï¼šæŒ‡çš„æ˜¯ HTTP POST æ–¹æ³•ï¼›è¡¨å•æ•°æ®ä¼šåŒ…å«åœ¨è¡¨å•ä½“å†…ç„¶åå‘é€ç»™æœåŠ¡å™¨ã€‚ getï¼šæŒ‡çš„æ˜¯ HTTP GET æ–¹æ³•ï¼›è¡¨å•æ•°æ®ä¼šé™„åŠ åœ¨ action å±æ€§çš„URIä¸­ï¼Œå¹¶ä»¥ â€˜?â€™ ä½œä¸ºåˆ†éš”ç¬¦ï¼Œç„¶åè¿™æ ·å¾—åˆ°çš„ URI å†å‘é€ç»™æœåŠ¡å™¨ã€‚ åœ°å€æ å¯è§ æ•°æ®å®‰å…¨ æ•°æ®å¤§å° GET å¯è§ ä¸å®‰å…¨ æœ‰é™åˆ¶ï¼ˆå–å†³äºæµè§ˆå™¨ï¼‰ POST ä¸å¯è§ ç›¸å¯¹å®‰å…¨ æ— é™åˆ¶ è¡¨å•å…ƒç´  æ ‡ç­¾å ä½œç”¨ å¤‡æ³¨ label è¡¨å•å…ƒç´ çš„è¯´æ˜ï¼Œé…åˆè¡¨å•å…ƒç´ ä½¿ç”¨ forå±æ€§å€¼ä¸ºç›¸å…³è¡¨å•å…ƒç´ idå±æ€§å€¼ input è¡¨å•ä¸­è¾“å…¥æ§ä»¶ï¼Œå¤šç§è¾“å…¥ç±»å‹ï¼Œç”¨äºæ¥å—æ¥è‡ªç”¨æˆ·æ•°æ® typeå±æ€§å€¼å†³å®šè¾“å…¥ç±»å‹ button é¡µé¢ä¸­å¯ç‚¹å‡»çš„æŒ‰é’®ï¼Œå¯ä»¥é…åˆè¡¨å•è¿›è¡Œæäº¤ typeå±æ€§å€¼å†³å®šæŒ‰é’®ç±»å‹ select è¡¨å•çš„æ§ä»¶ï¼Œä¸‹æ‹‰é€‰é¡¹èœå• ä¸optioné…åˆå®ç”¨ optgroup optionçš„åˆ†ç»„æ ‡ç­¾ ä¸optioné…åˆå®ç”¨ option selectçš„å­æ ‡ç­¾ï¼Œè¡¨ç¤ºä¸€ä¸ªé€‰é¡¹ textarea è¡¨ç¤ºå¤šè¡Œçº¯æ–‡æœ¬ç¼–è¾‘æ§ä»¶ fieldset ç”¨æ¥å¯¹è¡¨å•ä¸­çš„æ§åˆ¶å…ƒç´ è¿›è¡Œåˆ†ç»„(ä¹ŸåŒ…æ‹¬ label å…ƒç´ ) legend ç”¨äºè¡¨ç¤ºå®ƒçš„fieldsetå†…å®¹çš„æ ‡é¢˜ã€‚ fieldset çš„å­å…ƒç´  æŒ‰é”®æ§ä»¶buttonæ ‡ç­¾ï¼šè¡¨ç¤ºæŒ‰é’® typeå±æ€§ï¼šè¡¨ç¤ºæŒ‰é’®ç±»å‹ï¼Œsubmitå€¼ä¸ºæäº¤æŒ‰é’®ã€‚ å±æ€§å€¼ ä½œç”¨ å¤‡æ³¨ button æ— è¡Œä¸ºæŒ‰é’®ï¼Œç”¨äºç»“åˆJavaScriptå®ç°è‡ªå®šä¹‰åŠ¨æ€æ•ˆæœ åŒ &lt;input type=&quot;submit&quot;/&gt; submit æäº¤æŒ‰é’®ï¼Œç”¨äºæäº¤è¡¨å•æ•°æ®åˆ°æœåŠ¡å™¨ã€‚ åŒ &lt;input type=&quot;submit&quot;/&gt; reset é‡ç½®æŒ‰é’®ï¼Œç”¨äºå°†è¡¨å•ä¸­å†…å®¹æ¢å¤ä¸ºé»˜è®¤å€¼ã€‚ åŒ&lt;input type=&quot;reset&quot;&#x2F;&gt; è¾“å…¥æ§ä»¶åŸºæœ¬ä»‹ç» labelæ ‡ç­¾ï¼šè¡¨å•çš„è¯´æ˜ã€‚ forå±æ€§å€¼ï¼šåŒ¹é…inputæ ‡ç­¾çš„idå±æ€§å€¼ inputæ ‡ç­¾ï¼šè¾“å…¥æ§ä»¶ã€‚ å±æ€§ï¼š typeï¼šè¡¨ç¤ºè¾“å…¥ç±»å‹ï¼Œtextå€¼ä¸ºæ™®é€šæ–‡æœ¬æ¡† idï¼šè¡¨ç¤ºæ ‡ç­¾å”¯ä¸€æ ‡è¯† nameï¼šè¡¨ç¤ºæ ‡ç­¾åç§°ï¼Œæäº¤æœåŠ¡å™¨çš„æ ‡è¯† valueï¼šè¡¨ç¤ºæ ‡ç­¾çš„é»˜è®¤æ•°æ®å€¼ placeholderï¼šé»˜è®¤çš„æç¤ºä¿¡æ¯ï¼Œä»…é€‚ç”¨äºå½“type å±æ€§ä¸ºtext, search, tel, url or emailæ—¶; requiredï¼šæ˜¯å¦å¿…é¡»ä¸ºè¯¥å…ƒç´ å¡«å……å€¼ï¼Œå½“typeå±æ€§æ˜¯hidden,imageæˆ–è€…buttonç±»å‹æ—¶ä¸å¯ä½¿ç”¨ readonlyï¼šæ˜¯å¦åªè¯»,å¯ä»¥è®©ç”¨æˆ·ä¸ä¿®æ”¹è¿™ä¸ªè¾“å…¥æ¡†çš„å€¼,å°±ä½¿ç”¨valueå±æ€§è®¾ç½®é»˜è®¤å€¼ disabledï¼šæ˜¯å¦å¯ç”¨,å¦‚æœæŸä¸ªè¾“å…¥æ¡†æœ‰disabledé‚£ä¹ˆå®ƒçš„æ•°æ®ä¸èƒ½æäº¤åˆ°æœåŠ¡å™¨é€šå¸¸æ˜¯ä½¿ç”¨åœ¨æœ‰çš„é¡µé¢ä¸­ï¼Œè®©ä¸€äº›æŒ‰é’®ä¸èƒ½ç‚¹å‡» autocompleteï¼šè‡ªåŠ¨è¡¥å…¨ï¼Œè§„å®šè¡¨å•æˆ–è¾“å…¥å­—æ®µæ˜¯å¦åº”è¯¥è‡ªåŠ¨å®Œæˆã€‚å½“è‡ªåŠ¨å®Œæˆå¼€å¯ï¼Œæµè§ˆå™¨ä¼šåŸºäºç”¨æˆ·ä¹‹å‰çš„è¾“å…¥å€¼è‡ªåŠ¨å¡«å†™å€¼ã€‚å¯ä»¥è®¾ç½®æŒ‡å®šçš„å­—æ®µä¸ºoffï¼Œå…³é—­è‡ªåŠ¨è¡¥å…¨ 12345678910&lt;body&gt; &lt;form action=&quot;#&quot; method=&quot;get&quot; autocomplete=&quot;off&quot;&gt; &lt;label for=&quot;username&quot;&gt;ç”¨æˆ·åï¼š&lt;/label&gt; &lt;input type=&quot;text&quot; id=&quot;username&quot; name=&quot;username&quot; value=&quot;&quot; placeholder=&quot; è¯·åœ¨æ­¤å¤„è¾“å…¥ç”¨æˆ·å&quot; required/&gt; &lt;button type=&quot;submit&quot;&gt;æäº¤&lt;/button&gt; &lt;button type=&quot;reset&quot;&gt;é‡ç½®&lt;/button&gt; &lt;button type=&quot;button&quot;&gt;æŒ‰é’®&lt;/button&gt; &lt;/form&gt;&lt;/body&gt;&lt;/html&gt; æ•ˆæœå›¾ï¼š è¡¨å•é¡¹æ ‡ç­¾ ç”¨æˆ·åï¼š æäº¤ é‡ç½® æŒ‰é’® n-vå±æ€§ å±æ€§å ä½œç”¨ name &lt;input&gt;çš„åå­—ï¼Œåœ¨æäº¤æ•´ä¸ªè¡¨å•æ•°æ®æ—¶ï¼Œå¯ä»¥ç”¨äºåŒºåˆ†å±äºä¸åŒ&lt;input&gt;çš„å€¼ value è¿™ä¸ª&lt;input&gt;å…ƒç´ å½“å‰çš„å€¼ï¼Œå…è®¸ç”¨æˆ·é€šè¿‡é¡µé¢è¾“å…¥ ä½¿ç”¨æ–¹å¼ï¼šä»¥nameå±æ€§å€¼ä½œä¸ºé”®ï¼Œvalueå±æ€§å€¼ä½œä¸ºå€¼ï¼Œæ„æˆé”®å€¼å¯¹æäº¤åˆ°æœåŠ¡å™¨ï¼Œå¤šä¸ªé”®å€¼å¯¹æµè§ˆå™¨ä½¿ç”¨&amp;è¿›è¡Œåˆ†éš”ã€‚ typeå±æ€§ å±æ€§å€¼ ä½œç”¨ å¤‡æ³¨ text å•è¡Œæ–‡æœ¬å­—æ®µ password å•è¡Œæ–‡æœ¬å­—æ®µï¼Œå€¼è¢«é®ç›– email ç”¨äºç¼–è¾‘ e-mail çš„å­—æ®µï¼Œå¯ä»¥å¯¹e-mailåœ°å€è¿›è¡Œç®€å•æ ¡éªŒ radio å•é€‰æŒ‰é’®ã€‚ 1. åœ¨åŒä¸€ä¸ªâ€å•é€‰æŒ‰é’®ç»„â€œä¸­ï¼Œæ‰€æœ‰å•é€‰æŒ‰é’®çš„ name å±æ€§ä½¿ç”¨åŒä¸€ä¸ªå€¼ï¼›ä¸€ä¸ªå•é€‰æŒ‰é’®ç»„ä¸­æ˜¯ï¼ŒåŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªå•é€‰æŒ‰é’®å¯ä»¥è¢«é€‰æ‹©ã€‚ 2. å¿…é¡»ä½¿ç”¨ value å±æ€§å®šä¹‰æ­¤æ§ä»¶è¢«æäº¤æ—¶çš„å€¼ã€‚ 3. ä½¿ç”¨checked å¿…é¡»æŒ‡ç¤ºæ§ä»¶æ˜¯å¦ç¼ºçœè¢«é€‰æ‹©ã€‚ checkbox å¤é€‰æ¡†ã€‚ 1. å¿…é¡»ä½¿ç”¨ value å±æ€§å®šä¹‰æ­¤æ§ä»¶è¢«æäº¤æ—¶çš„å€¼ã€‚ 2. ä½¿ç”¨ checked å±æ€§æŒ‡ç¤ºæ§ä»¶æ˜¯å¦è¢«é€‰æ‹©ã€‚ 3. é€‰ä¸­å¤šä¸ªå€¼æ—¶ï¼Œæ‰€æœ‰çš„å€¼ä¼šæ„æˆä¸€ä¸ªæ•°ç»„è€Œæäº¤åˆ°WebæœåŠ¡å™¨ date HTML5 ç”¨äºè¾“å…¥æ—¥æœŸçš„æ§ä»¶ å¹´ï¼Œæœˆï¼Œæ—¥ï¼Œä¸åŒ…æ‹¬æ—¶é—´ time HTML5 ç”¨äºè¾“å…¥æ—¶é—´çš„æ§ä»¶ ä¸å«æ—¶åŒº datetime-local HTML5 ç”¨äºè¾“å…¥æ—¥æœŸæ—¶é—´çš„æ§ä»¶ ä¸åŒ…å«æ—¶åŒº number HTML5 ç”¨äºè¾“å…¥æµ®ç‚¹æ•°çš„æ§ä»¶ range HTML5 ç”¨äºè¾“å…¥ä¸ç²¾ç¡®å€¼æ§ä»¶ max-è§„å®šæœ€å¤§å€¼min-è§„å®šæœ€å°å€¼ step-è§„å®šæ­¥è¿›å€¼ value-è§„å®šé»˜è®¤å€¼ search HTML5 ç”¨äºè¾“å…¥æœç´¢å­—ç¬¦ä¸²çš„å•è¡Œæ–‡æœ¬å­—æ®µ å¯ä»¥ç‚¹å‡»xæ¸…é™¤å†…å®¹ tel HTML5 ç”¨äºè¾“å…¥ç”µè¯å·ç çš„æ§ä»¶ url HTML5 ç”¨äºç¼–è¾‘URLçš„å­—æ®µ å¯ä»¥æ ¡éªŒURLåœ°å€æ ¼å¼ file æ­¤æ§ä»¶å¯ä»¥è®©ç”¨æˆ·é€‰æ‹©æ–‡ä»¶ï¼Œç”¨äºæ–‡ä»¶ä¸Šä¼ ã€‚ ä½¿ç”¨ accept å±æ€§å¯ä»¥å®šä¹‰æ§ä»¶å¯ä»¥é€‰æ‹©çš„æ–‡ä»¶ç±»å‹ã€‚ hidden æ­¤æ§ä»¶ç”¨æˆ·åœ¨é¡µé¢ä¸Šä¸å¯è§ï¼Œä½†å®ƒçš„å€¼ä¼šè¢«æäº¤åˆ°æœåŠ¡å™¨ï¼Œç”¨äºä¼ é€’éšè—å€¼ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;typeå±æ€§æ¼”ç¤º&lt;/title&gt;&lt;/head&gt;&lt;body&gt; &lt;form action=&quot;#&quot; method=&quot;get&quot; autocomplete=&quot;off&quot;&gt; &lt;label for=&quot;username&quot;&gt;ç”¨æˆ·åï¼š&lt;/label&gt; &lt;input type=&quot;text&quot; id=&quot;username&quot; name=&quot;username&quot;/&gt; &lt;br/&gt; &lt;label for=&quot;password&quot;&gt;å¯†ç ï¼š&lt;/label&gt; &lt;input type=&quot;password&quot; id=&quot;password&quot; name=&quot;password&quot;/&gt; &lt;br/&gt; &lt;label for=&quot;email&quot;&gt;é‚®ç®±ï¼š&lt;/label&gt; &lt;input type=&quot;email&quot; id=&quot;email&quot; name=&quot;email&quot;/&gt; &lt;br/&gt; &lt;label for=&quot;gender&quot;&gt;æ€§åˆ«ï¼š&lt;/label&gt; &lt;input type=&quot;radio&quot; id=&quot;gender&quot; name=&quot;gender&quot; value=&quot;men&quot;/&gt;ç”· &lt;input type=&quot;radio&quot; name=&quot;gender&quot; value=&quot;women&quot;/&gt;å¥³ &lt;input type=&quot;radio&quot; name=&quot;gender&quot; value=&quot;other&quot;/&gt;å…¶ä»–&lt;br/&gt; &lt;label for=&quot;hobby&quot;&gt;çˆ±å¥½ï¼š&lt;/label&gt; &lt;input type=&quot;checkbox&quot; id=&quot;hobby&quot; name=&quot;hobby&quot; value=&quot;music&quot; checked/&gt;éŸ³ä¹ &lt;input type=&quot;checkbox&quot; name=&quot;hobby&quot; value=&quot;game&quot;/&gt;æ¸¸æˆ &lt;br/&gt; &lt;label for=&quot;birthday&quot;&gt;ç”Ÿæ—¥ï¼š&lt;/label&gt; &lt;input type=&quot;date&quot; id=&quot;birthday&quot; name=&quot;birthday&quot;/&gt; &lt;br/&gt; &lt;label for=&quot;time&quot;&gt;å½“å‰æ—¶é—´ï¼š&lt;/label&gt; &lt;input type=&quot;time&quot; id=&quot;time&quot; name=&quot;time&quot;/&gt; &lt;br/&gt; &lt;label for=&quot;insert&quot;&gt;æ³¨å†Œæ—¶é—´ï¼š&lt;/label&gt; &lt;input type=&quot;datetime-local&quot; id=&quot;insert&quot; name=&quot;insert&quot;/&gt; &lt;br/&gt; &lt;label for=&quot;age&quot;&gt;å¹´é¾„ï¼š&lt;/label&gt; &lt;input type=&quot;number&quot; id=&quot;age&quot; name=&quot;age&quot;/&gt; &lt;br/&gt; &lt;label for=&quot;range&quot;&gt;å¿ƒæƒ…å€¼(1~10)ï¼š&lt;/label&gt; &lt;input type=&quot;range&quot; id=&quot;range&quot; name=&quot;range&quot; min=&quot;1&quot; max=&quot;10&quot; step=&quot;1&quot;/&gt; &lt;br/&gt; &lt;label for=&quot;search&quot;&gt;å¯å…¨éƒ¨æ¸…é™¤æ–‡æœ¬ï¼š&lt;/label&gt; &lt;input type=&quot;search&quot; id=&quot;search&quot; name=&quot;search&quot;/&gt; &lt;br/&gt; &lt;label for=&quot;tel&quot;&gt;ç”µè¯ï¼š&lt;/label&gt; &lt;input type=&quot;tel&quot; id=&quot;tel&quot; name=&quot;tel&quot;/&gt; &lt;br/&gt; &lt;label for=&quot;url&quot;&gt;ä¸ªäººç½‘ç«™ï¼š&lt;/label&gt; &lt;input type=&quot;url&quot; id=&quot;url&quot; name=&quot;url&quot;/&gt; &lt;br/&gt; &lt;label for=&quot;file&quot;&gt;æ–‡ä»¶ä¸Šä¼ ï¼š&lt;/label&gt; &lt;input type=&quot;file&quot; id=&quot;file&quot; name=&quot;file&quot;/&gt; &lt;br/&gt; &lt;label for=&quot;hidden&quot;&gt;éšè—ä¿¡æ¯ï¼š&lt;/label&gt; &lt;input type=&quot;hidden&quot; id=&quot;hidden&quot; name=&quot;hidden&quot; value=&quot;itheima&quot;/&gt; &lt;br/&gt; &lt;button type=&quot;submit&quot;&gt;æäº¤&lt;/button&gt; &lt;button type=&quot;reset&quot;&gt;é‡ç½®&lt;/button&gt; &lt;/form&gt;&lt;/body&gt;&lt;/html&gt; é€‰æ‹©æ§ä»¶ä¸‹æ‹‰åˆ—è¡¨æ ‡ç­¾ï¼š 123&lt;select name=&quot;&quot;&gt; &lt;option value=&quot;&quot;&gt;æ˜¾ç¤ºçš„å†…å®¹&lt;/option&gt;&lt;/select&gt; optionï¼šé€‰æ‹©èœå•çš„é€‰é¡¹ optgroupï¼šåˆ—è¡¨é¡¹åˆ†ç»„æ ‡ç­¾å±æ€§ï¼šlabelè®¾ç½®åˆ†ç»„åç§° æ–‡æœ¬åŸŸæ§ä»¶1&lt;textarea name=&quot;textarea&quot; rows=&quot;10&quot; cols=&quot;50&quot;&gt;Write something here&lt;/textarea&gt; å±æ€§ï¼š name-æ ‡ç­¾åç§° rows-è¡Œæ•° cols-åˆ—æ•° 1234567891011121314151617&lt;body&gt; &lt;form action=&quot;#&quot; method=&quot;get&quot; autocomplete=&quot;off&quot;&gt; æ‰€åœ¨åŸå¸‚ï¼š&lt;select name=&quot;city&quot;&gt; &lt;option&gt;---è¯·é€‰æ‹©åŸå¸‚---&lt;/option&gt; &lt;optgroup label=&quot;ç›´è¾–å¸‚&quot;&gt; &lt;option&gt;åŒ—äº¬&lt;/option&gt; &lt;option&gt;ä¸Šæµ·&lt;/option&gt; &lt;/optgroup&gt; &lt;optgroup label=&quot;çœä¼šå¸‚&quot;&gt; &lt;option&gt;æ­å·&lt;/option&gt; &lt;option&gt;æ­¦æ±‰&lt;/option&gt; &lt;/optgroup&gt; &lt;/select&gt; &lt;br/&gt; ä¸ªäººä»‹ç»ï¼š&lt;textarea name=&quot;desc&quot; rows=&quot;5&quot; cols=&quot;20&quot;&gt;&lt;/textarea&gt; &lt;/form&gt;&lt;/body&gt; åˆ†ç»„æ§ä»¶123456789&lt;form action=&quot;#&quot; method=&quot;post&quot;&gt; &lt;fieldset&gt; &lt;legend&gt;æ˜¯å¦åŒæ„&lt;/legend&gt; &lt;input type=&quot;radio&quot; id=&quot;radio_y&quot; name=&quot;agree&quot; value=&quot;y&quot;&gt; &lt;label for=&quot;radio_y&quot;&gt;åŒæ„&lt;/label&gt; &lt;input type=&quot;radio&quot; id=&quot;radio_n&quot; name=&quot;agree&quot; value=&quot;n&quot;&gt; &lt;label for=&quot;radio_n&quot;&gt;ä¸åŒæ„&lt;/label&gt; &lt;/fieldset&gt;&lt;/form&gt; æ˜¯å¦åŒæ„ åŒæ„ ä¸åŒæ„ è¡¨æ ¼æ ‡ç­¾åŸºæœ¬å±æ€§&lt;table&gt; , è¡¨ç¤ºè¡¨æ ¼æ ‡ç­¾ï¼Œè¡¨æ ¼æ˜¯æ•°æ®å•å…ƒçš„è¡Œå’Œåˆ—çš„ä¸¤ç»´è¡¨ trï¼štable rowï¼Œè¡¨ç¤ºè¡¨ä¸­å•å…ƒçš„è¡Œ tdï¼štable dataï¼Œè¡¨ç¤ºè¡¨ä¸­ä¸€ä¸ªå•å…ƒæ ¼ thï¼štable headerï¼Œè¡¨æ ¼å•å…ƒæ ¼çš„è¡¨å¤´ï¼Œé€šå¸¸å­—ä½“æ ·å¼åŠ ç²—å±…ä¸­ ä»£ç å±•ç¤ºï¼š 1234567891011121314&lt;table&gt; &lt;tr&gt; &lt;th&gt;First name&lt;/th&gt; &lt;th&gt;Last name&lt;/th&gt; &lt;/tr&gt; &lt;tr&gt; &lt;td&gt;John&lt;/td&gt; &lt;td&gt;Doe&lt;/td&gt; &lt;/tr&gt; &lt;tr&gt; &lt;td&gt;Jane&lt;/td&gt; &lt;td&gt;Doe&lt;/td&gt; &lt;/tr&gt;&lt;/table&gt; æ•ˆæœå›¾ï¼š First name Last name John Doe Jane Doe è·¨è¡Œè·¨åˆ—123456789101112131415161718192021222324252627282930313233343536&lt;table width=&quot;400px&quot; border=&quot;1px&quot; align=&quot;center&quot;&gt; &lt;thead&gt; &lt;tr&gt; &lt;th&gt;å§“å&lt;/th&gt; &lt;th&gt;æ€§åˆ«&lt;/th&gt; &lt;th&gt;å¹´é¾„&lt;/th&gt; &lt;th&gt;æ•°å­¦&lt;/th&gt; &lt;th&gt;è¯­æ–‡&lt;/th&gt; &lt;/tr&gt; &lt;/thead&gt; &lt;tbody&gt; &lt;tr align=&quot;center&quot;&gt; &lt;td&gt;å¼ ä¸‰&lt;/td&gt; &lt;td rowspan=&quot;2&quot;&gt;ç”·&lt;/td&gt; &lt;td&gt;23&lt;/td&gt; &lt;td colspan=&quot;2&quot;&gt;90&lt;/td&gt; &lt;!--&lt;td&gt;90&lt;/td&gt;--&gt; &lt;/tr&gt; &lt;tr align=&quot;center&quot;&gt; &lt;td&gt;æå››&lt;/td&gt; &lt;!--&lt;td&gt;ç”·&lt;/td&gt;--&gt; &lt;td&gt;24&lt;/td&gt; &lt;td&gt;95&lt;/td&gt; &lt;td&gt;98&lt;/td&gt; &lt;/tr&gt; &lt;/tbody&gt; &lt;tfoot&gt; &lt;tr&gt; &lt;td colspan=&quot;4&quot;&gt;æ€»åˆ†æ•°ï¼š&lt;/td&gt; &lt;td&gt;373&lt;/td&gt; &lt;/tr&gt; &lt;/tfoot&gt;&lt;/table&gt; æ•ˆæœå›¾ï¼š è¡¨æ ¼ç»“æ„ æ ‡ç­¾å ä½œç”¨ å¤‡æ³¨ thead å®šä¹‰è¡¨æ ¼çš„åˆ—å¤´çš„è¡Œ ä¸€ä¸ªè¡¨æ ¼ä¸­ä»…æœ‰ä¸€ä¸ª tbody å®šä¹‰è¡¨æ ¼çš„ä¸»ä½“ ç”¨æ¥å°è£…ä¸€ç»„è¡¨è¡Œï¼ˆtrå…ƒç´ ï¼‰ tfoot å®šä¹‰è¡¨æ ¼çš„å„åˆ—æ±‡æ€»è¡Œ ä¸€ä¸ªè¡¨æ ¼ä¸­ä»…æœ‰ä¸€ä¸ª æ ·å¼å¸ƒå±€åŸºæœ¬æ ¼å¼åœ¨headæ ‡ç­¾ä¸­ï¼Œé€šè¿‡styleæ ‡ç­¾åŠ å…¥æ ·å¼ã€‚ åŸºæœ¬æ ¼å¼ï¼šå¯ä»¥å«æœ‰å¤šä¸ªå±æ€§ï¼Œä¸€ä¸ªå±æ€§åä¹Ÿå¯ä»¥å«æœ‰å¤šä¸ªå€¼ï¼ŒåŒæ—¶è®¾ç½®å¤šæ ·å¼ã€‚ 1234567&lt;style&gt; æ ‡ç­¾å&#123; å±æ€§å1:å±æ€§å€¼1; å±æ€§å2:å±æ€§å€¼2; å±æ€§å:å±æ€§å€¼1 å±æ€§å€¼2 å±æ€§å€¼3; &#125;&lt;/style&gt; èƒŒæ™¯æ ¼å¼backgroundå±æ€§ç”¨æ¥è®¾ç½®èƒŒæ™¯ç›¸å…³çš„æ ·å¼ã€‚ èƒŒæ™¯è‰²[background-color]å±æ€§å®šä¹‰ä»»ä½•å…ƒç´ çš„èƒŒæ™¯è‰² 123body &#123; background-color: #567895;&#125; èƒŒæ™¯å›¾è¯¥[background-image]å±æ€§å…è®¸åœ¨å…ƒç´ çš„èƒŒæ™¯ä¸­æ˜¾ç¤ºå›¾åƒã€‚ä½¿ç”¨urlå‡½æ•°æŒ‡å®šå›¾ç‰‡è·¯å¾„ 12345678910111213141516&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;èƒŒæ™¯å›¾ç‰‡&lt;/title&gt; &lt;style&gt; body&#123; /*æ·»åŠ èƒŒæ™¯å›¾ç‰‡*/ background: url(&quot;../img/bg.png&quot;); &#125; &lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt; èƒŒæ™¯é‡å¤ [background-repeat]å±æ€§ç”¨äºæ§åˆ¶å›¾åƒçš„å¹³é“ºè¡Œä¸ºã€‚å¯ç”¨å€¼ï¼š no-repeat -åœæ­¢å®Œå…¨é‡å¤èƒŒæ™¯ repeat-x â€”æ°´å¹³é‡å¤ repeat-y â€”ç«–ç›´é‡å¤ repeatâ€”é»˜è®¤å€¼ï¼›åŒå‘é‡å¤ 1234body &#123; background-image: url(star.png); background-repeat: repeat-x;/*æ°´å¹³é‡å¤*/&#125; divå¸ƒå±€ divç®€å•å¸ƒå±€ï¼š broaderï¼šè¾¹ç•Œ solidï¼šå®çº¿ blueï¼šé¢œè‰² 1234567&lt;style&gt; div&#123; border: 1px solid blue;&#125;&lt;/style&gt;&lt;div &gt;left&lt;/div&gt;&lt;div &gt;center&lt;/div&gt;&lt;div&gt;right&lt;/div&gt; classå€¼å¯ä»¥è®¾ç½®å®½åº¦ï¼Œæµ®åŠ¨ï¼ŒèƒŒæ™¯ 123456.classå€¼&#123; å±æ€§å:å±æ€§å€¼;&#125;&lt;æ ‡ç­¾å class=&quot;classå€¼&quot;&gt; æç¤º: classæ˜¯è‡ªå®šä¹‰çš„å€¼ å±æ€§ backgroundï¼šèƒŒæ™¯é¢œè‰² widthï¼šå®½åº¦ (npx æˆ–è€… n%) heightï¼šé•¿åº¦ text-alignï¼šæ–‡æœ¬å¯¹é½æ–¹å¼ background-image: url(â€œ..&#x2F;img&#x2F;bg.pngâ€)ï¼šèƒŒæ™¯å›¾ floatï¼šæµ®åŠ¨ æŒ‡å®šä¸€ä¸ªå…ƒç´ åº”æ²¿å…¶å®¹å™¨çš„å·¦ä¾§æˆ–å³ä¾§æ”¾ç½®ï¼Œå…è®¸æ–‡æœ¬æˆ–è€…å†…è”å…ƒç´ ç¯ç»•å®ƒï¼Œè¯¥å…ƒç´ ä»ç½‘é¡µçš„æ­£å¸¸æµåŠ¨ä¸­ç§»é™¤ï¼Œå…¶ä»–éƒ¨åˆ†ä¿æŒæ­£å¸¸æ–‡æ¡£æµé¡ºåºã€‚ 1234567&lt;!-- åŠ å…¥æµ®åŠ¨ --&gt;floatï¼šnoneï¼›ä¸æµ®åŠ¨floatï¼šleftï¼›å·¦æµ®åŠ¨floatï¼šrightï¼›å³æµ®åŠ¨&lt;!-- æ¸…é™¤æµ®åŠ¨ --&gt;clearï¼šbothï¼›æ¸…é™¤ä¸¤ä¾§æµ®åŠ¨ï¼Œæ­¤å…ƒç´ ä¸å†æ”¶æµ®åŠ¨å…ƒç´ å¸ƒå±€å½±å“ã€‚ divåŸºæœ¬å¸ƒå±€ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;æ ·å¼æ¼”ç¤º&lt;/title&gt; &lt;style&gt; /*ç»™divæ ‡ç­¾æ·»åŠ è¾¹æ¡†*/ div&#123; border: 1px solid red; &#125; /*å·¦ä¾§å›¾ç‰‡çš„divæ ·å¼*/ .left&#123; width: 20%; float: left; height: 500px; &#125; /*ä¸­é—´æ­£æ–‡çš„divæ ·å¼*/ .center&#123; width: 59%; float: left; height: 500px; &#125; /*å³ä¾§å¹¿å‘Šå›¾ç‰‡çš„divæ ·å¼*/ .right&#123; width: 20%; float: left; height: 500px; &#125; /*åº•éƒ¨è¶…é“¾æ¥çš„divæ ·å¼*/ .footer&#123; /*æ¸…é™¤æµ®åŠ¨æ•ˆæœ*/ clear: both; /*æ–‡æœ¬å¯¹é½æ–¹å¼*/ text-align: center; /*èƒŒæ™¯é¢œè‰²*/ background: blue; &#125; &lt;/style&gt;&lt;/head&gt;&lt;body&gt; &lt;!--é¡¶éƒ¨ç™»é™†æ³¨å†Œ--&gt; &lt;div&gt;top&lt;/div&gt; &lt;!--å¯¼èˆªæ¡--&gt; &lt;div&gt;navibar&lt;/div&gt; &lt;!--å·¦ä¾§å›¾ç‰‡--&gt; &lt;div class=&quot;left&quot;&gt;left&lt;/div&gt; &lt;!--ä¸­é—´æ­£æ–‡--&gt; &lt;div class=&quot;center&quot;&gt;center&lt;/div&gt; &lt;!--å³ä¾§å¹¿å‘Šå›¾ç‰‡--&gt; &lt;div class=&quot;right&quot;&gt;right&lt;/div&gt; &lt;!--åº•éƒ¨é¡µè„šè¶…é“¾æ¥--&gt; &lt;div class=&quot;footer&quot;&gt;footer&lt;/div&gt;&lt;/body&gt;&lt;/html&gt; è¯­ä¹‰åŒ–æ ‡ç­¾ä¸ºäº†æ›´å¥½çš„ç»„ç»‡æ–‡æ¡£ï¼ŒHTML5è§„èŒƒä¸­è®¾è®¡äº†å‡ ä¸ªè¯­ä¹‰å…ƒç´ ï¼Œå¯ä»¥å°†ç‰¹æ®Šå«ä¹‰ä¼ è¾¾ç»™æµè§ˆå™¨ã€‚ æ ‡ç­¾ åç§° ä½œç”¨ å¤‡æ³¨ header æ ‡å¤´å…ƒç´  è¡¨ç¤ºå†…å®¹çš„ä»‹ç» å—å…ƒç´ ï¼Œæ–‡æ¡£ä¸­å¯ä»¥å®šä¹‰å¤šä¸ª nav å¯¼èˆªå…ƒç´  è¡¨ç¤ºå¯¼èˆªé“¾æ¥ å¸¸è§äºç½‘ç«™çš„èœå•ï¼Œç›®å½•å’Œç´¢å¼•ç­‰ï¼Œå¯ä»¥åµŒå¥—åœ¨headerä¸­ article æ–‡ç« å…ƒç´  è¡¨ç¤ºç‹¬ç«‹å†…å®¹åŒºåŸŸ æ ‡ç­¾å®šä¹‰çš„å†…å®¹æœ¬èº«å¿…é¡»æ˜¯æœ‰æ„ä¹‰ä¸”å¿…é¡»ç‹¬ç«‹äºæ–‡æ¡£çš„å…¶ä»–éƒ¨åˆ† footer é¡µè„šå…ƒç´  è¡¨ç¤ºé¡µé¢çš„åº•éƒ¨ å—å…ƒç´ ï¼Œæ–‡æ¡£ä¸­å¯ä»¥å®šä¹‰å¤šä¸ª HTMLæ‹“å±•éŸ³é¢‘æ ‡ç­¾&lt;audio&gt;ï¼šç”¨äºæ’­æ”¾å£°éŸ³ï¼Œæ¯”å¦‚éŸ³ä¹æˆ–å…¶ä»–éŸ³é¢‘æµï¼Œæ˜¯ HTML 5 çš„æ–°æ ‡ç­¾ã€‚ å¸¸ç”¨å±æ€§ï¼š å±æ€§å å–å€¼ æè¿° src URL éŸ³é¢‘èµ„æºçš„è·¯å¾„ autoplay autoplay éŸ³é¢‘å‡†å¤‡å°±ç»ªåè‡ªåŠ¨æ’­æ”¾ controls controls æ˜¾ç¤ºæ§ä»¶ï¼Œæ¯”å¦‚æ’­æ”¾æŒ‰é’®ã€‚ loop loop è¡¨ç¤ºå¾ªç¯æ’­æ”¾ preload preload éŸ³é¢‘åœ¨é¡µé¢åŠ è½½æ—¶è¿›è¡Œé¢„åŠ è½½ã€‚å¦‚æœä½¿ç”¨ â€œautoplayâ€ï¼Œåˆ™å¿½ç•¥è¯¥å±æ€§ã€‚ HTML5åª’ä½“æ ‡ç­¾-éŸ³é¢‘audio ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒ audio æ ‡ç­¾ã€‚ è§†é¢‘æ ‡ç­¾&lt;video&gt; æ ‡ç­¾ç”¨äºæ’­æ”¾è§†é¢‘ï¼Œæ¯”å¦‚ç”µå½±ç‰‡æ®µæˆ–å…¶ä»–è§†é¢‘æµï¼Œæ˜¯ HTML 5 çš„æ–°æ ‡ç­¾ã€‚ å¸¸ç”¨å±æ€§ï¼š å±æ€§å å–å€¼ æè¿° src URL è¦æ’­æ”¾çš„è§†é¢‘çš„ URLã€‚ width è®¾ç½®è§†é¢‘æ’­æ”¾å™¨çš„å®½åº¦ã€‚ height è®¾ç½®è§†é¢‘æ’­æ”¾å™¨çš„é«˜åº¦ã€‚ autoplay autoplay è§†é¢‘åœ¨å°±ç»ªåè‡ªåŠ¨æ’­æ”¾ã€‚ control controls æ˜¾ç¤ºæ§ä»¶ï¼Œæ¯”å¦‚æ’­æ”¾æŒ‰é’®ã€‚ loop loop å¦‚æœå‡ºç°è¯¥å±æ€§ï¼Œåˆ™å½“åª’ä»‹æ–‡ä»¶å®Œæˆæ’­æ”¾åå†æ¬¡å¼€å§‹æ’­æ”¾ã€‚ preload preload è§†é¢‘åœ¨é¡µé¢åŠ è½½æ—¶è¿›è¡ŒåŠ è½½ã€‚å¦‚æœä½¿ç”¨ â€œautoplayâ€ï¼Œåˆ™å¿½ç•¥è¯¥å±æ€§ã€‚ mute muted è§„å®šè§†é¢‘çš„éŸ³é¢‘è¾“å‡ºåº”è¯¥è¢«é™éŸ³ã€‚ poste URL è§†é¢‘ä¸‹è½½æ—¶æ˜¾ç¤ºçš„å›¾åƒï¼Œæˆ–è€…è§†é¢‘æ’­æ”¾å‰æ˜¾ç¤ºçš„å›¾åƒã€‚ 1234567891011121314&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;HTML5åª’ä½“æ ‡ç­¾-è§†é¢‘video&lt;/title&gt;&lt;/head&gt;&lt;body&gt; &lt;video src=&quot;media/movie.ogg&quot; controls&gt; ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒ video æ ‡ç­¾ &lt;/video&gt;&lt;/body&gt;&lt;/html&gt; å›åˆ°é¡¶éƒ¨åœ¨htmlé‡Œé¢é”šç‚¹çš„ä½œç”¨: é€šè¿‡aæ ‡ç­¾è·³è½¬åˆ°æŒ‡å®šçš„ä½ç½®. 1&lt;a href=&quot;#aId&quot;&gt;å›åˆ°é¡¶éƒ¨&lt;/a&gt; å›åˆ°é¡¶éƒ¨ è¯¦æƒ…æ¦‚è¦summaryæ ‡ç­¾æ¥æè¿°æ¦‚è¦ä¿¡æ¯, åˆ©ç”¨detailsæ ‡ç­¾æ¥æè¿°è¯¦æƒ…ä¿¡æ¯. é»˜è®¤æƒ…å†µä¸‹æ˜¯æŠ˜å å±•ç¤º, æƒ³çœ‹è§è¯¦æƒ…å¿…é¡»ç‚¹å‡» 1234&lt;details&gt; &lt;summary&gt;æ¦‚è¦ä¿¡æ¯&lt;/summary&gt; è¯¦æƒ…ä¿¡æ¯&lt;/details&gt; æ¦‚è¦ä¿¡æ¯ è¯¦æƒ…ä¿¡æ¯ CSSCSSå…¥é—¨æ¦‚è¿°CSS (å±‚å æ ·å¼è¡¨â€”â€”Cascading Style Sheetsï¼Œç¼©å†™ä¸º CSSï¼‰ï¼Œç®€å•çš„è¯´ï¼Œå®ƒæ˜¯ç”¨äºè®¾ç½®å’Œå¸ƒå±€ç½‘é¡µçš„è®¡ç®—æœºè¯­è¨€ã€‚ä¼šå‘ŠçŸ¥æµè§ˆå™¨å¦‚ä½•æ¸²æŸ“é¡µé¢å…ƒç´ ã€‚ä¾‹å¦‚ï¼Œè°ƒæ•´å†…å®¹çš„å­—ä½“ï¼Œé¢œè‰²ï¼Œå¤§å°ç­‰æ ·å¼ï¼Œè®¾ç½®è¾¹æ¡†çš„æ ·å¼ï¼Œè°ƒæ•´æ¨¡å—çš„é—´è·ç­‰ã€‚ å±‚å ï¼šæ˜¯æŒ‡æ ·å¼è¡¨å…è®¸ä»¥å¤šç§æ–¹å¼è§„å®šæ ·å¼ä¿¡æ¯ã€‚å¯ä»¥è§„å®šåœ¨å•ä¸ªå…ƒç´ ä¸­ï¼Œå¯ä»¥åœ¨é¡µé¢å¤´å…ƒç´ ä¸­ï¼Œä¹Ÿå¯ä»¥åœ¨å¦ä¸€ä¸ªCSSæ–‡ä»¶ä¸­ï¼Œè§„å®šçš„æ–¹å¼ä¼šæœ‰æ¬¡åºçš„å·®åˆ«ã€‚ æ ·å¼ï¼šæ˜¯æŒ‡ä¸°å¯Œçš„æ ·å¼å¤–è§‚ã€‚æ‹¿è¾¹æ¡†è·ç¦»æ¥è¯´ï¼Œå…è®¸ä»»ä½•è®¾ç½®è¾¹æ¡†ï¼Œå…è®¸è®¾ç½®è¾¹æ¡†ä¸æ¡†å†…å…ƒç´ çš„è·ç¦»ï¼Œå…è®¸è®¾ç½®è¾¹æ¡†ä¸è¾¹æ¡†çš„è·ç¦»ç­‰ç­‰ã€‚ ç»„æˆCSSæ˜¯ä¸€é—¨åŸºäºè§„åˆ™çš„è¯­è¨€â€”ä½ èƒ½å®šä¹‰ç”¨äºä½ çš„ç½‘é¡µä¸­ç‰¹å®šå…ƒç´ çš„ä¸€ç»„æ ·å¼è§„åˆ™ã€‚è¿™é‡Œé¢æåˆ°äº†ä¸¤ä¸ªæ¦‚å¿µï¼Œä¸€æ˜¯ç‰¹å®šå…ƒç´ ï¼ŒäºŒæ˜¯æ ·å¼è§„åˆ™ã€‚å¯¹åº”CSSçš„è¯­æ³•ï¼Œä¹Ÿå°±æ˜¯é€‰æ‹©å™¨ï¼ˆselectsï¼‰å’Œå£°æ˜ï¼ˆeclarationsï¼‰ã€‚ é€‰æ‹©å™¨ï¼šæŒ‡å®šè¦æ·»åŠ æ ·å¼çš„ HTMLå…ƒç´ çš„æ–¹å¼ã€‚å¯ä»¥ä½¿ç”¨æ ‡ç­¾åï¼Œclasså€¼ï¼Œidå€¼ç­‰å¤šç§æ–¹å¼ã€‚ å£°æ˜ï¼šå½¢å¼ä¸º**å±æ€§(property):å€¼(value)**ï¼Œç”¨äºè®¾ç½®ç‰¹å®šå…ƒç´ çš„å±æ€§ä¿¡æ¯ã€‚ å±æ€§ï¼šæŒ‡ç¤ºæ–‡ä½“ç‰¹å¾ï¼Œä¾‹å¦‚font-sizeï¼Œwidthï¼Œbackground-colorã€‚ å€¼ï¼šæ¯ä¸ªæŒ‡å®šçš„å±æ€§éƒ½æœ‰ä¸€ä¸ªå€¼ï¼Œè¯¥å€¼æŒ‡ç¤ºæ‚¨å¦‚ä½•æ›´æ”¹è¿™äº›æ ·å¼ã€‚ æ ¼å¼ï¼š 12345é€‰æ‹©å™¨ &#123; å±æ€§å:å±æ€§å€¼; å±æ€§å:å±æ€§å€¼; å±æ€§å:å±æ€§å€¼;&#125; å®ç° é¡µé¢æ ‡é¢˜ h1{ font-size:40px; /* è®¾ç½®å­—ä½“å¤§å°ä¸º100åƒç´ */ } ä»Šå¤©å¼€å§‹å­¦CSS CSSè¯­æ³•æ³¨é‡Šæ–¹å¼CSSä¸­çš„æ³¨é‡Šä»¥/*å’Œå¼€å¤´*/ã€‚ 123456/* è®¾ç½®h1çš„æ ·å¼ */h1 &#123; color: blue; background-color: yellow; border: 1px solid black;&#125; å¼•å…¥æ–¹å¼å†…è”æ ·å¼å†…è”æ ·å¼æ˜¯CSSå£°æ˜åœ¨å…ƒç´ çš„styleå±æ€§ä¸­ï¼Œä»…å½±å“ä¸€ä¸ªå…ƒç´ ï¼š æ ¼å¼ï¼š 1&lt;æ ‡ç­¾ style=&quot;å±æ€§å:å±æ€§å€¼; å±æ€§å:å±æ€§å€¼;&quot;&gt;å†…å®¹&lt;/æ ‡ç­¾&gt; ä¾‹å¦‚ï¼š 123&lt;h1 style=&quot;color: blue;background-color: yellow;border: 1px solid black;&quot;&gt; Hello World!&lt;/h1&gt; æ•ˆæœï¼š Hello World! ç‰¹ç‚¹ï¼šæ ¼å¼ç®€å•ï¼Œä½†æ˜¯æ ·å¼ä½œç”¨æ— æ³•å¤ç”¨åˆ°å¤šä¸ªå…ƒç´ ä¸Šï¼Œä¸åˆ©äºç»´æŠ¤ å†…éƒ¨æ ·å¼è¡¨å†…éƒ¨æ ·å¼è¡¨æ˜¯å°†CSSæ ·å¼æ”¾åœ¨styleæ ‡ç­¾ä¸­ï¼Œé€šå¸¸styleæ ‡ç­¾ç¼–å†™åœ¨HTML çš„headæ ‡ç­¾å†…éƒ¨ã€‚ æ ¼å¼ï¼š 12345678&lt;head&gt; &lt;style&gt; é€‰æ‹©å™¨ &#123; å±æ€§å: å±æ€§å€¼; å±æ€§å: å±æ€§å€¼; &#125; &lt;/style&gt;&lt;/head&gt; ä¾‹å¦‚ï¼š 123456789&lt;head&gt; &lt;style&gt; h1 &#123; color: blue; background-color: yellow; border: 1px solid black; &#125; &lt;/style&gt; &lt;/head&gt; ç‰¹ç‚¹ï¼šå†…éƒ¨æ ·å¼åªèƒ½ä½œç”¨åœ¨å½“å‰é¡µé¢ä¸Šï¼Œå¦‚æœæ˜¯å¤šä¸ªé¡µé¢ï¼Œå°±æ— æ³•å¤ç”¨äº† å¤–éƒ¨æ ·å¼è¡¨å¤–éƒ¨æ ·å¼è¡¨æ˜¯CSSé™„åŠ åˆ°æ–‡æ¡£ä¸­çš„æœ€å¸¸è§å’Œæœ€æœ‰ç”¨çš„æ–¹æ³•ï¼Œå› ä¸ºæ‚¨å¯ä»¥å°†CSSæ–‡ä»¶é“¾æ¥åˆ°å¤šä¸ªé¡µé¢ï¼Œä»è€Œå…è®¸æ‚¨ä½¿ç”¨ç›¸åŒçš„æ ·å¼è¡¨è®¾ç½®æ‰€æœ‰é¡µé¢çš„æ ·å¼ã€‚ å¤–éƒ¨æ ·å¼è¡¨æ˜¯æŒ‡å°†CSSç¼–å†™åœ¨æ‰©å±•åä¸º.css çš„å•ç‹¬æ–‡ä»¶ä¸­ï¼Œå¹¶ä»HTML&lt;link&gt; å…ƒç´ å¼•ç”¨å®ƒï¼Œé€šå¸¸linkæ ‡ç­¾&#96;ç¼–å†™åœ¨HTML çš„[head]æ ‡ç­¾å†…éƒ¨ã€‚ æ ¼å¼ 1&lt;link rel=&quot;stylesheet&quot; href=&quot;cssæ–‡ä»¶&quot;&gt; relï¼šè¡¨ç¤ºâ€œå…³ç³» (relationship) â€ï¼Œå±æ€§å€¼æŒ‡é“¾æ¥æ–¹å¼ä¸åŒ…å«å®ƒçš„æ–‡æ¡£ä¹‹é—´çš„å…³ç³»ï¼Œå¼•å…¥cssæ–‡ä»¶å›ºå®šå€¼ä¸ºstylesheetã€‚ hrefï¼šå±æ€§éœ€è¦å¼•ç”¨æŸæ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ä¸ªæ–‡ä»¶ã€‚ ä¸¾ä¾‹ åˆ›å»ºstyles.cssæ–‡ä»¶ 12345h1 &#123; color: blue; background-color: yellow; border: 1px solid black;&#125; linkæ ‡ç­¾å¼•å…¥æ–‡ä»¶ 12345678910&lt;!DOCTYPE html&gt;&lt;html&gt; &lt;head&gt; &lt;meta charset=&quot;utf-8&quot;&gt; &lt;link rel=&quot;stylesheet&quot; href=&quot;styles.css&quot;&gt; &lt;/head&gt; &lt;body&gt; &lt;h1&gt;Hello World!&lt;/h1&gt; &lt;/body&gt;&lt;/html&gt; æ•ˆæœåŒä¸Š ä¸ºäº†CSSæ–‡ä»¶çš„ç®¡ç†ï¼Œåœ¨é¡¹ç›®ä¸­åˆ›å»ºä¸€ä¸ªcssæ–‡ä»¶å¤¹ï¼Œä¸“é—¨ä¿å­˜æ ·å¼æ–‡ä»¶ï¼Œå¹¶è°ƒæ•´æŒ‡å®šçš„è·¯å¾„ä»¥åŒ¹é… 12&lt;link rel=&quot;stylesheet&quot; href=&quot;../css/styles.css&quot;&gt;&lt;!--..ä»£è¡¨ä¸Šä¸€çº§ ç›¸å¯¹è·¯å¾„--&gt; ä¼˜å…ˆçº§è§„åˆ™å±‚å äºä¸€ä¸ªæ ·å¼è¡¨ä¸­ï¼Œå…¶ä¸­æ•°å­— 4 æ‹¥æœ‰æœ€é«˜çš„ä¼˜å…ˆæƒï¼š æµè§ˆå™¨ç¼ºçœè®¾ç½® å¤–éƒ¨æ ·å¼è¡¨ å†…éƒ¨æ ·å¼è¡¨ï¼ˆä½äº æ ‡ç­¾å†…éƒ¨ï¼‰ å†…è”æ ·å¼ï¼ˆåœ¨ HTML å…ƒç´ å†…éƒ¨ï¼‰ é€‰æ‹©å™¨ä»‹ç»é€‰æ‹©å™¨ä¸ºäº†æ ·å¼åŒ–æŸäº›å…ƒç´ ï¼Œæˆ‘ä»¬ä¼šé€šè¿‡é€‰æ‹©å™¨æ¥é€‰ä¸­HTMLæ–‡æ¡£ä¸­çš„è¿™äº›å…ƒç´ ï¼Œæ¯ä¸ªCSSè§„åˆ™éƒ½ä»¥ä¸€ä¸ªé€‰æ‹©å™¨æˆ–ä¸€ç»„é€‰æ‹©å™¨ä¸ºå¼€å§‹ï¼Œå»å‘Šè¯‰æµè§ˆå™¨è¿™äº›è§„åˆ™åº”è¯¥åº”ç”¨åˆ°å“ªäº›å…ƒç´ ä¸Šã€‚ é€‰æ‹©å™¨çš„åˆ†ç±»ï¼š åˆ†ç±» åç§° ç¬¦å· ä½œç”¨ ç¤ºä¾‹ åŸºæœ¬é€‰æ‹©å™¨ å…ƒç´ é€‰æ‹©å™¨ æ ‡ç­¾å åŸºäºæ ‡ç­¾ååŒ¹é…å…ƒç´  div{ } ç±»é€‰æ‹©å™¨ . åŸºäºclasså±æ€§å€¼åŒ¹é…å…ƒç´  .center{ } IDé€‰æ‹©å™¨ # åŸºäºidå±æ€§å€¼åŒ¹é…å…ƒç´  #username{ } é€šç”¨é€‰æ‹©å™¨ * åŒ¹é…æ–‡æ¡£ä¸­çš„æ‰€æœ‰å†…å®¹ *{ } å±æ€§é€‰æ‹©å™¨ å±æ€§é€‰æ‹©å™¨ [] åŸºäºæŸå±æ€§åŒ¹é…å…ƒç´  [type]{ } ä¼ªç±»é€‰æ‹©å™¨ ä¼ªç±»é€‰æ‹©å™¨ : ç”¨äºå‘æŸäº›é€‰æ‹©å™¨æ·»åŠ ç‰¹æ®Šçš„æ•ˆæœ a:hover{ } ç»„åˆé€‰æ‹©å™¨ åˆ†ç»„é€‰æ‹©å™¨ , ä½¿ç”¨ , å·ç»“åˆä¸¤ä¸ªé€‰æ‹©å™¨ï¼ŒåŒ¹é…ä¸¤ä¸ªé€‰æ‹©å™¨çš„å…ƒç´  span,p{} åä»£é€‰æ‹©å™¨ ç©ºæ ¼ ä½¿ç”¨ç©ºæ ¼ç¬¦å·ç»“åˆä¸¤ä¸ªé€‰æ‹©å™¨ï¼ŒåŸºäºç¬¬ä¸€ä¸ªé€‰æ‹©å™¨ï¼ŒåŒ¹é…ç¬¬äºŒä¸ªé€‰æ‹©å™¨çš„æ‰€æœ‰åä»£å…ƒç´  .top li{ } åŸºæœ¬é€‰æ‹©å™¨ é¡µé¢å…ƒç´ ï¼š 123456789&lt;body&gt; &lt;div&gt;div1&lt;/div&gt; &lt;div class=&quot;cls&quot;&gt;div2&lt;/div&gt; &lt;div class=&quot;cls&quot;&gt;div3&lt;/div&gt; &lt;div id=&quot;d1&quot;&gt;div4&lt;/div&gt; &lt;div id=&quot;d2&quot;&gt;div5&lt;/div&gt;&lt;/body&gt; å…ƒç´ é€‰æ‹©å™¨ 1234/*é€‰æ‹©æ‰€æœ‰divæ ‡ç­¾,å­—ä½“ä¸ºè“è‰²*/div&#123; color: red;&#125; ç±»é€‰æ‹©å™¨ 1234/*é€‰æ‹©classä¸ºclsçš„,å­—ä½“ä¸ºè“è‰²*/.cls&#123; color: blue;&#125; IDé€‰æ‹©å™¨ 12345678/*idé€‰æ‹©å™¨*/#d1&#123; color: green;/*idä¸ºd1çš„å­—ä½“å˜æˆç»¿è‰²*/&#125;#d2&#123; color: pink;/*idä¸ºd2çš„å­—ä½“å˜æˆç²‰è‰²*/&#125;/ é€šç”¨é€‰æ‹©å™¨ 1234/*æ‰€æœ‰æ ‡ç­¾ */*&#123; background-color: aqua;&#125; å±æ€§é€‰æ‹©å™¨ é¡µé¢ï¼š 12345&lt;body&gt; ç”¨æˆ·åï¼š&lt;input type=&quot;text&quot;/&gt; &lt;br/&gt; å¯†ç ï¼š&lt;input type=&quot;password&quot;/&gt; &lt;br&gt; é‚®ç®±ï¼š&lt;input type=&quot;email&quot;/&gt; &lt;br&gt;&lt;/body&gt; é€‰æ‹©å™¨ï¼š 12345678/*è¾“å…¥æ¡†ä¸­è¾“å…¥çš„å­—ç¬¦æ˜¯çº¢è‰²*/[type] &#123; color: red;&#125;/*è¾“å…¥æ¡†ä¸­è¾“å…¥çš„å­—ç¬¦æ˜¯è“è‰²*/[type=password] &#123; color: blue;&#125; ä¼ªç±»é€‰æ‹©å™¨ é¡µé¢å…ƒç´  123&lt;body&gt; &lt;a href=&quot;https://www.baidu.com&quot; target=&quot;_blank&quot;&gt;ç™¾åº¦ä¸€ä¸‹&lt;/a&gt;&lt;/body&gt; ä¼ªç±»é€‰æ‹©å™¨ 12345678910111213141516171819/*æœªè®¿é—®çš„çŠ¶æ€*/a:link&#123; color: black;&#125;/*å·²è®¿é—®çš„çŠ¶æ€*/a:visited&#123; color: blue;&#125;/*é¼ æ ‡æ‚¬æµ®çš„çŠ¶æ€*/a:hover&#123; color: red;&#125;/*å·²é€‰ä¸­çš„çŠ¶æ€*/a:active&#123; color: yellow;&#125; æ³¨æ„ï¼šä¼ªç±»é¡ºåº link ï¼Œvisitedï¼Œhoverï¼Œactiveï¼Œå¦åˆ™æœ‰å¯èƒ½å¤±æ•ˆã€‚ ç»„åˆé€‰æ‹©å™¨ é¡µé¢ï¼š 1234567891011121314151617&lt;body&gt; &lt;span&gt;span&lt;/span&gt; &lt;br/&gt; &lt;p&gt;æ®µè½&lt;/p&gt; &lt;div class=&quot;top&quot;&gt; &lt;ol&gt; &lt;li&gt;aa&lt;/li&gt; &lt;li&gt;bb&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt; &lt;div class=&quot;center&quot;&gt; &lt;ol&gt; &lt;li&gt;cc&lt;/li&gt; &lt;li&gt;dd&lt;/li&gt; &lt;/ol&gt; &lt;/div&gt;&lt;/body&gt; åˆ†ç»„é€‰æ‹©å™¨ 1234/*span pä¸¤ä¸ªæ ‡ç­¾ä¸‹çš„å­—ä½“ä¸ºè“è‰²*/span,p&#123; color: blue;&#125; åä»£é€‰æ‹©å™¨ 1234/*classä¸ºtopä¸‹çš„æ‰€æœ‰liæ ‡ç­¾å­—ä½“é¢œè‰²ä¸ºçº¢è‰²*/.top li&#123; color: red;&#125; ä¼˜å…ˆçº§é€‰æ‹©å™¨ä¼˜å…ˆçº§ IDé€‰æ‹©å™¨ &gt; ç±»é€‰æ‹©å™¨ &gt; æ ‡ç­¾é€‰æ‹©å™¨ &gt; é€šç”¨é€‰æ‹©å™¨ å¦‚æœä¼˜å…ˆçº§ç›¸åŒï¼Œé‚£ä¹ˆå°±æ»¡è¶³å°±è¿‘åŸåˆ™ è¾¹æ¡†æ ·å¼å•ä¸ªè¾¹æ¡† å•ä¸ªè¾¹æ¡†borderï¼šè¾¹æ¡†border-top: ä¸Šè¾¹æ¡†border-left: å·¦è¾¹æ¡†border-bottom: åº•è¾¹æ¡†border-right: å³è¾¹æ¡† æ— è¾¹æ¡†ï¼Œå½“borderå€¼ä¸ºnoneæ—¶ï¼Œå¯ä»¥è®©è¾¹æ¡†ä¸æ˜¾ç¤º 12345div &#123; width: 200px; height: 200px; border: none;&#125; åœ†è§’ é€šè¿‡ä½¿ç”¨[border-radius]å±æ€§è®¾ç½®ç›’å­çš„åœ†è§’ï¼Œè™½ç„¶èƒ½åˆ†åˆ«è®¾ç½®å››ä¸ªè§’ï¼Œä½†æ˜¯é€šå¸¸æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå€¼ï¼Œæ¥è®¾ç½®æ•´ä½“æ•ˆæœ 123456789101112131415161718192021222324#d1&#123; /*è®¾ç½®æ‰€æœ‰è¾¹æ¡†*/ /*border: 5px solid black;*/ /*è®¾ç½®ä¸Šè¾¹æ¡†*/ border-top: 5px solid black; /*è®¾ç½®å·¦è¾¹æ¡†*/ border-left: 5px double red; /*è®¾ç½®å³è¾¹æ¡†*/ border-right: 5px dotted blue; /*è®¾ç½®ä¸‹è¾¹æ¡†*/ border-bottom: 5px dashed pink; width: 150px; height: 150px;&#125;#d2&#123; border: 5px solid red; /*è®¾ç½®è¾¹æ¡†çš„å¼§åº¦*/ border-radius: 25px; width: 150px; height: 150px;&#125; 12345&lt;body&gt; &lt;div id=&quot;d1&quot;&gt;&lt;/div&gt; &lt;br/&gt; &lt;div id=&quot;d2&quot;&gt;&lt;/div&gt;&lt;/body&gt; è¾¹æ¡†è½®å»“è½®å»“outlineï¼šæ˜¯ç»˜åˆ¶äºå…ƒç´ å‘¨å›´çš„ä¸€æ¡çº¿ï¼Œä½äºè¾¹æ¡†è¾¹ç¼˜çš„å¤–å›´ï¼Œå¯èµ·åˆ°çªå‡ºå…ƒç´ çš„ä½œç”¨ å±æ€§å€¼ï¼šdoubleï¼šåŒå®çº¿ dottedï¼šåœ†ç‚¹ dashedï¼šè™šçº¿ noneï¼šæ—  123456789101112131415&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;æ ·å¼æ¼”ç¤º&lt;/title&gt; &lt;style&gt; input&#123; outline: dotted; &#125; &lt;/style&gt;&lt;/head&gt;&lt;body&gt; ç”¨æˆ·åï¼š&lt;input type=&quot;text&quot;/&gt; &lt;br/&gt;&lt;/body&gt;&lt;/html&gt; ç›’å­æ¨¡å‹æ¨¡å‹ä»‹ç»ç›’å­æ¨¡å‹æ˜¯é€šè¿‡è®¾ç½®å…ƒç´ æ¡†ä¸å…ƒç´ å†…å®¹å’Œå¤–éƒ¨å…ƒç´ çš„è¾¹è·ï¼Œè€Œè¿›è¡Œå¸ƒå±€çš„æ–¹å¼ã€‚ element : å…ƒç´ ã€‚ padding : å†…è¾¹è·ï¼Œä¹Ÿæœ‰èµ„æ–™å°†å…¶ç¿»è¯‘ä¸ºå¡«å……ã€‚ border : è¾¹æ¡†ã€‚ margin : å¤–è¾¹è·ï¼Œä¹Ÿæœ‰èµ„æ–™å°†å…¶ç¿»è¯‘ä¸ºç©ºç™½æˆ–ç©ºç™½è¾¹ã€‚ è¾¹è·å†…è¾¹è·ã€è¾¹æ¡†å’Œå¤–è¾¹è·éƒ½æ˜¯å¯é€‰çš„ï¼Œé»˜è®¤å€¼æ˜¯é›¶ã€‚åœ¨ CSS ä¸­ï¼Œwidth å’Œ height æŒ‡çš„æ˜¯å†…å®¹åŒºåŸŸçš„å®½åº¦å’Œé«˜åº¦ã€‚ å¤–è¾¹è·å•ç‹¬è®¾ç½®è¾¹æ¡†çš„å¤–è¾¹è·ï¼Œè®¾ç½®ä¸Šã€å³ã€ä¸‹ã€å·¦æ–¹å‘ï¼š 1234margin-topmargin-rightmargin-bottommargin-left margin: auto /*æµè§ˆå™¨è‡ªåŠ¨è®¡ç®—å¤–è¾¹è·ï¼Œå…·æœ‰å±…ä¸­æ•ˆæœã€‚*/ 123456* ä¸€ä¸ªå€¼ ```css /* æ‰€æœ‰ 4 ä¸ªå¤–è¾¹è·éƒ½æ˜¯ 10px */ margin:10px; ä¸¤ä¸ªå€¼ 12margin:10px 5px;/* ä¸Šå¤–è¾¹è·å’Œä¸‹å¤–è¾¹è·æ˜¯ 10px*/margin:10px auto;/*å³å¤–è¾¹è·å’Œå·¦å¤–è¾¹è·æ˜¯ 5px */ ä¸‰ä¸ªå€¼ 12/* ä¸Šå¤–è¾¹è·æ˜¯ 10pxï¼Œå³å¤–è¾¹è·å’Œå·¦å¤–è¾¹è·æ˜¯ 5pxï¼Œä¸‹å¤–è¾¹è·æ˜¯ 15px*/margin:10px 5px 15px; å››ä¸ªå€¼ 123/*ä¸Šå¤–è¾¹è·æ˜¯ 10pxï¼Œå³å¤–è¾¹è·æ˜¯ 5pxï¼Œä¸‹å¤–è¾¹è·æ˜¯ 15pxï¼Œå·¦å¤–è¾¹è·æ˜¯ 20px*//*ä¸Šå³ä¸‹å¤–*/margin:10px 5px 15px 20px; å†…è¾¹è·ä¸å¤–è¾¹è·ç±»ä¼¼ï¼Œå•ç‹¬è®¾ç½®è¾¹æ¡†çš„å†…è¾¹è·ï¼Œè®¾ç½®ä¸Šã€å³ã€ä¸‹ã€å·¦æ–¹å‘ï¼š 1234padding-toppadding-rightpadding-bottompadding-left å¸ƒå±€ åŸºæœ¬å¸ƒå±€ 12345678910111213141516171819&lt;style&gt; div&#123; border: 2px solid blue; &#125; .big&#123; width: 200px; height: 200px; &#125; .small&#123; width: 100px; height: 100px; margin: 30px;/* å¤–è¾¹è· */ &#125;&lt;/style&gt;&lt;div class=&quot;big&quot;&gt; &lt;div class=&quot;small&quot;&gt; &lt;/div&gt;&lt;/div å¢åŠ å†…è¾¹è·ä¼šå¢åŠ å…ƒç´ æ¡†çš„æ€»å°ºå¯¸ 1234567891011121314 &lt;style&gt; div&#123; border: 2px solid blue; &#125; .big&#123; width: 200px; height: 200px; padding: 30px;/*å†…è¾¹è· */ &#125; .small&#123; width: 100px; height: 100px; &#125;&lt;/style&gt; æ–‡æœ¬æ ·å¼åŸºæœ¬å±æ€§ å±æ€§å ä½œç”¨ å±æ€§å–å€¼ width å®½åº¦ height é«˜åº¦ color é¢œè‰² font-family å­—ä½“æ ·å¼ å®‹ä½“ã€æ¥·ä½“ font-size å­—ä½“å¤§å° px : åƒç´ ï¼Œæ–‡æœ¬é«˜åº¦åƒç´ ç»å¯¹æ•°å€¼ã€‚em : 1emç­‰äºå½“å‰å…ƒç´ çš„çˆ¶å…ƒç´ è®¾ç½®çš„å­—ä½“å¤§å°ï¼Œæ˜¯ç›¸å¯¹æ•°å€¼ text-decoration ä¸‹åˆ’çº¿ underline : ä¸‹åˆ’çº¿ overline : ä¸Šåˆ’çº¿ line-through : åˆ é™¤çº¿ none : ä¸è¦çº¿æ¡ text-align æ–‡æœ¬æ°´å¹³å¯¹é½ lef : å·¦å¯¹é½æ–‡æœ¬right : å³å¯¹é½æ–‡æœ¬center : ä½¿æ–‡æœ¬å±…ä¸­ justify : ä½¿æ–‡æœ¬æ•£å¸ƒï¼Œæ”¹å˜å•è¯é—´çš„é—´è·ï¼Œä½¿æ–‡æœ¬æ‰€æœ‰è¡Œå…·æœ‰ç›¸åŒå®½åº¦ã€‚ line-height è¡Œé«˜ï¼Œè¡Œé—´è· vertical-align æ–‡æœ¬å‚ç›´å¯¹é½ topï¼šå±…ä¸Š bottomï¼šå±…ä¸‹ middleï¼šå±…ä¸­ æˆ–è€…ç™¾åˆ†æ¯” display å…ƒç´ å¦‚ä½•æ˜¾ç¤º å¯ä»¥è®¾ç½®å—çº§å’Œè¡Œå†…å…ƒç´ çš„åˆ‡æ¢ï¼Œä¹Ÿå¯ä»¥è®¾ç½®å…ƒç´ éšè—inlineï¼šå†…è”å…ƒç´ (æ— æ¢è¡Œã€æ— é•¿å®½) blockï¼šå—çº§å…ƒç´ (æœ‰æ¢è¡Œ) inline-blockï¼šå†…è”å…ƒç´ (æœ‰é•¿å®½) noneï¼šéšè—å…ƒç´  12345678910111213div&#123; color: /*red*/ #ff0000; font-family: /*å®‹ä½“*/ å¾®è½¯é›…é»‘; font-size: 25px;/ text-decoration: none; text-align: center; line-height: 60px;&#125;span&#123; /*æ–‡å­—å‚ç›´å¯¹é½ topï¼šå±…ä¸Š bottomï¼šå±…ä¸‹ middleï¼šå±…ä¸­ ç™¾åˆ†æ¯”*/ vertical-align: 50%; /*å±…ä¸­å¯¹é½*/&#125; 123456789&lt;div&gt; æˆ‘æ˜¯æ–‡å­—&lt;/div&gt;&lt;div&gt; æˆ‘æ˜¯æ–‡å­—&lt;/div&gt;&lt;img src=&quot;../img/wx.png&quot; width=&quot;38px&quot; height=&quot;38px&quot;/&gt;&lt;span&gt;å¾®ä¿¡&lt;/span&gt; æ–‡æœ¬æ˜¾ç¤º å…ƒç´ æ˜¾ç¤º 1234567891011121314151617/* æŠŠåˆ—è¡¨é¡¹æ˜¾ç¤ºä¸ºå†…è”å…ƒç´ ï¼Œæ— é•¿å®½*/li &#123; display:inline;&#125;/* æŠŠspanå…ƒç´ ä½œä¸ºå—å…ƒç´ ï¼Œæœ‰æ¢è¡Œ*/span &#123; display:block;&#125;/* è¡Œå†…å—å…ƒç´ ï¼Œç»“åˆçš„è¡Œå†…å’Œå—çº§çš„ä¼˜ç‚¹ï¼Œæ—¢å¯ä»¥è¡Œå†…æ˜¾ç¤ºï¼Œåˆå¯ä»¥è®¾ç½®é•¿å®½ï¼Œ*/li &#123; display:inline-block;&#125;/*æ‰€æœ‰divåœ¨ä¸€è¡Œæ˜¾ç¤º*/div&#123; display: inline-block; width: 100px;&#125; å…ƒç´ éšè— å½“è®¾ç½®ä¸ºnoneæ—¶ï¼Œå¯ä»¥éšè—å…ƒç´ ã€‚ CSSæ¡ˆä¾‹12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364/*èƒŒæ™¯å›¾ç‰‡*/body&#123; background: url(&quot;../img/bg.png&quot;);&#125;/*ä¸­é—´è¡¨å•æ ·å¼*/.center&#123; background: white; /*èƒŒæ™¯è‰²*/ width: 40%; /*å®½åº¦*/ margin: auto; /*æ°´å¹³å±…ä¸­å¤–è¾¹è·*/ margin-top: 100px; /*ä¸Šå¤–è¾¹è·*/ border-radius: 15px; /*è¾¹æ¡†å¼§åº¦*/ text-align: center; /*æ–‡æœ¬æ°´å¹³å±…ä¸­*/&#125;/*è¡¨å¤´æ ·å¼*/thead th&#123; font-size: 30px; /*å­—ä½“å¤§å°*/ color: orangered; /*å­—ä½“é¢œè‰²*/&#125;/*è¡¨ä½“æç¤ºä¿¡æ¯æ ·å¼*/tbody label&#123; font-size: 20px; /*å­—ä½“å¤§å°*/&#125;/*è¡¨ä½“è¾“å…¥æ¡†æ ·å¼*/tbody input&#123; border: 1px solid gray; /*è¾¹æ¡†*/ border-radius: 5px; /*è¾¹æ¡†å¼§åº¦*/ width: 90%; /*è¾“å…¥æ¡†çš„å®½åº¦*/ height: 40px; /*è¾“å…¥æ¡†çš„é«˜åº¦*/ outline: none; /*å–æ¶ˆè½®å»“çš„æ ·å¼*/&#125;/*è¡¨åº•ç¡®å®šæŒ‰é’®æ ·å¼*/tfoot button&#123; border: 1px solid crimson; /*è¾¹æ¡†*/ border-radius: 5px; /*è¾¹æ¡†å¼§åº¦*/ width: 95%; /*å®½åº¦*/ height: 40px; /*é«˜åº¦*/ background: crimson; /*èƒŒæ™¯è‰²*/ color: white; /*æ–‡å­—çš„é¢œè‰²*/ font-size: 20px; /*å­—ä½“å¤§å°*/&#125;/*è¡¨è¡Œé«˜åº¦*/tr&#123; line-height: 60px; /*è¡Œé«˜*/&#125;/*åº•éƒ¨é¡µè„šæ ·å¼*/.footer&#123; width: 35%; /*å®½åº¦*/ margin: auto; /*æ°´å¹³å±…ä¸­å¤–è¾¹è·*/ font-size: 15px; /*å­—ä½“å¤§å°*/ color: gray; /*å­—ä½“é¢œè‰²*/&#125;/*è¶…é“¾æ¥æ ·å¼*/a&#123; text-decoration: none; /*å»é™¤è¶…é“¾æ¥çš„ä¸‹åˆ’çº¿*/ color: blue; /*è¶…é“¾æ¥é¢œè‰²*/&#125; 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;ç™»å½•é¡µé¢&lt;/title&gt; &lt;link rel=&quot;stylesheet&quot; href=&quot;../css/login.css&quot;/&gt;&lt;/head&gt;&lt;body&gt; &lt;!--é¡¶éƒ¨å…¬å¸å›¾æ ‡--&gt; &lt;div&gt; &lt;img src=&quot;../img/logo.png&quot;/&gt; &lt;/div&gt; &lt;!--ä¸­é—´è¡¨å•--&gt; &lt;div class=&quot;center&quot;&gt; &lt;form action=&quot;#&quot; method=&quot;get&quot; autocomplete=&quot;off&quot;&gt; &lt;table width=&quot;100%&quot;&gt; &lt;thead&gt; &lt;tr&gt; &lt;th colspan=&quot;2&quot;&gt;è´¦&amp;nbsp;å¯†&amp;nbsp;ç™»&amp;nbsp;å½•&lt;hr/&gt;&lt;/th&gt; &lt;/tr&gt; &lt;/thead&gt; &lt;tbody&gt; &lt;tr&gt; &lt;td&gt; &lt;label for=&quot;username&quot;&gt;è´¦å·&lt;/label&gt; &lt;/td&gt; &lt;td&gt; &lt;input type=&quot;text&quot; id=&quot;username&quot; name=&quot;username&quot; placeholder=&quot; è¯·è¾“å…¥è´¦å·&quot; required/&gt; &lt;/td&gt; &lt;/tr&gt; &lt;tr&gt; &lt;td&gt; &lt;label for=&quot;password&quot;&gt;å¯†ç &lt;/label&gt; &lt;/td&gt; &lt;td&gt; &lt;input type=&quot;password&quot; id=&quot;password&quot; name=&quot;password&quot; placeholder=&quot; è¯·è¾“å…¥å¯†ç &quot; required/&gt; &lt;/td&gt; &lt;/tr&gt; &lt;/tbody&gt; &lt;tfoot&gt; &lt;tr&gt; &lt;td colspan=&quot;2&quot;&gt; &lt;button type=&quot;submit&quot;&gt;ç¡®&amp;nbsp;å®š&lt;/button&gt; &lt;/td&gt; &lt;/tr&gt; &lt;/tfoot&gt; &lt;/table&gt; &lt;/form&gt; &lt;/div&gt; &lt;!--åº•éƒ¨é¡µè„š--&gt; &lt;div class=&quot;footer&quot;&gt; &lt;br/&gt;&lt;br/&gt; ç™»å½•/æ³¨å†Œå³è¡¨ç¤ºæ‚¨åŒæ„&amp;nbsp;&amp;nbsp; &lt;a href=&quot;#&quot; target=&quot;_blank&quot;&gt;ç”¨æˆ·åè®®&lt;/a&gt;&amp;nbsp;&amp;nbsp; å’Œ&amp;nbsp;&amp;nbsp; &lt;a href=&quot;#&quot; target=&quot;_blank&quot;&gt;éšç§æ¡æ¬¾&lt;/a&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;a href=&quot;#&quot; target=&quot;_blank&quot;&gt;å¿˜è®°å¯†ç ?&lt;/a&gt; &lt;/div&gt;&lt;/body&gt;&lt;/html&gt; HTTPç›¸å…³æ¦‚å¿µHTTPï¼šHyper Text Transfer Protocolï¼Œæ„ä¸ºè¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼Œæ˜¯å»ºç«‹åœ¨ TCP&#x2F;IP åè®®åŸºç¡€ä¸Šï¼ŒæŒ‡çš„æ˜¯æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´äº¤äº’å¿…é¡»éµå¾ªçš„ä¸€é—®ä¸€ç­”çš„è§„åˆ™ï¼Œå½¢å®¹è¿™ä¸ªè§„åˆ™ï¼šé—®ç­”æœºåˆ¶ã€æ¡æ‰‹æœºåˆ¶ HTTP åè®®æ˜¯ä¸€ä¸ªæ— çŠ¶æ€çš„é¢å‘è¿æ¥çš„åè®®ï¼ŒæŒ‡çš„æ˜¯åè®®å¯¹äºäº‹åŠ¡å¤„ç†æ²¡æœ‰è®°å¿†èƒ½åŠ›ï¼ŒæœåŠ¡å™¨ä¸çŸ¥é“å®¢æˆ·ç«¯æ˜¯ä»€ä¹ˆçŠ¶æ€ã€‚æ‰€ä»¥æ‰“å¼€ä¸€ä¸ªæœåŠ¡å™¨ä¸Šçš„ç½‘é¡µå’Œä¸Šä¸€æ¬¡æ‰“å¼€è¿™ä¸ªæœåŠ¡å™¨ä¸Šçš„ç½‘é¡µä¹‹é—´æ²¡æœ‰ä»»ä½•è”ç³» æ³¨æ„ï¼šæ— çŠ¶æ€å¹¶ä¸æ˜¯ä»£è¡¨ HTTP å°±æ˜¯ UDPï¼Œé¢å‘è¿æ¥ä¹Ÿä¸æ˜¯ä»£è¡¨ HTTP å°±æ˜¯TCP HTTP ä½œç”¨ï¼šç”¨äºå®šä¹‰ WEB æµè§ˆå™¨ä¸ WEB æœåŠ¡å™¨ä¹‹é—´äº¤æ¢æ•°æ®çš„è¿‡ç¨‹å’Œæ•°æ®æœ¬èº«çš„å†…å®¹ æµè§ˆå™¨å’ŒæœåŠ¡å™¨äº¤äº’è¿‡ç¨‹ï¼šæµè§ˆå™¨è¯·æ±‚ï¼ŒæœåŠ¡è¯·æ±‚å“åº” è¯·æ±‚ï¼ˆè¯·æ±‚è¡Œã€è¯·æ±‚å¤´ã€è¯·æ±‚ä½“ï¼‰ å“åº”ï¼ˆå“åº”è¡Œã€å“åº”å¤´ã€å“åº”ä½“ï¼‰ URL å’Œ URI URLï¼šç»Ÿä¸€èµ„æºå®šä½ç¬¦ æ ¼å¼ï¼šhttp://127.0.0.1:8080/request/servletDemo01 è¯¦è§£ï¼šhttpï¼šåè®®ï¼›127.0.0.1ï¼šåŸŸåï¼›8080ï¼šç«¯å£ï¼›request&#x2F;servletDemo01ï¼šè¯·æ±‚èµ„æºè·¯å¾„ URIï¼šç»Ÿä¸€èµ„æºæ ‡å¿—ç¬¦ æ ¼å¼ï¼š&#x2F;request&#x2F;servletDemo01 åŒºåˆ«ï¼šURL - HOST = URIï¼ŒURI æ˜¯æŠ½è±¡çš„å®šä¹‰ï¼ŒURL ç”¨åœ°å€å®šä½ï¼ŒURI ç”¨åç§°å®šä½ã€‚åªè¦èƒ½å”¯ä¸€æ ‡è¯†èµ„æºçš„æ˜¯ URIï¼Œåœ¨ URI çš„åŸºç¡€ä¸Šç»™å‡ºå…¶èµ„æºçš„è®¿é—®æ–¹å¼çš„æ˜¯ URL ä»æµè§ˆå™¨åœ°å€æ è¾“å…¥ URL åˆ°è¯·æ±‚è¿”å›å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ è¿›è¡Œ URL è§£æï¼Œè¿›è¡Œç¼–ç  DNS è§£æï¼Œé¡ºåºæ˜¯å…ˆæŸ¥ hosts æ–‡ä»¶æ˜¯å¦æœ‰è®°å½•ï¼Œæœ‰çš„è¯å°±ä¼šæŠŠç›¸å¯¹åº”æ˜ å°„çš„ IP è¿”å›ï¼Œç„¶åå»æœ¬åœ° DNS ç¼“å­˜ä¸­å¯»æ‰¾ï¼Œç„¶åä¾æ¬¡å‘æœ¬åœ°åŸŸåæœåŠ¡å™¨ã€æ ¹åŸŸåæœåŠ¡å™¨ã€é¡¶çº§åŸŸåæœåŠ¡å™¨ã€æƒé™åŸŸåæœåŠ¡å™¨å‘èµ·æŸ¥è¯¢è¯·æ±‚ï¼Œæœ€ç»ˆè¿”å› IP åœ°å€ç»™æœ¬åœ°åŸŸåæœåŠ¡å™¨ æœ¬åœ°åŸŸåæœåŠ¡å™¨å°†å¾—åˆ°çš„ IP åœ°å€è¿”å›ç»™æ“ä½œç³»ç»Ÿï¼ŒåŒæ—¶å°† IP åœ°å€ç¼“å­˜èµ·æ¥ï¼›æ“ä½œç³»ç»Ÿå°† IP åœ°å€è¿”å›ç»™æµè§ˆå™¨ï¼ŒåŒæ—¶è‡ªå·±ä¹Ÿå°† IP åœ°å€ç¼“å­˜èµ·æ¥ æŸ¥æ‰¾åˆ° IP ä¹‹åï¼Œè¿›è¡Œ TCP åè®®çš„ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥ å‘å‡º HTTP è¯·æ±‚ï¼Œå–æ–‡ä»¶æŒ‡ä»¤ æœåŠ¡å™¨å¤„ç†è¯·æ±‚ï¼Œè¿”å›å“åº” é‡Šæ”¾ TCP è¿æ¥ æµè§ˆå™¨è§£ææ¸²æŸ“é¡µé¢ æ¨èé˜…è¯»ï¼šhttps://xiaolincoding.com/network/ ç‰ˆæœ¬åŒºåˆ«ç‰ˆæœ¬ä»‹ç»ï¼š HTTP&#x2F;0.9 ä»…æ”¯æŒ GET è¯·æ±‚ï¼Œä¸æ”¯æŒè¯·æ±‚å¤´ HTTP&#x2F;1.0 é»˜è®¤çŸ­è¿æ¥ï¼ˆä¸€æ¬¡è¯·æ±‚å»ºè®®ä¸€æ¬¡ TCP è¿æ¥ï¼Œè¯·æ±‚å®Œå°±æ–­å¼€ï¼‰ï¼Œæ”¯æŒ GETã€POSTã€ HEAD è¯·æ±‚ HTTP&#x2F;1.1 é»˜è®¤é•¿è¿æ¥ï¼ˆä¸€æ¬¡ TCP è¿æ¥å¯ä»¥å¤šæ¬¡è¯·æ±‚ï¼‰ï¼›æ”¯æŒ PUTã€DELETEã€PATCH ç­‰å…­ç§è¯·æ±‚ï¼›å¢åŠ  HOST å¤´ï¼Œæ”¯æŒè™šæ‹Ÿä¸»æœºï¼›æ”¯æŒæ–­ç‚¹ç»­ä¼ åŠŸèƒ½ HTTP&#x2F;2.0 å¤šè·¯å¤ç”¨ï¼Œé™ä½å¼€é”€ï¼ˆä¸€æ¬¡ TCP è¿æ¥å¯ä»¥å¤„ç†å¤šä¸ªè¯·æ±‚ï¼‰ï¼›æœåŠ¡å™¨ä¸»åŠ¨æ¨é€ï¼ˆç›¸å…³èµ„æºä¸€ä¸ªè¯·æ±‚å…¨éƒ¨æ¨é€ï¼‰ï¼›è§£æåŸºäºäºŒè¿›åˆ¶ï¼Œè§£æé”™è¯¯å°‘ï¼Œæ›´é«˜æ•ˆï¼ˆHTTP&#x2F;1.X è§£æåŸºäºæ–‡æœ¬ï¼‰ï¼›æŠ¥å¤´å‹ç¼©ï¼Œé™ä½å¼€é”€ HTTP&#x2F;3.0 QUIC (Quick UDP Internet Connections)ï¼Œå¿«é€Ÿ UDP äº’è”ç½‘è¿æ¥ï¼ŒåŸºäº UDP åè®® HTTP 1.0 å’Œ HTTP 1.1 çš„ä¸»è¦åŒºåˆ«ï¼š é•¿çŸ­è¿æ¥ï¼š åœ¨HTTP&#x2F;1.0ä¸­ï¼Œé»˜è®¤ä½¿ç”¨çš„æ˜¯çŸ­è¿æ¥ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½è¦é‡æ–°å»ºç«‹ä¸€æ¬¡è¿æ¥ï¼Œæ¯”å¦‚è·å– HTML å’Œ CSS æ–‡ä»¶ï¼Œéœ€è¦ä¸¤æ¬¡è¯·æ±‚ã€‚HTTP åŸºäº TCP&#x2F;IP åè®®çš„ï¼Œæ¯ä¸€æ¬¡å»ºç«‹æˆ–è€…æ–­å¼€è¿æ¥éƒ½éœ€è¦ä¸‰æ¬¡æ¡æ‰‹å››æ¬¡æŒ¥æ‰‹ï¼Œå¼€é”€ä¼šæ¯”è¾ƒå¤§ HTTP 1.1èµ·ï¼Œé»˜è®¤ä½¿ç”¨é•¿è¿æ¥ ï¼Œé»˜è®¤å¼€å¯ Connection: keep-aliveï¼ŒKeep-Alive æœ‰ä¸€ä¸ªä¿æŒæ—¶é—´ï¼Œä¸ä¼šæ°¸ä¹…ä¿æŒè¿æ¥ã€‚æŒç»­è¿æ¥æœ‰éæµæ°´çº¿æ–¹å¼å’Œæµæ°´çº¿æ–¹å¼ ï¼Œæµæ°´çº¿æ–¹å¼æ˜¯å®¢æˆ·ç«¯åœ¨æ”¶åˆ° HTTP çš„å“åº”æŠ¥æ–‡ä¹‹å‰å°±èƒ½æ¥ç€å‘é€æ–°çš„è¯·æ±‚æŠ¥æ–‡ï¼Œéæµæ°´çº¿æ–¹å¼æ˜¯å®¢æˆ·ç«¯åœ¨æ”¶åˆ°å‰ä¸€ä¸ªå“åº”åæ‰èƒ½å‘é€ä¸‹ä¸€ä¸ªè¯·æ±‚ HTTP åè®®çš„é•¿è¿æ¥å’ŒçŸ­è¿æ¥ï¼Œå®è´¨ä¸Šæ˜¯ TCP åè®®çš„é•¿è¿æ¥å’ŒçŸ­è¿æ¥ é”™è¯¯çŠ¶æ€å“åº”ç ï¼šåœ¨ HTTP1.1 ä¸­æ–°å¢äº† 24 ä¸ªé”™è¯¯çŠ¶æ€å“åº”ç ï¼Œå¦‚ 409ï¼ˆConflictï¼‰è¡¨ç¤ºè¯·æ±‚çš„èµ„æºä¸èµ„æºçš„å½“å‰çŠ¶æ€å‘ç”Ÿå†²çªï¼Œ410ï¼ˆGoneï¼‰è¡¨ç¤ºæœåŠ¡å™¨ä¸Šçš„æŸä¸ªèµ„æºè¢«æ°¸ä¹…æ€§çš„åˆ é™¤ ç¼“å­˜å¤„ç†ï¼šåœ¨ HTTP1.0 ä¸­ä¸»è¦ä½¿ç”¨ header é‡Œçš„ If-Modified-Sinceï¼ŒExpires æ¥åšä¸ºç¼“å­˜åˆ¤æ–­çš„æ ‡å‡†ï¼ŒHTTP1.1 åˆ™å¼•å…¥äº†æ›´å¤šçš„ç¼“å­˜æ§åˆ¶ç­–ç•¥ï¼Œä¾‹å¦‚ Entity tagï¼ŒIf-Unmodified-Sinceï¼ŒIf-Matchï¼ŒIf-None-Matchç­‰ å¸¦å®½ä¼˜åŒ–åŠç½‘ç»œè¿æ¥çš„ä½¿ç”¨ï¼šHTTP1.0 å­˜åœ¨ä¸€äº›æµªè´¹å¸¦å®½çš„ç°è±¡ï¼Œä¾‹å¦‚å®¢æˆ·ç«¯åªéœ€è¦æŸä¸ªå¯¹è±¡çš„ä¸€éƒ¨åˆ†ï¼Œè€ŒæœåŠ¡å™¨å´å°†æ•´ä¸ªå¯¹è±¡é€è¿‡æ¥äº†ï¼Œå¹¶ä¸”ä¸æ”¯æŒæ–­ç‚¹ç»­ä¼ åŠŸèƒ½ï¼ŒHTTP1.1 åˆ™åœ¨è¯·æ±‚å¤´å¼•å…¥äº† range å¤´åŸŸï¼Œå…è®¸åªè¯·æ±‚èµ„æºçš„æŸä¸ªéƒ¨åˆ†ï¼Œå³è¿”å›ç æ˜¯ 206ï¼ˆPartial Contentï¼‰ï¼Œè¿™æ ·å°±æ–¹ä¾¿äº†å¼€å‘è€…è‡ªç”±çš„é€‰æ‹©ä»¥ä¾¿äºå……åˆ†åˆ©ç”¨å¸¦å®½å’Œè¿æ¥ HOST å¤´å¤„ç†ï¼šåœ¨ HTTP1.0 ä¸­è®¤ä¸ºæ¯å°æœåŠ¡å™¨éƒ½ç»‘å®šä¸€ä¸ªå”¯ä¸€çš„ IP åœ°å€ï¼Œå› æ­¤è¯·æ±‚æ¶ˆæ¯ä¸­çš„ URL å¹¶æ²¡æœ‰ä¼ é€’ä¸»æœºåã€‚HTTP1.1 æ—¶ä»£è™šæ‹Ÿä¸»æœºæŠ€æœ¯å‘å±•è¿…é€Ÿï¼Œåœ¨ä¸€å°ç‰©ç†æœåŠ¡å™¨ä¸Šå¯ä»¥å­˜åœ¨å¤šä¸ªè™šæ‹Ÿä¸»æœºï¼Œå¹¶ä¸”å…±äº«ä¸€ä¸ª IP åœ°å€ï¼Œæ•… HTTP1.1 å¢åŠ äº† HOST ä¿¡æ¯ HTTP 1.1 å’Œ HTTP 2.0 çš„ä¸»è¦åŒºåˆ«ï¼š æ–°çš„äºŒè¿›åˆ¶æ ¼å¼ï¼šHTTP1.1 åŸºäºæ–‡æœ¬æ ¼å¼ä¼ è¾“æ•°æ®ï¼ŒHTTP2.0 é‡‡ç”¨äºŒè¿›åˆ¶æ ¼å¼ä¼ è¾“æ•°æ®ï¼Œè§£ææ›´é«˜æ•ˆ å¤šè·¯å¤ç”¨ï¼šåœ¨ä¸€ä¸ªè¿æ¥é‡Œï¼Œå…è®¸åŒæ—¶å‘é€å¤šä¸ªè¯·æ±‚æˆ–å“åº”ï¼Œå¹¶ä¸”è¿™äº›è¯·æ±‚æˆ–å“åº”èƒ½å¤Ÿå¹¶è¡Œçš„ä¼ è¾“è€Œä¸è¢«é˜»å¡ï¼Œé¿å… HTTP1.1 å‡ºç°çš„é˜Ÿå¤´å µå¡é—®é¢˜ å¤´éƒ¨å‹ç¼©ï¼ŒHTTP1.1 çš„ header å¸¦æœ‰å¤§é‡ä¿¡æ¯ï¼Œè€Œä¸”æ¯æ¬¡éƒ½è¦é‡å¤å‘é€ï¼›HTTP2.0 æŠŠ header ä»æ•°æ®ä¸­åˆ†ç¦»ï¼Œå¹¶å°è£…æˆå¤´å¸§å’Œæ•°æ®å¸§ï¼Œä½¿ç”¨ç‰¹å®šç®—æ³•å‹ç¼©å¤´å¸§ã€‚å¹¶ä¸” HTTP2.0 åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯è®°å½•äº†ä¹‹å‰å‘é€çš„é”®å€¼å¯¹ï¼Œå¯¹äºç›¸åŒçš„æ•°æ®ä¸ä¼šé‡å¤å‘é€ã€‚æ¯”å¦‚è¯·æ±‚ A å‘é€äº†æ‰€æœ‰çš„å¤´ä¿¡æ¯å­—æ®µï¼Œè¯·æ±‚ B åˆ™åªéœ€è¦å‘é€å·®å¼‚æ•°æ®ï¼Œè¿™æ ·å¯ä»¥å‡å°‘å†—ä½™æ•°æ®ï¼Œé™ä½å¼€é”€ æœåŠ¡ç«¯æ¨é€ï¼šHTTP2.0 å…è®¸æœåŠ¡å™¨å‘å®¢æˆ·ç«¯æ¨é€èµ„æºï¼Œæ— éœ€å®¢æˆ·ç«¯å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨è·å– å®‰å…¨è¯·æ±‚HTTP å’Œ HTTPS çš„åŒºåˆ«ï¼š ç«¯å£ ï¼šHTTP é»˜è®¤ä½¿ç”¨ç«¯å£ 80ï¼ŒHTTPS é»˜è®¤ä½¿ç”¨ç«¯å£ 443 å®‰å…¨æ€§ï¼šHTTP åè®®è¿è¡Œåœ¨ TCP ä¹‹ä¸Šï¼Œæ‰€æœ‰ä¼ è¾“çš„å†…å®¹éƒ½æ˜¯æ˜æ–‡ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯éƒ½æ— æ³•éªŒè¯å¯¹æ–¹çš„èº«ä»½ï¼›HTTPS æ˜¯è¿è¡Œåœ¨ SSL&#x2F;TLS ä¹‹ä¸Šçš„ HTTP åè®®ï¼ŒSSL&#x2F;TLS è¿è¡Œåœ¨ TCP ä¹‹ä¸Šï¼Œæ‰€æœ‰ä¼ è¾“çš„å†…å®¹éƒ½ç»è¿‡åŠ å¯†ï¼ŒåŠ å¯†é‡‡ç”¨å¯¹ç§°åŠ å¯†ï¼Œä½†å¯¹ç§°åŠ å¯†çš„å¯†é’¥ç”¨æœåŠ¡å™¨æ–¹çš„è¯ä¹¦è¿›è¡Œäº†éå¯¹ç§°åŠ å¯† èµ„æºæ¶ˆè€—ï¼šHTTP å®‰å…¨æ€§æ²¡æœ‰ HTTPS é«˜ï¼Œä½†æ˜¯ HTTPS æ¯” HTTP è€—è´¹æ›´å¤šæœåŠ¡å™¨èµ„æº å¯¹ç§°åŠ å¯†å’Œéå¯¹ç§°åŠ å¯† å¯¹ç§°åŠ å¯†ï¼šåŠ å¯†å’Œè§£å¯†ä½¿ç”¨åŒä¸€ä¸ªç§˜é’¥ï¼ŒæŠŠå¯†é’¥è½¬å‘ç»™éœ€è¦å‘é€æ•°æ®çš„å®¢æˆ·æœºï¼Œä¸­é€”ä¼šè¢«æ‹¦æˆªï¼ˆç±»ä¼¼äºæŠŠå¸¦é”çš„ç®±å­å’Œé’¥åŒ™ç»™åˆ«äººï¼Œå¯¹æ–¹æ‰“å¼€ç®±å­æ”¾å…¥æ•°æ®ï¼Œä¸Šé”åå‘é€ï¼‰ï¼Œç§é’¥ç”¨æ¥è§£å¯†æ•°æ®ï¼Œå…¸å‹çš„å¯¹ç§°åŠ å¯†ç®—æ³•æœ‰ DESã€AES ç­‰ ä¼˜ç‚¹ï¼šè¿ç®—é€Ÿåº¦å¿« ç¼ºç‚¹ï¼šæ— æ³•å®‰å…¨çš„å°†å¯†é’¥ä¼ è¾“ç»™é€šä¿¡æ–¹ éå¯¹ç§°åŠ å¯†ï¼šåŠ å¯†å’Œè§£å¯†ä½¿ç”¨ä¸åŒçš„ç§˜é’¥ï¼Œä¸€æŠŠä½œä¸ºå…¬å¼€çš„å…¬é’¥ï¼Œå¦ä¸€æŠŠä½œä¸ºç§é’¥ï¼Œå…¬é’¥å…¬å¼€ç»™ä»»ä½•äººï¼ˆç±»ä¼¼äºæŠŠé”å’Œç®±å­ç»™åˆ«äººï¼Œå¯¹æ–¹æ‰“å¼€ç®±å­æ”¾å…¥æ•°æ®ï¼Œä¸Šé”åå‘é€ï¼‰ï¼Œå…¸å‹çš„éå¯¹ç§°åŠ å¯†ç®—æ³•æœ‰ RSAã€DSA ç­‰ å…¬é’¥åŠ å¯†ï¼Œç§é’¥è§£å¯†ï¼šä¸ºäº†ä¿è¯å†…å®¹ä¼ è¾“çš„å®‰å…¨ï¼Œå› ä¸ºè¢«å…¬é’¥åŠ å¯†çš„å†…å®¹ï¼Œå…¶ä»–äººæ˜¯æ— æ³•è§£å¯†çš„ï¼Œåªæœ‰æŒæœ‰ç§é’¥çš„äººï¼Œæ‰èƒ½è§£å¯†å‡ºå®é™…çš„å†…å®¹ ç§é’¥åŠ å¯†ï¼Œå…¬é’¥è§£å¯†ï¼šä¸ºäº†ä¿è¯æ¶ˆæ¯ä¸ä¼šè¢«å†’å……ï¼Œå› ä¸ºç§é’¥æ˜¯ä¸å¯æ³„éœ²çš„ï¼Œå¦‚æœå…¬é’¥èƒ½æ­£å¸¸è§£å¯†å‡ºç§é’¥åŠ å¯†çš„å†…å®¹ï¼Œå°±èƒ½è¯æ˜è¿™ä¸ªæ¶ˆæ¯æ˜¯æ¥æºäºæŒæœ‰ç§é’¥èº«ä»½çš„äººå‘é€çš„ å¯ä»¥æ›´å®‰å…¨åœ°å°†å…¬å¼€å¯†é’¥ä¼ è¾“ç»™é€šä¿¡å‘é€æ–¹ï¼Œä½†æ˜¯è¿ç®—é€Ÿåº¦æ…¢ ä½¿ç”¨å¯¹ç§°åŠ å¯†å’Œéå¯¹ç§°åŠ å¯†çš„æ–¹å¼ä¼ é€æ•°æ® ä½¿ç”¨éå¯¹ç§°å¯†é’¥åŠ å¯†æ–¹å¼ï¼Œä¼ è¾“å¯¹ç§°å¯†é’¥åŠ å¯†æ–¹å¼æ‰€éœ€è¦çš„ Secret Keyï¼Œä»è€Œä¿è¯å®‰å…¨æ€§ è·å–åˆ° Secret Key åï¼Œå†ä½¿ç”¨å¯¹ç§°å¯†é’¥åŠ å¯†æ–¹å¼è¿›è¡Œé€šä¿¡ï¼Œä»è€Œä¿è¯æ•ˆç‡ æ€æƒ³ï¼šé”ä¸ŠåŠ é” åè¯è§£é‡Šï¼š å“ˆå¸Œç®—æ³•ï¼šé€šè¿‡å“ˆå¸Œå‡½æ•°è®¡ç®—å‡ºå†…å®¹çš„å“ˆå¸Œå€¼ï¼Œä¼ è¾“åˆ°å¯¹ç«¯åä¼šé‡æ–°è®¡ç®—å†…å®¹çš„å“ˆå¸Œï¼Œè¿›è¡Œå“ˆå¸Œæ¯”å¯¹æ¥æ ¡éªŒå†…å®¹çš„å®Œæ•´æ€§ æ•°å­—ç­¾åï¼šé™„åŠ åœ¨æŠ¥æ–‡ä¸Šçš„ç‰¹æ®ŠåŠ å¯†æ ¡éªŒç ï¼Œå¯ä»¥é˜²æ­¢æŠ¥æ–‡è¢«ç¯¡æ”¹ã€‚ä¸€èˆ¬æ˜¯é€šè¿‡ç§é’¥å¯¹å†…å®¹çš„å“ˆå¸Œå€¼è¿›è¡ŒåŠ å¯†ï¼Œå…¬é’¥æ­£å¸¸è§£å¯†å¹¶å¯¹æ¯”å“ˆå¸Œå€¼åï¼Œå¯ä»¥ç¡®ä¿è¯¥å†…å®¹å°±æ˜¯å¯¹ç«¯å‘å‡ºçš„ï¼Œé˜²æ­¢å‡ºç°ä¸­é—´äººæ›¿æ¢çš„é—®é¢˜ æ•°å­—è¯ä¹¦ï¼šç”±æƒå¨æœºæ„ç»™æŸç½‘ç«™é¢å‘çš„ä¸€ç§è®¤å¯å‡­è¯ HTTPS å·¥ä½œæµç¨‹ï¼šæœåŠ¡å™¨ç«¯çš„å…¬é’¥å’Œç§é’¥ï¼Œç”¨æ¥è¿›è¡Œéå¯¹ç§°åŠ å¯†ï¼Œå®¢æˆ·ç«¯ç”Ÿæˆçš„éšæœºå¯†é’¥ï¼Œç”¨æ¥è¿›è¡Œå¯¹ç§°åŠ å¯† å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘èµ· HTTPS è¯·æ±‚ï¼Œè¿æ¥åˆ°æœåŠ¡å™¨çš„ 443 ç«¯å£ï¼Œè¯·æ±‚æºå¸¦äº†æµè§ˆå™¨æ”¯æŒçš„åŠ å¯†ç®—æ³•å’Œå“ˆå¸Œç®—æ³•ï¼Œåå•†åŠ å¯†ç®—æ³• æœåŠ¡å™¨ç«¯ä¼šå‘æ•°å­—è¯ä¹¦è®¤è¯æœºæ„æ³¨å†Œå…¬å¼€å¯†é’¥ï¼Œè®¤è¯æœºæ„ç”¨ CA ç§é’¥å¯¹å…¬å¼€å¯†é’¥åšæ•°å­—ç­¾ååç»‘å®šåœ¨æ•°å­—è¯ä¹¦ï¼ˆåˆå«å…¬é’¥è¯ä¹¦ï¼Œå†…å®¹æœ‰å…¬é’¥ï¼Œç½‘ç«™åœ°å€ï¼Œè¯ä¹¦é¢å‘æœºæ„ï¼Œå¤±æ•ˆæ—¥æœŸç­‰ï¼‰ æœåŠ¡å™¨å°†æ•°å­—è¯ä¹¦å‘é€ç»™å®¢æˆ·ç«¯ï¼Œç§é’¥ç”±æœåŠ¡å™¨æŒæœ‰ å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨ç«¯çš„æ•°å­—è¯ä¹¦åé€šè¿‡ CA å…¬é’¥ï¼ˆäº‹å…ˆç½®å…¥æµè§ˆå™¨æˆ–æ“ä½œç³»ç»Ÿï¼‰å¯¹è¯ä¹¦è¿›è¡Œæ£€æŸ¥ï¼ŒéªŒè¯å…¶åˆæ³•æ€§ã€‚å¦‚æœå…¬é’¥åˆæ ¼ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ä¼šç”Ÿæˆä¸€ä¸ªéšæœºå€¼ï¼Œè¿™ä¸ªéšæœºå€¼å°±æ˜¯ç”¨äºè¿›è¡Œå¯¹ç§°åŠ å¯†çš„å¯†é’¥ï¼Œå°†è¯¥å¯†é’¥ç§°ä¹‹ä¸º client keyï¼ˆå®¢æˆ·ç«¯å¯†é’¥ã€ä¼šè¯å¯†é’¥ï¼‰ã€‚ç”¨æœåŠ¡å™¨çš„å…¬é’¥å¯¹å®¢æˆ·ç«¯å¯†é’¥è¿›è¡Œéå¯¹ç§°åŠ å¯†ï¼Œè¿™æ ·å®¢æˆ·ç«¯å¯†é’¥å°±å˜æˆå¯†æ–‡ï¼ŒHTTPS ä¸­çš„ç¬¬ä¸€æ¬¡ HTTP è¯·æ±‚ç»“æŸ å®¢æˆ·ç«¯ä¼šå‘èµ· HTTPS ä¸­çš„ç¬¬äºŒä¸ª HTTP è¯·æ±‚ï¼Œå°†åŠ å¯†ä¹‹åçš„å®¢æˆ·ç«¯å¯†é’¥å‘é€ç»™æœåŠ¡å™¨ æœåŠ¡å™¨æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘æ¥çš„å¯†æ–‡ä¹‹åï¼Œä¼šç”¨è‡ªå·±çš„ç§é’¥å¯¹å…¶è¿›è¡Œéå¯¹ç§°è§£å¯†ï¼Œè§£å¯†ä¹‹åçš„æ˜æ–‡å°±æ˜¯å®¢æˆ·ç«¯å¯†é’¥ï¼Œç„¶åç”¨å®¢æˆ·ç«¯å¯†é’¥å¯¹æ•°æ®è¿›è¡Œå¯¹ç§°åŠ å¯†ï¼Œè¿™æ ·æ•°æ®å°±å˜æˆäº†å¯†æ–‡ æœåŠ¡å™¨å°†åŠ å¯†åçš„å¯†æ–‡å‘é€ç»™å®¢æˆ·ç«¯ å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨å‘é€æ¥çš„å¯†æ–‡ï¼Œç”¨å®¢æˆ·ç«¯å¯†é’¥å¯¹å…¶è¿›è¡Œå¯¹ç§°è§£å¯†ï¼Œå¾—åˆ°æœåŠ¡å™¨å‘é€çš„æ•°æ®ï¼Œè¿™æ · HTTPS ä¸­çš„ç¬¬äºŒä¸ª HTTP è¯·æ±‚ç»“æŸï¼Œæ•´ä¸ª HTTPS ä¼ è¾“å®Œæˆ å‚è€ƒæ–‡ç« ï¼šhttps://www.cnblogs.com/linianhui/p/security-https-workflow.html å‚è€ƒæ–‡ç« ï¼šhttps://www.jianshu.com/p/14cd2c9d2cd2 è¯·æ±‚éƒ¨åˆ†è¯·æ±‚è¡Œï¼š æ°¸è¿œä½äºè¯·æ±‚çš„ç¬¬ä¸€è¡Œ è¯·æ±‚å¤´ï¼š ä»ç¬¬äºŒè¡Œå¼€å§‹ï¼Œåˆ°ç¬¬ä¸€ä¸ªç©ºè¡Œç»“æŸ è¯·æ±‚ä½“ï¼š ä»ç¬¬ä¸€ä¸ªç©ºè¡Œåå¼€å§‹ï¼Œåˆ°æ­£æ–‡çš„ç»“æŸï¼ˆGET æ²¡æœ‰ï¼‰ è¯·æ±‚æ–¹å¼ POST GET 123456789101112ã€è¯·æ±‚è¡Œã€‘GET /myApp/success.html?username=zs&amp;password=123456 HTTP/1.1ã€è¯·æ±‚å¤´ã€‘Accept: text/html, application/xhtml+xml, */*; X-HttpWatch-RID: 41723-10011Referer: http://localhost:8080/myApp/login.htmlAccept-Language: zh-Hans-CN,zh-Hans;q=0.5User-Agent: Mozilla/5.0 (MSIE 9.0; qdesk 2.4.1266.203; Windows NT 6.3; WOW64; Trident/7.0; rv:11.0) like GeckoAccept-Encoding: gzip, deflateHost: localhost:8080Connection: Keep-AliveCookie: Idea-b77ddca6=4bc282fe-febf-4fd1-b6c9-72e9e0f381e8 GET å’Œ POST æ¯”è¾ƒ ä½œç”¨ï¼šGET ç”¨äºè·å–èµ„æºï¼Œè€Œ POST ç”¨äºä¼ è¾“å®ä½“ä¸»ä½“ å‚æ•°ï¼šGET å’Œ POST çš„è¯·æ±‚éƒ½èƒ½ä½¿ç”¨é¢å¤–çš„å‚æ•°ï¼Œä½†æ˜¯ GET çš„å‚æ•°æ˜¯ä»¥æŸ¥è¯¢å­—ç¬¦ä¸²å‡ºç°åœ¨ URL ä¸­ï¼Œè€Œ POST çš„å‚æ•°å­˜å‚¨åœ¨å®ä½“ä¸»ä½“ä¸­ï¼ˆGET ä¹Ÿæœ‰è¯·æ±‚ä½“ï¼ŒPOST ä¹Ÿå¯ä»¥é€šè¿‡ URL ä¼ è¾“å‚æ•°ï¼‰ã€‚ä¸èƒ½å› ä¸º POST å‚æ•°å­˜å‚¨åœ¨å®ä½“ä¸»ä½“ä¸­å°±è®¤ä¸ºå®ƒçš„å®‰å…¨æ€§æ›´é«˜ï¼Œå› ä¸ºç…§æ ·å¯ä»¥é€šè¿‡ä¸€äº›æŠ“åŒ…å·¥å…·ï¼ˆFiddlerï¼‰æŸ¥çœ‹ å®‰å…¨ï¼šå®‰å…¨çš„ HTTP æ–¹æ³•ä¸ä¼šæ”¹å˜æœåŠ¡å™¨çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒåªæ˜¯å¯è¯»çš„ã€‚GET æ–¹æ³•æ˜¯å®‰å…¨çš„ï¼Œè€Œ POST ä¸æ˜¯ï¼Œå› ä¸º POST çš„ç›®çš„æ˜¯ä¼ é€å®ä½“ä¸»ä½“å†…å®¹ å®‰å…¨çš„æ–¹æ³•é™¤äº† GET ä¹‹å¤–è¿˜æœ‰ï¼šHEADã€OPTIONS ä¸å®‰å…¨çš„æ–¹æ³•é™¤äº† POST ä¹‹å¤–è¿˜æœ‰ PUTã€DELETE å¹‚ç­‰æ€§ï¼šåŒæ ·çš„è¯·æ±‚è¢«æ‰§è¡Œä¸€æ¬¡ä¸è¿ç»­æ‰§è¡Œå¤šæ¬¡çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼ŒæœåŠ¡å™¨çš„çŠ¶æ€ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œæ‰€æœ‰çš„å®‰å…¨æ–¹æ³•ä¹Ÿéƒ½æ˜¯å¹‚ç­‰çš„ã€‚åœ¨æ­£ç¡®å®ç°æ¡ä»¶ä¸‹ï¼ŒGETï¼ŒHEADï¼ŒPUT å’Œ DELETE ç­‰æ–¹æ³•éƒ½æ˜¯å¹‚ç­‰çš„ï¼ŒPOST æ–¹æ³•ä¸æ˜¯ å¯ç¼“å­˜ï¼šå¦‚æœè¦å¯¹å“åº”è¿›è¡Œç¼“å­˜ï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ è¯·æ±‚æŠ¥æ–‡çš„ HTTP æ–¹æ³•æœ¬èº«æ˜¯å¯ç¼“å­˜çš„ï¼ŒåŒ…æ‹¬ GET å’Œ HEADï¼Œä½†æ˜¯ PUT å’Œ DELETE ä¸å¯ç¼“å­˜ï¼ŒPOST åœ¨å¤šæ•°æƒ…å†µä¸‹ä¸å¯ç¼“å­˜ å“åº”æŠ¥æ–‡çš„çŠ¶æ€ç æ˜¯å¯ç¼“å­˜çš„ï¼ŒåŒ…æ‹¬ï¼š200ã€203ã€204ã€206ã€300ã€301ã€404ã€405ã€410ã€414 and 501 å“åº”æŠ¥æ–‡çš„ Cache-Control é¦–éƒ¨å­—æ®µæ²¡æœ‰æŒ‡å®šä¸è¿›è¡Œç¼“å­˜ PUT å’Œ POST çš„åŒºåˆ« PUT è¯·æ±‚ï¼šå¦‚æœä¸¤ä¸ªè¯·æ±‚ç›¸åŒï¼Œåä¸€ä¸ªè¯·æ±‚ä¼šæŠŠç¬¬ä¸€ä¸ªè¯·æ±‚è¦†ç›–æ‰ï¼ˆå¹‚ç­‰ï¼‰ï¼Œæ‰€ä»¥ PUT ç”¨æ¥ä¿®æ”¹èµ„æº POST è¯·æ±‚ï¼šåä¸€ä¸ªè¯·æ±‚ä¸ä¼šæŠŠç¬¬ä¸€ä¸ªè¯·æ±‚è¦†ç›–æ‰ï¼ˆéå¹‚ç­‰ï¼‰ï¼Œæ‰€ä»¥ POST ç”¨æ¥åˆ›å»ºèµ„æº PATCH æ–¹æ³• æ˜¯æ–°å¼•å…¥çš„ï¼Œæ˜¯å¯¹ PUT æ–¹æ³•çš„è¡¥å……ï¼Œç”¨æ¥å¯¹å·²çŸ¥èµ„æºè¿›è¡Œå±€éƒ¨æ›´æ–° è¯·æ±‚è¡Œè¯¦è§£ 12GET /myApp/success.html?username=zs&amp;password=123456 HTTP/1.1 POST /myApp/success.html HTTP/1.1 å†…å®¹ è¯´æ˜ GET&#x2F;POST è¯·æ±‚çš„æ–¹å¼ã€‚ &#x2F;myApp&#x2F;success.html è¯·æ±‚çš„èµ„æºã€‚ HTTP&#x2F;1.1 ä½¿ç”¨çš„åè®®ï¼ŒåŠåè®®çš„ç‰ˆæœ¬ã€‚ è¯·æ±‚å¤´è¯¦è§£ ä»ç¬¬ 2 è¡Œåˆ°ç©ºè¡Œå¤„ï¼Œéƒ½å«è¯·æ±‚å¤´ï¼Œä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜åœ¨ï¼Œä½†å­˜åœ¨ä¸€ä¸ª key å¯¹åº”å¤šä¸ªå€¼çš„è¯·æ±‚å¤´ å†…å®¹ è¯´æ˜ Accept å‘ŠçŸ¥æœåŠ¡å™¨ï¼Œå®¢æˆ·æµè§ˆå™¨æ”¯æŒçš„ MIME ç±»å‹ User-Agent æµè§ˆå™¨ç›¸å…³ä¿¡æ¯ Accept-Charset å‘Šè¯‰æœåŠ¡å™¨ï¼Œå®¢æˆ·æµè§ˆå™¨æ”¯æŒå“ªç§å­—ç¬¦é›† Accept-Encoding å‘ŠçŸ¥æœåŠ¡å™¨ï¼Œå®¢æˆ·æµè§ˆå™¨æ”¯æŒçš„å‹ç¼©ç¼–ç æ ¼å¼ï¼Œå¸¸ç”¨ gzip å‹ç¼© Accept-Language å‘ŠçŸ¥æœåŠ¡å™¨ï¼Œå®¢æˆ·æµè§ˆå™¨æ”¯æŒçš„è¯­è¨€ï¼Œzh_CN æˆ– en_US ç­‰ Host åˆå§‹ URL ä¸­çš„ä¸»æœºå’Œç«¯å£ Referer å‘ŠçŸ¥æœåŠ¡å™¨ï¼Œå½“å‰è¯·æ±‚çš„æ¥æºã€‚åªæœ‰å½“å‰è¯·æ±‚æœ‰æ¥æºï¼Œæ‰æœ‰è¿™ä¸ªæ¶ˆæ¯å¤´ã€‚ä½œç”¨ï¼š1 æŠ•æ”¾å¹¿å‘Š 2 é˜²ç›—é“¾ Content-Type å‘ŠçŸ¥æœåŠ¡å™¨ï¼Œè¯·æ±‚æ­£æ–‡çš„ MIME ç±»å‹ï¼Œæ–‡ä»¶ä¼ è¾“çš„ç±»å‹ï¼Œapplication&#x2F;x-www-form-urlencoded Content-Length å‘ŠçŸ¥æœåŠ¡å™¨ï¼Œè¯·æ±‚æ­£æ–‡çš„é•¿åº¦ã€‚ Connection è¡¨ç¤ºæ˜¯å¦éœ€è¦æŒä¹…è¿æ¥ï¼Œä¸€èˆ¬æ˜¯ Keep -Aliveï¼ˆHTTP 1.1 é»˜è®¤è¿›è¡ŒæŒä¹…è¿æ¥ ) If-Modified-Since å‘ŠçŸ¥æœåŠ¡å™¨ï¼Œå®¢æˆ·æµè§ˆå™¨ç¼“å­˜æ–‡ä»¶çš„æœ€åä¿®æ”¹æ—¶é—´ Cookie ä¼šè¯ç®¡ç†ç›¸å…³ï¼ˆéå¸¸çš„é‡è¦ï¼‰ è¯·æ±‚ä½“è¯¦è§£ åªæœ‰ POST è¯·æ±‚æ–¹å¼ï¼Œæ‰æœ‰è¯·æ±‚çš„æ­£æ–‡ï¼ŒGET æ–¹å¼çš„æ­£æ–‡æ˜¯åœ¨åœ°å€æ ä¸­çš„ è¡¨å•çš„è¾“å…¥åŸŸæœ‰ name å±æ€§çš„æ‰ä¼šè¢«æäº¤ï¼Œä¸åˆ† GET å’Œ POST çš„è¯·æ±‚æ–¹å¼ è¡¨å•çš„ enctype å±æ€§å–å€¼å†³å®šäº†è¯·æ±‚æ­£æ–‡çš„ä½“ç°å½¢å¼ enctypeå–å€¼ è¯·æ±‚æ­£æ–‡ä½“ç°å½¢å¼ ç¤ºä¾‹ application&#x2F;x-www-form-urlencoded key&#x3D;value&amp;key&#x3D;value username&#x3D;test&amp;password&#x3D;1234 multipart&#x2F;form-data æ­¤æ—¶å˜æˆäº†å¤šéƒ¨åˆ†è¡¨å•æ•°æ®ã€‚å¤šéƒ¨åˆ†æ˜¯é åˆ†éš”ç¬¦åˆ†éš”çš„ã€‚ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€“7df23a16c0210Content-Disposition: form-data; name&#x3D;â€usernameâ€testâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€“7df23a16c0210Content-Disposition: form-data; name&#x3D;â€passwordâ€1234â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-7df23a16c0210 å“åº”éƒ¨åˆ†å“åº”éƒ¨åˆ†å›¾ï¼š å“åº”è¡Œ HTTP&#x2F;1.1ï¼šä½¿ç”¨åè®®çš„ç‰ˆæœ¬ 200ï¼šå“åº”çŠ¶æ€ç  OKï¼šçŠ¶æ€ç æè¿° å“åº”çŠ¶æ€ç ï¼š çŠ¶æ€ç  è¯´æ˜ 200 ä¸€åˆ‡éƒ½ OKï¼Œä¸æœåŠ¡å™¨è¿æ¥æˆåŠŸï¼Œå‘é€è¯·æ±‚æˆåŠŸ 302&#x2F;307 è¯·æ±‚é‡å®šå‘ï¼ˆå®¢æˆ·ç«¯è¡Œä¸ºï¼Œä¸¤æ¬¡è¯·æ±‚ï¼Œåœ°å€æ å‘ç”Ÿæ”¹å˜ï¼‰ 304 è¯·æ±‚èµ„æºæœªæ”¹å˜ï¼Œä½¿ç”¨ç¼“å­˜ 400 å®¢æˆ·ç«¯é”™è¯¯ï¼Œè¯·æ±‚é”™è¯¯ï¼Œæœ€å¸¸è§çš„å°±æ˜¯è¯·æ±‚å‚æ•°æœ‰é—®é¢˜ 403 å®¢æˆ·ç«¯é”™è¯¯ï¼Œä½† forbidden æƒé™ä¸å¤Ÿï¼Œæ‹’ç»å¤„ç† 404 å®¢æˆ·ç«¯é”™è¯¯ï¼Œè¯·æ±‚èµ„æºæœªæ‰¾åˆ° 500 æœåŠ¡å™¨é”™è¯¯ï¼ŒæœåŠ¡å™¨è¿è¡Œå†…éƒ¨é”™è¯¯ è½¬ç§»ï¼š 301 redirectï¼š301 ä»£è¡¨æ°¸ä¹…æ€§è½¬ç§» (Permanently Moved) 302 redirectï¼š302 ä»£è¡¨æš‚æ—¶æ€§è½¬ç§» (Temporarily Moved ) å“åº”å¤´ï¼šä»¥ key:vaue å­˜åœ¨ï¼Œå¯èƒ½å¤šä¸ª value æƒ…å†µ æ¶ˆæ¯å¤´ è¯´æ˜ Location è¯·æ±‚é‡å®šå‘çš„åœ°å€ï¼Œå¸¸ä¸ 302ï¼Œ307 é…åˆä½¿ç”¨ã€‚ Server æœåŠ¡å™¨ç›¸å…³ä¿¡æ¯ Content-Type å‘ŠçŸ¥å®¢æˆ·æµè§ˆå™¨ï¼Œå“åº”æ­£æ–‡çš„MIMEç±»å‹ Content-Length å‘ŠçŸ¥å®¢æˆ·æµè§ˆå™¨ï¼Œå“åº”æ­£æ–‡çš„é•¿åº¦ Content-Encoding å‘ŠçŸ¥å®¢æˆ·æµè§ˆå™¨ï¼Œå“åº”æ­£æ–‡ä½¿ç”¨çš„å‹ç¼©ç¼–ç æ ¼å¼ï¼Œå¸¸ç”¨çš„ gzip å‹ç¼© Content-Language å‘ŠçŸ¥å®¢æˆ·æµè§ˆå™¨ï¼Œå“åº”æ­£æ–‡çš„è¯­è¨€ï¼Œzh_CN æˆ– en_US ç­‰ Content-Disposition å‘ŠçŸ¥å®¢æˆ·æµè§ˆå™¨ï¼Œä»¥ä¸‹è½½çš„æ–¹å¼æ‰“å¼€å“åº”æ­£æ–‡ Refresh å®¢æˆ·ç«¯çš„åˆ·æ–°é¢‘ç‡ï¼Œå•ä½æ˜¯ç§’ Last-Modified æœåŠ¡å™¨èµ„æºçš„æœ€åä¿®æ”¹æ—¶é—´ Set-Cookie æœåŠ¡å™¨ç«¯å‘é€çš„ Cookieï¼Œä¼šè¯ç®¡ç†ç›¸å…³ Expires:-1 æœåŠ¡å™¨èµ„æºåˆ°å®¢æˆ·æµè§ˆå™¨åçš„ç¼“å­˜æ—¶é—´ Catch-Control: no-catch ä¸è¦ç¼“å­˜ï¼Œ&#x2F;&#x2F;é’ˆå¯¹httpåè®®1.1ç‰ˆæœ¬ Pragma:no-catch ä¸è¦ç¼“å­˜ï¼Œ&#x2F;&#x2F;é’ˆå¯¹httpåè®®1.0ç‰ˆæœ¬ å“åº”ä½“ï¼šé¡µé¢å±•ç¤ºå†…å®¹, ç±»ä¼¼ç½‘é¡µçš„æºç  123456789&lt;html&gt; &lt;head&gt; &lt;link rel=&quot;stylesheet&quot; href=&quot;css.css&quot; type=&quot;text/css&quot;&gt; &lt;script type=&quot;text/javascript&quot; src=&quot;demo.js&quot;&gt;&lt;/script&gt; &lt;/head&gt; &lt;body&gt; &lt;img src=&quot;1.jpg&quot; /&gt; &lt;/body&gt;&lt;/html&gt; ServletJavaEEJavaEEè§„èŒƒJavaEE è§„èŒƒæ˜¯ J2EE è§„èŒƒçš„æ–°åç§°ï¼Œæ—©æœŸè¢«ç§°ä¸º J2EE è§„èŒƒï¼Œå…¶å…¨ç§°æ˜¯ Java 2 Platform Enterprise Editionï¼Œå®ƒæ˜¯ç”± SUN å…¬å¸é¢†å¯¼ã€å„å‚å®¶å…±åŒåˆ¶å®šå¹¶å¾—åˆ°å¹¿æ³›è®¤å¯çš„å·¥ä¸šæ ‡å‡†ï¼ˆJCPç»„ç»‡æˆå‘˜ï¼‰ã€‚ä¹‹æ‰€ä»¥æ”¹åä¸ºJavaEEï¼Œç›®çš„è¿˜æ˜¯è®©å¤§å®¶æ¸…æ¥š J2EE åªæ˜¯ Java ä¼ä¸šåº”ç”¨ã€‚åœ¨ 2004 å¹´åº•ä¸­å›½è½¯ä»¶æŠ€æœ¯å¤§ä¼š Ioc å¾®å®¹å™¨ï¼ˆä¹Ÿå°±æ˜¯ Jdon æ¡†æ¶çš„å®ç°åŸç†ï¼‰æ¼”è®²ä¸­æŒ‡å‡ºï¼šæˆ‘ä»¬éœ€è¦ä¸€ä¸ªè·¨ J2SE/WEB/EJB çš„å¾®å®¹å™¨ï¼Œä¿æŠ¤æˆ‘ä»¬çš„ä¸šåŠ¡æ ¸å¿ƒç»„ä»¶ï¼Œä»¥å»¶ç»­å®ƒçš„ç”Ÿå‘½åŠ›ï¼Œè€Œä¸æ˜¯ä¾èµ– J2SE/J2EE ç‰ˆæœ¬ã€‚æ­¤æ¬¡ J2EE æ”¹åä¸º Java EEï¼Œå®é™…ä¹Ÿåæ˜ å‡ºä¸šç•Œè¿™ç§å…±åŒå¿ƒå£° JavaEE è§„èŒƒæ˜¯å¾ˆå¤š Java å¼€å‘æŠ€æœ¯çš„æ€»ç§°ã€‚è¿™äº›æŠ€æœ¯è§„èŒƒéƒ½æ˜¯æ²¿ç”¨è‡ª J2EE çš„ã€‚ä¸€å…±åŒ…æ‹¬äº† 13 ä¸ªæŠ€æœ¯è§„èŒƒï¼Œä¾‹å¦‚ï¼šjsp/servletï¼Œjndiï¼Œjaxpï¼Œjdbcï¼Œjniï¼Œjaxbï¼Œjmfï¼Œjtaï¼Œjpaï¼ŒEJBç­‰ã€‚ å…¶ä¸­ï¼ŒJCP ç»„ç»‡çš„å…¨ç§°æ˜¯ Java Community Processï¼Œæ˜¯ä¸€ä¸ªå¼€æ”¾çš„å›½é™…ç»„ç»‡ï¼Œä¸»è¦ç”± Java å¼€å‘è€…ä»¥åŠè¢«æˆæƒè€…ç»„æˆï¼ŒèŒèƒ½æ˜¯å‘å±•å’Œæ›´æ–°ã€‚æˆç«‹äº 1998 å¹´ã€‚å®˜ç½‘æ˜¯ï¼šJCP JavaEE çš„ç‰ˆæœ¬æ˜¯å»¶ç»­äº† J2EE çš„ç‰ˆæœ¬ï¼Œä½†æ˜¯æ²¡æœ‰ç»§ç»­é‡‡ç”¨å…¶å‘½åè§„åˆ™ã€‚J2EE çš„ç‰ˆæœ¬ä» 1.0 å¼€å§‹åˆ° 1.4 ç»“æŸï¼Œè€Œ JavaEE ç‰ˆæœ¬æ˜¯ä» JavaEE 5 ç‰ˆæœ¬å¼€å§‹ï¼Œç›®å‰æœ€æ–°çš„çš„ç‰ˆæœ¬æ˜¯ JavaEE 8 è¯¦æƒ…è¯·å‚è€ƒï¼šJavaEE8 è§„èŒƒæ¦‚è§ˆ Web æ¦‚è¿°Webï¼Œåœ¨è®¡ç®—æœºé¢†åŸŸæŒ‡ç½‘ç»œã€‚åƒæˆ‘ä»¬æ¥è§¦çš„ WWWï¼Œå®ƒæ˜¯ç”± 3 ä¸ªå•è¯ç»„æˆçš„ï¼Œå³ï¼šWorld Wide Web ï¼Œä¸­æ–‡å«ä¹‰æ˜¯ä¸‡ç»´ç½‘ã€‚è€Œæˆ‘ä»¬å‰é¢å­¦çš„ HTML çš„å‚è€ƒæ–‡æ¡£ã€ŠW3School å…¨å¥—æ•™ç¨‹ã€‹ä¸­çš„ W3C å°±æ˜¯ä¸‡ç»´ç½‘è”ç›Ÿï¼Œä»–ä»¬çš„å‡ºç°éƒ½æ˜¯ä¸ºäº†è®©æˆ‘ä»¬åœ¨ç½‘ç»œçš„ä¸–ç•Œä¸­è·å–èµ„æºï¼Œè¿™äº›èµ„æºçš„å­˜æ”¾ä¹‹å¤„ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºç½‘ç«™ã€‚æˆ‘ä»¬é€šè¿‡è¾“å…¥ç½‘ç«™çš„åœ°å€ï¼ˆç½‘å€ï¼‰ï¼Œå°±å¯ä»¥è®¿é—®ç½‘ç«™ä¸­æä¾›çš„èµ„æºã€‚åœ¨ç½‘ä¸Šæˆ‘ä»¬èƒ½è®¿é—®åˆ°çš„å†…å®¹å…¨æ˜¯èµ„æºï¼ˆä¸åŒºåˆ†å±€åŸŸç½‘è¿˜æ˜¯å¹¿åŸŸç½‘ï¼‰ï¼Œåªä¸è¿‡ä¸åŒç±»å‹çš„èµ„æºå±•ç¤ºçš„æ•ˆæœä¸ä¸€æ · èµ„æºåˆ†ä¸ºé™æ€èµ„æºå’ŒåŠ¨æ€èµ„æº é™æ€èµ„æºæŒ‡çš„æ˜¯ï¼Œç½‘ç«™ä¸­æä¾›ç»™äººä»¬å±•ç¤ºçš„èµ„æºæ˜¯ä¸€æˆä¸å˜çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸åŒäººæˆ–è€…åœ¨ä¸åŒæ—¶é—´ï¼Œçœ‹åˆ°çš„å†…å®¹éƒ½æ˜¯ä¸€æ ·çš„ã€‚ä¾‹å¦‚ï¼šæˆ‘ä»¬çœ‹åˆ°çš„æ–°é—»ï¼Œç½‘ç«™çš„ä½¿ç”¨æ‰‹å†Œï¼Œç½‘ç«™åŠŸèƒ½è¯´æ˜æ–‡æ¡£ç­‰ç­‰ã€‚è€Œä½œä¸ºå¼€å‘è€…ï¼Œæˆ‘ä»¬ç¼–å†™çš„ htmlã€cssã€js å›¾ç‰‡ï¼Œå¤šåª’ä½“ç­‰ç­‰éƒ½å¯ä»¥ç§°ä¸ºé™æ€èµ„æº åŠ¨æ€èµ„æºå®ƒæŒ‡çš„æ˜¯ï¼Œç½‘ç«™ä¸­æä¾›ç»™äººä»¬å±•ç¤ºçš„èµ„æºæ˜¯ç”±ç¨‹åºäº§ç”Ÿçš„ï¼Œåœ¨ä¸åŒçš„æ—¶é—´æˆ–è€…ç”¨ä¸åŒçš„äººå‘˜ç”±äºèº«ä»½çš„ä¸åŒï¼Œæ‰€çœ‹åˆ°çš„å†…å®¹æ˜¯ä¸ä¸€æ ·çš„ã€‚ä¾‹å¦‚ï¼šæˆ‘ä»¬åœ¨CSDNä¸Šä¸‹è½½èµ„æ–™ï¼Œåªæœ‰ç™»å½•æˆåŠŸåï¼Œä¸”ç§¯åˆ†è¶³å¤Ÿæ—¶æ‰èƒ½ä¸‹è½½ã€‚å¦åˆ™å°±ä¸èƒ½ä¸‹è½½ï¼Œè¿™å°±æ˜¯è®¿å®¢èº«ä»½å’Œä¼šå‘˜èº«ä»½çš„åŒºåˆ«ã€‚ä½œä¸ºå¼€å‘äººå‘˜ï¼Œæˆ‘ä»¬ç¼–å†™çš„ JSPï¼Œservletï¼Œphpï¼ŒASP ç­‰éƒ½æ˜¯åŠ¨æ€èµ„æºã€‚ å…³äºå¹¿åŸŸç½‘å’Œå±€åŸŸç½‘çš„åˆ’åˆ† å¹¿åŸŸç½‘æŒ‡çš„å°±æ˜¯ä¸‡ç»´ç½‘ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯´çš„äº’è”ç½‘ã€‚ å±€åŸŸç½‘æ˜¯æŒ‡çš„æ˜¯åœ¨ä¸€å®šèŒƒå›´ä¹‹å†…å¯ä»¥è®¿é—®çš„ç½‘ç»œï¼Œå‡ºäº†è¿™ä¸ªèŒƒå›´ï¼Œå°±ä¸èƒ½å†ä½¿ç”¨çš„ç½‘ç»œã€‚ ç³»ç»Ÿç»“æ„åŸºç¡€ç»“æ„åˆ’åˆ†ï¼šC&#x2F;Sç»“æ„ï¼ŒB&#x2F;Sç»“æ„ä¸¤ç±»ã€‚ æŠ€æœ¯é€‰å‹åˆ’åˆ†ï¼šModel1æ¨¡å‹ï¼ŒModel2æ¨¡å‹ï¼ŒMVCæ¨¡å‹å’Œä¸‰å±‚æ¶æ„+MVCæ¨¡å‹ã€‚ éƒ¨ç½²æ–¹å¼åˆ’åˆ†ï¼šä¸€ä½“åŒ–æ¶æ„ï¼Œå‚ç›´æ‹†åˆ†æ¶æ„ï¼Œåˆ†å¸ƒå¼æ¶æ„ï¼ŒæµåŠ¨è®¡ç®—æ¶æ„ï¼Œå¾®æœåŠ¡æ¶æ„ã€‚ C&#x2F;Sç»“æ„ï¼šå®¢æˆ·ç«¯â€”æœåŠ¡å™¨çš„æ–¹å¼ã€‚å…¶ä¸­Cä»£è¡¨Clientï¼ŒSä»£è¡¨æœåŠ¡å™¨ã€‚C&#x2F;Sç»“æ„çš„ç³»ç»Ÿè®¾è®¡å›¾å¦‚ä¸‹ï¼š B&#x2F;Sç»“æ„æ˜¯æµè§ˆå™¨â€”æœåŠ¡å™¨çš„æ–¹å¼ã€‚Bä»£è¡¨Browserï¼ŒSä»£è¡¨æœåŠ¡å™¨ã€‚B&#x2F;Sç»“æ„çš„ç³»ç»Ÿè®¾è®¡å›¾å¦‚ä¸‹ï¼š ä¸¤ç§ç»“æ„çš„åŒºåˆ«åŠä¼˜åŠ£ åŒºåˆ«ï¼š ç¬¬ä¸€ï¼šç¡¬ä»¶ç¯å¢ƒä¸åŒï¼ŒC&#x2F;Sé€šå¸¸æ˜¯å»ºç«‹åœ¨ä¸“ç”¨çš„ç½‘ç»œæˆ–å°èŒƒå›´çš„ç½‘ç»œç¯å¢ƒä¸Šï¼ˆå³å±€åŸŸç½‘ï¼‰ï¼Œä¸”å¿…é¡»è¦å®‰è£…å®¢æˆ·ç«¯ã€‚è€ŒB&#x2F;Sæ˜¯å»ºç«‹åœ¨å¹¿åŸŸç½‘ä¸Šçš„ï¼Œé€‚åº”èŒƒå›´å¼ºï¼Œé€šå¸¸æœ‰æ“ä½œç³»ç»Ÿå’Œæµè§ˆå™¨å°±è¡Œã€‚ ç¬¬äºŒï¼šC&#x2F;Sç»“æ„æ¯”B&#x2F;Sç»“æ„æ›´å®‰å…¨ï¼Œå› ä¸ºç”¨æˆ·ç¾¤ç›¸å¯¹å›ºå®šï¼Œå¯¹ä¿¡æ¯çš„ä¿æŠ¤æ›´å¼ºã€‚ ç¬¬ä¸‰ï¼šB&#x2F;Sç»“æ„ç»´æŠ¤å‡çº§æ¯”è¾ƒç®€å•ï¼Œè€ŒC&#x2F;Sç»“æ„ç»´æŠ¤å‡çº§ç›¸å¯¹å›°éš¾ã€‚ ä¼˜åŠ£ C&#x2F;Sï¼šèƒ½å……åˆ†å‘æŒ¥å®¢æˆ·ç«¯PCçš„å¤„ç†èƒ½åŠ›ï¼Œå¾ˆå¤šå·¥ä½œå¯ä»¥åœ¨å®¢æˆ·ç«¯å¤„ç†åå†æäº¤ç»™æœåŠ¡å™¨ã€‚å¯¹åº”çš„ä¼˜ç‚¹å°±æ˜¯å®¢æˆ·ç«¯å“åº”é€Ÿåº¦å¿«ã€‚ B&#x2F;Sï¼šæ€»ä½“æ‹¥æœ‰æˆæœ¬ä½ã€ç»´æŠ¤æ–¹ä¾¿ã€ åˆ†å¸ƒæ€§å¼ºã€å¼€å‘ç®€å•ï¼Œå¯ä»¥ä¸ç”¨å®‰è£…ä»»ä½•ä¸“é—¨çš„è½¯ä»¶å°±èƒ½å®ç°åœ¨ä»»ä½•åœ°æ–¹è¿›è¡Œæ“ä½œï¼Œå®¢æˆ·ç«¯é›¶ç»´æŠ¤ï¼Œç³»ç»Ÿçš„æ‰©å±•éå¸¸å®¹æ˜“ï¼Œåªè¦æœ‰ä¸€å°èƒ½ä¸Šç½‘çš„ç”µè„‘å°±èƒ½ä½¿ç”¨ã€‚ æˆ‘ä»¬çš„è¯¾ç¨‹ä¸­æ¶‰åŠçš„ç³»ç»Ÿç»“æ„éƒ½æ˜¯æ˜¯åŸºäºB&#x2F;Sç»“æ„ TomcatæœåŠ¡å™¨æœåŠ¡å™¨çš„æ¦‚å¿µéå¸¸çš„å¹¿æ³›ï¼Œå®ƒå¯ä»¥æŒ‡ä»£ä¸€å°ç‰¹æ®Šçš„è®¡ç®—æœºï¼ˆç›¸æ¯”æ™®é€šè®¡ç®—æœºè¿è¡Œæ›´å¿«ã€è´Ÿè½½æ›´é«˜ã€ä»·æ ¼æ›´è´µï¼‰ï¼Œä¹Ÿå¯ä»¥æŒ‡ä»£ç”¨äºéƒ¨ç½²ç½‘ç«™çš„åº”ç”¨ã€‚æˆ‘ä»¬è¿™é‡Œè¯´çš„æœåŠ¡å™¨ï¼Œå…¶å®æ˜¯webæœåŠ¡å™¨ï¼Œæˆ–è€…åº”ç”¨æœåŠ¡å™¨ã€‚å®ƒæœ¬è´¨å°±æ˜¯ä¸€ä¸ªè½¯ä»¶ï¼Œä¸€ä¸ªåº”ç”¨ã€‚ä½œç”¨å°±æ˜¯å‘å¸ƒæˆ‘ä»¬çš„åº”ç”¨ï¼ˆå·¥ç¨‹ï¼‰ï¼Œè®©ç”¨æˆ·å¯ä»¥é€šè¿‡æµè§ˆå™¨è®¿é—®æˆ‘ä»¬çš„åº”ç”¨ã€‚ å¸¸è§çš„åº”ç”¨æœåŠ¡å™¨ï¼Œè¯·çœ‹ä¸‹è¡¨ï¼š æœåŠ¡å™¨åç§° è¯´æ˜ weblogic å®ç°äº† JavaEE è§„èŒƒï¼Œé‡é‡çº§æœåŠ¡å™¨ï¼Œåˆç§°ä¸º JavaEE å®¹å™¨ websphereAS å®ç°äº† JavaEE è§„èŒƒï¼Œé‡é‡çº§æœåŠ¡å™¨ã€‚ JBOSSAS å®ç°äº† JavaEE è§„èŒƒï¼Œé‡é‡çº§æœåŠ¡å™¨ï¼Œå…è´¹ Tomcat å®ç°äº† jsp&#x2F;servlet è§„èŒƒï¼Œæ˜¯ä¸€ä¸ªè½»é‡çº§æœåŠ¡å™¨ï¼Œå¼€æºå…è´¹ åŸºæœ¬ä»‹ç»Windowså®‰è£…ä¸‹è½½åœ°å€ï¼šhttp://tomcat.apache.org/ ç›®å½•ç»“æ„è¯¦è§£ï¼š Linuxå®‰è£…è§£å‹apache-tomcat-8.5.32.tar.gzã€‚ é˜²ç«å¢™è®¾ç½® æ–¹å¼1ï¼šservice iptables stop å…³é—­é˜²ç«å¢™(ä¸å»ºè®®); ç”¨åˆ°å“ªä¸€ä¸ªç«¯å£å·å°±æ”¾è¡Œå“ªä¸€ä¸ª(80,8080,3306â€¦) æ–¹å¼2ï¼šæ”¾è¡Œ8080 ç«¯å£ ä¿®æ”¹é…ç½®æ–‡ä»¶cd /etc/sysconfigâ€“&gt;vi iptables-A INPUT -m state --state NEW -m tcp -p tcp --dport 8080 -j ACCEPT é‡å¯åŠ è½½é˜²ç«å¢™æˆ–è€…é‡å¯é˜²ç«å¢™service iptables reload æˆ–è€…service iptables restart å¯åŠ¨åœæ­¢TomcatæœåŠ¡å™¨çš„å¯åŠ¨æ–‡ä»¶åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ç›®å½•binä¸­ï¼šstartup.batï¼Œstartup.sh TomcatæœåŠ¡å™¨çš„åœæ­¢æ–‡ä»¶ä¹Ÿåœ¨äºŒè¿›åˆ¶æ–‡ä»¶ç›®å½•binä¸­ï¼šshutdown.batï¼Œshutdown.sh ï¼ˆæ¨èç›´æ¥å…³é—­æ§åˆ¶å°ï¼‰ å…¶ä¸­.batæ–‡ä»¶æ˜¯é’ˆå¯¹windowsç³»ç»Ÿçš„è¿è¡Œç¨‹åºï¼Œ.shæ–‡ä»¶æ˜¯é’ˆå¯¹linuxç³»ç»Ÿçš„è¿è¡Œç¨‹åºã€‚ å¸¸è§é—®é¢˜ å¯åŠ¨ä¸€é—ªè€Œè¿‡ æ²¡æœ‰é…ç½®ç¯å¢ƒå˜é‡ï¼Œé…ç½®ä¸Š JAVA_HOME ç¯å¢ƒå˜é‡ã€‚ Tomcat å¯åŠ¨åæ§åˆ¶å°è¾“å‡ºä¹±ç  æ‰“å¼€ /conf/logging.propertiesï¼Œè®¾ç½® gbk java.util.logging.ConsoleHandler.encoding = gbk Address already in use : JVM_Bindï¼šç«¯å£è¢«å ç”¨ï¼Œæ‰¾åˆ°å ç”¨è¯¥ç«¯å£çš„åº”ç”¨ è¿›ç¨‹ä¸é‡è¦ï¼šä½¿ç”¨cmdå‘½ä»¤ï¼šnetstat -a -o æŸ¥çœ‹ pid åœ¨ä»»åŠ¡ç®¡ç†å™¨ä¸­ç»“æŸå ç”¨ç«¯å£çš„è¿›ç¨‹ è¿›ç¨‹å¾ˆé‡è¦ï¼šä¿®æ”¹è‡ªå·±çš„ç«¯å£å·ã€‚ä¿®æ”¹çš„æ˜¯ Tomcat ç›®å½•ä¸‹\\conf\\server.xmlä¸­çš„é…ç½®ã€‚ IDEAé›†æˆRun -&gt; Edit Configurations -&gt; Templates -&gt; Tomcat Server -&gt; Local å‘å¸ƒåº”ç”¨è™šæ‹Ÿç›®å½•åœ¨ server.xml çš„ &lt;Host&gt; å…ƒç´ ä¸­åŠ ä¸€ä¸ª &lt;Context path=&quot;&quot; docBase=&quot;&quot;/&gt; å…ƒç´  pathï¼šè®¿é—®èµ„æºURIï¼ŒURIåç§°å¯ä»¥éšä¾¿èµ·ï¼Œä½†æ˜¯å¿…é¡»åœ¨å‰é¢åŠ ä¸Šä¸€ä¸ª&#x2F; docBaseï¼šèµ„æºæ‰€åœ¨çš„ç£ç›˜ç‰©ç†åœ°å€ è™šæ‹Ÿä¸»æœºåœ¨&lt;Engine&gt;å…ƒç´ ä¸­æ·»åŠ ä¸€ä¸ª&lt;Host name=&quot;&quot; appBase=&quot;&quot; unparkWARs=&quot;&quot; autoDeploy=&quot;&quot; /&gt;ï¼Œå…¶ä¸­ï¼š nameï¼šæŒ‡å®šä¸»æœºçš„åç§° appBaseï¼šå½“å‰ä¸»æœºçš„åº”ç”¨å‘å¸ƒç›®å½• unparkWARsï¼šå¯åŠ¨æ—¶æ˜¯å¦è‡ªåŠ¨è§£å‹waråŒ… autoDeployï¼šæ˜¯å¦è‡ªåŠ¨å‘å¸ƒ 123&lt;Host name=&quot;www.itcast.cn&quot; appBase=&quot;D:\\itcastapps&quot; unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;/&gt;&lt;Host name=&quot;www.itheima.com&quot; appBase=&quot;D:\\itheimaapps&quot; unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;/&gt; IDEAéƒ¨ç½² æ–°å»ºå·¥ç¨‹ å‘å¸ƒå·¥ç¨‹ Run IDEAå‘å¸ƒæŠŠèµ„æºç§»åŠ¨åˆ° Tomcat å·¥ç¨‹ä¸‹ web ç›®å½•ä¸­ï¼Œä¸¤ç§è®¿é—®æ–¹å¼ ç›´æ¥è®¿é—®ï¼šhttp://localhost:8080/Tomcat/login/login.html åœ¨ web.xml ä¸­é…ç½®é»˜è®¤ä¸»é¡µ 123&lt;welcome-file-list&gt; &lt;welcome-file&gt;/é»˜è®¤ä¸»é¡µ&lt;/welcome-file&gt;&lt;/welcome-file-list&gt; æ‰§è¡ŒåŸç†æ•´ä½“æ¶æ„Tomcat æ ¸å¿ƒç»„ä»¶æ¶æ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š ç»„ä»¶ä»‹ç»ï¼š GlobalNamingResourcesï¼šå®ç° JNDIï¼ŒæŒ‡å®šä¸€äº›èµ„æºçš„é…ç½®ä¿¡æ¯ Serverï¼šTomcat æ˜¯ä¸€ä¸ª Servlet å®¹å™¨ï¼Œä¸€ä¸ª Tomcat å¯¹åº”ä¸€ä¸ª Serverï¼Œä¸€ä¸ª Server å¯ä»¥åŒ…å«å¤šä¸ª Service Serviceï¼šæ ¸å¿ƒæœåŠ¡æ˜¯ Catalinaï¼Œç”¨æ¥å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œä¸€ä¸ª Service åŒ…å«å¤šä¸ª Connector å’Œä¸€ä¸ª Container Connectorï¼šè¿æ¥å™¨ï¼Œè´Ÿè´£å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œè§£æä¸åŒåè®®åŠ I&#x2F;O æ–¹å¼ Executorï¼šçº¿ç¨‹æ±  Containerï¼šå®¹æ˜“åŒ…å« Engineï¼ŒHostï¼ŒContextï¼ŒWrapper ç­‰ç»„ä»¶ Engineï¼šæœåŠ¡äº¤ç»™å¼•æ“å¤„ç†è¯·æ±‚ï¼ŒContainer å®¹å™¨ä¸­é¡¶å±‚çš„å®¹å™¨å¯¹è±¡ï¼Œä¸€ä¸ª Engine å¯ä»¥åŒ…å«å¤šä¸ª Host ä¸»æœº Hostï¼šEngine å®¹å™¨çš„å­å®¹å™¨ï¼Œä¸€ä¸ª Host å¯¹åº”ä¸€ä¸ªç½‘ç»œåŸŸåï¼Œä¸€ä¸ª Host åŒ…å«å¤šä¸ª Context Contextï¼šHost å®¹å™¨çš„å­å®¹å™¨ï¼Œè¡¨ç¤ºä¸€ä¸ª Web åº”ç”¨ Wrapperï¼šTomcat ä¸­çš„æœ€å°å®¹å™¨å•å…ƒï¼Œè¡¨ç¤º Web åº”ç”¨ä¸­çš„ Servlet æ ¸å¿ƒç±»åº“ï¼š Coyoteï¼šTomcat è¿æ¥å™¨çš„åç§°ï¼Œå°è£…äº†åº•å±‚çš„ç½‘ç»œé€šä¿¡ï¼Œä¸º Catalina å®¹å™¨æä¾›äº†ç»Ÿä¸€çš„æ¥å£ï¼Œä½¿å®¹å™¨ä¸å…·ä½“çš„åè®®ä»¥åŠ I&#x2F;O è§£è€¦ EndPointï¼šCoyote é€šä¿¡ç«¯ç‚¹ï¼Œå³é€šä¿¡ç›‘å¬çš„æ¥å£ï¼Œæ˜¯ Socket æ¥æ”¶å’Œå‘é€å¤„ç†å™¨ï¼Œæ˜¯å¯¹ä¼ è¾“å±‚çš„æŠ½è±¡ï¼Œç”¨æ¥å®ç° TCP&#x2F;IP åè®® Processor ï¼š Coyote åè®®å¤„ç†æ¥å£ï¼Œç”¨æ¥å®ç° HTTP åè®®ï¼ŒProcessor æ¥æ”¶æ¥è‡ª EndPoint çš„ Socketï¼Œè¯»å–å­—èŠ‚æµè§£ææˆ Tomcat çš„ Request å’Œ Response å¯¹è±¡ï¼Œå¹¶é€šè¿‡ Adapter å°†å…¶æäº¤åˆ°å®¹å™¨å¤„ç†ï¼ŒProcessor æ˜¯å¯¹åº”ç”¨å±‚åè®®çš„æŠ½è±¡ CoyoteAdapterï¼šé€‚é…å™¨ï¼Œè¿æ¥å™¨è°ƒç”¨ CoyoteAdapter çš„ sevice æ–¹æ³•ï¼Œä¼ å…¥çš„æ˜¯ TomcatRequest å¯¹è±¡ï¼ŒCoyoteAdapter è´Ÿè´£å°†TomcatRequest è½¬æˆ ServletRequestï¼Œå†è°ƒç”¨å®¹å™¨çš„ service æ–¹æ³• å‚è€ƒæ–‡ç« ï¼šhttps://www.jianshu.com/p/7c9401b85704 å‚è€ƒæ–‡ç« ï¼šhttps://www.yuque.com/yinhuidong/yu877c/ktq82e å¯åŠ¨è¿‡ç¨‹Tomcat çš„å¯åŠ¨å…¥å£æ˜¯ Bootstrap#main å‡½æ•°ï¼Œé¦–å…ˆé€šè¿‡è°ƒç”¨ bootstrap.init() åˆå§‹åŒ–ç›¸å…³ç»„ä»¶ï¼š initClassLoaders()ï¼šåˆå§‹åŒ–ä¸‰ä¸ªç±»åŠ è½½å™¨ï¼ŒcommonLoader çš„çˆ¶ç±»åŠ è½½å™¨æ˜¯å¯åŠ¨ç±»åŠ è½½å™¨ Thread.currentThread().setContextClassLoader(catalinaLoader)ï¼šè‡ªå®šä¹‰ç±»åŠ è½½å™¨åŠ è½½ Catalina ç±»ï¼Œæ‰“ç ´åŒäº²å§”æ´¾ Object startupInstance = startupClass.getConstructor().newInstance()ï¼šåå°„åˆ›å»º Catalina å¯¹è±¡ method.invoke(startupInstance, paramValues)ï¼šåå°„è°ƒç”¨æ–¹æ³•ï¼Œè®¾ç½®çˆ¶ç±»åŠ è½½å™¨æ˜¯ sharedLoader catalinaDaemon = startupInstanceï¼šå¼•ç”¨ Catalina å¯¹è±¡ daemon.load(args) æ–¹æ³•åå°„è°ƒç”¨ Catalina å¯¹è±¡çš„ load æ–¹æ³•ï¼Œå¯¹æœåŠ¡å™¨çš„ç»„ä»¶è¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶ç»‘å®šäº† ServerSocket çš„ç«¯å£ï¼š parseServerXml(true)ï¼šè§£æ XML é…ç½®æ–‡ä»¶ getServer().init()ï¼šæœåŠ¡å™¨æ‰§è¡Œåˆå§‹åŒ–ï¼Œé‡‡ç”¨è´£ä»»é“¾çš„æ‰§è¡Œæ–¹å¼ LifecycleBase.init()ï¼šç”Ÿå‘½å‘¨æœŸæ¥å£çš„åˆå§‹åŒ–æ–¹æ³•ï¼Œå¼€å§‹é“¾å¼è°ƒç”¨ StandardServer.initInternal()ï¼šServer çš„åˆå§‹åŒ–ï¼Œéå†æ‰€æœ‰çš„ Service è¿›è¡Œåˆå§‹åŒ– StandardService.initInternal()ï¼šService çš„åˆå§‹åŒ–ï¼Œå¯¹ Engineã€Executorã€listenerã€Connector è¿›è¡Œåˆå§‹åŒ– StandardEngine.initInternal()ï¼šEngine çš„åˆå§‹åŒ– getRealm()ï¼šåˆ›å»ºä¸€ä¸ª Realm å¯¹è±¡ ContainerBase.initInternal()ï¼šå®¹å™¨çš„åˆå§‹åŒ–ï¼Œè®¾ç½®å¤„ç†å®¹å™¨å†…ç»„ä»¶çš„å¯åŠ¨å’Œåœæ­¢äº‹ä»¶çš„çº¿ç¨‹æ±  Connector.initInternal()ï¼šConnector çš„åˆå§‹åŒ– 123public Connector() &#123; this(&quot;HTTP/1.1&quot;); //é»˜è®¤æ— å‚æ„é€ æ–¹æ³•ï¼Œä¼šåˆ›å»ºå‡º Http11NioProtocol çš„åè®®å¤„ç†å™¨&#125; adapter = new CoyoteAdapter(this)ï¼šå®ä¾‹åŒ– CoyoteAdapter å¯¹è±¡ protocolHandler.setAdapter(adapter)ï¼šè®¾ç½®åˆ° ProtocolHandler åè®®å¤„ç†å™¨ä¸­ ProtocolHandler.init()ï¼šåè®®å¤„ç†å™¨çš„åˆå§‹åŒ–ï¼Œåº•å±‚è°ƒç”¨ AbstractProtocol#init æ–¹æ³• endpoint.init()ï¼šç«¯å£çš„åˆå§‹åŒ–ï¼Œåº•å±‚è°ƒç”¨ AbstractEndpoint#init æ–¹æ³• NioEndpoint.bind()ï¼šç»‘å®šæ–¹æ³• initServerSocket()ï¼šåˆå§‹åŒ– ServerSocketï¼Œä»¥ NIO çš„æ–¹å¼ç›‘å¬ç«¯å£ serverSock = ServerSocketChannel.open()ï¼šNIO çš„æ–¹å¼æ‰“å¼€é€šé“ serverSock.bind(addr, getAcceptCount())ï¼šé€šé“ç»‘å®šè¿æ¥ç«¯å£ serverSock.configureBlocking(true)ï¼šåˆ‡æ¢ä¸ºé˜»å¡æ¨¡å¼ï¼ˆæ²¡æ‡‚ï¼Œä¸ºä»€ä¹ˆé˜»å¡ï¼‰ initialiseSsl()ï¼šåˆå§‹åŒ– SSL è¿æ¥ selectorPool.open(getName())ï¼šæ‰“å¼€é€‰æ‹©å™¨ï¼Œç±»ä¼¼ NIO çš„å¤šè·¯å¤ç”¨å™¨ åˆå§‹åŒ–å®Œæ‰€æœ‰çš„ç»„ä»¶ï¼Œè°ƒç”¨ daemon.start() è¿›è¡Œç»„ä»¶çš„å¯åŠ¨ï¼Œåº•å±‚åå°„è°ƒç”¨ Catalina å¯¹è±¡çš„ start æ–¹æ³•ï¼š getServer().start()ï¼šå¯åŠ¨ç»„ä»¶ï¼Œä¹Ÿæ˜¯è´£ä»»é“¾çš„æ¨¡å¼ LifecycleBase.start()ï¼šç”Ÿå‘½å‘¨æœŸæ¥å£çš„åˆå§‹åŒ–æ–¹æ³•ï¼Œå¼€å§‹é“¾å¼è°ƒç”¨ StandardServer.startInternal()ï¼šServer æœåŠ¡çš„å¯åŠ¨ globalNamingResources.start()ï¼šå¯åŠ¨ JNDI æœåŠ¡ for (Service service : services)ï¼šéå†æ‰€æœ‰çš„ Service è¿›è¡Œå¯åŠ¨ StandardService.startInternal()ï¼šService çš„å¯åŠ¨ï¼Œå¯¹æ‰€æœ‰ Executorã€listenerã€Connector è¿›è¡Œå¯ StandardEngine.startInternal()ï¼šå¯åŠ¨å¼•æ“ï¼Œéƒ¨ç½²é¡¹ç›® ContainerBase.startInternal()ï¼šå®¹å™¨çš„å¯åŠ¨ å¯åŠ¨é›†ç¾¤ã€Realm ç»„ä»¶ï¼Œå¹¶ä¸”åˆ›å»ºå­å®¹å™¨ï¼Œæäº¤ç»™çº¿ç¨‹æ±  ((Lifecycle) pipeline).start()ï¼šéå†æ‰€æœ‰çš„ç®¡é“è¿›è¡Œå¯åŠ¨ Valve current = firstï¼šè·å–ç¬¬ä¸€ä¸ªé˜€é—¨ ((Lifecycle) current).start()ï¼šå¯åŠ¨é˜€é—¨ï¼Œåº•å±‚ ValveBase#startInternal ä¸­è®¾ç½®å¯åŠ¨çš„çŠ¶æ€ current = current.getNext()ï¼šè·å–ä¸‹ä¸€ä¸ªé˜€é—¨ Connector.startInternal()ï¼šConnector çš„åˆå§‹åŒ– protocolHandler.start()ï¼šåè®®å¤„ç†å™¨çš„å¯åŠ¨ endpoint.start()ï¼šç«¯ç‚¹å¯åŠ¨ NioEndpoint.startInternal()ï¼šå¯åŠ¨ NIO çš„ç«¯ç‚¹ createExecutor()ï¼šåˆ›å»º Worker çº¿ç¨‹ç»„ï¼Œ10 ä¸ªçº¿ç¨‹ï¼Œç”¨æ¥è¿›è¡Œä»»åŠ¡å¤„ç† initializeConnectionLatch()ï¼šç”¨æ¥è¿›è¡Œè¿æ¥é™æµï¼Œæœ€å¤§ 8*1024 æ¡è¿æ¥ poller = new Poller()ï¼šåˆ›å»º Poller å¯¹è±¡ï¼Œå¼€å¯äº†ä¸€ä¸ªå¤šè·¯å¤ç”¨å™¨ Selector Thread pollerThread = new Thread(poller, getName() + &quot;-ClientPoller&quot;)ï¼šåˆ›å»ºå¹¶å¯åŠ¨ Poller çº¿ç¨‹ï¼ŒPoller å®ç°äº† Runnable æ¥å£ï¼Œæ˜¯ä¸€ä¸ªä»»åŠ¡å¯¹è±¡ï¼Œçº¿ç¨‹ start åè¿›å…¥ Poller#run æ–¹æ³• pollerThread.setDaemon(true)ï¼šè®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹ startAcceptorThread()ï¼šå¯åŠ¨æ¥æ”¶è€…çº¿ç¨‹ acceptor = new Acceptor&lt;&gt;(this)ï¼šåˆ›å»º Acceptor å¯¹è±¡ Thread t = new Thread(acceptor, threadName)ï¼šåˆ›å»ºå¹¶å¯åŠ¨ Acceptor æ¥å—è€…çº¿ç¨‹ å¤„ç†è¿‡ç¨‹ Acceptor ç›‘å¬å®¢æˆ·ç«¯å¥—æ¥å­—ï¼Œæ¯ 50ms è°ƒç”¨ä¸€æ¬¡ **serverSocket.accept**ï¼Œè·å– Socket åæŠŠå°è£…æˆ NioSocketWrapperï¼ˆæ˜¯ SocketWrapperBase çš„å­ç±»ï¼‰ï¼Œå¹¶è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ï¼ŒæŠŠ NioSocketWrapper å°è£…æˆ PollerEvent æ”¾å…¥åŒæ­¥é˜Ÿåˆ—ä¸­ Poller å¾ªç¯åˆ¤æ–­åŒæ­¥é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å°±ç»ªçš„äº‹ä»¶ï¼Œå¦‚æœæœ‰åˆ™é€šè¿‡ selector.selectedKeys() è·å–å°±ç»ªäº‹ä»¶ï¼Œè·å– SocketChannel ä¸­æºå¸¦çš„ attachmentï¼ˆNioSocketWrapperï¼‰ï¼Œåœ¨ processKey æ–¹æ³•ä¸­æ ¹æ®äº‹ä»¶ç±»å‹è¿›è¡Œ processSocketï¼Œå°† Wrapper å¯¹è±¡å°è£…æˆ SocketProcessor å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ˜¯ä¸€ä¸ªä»»åŠ¡å¯¹è±¡ï¼Œæäº¤åˆ° Worker çº¿ç¨‹æ± è¿›è¡Œæ‰§è¡Œ SocketProcessorBase.run() åŠ é”è°ƒç”¨ SocketProcessor#doRunï¼Œä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä»åè®®å¤„ç†å™¨ ProtocolHandler ä¸­è·å– AbstractProtocolï¼Œç„¶ååˆ›å»º Http11Processor å¯¹è±¡å¤„ç†è¯·æ±‚ Http11Processor#service ä¸­è°ƒç”¨ CoyoteAdapter#service ï¼ŒæŠŠç”Ÿæˆçš„ Tomcat ä¸‹çš„ Request å’Œ Response å¯¹è±¡é€šè¿‡æ–¹æ³• postParseRequest åŒ¹é…åˆ°å¯¹åº”çš„ Servlet çš„è¯·æ±‚å“åº”ï¼Œå°†è¯·æ±‚ä¼ é€’åˆ°å¯¹åº”çš„ Engine å®¹å™¨ä¸­è°ƒç”¨ Pipelineï¼Œç®¡é“ä¸­åŒ…å«è‹¥å¹²ä¸ª Valveï¼Œæ‰§è¡Œå®Œæ‰€æœ‰çš„ Valve æœ€åæ‰§è¡Œ StandardEngineValveï¼Œç»§ç»­è°ƒç”¨ Host å®¹å™¨çš„ Pipelineï¼Œæ‰§è¡Œ Host çš„ Valveï¼Œå†ä¼ é€’ç»™ Context çš„ Pipelineï¼Œæœ€åä¼ é€’åˆ° Wrapper å®¹å™¨ StandardWrapperValve#invoke ä¸­åˆ›å»ºäº† Servlet å¯¹è±¡å¹¶æ‰§è¡Œåˆå§‹åŒ–ï¼Œå¹¶ä¸ºå½“å‰è¯·æ±‚å‡†å¤‡ä¸€ä¸ª FilterChain è¿‡æ»¤å™¨é“¾æ‰§è¡Œ doFilter æ–¹æ³•ï¼ŒApplicationFilterChain#doFilter æ˜¯ä¸€ä¸ªè´£ä»»é“¾çš„é©±åŠ¨æ–¹æ³•ï¼Œé€šè¿‡è°ƒç”¨ internalDoFilter æ¥è·å–è¿‡æ»¤å™¨é“¾çš„ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨æ‰§è¡Œ doFilterï¼Œæ‰§è¡Œå®Œæ‰€æœ‰çš„è¿‡æ»¤å™¨åæ‰§è¡Œ servlet.service çš„æ–¹æ³• æœ€åè°ƒç”¨ HttpServlet#service()ï¼Œæ ¹æ®è¯·æ±‚çš„æ–¹æ³•æ¥è°ƒç”¨ doGetã€doPost ç­‰ï¼Œæ‰§è¡Œåˆ°è‡ªå®šä¹‰çš„ä¸šåŠ¡æ–¹æ³• ServletSocketSocket æ˜¯ä½¿ç”¨ TCP&#x2F;IP æˆ–è€… UDP åè®®åœ¨æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ä¹‹é—´è¿›è¡Œä¼ è¾“çš„æŠ€æœ¯ï¼Œæ˜¯ç½‘ç»œç¼–ç¨‹çš„åŸºç¡€ Servlet æ˜¯ä½¿ç”¨ HTTP åè®®åœ¨æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ä¹‹é—´é€šä¿¡çš„æŠ€æœ¯ï¼Œæ˜¯ Socket çš„ä¸€ç§åº”ç”¨ HTTP åè®®ï¼šæ˜¯åœ¨ TCP&#x2F;IP åè®®ä¹‹ä¸Šè¿›ä¸€æ­¥å°è£…çš„ä¸€å±‚åè®®ï¼Œå…³æ³¨æ•°æ®ä¼ è¾“çš„æ ¼å¼æ˜¯å¦è§„èŒƒï¼Œåº•å±‚çš„æ•°æ®ä¼ è¾“è¿˜æ˜¯è¿ç”¨äº† Socket å’Œ TCP&#x2F;IP Tomcat å’Œ Servlet çš„å…³ç³»ï¼šServlet çš„è¿è¡Œç¯å¢ƒå«åš Web å®¹å™¨æˆ– Servlet æœåŠ¡å™¨ï¼ŒTomcat æ˜¯ Web åº”ç”¨æœåŠ¡å™¨ï¼Œæ˜¯ä¸€ä¸ª Servlet&#x2F;JSP å®¹å™¨ã€‚Tomcat ä½œä¸º Servlet å®¹å™¨ï¼Œè´Ÿè´£å¤„ç†å®¢æˆ·è¯·æ±‚ï¼ŒæŠŠè¯·æ±‚ä¼ é€ç»™ Servletï¼Œå¹¶å°† Servlet çš„å“åº”ä¼ é€å›ç»™å®¢æˆ·ã€‚è€Œ Servlet æ˜¯ä¸€ç§è¿è¡Œåœ¨æ”¯æŒ Java è¯­è¨€çš„æœåŠ¡å™¨ä¸Šçš„ç»„ä»¶ï¼ŒServlet ç”¨æ¥æ‰©å±• Java Web æœåŠ¡å™¨åŠŸèƒ½ï¼Œæä¾›éå¸¸å®‰å…¨çš„ã€å¯ç§»æ¤çš„ã€æ˜“äºä½¿ç”¨çš„ CGI æ›¿ä»£å“ åŸºæœ¬ä»‹ç»Servletç±»Servletæ˜¯SUNå…¬å¸æä¾›çš„ä¸€å¥—è§„èŒƒï¼Œåç§°å°±å«Servletè§„èŒƒï¼Œå®ƒä¹Ÿæ˜¯JavaEEè§„èŒƒä¹‹ä¸€ã€‚é€šè¿‡APIæ¥ä½¿ç”¨Servletã€‚ Servletæ˜¯ä¸€ä¸ªè¿è¡Œåœ¨webæœåŠ¡ç«¯çš„javaå°ç¨‹åºï¼Œç”¨äºæ¥æ”¶å’Œå“åº”å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚ä¸€ä¸ªæœåŠ¡å™¨åŒ…å«å¤šä¸ªServlet é€šè¿‡å®ç°Servletæ¥å£ï¼Œç»§æ‰¿GenericServletæˆ–è€…HttpServletï¼Œå®ç°ServletåŠŸèƒ½ æ¯æ¬¡è¯·æ±‚éƒ½ä¼šæ‰§è¡Œserviceæ–¹æ³•ï¼Œåœ¨serviceæ–¹æ³•ä¸­è¿˜æœ‰å‚æ•°ServletRequestå’ŒServletResponse æ”¯æŒé…ç½®ç›¸å…³åŠŸèƒ½ æ‰§è¡Œæµç¨‹åˆ›å»º Web å·¥ç¨‹ â†’ ç¼–å†™æ™®é€šç±»ç»§æ‰¿ Servlet ç›¸å…³ç±» â†’ é‡å†™æ–¹æ³• Servletæ‰§è¡Œè¿‡ç¨‹åˆ†æï¼š é€šè¿‡æµè§ˆå™¨å‘é€è¯·æ±‚ï¼Œè¯·æ±‚é¦–å…ˆåˆ°è¾¾TomcatæœåŠ¡å™¨ï¼Œç”±æœåŠ¡å™¨è§£æè¯·æ±‚URLï¼Œç„¶ååœ¨éƒ¨ç½²çš„åº”ç”¨åˆ—è¡¨ä¸­æ‰¾åˆ°åº”ç”¨ã€‚ç„¶åæ‰¾åˆ°web.xmlé…ç½®æ–‡ä»¶ï¼Œåœ¨web.xmlä¸­æ‰¾åˆ°FirstServletçš„é…ç½®ï¼ˆ&#x2F;ï¼‰ï¼Œæ‰¾åˆ°åæ‰§è¡Œserviceæ–¹æ³•ï¼Œæœ€åç”±FirstServletå“åº”å®¢æˆ·æµè§ˆå™¨ã€‚æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å®ç°æ–¹å¼å®ç° Servlet åŠŸèƒ½æ—¶ï¼Œå¯ä»¥é€‰æ‹©ä»¥ä¸‹ä¸‰ç§æ–¹å¼ï¼š ç¬¬ä¸€ç§ï¼šå®ç° Servlet æ¥å£ï¼Œæ¥å£ä¸­çš„æ–¹æ³•å¿…é¡»å…¨éƒ¨å®ç°ã€‚ä½¿ç”¨æ­¤ç§æ–¹å¼ï¼Œè¡¨ç¤ºæ¥å£ä¸­çš„æ‰€æœ‰æ–¹æ³•åœ¨éœ€æ±‚æ–¹é¢éƒ½æœ‰é‡å†™çš„å¿…è¦ã€‚æ­¤ç§æ–¹å¼æ”¯æŒæœ€å¤§ç¨‹åº¦çš„è‡ªå®šä¹‰ã€‚ ç¬¬äºŒç§ï¼šç»§æ‰¿ GenericServletï¼Œservice æ–¹æ³•å¿…é¡»é‡å†™ï¼Œå…¶ä»–æ–¹å¯æ ¹æ®éœ€æ±‚ï¼Œé€‰æ‹©æ€§é‡å†™ã€‚ä½¿ç”¨æ­¤ç§æ–¹å¼ï¼Œè¡¨ç¤ºåªåœ¨æ¥æ”¶å’Œå“åº”å®¢æˆ·ç«¯è¯·æ±‚è¿™æ–¹é¢æœ‰é‡å†™çš„éœ€æ±‚ï¼Œè€Œå…¶ä»–æ–¹æ³•å¯æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©æ€§é‡å†™ï¼Œä½¿æˆ‘ä»¬çš„å¼€å‘Servletå˜å¾—ç®€å•ã€‚ä½†æ˜¯ï¼Œæ­¤ç§æ–¹å¼æ˜¯å’Œ HTTP åè®®æ— å…³çš„ã€‚ ç¬¬ä¸‰ç§ï¼šç»§æ‰¿ HttpServletï¼Œå®ƒæ˜¯ javax.servlet.http åŒ…ä¸‹çš„ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæ˜¯ GenericServlet çš„å­ç±»ã€‚é€‰æ‹©ç»§æ‰¿ HttpServlet æ—¶ï¼Œéœ€è¦é‡å†™ doGet å’Œ doPost æ–¹æ³•ï¼Œæ¥æ¥æ”¶ get æ–¹å¼å’Œ post æ–¹å¼çš„è¯·æ±‚ï¼Œä¸è¦è¦†ç›– service æ–¹æ³•ã€‚ä½¿ç”¨æ­¤ç§æ–¹å¼ï¼Œè¡¨ç¤ºæˆ‘ä»¬çš„è¯·æ±‚å’Œå“åº”éœ€è¦å’Œ HTTP åè®®ç›¸å…³ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡ HTTP åè®®æ¥è®¿é—®ã€‚æ¯æ¬¡è¯·æ±‚å’Œå“åº”éƒ½ç¬¦åˆ HTTP åè®®çš„è§„èŒƒã€‚è¯·æ±‚çš„æ–¹å¼å°±æ˜¯ HTTP åè®®æ‰€æ”¯æŒçš„æ–¹å¼ï¼ˆGET POST PUT DELETE TRACE OPTIONS HEAD )ã€‚ ç›¸å…³é—®é¢˜å¼‚æ­¥å¤„ç†Servlet 3.0 ä¸­çš„å¼‚æ­¥å¤„ç†æŒ‡çš„æ˜¯å…è®¸Servleté‡æ–°å‘èµ·ä¸€æ¡æ–°çº¿ç¨‹å»è°ƒç”¨ è€—æ—¶ä¸šåŠ¡æ–¹æ³•ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…ç­‰å¾… ç”Ÿå‘½å‘¨æœŸservletä»åˆ›å»ºåˆ°é”€æ¯çš„è¿‡ç¨‹ï¼š å‡ºç”Ÿï¼šï¼ˆåˆå§‹åŒ–ï¼‰è¯·æ±‚ç¬¬ä¸€æ¬¡åˆ°è¾¾ Servlet æ—¶ï¼Œåˆ›å»ºå¯¹è±¡ï¼Œå¹¶ä¸”åˆå§‹åŒ–æˆåŠŸã€‚Only one time æ´»ç€ï¼šï¼ˆæœåŠ¡ï¼‰æœåŠ¡å™¨æä¾›æœåŠ¡çš„æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œè¯¥å¯¹è±¡ä¸€ç›´å­˜åœ¨ï¼Œæ¯æ¬¡åªæ˜¯æ‰§è¡Œ service æ–¹æ³• æ­»äº¡ï¼šï¼ˆé”€æ¯ï¼‰å½“æœåŠ¡åœæ­¢æ—¶ï¼Œæˆ–è€…æœåŠ¡å™¨å®•æœºæ—¶ï¼Œå¯¹è±¡åˆ é™¤ï¼Œ serrvletç”Ÿå‘½å‘¨æœŸæ–¹æ³•:init(ServletConfig config) â†’ service(ServletRequest req, ServletResponse res) â†’ destroy() é»˜è®¤æƒ…å†µä¸‹, æœ‰äº†ç¬¬ä¸€æ¬¡è¯·æ±‚, ä¼šè°ƒç”¨ init() æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ã€è°ƒç”¨ä¸€æ¬¡ã€‘ï¼Œä»»ä½•ä¸€æ¬¡è¯·æ±‚ï¼Œéƒ½ä¼šè°ƒç”¨ service() æ–¹æ³•å¤„ç†è¿™ä¸ªè¯·æ±‚ï¼ŒæœåŠ¡å™¨æ­£å¸¸å…³é—­æˆ–è€…é¡¹ç›®ä»æœåŠ¡å™¨ç§»é™¤, è°ƒç”¨ destory() æ–¹æ³•è¿›è¡Œé”€æ¯ã€è°ƒç”¨ä¸€æ¬¡ã€‘ æ‰©å±•ï¼šservlet æ˜¯å•ä¾‹å¤šçº¿ç¨‹çš„ï¼Œå°½é‡ä¸è¦åœ¨ servlet é‡Œé¢ä½¿ç”¨å…¨å±€(æˆå‘˜)å˜é‡ï¼Œå¯èƒ½ä¼šå¯¼è‡´çº¿ç¨‹ä¸å®‰å…¨ å•ä¾‹ï¼šServlet å¯¹è±¡åªä¼šåˆ›å»ºä¸€æ¬¡ï¼Œé”€æ¯ä¸€æ¬¡ï¼ŒServlet å¯¹è±¡åªæœ‰ä¸€ä¸ªå®ä¾‹ã€‚ å¤šçº¿ç¨‹ï¼šæœåŠ¡å™¨ä¼šé’ˆå¯¹æ¯æ¬¡è¯·æ±‚, å¼€å¯ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ service() æ–¹æ³•å¤„ç†è¿™ä¸ªè¯·æ±‚ çº¿ç¨‹å®‰å…¨Servletè¿ç”¨äº†å•ä¾‹æ¨¡å¼ï¼Œæ•´ä¸ªåº”ç”¨ä¸­åªæœ‰ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œæ‰€ä»¥éœ€è¦åˆ†æè¿™ä¸ªå”¯ä¸€çš„å®ä¾‹ä¸­çš„ç±»æˆå‘˜æ˜¯å¦çº¿ç¨‹å®‰å…¨ 12345678910111213141516171819202122232425262728public class ServletDemo extends HttpServlet&#123; //1.å®šä¹‰ç”¨æˆ·åæˆå‘˜å˜é‡ //private String username = null; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; String username = null; //synchronized (this) &#123; //2.è·å–ç”¨æˆ·å username = req.getParameter(&quot;username&quot;); try &#123; Thread.sleep(3000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; //3.è·å–è¾“å‡ºæµå¯¹è±¡ PrintWriter pw = resp.getWriter(); //4.å“åº”ç»™å®¢æˆ·ç«¯æµè§ˆå™¨ pw.print(&quot;Welcome:&quot; + username); //5.å…³æµ pw.close(); //&#125; &#125; @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doGet(req,resp); &#125;&#125; å¯åŠ¨ä¸¤ä¸ªæµè§ˆå™¨ï¼Œè¾“å…¥ä¸åŒçš„å‚æ•°(http://localhost:8080/ServletDemo/username=aaa æˆ–è€…bbb)ï¼Œè®¿é—®ä¹‹åå‘ç°è¾“å‡ºçš„ç»“æœéƒ½æ˜¯ä¸€æ ·ï¼Œæ‰€ä»¥å‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ åœ¨Servletä¸­å®šä¹‰äº†ç±»æˆå‘˜ä¹‹åï¼Œå¤šä¸ªæµè§ˆå™¨éƒ½ä¼šå…±äº«ç±»æˆå‘˜çš„æ•°æ®ï¼Œå…¶ä¸­ä»»ä½•ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†æ•°æ®ï¼Œéƒ½ä¼šå½±å“å…¶ä»–çº¿ç¨‹ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºServletå®ƒä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å› ä¸ºServletæ˜¯å•ä¾‹ï¼Œå•ä¾‹å¯¹è±¡çš„ç±»æˆå‘˜åªä¼šéšç±»å®ä¾‹åŒ–æ—¶åˆå§‹åŒ–ä¸€æ¬¡ï¼Œä¹‹åçš„æ“ä½œéƒ½æ˜¯æ”¹å˜ï¼Œè€Œä¸ä¼šé‡æ–°åˆå§‹åŒ–ã€‚ è§£å†³åŠæ³•ï¼šå¦‚æœç±»æˆå‘˜æ˜¯å…±ç”¨çš„ï¼Œåªåœ¨åˆå§‹åŒ–æ—¶èµ‹å€¼ï¼Œå…¶ä½™æ—¶é—´éƒ½æ˜¯è·å–ã€‚æˆ–è€…åŠ é”synchronized æ˜ å°„æ–¹å¼Servletæ”¯æŒä¸‰ç§æ˜ å°„æ–¹å¼ï¼Œä¸‰ç§æ˜ å°„æ–¹å¼çš„ä¼˜å…ˆçº§ä¸ºï¼šç¬¬ä¸€ç§&gt;ç¬¬äºŒç§&gt;ç¬¬ä¸‰ç§ã€‚ å…·ä½“åç§°æ–¹å¼è¿™ç§æ–¹å¼ï¼Œåªæœ‰å’Œæ˜ å°„é…ç½®ä¸€æ¨¡ä¸€æ ·æ—¶ï¼ŒServletæ‰ä¼šæ¥æ”¶å’Œå“åº”æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚è®¿é—®URLï¼šhttp://localhost:8080/servlet/servletDemo 12345678&lt;servlet&gt; &lt;servlet-name&gt;servletDemo&lt;/servlet-name&gt; &lt;servlet-class&gt;com.itheima.servlet.ServletDemo&lt;/servlet-class&gt;&lt;/servlet&gt;&lt;servlet-mapping&gt; &lt;servlet-name&gt;servletDemo&lt;/servlet-name&gt; &lt;url-pattern&gt;/servletDemo&lt;/url-pattern&gt;&lt;/servlet-mapping&gt; &#x2F;å¼€å¤´+é€šé…ç¬¦çš„æ–¹å¼è¿™ç§æ–¹å¼ï¼Œåªè¦ç¬¦åˆç›®å½•ç»“æ„å³å¯ï¼Œä¸ç”¨è€ƒè™‘ç»“å°¾æ˜¯ä»€ä¹ˆè®¿é—®URLï¼šhttp://localhost:8080/servlet/ + ä»»ä½•å­—ç¬¦ 12345678&lt;servlet&gt; &lt;servlet-name&gt;servletDemo&lt;/servlet-name&gt; &lt;servlet-class&gt;com.itheima.servlet.ServletDemo&lt;/servlet-class&gt;&lt;/servlet&gt;&lt;servlet-mapping&gt; &lt;servlet-name&gt;servletDemo&lt;/servlet-name&gt; &lt;url-pattern&gt;/servlet/*&lt;/url-pattern&gt;&lt;/servlet-mapping&gt; é€šé…ç¬¦+å›ºå®šæ ¼å¼ç»“å°¾è¿™ç§æ–¹å¼ï¼Œåªè¦ç¬¦åˆå›ºå®šç»“å°¾æ ¼å¼å³å¯ï¼Œå…¶å‰é¢çš„è®¿é—®URIæ— é¡»å…³å¿ƒï¼ˆæ³¨æ„åè®®ï¼Œä¸»æœºå’Œç«¯å£å¿…é¡»æ­£ç¡®ï¼‰è®¿é—®URLï¼šhttp://localhost:8080/ä»»ä½•å­—ç¬¦ä»»ä½•ç›®å½• + .do (http://localhost:8080/seazean/i.do) 12345678&lt;servlet&gt; &lt;servlet-name&gt;servletDemo05&lt;/servlet-name&gt; &lt;servlet-class&gt;com.itheima.servlet.ServletDemo05&lt;/servlet-class&gt;&lt;/servlet&gt;&lt;servlet-mapping&gt; &lt;servlet-name&gt;servletDemo05&lt;/servlet-name&gt; &lt;url-pattern&gt;*.do&lt;/url-pattern&gt;&lt;/servlet-mapping&gt; å¤šè·¯å¾„æ˜ å°„ä¸€ä¸ªServletçš„å¤šç§è·¯å¾„é…ç½®çš„æ”¯æŒã€‚ç»™ä¸€ä¸ªServleté…ç½®å¤šä¸ªè®¿é—®æ˜ å°„ï¼Œä»è€Œæ ¹æ®ä¸åŒè¯·æ±‚çš„URLå®ç°ä¸åŒçš„åŠŸèƒ½ 123456789101112131415161718192021222324252627/*å¤šè·¯æ˜ å°„*/public class ServletDemo06 extends HttpServlet &#123; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; int money = 1000; //è·å–è®¿é—®çš„èµ„æºè·¯å¾„ String name = req.getRequestURI(); name = name.substring(name.lastIndexOf(&quot;/&quot;)); if(&quot;/vip&quot;.equals(name)) &#123; //å¦‚æœè®¿é—®èµ„æºè·¯å¾„æ˜¯/vip å•†å“ä»·æ ¼ä¸º9æŠ˜ System.out.println(&quot;å•†å“åŸä»·ä¸ºï¼š&quot; + money + &quot;ã€‚ä¼˜æƒ åæ˜¯ï¼š&quot; + (money*0.9)); &#125; else if(&quot;/svip&quot;.equals(name)) &#123; //å¦‚æœè®¿é—®èµ„æºè·¯å¾„æ˜¯/svip å•†å“ä»·æ ¼ä¸º5æŠ˜ System.out.println(&quot;å•†å“åŸä»·ä¸ºï¼š&quot; + money + &quot;ã€‚ä¼˜æƒ åæ˜¯ï¼š&quot; + (money*0.5)); &#125; else &#123; //å¦‚æœè®¿é—®èµ„æºè·¯å¾„æ˜¯å…¶ä»– å•†å“ä»·æ ¼åŸæ ·æ˜¾ç¤º System.out.println(&quot;å•†å“ä»·æ ¼ä¸ºï¼š&quot; + money); &#125; &#125; @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doGet(req,resp); &#125;&#125; 12345678910111213141516171819202122232425&lt;!--æ¼”ç¤ºServletå¤šè·¯å¾„æ˜ å°„--&gt;&lt;servlet&gt; &lt;servlet-name&gt;vip&lt;/servlet-name&gt; &lt;servlet-class&gt;com.itheima.servlet.ServletDemo06&lt;/servlet-class&gt;&lt;/servlet&gt;&lt;servlet-mapping&gt; &lt;servlet-name&gt;vip&lt;/servlet-name&gt; &lt;url-pattern&gt;/vip&lt;/url-pattern&gt;&lt;/servlet-mapping&gt;&lt;servlet&gt; &lt;servlet-name&gt;svip&lt;/servlet-name&gt; &lt;servlet-class&gt;com.itheima.servlet.ServletDemo06&lt;/servlet-class&gt;&lt;/servlet&gt;&lt;servlet-mapping&gt; &lt;servlet-name&gt;svip&lt;/servlet-name&gt; &lt;url-pattern&gt;/svip&lt;/url-pattern&gt;&lt;/servlet-mapping&gt;&lt;servlet&gt; &lt;servlet-name&gt;other&lt;/servlet-name&gt; &lt;servlet-class&gt;com.itheima.servlet.ServletDemo06&lt;/servlet-class&gt;&lt;/servlet&gt;&lt;servlet-mapping&gt; &lt;servlet-name&gt;other&lt;/servlet-name&gt; &lt;url-pattern&gt;/other&lt;/url-pattern&gt;&lt;/servlet-mapping&gt; è¿™æ ·å°±å¯ä»¥æ ¹æ®ä¸åŒçš„ç½‘é¡µæ˜¾ç¤ºä¸åŒçš„æ•°æ®ã€‚ å¯åŠ¨æ—¶åˆ›å»º ç¬¬ä¸€ç§ï¼šåº”ç”¨åŠ è½½æ—¶åˆ›å»ºServletï¼Œå®ƒçš„ä¼˜åŠ¿æ˜¯åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶ï¼Œå°±æŠŠéœ€è¦çš„å¯¹è±¡éƒ½åˆ›å»ºå®Œæˆäº†ï¼Œä»è€Œåœ¨ä½¿ç”¨çš„æ—¶å€™å‡å°‘äº†åˆ›å»ºå¯¹è±¡çš„æ—¶é—´ï¼Œæé«˜äº†é¦–æ¬¡æ‰§è¡Œçš„æ•ˆç‡ã€‚å®ƒçš„å¼Šç«¯æ˜¯åœ¨åº”ç”¨åŠ è½½æ—¶å°±åˆ›å»ºäº†Servletå¯¹è±¡ï¼Œå› æ­¤ï¼Œå¯¼è‡´å†…å­˜ä¸­å……æ–¥ç€å¤§é‡ç”¨ä¸ä¸Šçš„Servletå¯¹è±¡ï¼Œé€ æˆäº†å†…å­˜çš„æµªè´¹ã€‚ ç¬¬äºŒç§ï¼šè¯·æ±‚ç¬¬ä¸€æ¬¡è®¿é—®æ˜¯åˆ›å»ºServletï¼Œå®ƒçš„ä¼˜åŠ¿å°±æ˜¯å‡å°‘äº†å¯¹æœåŠ¡å™¨å†…å­˜çš„æµªè´¹ï¼Œå› ä¸ºä¸€ç›´æ²¡æœ‰è¢«è®¿é—®è¿‡çš„Servletå¯¹è±¡éƒ½æ²¡æœ‰åˆ›å»ºï¼Œå› æ­¤ä¹Ÿæé«˜äº†æœåŠ¡å™¨çš„å¯åŠ¨æ—¶é—´ã€‚è€Œå®ƒçš„å¼Šç«¯å°±æ˜¯è¦åœ¨åº”ç”¨åŠ è½½æ—¶å°±åšçš„åˆå§‹åŒ–æ“ä½œï¼Œå®ƒéƒ½æ²¡æ³•å®Œæˆï¼Œä»è€Œè¦è€ƒè™‘å…¶ä»–æŠ€æœ¯å®ç°ã€‚ åœ¨web.xmlä¸­æ˜¯æ”¯æŒå¯¹Servletçš„åˆ›å»ºæ—¶æœºè¿›è¡Œé…ç½®çš„ï¼Œé…ç½®çš„æ–¹å¼å¦‚ä¸‹ï¼š 123456789101112&lt;!--é…ç½®ServletDemo3--&gt;&lt;servlet&gt; &lt;servlet-name&gt;servletDemo&lt;/servlet-name&gt; &lt;servlet-class&gt;com.itheima.web.servlet.ServletDemo&lt;/servlet-class&gt; &lt;!--é…ç½®Servletçš„åˆ›å»ºé¡ºåºï¼Œå½“é…ç½®æ­¤æ ‡ç­¾æ—¶ï¼ŒServletå°±ä¼šæ”¹ä¸ºåº”ç”¨åŠ è½½æ—¶åˆ›å»º é…ç½®é¡¹çš„å–å€¼åªèƒ½æ˜¯æ­£æ•´æ•°ï¼ˆåŒ…æ‹¬0ï¼‰ï¼Œæ•°å€¼è¶Šå°ï¼Œè¡¨æ˜åˆ›å»ºçš„ä¼˜å…ˆçº§è¶Šé«˜--&gt; &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;&lt;/servlet&gt;&lt;servlet-mapping&gt; &lt;servlet-name&gt;servletDemo&lt;/servlet-name&gt; &lt;url-pattern&gt;/servletDemo&lt;/url-pattern&gt;&lt;/servlet-mapping&gt; é»˜è®¤Servleté»˜è®¤ Servlet æ˜¯ç”±æœåŠ¡å™¨æä¾›çš„ä¸€ä¸ª Servletï¼Œå®ƒé…ç½®åœ¨ Tomcat çš„ conf ç›®å½•ä¸‹çš„ web.xml ä¸­ã€‚ å®ƒçš„æ˜ å°„è·¯å¾„æ˜¯&lt;url-pattern&gt;/&lt;url-pattern&gt;ï¼Œæˆ‘ä»¬åœ¨å‘é€è¯·æ±‚æ—¶ï¼Œé¦–å…ˆä¼šåœ¨æˆ‘ä»¬åº”ç”¨ä¸­çš„ web.xml ä¸­æŸ¥æ‰¾æ˜ å°„é…ç½®ã€‚ä½†æ˜¯å½“æ‰¾ä¸åˆ°å¯¹åº”çš„ Servlet è·¯å¾„æ—¶ï¼Œå°±å»æ‰¾é»˜è®¤çš„ Servletï¼Œç”±é»˜è®¤ Servlet å¤„ç†ã€‚ ServletConfigServletConfig æ˜¯ Servlet çš„é…ç½®å‚æ•°å¯¹è±¡ã€‚åœ¨ Servlet è§„èŒƒä¸­ï¼Œå…è®¸ä¸ºæ¯ä¸ª Servlet éƒ½æä¾›ä¸€äº›åˆå§‹åŒ–é…ç½®ï¼Œæ¯ä¸ª Servlet éƒ½æœ‰è‡ªå·±çš„ServletConfigï¼Œä½œç”¨æ˜¯åœ¨ Servlet åˆå§‹åŒ–æœŸé—´ï¼ŒæŠŠä¸€äº›é…ç½®ä¿¡æ¯ä¼ é€’ç»™ Servlet ç”Ÿå‘½å‘¨æœŸï¼šåœ¨åˆå§‹åŒ–é˜¶æ®µè¯»å–äº† web.xml ä¸­ä¸º Servlet å‡†å¤‡çš„åˆå§‹åŒ–é…ç½®ï¼Œå¹¶æŠŠé…ç½®ä¿¡æ¯ä¼ é€’ç»™ Servletï¼Œæ‰€ä»¥ç”Ÿå‘½å‘¨æœŸä¸ Servlet ç›¸åŒã€‚å¦‚æœ Servlet é…ç½®äº† &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;ï¼ŒServletConfig ä¹Ÿä¼šåœ¨åº”ç”¨åŠ è½½æ—¶åˆ›å»ºã€‚ è·å– ServletConfigï¼šåœ¨ init æ–¹æ³•ä¸­ä¸º ServletConfig èµ‹å€¼ å¸¸ç”¨APIï¼š String getInitParameter(String name)ï¼šæ ¹æ®åˆå§‹åŒ–å‚æ•°çš„åç§°è·å–å‚æ•°çš„å€¼ï¼Œæ ¹æ®ï¼Œè·å– Enumeration&lt;String&gt; getInitParameterNames() : è·å–æ‰€æœ‰åˆå§‹åŒ–å‚æ•°åç§°çš„æšä¸¾(éå†æ–¹å¼çœ‹ä¾‹å­) ServletContext getServletContext() : è·å–ServletContextå¯¹è±¡ String getServletName() : è·å–Servletåç§° ä»£ç å®ç°ï¼š web.xml é…ç½®ï¼šåˆå§‹åŒ–å‚æ•°ä½¿ç”¨ &lt;servlet&gt; æ ‡ç­¾ä¸­çš„ &lt;init-param&gt; æ ‡ç­¾æ¥é…ç½®ï¼Œå¹¶ä¸”æ¯ä¸ª Servlet éƒ½æ”¯æŒæœ‰å¤šä¸ªåˆå§‹åŒ–å‚æ•°ï¼Œå¹¶ä¸”åˆå§‹åŒ–å‚æ•°éƒ½æ˜¯ä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜åœ¨çš„ 123456789101112131415161718192021&lt;!--é…ç½®ServletDemo8--&gt;&lt;servlet&gt; &lt;servlet-name&gt;servletDemo8&lt;/servlet-name&gt; &lt;servlet-class&gt;com.itheima.web.servlet.ServletDemo8&lt;/servlet-class&gt; &lt;!--é…ç½®åˆå§‹åŒ–å‚æ•°--&gt; &lt;init-param&gt; &lt;!--ç”¨äºè·å–åˆå§‹åŒ–å‚æ•°çš„key--&gt; &lt;param-name&gt;encoding&lt;/param-name&gt; &lt;!--åˆå§‹åŒ–å‚æ•°çš„å€¼--&gt; &lt;param-value&gt;UTF-8&lt;/param-value&gt; &lt;/init-param&gt; &lt;!--æ¯ä¸ªåˆå§‹åŒ–å‚æ•°éƒ½éœ€è¦ç”¨åˆ°init-paramæ ‡ç­¾--&gt; &lt;init-param&gt; &lt;param-name&gt;servletInfo&lt;/param-name&gt; &lt;param-value&gt;This is Demo8&lt;/param-value&gt; &lt;/init-param&gt;&lt;/servlet&gt;&lt;servlet-mapping&gt; &lt;servlet-name&gt;servletDemo8&lt;/servlet-name&gt; &lt;url-pattern&gt;/servletDemo8&lt;/url-pattern&gt;&lt;/servlet-mapping&gt; ä»£ç ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344//æ¼”ç¤ºServletçš„åˆå§‹åŒ–å‚æ•°å¯¹è±¡public class ServletDemo8 extends HttpServlet &#123; //å®šä¹‰Servleté…ç½®å¯¹è±¡ServletConfig private ServletConfig servletConfig; //åœ¨åˆå§‹åŒ–æ—¶ä¸ºServletConfigèµ‹å€¼ @Override public void init(ServletConfig config) throws ServletException &#123; this.servletConfig = config; &#125; /** * doGetæ–¹æ³•è¾“å‡ºä¸€å¥è¯ */ @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; //1.è¾“å‡ºServletConfig System.out.println(servletConfig); //2.è·å–Servletçš„åç§° String servletName= servletConfig.getServletName(); System.out.println(servletName); //3.è·å–å­—ç¬¦é›†ç¼–ç  String encoding = servletConfig.getInitParameter(&quot;encoding&quot;); System.out.println(encoding); //4.è·å–æ‰€æœ‰åˆå§‹åŒ–å‚æ•°åç§°çš„æšä¸¾ Enumeration&lt;String&gt; names = servletConfig.getInitParameterNames(); //éå†names while(names.hasMoreElements())&#123; //å–å‡ºæ¯ä¸ªname String name = names.nextElement(); //æ ¹æ®keyè·å–value String value = servletConfig.getInitParameter(name); System.out.println(&quot;name:&quot;+name+&quot;,value:&quot;+value); &#125; //5.è·å–ServletContextå¯¹è±¡ ServletContext servletContext = servletConfig.getServletContext(); System.out.println(servletContext); &#125; //è°ƒç”¨doGetæ–¹æ³• @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doGet(req,resp); &#125;&#125; æ•ˆæœï¼š ServletContextServletContext å¯¹è±¡æ˜¯åº”ç”¨ä¸Šä¸‹æ–‡å¯¹è±¡ã€‚æœåŠ¡å™¨ä¸ºæ¯ä¸€ä¸ªåº”ç”¨éƒ½åˆ›å»ºäº†ä¸€ä¸ª ServletContext å¯¹è±¡ï¼ŒServletContext å±äºæ•´ä¸ªåº”ç”¨ï¼Œä¸å±€é™äºæŸä¸ª Servletï¼Œå¯ä»¥å®ç°è®©åº”ç”¨ä¸­æ‰€æœ‰ Servlet é—´çš„æ•°æ®å…±äº«ã€‚ ä¸Šä¸‹æ–‡ä»£è¡¨äº†ç¨‹åºå½“ä¸‹æ‰€è¿è¡Œçš„ç¯å¢ƒï¼Œè”ç³»æ•´ä¸ªåº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸä¸èµ„æºè°ƒç”¨ï¼Œæ˜¯ç¨‹åºå¯ä»¥è®¿é—®åˆ°çš„æ‰€æœ‰èµ„æºçš„æ€»å’Œï¼Œèµ„æºå¯ä»¥æ˜¯ä¸€ä¸ªå˜é‡ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨ ç”Ÿå‘½å‘¨æœŸï¼š å‡ºç”Ÿï¼šåº”ç”¨ä¸€åŠ è½½ï¼Œè¯¥å¯¹è±¡å°±è¢«åˆ›å»ºå‡ºæ¥ã€‚ä¸€ä¸ªåº”ç”¨åªæœ‰ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼ˆServlet å’Œ ServletContext éƒ½æ˜¯å•ä¾‹çš„ï¼‰ æ´»ç€ï¼šåªè¦åº”ç”¨ä¸€ç›´æä¾›æœåŠ¡ï¼Œè¯¥å¯¹è±¡å°±ä¸€ç›´å­˜åœ¨ã€‚ æ­»äº¡ï¼šåº”ç”¨è¢«å¸è½½ï¼ˆæˆ–è€…æœåŠ¡å™¨åœæ­¢ï¼‰ï¼Œè¯¥å¯¹è±¡æ¶ˆäº¡ã€‚ åŸŸå¯¹è±¡ï¼šæŒ‡çš„æ˜¯å¯¹è±¡æœ‰ä½œç”¨åŸŸï¼Œå³æœ‰ä½œç”¨èŒƒå›´ï¼Œå¯ä»¥å®ç°æ•°æ®å…±äº«ï¼Œä¸åŒä½œç”¨èŒƒå›´çš„åŸŸå¯¹è±¡ï¼Œå…±äº«æ•°æ®çš„èƒ½åŠ›ä¸ä¸€æ ·ã€‚ Servlet è§„èŒƒä¸­ï¼Œå…±æœ‰4ä¸ªåŸŸå¯¹è±¡ï¼ŒServletContext æ˜¯å…¶ä¸­ä¸€ä¸ªï¼Œweb åº”ç”¨ä¸­æœ€å¤§çš„ä½œç”¨åŸŸï¼Œå« application åŸŸï¼Œå¯ä»¥å®ç°æ•´ä¸ªåº”ç”¨é—´çš„æ•°æ®å…±äº«åŠŸèƒ½ã€‚ æ•°æ®å…±äº«ï¼š è·å–ServletContextï¼š Java é¡¹ç›®ç»§æ‰¿ HttpServletï¼ŒHttpServlet ç»§æ‰¿ GenericServletï¼ŒGenericServlet ä¸­æœ‰ä¸€ä¸ªæ–¹æ³•å¯ä»¥ç›´æ¥ä½¿ç”¨ 123public ServletContext getServletContext() &#123; return this.getServletConfig().getServletContext();&#125; ServletRequest ç±»æ–¹æ³•ï¼š 1ServletContext getServletContext()//è·å–ServletContextå¯¹è±¡ å¸¸ç”¨APIï¼š String getInitParameter(String name) : æ ¹æ®åç§°è·å–å…¨å±€é…ç½®çš„å‚æ•° String getContextPath : è·å–å½“å‰åº”ç”¨è®¿é—®çš„è™šæ‹Ÿç›®å½• String getRealPath(String path) : æ ¹æ®è™šæ‹Ÿç›®å½•è·å–åº”ç”¨éƒ¨ç½²çš„ç£ç›˜ç»å¯¹è·¯å¾„ void setAttribute(String name, Object object) : å‘åº”ç”¨åŸŸå¯¹è±¡ä¸­å­˜å‚¨æ•°æ® Object getAttribute(String name) : æ ¹æ®åç§°è·å–åŸŸå¯¹è±¡ä¸­çš„æ•°æ®ï¼Œæ²¡æœ‰åˆ™è¿”å›null void removeAttribute(String name) : æ ¹æ®åç§°ç§»é™¤åº”ç”¨åŸŸå¯¹è±¡ä¸­çš„æ•°æ® ä»£ç å®ç°ï¼š web.xmlé…ç½®ï¼šé…ç½®çš„æ–¹å¼ï¼Œéœ€è¦åœ¨&lt;web-app&gt;æ ‡ç­¾ä¸­ä½¿ç”¨&lt;context-param&gt;æ¥é…ç½®åˆå§‹åŒ–å‚æ•°ï¼Œå®ƒçš„é…ç½®æ˜¯é’ˆå¯¹æ•´ä¸ªåº”ç”¨çš„é…ç½®ï¼Œè¢«ç§°ä¸ºåº”ç”¨çš„åˆå§‹åŒ–å‚æ•°é…ç½®ã€‚ 123456789101112&lt;!--é…ç½®åº”ç”¨åˆå§‹åŒ–å‚æ•°--&gt;&lt;context-param&gt; &lt;!--ç”¨äºè·å–åˆå§‹åŒ–å‚æ•°çš„key--&gt; &lt;param-name&gt;servletContextInfo&lt;/param-name&gt; &lt;!--åˆå§‹åŒ–å‚æ•°çš„å€¼--&gt; &lt;param-value&gt;This is application scope&lt;/param-value&gt;&lt;/context-param&gt;&lt;!--æ¯ä¸ªåº”ç”¨åˆå§‹åŒ–å‚æ•°éƒ½éœ€è¦ç”¨åˆ°context-paramæ ‡ç­¾--&gt;&lt;context-param&gt; &lt;param-name&gt;globalEncoding&lt;/param-name&gt; &lt;param-value&gt;UTF-8&lt;/param-value&gt;&lt;/context-param&gt; ä»£ç ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243public class ServletContextDemo extends HttpServlet &#123; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; //è·å–ServletContextå¯¹è±¡ ServletContext context = getServletContext(); //è·å–å…¨å±€é…ç½®çš„globalEncoding String value = context.getInitParameter(&quot;globalEncoding&quot;); System.out.println(value);//UTF-8 //è·å–åº”ç”¨çš„è®¿é—®è™šæ‹Ÿç›®å½• String contextPath = context.getContextPath(); System.out.println(contextPath);//servlet //æ ¹æ®è™šæ‹Ÿç›®å½•è·å–åº”ç”¨éƒ¨ç½²çš„ç£ç›˜ç»å¯¹è·¯å¾„ //è·å–b.txtæ–‡ä»¶çš„ç»å¯¹è·¯å¾„ webç›®å½•ä¸‹ String b = context.getRealPath(&quot;/b.txt&quot;); System.out.println(b); //è·å–c.txtæ–‡ä»¶çš„ç»å¯¹è·¯å¾„ /WEB-INFç›®å½•ä¸‹ String c = context.getRealPath(&quot;/WEB-INF/c.txt&quot;); System.out.println(c); //è·å–a.txtæ–‡ä»¶çš„ç»å¯¹è·¯å¾„ //srcç›®å½•ä¸‹ String a = context.getRealPath(&quot;/WEB-INF/classes/a.txt&quot;); System.out.println(a); //å‘åŸŸå¯¹è±¡ä¸­å­˜å‚¨æ•°æ® context.setAttribute(&quot;username&quot;,&quot;zhangsan&quot;); //ç§»é™¤åŸŸå¯¹è±¡ä¸­usernameçš„æ•°æ® //context.removeAttribute(&quot;username&quot;); &#125; @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doGet(req,resp); &#125;&#125;//E:\\Database\\Java\\Project\\JavaEE\\out\\artifacts\\Servlet_war_exploded\\b.txt//E:\\Database\\Java\\Project\\JavaEE\\out\\artifacts\\Servlet_war_exploded\\WEB-INF\\c.txt//E:\\Database\\Java\\Project\\JavaEE\\out\\artifacts\\Servlet_war_exploded\\WEB-INF\\classes\\a.txt æ³¨è§£å¼€å‘Servlet3.0 ç‰ˆæœ¬ï¼ä¸éœ€è¦é…ç½® web.xml æ³¨è§£æ¡ˆä¾‹ 123456789101112@WebServlet(&quot;/servletDemo1&quot;)public class ServletDemo1 extends HttpServlet &#123; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doPost(req,resp); &#125; @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; System.out.println(&quot;Servlet Demo1 Annotation&quot;); &#125;&#125; WebServletæ³¨è§£ï¼ˆ@since Servlet 3.0 (Section 8.1.1)ï¼‰ 12345678910111213141516171819202122232425262728293031323334@Target(ElementType.TYPE)@Retention(RetentionPolicy.RUNTIME)@Documentedpublic @interface WebServlet &#123; //æŒ‡å®šServletçš„åç§°ã€‚ç›¸å½“äºxmlé…ç½®ä¸­&lt;servlet&gt;æ ‡ç­¾ä¸‹çš„&lt;servlet-name&gt; String name() default &quot;&quot;; //ç”¨äºæ˜ å°„Servletè®¿é—®çš„urlæ˜ å°„ï¼Œç›¸å½“äºxmlé…ç½®æ—¶çš„&lt;url-pattern&gt; String[] value() default &#123;&#125;; //ç›¸å½“äºxmlé…ç½®æ—¶çš„&lt;url-pattern&gt; String[] urlPatterns() default &#123;&#125;; //ç”¨äºé…ç½®Servletçš„å¯åŠ¨æ—¶æœºï¼Œç›¸å½“äºxmlé…ç½®çš„&lt;load-on-startup&gt; int loadOnStartup() default -1; //ç”¨äºé…ç½®Servletçš„åˆå§‹åŒ–å‚æ•°ï¼Œç›¸å½“äºxmlé…ç½®çš„&lt;init-param&gt; WebInitParam[] initParams() default &#123;&#125;; //ç”¨äºé…ç½®Servletæ˜¯å¦æ”¯æŒå¼‚æ­¥ï¼Œç›¸å½“äºxmlé…ç½®çš„&lt;async-supported&gt; boolean asyncSupported() default false; //ç”¨äºæŒ‡å®šServletçš„å°å›¾æ ‡ String smallIcon() default &quot;&quot;; //ç”¨äºæŒ‡å®šServletçš„å¤§å›¾æ ‡ String largeIcon() default &quot;&quot;; //ç”¨äºæŒ‡å®šServletçš„æè¿°ä¿¡æ¯ String description() default &quot;&quot;; //ç”¨äºæŒ‡å®šServletçš„æ˜¾ç¤ºåç§° String displayName() default &quot;&quot;;&#125; æ‰‹åŠ¨åˆ›å»ºå®¹å™¨ï¼šï¼ˆäº†è§£ï¼‰ Requestè¯·æ±‚å“åº”WebæœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯çš„httpè¯·æ±‚ï¼Œä¼šé’ˆå¯¹æ¯ä¸€æ¬¡è¯·æ±‚ï¼Œåˆ†åˆ«åˆ›å»ºä¸€ä¸ªç”¨äºä»£è¡¨è¯·æ±‚çš„requestå¯¹è±¡ã€å’Œä»£è¡¨å“åº”çš„responseå¯¹è±¡ã€‚ è¯·æ±‚å¯¹è±¡è¯·æ±‚ï¼šå®¢æˆ·æœºå¸Œæœ›ä»æœåŠ¡å™¨ç«¯ç´¢å–ä¸€äº›èµ„æºï¼Œå‘æœåŠ¡å™¨å‘å‡ºè¯¢é—® è¯·æ±‚å¯¹è±¡ï¼šåœ¨ JavaEE å·¥ç¨‹ä¸­ï¼Œç”¨äºå‘é€è¯·æ±‚çš„å¯¹è±¡ï¼Œå¸¸ç”¨çš„å¯¹è±¡æ˜¯ ServletRequest å’Œ HttpServletRequest ï¼Œå®ƒä»¬çš„åŒºæ˜¯æ˜¯å¦ä¸ HTTP åè®®æœ‰å…³ Request ä½œç”¨ï¼š æ“ä½œè¯·æ±‚ä¸‰éƒ¨åˆ†(è¡Œ,å¤´,ä½“) è¯·æ±‚è½¬å‘ ä½œä¸ºåŸŸå¯¹è±¡å­˜æ•°æ® è¯·æ±‚è·¯å¾„ æ–¹æ³• ä½œç”¨ String getLocalAddr() è·å–æœ¬æœºï¼ˆæœåŠ¡å™¨ï¼‰åœ°å€ String getLocalName() è·å–æœ¬æœºï¼ˆæœåŠ¡å™¨ï¼‰åç§° int getLocalPort() è·å–æœ¬æœºï¼ˆæœåŠ¡å™¨ï¼‰ç«¯å£ String getRemoteAddr() è·å–è®¿é—®è€…IP String getRemoteHost è·å–è®¿é—®è€…ä¸»æœº int getRemotePort() è·å–è®¿é—®è€…ç«¯å£ String getMethod(); è·å¾—è¯·æ±‚æ–¹å¼ String getRequestURI() è·å–ç»Ÿä¸€èµ„æºæ ‡è¯†ç¬¦ï¼ˆ&#x2F;request&#x2F;servletDemo01ï¼‰ String getRequestURL() è·å–ç»Ÿä¸€èµ„æºå®šä½ç¬¦ï¼ˆhttp://localhost:8080/request/servletDemo01ï¼‰ String getQueryString() è·å–è¯·æ±‚æ¶ˆæ¯çš„æ•°æ®ï¼ˆGETæ–¹å¼ URLä¸­å¸¦å‚å­—ç¬¦ä¸²ï¼šusername&#x3D;aaa&amp;password&#x3D;123ï¼‰ String getContextPath() è·å–è™šæ‹Ÿç›®å½•åç§°ï¼ˆ&#x2F;requestï¼‰ String getServletPath è·å–Servletæ˜ å°„è·¯å¾„ï¼ˆæˆ–@WebServletå€¼: &#x2F;servletDemo01ï¼‰ String getRealPath(String path) æ ¹æ®è™šæ‹Ÿç›®å½•è·å–åº”ç”¨éƒ¨ç½²çš„ç£ç›˜ç»å¯¹è·¯å¾„ URL &#x3D; URI + HOST URL &#x3D; HOST + ContextPath + ServletPath è·å–è¯·æ±‚å¤´ æ–¹æ³• ä½œç”¨ String getHeader(String name) è·å¾—æŒ‡å®šè¯·æ±‚å¤´çš„å€¼ã€‚å¦‚æœæ²¡æœ‰è¯¥è¯·æ±‚å¤´è¿”å›nullï¼Œæœ‰å¤šä¸ªå€¼è¿”å›ç¬¬ä¸€ä¸ª Enumeration getHeaders(String name) è·å–æŒ‡å®šè¯·æ±‚å¤´çš„å¤šä¸ªå€¼ Enumeration getHeaderNames() è·å–æ‰€æœ‰è¯·æ±‚å¤´åç§°çš„æšä¸¾ 1234567891011121314151617181920@WebServlet(&quot;/servletDemo02&quot;)public class ServletDemo02 extends HttpServlet &#123; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; //1.æ ¹æ®è¯·æ±‚å¤´åç§°è·å–ä¸€ä¸ªå€¼ String connection = req.getHeader(&quot;connection&quot;); System.out.println(connection);//keep-alive //2.æ ¹æ®è¯·æ±‚å¤´åç§°è·å–å¤šä¸ªå€¼ Enumeration&lt;String&gt; values = req.getHeaders(&quot;accept-encoding&quot;); while(values.hasMoreElements()) &#123; String value = values.nextElement(); System.out.println(value);//gzip, deflate, br &#125; &#125; @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doGet(req,resp); &#125;&#125; è¯·æ±‚å‚æ•°è¯·æ±‚å‚æ•°è¯·æ±‚å‚æ•°æ˜¯æ­£æ–‡éƒ¨åˆ†æ ‡ç­¾å†…å®¹ï¼Œæ ‡ç­¾å±æ€§action&#x3D;â€&#x2F;request&#x2F;servletDemo08â€ï¼ŒæœåŠ¡å™¨URI æ³•å ä½œç”¨ String getParameter(String name) è·å¾—æŒ‡å®šå‚æ•°åçš„å€¼å¦‚æœæ²¡æœ‰è¯¥å‚æ•°åˆ™è¿”å›nullï¼Œå¦‚æœæœ‰å¤šä¸ªè·å¾—ç¬¬ä¸€ä¸ª String[] getParameterValues(String name) è·å¾—æŒ‡å®šå‚æ•°åæ‰€æœ‰çš„å€¼ã€‚æ­¤æ–¹æ³•ä¸ºå¤é€‰æ¡†æä¾›çš„ Enumeration getParameterNames() è·å¾—æ‰€æœ‰å‚æ•°å Map&lt;String,String[]&gt; getParameterMap() è·å¾—æ‰€æœ‰çš„è¯·æ±‚å‚æ•°é”®å€¼å¯¹ï¼ˆkey&#x3D;valueï¼‰ å°è£…å‚æ•°å°è£…è¯·æ±‚å‚æ•°åˆ°ç±»å¯¹è±¡ï¼š ç›´æ¥å°è£…ï¼šæœ‰å‚æ„é€ æˆ–è€…setæ–¹æ³• 1234567891011121314151617181920212223@WebServlet(&quot;/servletDemo04&quot;)public class ServletDemo04 extends HttpServlet &#123; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; //1.è·å–æ‰€æœ‰çš„æ•°æ® String username = req.getParameter(&quot;username&quot;); String password = req.getParameter(&quot;password&quot;); String[] hobbies = req.getParameterValues(&quot;hobby&quot;); //2.å°è£…å­¦ç”Ÿå¯¹è±¡ Student stu = new Student(username,password,hobbies); //3.è¾“å‡ºå¯¹è±¡ System.out.println(stu); &#125; @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doGet(req,resp); &#125;&#125; 123456public class Student &#123; private String username; private String password; private String[] hobby; &#125; 1234567891011121314151617&lt;!--register.html--&gt;&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;æ³¨å†Œé¡µé¢&lt;/title&gt;&lt;/head&gt;&lt;body&gt; &lt;form action=&quot;/request/servletDemo05&quot; method=&quot;get&quot; autocomplete=&quot;off&quot;&gt; å§“åï¼š&lt;input type=&quot;text&quot; name=&quot;username&quot;&gt; &lt;br&gt; å¯†ç ï¼š&lt;input type=&quot;password&quot; name=&quot;password&quot;&gt; &lt;br&gt; çˆ±å¥½ï¼š&lt;input type=&quot;checkbox&quot; name=&quot;hobby&quot; value=&quot;study&quot;&gt;å­¦ä¹  &lt;input type=&quot;checkbox&quot; name=&quot;hobby&quot; value=&quot;game&quot;&gt;æ¸¸æˆ &lt;br&gt; &lt;button type=&quot;submit&quot;&gt;æ³¨å†Œ&lt;/button&gt; &lt;/form&gt;&lt;/body&gt;&lt;/html&gt; åå°„æ–¹å¼ï¼š è¡¨å•&lt;input&gt;æ ‡ç­¾çš„nameå±æ€§å–å€¼ï¼Œå¿…é¡»å’Œå®ä½“ç±»ä¸­å®šä¹‰çš„å±æ€§åç§°ä¸€è‡´ 12345678910111213141516171819202122232425262728protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; //1.è·å–è¯·æ±‚æ­£æ–‡çš„æ˜ å°„å…³ç³» Map&lt;String, String[]&gt; map = req.getParameterMap(); //2.å°è£…å­¦ç”Ÿå¯¹è±¡ Student stu = new Student(); //2.1éå†é›†åˆ for(String name : map.keySet()) &#123; String[] value = map.get(name); try &#123; //2.2è·å–Studentå¯¹è±¡çš„å±æ€§æè¿°å™¨ //å‚æ•°ä¸€ï¼šæŒ‡å®šè·å–xxxå±æ€§çš„æè¿°å™¨ //å‚æ•°äºŒï¼šæŒ‡å®šå­—èŠ‚ç æ–‡ä»¶ PropertyDescriptor pd = new PropertyDescriptor(name,stu.getClass()); //2.3è·å–å¯¹åº”çš„setXxxæ–¹æ³• Method writeMethod = pd.getWriteMethod(); //2.4æ‰§è¡Œæ–¹æ³• if(value.length &gt; 1) &#123; writeMethod.invoke(stu,(Object)value); &#125;else &#123; writeMethod.invoke(stu,value); &#125; &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125; //3.è¾“å‡ºå¯¹è±¡ System.out.println(stu);&#125; commons-beanutilså°è£… 1234567891011121314protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; //1.è·å–æ‰€æœ‰çš„æ•°æ® Map&lt;String, String[]&gt; map = req.getParameterMap(); //2.å°è£…å­¦ç”Ÿå¯¹è±¡ Student stu = new Student(); try &#123; BeanUtils.populate(stu,map); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; //3.è¾“å‡ºå¯¹è±¡ System.out.println(stu);&#125; æµè·å–æ•°æ®ServletInputStream getInputStream() : è·å–è¯·æ±‚å­—èŠ‚è¾“å…¥æµå¯¹è±¡BufferedReader getReader() : è·å–è¯·æ±‚ç¼“å†²å­—ç¬¦è¾“å…¥æµå¯¹è±¡ 1234567891011121314151617181920212223242526@WebServlet(&quot;/servletDemo07&quot;)public class ServletDemo07 extends HttpServlet &#123; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; //å­—ç¬¦æµ(å¿…é¡»æ˜¯postæ–¹å¼) /*BufferedReader br = req.getReader(); String line; while((line = br.readLine()) != null) &#123; System.out.println(line); &#125;*/ //br.close(); //å­—èŠ‚æµ ServletInputStream is = req.getInputStream(); byte[] arr = new byte[1024]; int len; while((len = is.read(arr)) != -1) &#123; System.out.println(new String(arr,0,len)); &#125; //is.close(); &#125; @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doGet(req,resp); &#125;&#125; 12&lt;form action=&quot;/request/servletDemo07&quot; method=&quot;get&quot; autocomplete=&quot;off&quot;&gt;&lt;/form&gt; è¯·æ±‚åŸŸè¯·æ±‚åŸŸrequest åŸŸï¼šå¯ä»¥åœ¨ä¸€æ¬¡è¯·æ±‚èŒƒå›´å†…è¿›è¡Œå…±äº«æ•°æ® æ–¹æ³• ä½œç”¨ void setAttribute(String name, Object value) å‘è¯·æ±‚åŸŸå¯¹è±¡ä¸­å­˜å‚¨æ•°æ® Object getAttribute(String name) é€šè¿‡åç§°è·å–è¯·æ±‚åŸŸå¯¹è±¡çš„æ•°æ® void removeAttribute(String name) é€šè¿‡åç§°ç§»é™¤è¯·æ±‚åŸŸå¯¹è±¡çš„æ•°æ® è¯·æ±‚è½¬å‘è¯·æ±‚è½¬å‘ï¼šå®¢æˆ·ç«¯çš„ä¸€æ¬¡è¯·æ±‚åˆ°è¾¾åï¼Œéœ€è¦å€ŸåŠ©å…¶ä»– Servlet æ¥å®ç°åŠŸèƒ½ï¼Œè¿›è¡Œè¯·æ±‚è½¬å‘ã€‚ç‰¹ç‚¹ï¼š æµè§ˆå™¨åœ°å€æ ä¸å˜ åŸŸå¯¹è±¡ä¸­çš„æ•°æ®ä¸ä¸¢å¤± è´Ÿè´£è½¬å‘çš„ Servlet è½¬å‘å‰åå“åº”æ­£æ–‡ä¼šä¸¢å¤± ç”±è½¬å‘ç›®çš„åœ°æ¥å“åº”å®¢æˆ·ç«¯ HttpServletRequest ç±»æ–¹æ³•ï¼š RequestDispatcher getRequestDispatcher(String path) : è·å–ä»»åŠ¡è°ƒåº¦å¯¹è±¡ RequestDispatcher ç±»æ–¹æ³•ï¼š void forward(ServletRequest request, ServletResponse response) : å®ç°è½¬å‘ï¼Œå°†è¯·æ±‚ä» Servlet è½¬å‘åˆ°æœåŠ¡å™¨ä¸Šçš„å¦ä¸€ä¸ªèµ„æºï¼ˆServletï¼ŒJSP æ–‡ä»¶æˆ– HTML æ–‡ä»¶ï¼‰ è¿‡ç¨‹ï¼šæµè§ˆå™¨è®¿é—® http://localhost:8080/request/servletDemo09ï¼Œ/servletDemo10ä¹Ÿä¼šæ‰§è¡Œ 12345678910111213141516@WebServlet(&quot;/servletDemo09&quot;)public class ServletDemo09 extends HttpServlet &#123; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; //è®¾ç½®å…±äº«æ•°æ® req.setAttribute(&quot;encoding&quot;,&quot;gbk&quot;); //è·å–è¯·æ±‚è°ƒåº¦å¯¹è±¡ RequestDispatcher rd = req.getRequestDispatcher(&quot;/servletDemo10&quot;); //å®ç°è½¬å‘åŠŸèƒ½ rd.forward(req,resp); &#125; @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doGet(req,resp); &#125;&#125; 1234567891011121314151617@WebServlet(&quot;/servletDemo10&quot;)public class ServletDemo10 extends HttpServlet &#123; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; //è·å–å…±äº«æ•°æ® Object encoding = req.getAttribute(&quot;encoding&quot;); System.out.println(encoding);//gbk System.out.println(&quot;servletDemo10æ‰§è¡Œäº†...&quot;); &#125; @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doGet(req,resp); &#125;&#125; è¯·æ±‚åŒ…å«è¯·æ±‚åŒ…å«ï¼šåˆå¹¶å…¶ä»–çš„ Servlet ä¸­çš„åŠŸèƒ½ä¸€èµ·å“åº”ç»™å®¢æˆ·ç«¯ã€‚ç‰¹ç‚¹ï¼š æµè§ˆå™¨åœ°å€æ ä¸å˜ åŸŸå¯¹è±¡ä¸­çš„æ•°æ®ä¸ä¸¢å¤± è¢«åŒ…å«çš„ Servlet å“åº”å¤´ä¼šä¸¢å¤± è¯·æ±‚è½¬å‘çš„æ³¨æ„äº‹é¡¹ï¼šè´Ÿè´£è½¬å‘çš„ Servletï¼Œè½¬å‘å‰åçš„å“åº”æ­£æ–‡ä¸¢å¤±ï¼Œç”±è½¬å‘ç›®çš„åœ°æ¥å“åº”æµè§ˆå™¨ è¯·æ±‚åŒ…å«çš„æ³¨æ„äº‹é¡¹ï¼šè¢«åŒ…å«è€…çš„å“åº”æ¶ˆæ¯å¤´ä¸¢å¤±ï¼Œå› ä¸ºå®ƒè¢«åŒ…å«è€…åŒ…å«èµ·æ¥äº† HttpServletRequest ç±»æ–¹æ³•ï¼š RequestDispatcher getRequestDispatcher(String path) : è·å–ä»»åŠ¡è°ƒåº¦å¯¹è±¡ RequestDispatcher ç±»æ–¹æ³•ï¼š void include(ServletRequest request, ServletResponse response) : å®ç°åŒ…å«ã€‚åŒ…æ‹¬å“åº”ä¸­èµ„æºçš„å†…å®¹ï¼ˆservletï¼ŒJSPé¡µé¢ï¼ŒHTMLæ–‡ä»¶ï¼‰ã€‚ 12345678910111213141516171819202122232425262728@WebServlet(&quot;/servletDemo11&quot;)public class ServletDemo11 extends HttpServlet &#123; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; System.out.println(&quot;servletDemo11æ‰§è¡Œäº†...&quot;);//æ‰§è¡Œäº† //è·å–è¯·æ±‚è°ƒåº¦å¯¹è±¡ RequestDispatcher rd = req.getRequestDispatcher(&quot;/servletDemo12&quot;); //å®ç°åŒ…å«åŠŸèƒ½ rd.include(req,resp); &#125; @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doGet(req,resp); &#125;&#125;**********************************************************************************@WebServlet(&quot;/servletDemo12&quot;)public class ServletDemo12 extends HttpServlet &#123; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; System.out.println(&quot;servletDemo12æ‰§è¡Œäº†...&quot;);//è¾“å‡ºäº† &#125; @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doGet(req,resp); &#125;&#125; ä¹±ç é—®é¢˜è¯·æ±‚ä½“ POSTï¼švoid setCharacterEncoding(String env)ï¼šè®¾ç½®è¯·æ±‚ä½“çš„ç¼–ç  1234567891011121314151617@WebServlet(&quot;/servletDemo08&quot;)public class ServletDemo08 extends HttpServlet &#123; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; //è®¾ç½®ç¼–ç æ ¼å¼ req.setCharacterEncoding(&quot;UTF-8&quot;); String username = req.getParameter(&quot;username&quot;); System.out.println(username); &#125; @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doGet(req,resp); &#125;&#125; GETï¼šTomcat8.5 ç‰ˆæœ¬åŠä»¥åï¼ŒTomcat æœåŠ¡å™¨å·²ç»å¸®æˆ‘ä»¬è§£å†³ Responseå“åº”å¯¹è±¡å“åº”ï¼ŒæœåŠ¡å™¨æŠŠè¯·æ±‚çš„å¤„ç†ç»“æœå‘ŠçŸ¥å®¢æˆ·ç«¯ å“åº”å¯¹è±¡ï¼šåœ¨ JavaEE å·¥ç¨‹ä¸­ï¼Œç”¨äºå‘é€å“åº”çš„å¯¹è±¡ åè®®æ— å…³çš„å¯¹è±¡æ ‡å‡†æ˜¯ï¼šServletResponse æ¥å£ åè®®ç›¸å…³çš„å¯¹è±¡æ ‡å‡†æ˜¯ï¼šHttpServletResponse æ¥å£ Response çš„ä½œç”¨ï¼š æ“ä½œå“åº”çš„ä¸‰éƒ¨åˆ†(è¡Œ, å¤´, ä½“) è¯·æ±‚é‡å®šå‘ æ“ä½œå“åº”è¡Œ æ–¹æ³• è¯´æ˜ int getStatus() Gets the current status code of this response void setStatus(int sc) Sets the status code for this response çŠ¶æ€ç ï¼šï¼ˆHTTPâ€“&gt;ç›¸åº”éƒ¨åˆ†ï¼‰ çŠ¶æ€ç  è¯´æ˜ 1xx æ¶ˆæ¯ 2xx æˆåŠŸ 3xx é‡å®šå‘ 4xx å®¢æˆ·ç«¯é”™è¯¯ 5xx æœåŠ¡å™¨é”™è¯¯ æ“ä½œå“åº”ä½“å­—èŠ‚æµå“åº”å“åº”ä½“å¯¹åº”ä¹±ç é—®é¢˜ é¡¹ç›®ä¸­å¸¸ç”¨çš„ç¼–ç æ ¼å¼æ˜¯UTF-8ï¼Œè€Œæµè§ˆå™¨é»˜è®¤ä½¿ç”¨çš„ç¼–ç æ˜¯gbkã€‚å¯¼è‡´ä¹±ç ï¼ è§£å†³æ–¹å¼ï¼š ä¸€ï¼šä¿®æ”¹æµè§ˆå™¨çš„ç¼–ç æ ¼å¼(ä¸æ¨èï¼Œä¸èƒ½è®©ç”¨æˆ·åšä¿®æ”¹çš„åŠ¨ä½œ) äºŒï¼šé€šè¿‡è¾“å‡ºæµå†™å‡ºä¸€ä¸ªæ ‡ç­¾ï¼š&lt;meta http-equiv&#x3D;â€™content-typeâ€™content&#x3D;â€™text&#x2F;html;charset&#x3D;UTF-8â€™&gt; ä¸‰ï¼šæŒ‡å®šå“åº”å¤´ä¿¡æ¯ï¼šresponse.setHeader(â€œContent-Typeâ€,â€text&#x2F;html;charset&#x3D;UTF-8â€) å››ï¼šresponse.setContentType(â€œtext&#x2F;html;charset&#x3D;UTF-8â€) å¸¸ç”¨APIï¼š ServletOutputStream getOutputStream() : è·å–å“åº”å­—èŠ‚è¾“å‡ºæµå¯¹è±¡ void setContenType(&quot;text/html;charset=UTF-8&quot;) : è®¾ç½®å“åº”å†…å®¹ç±»å‹ï¼Œè§£å†³ä¸­æ–‡ä¹±ç é—®é¢˜ 1234567891011121314151617181920@WebServlet(&quot;/servletDemo01&quot;)public class ServletDemo01 extends HttpServlet &#123; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; //1.è®¾ç½®å“åº”å†…å®¹ç±»å‹ resp.setContentType(&quot;text/html;charset=UTF-8&quot;); //2.é€šè¿‡å“åº”å¯¹è±¡è·å–å­—èŠ‚è¾“å‡ºæµå¯¹è±¡ ServletOutputStream sos = resp.getOutputStream(); //3.å®šä¹‰æ¶ˆæ¯ String str = &quot;ä½ å¥½&quot;; //4.é€šè¿‡å­—èŠ‚æµè¾“å‡ºå¯¹è±¡ sos.write(str.getBytes(&quot;UTF-8&quot;)); &#125; @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doGet(req,resp); &#125;&#125; å­—ç¬¦æµå“åº”responseå¾—åˆ°çš„å­—ç¬¦æµå’Œå­—èŠ‚æµäº’æ–¥ï¼Œåªèƒ½é€‰å…¶ä¸€ï¼Œresponseè·å–çš„æµä¸ç”¨å…³é—­ï¼Œç”±æœåŠ¡å™¨å…³é—­å³å¯ã€‚ å¸¸ç”¨APIï¼š PrintWriter getWriter() : è·å–å“åº”å­—èŠ‚è¾“å‡ºæµå¯¹è±¡ï¼Œå¯ä»¥å‘é€æ ‡ç­¾ void setContenType(&quot;text/html;charset=UTF-8&quot;) : è®¾ç½®å“åº”å†…å®¹ç±»å‹ï¼Œè§£å†³ä¸­æ–‡ä¹±ç é—®é¢˜ 12345678protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; String str = &quot;ä½ å¥½&quot;; //è§£å†³ä¸­æ–‡ä¹±ç  resp.setContentType(&quot;text/html;charset=UTF-8&quot;); //è·å–å­—ç¬¦æµå¯¹è±¡ PrintWriter pw = resp.getWriter(); pw.write(str);&#125; å“åº”å›¾ç‰‡å“åº”å›¾ç‰‡åˆ°æµè§ˆå™¨ 123456789101112131415161718192021222324252627@WebServlet(&quot;/servletDemo03&quot;)public class ServletDemo03 extends HttpServlet &#123; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; //1.é€šè¿‡æ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„æ¥è·å–æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ String realPath = getServletContext().getRealPath(&quot;/img/hm.png&quot;); //E:\\Project\\JavaEE\\out\\artifacts\\Response_war_exploded\\img\\hm.png System.out.println(realPath); //2.åˆ›å»ºå­—èŠ‚è¾“å…¥æµå¯¹è±¡ï¼Œå…³è”å›¾ç‰‡è·¯å¾„ BufferedInputStream bis = new BufferedInputStream(new FileInputStream(realPath)); //3.é€šè¿‡å“åº”å¯¹è±¡è·å–å­—èŠ‚è¾“å‡ºæµå¯¹è±¡ ServletOutputStream sos = resp.getOutputStream(); //4.å¾ªç¯è¯»å†™ byte[] arr = new byte[1024]; int len; while((len = bis.read(arr)) != -1) &#123; sos.write(arr,0,len); &#125; &#125; @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doGet(req,resp); &#125;&#125; æ“ä½œå“åº”å¤´å¸¸ç”¨æ–¹æ³•å“åº”å¤´: æ˜¯æœåŠ¡å™¨æŒ‡ç¤ºæµè§ˆå™¨å»åšä»€ä¹ˆ æ–¹æ³• è¯´æ˜ String getHeader(String name) è·å–æŒ‡å®šå“åº”å¤´çš„å†…å®¹ Collection getHeaders(String name) è·å–æŒ‡å®šå“åº”å¤´çš„å¤šä¸ªå€¼ Collection getHeaderNames() è·å–æ‰€æœ‰å“åº”å¤´åç§°çš„æšä¸¾ void setHeader(String name, String value) è®¾ç½®å“åº”å¤´ void setDateHeader(String name, long date) è®¾ç½®å…·æœ‰ç»™å®šåç§°å’Œæ—¥æœŸå€¼çš„å“åº”æ¶ˆæ¯å¤´ void sendRedirect(String location) è®¾ç½®é‡å®šå‘ setHeaderå¸¸ç”¨å“åº”å¤´ï¼š Expiresï¼šè®¾ç½®ç¼“å­˜æ—¶é—´ Refreshï¼šå®šæ—¶è·³è½¬ Locationï¼šé‡å®šå‘åœ°å€ Content-Disposition: å‘Šè¯‰æµè§ˆå™¨ä¸‹è½½ Content-Typeï¼šè®¾ç½®å“åº”å†…å®¹çš„MIMEç±»å‹(æœåŠ¡å™¨å‘Šè¯‰æµè§ˆå™¨å†…å®¹çš„ç±»å‹) æ§åˆ¶ç¼“å­˜ç¼“å­˜ï¼šå¯¹äºä¸ç»å¸¸å˜åŒ–çš„æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®åˆç†çš„ç¼“å­˜æ—¶é—´ï¼Œé˜²æ­¢æµè§ˆå™¨é¢‘ç¹çš„è¯·æ±‚æœåŠ¡å™¨ã€‚ 12345678910111213141516171819@WebServlet(&quot;/servletDemo04&quot;)public class ServletDemo04 extends HttpServlet &#123; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; String news = &quot;è®¾ç½®ç¼“å­˜æ—¶é—´&quot;; //è®¾ç½®ç¼“å­˜æ—¶é—´ï¼Œç¼“å­˜ä¸€å°æ—¶ resp.setDateHeader(&quot;Expires&quot;,System.currentTimeMillis()+1*60*60*1000L); //è®¾ç½®ç¼–ç æ ¼å¼ resp.setContentType(&quot;text/html;charset=UTF-8&quot;); //å†™å‡ºæ•°æ® resp.getWriter().write(news); System.out.println(&quot;aaa&quot;);//åªè¾“å‡ºä¸€æ¬¡ï¼Œä¸èƒ½åˆ·æ–°ï¼Œå¿…é¡»ä»ç½‘å€ç›´æ¥è¿›å…¥ &#125; @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doGet(req,resp); &#125;&#125; å®šæ—¶åˆ·æ–°å®šæ—¶åˆ·æ–°ï¼šè¿‡äº†æŒ‡å®šæ—¶é—´åï¼Œé¡µé¢è¿›è¡Œè‡ªåŠ¨è·³è½¬ æ ¼å¼ï¼šsetHeader(&quot;Refresh&quot;, &quot;3;URL=https://www.baidu.com&quot;&quot;); Refreshè®¾ç½®çš„æ—¶é—´å•ä½æ˜¯ç§’ï¼Œå¦‚æœåˆ·æ–°åˆ°å…¶ä»–åœ°å€ï¼Œéœ€è¦åœ¨æ—¶é—´åé¢æ‹¼æ¥ä¸Šåœ°å€ 12345678910111213141516171819@WebServlet(&quot;/servletDemo05&quot;)public class ServletDemo05 extends HttpServlet &#123; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; String news = &quot;æ‚¨çš„ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼Œ3ç§’åè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢...&quot;; //è®¾ç½®ç¼–ç æ ¼å¼ resp.setContentType(&quot;text/html;charset=UTF-8&quot;); //å†™å‡ºæ•°æ® resp.getWriter().write(news); //è®¾ç½®å“åº”æ¶ˆæ¯å¤´å®šæ—¶åˆ·æ–° resp.setHeader(&quot;Refresh&quot;,&quot;3;URL=/response/login.html&quot;); &#125; @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doGet(req,resp); &#125;&#125; ä¸‹è½½æ–‡ä»¶1234567891011121314151617181920212223242526272829303132333435363738394041@WebServlet(&quot;/servletDemo06&quot;)public class ServletDemo06 extends HttpServlet &#123; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; //1.åˆ›å»ºå­—èŠ‚è¾“å…¥æµå¯¹è±¡ï¼Œå…³è”è¯»å–çš„æ–‡ä»¶ String realPath = getServletContext().getRealPath(&quot;/img/hm.png&quot;);//ç»å¯¹è·¯å¾„ BufferedInputStream bis = new BufferedInputStream(new FileInputStream(realPath)); //2.è®¾ç½®å“åº”å¤´æ”¯æŒçš„ç±»å‹ åº”ç”¨æ”¯æŒçš„ç±»å‹ä¸ºå­—èŠ‚æµ /* Content-Type æ¶ˆæ¯å¤´åç§° æ”¯æŒçš„ç±»å‹ application/octet-stream æ¶ˆæ¯å¤´å‚æ•° åº”ç”¨ç±»å‹ä¸ºå­—èŠ‚æµ */ resp.setHeader(&quot;Content-Type&quot;,&quot;application/octet-stream&quot;); //3.è®¾ç½®å“åº”å¤´ä»¥ä¸‹è½½æ–¹å¼æ‰“å¼€ ä»¥é™„ä»¶å½¢å¼å¤„ç†å†…å®¹ /* Content-Disposition æ¶ˆæ¯å¤´åç§° å¤„ç†çš„å½¢å¼ attachment;filename= æ¶ˆæ¯å¤´å‚æ•° é™„ä»¶å½¢å¼è¿›è¡Œå¤„ç† */ resp.setHeader(&quot;Content-Disposition&quot;,&quot;attachment;filename=&quot; + System.currentTimeMillis() + &quot;.png&quot;); //4.è·å–å­—èŠ‚è¾“å‡ºæµå¯¹è±¡ ServletOutputStream sos = resp.getOutputStream(); //5.å¾ªç¯è¯»å†™æ–‡ä»¶ byte[] arr = new byte[1024]; int len; while((len = bis.read(arr)) != -1) &#123; sos.write(arr,0,len); &#125; //6.é‡Šæ”¾èµ„æº bis.close(); &#125; @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doGet(req,resp); &#125;&#125; é‡å®šå‘å®ç°é‡å®šå‘è¯·æ±‚é‡å®šå‘ï¼šå®¢æˆ·ç«¯çš„ä¸€æ¬¡è¯·æ±‚åˆ°è¾¾åï¼Œéœ€è¦å€ŸåŠ©å…¶ä»– Servlet æ¥å®ç°åŠŸèƒ½ã€‚ç‰¹ç‚¹ï¼š é‡å®šå‘ä¸¤æ¬¡è¯·æ±‚ é‡å®šå‘çš„åœ°å€æ è·¯å¾„æ”¹å˜ é‡å®šå‘çš„è·¯å¾„å†™ç»å¯¹è·¯å¾„ï¼ˆå¸¦åŸŸå &#x2F;ip åœ°å€ï¼Œå¦‚æœæ˜¯åŒä¸€ä¸ªé¡¹ç›®ï¼Œå¯ä»¥çœç•¥åŸŸå &#x2F;ip åœ°å€ï¼‰ é‡å®šå‘çš„è·¯å¾„å¯ä»¥æ˜¯é¡¹ç›®å†…éƒ¨çš„,ä¹Ÿå¯ä»¥æ˜¯é¡¹ç›®ä»¥å¤–çš„ï¼ˆç™¾åº¦ï¼‰ é‡å®šå‘ä¸èƒ½é‡å®šå‘åˆ° WEB-INF ä¸‹çš„èµ„æº æŠŠæ•°æ®å­˜åˆ° request åŸŸé‡Œé¢ï¼Œé‡å®šå‘ä¸å¯ç”¨ å®ç°æ–¹å¼ï¼š æ–¹å¼ä¸€ï¼š è®¾ç½®å“åº”çŠ¶æ€ç ï¼šresp.setStatus(302) è®¾ç½®é‡å®šå‘çš„è·¯å¾„ï¼ˆå“åº”åˆ°å“ªé‡Œï¼Œé€šè¿‡å“åº”å¤´ location æ¥æŒ‡å®šï¼‰ response.setHeader(&quot;Location&quot;,&quot;http://www.baidu.com&quot;); response.setHeader(&quot;Location&quot;,&quot;/response/servletDemo08); æ–¹å¼äºŒï¼š resp.sendRedirect(&quot;é‡å®šå‘çš„è·¯å¾„&quot;); 1234567891011121314151617@WebServlet(&quot;/servletDemo07&quot;)public class ServletDemo07 extends HttpServlet &#123; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; //è®¾ç½®è¯·æ±‚åŸŸæ•°æ® req.setAttribute(&quot;username&quot;,&quot;zhangsan&quot;); //è®¾ç½®é‡å®šå‘ resp.sendRedirect(req.getContextPath() + &quot;/servletDemo07&quot;); // resp.sendRedirect(&quot;https://www.baidu.com&quot;); &#125; @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doGet(req,resp); &#125;&#125; 123456789@WebServlet(&quot;/servletDemo08&quot;)public class ServletDemo08 extends HttpServlet &#123; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; System.out.println(&quot;servletDemo08æ‰§è¡Œäº†...&quot;); Object username = req.getAttribute(&quot;username&quot;); System.out.println(username); &#125;&#125; é‡å®šå‘å’Œè½¬å‘è¯·æ±‚é‡å®šå‘è·³è½¬çš„ç‰¹ç‚¹ï¼š é‡å®šå‘æ˜¯ç”±æµè§ˆå™¨å‘èµ·çš„ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æµè§ˆå™¨ä¼šå‘èµ·ä¸¤æ¬¡è¯·æ±‚ é‡å®šå‘å¯ä»¥è·³è½¬åˆ°ä»»æ„æœåŠ¡å™¨çš„èµ„æºï¼Œä½†æ˜¯æ— æ³•è·³è½¬åˆ°WEB-INFä¸­çš„èµ„æº é‡å®šå‘ä¸èƒ½å’Œè¯·æ±‚åŸŸå¯¹è±¡å…±äº«æ•°æ®ï¼Œæ•°æ®ä¼šä¸¢å¤± é‡å®šå‘æµè§ˆå™¨çš„åœ°å€æ ä¸­çš„åœ°å€ä¼šå˜æˆè·³è½¬åˆ°çš„è·¯å¾„ è¯·æ±‚è½¬å‘è·³è½¬çš„ç‰¹ç‚¹ï¼š è¯·æ±‚è½¬å‘æ˜¯ç”±æœåŠ¡å™¨å‘èµ·çš„ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æµè§ˆå™¨åªä¼šå‘èµ·ä¸€æ¬¡è¯·æ±‚ è¯·æ±‚è½¬å‘åªèƒ½è·³è½¬åˆ°æœ¬é¡¹ç›®çš„èµ„æºï¼Œä½†æ˜¯å¯ä»¥è·³è½¬åˆ°WEB-INFä¸­çš„èµ„æº è¯·æ±‚è½¬å‘å¯ä»¥å’Œè¯·æ±‚åŸŸå¯¹è±¡å…±äº«æ•°æ®ï¼Œæ•°æ®ä¸ä¼šä¸¢å¤± è¯·æ±‚è½¬å‘æµè§ˆå™¨åœ°å€æ ä¸å˜ è·¯å¾„é—®é¢˜å®Œæ•´URLåœ°å€ï¼š åè®®ï¼šhttp:&#x2F;&#x2F; æœåŠ¡å™¨ä¸»æœºåœ°å€ï¼š127.0.0.1 or localhost æœåŠ¡å™¨ç«¯å£å·ï¼š8080 é¡¹ç›®çš„è™šæ‹Ÿè·¯å¾„(éƒ¨ç½²è·¯å¾„)ï¼š&#x2F;response å…·ä½“çš„é¡¹ç›®ä¸Šèµ„æºè·¯å¾„ &#x2F;login.html or Demo çš„Servletæ˜ å°„è·¯å¾„ ç›¸å¯¹è·¯å¾„ï¼š ä¸ä»¥â€&#x2F;â€œå¼€å¤´çš„è·¯å¾„å†™æ³•ï¼Œå®ƒæ˜¯ä»¥ç›®æ ‡è·¯å¾„ç›¸å¯¹å½“å‰æ–‡ä»¶çš„è·¯å¾„ï¼Œå…¶ä¸­â€..â€è¡¨ç¤ºä¸Šä¸€çº§ç›®å½•ã€‚ 1234567891011121314151617&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;&lt;/title&gt;&lt;/head&gt;&lt;body&gt; &lt;h1&gt;hello world....&lt;/h1&gt; &lt;!-- ç›®æ ‡èµ„æºçš„url: http://localhost:8080/response/demo05 å½“å‰èµ„æºçš„url: http://localhost:8080/response/pages/demo.html ç›¸å¯¹è·¯å¾„çš„ä¼˜åŠ£: 1. ä¼˜åŠ¿: æ— è®ºéƒ¨ç½²çš„é¡¹ç›®åæ€ä¹ˆæ”¹å˜ï¼Œæˆ‘çš„è·¯å¾„éƒ½ä¸éœ€è¦æ”¹å˜ 2. åŠ£åŠ¿: å¦‚æœå½“å‰èµ„æºçš„ä½ç½®å‘ç”Ÿæ”¹å˜ï¼Œé‚£ä¹ˆç›¸å¯¹è·¯å¾„å°±å¿…å®šè¦å‘ç”Ÿæ”¹å˜--&gt; &lt;a href=&quot;../demo05&quot;&gt;è®¿é—®ServletDemo05&lt;/a&gt;&lt;/body&gt;&lt;/html&gt; ç»å¯¹è·¯å¾„ï¼š ç»å¯¹è·¯å¾„å°±æ˜¯ä»¥â€&#x2F;â€œå¼€å¤´çš„è·¯å¾„å†™æ³•ï¼Œé¡¹ç›®éƒ¨ç½²çš„è·¯å¾„ Cookieä¼šè¯æŠ€æœ¯ä¼šè¯ï¼šæµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´çš„å¤šæ¬¡è¯·æ±‚å’Œå“åº” æµè§ˆå™¨å’ŒæœåŠ¡å™¨å¯èƒ½äº§ç”Ÿå¤šæ¬¡çš„è¯·æ±‚å’Œå“åº”ï¼Œä»æµè§ˆå™¨è®¿é—®æœåŠ¡å™¨å¼€å§‹ï¼Œåˆ°è®¿é—®æœåŠ¡å™¨ç»“æŸï¼ˆå…³é—­æµè§ˆå™¨ã€åˆ°äº†è¿‡æœŸæ—¶é—´ï¼‰ï¼Œè¿™æœŸé—´äº§ç”Ÿçš„å¤šæ¬¡è¯·æ±‚å’Œå“åº”åŠ åœ¨ä¸€èµ·ç§°ä¸ºæµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´çš„ä¸€æ¬¡å¯¹è¯ ä½œç”¨ï¼šä¿å­˜ç”¨æˆ·å„è‡ªçš„æ•°æ®ï¼ˆä»¥æµè§ˆå™¨ä¸ºå•ä½ï¼‰ï¼Œåœ¨å¤šæ¬¡è¯·æ±‚é—´å®ç°æ•°æ®å…±äº« å¸¸ç”¨çš„ä¼šè¯ç®¡ç†æŠ€æœ¯ï¼š Cookieï¼šå®¢æˆ·ç«¯ä¼šè¯ç®¡ç†æŠ€æœ¯ï¼Œç”¨æˆ·æµè§ˆçš„ä¿¡æ¯ä»¥é”®å€¼å¯¹ï¼ˆkey&#x3D;valueï¼‰çš„å½¢å¼ä¿å­˜åœ¨æµè§ˆå™¨ä¸Šã€‚å¦‚æœæ²¡æœ‰å…³é—­æµè§ˆå™¨ï¼Œå†æ¬¡è®¿é—®æœåŠ¡å™¨ï¼Œä¼šæŠŠ cookie å¸¦åˆ°æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯å°±å¯ä»¥åšç›¸åº”çš„å¤„ç† Sessionï¼šæœåŠ¡ç«¯ä¼šè¯ç®¡ç†æŠ€æœ¯ã€‚å½“å®¢æˆ·ç«¯ç¬¬ä¸€æ¬¡è¯·æ±‚ session å¯¹è±¡æ—¶ï¼ŒæœåŠ¡å™¨ä¸ºæ¯ä¸€ä¸ªæµè§ˆå™¨å¼€è¾Ÿä¸€å—å†…å­˜ç©ºé—´ï¼Œå¹¶å°†é€šè¿‡ç‰¹æ®Šç®—æ³•ç®—å‡ºä¸€ä¸ª session çš„ IDï¼Œç”¨æ¥æ ‡è¯†è¯¥ session å¯¹è±¡ã€‚ç”±äºå†…å­˜ç©ºé—´æ˜¯æ¯ä¸€ä¸ªæµè§ˆå™¨ç‹¬äº«çš„ï¼Œæ‰€æœ‰ç”¨æˆ·åœ¨è®¿é—®çš„æ—¶å€™ï¼Œå¯ä»¥æŠŠä¿¡æ¯ä¿å­˜åœ¨ session å¯¹è±¡ä¸­ï¼ŒåŒæ—¶æœåŠ¡å™¨ä¼šæŠŠ sessionId å†™åˆ° cookie ä¸­ï¼Œå†æ¬¡è®¿é—®çš„æ—¶å€™ï¼Œæµè§ˆå™¨ä¼šæŠŠ cookie(sessionId) å¸¦è¿‡æ¥ï¼Œæ‰¾åˆ°å¯¹åº”çš„ session å¯¹è±¡å³å¯ tomcat ç”Ÿæˆçš„ sessionID å«åš jsessionID ä¸¤è€…åŒºåˆ«ï¼š Cookie å­˜å‚¨åœ¨å®¢æˆ·ç«¯ä¸­ï¼Œè€Œ Session å­˜å‚¨åœ¨æœåŠ¡å™¨ä¸Šï¼Œç›¸å¯¹æ¥è¯´ Session å®‰å…¨æ€§æ›´é«˜ã€‚å¦‚æœè¦åœ¨ Cookie ä¸­å­˜å‚¨ä¸€äº›æ•æ„Ÿä¿¡æ¯ï¼Œä¸è¦ç›´æ¥å†™å…¥ Cookieï¼Œåº”è¯¥å°† Cookie ä¿¡æ¯åŠ å¯†ç„¶åä½¿ç”¨åˆ°çš„æ—¶å€™å†å»æœåŠ¡å™¨ç«¯è§£å¯† Cookie ä¸€èˆ¬ç”¨æ¥ä¿å­˜ç”¨æˆ·ä¿¡æ¯ï¼Œåœ¨ Cookie ä¸­ä¿å­˜å·²ç»ç™»å½•è¿‡å¾—ç”¨æˆ·ä¿¡æ¯ï¼Œä¸‹æ¬¡è®¿é—®ç½‘ç«™çš„æ—¶å€™å°±ä¸éœ€è¦é‡æ–°ç™»å½•ï¼Œå› ä¸ºç”¨æˆ·ç™»å½•çš„æ—¶å€™å¯ä»¥å­˜æ”¾ä¸€ä¸ª Token åœ¨ Cookie ä¸­ï¼Œä¸‹æ¬¡ç™»å½•çš„æ—¶å€™åªéœ€è¦æ ¹æ® Token å€¼æ¥æŸ¥æ‰¾ç”¨æˆ·å³å¯ï¼ˆä¸ºäº†å®‰å…¨è€ƒè™‘ï¼Œé‡æ–°ç™»å½•ä¸€èˆ¬è¦å°† Token é‡å†™ï¼‰ï¼Œæ‰€ä»¥ç™»å½•ä¸€æ¬¡ç½‘ç«™åè®¿é—®ç½‘ç«™å…¶ä»–é¡µé¢ä¸éœ€è¦é‡æ–°ç™»å½• Session é€šè¿‡æœåŠ¡ç«¯è®°å½•ç”¨æˆ·çš„çŠ¶æ€ï¼ŒæœåŠ¡ç«¯ç»™ç‰¹å®šçš„ç”¨æˆ·åˆ›å»ºç‰¹å®šçš„ Session ä¹‹åå°±å¯ä»¥æ ‡è¯†è¿™ä¸ªç”¨æˆ·å¹¶ä¸”è·Ÿè¸ªè¿™ä¸ªç”¨æˆ· Cookie åªèƒ½å­˜å‚¨ ASCII ç ï¼Œè€Œ Session å¯ä»¥å­˜å‚¨ä»»ä½•ç±»å‹çš„æ•°æ® å‚è€ƒæ–‡ç« ï¼šhttps://blog.csdn.net/weixin_43625577/article/details/92393581 åŸºæœ¬ä»‹ç»Cookieï¼šå®¢æˆ·ç«¯ä¼šè¯ç®¡ç†æŠ€æœ¯ï¼ŒæŠŠè¦å…±äº«çš„æ•°æ®ä¿å­˜åˆ°äº†å®¢æˆ·ç«¯ï¼ˆä¹Ÿå°±æ˜¯æµè§ˆå™¨ç«¯ï¼‰ã€‚æ¯æ¬¡è¯·æ±‚æ—¶ï¼ŒæŠŠä¼šè¯ä¿¡æ¯å¸¦åˆ°æœåŠ¡å™¨ï¼Œä»è€Œå®ç°å¤šæ¬¡è¯·æ±‚çš„æ•°æ®å…±äº«ã€‚ ä½œç”¨ï¼šä¿å­˜å®¢æˆ·æµè§ˆå™¨è®¿é—®ç½‘ç«™çš„ç›¸å…³å†…å®¹ï¼ˆéœ€è¦å®¢æˆ·ç«¯ä¸ç¦ç”¨ Cookieï¼‰ï¼Œä»è€Œåœ¨æ¯æ¬¡è®¿é—®åŒä¸€ä¸ªå†…å®¹æ—¶ï¼Œå…ˆä»æœ¬åœ°ç¼“å­˜è·å–ï¼Œä½¿èµ„æºå…±äº«ï¼Œæé«˜æ•ˆç‡ã€‚ åŸºæœ¬ä½¿ç”¨å¸¸ç”¨API Cookieå±æ€§ï¼š å±æ€§åç§° å±æ€§ä½œç”¨ æ˜¯å¦é‡è¦ name cookieçš„åç§° å¿…è¦å±æ€§ value cookieçš„å€¼ï¼ˆä¸èƒ½æ˜¯ä¸­æ–‡ï¼‰ å¿…è¦å±æ€§ path cookieçš„è·¯å¾„ é‡è¦ domain cookieçš„åŸŸå é‡è¦ maxAge cookieçš„ç”Ÿå­˜æ—¶é—´ é‡è¦ version cookieçš„ç‰ˆæœ¬å· ä¸é‡è¦ comment cookieçš„è¯´æ˜ ä¸é‡è¦ æ³¨æ„ï¼šCookie æœ‰å¤§å°ï¼Œä¸ªæ•°é™åˆ¶ã€‚æ¯ä¸ªç½‘ç«™æœ€å¤šåªèƒ½å­˜20ä¸ª Cookieï¼Œä¸”å¤§å°ä¸èƒ½è¶…è¿‡ 4kbã€‚åŒæ—¶æ‰€æœ‰ç½‘ç«™çš„ Cookie æ€»æ•°ä¸è¶…è¿‡300ä¸ªã€‚ Cookieç±»APIï¼š Cookie(String name, String value) : æ„é€ æ–¹æ³•åˆ›å»º Cookie å¯¹è±¡ Cookie å±æ€§å¯¹åº”çš„ set å’Œ get æ–¹æ³•ï¼Œname å±æ€§è¢« final ä¿®é¥°ï¼Œæ²¡æœ‰ set æ–¹æ³• HttpServletResponse ç±» APIï¼š void addCookie(Cookie cookie)ï¼šå‘å®¢æˆ·ç«¯æ·»åŠ  Cookieï¼ŒAdds cookie to the response HttpServletRequestç±»APIï¼š Cookie[] getCookies()ï¼šè·å–æ‰€æœ‰çš„ Cookie å¯¹è±¡ï¼Œclient sent with this request æœ‰æ•ˆæœŸå¦‚æœä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè¡¨ç¤ºè¿™ä¸ª Cookie ç”Ÿå‘½å‘¨æœŸä¸ºæµè§ˆå™¨ä¼šè¯æœŸé—´ï¼Œåªè¦å…³é—­æµè§ˆå™¨çª—å£ Cookie å°±æ¶ˆå¤±ï¼Œè¿™ç§ç”Ÿå‘½æœŸä¸ºæµè§ˆä¼šè¯æœŸçš„ Cookie è¢«ç§°ä¸ºä¼šè¯ Cookieï¼Œä¼šè¯ Cookie ä¸€èˆ¬ä¸ä¿å­˜åœ¨ç¡¬ç›˜ä¸Šè€Œæ˜¯ä¿å­˜åœ¨å†…å­˜é‡Œã€‚ å¦‚æœè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œæµè§ˆå™¨å°±ä¼šæŠŠ Cookie ä¿å­˜åˆ°ç¡¬ç›˜ä¸Šï¼Œå…³é—­åå†æ¬¡æ‰“å¼€æµè§ˆå™¨ï¼Œè¿™äº› Cookie ä¾ç„¶æœ‰æ•ˆç›´åˆ°è¶…è¿‡è®¾å®šçš„è¿‡æœŸæ—¶é—´ã€‚å­˜å‚¨åœ¨ç¡¬ç›˜ä¸Šçš„ Cookie å¯ä»¥åœ¨ä¸åŒçš„æµè§ˆå™¨è¿›ç¨‹é—´å…±äº«ï¼Œæ¯”å¦‚ä¸¤ä¸ª IE çª—å£ï¼Œè€Œå¯¹äºä¿å­˜åœ¨å†…å­˜çš„ Cookieï¼Œä¸åŒçš„æµè§ˆå™¨æœ‰ä¸åŒçš„å¤„ç†æ–¹å¼ è®¾ç½® Cookie å­˜æ´»æ—¶é—´ APIï¼švoid setMaxAge(int expiry) -1ï¼šé»˜è®¤ï¼Œä»£è¡¨ Cookie æ•°æ®å­˜åˆ°æµè§ˆå™¨å…³é—­ï¼ˆä¿å­˜åœ¨æµè§ˆå™¨æ–‡ä»¶ä¸­ï¼‰ 0ï¼šä»£è¡¨åˆ é™¤ Cookieï¼Œå¦‚æœè¦åˆ é™¤ Cookie è¦ç¡®ä¿è·¯å¾„ä¸€è‡´ æ­£æ•´æ•°ï¼šä»¥ç§’ä¸ºå•ä½ä¿å­˜æ•°æ®æœ‰æœ‰æ•ˆæ—¶é—´ï¼ˆæŠŠç¼“å­˜æ•°æ®ä¿å­˜åˆ°ç£ç›˜ä¸­ï¼‰ 12345678910111213141516171819202122232425262728293031323334353637@WebServlet(&quot;/servletDemo01&quot;)public class ServletDemo01 extends HttpServlet&#123; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; //1.é€šè¿‡å“åº”å¯¹è±¡å†™å‡ºæç¤ºä¿¡æ¯ resp.setContentType(&quot;text/html;charset=UTF-8&quot;); PrintWriter pw = resp.getWriter(); pw.write(&quot;æ¬¢è¿è®¿é—®æœ¬ç½‘ç«™ï¼Œæ‚¨çš„æœ€åè®¿é—®æ—¶é—´ä¸ºï¼š&lt;br&gt;&quot;); //2.åˆ›å»ºCookieå¯¹è±¡ï¼Œç”¨äºè®°å½•æœ€åè®¿é—®æ—¶é—´ Cookie cookie = new Cookie(&quot;time&quot;,System.currentTimeMillis()+&quot;&quot;); //3.è®¾ç½®æœ€å¤§å­˜æ´»æ—¶é—´ cookie.setMaxAge(3600); //cookie.setMaxAge(0); // ç«‹å³æ¸…é™¤ //4.å°†cookieå¯¹è±¡æ·»åŠ åˆ°å®¢æˆ·ç«¯ resp.addCookie(cookie); //5.è·å–cookie Cookie[] cookies = req.getCookies(); for(Cookie c : cookies) &#123; if(&quot;time&quot;.equals(c.getName())) &#123; //6.è·å–cookieå¯¹è±¡ä¸­çš„valueï¼Œè¿›è¡Œå†™å‡º String value = c.getValue(); SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;); pw.write(sdf.format(Long.parseLong(value))); &#125; &#125; &#125; @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doGet(req,resp); &#125;&#125; æœ‰æ•ˆè·¯å¾„setPath(String url) : Cookie è®¾ç½®æœ‰æ•ˆè·¯å¾„ æœ‰æ•ˆè·¯å¾„ä½œç”¨ : ä¿è¯ä¸ä¼šæºå¸¦åˆ«çš„ç½‘ç«™&#x2F;é¡¹ç›®é‡Œé¢çš„ Cookie åˆ°æˆ‘ä»¬è‡ªå·±çš„é¡¹ç›® è·¯å¾„ä¸ä¸€æ ·ï¼ŒCookie çš„ key å¯ä»¥ç›¸åŒ ä¿è¯è‡ªå·±çš„é¡¹ç›®å¯ä»¥åˆç†çš„åˆ©ç”¨è‡ªå·±é¡¹ç›®çš„ Cookie åˆ¤æ–­è·¯å¾„æ˜¯å¦æºå¸¦ Cookieï¼šè¯·æ±‚èµ„æº URI.startWith(cookieçš„path)ï¼Œè¿”å› true å°±å¸¦ è®¿é—®URL URIéƒ¨åˆ† Cookieçš„Path æ˜¯å¦æºå¸¦Cookie èƒ½å¦å–åˆ°Cookie servletDemo02 &#x2F;servlet&#x2F;servletDemo02 &#x2F;servlet&#x2F; å¸¦ èƒ½å–åˆ° servletDemo03 &#x2F;servlet&#x2F;servletDemo03 &#x2F;servlet&#x2F; å¸¦ èƒ½å–åˆ° servletDemo04 &#x2F;servlet&#x2F;aaa&#x2F;servletDemo04 &#x2F;servlet&#x2F; å¸¦ èƒ½å–åˆ° servletDemo05 &#x2F;bbb&#x2F;servletDemo04 &#x2F;servlet&#x2F; ä¸å¸¦ ä¸èƒ½å–åˆ° åªæœ‰å½“è®¿é—®èµ„æºçš„ url åŒ…å«æ­¤ cookie çš„æœ‰æ•ˆ path çš„æ—¶å€™ï¼Œæ‰ä¼šæºå¸¦è¿™ä¸ª cookie æƒ³è¦å½“å‰é¡¹ç›®ä¸‹çš„ Servlet å¯ä»¥ä½¿ç”¨è¯¥ cookieï¼Œä¸€èˆ¬è®¾ç½®ï¼šcookie.setPath(request.getContextPath()) å®‰å…¨æ€§å¦‚æœ Cookie ä¸­è®¾ç½®äº† HttpOnly å±æ€§ï¼Œé€šè¿‡ js è„šæœ¬å°†æ— æ³•è¯»å–åˆ° cookie ä¿¡æ¯ï¼Œè¿™æ ·èƒ½æœ‰æ•ˆçš„é˜²æ­¢ XSS æ”»å‡»ï¼Œçªƒå– cookie å†…å®¹ï¼Œè¿™æ ·å°±å¢åŠ äº†å®‰å…¨æ€§ï¼Œå³ä¾¿æ˜¯è¿™æ ·ï¼Œä¹Ÿä¸è¦å°†é‡è¦ä¿¡æ¯å­˜å…¥cookieã€‚ XSS å…¨ç§° Cross SiteScriptï¼Œè·¨ç«™è„šæœ¬æ”»å‡»ï¼Œæ˜¯Webç¨‹åºä¸­å¸¸è§çš„æ¼æ´ï¼ŒXSS å±äºè¢«åŠ¨å¼ä¸”ç”¨äºå®¢æˆ·ç«¯çš„æ”»å‡»æ–¹å¼ï¼Œæ‰€ä»¥å®¹æ˜“è¢«å¿½ç•¥å…¶å±å®³æ€§ã€‚å…¶åŸç†æ˜¯æ”»å‡»è€…å‘æœ‰ XSS æ¼æ´çš„ç½‘ç«™ä¸­è¾“å…¥(ä¼ å…¥)æ¶æ„çš„ HTML ä»£ç ï¼Œå½“å…¶å®ƒç”¨æˆ·æµè§ˆè¯¥ç½‘ç«™æ—¶ï¼Œè¿™æ®µHTMLä»£ç ä¼šè‡ªåŠ¨æ‰§è¡Œï¼Œä»è€Œè¾¾åˆ°æ”»å‡»çš„ç›®çš„ã€‚å¦‚ç›—å–ç”¨æˆ· Cookieã€ç ´åé¡µé¢ç»“æ„ã€é‡å®šå‘åˆ°å…¶å®ƒç½‘ç«™ç­‰ã€‚ SessionåŸºæœ¬ä»‹ç»Sessionï¼šæœåŠ¡å™¨ç«¯ä¼šè¯ç®¡ç†æŠ€æœ¯ï¼Œæœ¬è´¨ä¹Ÿæ˜¯é‡‡ç”¨å®¢æˆ·ç«¯ä¼šè¯ç®¡ç†æŠ€æœ¯ï¼Œä¸è¿‡åœ¨å®¢æˆ·ç«¯ä¿å­˜çš„æ˜¯ä¸€ä¸ªç‰¹æ®Šæ ‡è¯†ï¼Œå…±äº«çš„æ•°æ®ä¿å­˜åˆ°äº†æœåŠ¡å™¨çš„å†…å­˜å¯¹è±¡ä¸­ã€‚æ¯æ¬¡è¯·æ±‚æ—¶ï¼Œä¼šå°†ç‰¹æ®Šæ ‡è¯†å¸¦åˆ°æœåŠ¡å™¨ç«¯ï¼Œæ ¹æ®æ ‡è¯†æ¥æ‰¾åˆ°å¯¹åº”çš„å†…å­˜ç©ºé—´ï¼Œä»è€Œå®ç°æ•°æ®å…±äº«ã€‚ç®€å•è¯´å®ƒå°±æ˜¯ä¸€ä¸ªæœåŠ¡ç«¯ä¼šè¯å¯¹è±¡ï¼Œç”¨äºå­˜å‚¨ç”¨æˆ·çš„ä¼šè¯æ•°æ® Session åŸŸï¼ˆä¼šè¯åŸŸï¼‰å¯¹è±¡æ˜¯ Servlet è§„èŒƒä¸­å››å¤§åŸŸå¯¹è±¡ä¹‹ä¸€ï¼Œå¹¶ä¸”å®ƒä¹Ÿæ˜¯ç”¨äºå®ç°æ•°æ®å…±äº«çš„ åŸŸå¯¹è±¡ åŠŸèƒ½ åˆ›å»º é”€æ¯ ä½¿ç”¨åœºæ™¯ ServletContext åº”ç”¨åŸŸ æœåŠ¡å™¨å¯åŠ¨ æœåŠ¡å™¨å…³é—­ åœ¨æ•´ä¸ªåº”ç”¨ä¹‹é—´å®ç°æ•°æ®å…±äº«ï¼ˆè®°å½•ç½‘ç«™è®¿é—®æ¬¡æ•°ï¼ŒèŠå¤©å®¤ï¼‰ ServletRequest è¯·æ±‚åŸŸ è¯·æ±‚åˆ°æ¥ å“åº”äº†è¿™ä¸ªè¯·æ±‚ åœ¨å½“å‰è¯·æ±‚æˆ–è€…è¯·æ±‚è½¬å‘ä¹‹é—´å®ç°æ•°æ®å…±äº« HttpSession ä¼šè¯åŸŸ getSession() sessionè¿‡æœŸï¼Œè°ƒç”¨invalidate()ï¼ŒæœåŠ¡å™¨å…³é—­ åœ¨å½“å‰ä¼šè¯èŒƒå›´ä¸­å®ç°æ•°æ®å…±äº«ï¼Œå¯ä»¥åœ¨å¤šæ¬¡è¯·æ±‚ä¸­å®ç°æ•°æ®å…±äº«ã€‚ï¼ˆéªŒè¯ç æ ¡éªŒ, ä¿å­˜ç”¨æˆ·ç™»å½•çŠ¶æ€ç­‰ï¼‰ åŸºæœ¬ä½¿ç”¨è·å–ä¼šè¯HttpServletRequestç±»è·å–Sessionï¼š æ–¹æ³• è¯´æ˜ HttpSession getSession() è·å–HttpSessionå¯¹è±¡ HttpSession getSession(boolean creat) è·å–HttpSessionå¯¹è±¡ï¼Œæœªè·å–åˆ°æ˜¯å¦è‡ªåŠ¨åˆ›å»º å¸¸ç”¨API æ–¹æ³• è¯´æ˜ void setAttribute(String name, Object value) è®¾ç½®ä¼šè¯åŸŸä¸­çš„æ•°æ® Object getAttribute(String name) è·å–æŒ‡å®šåç§°çš„ä¼šè¯åŸŸæ•°æ® Enumeration getAttributeNames() è·å–æ‰€æœ‰ä¼šè¯åŸŸæ‰€æœ‰å±æ€§çš„åç§° void removeAttribute(String name) ç§»é™¤ä¼šè¯åŸŸä¸­æŒ‡å®šåç§°çš„æ•°æ® String getId() è·å–å”¯ä¸€æ ‡è¯†åç§°ï¼ŒJsessionidçš„å€¼ void invalidate() ç«‹å³å¤±æ•ˆsession å®ç°ä¼šè¯é€šè¿‡ç¬¬ä¸€ä¸ªServletè®¾ç½®å…±äº«çš„æ•°æ®ç”¨æˆ·åï¼Œå¹¶åœ¨ç¬¬äºŒä¸ªServletè·å–åˆ° é¡¹ç›®æ‰§è¡Œå®Œä»¥åï¼Œå»æµè§ˆå™¨æŠ“åŒ…ï¼ŒRequest Headers ä¸­çš„ Cookie JSESSIONIDçš„å€¼æ˜¯ä¸€æ ·çš„ 12345678910111213141516171819@WebServlet(&quot;/servletDemo01&quot;)public class ServletDemo01 extends HttpServlet&#123; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; //1.è·å–è¯·æ±‚çš„ç”¨æˆ·å String username = req.getParameter(&quot;username&quot;); //2.è·å–HttpSessionçš„å¯¹è±¡ HttpSession session = req.getSession(); System.out.println(session); System.out.println(session.getId()); //3.å°†ç”¨æˆ·åä¿¡æ¯æ·»åŠ åˆ°å…±äº«æ•°æ®ä¸­ session.setAttribute(&quot;username&quot;,username); &#125; @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doGet(req,resp); &#125;&#125; 1234567891011121314151617@WebServlet(&quot;/servletDemo02&quot;)public class ServletDemo02 extends HttpServlet&#123; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; //1.è·å–HttpSessionå¯¹è±¡ HttpSession session = req.getSession(); //2.è·å–å…±äº«æ•°æ® Object username = session.getAttribute(&quot;username&quot;); //3.å°†æ•°æ®å“åº”ç»™æµè§ˆå™¨ resp.getWriter().write(username+&quot;&quot;); &#125; @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doGet(req,resp); &#125;&#125; ç”Ÿå‘½å‘¨æœŸSession çš„åˆ›å»ºï¼šä¸€ä¸ªå¸¸è§çš„é”™è¯¯æ˜¯ä»¥ä¸º Session åœ¨æœ‰å®¢æˆ·ç«¯è®¿é—®æ—¶å°±è¢«åˆ›å»ºï¼Œäº‹å®æ˜¯ç›´åˆ°æŸ server ç«¯ç¨‹åºï¼ˆå¦‚ Servletï¼‰è°ƒç”¨ HttpServletRequest.getSession(true) è¿™æ ·çš„è¯­å¥æ—¶æ‰ä¼šè¢«åˆ›å»º Session åœ¨ä»¥ä¸‹æƒ…å†µä¼šè¢«åˆ é™¤ï¼š ç¨‹åºè°ƒç”¨ HttpSession.invalidate() è·ç¦»ä¸Šä¸€æ¬¡æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„ session id æ—¶é—´é—´éš”è¶…è¿‡äº† session çš„æœ€å¤§æœ‰æ•ˆæ—¶é—´ æœåŠ¡å™¨è¿›ç¨‹è¢«åœæ­¢ æ³¨æ„äº‹é¡¹ï¼š å®¢æˆ·ç«¯åªä¿å­˜ sessionID åˆ° cookie ä¸­ï¼Œè€Œä¸ä¼šä¿å­˜ session å…³é—­æµè§ˆå™¨åªä¼šä½¿å­˜å‚¨åœ¨å®¢æˆ·ç«¯æµè§ˆå™¨å†…å­˜ä¸­çš„ cookie å¤±æ•ˆï¼Œä¸ä¼šä½¿æœåŠ¡å™¨ç«¯çš„ session å¯¹è±¡å¤±æ•ˆï¼ŒåŒæ ·ä¹Ÿä¸ä¼šä½¿å·²ç»ä¿å­˜åˆ°ç¡¬ç›˜ä¸Šçš„æŒä¹…åŒ–cookieæ¶ˆå¤± æ‰“å¼€ä¸¤ä¸ªæµè§ˆå™¨çª—å£è®¿é—®åº”ç”¨ç¨‹åºä¼šä½¿ç”¨çš„æ˜¯ä¸åŒçš„sessionï¼Œé€šå¸¸ session cookie æ˜¯ä¸èƒ½è·¨çª—å£ä½¿ç”¨ï¼Œå½“æ–°å¼€äº†ä¸€ä¸ªæµè§ˆå™¨çª—å£è¿›å…¥ç›¸åŒé¡µé¢æ—¶ï¼Œç³»ç»Ÿä¼šèµ‹äºˆä¸€ä¸ªæ–°çš„ session idï¼Œå®ç°è·¨çª—å£ä¿¡æ¯å…±äº«ï¼š å…ˆæŠŠ session id ä¿å­˜åœ¨ persistent cookie ä¸­ï¼ˆé€šè¿‡è®¾ç½®sessionçš„æœ€å¤§æœ‰æ•ˆæ—¶é—´ï¼‰ åœ¨æ–°çª—å£ä¸­è¯»å‡ºæ¥ï¼Œå°±å¯ä»¥å¾—åˆ°ä¸Šä¸€ä¸ªçª—å£çš„ session idï¼Œè¿™æ ·é€šè¿‡ session cookie å’Œ persistent cookie çš„ç»“åˆå°±å¯ä»¥å®ç°è·¨çª—å£çš„ä¼šè¯è·Ÿè¸ª ä¼šè¯é—®é¢˜ç¦ç”¨Cookieæµè§ˆå™¨ç¦ç”¨Cookieè§£å†³åŠæ³•ï¼š æ–¹å¼ä¸€ï¼šé€šè¿‡æç¤ºä¿¡æ¯å‘ŠçŸ¥ç”¨æˆ· 123456789101112131415161718@WebServlet(&quot;/servletDemo03&quot;)public class ServletDemo03 extends HttpServlet&#123; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; //1.è·å–HttpSessionå¯¹è±¡ HttpSession session = req.getSession(false); System.out.println(session); if(session == null) &#123; resp.setContentType(&quot;text/html;charset=UTF-8&quot;); resp.getWriter().write(&quot;ä¸ºäº†ä¸å½±å“æ­£å¸¸çš„ä½¿ç”¨ï¼Œè¯·ä¸è¦ç¦ç”¨æµè§ˆå™¨çš„Cookie~&quot;); &#125; &#125; @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doGet(req,resp); &#125;&#125; æ–¹å¼äºŒï¼šè®¿é—®æ—¶æ‹¼æ¥ jsessionid æ ‡è¯†ï¼Œé€šè¿‡ encodeURL() æ–¹æ³•é‡å†™åœ°å€ 123456789@Overrideprotected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; HttpSession session = req.getSession(); //å®ç°urlé‡å†™ ç›¸å½“äºåœ¨åœ°å€æ åé¢æ‹¼æ¥äº†ä¸€ä¸ªjsessionid resp.getWriter().write(&quot;&lt;a href=&#x27;&quot;+ resp.encodeURL (&quot;http://localhost:8080/session/servletDemo03&quot;) + &quot;&#x27;&gt;go servletDemo03&lt;/a&gt;&quot;);&#125; é’åŒ–æ´»åŒ–Session å­˜æ”¾åœ¨æœåŠ¡å™¨ç«¯çš„å†…å­˜ä¸­ï¼Œå¯ä»¥åšæŒä¹…åŒ–ç®¡ç†ã€‚ é’åŒ–ï¼šåºåˆ—åŒ–ï¼ŒæŒä¹…æ€ã€‚æŠŠé•¿æ—¶é—´ä¸ç”¨ï¼Œä½†è¿˜ä¸åˆ°è¿‡æœŸæ—¶é—´çš„ HttpSession è¿›è¡Œåºåˆ—åŒ–å†™åˆ°ç£ç›˜ä¸Šã€‚ æ´»åŒ–ï¼šç›¸åçš„çŠ¶æ€ ä½•æ—¶é’åŒ–ï¼š å½“è®¿é—®é‡å¾ˆå¤§æ—¶ï¼ŒæœåŠ¡å™¨ä¼šæ ¹æ®getLastAccessTimeæ¥è¿›è¡Œæ’åºï¼Œå¯¹é•¿æ—¶é—´ä¸ç”¨ï¼Œä½†æ˜¯è¿˜æ²¡åˆ°è¿‡æœŸæ—¶é—´çš„HttpSessionè¿›è¡Œåºåˆ—åŒ–ï¼ˆæŒä¹…åŒ–ï¼‰ å½“æœåŠ¡å™¨è¿›è¡Œé‡å¯çš„æ—¶å€™ï¼Œä¸ºäº†ä¿æŒå®¢æˆ·HttpSessionä¸­çš„æ•°æ®ï¼Œä¹Ÿè¦å¯¹HttpSessionè¿›è¡Œåºåˆ—åŒ–ï¼ˆæŒä¹…åŒ–ï¼‰ æ³¨æ„ï¼š HttpSessionçš„æŒä¹…åŒ–ç”±æœåŠ¡å™¨æ¥è´Ÿè´£ç®¡ç†ï¼Œæˆ‘ä»¬ä¸ç”¨å…³å¿ƒ åªæœ‰å®ç°äº†åºåˆ—åŒ–æ¥å£çš„ç±»æ‰èƒ½è¢«åºåˆ—åŒ– JSPJSPæ¦‚è¿°JSP(Java Server Page)ï¼šæ˜¯ä¸€ç§åŠ¨æ€ç½‘é¡µæŠ€æœ¯æ ‡å‡†ã€‚ï¼ˆé¡µé¢æŠ€æœ¯ï¼‰ JSPæ˜¯åŸºäºJavaè¯­è¨€çš„ï¼Œå®ƒçš„æœ¬è´¨å°±æ˜¯Servletï¼Œä¸€ä¸ªç‰¹æ®Šçš„Servletã€‚ JSPéƒ¨ç½²åœ¨æœåŠ¡å™¨ä¸Šï¼Œå¯ä»¥å¤„ç†å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ï¼Œå¹¶æ ¹æ®è¯·æ±‚å†…å®¹åŠ¨æ€çš„ç”ŸæˆHTMLã€XMLæˆ–å…¶ä»–æ ¼å¼æ–‡æ¡£çš„Webç½‘é¡µï¼Œç„¶åå“åº”ç»™å®¢æˆ·ç«¯ã€‚ ç±»åˆ« é€‚ç”¨åœºæ™¯ HTML å¼€å‘é™æ€èµ„æºï¼Œä¸èƒ½åŒ…å«javaä»£ç ï¼Œæ— æ³•æ·»åŠ åŠ¨æ€æ•°æ®ã€‚ CSS ç¾åŒ–é¡µé¢ JavaScript ç»™ç½‘é¡µæ·»åŠ åŠ¨æ€æ•ˆæœ Servlet ç¼–å†™javaä»£ç ï¼Œå®ç°åå°åŠŸèƒ½å¤„ç†ï¼Œä½†æ˜¯å¾ˆä¸æ–¹ä¾¿ï¼Œå¼€å‘æ•ˆç‡ä½ã€‚ JSP åŒ…æ‹¬äº†æ˜¾ç¤ºé¡µé¢æŠ€æœ¯ï¼ŒåŒæ—¶å…·å¤‡Servletè¾“å‡ºåŠ¨æ€èµ„æºçš„èƒ½åŠ›ã€‚ä½†æ˜¯ä¸é€‚åˆä½œä¸ºæ§åˆ¶å™¨æ¥ç”¨ã€‚ æ‰§è¡ŒåŸç† æ–°å»ºJavaEEå·¥ç¨‹ï¼Œç¼–å†™index.jspæ–‡ä»¶ 123456789&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;&lt;html&gt; &lt;head&gt; &lt;title&gt;JSPçš„å…¥é—¨&lt;/title&gt; &lt;/head&gt; &lt;body&gt; è¿™æ˜¯ç¬¬ä¸€ä¸ªJSPé¡µé¢ &lt;/body&gt;&lt;/html&gt; æ‰§è¡Œè¿‡ç¨‹ï¼š å®¢æˆ·ç«¯æäº¤è¯·æ±‚â€”â€”TomcatæœåŠ¡å™¨è§£æè¯·æ±‚åœ°å€â€”â€”æ‰¾åˆ°JSPé¡µé¢â€”â€”Tomcatå°†JSPé¡µé¢ç¿»è¯‘æˆServletçš„javaæ–‡ä»¶â€”â€”å°†ç¿»è¯‘å¥½çš„.javaæ–‡ä»¶ç¼–è¯‘æˆ.classæ–‡ä»¶â€”â€”è¿”å›åˆ°å®¢æˆ·æµè§ˆå™¨ä¸Š æº¯æºï¼Œæ‰“å¼€JSPç¿»è¯‘åçš„Javaæ–‡ä»¶ public final class index_jsp extends org.apache.jasper.runtime.HttpJspBaseï¼Œpublic abstract class HttpJspBase extends HttpServlet implements HttpJspPageï¼ŒHttpJspBaseæ˜¯ä¸ªæŠ½è±¡ç±»ç»§æ‰¿HttpServletï¼Œæ‰€ä»¥JSPæœ¬è´¨ä¸Šç»§æ‰¿HttpServlet åœ¨æ–‡ä»¶ä¸­æ‰¾åˆ°äº†è¾“å‡ºé¡µé¢çš„ä»£ç ï¼Œæœ¬è´¨éƒ½æ˜¯ç”¨out.write()è¾“å‡ºçš„JSPè¯­å¥ æ€»ç»“ï¼šJSPå®ƒæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„Servletï¼Œä¸»è¦æ˜¯ç”¨äºå±•ç¤ºåŠ¨æ€æ•°æ®ã€‚å®ƒå±•ç¤ºçš„æ–¹å¼æ˜¯ç”¨æµæŠŠæ•°æ®è¾“å‡ºå‡ºæ¥ï¼Œè€Œæˆ‘ä»¬åœ¨ä½¿ç”¨JSPæ—¶ï¼Œæ¶‰åŠHTMLçš„éƒ¨åˆ†ï¼Œéƒ½ä¸HTMLçš„ç”¨æ³•ä¸€è‡´ï¼Œè¿™éƒ¨åˆ†ç§°ä¸ºjspä¸­çš„æ¨¡æ¿å…ƒç´ ï¼Œå†³å®šäº†é¡µé¢çš„å¤–è§‚ã€‚ JSPè¯­æ³• JSPæ³¨é‡Šï¼š æ³¨é‡Šç±»å‹ æ–¹æ³• ä½œç”¨ JSPæ³¨é‡Š &lt;%â€“æ³¨é‡Šå†…å®¹â€“%&gt; è¢«jspæ³¨é‡Šçš„éƒ¨åˆ†ä¸ä¼šè¢«ç¿»è¯‘æˆ.javaæ–‡ä»¶ï¼Œä¸ä¼šåœ¨æµè§ˆå™¨ä¸Šæ˜¾ç¤º HTMLæ³¨é‡Š åœ¨Jspä¸­å¯ä»¥ä½¿ç”¨htmlçš„æ³¨é‡Šï¼Œä½†æ˜¯åªèƒ½æ³¨é‡Šhtmlå…ƒç´ è¢«htmlæ³¨é‡Šéƒ¨åˆ†ä¼šå‚ä¸ç¿»è¯‘ï¼Œå¹¶ä¸”ä¼šåœ¨æµè§ˆå™¨ä¸Šæ˜¾ç¤º Javaæ³¨é‡Š &#x2F;&#x2F;; &#x2F;* *&#x2F; Javaä»£ç å— 12&lt;% æ­¤å¤„å†™javaä»£ç  %&gt;&lt;%--ç”±tomcatè´Ÿè´£ç¿»è¯‘ï¼Œç¿»è¯‘ä¹‹åæ˜¯serviceæ–¹æ³•çš„æˆå‘˜å˜é‡--%&gt; JSPè¡¨è¾¾å¼ 12&lt;%=è¡¨è¾¾å¼%&gt;&lt;%--ç¿»è¯‘æˆService()æ–¹æ³•é‡Œé¢çš„å†…å®¹,ç›¸å½“äºè°ƒç”¨out.print()--%&gt; JSPå£°æ˜ 12&lt;%! å£°æ˜çš„å˜é‡æˆ–æ–¹æ³• %&gt;&lt;%--ç¿»è¯‘æˆServletç±»é‡Œé¢çš„å†…å®¹--%&gt; è¯­æ³•ç¤ºä¾‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;&lt;html&gt;&lt;head&gt; &lt;title&gt;jspè¯­æ³•&lt;/title&gt;&lt;/head&gt;&lt;body&gt; &lt;%--1. è¿™æ˜¯æ³¨é‡Š--%&gt; &lt;%-- 2.javaä»£ç å— System.out.println(&quot;Hello JSP&quot;); æ™®é€šè¾“å‡ºè¯­å¥ï¼Œè¾“å‡ºåœ¨æ§åˆ¶å°!! out.println(&quot;Hello JSP&quot;);outæ˜¯JspWriterå¯¹è±¡ï¼Œè¾“å‡ºåœ¨é¡µé¢ä¸Š --%&gt; &lt;% System.out.println(&quot;Hello JSP&quot;); out.println(&quot;Hello JSP&lt;br&gt;&quot;); String str = &quot;hello&lt;br&gt;&quot;; out.println(str); %&gt; &lt;%-- 3.jspè¡¨è¾¾å¼,ç›¸å½“äº out.println(&quot;Hello&quot;); --%&gt; &lt;%=&quot;Hello&lt;br&gt;&quot;%&gt; &lt;%-- 4.jspä¸­çš„å£°æ˜(å˜é‡æˆ–æ–¹æ³•) å¦‚æœåŠ ! ä»£è¡¨çš„æ˜¯å£°æ˜çš„æ˜¯æˆå‘˜å˜é‡ å¦‚æœä¸åŠ ! ä»£è¡¨çš„æ˜¯å£°æ˜çš„æ˜¯å±€éƒ¨å˜é‡,é¡µé¢æ˜¾ç¤ºabc --%&gt; &lt;%! String s = &quot;abc&quot;;%&gt; &lt;% String s = &quot;def&quot;;%&gt; &lt;%=s%&gt; &lt;%! public void getSum()&#123;&#125;%&gt;&lt;/body&gt;&lt;/html&gt; 123456æ§åˆ¶å°è¾“å‡ºï¼šHello JSPé¡µé¢è¾“å‡ºï¼š Hello JSP hello Hello def JSPæŒ‡ä»¤ pageæŒ‡ä»¤ï¼š 1&lt;%@ page å±æ€§å=å±æ€§å€¼ å±æ€§å=å±æ€§å€¼... %&gt; å±æ€§å ä½œç”¨ contentType è®¾ç½®å“åº”æ­£æ–‡æ”¯æŒçš„MIMEç±»å‹å’Œç¼–ç æ ¼å¼ï¼šcontentType&#x3D;â€text&#x2F;html;charset&#x3D;UTF-8â€ language å‘ŠçŸ¥å¼•æ“ï¼Œè„šæœ¬ä½¿ç”¨çš„è¯­è¨€ï¼Œé»˜è®¤ä¸ºJava errorPage å½“å‰é¡µé¢å‡ºç°å¼‚å¸¸åè·³è½¬çš„é¡µé¢ isErrorPage æ˜¯å¦æŠ“ä½å¼‚å¸¸ã€‚å€¼ä¸ºtrueé¡µé¢ä¸­å°±èƒ½ä½¿ç”¨exceptionå¯¹è±¡ï¼Œæ‰“å°å¼‚å¸¸ä¿¡æ¯ã€‚é»˜è®¤å€¼false import å¯¼å…¥å“ªäº›åŒ…ï¼ˆç±»ï¼‰&lt;%@ page import&#x3D;â€java.util.ArrayListâ€ %&gt; session æ˜¯å¦åˆ›å»ºHttpSessionå¯¹è±¡ï¼Œé»˜è®¤æ˜¯true buffer è®¾å®šJspWriterç”¨sè¾“å‡ºjspå†…å®¹çš„ç¼“å­˜å¤§å°ã€‚é»˜è®¤8kb pageEncoding ç¿»è¯‘jspæ—¶æ‰€ç”¨çš„ç¼–ç æ ¼å¼ï¼ŒpageEncoding&#x3D;â€UTF-8â€ç›¸å½“äºç”¨UTF-8è¯»å–JSP isELIgnored æ˜¯å¦å¿½ç•¥ELè¡¨è¾¾å¼ï¼Œé»˜è®¤å€¼æ˜¯false Noteï¼šå½“ä½¿ç”¨å…¨å±€é”™è¯¯é¡µé¢ï¼Œå°±æ— é¡»é…ç½®errorPageå®ç°è·³è½¬é”™è¯¯é¡µé¢ï¼Œè€Œæ˜¯ç”±æœåŠ¡å™¨è´Ÿè´£è·³è½¬åˆ°é”™è¯¯é¡µé¢ é…ç½®å…¨å±€é”™è¯¯é¡µé¢ï¼šweb.xml 12345678&lt;error-page&gt; &lt;exception-type&gt;java.lang.Exception&lt;/exception-type&gt; &lt;location&gt;/error.jsp&lt;/location&gt;&lt;/error-page&gt;&lt;error-page&gt; &lt;error-code&gt;404&lt;/error-code&gt; &lt;location&gt;/404.html&lt;/location&gt;&lt;/error-page&gt; includeæŒ‡ä»¤ï¼šåŒ…å«å…¶ä»–é¡µé¢ 1&lt;%@include file=&quot;è¢«åŒ…å«çš„é¡µé¢&quot; %&gt; å±æ€§ï¼šfileï¼Œä»¥&#x2F;å¼€å¤´ï¼Œå°±ä»£è¡¨å½“å‰åº”ç”¨ taglibæŒ‡ä»¤ï¼šå¼•å…¥å¤–éƒ¨æ ‡ç­¾åº“ 1&lt;%taglib uri=&quot;æ ‡ç­¾åº“çš„åœ°å€&quot; prefix=&quot;å‰ç¼€åç§°&quot;%&gt; htmlæ ‡ç­¾å’Œjspæ ‡ç­¾ä¸ç”¨å¼•å…¥ éšå¼å¯¹è±¡ä¹å¤§éšå¼å¯¹è±¡éšå¼å¯¹è±¡ï¼šåœ¨jspä¸­å¯ä»¥ä¸å£°æ˜å°±ç›´æ¥ä½¿ç”¨çš„å¯¹è±¡ã€‚å®ƒåªå­˜åœ¨äºjspä¸­ï¼Œå› ä¸ºjavaç±»ä¸­çš„å˜é‡å¿…é¡»è¦å…ˆå£°æ˜å†ä½¿ç”¨ã€‚jspä¸­çš„éšå¼å¯¹è±¡ä¹Ÿå¹¶ä¸æ˜¯æœªå£°æ˜ï¼Œå®ƒæ˜¯åœ¨ç¿»è¯‘æˆ.javaæ–‡ä»¶æ—¶å£°æ˜çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨jspä¸­å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚ éšå¼å¯¹è±¡åç§° ç±»å‹ å¤‡æ³¨ request javax.servlet.http.HttpServletRequest response javax.servlet.http.HttpServletResponse session javax.servlet.http.HttpSession PageæŒ‡ä»¤å¯ä»¥æ§åˆ¶å¼€å…³ application javax.servlet.ServletContext page Java.lang.Object å½“å‰jspå¯¹åº”çš„servletå¼•ç”¨å®ä¾‹ config javax.servlet.ServletConfig exception java.lang.Throwable pageæŒ‡ä»¤æœ‰å¼€å…³ out javax.servlet.jsp.JspWriter å­—ç¬¦è¾“å‡ºæµï¼Œç›¸å½“äºprintwriter pageContext javax.servlet.jsp.PageContext å¾ˆé‡è¦ï¼Œé¡µé¢åŸŸ PageContext PageContextå¯¹è±¡ç‰¹ç‚¹ï¼š PageContextdå¯¹è±¡æ˜¯JSPç‹¬æœ‰çš„å¯¹è±¡ï¼ŒServletä¸­æ²¡æœ‰ PageContextdå¯¹è±¡æ˜¯ä¸€ä¸ªé¡µé¢åŸŸï¼ˆä½œç”¨èŒƒå›´ï¼‰å¯¹è±¡ï¼Œè¿˜å¯ä»¥æ“ä½œå…¶ä»–ä¸‰ä¸ªåŸŸå¯¹è±¡ä¸­çš„å±æ€§ PageContextdå¯¹è±¡å¯ä»¥è·å–å…¶ä»–å…«ä¸ªéšå¼å¯¹è±¡ PageContextdå¯¹è±¡æ˜¯ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸéšç€JSPçš„åˆ›å»ºè€Œè¯ç”Ÿï¼Œéšç€JSPçš„ç»“æŸè€Œæ¶ˆå¤±ã€‚æ¯ä¸ªJSPé¡µé¢éƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„PageContext PageContextæ–¹æ³•å¦‚ä¸‹ï¼Œé¡µé¢åŸŸæ“ä½œçš„æ–¹æ³•å®šä¹‰åœ¨äº†PageContextçš„çˆ¶ç±»JspContextä¸­ å››å¤§åŸŸå¯¹è±¡ åŸŸå¯¹è±¡åç§° èŒƒå›´ çº§åˆ« å¤‡æ³¨ PageContext é¡µé¢èŒƒå›´ æœ€å°ï¼Œåªèƒ½åœ¨å½“å‰é¡µé¢ç”¨ å› èŒƒå›´å¤ªå°ï¼Œå¼€å‘ä¸­ç”¨çš„å¾ˆå°‘ ServletRequest è¯·æ±‚èŒƒå›´ ä¸€æ¬¡è¯·æ±‚æˆ–å½“æœŸè¯·æ±‚è½¬å‘ç”¨ å½“è¯·æ±‚è½¬å‘ä¹‹åï¼Œå†æ¬¡è½¬å‘æ—¶è¯·æ±‚åŸŸä¸¢å¤± HttpSession ä¼šè¯èŒƒå›´ å¤šæ¬¡è¯·æ±‚æ•°æ®å…±äº«æ—¶ä½¿ç”¨ å¤šæ¬¡è¯·æ±‚å…±äº«æ•°æ®ï¼Œä½†ä¸åŒçš„å®¢æˆ·ç«¯ä¸èƒ½å…±äº« ServletContext åº”ç”¨èŒƒå›´ æœ€å¤§ï¼Œæ•´ä¸ªåº”ç”¨éƒ½å¯ä»¥ä½¿ç”¨ å°½é‡å°‘ç”¨ï¼Œå¦‚æœå¯¹æ•°æ®æœ‰ä¿®æ”¹éœ€è¦åšåŒæ­¥å¤„ç† MVCæ¨¡å‹M : modelï¼Œ é€šå¸¸ç”¨äºå°è£…æ•°æ®ï¼Œå°è£…çš„æ˜¯æ•°æ®æ¨¡å‹V : viewï¼Œé€šå¸¸ç”¨äºå±•ç¤ºæ•°æ®ã€‚åŠ¨æ€å±•ç¤ºç”¨jspé¡µé¢ï¼Œé™æ€æ•°æ®å±•ç¤ºç”¨htmlC : controllerï¼Œé€šå¸¸ç”¨äºå¤„ç†è¯·æ±‚å’Œå“åº”ï¼Œä¸€èˆ¬æŒ‡çš„æ˜¯Servlet ELELæ¦‚è¿°ELè¡¨è¾¾å¼ï¼šExpression Languageï¼Œæ„ä¸ºè¡¨è¾¾å¼è¯­è¨€ã€‚å®ƒæ˜¯Servletè§„èŒƒä¸­çš„ä¸€éƒ¨åˆ†ï¼Œæ˜¯JSP2.0è§„èŒƒåŠ å…¥çš„å†…å®¹ã€‚ ELè¡¨è¾¾å¼ä½œç”¨ï¼šåœ¨JSPé¡µé¢ä¸­è·å–æ•°æ®ï¼Œè®©JSPè„±ç¦»javaä»£ç å—å’ŒJSPè¡¨è¾¾å¼ ELè¡¨è¾¾å¼æ ¼å¼ï¼š $&#123;è¡¨è¾¾å¼å†…å®¹&#125; ELè¡¨è¾¾å¼ç‰¹ç‚¹ï¼š æœ‰æ˜ç¡®çš„è¿”å›å€¼ æŠŠå†…å®¹è¾“å‡ºåˆ°é¡µé¢ä¸Š åªèƒ½åœ¨å››å¤§åŸŸå¯¹è±¡ä¸­è·å–æ•°æ®ï¼Œä¸åœ¨å››å¤§åŸŸå¯¹è±¡ä¸­çš„æ•°æ®å–ä¸åˆ°ã€‚ ELç”¨æ³•å¤šç§ç±»å‹ELè¡¨è¾¾å¼å¯ä»¥è·å–ä¸åŒç±»å‹æ•°æ®ï¼Œå‰ææ˜¯æ•°æ®æ”¾å…¥å››å¤§åŸŸå¯¹è±¡ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869&lt;%@ page import=&quot;bean.Student&quot; %&gt;&lt;%@ page import=&quot;java.util.ArrayList&quot; %&gt;&lt;%@ page import=&quot;java.util.HashMap&quot; %&gt;&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;&lt;html&gt;&lt;head&gt; &lt;title&gt;ELè¡¨è¾¾å¼è·å–ä¸åŒç±»å‹æ•°æ®&lt;/title&gt;&lt;/head&gt;&lt;body&gt; &lt;%--1.è·å–åŸºæœ¬æ•°æ®ç±»å‹--%&gt; &lt;% pageContext.setAttribute(&quot;num&quot;,10); %&gt; åŸºæœ¬æ•°æ®ç±»å‹ï¼š$&#123;num&#125; &lt;br&gt; &lt;%--2.è·å–è‡ªå®šä¹‰å¯¹è±¡ç±»å‹--%&gt; &lt;% Student stu = new Student(&quot;å¼ ä¸‰&quot;,23); pageContext.setAttribute(&quot;stu&quot;,stu); %&gt; è‡ªå®šä¹‰å¯¹è±¡ï¼š$&#123;stu&#125; &lt;br&gt; &lt;%--stu.name å®ç°åŸç† getName()--%&gt; å­¦ç”Ÿå§“åï¼š$&#123;stu.name&#125; &lt;br&gt; å­¦ç”Ÿå¹´é¾„ï¼š$&#123;stu.age&#125; &lt;br&gt; &lt;%--3.è·å–æ•°ç»„ç±»å‹--%&gt; &lt;% String[] arr = &#123;&quot;hello&quot;,&quot;world&quot;&#125;; pageContext.setAttribute(&quot;arr&quot;,arr); %&gt; æ•°ç»„ï¼š$&#123;arr&#125; &lt;br&gt; 0ç´¢å¼•å…ƒç´ ï¼š$&#123;arr[0]&#125; &lt;br&gt; 1ç´¢å¼•å…ƒç´ ï¼š$&#123;arr[1]&#125; &lt;br&gt; &lt;%--4.è·å–Listé›†åˆ--%&gt; &lt;% ArrayList&lt;String&gt; list = new ArrayList&lt;&gt;(); list.add(&quot;aaa&quot;); list.add(&quot;bbb&quot;); pageContext.setAttribute(&quot;list&quot;,list); %&gt; Listé›†åˆï¼š$&#123;list&#125; &lt;br&gt; 0ç´¢å¼•å…ƒç´ ï¼š$&#123;list[0]&#125; &lt;br&gt; &lt;%--5.è·å–Mapé›†åˆ--%&gt; &lt;% HashMap&lt;String,Student&gt; map = new HashMap&lt;&gt;(); map.put(&quot;hm01&quot;,new Student(&quot;å¼ ä¸‰&quot;,23)); map.put(&quot;hm02&quot;,new Student(&quot;æå››&quot;,24)); pageContext.setAttribute(&quot;map&quot;,map); %&gt; Mapé›†åˆï¼š$&#123;map&#125; &lt;br&gt; ç¬¬ä¸€ä¸ªå­¦ç”Ÿå¯¹è±¡ï¼š$&#123;map.hm01&#125; &lt;br&gt; ç¬¬ä¸€ä¸ªå­¦ç”Ÿå¯¹è±¡çš„å§“åï¼š$&#123;map.hm01.name&#125;&lt;/body&gt;&lt;/html&gt;&lt;--é¡µé¢è¾“å‡ºæ•ˆæœåŸºæœ¬æ•°æ®ç±»å‹ï¼š10è‡ªå®šä¹‰å¯¹è±¡ï¼šbean.Student@5f8da92c (åœ°å€)å­¦ç”Ÿå§“åï¼šå¼ ä¸‰å­¦ç”Ÿå¹´é¾„ï¼š23æ•°ç»„ï¼š[Ljava.lang.String;@4b3bd5200ç´¢å¼•å…ƒç´ ï¼šhello1ç´¢å¼•å…ƒç´ ï¼šworldListé›†åˆï¼š[aaa, bbb]0ç´¢å¼•å…ƒç´ ï¼šaaaMapé›†åˆï¼š&#123;hm01=bean.Student@4768d250, hm02=bean.Student@67f237d9&#125;ç¬¬ä¸€ä¸ªå­¦ç”Ÿå¯¹è±¡ï¼šbean.Student@4768d250ç¬¬ä¸€ä¸ªå­¦ç”Ÿå¯¹è±¡çš„å§“åï¼šå¼ ä¸‰--&gt; å¼‚å¸¸é—®é¢˜ELè¡¨è¾¾å¼çš„æ³¨æ„äº‹é¡¹ï¼š ELè¡¨è¾¾å¼æ²¡æœ‰ç©ºæŒ‡é’ˆå¼‚å¸¸ ELè¡¨è¾¾å¼æ²¡æœ‰æ•°ç»„ä¸‹æ ‡è¶Šç•Œ ELè¡¨è¾¾å¼æ²¡æœ‰å­—ç¬¦ä¸²æ‹¼æ¥ 12345678910111213141516171819202122232425262728293031323334&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;&lt;html&gt; &lt;head&gt; &lt;title&gt;ELè¡¨è¾¾å¼çš„æ³¨æ„äº‹é¡¹&lt;/title&gt; &lt;/head&gt; &lt;body&gt; ç¬¬ä¸€ä¸ªï¼šæ²¡æœ‰ç©ºæŒ‡é’ˆå¼‚å¸¸&lt;br/&gt; &lt;% String str = null; request.setAttribute(&quot;testNull&quot;,str); %&gt; strï¼š$&#123;testNull&#125; &lt;hr/&gt; ç¬¬äºŒä¸ªï¼šæ²¡æœ‰æ•°ç»„ä¸‹æ ‡è¶Šç•Œ&lt;br/&gt; &lt;% String[] strs = new String[]&#123;&quot;a&quot;,&quot;b&quot;,&quot;c&quot;&#125;; request.setAttribute(&quot;strs&quot;,strs); %&gt; å–ç¬¬ä¸€ä¸ªå…ƒç´ ï¼š$&#123;strs[0]&#125;&lt;br/&gt; å–ç¬¬å…­ä¸ªå…ƒç´ ï¼š$&#123;strs[5]&#125;&lt;br/&gt; &lt;hr/&gt; ç¬¬ä¸‰ä¸ªï¼šæ²¡æœ‰å­—ç¬¦ä¸²æ‹¼æ¥&lt;br/&gt; &lt;%--$&#123;strs[0]+strs[1]&#125;--%&gt; æ‹¼æ¥ï¼š$&#123;strs[0]&#125;+$&#123;strs[1]&#125; &lt;%--æ³¨æ„æ‹¼æ¥--%&gt; &lt;/body&gt;&lt;/html&gt;&lt;--é¡µé¢è¾“å‡ºæ•ˆæœç¬¬ä¸€ä¸ªï¼šæ²¡æœ‰ç©ºæŒ‡é’ˆå¼‚å¸¸strï¼šç¬¬äºŒä¸ªï¼šæ²¡æœ‰æ•°ç»„ä¸‹æ ‡è¶Šç•Œå–ç¬¬ä¸€ä¸ªå…ƒç´ ï¼šaå–ç¬¬å…­ä¸ªå…ƒç´ ï¼šç¬¬ä¸‰ä¸ªï¼šæ²¡æœ‰å­—ç¬¦ä¸²æ‹¼æ¥æ‹¼æ¥ï¼ša+b--&gt; è¿ç®—ç¬¦ELè¡¨è¾¾å¼ä¸­è¿ç®—ç¬¦ï¼š å…³ç³»è¿ç®—ç¬¦ï¼š é€»è¾‘è¿ç®—ç¬¦ï¼š é€»è¾‘è¿ç®—ç¬¦ è¯´æ˜ &amp;&amp; æˆ– and äº¤é›† || æˆ– or å¹¶é›† ! æˆ– not é â€‹ å…¶ä»–è¿ç®—ç¬¦ è¿ç®—ç¬¦ ä½œç”¨ empty 1. åˆ¤æ–­å¯¹è±¡æ˜¯å¦ä¸ºnull2. åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ä¸ºç©ºå­—ç¬¦ä¸²3. åˆ¤æ–­å®¹å™¨å…ƒç´ æ˜¯å¦ä¸º0 æ¡ä»¶ ? è¡¨è¾¾å¼1 : è¡¨è¾¾å¼2 ä¸‰å…ƒè¿ç®—ç¬¦ï¼Œæ¡ä»¶?çœŸ:å‡ 1234567891011121314151617181920212223&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;&lt;html&gt;&lt;head&gt; &lt;title&gt;ELè¡¨è¾¾å¼è¿ç®—ç¬¦&lt;/title&gt;&lt;/head&gt;&lt;body&gt; &lt;%--empty--%&gt; &lt;% String str1 = null; String str2 = &quot;&quot;; int[] arr = &#123;&#125;; %&gt; $&#123;empty str1&#125; &lt;br&gt; $&#123;empty str2&#125; &lt;br&gt; $&#123;empty arr&#125; &lt;br&gt; &lt;%--ä¸‰å…ƒè¿ç®—ç¬¦ã€‚è·å–æ€§åˆ«çš„æ•°æ®ï¼Œåœ¨å¯¹åº”çš„æŒ‰é’®ä¸Šè¿›è¡Œå‹¾é€‰--%&gt; &lt;% pageContext.setAttribute(&quot;gender&quot;,&quot;women&quot;); %&gt; &lt;input type=&quot;radio&quot; name=&quot;gender&quot; value=&quot;men&quot; $&#123;gender==&quot;men&quot;?&quot;checked&quot;:&quot;&quot;&#125;&gt;ç”· &lt;input type=&quot;radio&quot; name=&quot;gender&quot; value=&quot;women&quot; $&#123;gender==&quot;women&quot;?&quot;checked&quot;:&quot;&quot;&#125;&gt;å¥³&lt;/body&gt;&lt;/html&gt; å››å¤§åŸŸæ•°æ®ELè¡¨è¾¾å¼åªèƒ½ä»ä»å››å¤§åŸŸä¸­è·å–æ•°æ®ï¼Œè°ƒç”¨çš„å°±æ˜¯findAttribute(name,value);æ–¹æ³•ï¼Œæ ¹æ®åç§°ç”±å°åˆ°å¤§åœ¨åŸŸå¯¹è±¡ä¸­æŸ¥æ‰¾ï¼Œæ‰¾åˆ°å°±è¿”å›ï¼Œæ‰¾ä¸åˆ°å°±ä»€ä¹ˆéƒ½ä¸æ˜¾ç¤ºã€‚ 1234567891011121314151617181920&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;&lt;html&gt;&lt;head&gt; &lt;title&gt;ELè¡¨è¾¾å¼ä½¿ç”¨ç»†èŠ‚&lt;/title&gt;&lt;/head&gt;&lt;body&gt; &lt;%--è·å–å››å¤§åŸŸå¯¹è±¡ä¸­çš„æ•°æ®--%&gt; &lt;% //pageContext.setAttribute(&quot;username&quot;,&quot;zhangsan&quot;); request.setAttribute(&quot;username&quot;,&quot;zhangsan&quot;); //session.setAttribute(&quot;username&quot;,&quot;zhangsan&quot;); //application.setAttribute(&quot;username&quot;,&quot;zhangsan&quot;); %&gt; $&#123;username&#125; &lt;br&gt; &lt;%--è·å–JSPä¸­å…¶ä»–å…«ä¸ªéšå¼å¯¹è±¡ è·å–è™šæ‹Ÿç›®å½•åç§°--%&gt; &lt;%= request.getContextPath()%&gt; $&#123;pageContext.request.contextPath&#125;&lt;/body&gt;&lt;/html&gt; ELéšå¼å¯¹è±¡ELè¡¨è¾¾å¼éšå¼å¯¹è±¡ELè¡¨è¾¾å¼ä¹Ÿä¸ºæˆ‘ä»¬æä¾›éšå¼å¯¹è±¡ï¼Œå¯ä»¥è®©æˆ‘ä»¬ä¸å£°æ˜ç›´æ¥æ¥ä½¿ç”¨ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®ƒå’ŒJSPçš„éšå¼å¯¹è±¡ä¸æ˜¯åŒä¸€ç§äº‹ç‰©ã€‚ ELä¸­çš„éšå¼å¯¹è±¡ ç±»å‹ å¯¹åº”JSPéšå¼å¯¹è±¡ å¤‡æ³¨ PageContext Javax.serlvet.jsp.PageContext PageContext å®Œå…¨ä¸€æ · ApplicationScope Java.util.Map æ²¡æœ‰ åº”ç”¨å±‚èŒƒå›´ SessionScope Java.util.Map æ²¡æœ‰ ä¼šè¯èŒƒå›´ RequestScope Java.util.Map æ²¡æœ‰ è¯·æ±‚èŒƒå›´ PageScope Java.util.Map æ²¡æœ‰ é¡µé¢å±‚èŒƒå›´ Header Java.util.Map æ²¡æœ‰ è¯·æ±‚æ¶ˆæ¯å¤´keyï¼Œå€¼æ˜¯valueï¼ˆä¸€ä¸ªï¼‰ HeaderValues Java.util.Map æ²¡æœ‰ è¯·æ±‚æ¶ˆæ¯å¤´keyï¼Œå€¼æ˜¯æ•°ç»„ï¼ˆä¸€ä¸ªå¤´å¤šä¸ªå€¼ï¼‰ Param Java.util.Map æ²¡æœ‰ è¯·æ±‚å‚æ•°keyï¼Œå€¼æ˜¯valueï¼ˆä¸€ä¸ªï¼‰ ParamValues Java.util.Map æ²¡æœ‰ è¯·æ±‚å‚æ•°keyï¼Œå€¼æ˜¯æ•°ç»„ï¼ˆä¸€ä¸ªåç§°å¤šä¸ªå€¼ï¼‰ InitParam Java.util.Map æ²¡æœ‰ å…¨å±€å‚æ•°ï¼Œkeyæ˜¯å‚æ•°åç§°ï¼Œvalueæ˜¯å‚æ•°å€¼ Cookie Java.util.Map æ²¡æœ‰ Keyæ˜¯cookieçš„åç§°ï¼Œvalueæ˜¯cookieå¯¹è±¡ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;&lt;html&gt;&lt;head&gt; &lt;title&gt;ELè¡¨è¾¾å¼11ä¸ªéšå¼å¯¹è±¡&lt;/title&gt;&lt;/head&gt;&lt;body&gt; &lt;%--pageContextå¯¹è±¡ å¯ä»¥è·å–å…¶ä»–ä¸‰ä¸ªåŸŸå¯¹è±¡å’ŒJSPä¸­å…«ä¸ªéšå¼å¯¹è±¡--%&gt; $&#123;pageContext.request.contextPath&#125; &lt;br&gt; &lt;%--applicationScope sessionScope requestScope pageScope æ“ä½œå››å¤§åŸŸå¯¹è±¡ä¸­çš„æ•°æ®--%&gt; &lt;% request.setAttribute(&quot;username&quot;,&quot;zhangsan&quot;); %&gt; $&#123;username&#125; &lt;br&gt; $&#123;requestScope.username&#125; &lt;br&gt; &lt;%--header headerValues è·å–è¯·æ±‚å¤´æ•°æ®--%&gt; $&#123;header[&quot;connection&quot;]&#125; &lt;br&gt; $&#123;headerValues[&quot;connection&quot;][0]&#125; &lt;br&gt; &lt;%--param paramValues è·å–è¯·æ±‚å‚æ•°æ•°æ®--%&gt; $&#123;param.username&#125; &lt;br&gt; $&#123;paramValues.hobby[0]&#125; &lt;br&gt; $&#123;paramValues.hobby[1]&#125; &lt;br&gt; &lt;%--initParam è·å–å…¨å±€é…ç½®å‚æ•°--%&gt; $&#123;initParam[&quot;pname&quot;]&#125; &lt;br&gt; &lt;%--cookie è·å–cookieä¿¡æ¯--%&gt; $&#123;cookie&#125; &lt;br&gt; &lt;%--è·å–Mapé›†åˆ--%&gt; $&#123;cookie.JSESSIONID&#125; &lt;br&gt; &lt;%--è·å–mapé›†åˆä¸­ç¬¬äºŒä¸ªå…ƒç´ --%&gt; $&#123;cookie.JSESSIONID.name&#125; &lt;br&gt; &lt;%--è·å–cookieå¯¹è±¡çš„åç§°--%&gt; $&#123;cookie.JSESSIONID.value&#125; &lt;%--è·å–cookieå¯¹è±¡çš„å€¼--%&gt;&lt;/body&gt;&lt;/html&gt;&lt;--é¡µé¢æ˜¾ç¤º/elzhangsanzhangsankeep-alivekeep-alivebbb&#123;JSESSIONID=javax.servlet.http.Cookie@435c8431, Idea-5a5d203e=javax.servlet.http.Cookie@46be0b58, Idea-be3279e7=javax.servlet.http.Cookie@4ef6e8e8&#125;javax.servlet.http.Cookie@435c8431JSESSIONIDE481B2A845A448AD88A71FD43611FF02 --&gt; åœ¨web.xmlé…ç½®å…¨å±€å‚æ•° 12345678&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;web-app ******&gt; &lt;!--é…ç½®å…¨å±€å‚æ•°--&gt; &lt;context-param&gt; &lt;param-name&gt;pname&lt;/param-name&gt; &lt;param-value&gt;bbb&lt;/param-value&gt; &lt;/context-param&gt;&lt;/web-app&gt; è·å–JSPéšå¼å¯¹è±¡é€šè¿‡è·å–é¡µé¢åŸŸå¯¹è±¡ï¼Œè·å–å…¶ä»–JSPå…«ä¸ªéšå¼å¯¹è±¡ 1234567891011121314&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;&lt;html&gt;&lt;head&gt; &lt;title&gt;ELè¡¨è¾¾å¼ä½¿ç”¨ç»†èŠ‚&lt;/title&gt;&lt;/head&gt;&lt;body&gt; &lt;%--è·å–è™šæ‹Ÿç›®å½•åç§°--%&gt; &lt;%= request.getContextPath()%&gt; $&#123;pageContext.request.contextPath&#125;&lt;/body&gt;&lt;/html&gt;&lt;--é¡µé¢æ˜¾ç¤º/el /el--&gt; JSTLJSTLï¼šJava Server Pages Standarded Tag Libraryï¼ŒJSPä¸­æ ‡å‡†æ ‡ç­¾åº“ã€‚ ä½œç”¨ï¼šæä¾›ç»™å¼€å‘äººå‘˜ä¸€ä¸ªæ ‡å‡†çš„æ ‡ç­¾åº“ï¼Œå¼€å‘äººå‘˜å¯ä»¥åˆ©ç”¨è¿™äº›æ ‡ç­¾å–ä»£JSPé¡µé¢ä¸Šçš„Javaä»£ç ï¼Œä»è€Œæé«˜ç¨‹åºçš„å¯è¯»æ€§ï¼Œé™ä½ç¨‹åºçš„ç»´æŠ¤éš¾åº¦ã€‚ ç»„æˆ ä½œç”¨ è¯´æ˜ Core æ ¸å¿ƒæ ‡ç­¾åº“ é€šç”¨é€»è¾‘å¤„ç† Fmt å›½é™…åŒ–æœ‰å…³ éœ€è¦ä¸åŒåœ°åŸŸæ˜¾ç¤ºä¸åŒè¯­è¨€æ—¶ä½¿ç”¨ Functions ELå‡½æ•° ELè¡¨è¾¾å¼å¯ä»¥ä½¿ç”¨çš„æ–¹æ³• SQL æ“ä½œæ•°æ®åº“ XML æ“ä½œXML ä½¿ç”¨ï¼šæ·»åŠ jaråŒ…ï¼Œé€šè¿‡taglibå¯¼å…¥ï¼Œprefixå±æ€§è¡¨ç¤ºç¨‹åºè°ƒç”¨æ ‡ç­¾ä½¿ç”¨çš„å¼•ç”¨å æ ‡ç­¾åç§° åŠŸèƒ½åˆ†ç±» åˆ†ç±» ä½œç”¨ &#96;&lt;c:if test&#x3D;â€${A&#x3D;&#x3D;B C&#x3D;&#x3D;D}â€&gt;&#96; æµç¨‹æ§åˆ¶ &lt;c:choose&gt; ,&lt;c:when&gt;,&lt;c:otherwise&gt; æµç¨‹æ§åˆ¶ æ ¸å¿ƒæ ‡ç­¾åº“ ç”¨äºå¤šä¸ªæ¡ä»¶åˆ¤æ–­ &lt;c:foreache&gt; è¿­ä»£æ“ä½œ æ ¸å¿ƒæ ‡ç­¾åº“ ç”¨äºå¾ªç¯éå† æµç¨‹æ§åˆ¶ 12345678910111213141516171819202122232425&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;&lt;%@taglib uri=&quot;http://java.sun.com/jsp/jstl/core&quot; prefix=&quot;c&quot;%&gt;&lt;html&gt;&lt;head&gt; &lt;title&gt;æµç¨‹æ§åˆ¶&lt;/title&gt;&lt;/head&gt;&lt;body&gt; &lt;%--å‘åŸŸå¯¹è±¡ä¸­æ·»åŠ æˆç»©æ•°æ®--%&gt; $&#123;pageContext.setAttribute(&quot;score&quot;,&quot;T&quot;)&#125; &lt;%--å¯¹æˆç»©è¿›è¡Œåˆ¤æ–­--%&gt; &lt;c:if test=&quot;$&#123;score eq &#x27;A&#x27;&#125;&quot;&gt; ä¼˜ç§€ &lt;/c:if&gt; &lt;%--å¯¹æˆç»©è¿›è¡Œå¤šæ¡ä»¶åˆ¤æ–­--%&gt; &lt;c:choose&gt; &lt;c:when test=&quot;$&#123;score eq &#x27;A&#x27;&#125;&quot;&gt;ä¼˜ç§€&lt;/c:when&gt; &lt;c:when test=&quot;$&#123;score eq &#x27;B&#x27;&#125;&quot;&gt;è‰¯å¥½&lt;/c:when&gt; &lt;c:when test=&quot;$&#123;score eq &#x27;C&#x27;&#125;&quot;&gt;åŠæ ¼&lt;/c:when&gt; &lt;c:when test=&quot;$&#123;score eq &#x27;D&#x27;&#125;&quot;&gt;è¾ƒå·®&lt;/c:when&gt; &lt;c:otherwise&gt;æˆç»©éæ³•&lt;/c:otherwise&gt; &lt;/c:choose&gt;&lt;/body&gt;&lt;/html&gt; è¿­ä»£æ“ä½œc:forEachï¼šç”¨æ¥éå†é›†åˆï¼Œå±æ€§ï¼š å±æ€§ ä½œç”¨ items æŒ‡å®šè¦éå†çš„é›†åˆï¼Œå®ƒå¯ä»¥æ˜¯ç”¨ELè¡¨è¾¾å¼å–å‡ºæ¥çš„å…ƒç´  var æŠŠå½“å‰éå†çš„å…ƒç´ æ”¾å…¥æŒ‡å®šçš„pageåŸŸä¸­ã€‚varçš„å€¼æ˜¯keyï¼Œéå†çš„å…ƒç´ æ˜¯valueæ³¨æ„ï¼švarä¸æ”¯æŒELè¡¨è¾¾å¼ï¼Œåªèƒ½æ˜¯å­—ç¬¦ä¸²å¸¸é‡ begin å¼€å§‹éå†çš„ç´¢å¼• end ç»“æŸéå†çš„ç´¢å¼• step æ­¥é•¿ï¼Œi+&#x3D;step varStatus å®ƒæ˜¯ä¸€ä¸ªè®¡æ•°å™¨å¯¹è±¡ï¼Œæœ‰ä¸¤ä¸ªå±æ€§ï¼Œä¸€ä¸ªæ˜¯ç”¨äºè®°å½•ç´¢å¼•ï¼Œä¸€ä¸ªæ˜¯ç”¨äºè®¡æ•°ã€‚ç´¢å¼•æ˜¯ä»0å¼€å§‹ï¼Œè®¡æ•°æ˜¯ä»1å¼€å§‹ 1234567891011121314151617181920212223&lt;%@ page import=&quot;java.util.ArrayList&quot; %&gt;&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;&lt;%@taglib uri=&quot;http://java.sun.com/jsp/jstl/core&quot; prefix=&quot;c&quot;%&gt;&lt;html&gt;&lt;head&gt; &lt;title&gt;å¾ªç¯&lt;/title&gt;&lt;/head&gt;&lt;body&gt; &lt;%--å‘åŸŸå¯¹è±¡ä¸­æ·»åŠ é›†åˆ--%&gt; &lt;% ArrayList&lt;String&gt; list = new ArrayList&lt;&gt;(); list.add(&quot;aa&quot;); list.add(&quot;bb&quot;); list.add(&quot;cc&quot;); list.add(&quot;dd&quot;); pageContext.setAttribute(&quot;list&quot;,list); %&gt; &lt;%--éå†é›†åˆ--%&gt; &lt;c:forEach items=&quot;$&#123;list&#125;&quot; var=&quot;str&quot;&gt; $&#123;str&#125; &lt;br&gt; &lt;/c:forEach&gt;&lt;/body&gt;&lt;/html&gt; Filterè¿‡æ»¤å™¨Filterï¼šè¿‡æ»¤å™¨ï¼Œæ˜¯ JavaWeb ä¸‰å¤§ç»„ä»¶ä¹‹ä¸€ï¼Œå¦å¤–ä¸¤ä¸ªæ˜¯ Servlet å’Œ Listener å·¥ä½œæµç¨‹ï¼šåœ¨ç¨‹åºè®¿é—®æœåŠ¡å™¨èµ„æºæ—¶ï¼Œå½“ä¸€ä¸ªè¯·æ±‚åˆ°æ¥ï¼ŒæœåŠ¡å™¨é¦–å…ˆåˆ¤æ–­æ˜¯å¦æœ‰è¿‡æ»¤å™¨ä¸å»è¯·æ±‚èµ„æºç›¸å…³è”ï¼Œå¦‚æœæœ‰è¿‡æ»¤å™¨å¯ä»¥å°†è¯·æ±‚æ‹¦æˆªä¸‹æ¥ï¼Œå®Œæˆä¸€äº›ç‰¹å®šçš„åŠŸèƒ½ï¼Œå†ç”±è¿‡æ»¤å™¨å†³å®šæ˜¯å¦äº¤ç»™è¯·æ±‚èµ„æºï¼Œå¦‚æœæ²¡æœ‰å°±ç›´æ¥è¯·æ±‚èµ„æºï¼Œå“åº”åŒç† ä½œç”¨ï¼šè¿‡æ»¤å™¨ä¸€èˆ¬ç”¨äºå®Œæˆé€šç”¨çš„æ“ä½œï¼Œä¾‹å¦‚ï¼šç™»å½•éªŒè¯ã€ç»Ÿä¸€ç¼–ç å¤„ç†ã€æ•æ„Ÿå­—ç¬¦è¿‡æ»¤ç­‰ ç›¸å…³ç±»FilterFilteræ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¦‚æœæƒ³å®ç°è¿‡æ»¤å™¨çš„åŠŸèƒ½ï¼Œå¿…é¡»å®ç°è¯¥æ¥å£ æ ¸å¿ƒæ–¹æ³• æ–¹æ³• è¯´æ˜ void init(FilterConfig filterConfig) åˆå§‹åŒ–ï¼Œå¼€å¯è¿‡æ»¤å™¨ void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) å¯¹è¯·æ±‚èµ„æºå’Œå“åº”èµ„æºè¿‡æ»¤ void destroy() é”€æ¯è¿‡æ»¤å™¨ é…ç½®æ–¹å¼ æ³¨è§£æ–¹å¼ 12@WebFilter(&quot;/*&quot;)()å†…å¡«æ‹¦æˆªè·¯å¾„ï¼Œ/*ä»£è¡¨å…¨éƒ¨è·¯å¾„ é…ç½®æ–‡ä»¶ 12345678&lt;filter&gt; &lt;filter-name&gt;filterDemo01&lt;/filter-name&gt; &lt;filter-class&gt;filter.FilterDemo01&lt;/filter-class&gt;&lt;/filter&gt;&lt;filter-mapping&gt; &lt;filter-name&gt;filterDemo01&lt;/filter-name&gt; &lt;url-pattern&gt;/*&lt;/url-pattern&gt;&lt;/filter-mapping&gt; FilterChain FilterChain æ˜¯ä¸€ä¸ªæ¥å£ï¼Œä»£è¡¨è¿‡æ»¤å™¨å¯¹è±¡ã€‚ç”±Servletå®¹å™¨æä¾›å®ç°ç±»å¯¹è±¡ï¼Œç›´æ¥ä½¿ç”¨å³å¯ã€‚ è¿‡æ»¤å™¨å¯ä»¥å®šä¹‰å¤šä¸ªï¼Œå°±ä¼šç»„æˆè¿‡æ»¤å™¨é“¾ æ ¸å¿ƒæ–¹æ³•ï¼švoid doFilter(ServletRequest request, ServletResponse response) ç”¨æ¥æ”¾è¡Œæ–¹æ³• å¦‚æœæœ‰å¤šä¸ªè¿‡æ»¤å™¨ï¼Œåœ¨ç¬¬ä¸€ä¸ªè¿‡æ»¤å™¨ä¸­è°ƒç”¨ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°åˆ°è¾¾æœ€ç»ˆè®¿é—®èµ„æºã€‚å¦‚æœåªæœ‰ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œæ”¾è¡Œæ—¶å°±ä¼šç›´æ¥åˆ°è¾¾æœ€ç»ˆè®¿é—®èµ„æºã€‚ FilterConfigFilterConfig æ˜¯ä¸€ä¸ªæ¥å£ï¼Œä»£è¡¨è¿‡æ»¤å™¨çš„é…ç½®å¯¹è±¡ï¼Œå¯ä»¥åŠ è½½ä¸€äº›åˆå§‹åŒ–å‚æ•° æ–¹æ³• ä½œç”¨ String getFilterName() è·å–è¿‡æ»¤å™¨å¯¹è±¡åç§° String getInitParameter(String name) è·å–æŒ‡å®šåç§°çš„åˆå§‹åŒ–å‚æ•°çš„å€¼ï¼Œä¸å­˜åœ¨è¿”å›null Enumeration getInitParameterNames() è·å–æ‰€æœ‰å‚æ•°çš„åç§° ServletContext getServletContext() è·å–åº”ç”¨ä¸Šä¸‹æ–‡å¯¹è±¡ Filterä½¿ç”¨è®¾ç½®é¡µé¢ç¼–ç è¯·æ±‚å…ˆè¢«è¿‡æ»¤å™¨æ‹¦æˆªè¿›è¡Œç›¸å…³æ“ä½œ è¿‡æ»¤å™¨æ”¾è¡Œä¹‹åæ‰§è¡Œå®Œç›®æ ‡èµ„æºï¼Œä»ä¼šå›åˆ°è¿‡æ»¤å™¨ä¸­ Filter ä»£ç ï¼š 123456789101112@WebFilter(&quot;/*&quot;)public class FilterDemo01 implements Filter&#123; @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException &#123; System.out.println(&quot;filterDemo01æ‹¦æˆªåˆ°è¯·æ±‚...&quot;); //å¤„ç†ä¹±ç  servletResponse.setContentType(&quot;text/html;charset=UTF-8&quot;); //è¿‡æ»¤å™¨æ”¾è¡Œ filterChain.doFilter(servletRequest,servletResponse); System.out.println(&quot;filterDemo1æ”¾è¡Œä¹‹åï¼Œåˆå›åˆ°äº†doFilteræ–¹æ³•&quot;); &#125;&#125; Servlet ä»£ç ï¼š 123456789101112@WebServlet(&quot;/servletDemo01&quot;)public class ServletDemo01 extends HttpServlet &#123; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; System.out.println(&quot;servletDemo01æ‰§è¡Œäº†...&quot;); resp.getWriter().write(&quot;servletDemo01æ‰§è¡Œäº†...&quot;); &#125; @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doGet(req,resp); &#125;&#125; æ§åˆ¶å°è¾“å‡ºï¼š 123filterDemo01æ‹¦æˆªåˆ°è¯·æ±‚...servletDemo01æ‰§è¡Œäº†...filterDemo1æ”¾è¡Œä¹‹åï¼Œåˆå›åˆ°äº†doFilteræ–¹æ³• å¤šè¿‡æ»¤å™¨é¡ºåºå¤šä¸ªè¿‡æ»¤å™¨ä½¿ç”¨çš„é¡ºåºï¼Œå–å†³äºè¿‡æ»¤å™¨æ˜ å°„çš„é¡ºåºã€‚ ä¸¤ä¸ª Filter ä»£ç ï¼š 1234567891011121314public class FilterDemo01 implements Filter&#123; @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException &#123; System.out.println(&quot;filterDemo01æ‰§è¡Œäº†...&quot;); filterChain.doFilter(servletRequest,servletResponse); &#125;&#125;public class FilterDemo02 implements Filter&#123; @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException &#123; System.out.println(&quot;filterDemo02æ‰§è¡Œäº†...&quot;); filterChain.doFilter(servletRequest,servletResponse); &#125;&#125; Servletä»£ç ï¼šSystem.out.println(&quot;servletDemo02æ‰§è¡Œäº†...&quot;); web.xmlé…ç½®ï¼š 12345678910111213141516&lt;filter&gt; &lt;filter-name&gt;filterDemo01&lt;/filter-name&gt; &lt;filter-class&gt;filter.FilterDemo01&lt;/filter-class&gt;&lt;/filter&gt;&lt;filter-mapping&gt; &lt;filter-name&gt;filterDemo01&lt;/filter-name&gt; &lt;url-pattern&gt;/*&lt;/url-pattern&gt;&lt;/filter-mapping&gt;&lt;filter&gt; &lt;filter-name&gt;filterDemo02&lt;/filter-name&gt; &lt;filter-class&gt;filter.FilterDemo02&lt;/filter-class&gt;&lt;/filter&gt;&lt;filter-mapping&gt; &lt;filter-name&gt;filterDemo02&lt;/filter-name&gt; &lt;url-pattern&gt;/*&lt;/url-pattern&gt;&lt;/filter-mapping&gt; æ§åˆ¶å°è¾“å‡ºï¼š 123filterDemo01æ‰§è¡Œäº†filterDemo02æ‰§è¡Œäº†servletDemo02æ‰§è¡Œäº†... åœ¨è¿‡æ»¤å™¨çš„é…ç½®ä¸­ï¼Œæœ‰è¿‡æ»¤å™¨çš„å£°æ˜å’Œè¿‡æ»¤å™¨çš„æ˜ å°„ä¸¤éƒ¨åˆ†ï¼Œåˆ°åº•æ˜¯å£°æ˜å†³å®šé¡ºåºï¼Œè¿˜æ˜¯æ˜ å°„å†³å®šé¡ºåºå‘¢ï¼Ÿ ç­”æ¡ˆæ˜¯ï¼š&lt;filter-mapping&gt;çš„é…ç½®å‰åé¡ºåºå†³å®šè¿‡æ»¤å™¨çš„è°ƒç”¨é¡ºåºï¼Œä¹Ÿå°±æ˜¯ç”±æ˜ å°„é…ç½®é¡ºåºå†³å®šã€‚ Filterç”Ÿå‘½å‘¨æœŸåˆ›å»ºï¼šå½“åº”ç”¨åŠ è½½æ—¶å®ä¾‹åŒ–å¯¹è±¡å¹¶æ‰§è¡Œinit()åˆå§‹åŒ–æ–¹æ³• æœåŠ¡ï¼šå¯¹è±¡æä¾›æœåŠ¡çš„è¿‡ç¨‹ï¼Œæ‰§è¡ŒdoFilter()æ–¹æ³• é”€æ¯ï¼šå½“åº”ç”¨å¸è½½æ—¶æˆ–æœåŠ¡å™¨åœæ­¢æ—¶å¯¹è±¡é”€æ¯ï¼Œæ‰§è¡Œdestroy()æ–¹æ³• Filterä»£ç ï¼š 123456789101112131415161718192021222324252627@WebFilter(&quot;/*&quot;)public class FilterDemo03 implements Filter&#123; /* åˆå§‹åŒ–æ–¹æ³• */ @Override public void init(FilterConfig filterConfig) &#123; System.out.println(&quot;å¯¹è±¡åˆå§‹åŒ–æˆåŠŸäº†...&quot;); &#125; /* æä¾›æœåŠ¡æ–¹æ³• */ @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException &#123; System.out.println(&quot;filterDemo03æ‰§è¡Œäº†...&quot;); //è¿‡æ»¤å™¨æ”¾è¡Œ filterChain.doFilter(servletRequest,servletResponse); &#125; /* å¯¹è±¡é”€æ¯æ–¹æ³•ï¼Œå…³é—­TomcatæœåŠ¡å™¨ */ @Override public void destroy() &#123; System.out.println(&quot;å¯¹è±¡é”€æ¯äº†...&quot;); &#125;&#125; Servlet ä»£ç ï¼šSystem.out.println(&quot;servletDemo03æ‰§è¡Œäº†...&quot;); æ§åˆ¶å°è¾“å‡ºï¼š 1234å¯¹è±¡åˆå§‹åŒ–æˆåŠŸäº†...filterDemo03æ‰§è¡Œäº†...servletDemo03æ‰§è¡Œäº†...å¯¹è±¡é”€æ¯äº† FilterConfigä½¿ç”¨Filteråˆå§‹åŒ–å‡½æ•°initçš„å‚æ•°æ˜¯FilterConfig å¯¹è±¡ Filterä»£ç ï¼š 1234567891011121314151617181920212223public class FilterDemo04 implements Filter&#123; //åˆå§‹åŒ–æ–¹æ³• @Override public void init(FilterConfig filterConfig) &#123; System.out.println(&quot;å¯¹è±¡åˆå§‹åŒ–æˆåŠŸäº†...&quot;); //è·å–è¿‡æ»¤å™¨åç§° String filterName = filterConfig.getFilterName(); System.out.println(filterName); //æ ¹æ®nameè·å–value String username = filterConfig.getInitParameter(&quot;username&quot;); System.out.println(username); &#125; @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException &#123; System.out.println(&quot;filterDemo04æ‰§è¡Œäº†...&quot;); filterChain.doFilter(servletRequest,servletResponse); &#125; @Override public void destroy() &#123;&#125;&#125; web.xmlé…ç½® 123456789101112&lt;filter&gt; &lt;filter-name&gt;filterDemo04&lt;/filter-name&gt; &lt;filter-class&gt;filter.FilterDemo04&lt;/filter-class&gt; &lt;init-param&gt; &lt;param-name&gt;username&lt;/param-name&gt; &lt;param-value&gt;zhangsan&lt;/param-value&gt; &lt;/init-param&gt;&lt;/filter&gt;&lt;filter-mapping&gt; &lt;filter-name&gt;filterDemo04&lt;/filter-name&gt; &lt;url-pattern&gt;/*&lt;/url-pattern&gt;&lt;/filter-mapping&gt; æ§åˆ¶å°è¾“å‡ºï¼š 123å¯¹è±¡åˆå§‹åŒ–æˆåŠŸäº†...filterDemo04zhangsan Filteræ¡ˆä¾‹åœ¨è®¿é—®htmlï¼Œjsï¼Œimageæ—¶ï¼Œä¸éœ€è¦æ¯æ¬¡éƒ½é‡æ–°å‘é€è¯·æ±‚è¯»å–èµ„æºï¼Œå°±å¯ä»¥é€šè¿‡è®¾ç½®å“åº”æ¶ˆæ¯å¤´çš„æ–¹å¼ï¼Œè®¾ç½®ç¼“å­˜æ—¶é—´ã€‚ä½†æ˜¯å¦‚æœæ¯ä¸ªServletéƒ½ç¼–å†™ç›¸åŒçš„ä»£ç ï¼Œæ˜¾ç„¶ä¸ç¬¦åˆæˆ‘ä»¬ç»Ÿä¸€è°ƒç”¨å’Œç»´æŠ¤çš„ç†å¿µã€‚ é™æ€èµ„æºè®¾ç½®ç¼“å­˜æ—¶é—´ï¼šhtmlè®¾ç½®ä¸º1å°æ—¶ï¼Œjsè®¾ç½®ä¸º2å°æ—¶ï¼Œcssè®¾ç½®ä¸º3å°æ—¶ é…ç½®è¿‡æ»¤å™¨ 12345678910111213141516171819202122232425262728&lt;filter&gt; &lt;filter-name&gt;StaticResourceNeedCacheFilter&lt;/filter-name&gt; &lt;filter-class&gt;filter.StaticResourceNeedCacheFilter&lt;/filter-class&gt; &lt;init-param&gt; &lt;param-name&gt;html&lt;/param-name&gt; &lt;param-value&gt;3&lt;/param-value&gt; &lt;/init-param&gt; &lt;init-param&gt; &lt;param-name&gt;js&lt;/param-name&gt; &lt;param-value&gt;4&lt;/param-value&gt; &lt;/init-param&gt; &lt;init-param&gt; &lt;param-name&gt;css&lt;/param-name&gt; &lt;param-value&gt;5&lt;/param-value&gt; &lt;/init-param&gt;&lt;/filter&gt;&lt;filter-mapping&gt; &lt;filter-name&gt;StaticResourceNeedCacheFilter&lt;/filter-name&gt; &lt;url-pattern&gt;*.html&lt;/url-pattern&gt;&lt;/filter-mapping&gt;&lt;filter-mapping&gt; &lt;filter-name&gt;StaticResourceNeedCacheFilter&lt;/filter-name&gt; &lt;url-pattern&gt;*.js&lt;/url-pattern&gt;&lt;/filter-mapping&gt;&lt;filter-mapping&gt; &lt;filter-name&gt;StaticResourceNeedCacheFilter&lt;/filter-name&gt; &lt;url-pattern&gt;*.css&lt;/url-pattern&gt;&lt;/filter-mapping&gt; ç¼–å†™è¿‡æ»¤å™¨ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748public class StaticResourceNeedCacheFilter implements Filter &#123; private FilterConfig filterConfig;//è·å–åˆå§‹åŒ–å‚æ•° @Override public void init(FilterConfig filterConfig) throws ServletException &#123; this.filterConfig = filterConfig; &#125; @Override public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain) throws IOException, ServletException &#123; //1.æŠŠdoFilterçš„è¯·æ±‚å’Œå“åº”å¯¹è±¡è½¬æ¢æˆè·Ÿhttpåè®®æœ‰å…³çš„å¯¹è±¡ HttpServletRequest request; HttpServletResponse response; try &#123; request = (HttpServletRequest) req; response = (HttpServletResponse) res; &#125; catch (ClassCastException e) &#123; throw new ServletException(&quot;non-HTTP request or response&quot;); &#125; //2.è·å–è¯·æ±‚èµ„æºURI String uri = request.getRequestURI(); //3.å¾—åˆ°è¯·æ±‚èµ„æºåˆ°åº•æ˜¯ä»€ä¹ˆç±»å‹ String extend = uri.substring(uri.lastIndexOf(&quot;.&quot;)+1);//æˆ‘ä»¬åªéœ€è¦åˆ¤æ–­å®ƒæ˜¯ä¸æ˜¯html,css,jsã€‚å…¶ä»–çš„ä¸ç®¡ //4.åˆ¤æ–­åˆ°åº•æ˜¯ä»€ä¹ˆç±»å‹çš„èµ„æº long time = 60*60*1000; if(&quot;html&quot;.equals(extend))&#123; //html ç¼“å­˜1å°æ—¶ String html = filterConfig.getInitParameter(&quot;html&quot;); time = time*Long.parseLong(html); &#125;else if(&quot;js&quot;.equals(extend))&#123; //js ç¼“å­˜2å°æ—¶ String js = filterConfig.getInitParameter(&quot;js&quot;); time = time*Long.parseLong(js); &#125;else if(&quot;css&quot;.equals(extend))&#123; //css ç¼“å­˜3å°æ—¶ String css = filterConfig.getInitParameter(&quot;css&quot;); time = time*Long.parseLong(css); &#125; //5.è®¾ç½®å“åº”æ¶ˆæ¯å¤´ response.setDateHeader(&quot;Expires&quot;, System.currentTimeMillis()+time); //6.æ”¾è¡Œ chain.doFilter(request, response); &#125; @Override public void destroy() &#123;&#125;&#125; æ‹¦æˆªè¡Œä¸ºFilterè¿‡æ»¤å™¨é»˜è®¤æ‹¦æˆªçš„æ˜¯è¯·æ±‚ï¼Œä½†æ˜¯åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬è¿˜æœ‰è¯·æ±‚è½¬å‘å’Œè¯·æ±‚åŒ…å«ï¼Œä»¥åŠç”±æœåŠ¡å™¨è§¦å‘è°ƒç”¨çš„å…¨å±€é”™è¯¯é¡µé¢ã€‚é»˜è®¤æƒ…å†µä¸‹è¿‡æ»¤å™¨æ˜¯ä¸å‚ä¸è¿‡æ»¤çš„ï¼Œéœ€è¦é…ç½®web.xml å¼€å¯åŠŸèƒ½åï¼Œå½“è®¿é—®é¡µé¢å‘ç”Ÿç›¸å…³è¡Œä¸ºåï¼Œä¼šæ‰§è¡Œè¿‡æ»¤å™¨çš„æ“ä½œ äº”ç§æ‹¦æˆªè¡Œä¸ºï¼š 1234567891011121314151617181920212223&lt;!--é…ç½®è¿‡æ»¤å™¨--&gt;&lt;filter&gt; &lt;filter-name&gt;FilterDemo5&lt;/filter-name&gt; &lt;filter-class&gt;filter.FilterDemo5&lt;/filter-class&gt; &lt;!--é…ç½®å¼€å¯å¼‚æ­¥æ”¯æŒï¼Œå½“dispatcheré…ç½®ASYNCæ—¶ï¼Œéœ€è¦é…ç½®æ­¤è¡Œ--&gt; &lt;async-supported&gt;true&lt;/async-supported&gt;&lt;/filter&gt;&lt;filter-mapping&gt; &lt;filter-name&gt;FilterDemo5&lt;/filter-name&gt; &lt;url-pattern&gt;/error.jsp&lt;/url-pattern&gt; &lt;!--&lt;url-pattern&gt;/index.jsp&lt;/url-pattern&gt;--&gt; &lt;!--è¿‡æ»¤è¯·æ±‚ï¼šé»˜è®¤å€¼ã€‚--&gt; &lt;dispatcher&gt;REQUEST&lt;/dispatcher&gt; &lt;!--è¿‡æ»¤å…¨å±€é”™è¯¯é¡µé¢ï¼šå¼€å¯åï¼Œå½“ç”±æœåŠ¡å™¨è°ƒç”¨å…¨å±€é”™è¯¯é¡µé¢æ—¶ï¼Œè¿‡æ»¤å™¨å·¥ä½œ--&gt; &lt;dispatcher&gt;ERROR&lt;/dispatcher&gt; &lt;!--è¿‡æ»¤è¯·æ±‚è½¬å‘ï¼šå¼€å¯åï¼Œå½“è¯·æ±‚è½¬å‘æ—¶ï¼Œè¿‡æ»¤å™¨å·¥ä½œã€‚--&gt; &lt;dispatcher&gt;FORWARD&lt;/dispatcher&gt; &lt;!--è¿‡æ»¤è¯·æ±‚åŒ…å«ï¼šå½“è¯·æ±‚åŒ…å«æ—¶ï¼Œè¿‡æ»¤å™¨å·¥ä½œã€‚å®ƒåªèƒ½è¿‡æ»¤åŠ¨æ€åŒ…å«ï¼Œjspçš„includeæŒ‡ä»¤æ˜¯é™æ€åŒ…å«--&gt; &lt;dispatcher&gt;INCLUDE&lt;/dispatcher&gt; &lt;!--è¿‡æ»¤å¼‚æ­¥ç±»å‹ï¼Œå®ƒè¦æ±‚æˆ‘ä»¬åœ¨filteræ ‡ç­¾ä¸­é…ç½®å¼€å¯å¼‚æ­¥æ”¯æŒ--&gt; &lt;dispatcher&gt;ASYNC&lt;/dispatcher&gt;&lt;/filter-mapping&gt; web.xmlï¼š 1234567891011&lt;filter&gt; &lt;filter-name&gt;FilterDemo5&lt;/filter-name&gt; &lt;filter-class&gt;filter.FilterDemo5&lt;/filter-class&gt; &lt;!--é…ç½®å¼€å¯å¼‚æ­¥æ”¯æŒï¼Œå½“dispatcheré…ç½®ASYNCæ—¶ï¼Œéœ€è¦é…ç½®æ­¤è¡Œ--&gt; &lt;async-supported&gt;true&lt;/async-supported&gt;&lt;/filter&gt;&lt;filter-mapping&gt; &lt;filter-name&gt;FilterDemo5&lt;/filter-name&gt; &lt;url-pattern&gt;/error.jsp&lt;/url-pattern&gt; &lt;dispatcher&gt;ERROR&lt;/dispatcher&gt;&lt;filter-mapping&gt; ServletDemo03ï¼š 1234protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; System.out.println(&quot;servletDemo03æ‰§è¡Œäº†...&quot;); int i = 1/ 0; &#125; FilterDemo05ï¼š 12345678public class FilterDemo05 implements Filter&#123; @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException &#123; System.out.println(&quot;filterDemo05æ‰§è¡Œäº†...&quot;); //æ”¾è¡Œ filterChain.doFilter(servletRequest,servletResponse); &#125;&#125; è®¿é—®URLï¼šhttp://localhost:8080/filter/servletDemo03 æ§åˆ¶å°è¾“å‡ºï¼ˆæ³¨æ„è¾“å‡ºé¡ºåºï¼‰ï¼š 12servletDemo03æ‰§è¡Œäº†...filterDemo05æ‰§è¡Œäº†... å¯¹æ¯”Servlet æ–¹æ³•&#x2F;ç±»å‹ Servlet Filter å¤‡æ³¨ åˆå§‹åŒ– æ–¹æ³• void init(ServletConfig); void init(FilterConfig); å‡ ä¹ä¸€æ ·ï¼Œéƒ½æ˜¯åœ¨web.xmlä¸­é…ç½®å‚æ•°ï¼Œç”¨è¯¥å¯¹è±¡çš„æ–¹æ³•å¯ä»¥è·å–åˆ°ã€‚ æä¾›æœåŠ¡æ–¹æ³• void service(request,response); void dofilter(request,response,FilterChain) Filteræ¯”Servletå¤šäº†ä¸€ä¸ªFilterChainï¼Œå®ƒä¸ä»…èƒ½å®ŒæˆServletçš„åŠŸèƒ½ï¼Œè€Œä¸”è¿˜å¯ä»¥å†³å®šç¨‹åºæ˜¯å¦èƒ½ç»§ç»­æ‰§è¡Œã€‚æ‰€ä»¥è¿‡æ»¤å™¨æ¯”Servletæ›´ä¸ºå¼ºå¤§ã€‚ åœ¨Struts2ä¸­ï¼Œæ ¸å¿ƒæ§åˆ¶å™¨å°±æ˜¯ä¸€ä¸ªè¿‡æ»¤å™¨ã€‚ é”€æ¯æ–¹æ³• void destroy(); void destroy(); æ–¹æ³•&#x2F;ç±»å‹ Listenerè§‚å¯Ÿè€…è®¾è®¡è€…æ‰€æœ‰çš„ç›‘å¬å™¨éƒ½æ˜¯åŸºäºè§‚å¯Ÿè€…è®¾è®¡æ¨¡å¼çš„ã€‚ è§‚å¯Ÿè€…æ¨¡å¼é€šå¸¸ç”±ä»¥ä¸‹ä¸‰éƒ¨åˆ†ç»„æˆï¼š äº‹ä»¶æºï¼šè§¦å‘äº‹ä»¶çš„å¯¹è±¡ã€‚ äº‹ä»¶ï¼šè§¦å‘çš„åŠ¨ä½œï¼Œé‡Œé¢å°è£…äº†äº‹ä»¶æºã€‚ ç›‘å¬å™¨ï¼šå½“äº‹ä»¶æºè§¦å‘äº‹ä»¶åï¼Œå¯ä»¥å®Œæˆçš„åŠŸèƒ½ã€‚ä¸€èˆ¬æ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”±ä½¿ç”¨è€…æ¥å®ç°ã€‚ï¼ˆæ­¤å¤„çš„æ€æƒ³è¿˜æ¶‰åŠäº†ä¸€ä¸ªç­–ç•¥æ¨¡å¼ï¼‰ ç›‘å¬å™¨åˆ†ç±»åœ¨ç¨‹åºå½“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ï¼šå¯¹è±¡çš„åˆ›å»ºé”€æ¯ã€åŸŸå¯¹è±¡ä¸­å±æ€§çš„å˜åŒ–ã€ä¼šè¯ç›¸å…³å†…å®¹è¿›è¡Œç›‘å¬ã€‚ Servletè§„èŒƒä¸­å…±è®¡8ä¸ªç›‘å¬å™¨ï¼Œç›‘å¬å™¨éƒ½æ˜¯ä»¥æ¥å£å½¢å¼æä¾›ï¼Œå…·ä½“åŠŸèƒ½éœ€è¦æˆ‘ä»¬è‡ªå·±å®Œæˆ ç›‘å¬å¯¹è±¡ ServletContextListenerï¼šç”¨äºç›‘å¬ServletContextå¯¹è±¡çš„åˆ›å»ºå’Œé”€æ¯ æ–¹æ³• ä½œç”¨ void contextInitialized(ServletContextEvent sce) å¯¹è±¡åˆ›å»ºæ—¶æ‰§è¡Œè¯¥æ–¹æ³• void contextDestroyed(ServletContextEvent sce) å¯¹è±¡é”€æ¯æ—¶æ‰§è¡Œè¯¥æ–¹æ³• å‚æ•°ServletContextEvent ä»£è¡¨äº‹ä»¶å¯¹è±¡ï¼Œäº‹ä»¶å¯¹è±¡ä¸­å°è£…äº†äº‹ä»¶æºServletContextï¼ŒçœŸæ­£çš„äº‹ä»¶æŒ‡çš„æ˜¯åˆ›å»ºæˆ–è€…é”€æ¯ServletContextå¯¹è±¡çš„æ“ä½œ HttpSessionListenerï¼šç”¨äºç›‘å¬HttpSessionå¯¹è±¡çš„åˆ›å»ºå’Œé”€æ¯ æ–¹æ³• ä½œç”¨ void sessionCreated(HttpSessionEvent se) å¯¹è±¡åˆ›å»ºæ—¶æ‰§è¡Œè¯¥æ–¹æ³• void sessionDestroyed(HttpSessionEvent se) å¯¹è±¡é”€æ¯æ—¶æ‰§è¡Œè¯¥æ–¹æ³• å‚æ•°HttpSessionEvent ä»£è¡¨äº‹ä»¶å¯¹è±¡ï¼Œäº‹ä»¶å¯¹è±¡ä¸­å°è£…äº†äº‹ä»¶æºHttpSessionï¼ŒçœŸæ­£çš„äº‹ä»¶æŒ‡çš„æ˜¯åˆ›å»ºæˆ–è€…é”€æ¯HttpSessionå¯¹è±¡çš„æ“ä½œ ServletRequestListenerï¼šç”¨äºç›‘å¬ServletRequestå¯¹è±¡çš„åˆ›å»ºå’Œé”€æ¯ æ–¹æ³• ä½œç”¨ void requestInitialized(ServletRequestEvent sre) å¯¹è±¡åˆ›å»ºæ—¶æ‰§è¡Œè¯¥æ–¹æ³• void requestDestroyed(ServletRequestEvent sre) å¯¹è±¡é”€æ¯æ—¶æ‰§è¡Œè¯¥æ–¹æ³• å‚æ•°ServletRequestEvent ä»£è¡¨äº‹ä»¶å¯¹è±¡ï¼Œäº‹ä»¶å¯¹è±¡ä¸­å°è£…äº†äº‹ä»¶æºServletRequestï¼ŒçœŸæ­£çš„äº‹ä»¶æŒ‡çš„æ˜¯åˆ›å»ºæˆ–è€…é”€æ¯ServletRequestå¯¹è±¡çš„æ“ä½œ ç›‘å¬åŸŸå¯¹è±¡å±æ€§ ServletContextAttributeListenerï¼šç”¨äºç›‘å¬ServletContextåº”ç”¨åŸŸä¸­å±æ€§çš„å˜åŒ– æ–¹æ³• ä½œç”¨ void attributeAdded(ServletContextAttributeEvent event) åŸŸä¸­æ·»åŠ å±æ€§æ—¶æ‰§è¡Œè¯¥æ–¹æ³• void attributeRemoved(ServletContextAttributeEvent event) åŸŸä¸­ç§»é™¤å±æ€§æ—¶æ‰§è¡Œè¯¥æ–¹æ³• void attributeReplaced(ServletContextAttributeEvent event) åŸŸä¸­æ›¿æ¢å±æ€§æ—¶æ‰§è¡Œè¯¥æ–¹æ³• å‚æ•°ServletContextAttributeEvent ä»£è¡¨äº‹ä»¶å¯¹è±¡ï¼Œäº‹ä»¶å¯¹è±¡ä¸­å°è£…äº†äº‹ä»¶æºServletContextï¼ŒçœŸæ­£çš„äº‹ä»¶æŒ‡çš„æ˜¯æ·»åŠ ã€ç§»é™¤ã€æ›¿æ¢åº”ç”¨åŸŸä¸­å±æ€§çš„æ“ä½œ HttpSessionAttributeListenerï¼šç”¨äºç›‘å¬HttpSessionä¼šè¯åŸŸä¸­å±æ€§çš„å˜åŒ– æ–¹æ³• ä½œç”¨ void attributeAdded(HttpSessionBindingEvent event) åŸŸä¸­æ·»åŠ å±æ€§æ—¶æ‰§è¡Œè¯¥æ–¹æ³• void attributeRemoved(HttpSessionBindingEvent event) åŸŸä¸­ç§»é™¤å±æ€§æ—¶æ‰§è¡Œè¯¥æ–¹æ³• void attributeReplaced(HttpSessionBindingEvent event) åŸŸä¸­æ›¿æ¢å±æ€§æ—¶æ‰§è¡Œè¯¥æ–¹æ³• å‚æ•°HttpSessionBindingEvent ä»£è¡¨äº‹ä»¶å¯¹è±¡ï¼Œäº‹ä»¶å¯¹è±¡ä¸­å°è£…äº†äº‹ä»¶æºHttpSessionï¼ŒçœŸæ­£çš„äº‹ä»¶æŒ‡çš„æ˜¯æ·»åŠ ã€ç§»é™¤ã€æ›¿æ¢åº”ç”¨åŸŸä¸­å±æ€§çš„æ“ä½œ ServletRequestAttributeListenerï¼šç”¨äºç›‘å¬ServletRequestè¯·æ±‚åŸŸä¸­å±æ€§çš„å˜åŒ– æ–¹æ³• ä½œç”¨ void attributeAdded(ServletRequestAttributeEvent srae) åŸŸä¸­æ·»åŠ å±æ€§æ—¶æ‰§è¡Œè¯¥æ–¹æ³• void attributeRemoved(ServletRequestAttributeEvent srae) åŸŸä¸­ç§»é™¤å±æ€§æ—¶æ‰§è¡Œè¯¥æ–¹æ³• void attributeReplaced(ServletRequestAttributeEvent srae) åŸŸä¸­æ›¿æ¢å±æ€§æ—¶æ‰§è¡Œè¯¥æ–¹æ³• å‚æ•°ServletRequestAttributeEvent ä»£è¡¨äº‹ä»¶å¯¹è±¡ï¼Œäº‹ä»¶å¯¹è±¡ä¸­å°è£…äº†äº‹ä»¶æºServletRequestï¼ŒçœŸæ­£çš„äº‹ä»¶æŒ‡çš„æ˜¯æ·»åŠ ã€ç§»é™¤ã€æ›¿æ¢åº”ç”¨åŸŸä¸­å±æ€§çš„æ“ä½œ é¡µé¢åŸŸå¯¹è±¡æ²¡æœ‰ç›‘å¬å™¨ æ„ŸçŸ¥å‹ç›‘å¬å™¨ç›‘å¬ä¼šè¯ç›¸å…³çš„æ„ŸçŸ¥å‹ç›‘å¬å™¨ï¼Œå’Œä¼šè¯åŸŸç›¸å…³çš„ä¸¤ä¸ªæ„ŸçŸ¥å‹ç›‘å¬å™¨æ˜¯æ— éœ€é…ç½®ï¼ˆæ³¨è§£ï¼‰çš„ï¼Œå¯ä»¥ç›´æ¥ç¼–å†™ä»£ç  HttpSessionBindingListenerï¼šç”¨äºæ„ŸçŸ¥å¯¹è±¡å’Œä¼šè¯åŸŸç»‘å®šçš„ç›‘å¬å™¨ æ–¹æ³• ä½œç”¨ void valueBound(HttpSessionBindingEvent event) æ•°æ®æ·»åŠ åˆ°ä¼šè¯åŸŸä¸­(ç»‘å®š)æ—¶æ‰§è¡Œè¯¥æ–¹æ³• void valueUnbound(HttpSessionBindingEvent event) æ•°æ®ä»ä¼šè¯åŸŸä¸­ç§»é™¤(è§£ç»‘)æ—¶æ‰§è¡Œè¯¥æ–¹æ³• å‚æ•°HttpSessionBindingEvent ä»£è¡¨äº‹ä»¶å¯¹è±¡ï¼Œäº‹ä»¶å¯¹è±¡ä¸­å°è£…äº†äº‹ä»¶æºHttpSessionï¼ŒçœŸæ­£çš„äº‹ä»¶æŒ‡çš„æ˜¯æ·»åŠ ã€ç§»é™¤ã€æ›¿æ¢åº”ç”¨åŸŸä¸­å±æ€§çš„æ“ä½œ HttpSessionActivationListenerï¼šç”¨äºæ„ŸçŸ¥ä¼šè¯åŸŸä¸­å¯¹è±¡å’Œé’åŒ–å’Œæ´»åŒ–çš„ç›‘å¬å™¨ æ–¹æ³• ä½œç”¨ void sessionWillPassivate(HttpSessionEvent se) ä¼šè¯åŸŸä¸­æ•°æ®é’åŒ–æ—¶æ‰§è¡Œè¯¥æ–¹æ³• void sessionDidActivate(HttpSessionEvent se) ä¼šè¯åŸŸä¸­æ•°æ®æ´»åŒ–æ—¶æ‰§è¡Œè¯¥æ–¹æ³• ç›‘å¬å™¨ä½¿ç”¨ServletContextListenerServletContextå¯¹è±¡çš„åˆ›å»ºå’Œé”€æ¯çš„ç›‘å¬å™¨ æ³¨è§£æ–¹å¼ï¼š 12345678910111213141516@WebListenerpublic class ServletContextListenerDemo implements ServletContextListener &#123; //åˆ›å»ºæ—¶æ‰§è¡Œæ­¤æ–¹æ³• @Override public void contextInitialized(ServletContextEvent sce) &#123; System.out.println(&quot;ç›‘å¬åˆ°å¯¹è±¡çš„åˆ›å»º....&quot;);//å¯åŠ¨æœåŠ¡å™¨å°±åˆ›å»º ServletContext servletContext = sce.getServletContext(); System.out.println(servletContext); &#125; //é”€æ¯æ—¶æ‰§è¡Œçš„æ–¹æ³• @Override public void contextDestroyed(ServletContextEvent sce) &#123; System.out.println(&quot;ç›‘å¬åˆ°å¯¹è±¡çš„é”€æ¯...&quot;);//å…³é—­æœåŠ¡å™¨å°±é”€æ¯ &#125;&#125; é…ç½®web.xml 123456&lt;web-app&gt;&lt;!--é…ç½®ç›‘å¬å™¨--&gt; &lt;listener&gt; &lt;listener-class&gt;listener.ServletContextAttributeListenerDemo&lt;/listener-class&gt; &lt;/listener&gt;&lt;/web-app&gt; ServletContextAttributeListeneråº”ç”¨åŸŸå¯¹è±¡ä¸­çš„å±æ€§å˜åŒ–çš„ç›‘å¬å™¨ 12345678910111213141516171819202122232425262728293031323334353637383940414243public class ServletContextAttributeListenerDemo implements ServletContextAttributeListener&#123; /* å‘åº”ç”¨åŸŸå¯¹è±¡ä¸­æ·»åŠ å±æ€§æ—¶æ‰§è¡Œæ­¤æ–¹æ³• */ @Override public void attributeAdded(ServletContextAttributeEvent scae) &#123; System.out.println(&quot;ç›‘å¬åˆ°äº†å±æ€§çš„æ·»åŠ ...&quot;); //è·å–åº”ç”¨åŸŸå¯¹è±¡ ServletContext servletContext = scae.getServletContext(); //è·å–å±æ€§ Object value = servletContext.getAttribute(&quot;username&quot;); System.out.println(value);//zhangsan &#125; /* å‘åº”ç”¨åŸŸå¯¹è±¡ä¸­æ›¿æ¢å±æ€§æ—¶æ‰§è¡Œæ­¤æ–¹æ³• */ @Override public void attributeReplaced(ServletContextAttributeEvent scae) &#123; System.out.println(&quot;ç›‘å¬åˆ°äº†å±æ€§çš„æ›¿æ¢...&quot;); //è·å–åº”ç”¨åŸŸå¯¹è±¡ ServletContext servletContext = scae.getServletContext(); //è·å–å±æ€§ Object value = servletContext.getAttribute(&quot;username&quot;); System.out.println(value);//lisi &#125; /* å‘åº”ç”¨åŸŸå¯¹è±¡ä¸­ç§»é™¤å±æ€§æ—¶æ‰§è¡Œæ­¤æ–¹æ³• */ @Override public void attributeRemoved(ServletContextAttributeEvent scae) &#123; System.out.println(&quot;ç›‘å¬åˆ°äº†å±æ€§çš„ç§»é™¤...&quot;); //è·å–åº”ç”¨åŸŸå¯¹è±¡ ServletContext servletContext = scae.getServletContext(); //è·å–å±æ€§ Object value = servletContext.getAttribute(&quot;username&quot;); System.out.println(value);//null &#125;&#125; 123456789101112131415161718192021222324public class ServletContextListenerDemo implements ServletContextListener&#123; //ServletContextå¯¹è±¡åˆ›å»ºçš„æ—¶å€™æ‰§è¡Œæ­¤æ–¹æ³• @Override public void contextInitialized(ServletContextEvent sce) &#123; System.out.println(&quot;ç›‘å¬åˆ°äº†å¯¹è±¡çš„åˆ›å»º...&quot;); //è·å–å¯¹è±¡ ServletContext servletContext = sce.getServletContext(); //æ·»åŠ å±æ€§ servletContext.setAttribute(&quot;username&quot;,&quot;zhangsan&quot;); //æ›¿æ¢å±æ€§ servletContext.setAttribute(&quot;username&quot;,&quot;lisi&quot;); //ç§»é™¤å±æ€§ servletContext.removeAttribute(&quot;username&quot;); &#125; //ServletContextå¯¹è±¡é”€æ¯çš„æ—¶å€™æ‰§è¡Œæ­¤æ–¹æ³• @Override public void contextDestroyed(ServletContextEvent sce) &#123; System.out.println(&quot;ç›‘å¬åˆ°äº†å¯¹è±¡çš„é”€æ¯...&quot;); &#125;&#125; æ§åˆ¶å°è¾“å‡ºï¼š 1234567ç›‘å¬åˆ°äº†å¯¹è±¡çš„åˆ›å»º...ç›‘å¬åˆ°äº†å±æ€§çš„æ·»åŠ ...zhangsanç›‘å¬åˆ°äº†å±æ€§çš„æ›¿æ¢lisiç›‘å¬åˆ°å±æ€§çš„ç§»é™¤null JSæ¦‚è¿°JavaScript æ˜¯ä¸€ç§å®¢æˆ·ç«¯è„šæœ¬è¯­è¨€ã€‚è¿è¡Œåœ¨å®¢æˆ·ç«¯æµè§ˆå™¨ä¸­ï¼Œæ¯ä¸€ä¸ªæµè§ˆå™¨éƒ½å…·å¤‡è§£æ JavaScript çš„å¼•æ“ã€‚ è„šæœ¬è¯­è¨€ï¼šä¸éœ€è¦ç¼–è¯‘ï¼Œå°±å¯ä»¥è¢«æµè§ˆå™¨ç›´æ¥è§£ææ‰§è¡Œäº†ã€‚ ä½œç”¨ï¼šå¢å¼ºç”¨æˆ·å’Œ HTML é¡µé¢çš„äº¤äº’è¿‡ç¨‹ï¼Œè®©é¡µé¢äº§ç”ŸåŠ¨æ€æ•ˆæœï¼Œå¢å¼ºç”¨æˆ·çš„ä½“éªŒã€‚ ç»„æˆéƒ¨åˆ†ï¼šECMAScriptã€DOMã€BOM å¼€å‘ç¯å¢ƒæ­å»ºï¼šå®‰è£…Node.jsï¼Œæ˜¯JavaScriptè¿è¡Œç¯å¢ƒ è¯­æ³•å¼•å…¥å¼•å…¥HTMLæ–‡ä»¶ å†…éƒ¨æ–¹å¼ï¼šæ ‡ç­¾ 12345678910111213&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;JSå¿«é€Ÿå…¥é—¨&lt;/title&gt;&lt;/head&gt;&lt;body&gt; &lt;!--htmlè¯­å¥--&gt;&lt;/body&gt;&lt;script&gt; // JSè¯­å¥&lt;/script&gt; &lt;/html&gt; å¤–éƒ¨æ–¹å¼ åˆ›å»ºjsæ–‡ä»¶ï¼šmy.js 1alert(&quot;Hello&quot;);//jsè¯­å¥ åœ¨htmlä¸­å¼•ç”¨å¤–éƒ¨jsæ–‡ä»¶ 12345&lt;body&gt; &lt;!--htmlè¯­å¥--&gt;&lt;/body&gt;&lt;script src=&quot;js/my.js&quot;&gt;&lt;/script&gt;&lt;html&gt; æ³¨é‡Š å•è¡Œæ³¨é‡Š 1// æ³¨é‡Šçš„å†…å®¹ å¤šè¡Œæ³¨é‡Š 123/*æ³¨é‡Šçš„å†…å®¹*/ è¾“å…¥è¾“å‡º è¾“å…¥æ¡†ï¼šprompt(â€œæç¤ºå†…å®¹â€); å¼¹å‡ºè­¦å‘Šæ¡†ï¼šalert(â€œæç¤ºå†…å®¹â€); æ§åˆ¶å°è¾“å‡ºï¼šconsole.log(â€œæ˜¾ç¤ºå†…å®¹â€); é¡µé¢å†…å®¹è¾“å‡ºï¼šdocument.write(â€œæ˜¾ç¤ºå†…å®¹â€); æ³¨ï¼šdocument.write(&quot;&lt;br/&gt;&quot;)æ¢è¡Œï¼Œé€šå¸¸è¾“å‡ºæ•°æ®åè·Ÿbræ ‡ç­¾ å˜é‡å¸¸é‡JavaScript å±äºå¼±ç±»å‹çš„è¯­è¨€ï¼Œå®šä¹‰å˜é‡æ—¶ä¸åŒºåˆ†å…·ä½“çš„æ•°æ®ç±»å‹ å®šä¹‰å±€éƒ¨å˜é‡ï¼šlet å˜é‡å = å€¼; 123let name = &quot;å¼ ä¸‰&quot;;let age = 23;document.write(name + &quot;,&quot; + age +&quot;&lt;br&gt;&quot;); å®šä¹‰å…¨å±€å˜é‡ï¼šå˜é‡å = å€¼; 1234&#123; l2 = &quot;bb&quot;;&#125;document.write(l2 + &quot;&lt;br&gt;&quot;); å®šä¹‰å¸¸é‡ï¼šconst å¸¸é‡å = å€¼;å¸¸é‡ä¸èƒ½è¢«é‡æ–°èµ‹å€¼ 123const PI = 3.1415926;//PI = 3.15; document.write(PI); æ•°æ®ç±»å‹ æ•°æ®ç±»å‹ è¯´æ˜ boolean å¸ƒå°”ç±»å‹ï¼Œtrueæˆ–false null å£°æ˜nullå€¼çš„ç‰¹æ®Šå…³é”®å­— undefined ä»£è¡¨å˜é‡æœªå®šä¹‰ number æ•´æ•°æˆ–æµ®ç‚¹æ•° string å­—ç¬¦ä¸² bigint å¤§æ•´æ•°ï¼Œä¾‹å¦‚ï¼šlet num &#x3D; 10n; typeof ç”¨äºåˆ¤æ–­å˜é‡çš„æ•°æ®ç±»å‹ 12let age = 18; document.write(typeof(age)); // number è¿ç®—ç¬¦ ç®—æœ¯è¿ç®—ç¬¦ ç®—æœ¯è¿ç®—ç¬¦ è¯´æ˜ + åŠ æ³•è¿ç®— - å‡æ³•è¿ç®— * ä¹˜æ³•è¿ç®— &#x2F; é™¤æ³•è¿ç®— % å–ä½™æ•° ++ è‡ªå¢ â€“ è‡ªå‡ èµ‹å€¼è¿ç®—ç¬¦ èµ‹å€¼è¿ç®—ç¬¦ è¯´æ˜ &#x3D; åŠ æ³•è¿ç®— +&#x3D; å‡æ³•è¿ç®— -&#x3D; ä¹˜æ³•è¿ç®— *&#x3D; é™¤æ³•è¿ç®— &#x2F;&#x3D; å–ä½™æ•° %&#x3D; è‡ªå¢ æ¯”è¾ƒè¿ç®—ç¬¦ æ¯”è¾ƒè¿ç®—ç¬¦ è¯´æ˜ &#x3D;&#x3D; åˆ¤æ–­å€¼æ˜¯å¦ç›¸ç­‰ &#x3D;&#x3D;&#x3D; åˆ¤æ–­æ•°æ®ç±»å‹å’Œå€¼æ˜¯å¦ç›¸ç­‰ &gt; å¤§äº &gt;&#x3D; å¤§äºç­‰äº &lt; å°äº &lt;&#x3D; å°äºç­‰äº !&#x3D; ä¸ç­‰äº é€»è¾‘è¿ç®—ç¬¦ é€»è¾‘è¿ç®—ç¬¦ è¯´æ˜ &amp;&amp; é€»è¾‘ä¸ï¼Œå¹¶ä¸”çš„åŠŸèƒ½ || é€»è¾‘æˆ–ï¼Œæˆ–è€…çš„åŠŸèƒ½ ! å–å ä¸‰å…ƒè¿ç®—ç¬¦ ä¸‰å…ƒè¿ç®—ç¬¦æ ¼å¼ï¼š(æ¯”è¾ƒè¡¨è¾¾å¼) ? è¡¨è¾¾å¼1 : è¡¨è¾¾å¼2; æ ¼å¼è¯´æ˜ï¼šå¦‚æœæ¯”è¾ƒè¡¨è¾¾å¼ä¸ºtrueï¼Œåˆ™å–è¡¨è¾¾å¼1å¦‚æœæ¯”è¾ƒè¡¨è¾¾å¼ä¸ºfalseï¼Œåˆ™å–è¡¨è¾¾å¼2 æµç¨‹æ§åˆ¶ ifè¯­å¥ 123456789101112let month = 3;if(month &gt;= 3 &amp;&amp; month &lt;= 5) &#123; document.write(&quot;æ˜¥å­£&quot;);&#125;else if(month &gt;= 6 &amp;&amp; month &lt;= 8) &#123; document.write(&quot;å¤å­£&quot;);&#125;else if(month == 12 || month == 1 || month == 2) &#123; document.write(&quot;å†¬å­£&quot;);&#125;else &#123; document.write(&quot;æœˆä»½æœ‰è¯¯&quot;);&#125;document.write(&quot;&lt;br&gt;&quot;); switchè¯­å¥ 1234567891011switch(sex)&#123; case 1: document.write(&quot;ç”·æ€§&quot;); break; case 2: document.write(&quot;å¥³æ€§&quot;); break; default: document.write(&quot;æ€§åˆ«æœ‰è¯¯&quot;); break;&#125; forå¾ªç¯ 123for(let i = 1; i &lt;= 5; i++) &#123; document.write(i + &quot;&lt;br&gt;&quot;);&#125; whileå¾ªç¯ 12345let n = 6;while(n &lt;= 10) &#123; document.write(n + &quot;&lt;br&gt;&quot;); n++;&#125; æ•°ç»„æ•°ç»„çš„ä½¿ç”¨å’Œ java ä¸­çš„æ•°ç»„åŸºæœ¬ä¸€è‡´ï¼Œåœ¨JavaScript ä¸­çš„æ•°ç»„æ›´åŠ çµæ´»ï¼Œæ•°æ®ç±»å‹å’Œé•¿åº¦éƒ½æ²¡æœ‰é™åˆ¶ å®šä¹‰æ ¼å¼ 1let æ•°ç»„å = [å…ƒç´ 1,å…ƒç´ 2,â€¦]; ç´¢å¼•èŒƒå›´ï¼šä» 0 å¼€å§‹ï¼Œæœ€å¤§åˆ°æ•°ç»„é•¿åº¦-1 æ•°ç»„é•¿åº¦ï¼šæ•°ç»„å.length 12345let arr = [10,20,30]; document.write(arr+&quot;&lt;br&gt;&quot;)// ç›´æ¥è¾“å‡ºï¼š10,20,30for(let i = 0; i &lt; arr.length; i++) &#123; document.write(arr[i] + &quot;&lt;br&gt;&quot;);&#125; æ•°ç»„é«˜çº§è¿ç®—ç¬¦ï¼š... æ•°ç»„èµ‹å€¼ 1let arr2 = [...arr]; åˆå¹¶æ•°ç»„ 12let arr3 = [40,50,60];let arr4 = [...arr2 , ...arr3]; å­—ç¬¦ä¸²è½¬æ•°ç»„ 1let arr5 = [...&quot;JavaScript&quot;]; å‡½æ•°å‡½æ•°ç±»ä¼¼äº java ä¸­çš„æ–¹æ³•ï¼Œå¯ä»¥å°†ä¸€äº›ä»£ç è¿›è¡ŒæŠ½å–ï¼Œè¾¾åˆ°å¤ç”¨çš„æ•ˆæœ å®šä¹‰æ ¼å¼ï¼š 1234function æ–¹æ³•å(å‚æ•°åˆ—è¡¨) &#123; æ–¹æ³•ä½“; return è¿”å›å€¼; &#125; è°ƒç”¨ï¼š 12let å˜é‡ = æ–¹æ³•å();æ–¹æ³•å(); å¯å˜å‚æ•°ï¼š 1234function æ–¹æ³•å(... å‚æ•°å) &#123; æ–¹æ³•ä½“; return è¿”å›å€¼; &#125; åŒ¿åå‡½æ•° 123function(å‚æ•°åˆ—è¡¨) &#123; æ–¹æ³•ä½“; &#125; DOMDOMä»‹ç»DOM(Document Object Model)ï¼šæ–‡æ¡£å¯¹è±¡æ¨¡å‹ã€‚ å°† HTML æ–‡æ¡£çš„å„ä¸ªç»„æˆéƒ¨åˆ†ï¼Œå°è£…ä¸ºå¯¹è±¡ã€‚å€ŸåŠ©è¿™äº›å¯¹è±¡ï¼Œå¯ä»¥å¯¹ HTML æ–‡æ¡£è¿›è¡Œå¢åˆ æ”¹æŸ¥çš„åŠ¨æ€æ“ä½œã€‚ å…ƒç´ è·å–Elementå…ƒç´ çš„è·å–æ“ä½œï¼šdocumentæ¥å£æ–¹æ³• æ–¹æ³• è¯´æ˜ getElementById(idå±æ€§å€¼) æ ¹æ®idå±æ€§å€¼è·å–å…ƒç´ å¯¹è±¡ getElementsByTagName(æ ‡ç­¾åç§°) æ ¹æ®æ ‡ç­¾åç§°è·å–å…ƒç´ å¯¹è±¡ï¼Œè¿”å›æ•°ç»„ getElementsByClassName(classå±æ€§å€¼) æ ¹æ®classå±æ€§å€¼è·å–å…ƒç´ å¯¹è±¡ï¼Œè¿”å›æ•°ç»„ getElementsByName(nameå±æ€§å€¼) æ ¹æ®nameå±æ€§å€¼è·å–å…ƒç´ å¯¹è±¡ï¼Œè¿”å›æ•°ç»„ å­å…ƒç´ å¯¹è±¡.parentElementå±æ€§ è·å–å½“å‰å…ƒç´ çš„çˆ¶å…ƒç´  123456789101112131415&lt;body&gt; &lt;div id=&quot;div1&quot;&gt;div1&lt;/div&gt; &lt;div id=&quot;div2&quot;&gt;div2&lt;/div&gt; &lt;div class=&quot;cls&quot;&gt;div3&lt;/div&gt; &lt;div class=&quot;cls&quot;&gt;div4&lt;/div&gt; &lt;input type=&quot;text&quot; name=&quot;username&quot;/&gt;&lt;/body&gt;&lt;script&gt; let div1 = document.getElementById(&quot;div1&quot;);//æ ¹æ®idå±æ€§å€¼è·å–å…ƒç´ å¯¹è±¡ //alert(div1);//[object HTMLDivElement] let body = div1.parentElement;//è·å–å½“å‰å…ƒç´ çš„çˆ¶å…ƒç´  alert(body);&lt;/script&gt;&lt;/html&gt; å…ƒç´ å¢åˆ æ”¹Elementå…ƒç´ çš„å¢åˆ æ”¹æ“ä½œï¼š æ–¹æ³• è¯´æ˜ createElement(æ ‡ç­¾å) åˆ›å»ºä¸€ä¸ªæ–°çš„æ ‡ç­¾å…ƒç´  appendChild(å­å…ƒç´ ) å°†æŒ‡å®šå­å…ƒç´ æ·»åŠ åˆ°çˆ¶å…ƒç´ ä¸­ removeChild(å­å…ƒç´ ) ç”¨çˆ¶å…ƒç´ åˆ é™¤æŒ‡å®šå­å…ƒç´  replaceChild(æ–°å…ƒç´ , æ—§å…ƒç´ ) ç”¨æ–°å…ƒç´ æ›¿æ¢å­å…ƒç´  createTextNode(æ•°æ®) åˆ›å»ºæ–‡æœ¬å…ƒç´  1234567891011121314151617&lt;body&gt; &lt;select id=&quot;s&quot;&gt; &lt;option&gt;---è¯·é€‰æ‹©---&lt;/option&gt; &lt;option&gt;åŒ—äº¬&lt;/option&gt; &lt;/select&gt;&lt;/body&gt;&lt;script&gt; let option = document.createElement(&quot;option&quot;);//åˆ›å»ºæ–°çš„å…ƒç´  option.innerText = &quot;æ·±åœ³&quot;;//ä¸ºoptionæ·»åŠ æ–‡æœ¬å†…å®¹ let select = document.getElementById(&quot;s&quot;); select.appendChild(option);//å°†å­å…ƒç´ æ·»åŠ åˆ°çˆ¶å…ƒç´ ä¸­ let option2 = document.createElement(&quot;option&quot;); option2.innerText = &quot;æ­å·&quot;; select.replaceChild(option2,option);//ç”¨æ–°å…ƒç´ æ›¿æ¢è€å…ƒç´ &lt;/script&gt; å±æ€§æ“ä½œAttributeå±æ€§çš„æ“ä½œï¼š æ–¹æ³• è¯´æ˜ setAttribute(å±æ€§å, å±æ€§å€¼) è®¾ç½®å±æ€§ getAttribute(å±æ€§å) æ ¹æ®å±æ€§åè·å–å±æ€§å€¼ removeAttribute(å±æ€§å) æ ¹æ®å±æ€§åç§»é™¤æŒ‡å®šçš„å±æ€§ å…ƒç´ å.styleå±æ€§ ä¸ºå…ƒç´ æ·»åŠ æ ·å¼ å…ƒç´ å.classNameå±æ€§ ä¸ºå…ƒç´ æ·»åŠ æŒ‡å®šæ ·å¼ 123.aColor&#123; color: blue;&#125;/*è·å–å†™åœ¨&lt;style&gt;æ ‡ç­¾*/ 123456789101112&lt;body&gt; &lt;a&gt;ç‚¹æˆ‘å‘€&lt;/a&gt;&lt;/body&gt;&lt;script&gt; let a = document.getElementsByTagName(&quot;a&quot;)[0];//å› ä¸ºæ˜¯æ•°ç»„ a.setAttribute(&quot;href&quot;,&quot;https://www.baidu.com&quot;);//æ·»åŠ å±æ€§ let value = a.getAttribute(&quot;href&quot;);//è·å–å±æ€§ //a.style.color = &quot;red&quot;;//æ·»åŠ æ ·å¼ a.className = &quot;aColor&quot;;//æ·»åŠ æŒ‡å®šCSSæ ·å¼&lt;/script&gt; æ–‡æœ¬æ“ä½œ Textæ–‡æœ¬çš„æ“ä½œï¼š å±æ€§å è¯´æ˜ innerText å…ƒç´ çš„æ–‡æœ¬å†…å®¹ï¼Œä¸è§£ææ ‡ç­¾ innerHTML å…ƒç´ çš„æ–‡æœ¬å†…å®¹ï¼Œè§£ææ ‡ç­¾ ç±»ä¼¼äºèµ‹å€¼æ“ä½œï¼ŒåŒæ—¶æ”¯æŒå–ç”¨è¯¥å€¼ 1234567891011&lt;body&gt; &lt;div id=&quot;div&quot;&gt;&lt;/div&gt;&lt;/body&gt;&lt;script&gt; //1. innerText æ·»åŠ æ–‡æœ¬å†…å®¹ï¼Œä¸è§£ææ ‡ç­¾ let div = document.getElementById(&quot;div&quot;); div.innerText = &quot;æˆ‘æ˜¯div&quot;; //2. innerHTML æ·»åŠ æ–‡æœ¬å†…å®¹ï¼Œè§£ææ ‡ç­¾ div.innerHTML = &quot;&lt;b&gt;æˆ‘æ˜¯div&lt;/b&gt;&quot;;&lt;/script&gt; è¾“å…¥æ¡†æ–‡æœ¬ï¼šinputå…ƒç´ .value; äº‹ä»¶äº‹ä»¶ä»‹ç»äº‹ä»¶æŒ‡çš„å°±æ˜¯å½“æŸäº›ç»„ä»¶æ‰§è¡Œäº†æŸäº›æ“ä½œåï¼Œä¼šè§¦å‘æŸäº›ä»£ç çš„æ‰§è¡Œ å¸¸ç”¨çš„äº‹ä»¶ï¼š æ›´å¤šçš„äº‹ä»¶ï¼š äº‹ä»¶æ“ä½œç»‘å®šäº‹ä»¶çš„æ–¹å¼ æ–¹å¼ä¸€ï¼šé€šè¿‡æ ‡ç­¾ä¸­çš„äº‹ä»¶å±æ€§è¿›è¡Œç»‘å®š æ–¹å¼äºŒï¼šé€šè¿‡ DOM å…ƒç´ å±æ€§ç»‘å®š 123456789101112131415161718192021222324252627282930&lt;body&gt; &lt;img id=&quot;img&quot; src=&quot;img/01.png&quot;/&gt; &lt;br&gt; &lt;!-- &lt;button id=&quot;up&quot; onclick=&quot;up()&quot;&gt;ä¸Šä¸€å¼ &lt;/button&gt; &lt;button id=&quot;down&quot; onclick=&quot;down()&quot;&gt;ä¸‹ä¸€å¼ &lt;/button&gt; --&gt; &lt;button id=&quot;up&quot;&gt;ä¸Šä¸€å¼ &lt;/button&gt; &lt;!--å›¾ç‰‡ ä¸Šä¸€å¼  ä¸‹ä¸€å¼  ç±»ä¼¼ç™¾åº¦å›¾åº“--&gt; &lt;button id=&quot;down&quot;&gt;ä¸‹ä¸€å¼ &lt;/button&gt;&lt;/body&gt;&lt;script&gt; //æ˜¾ç¤ºç¬¬ä¸€å¼ å›¾ç‰‡çš„æ–¹æ³• function up()&#123; let img = document.getElementById(&quot;img&quot;); img.setAttribute(&quot;src&quot;,&quot;img/01.png&quot;); &#125; //æ˜¾ç¤ºç¬¬äºŒå¼ å›¾ç‰‡çš„æ–¹æ³• function down()&#123; let img = document.getElementById(&quot;img&quot;); img.setAttribute(&quot;src&quot;,&quot;img/02.png&quot;); &#125; //ä¸ºä¸Šä¸€å¼ æŒ‰é’®ç»‘å®šå•å‡»äº‹ä»¶ let upBtn = document.getElementById(&quot;up&quot;); upBtn.onclick = up; //ä¸ºä¸‹ä¸€å¼ æŒ‰é’®ç»‘å®šå•å‡»äº‹ä»¶ let downBtn = document.getElementById(&quot;down&quot;); downBtn.onclick = down;&lt;/script&gt;&lt;/html&gt; ç»¼åˆæ¡ˆä¾‹æ¡ˆä¾‹ä»‹ç»ï¼š åœ¨å§“åã€å¹´é¾„ã€æ€§åˆ«ä¸‰ä¸ªæ–‡æœ¬æ¡†ä¸­å¡«å†™ä¿¡æ¯åï¼Œæ·»åŠ åˆ°â€œå­¦ç”Ÿä¿¡æ¯è¡¨â€åˆ—è¡¨ï¼ˆè¡¨æ ¼ï¼‰ï¼Œç‚¹å‡»åˆ é™¤åï¼Œåˆ é™¤è¯¥è¡Œæ•°æ®ï¼Œå¹¶ä¸”ä¸éœ€åˆ·æ–° æ·»åŠ åŠŸèƒ½åˆ†æ ä¸ºæ·»åŠ æŒ‰é’®ç»‘å®šå•å‡»äº‹ä»¶ åˆ›å»º tr å…ƒç´  åˆ›å»º 4 ä¸ª td å…ƒç´  å°† td æ·»åŠ åˆ° tr ä¸­ è·å–æ–‡æœ¬æ¡†è¾“å…¥çš„ä¿¡æ¯ åˆ›å»º 3 ä¸ªæ–‡æœ¬å…ƒç´  å°†æ–‡æœ¬å…ƒç´ æ·»åŠ åˆ°å¯¹åº”çš„ td ä¸­ åˆ›å»º a å…ƒç´  å°† a å…ƒç´ æ·»åŠ åˆ°å¯¹åº”çš„ td ä¸­ å°† tr æ·»åŠ åˆ° table ä¸­ åˆ é™¤åŠŸèƒ½åˆ†æ ä¸ºæ¯ä¸ªåˆ é™¤è¶…é“¾æ¥æ·»åŠ å•å‡»äº‹ä»¶å±æ€§ å®šä¹‰åˆ é™¤çš„æ–¹æ³• è·å– table å…ƒç´  è·å– tr å…ƒç´  é€šè¿‡ table åˆ é™¤ tr HTML 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;åŠ¨æ€è¡¨æ ¼&lt;/title&gt; &lt;link rel=&quot;stylesheet&quot; href=&quot;../css/table.css&quot;/&gt;&lt;/head&gt;&lt;body&gt;&lt;div&gt; &lt;input type=&quot;text&quot; id=&quot;name&quot; placeholder=&quot;è¯·è¾“å…¥å§“å&quot; autocomplete=&quot;off&quot;&gt; &lt;input type=&quot;text&quot; id=&quot;age&quot; placeholder=&quot;è¯·è¾“å…¥å¹´é¾„&quot; autocomplete=&quot;off&quot;&gt; &lt;input type=&quot;text&quot; id=&quot;gender&quot; placeholder=&quot;è¯·è¾“å…¥æ€§åˆ«&quot; autocomplete=&quot;off&quot;&gt; &lt;input type=&quot;button&quot; value=&quot;æ·»åŠ &quot; id=&quot;add&quot;&gt;&lt;/div&gt; &lt;table id=&quot;tb&quot;&gt; &lt;caption&gt;å­¦ç”Ÿä¿¡æ¯è¡¨&lt;/caption&gt; &lt;tr&gt; &lt;th&gt;å§“å&lt;/th&gt; &lt;th&gt;å¹´é¾„&lt;/th&gt; &lt;th&gt;æ€§åˆ«&lt;/th&gt; &lt;th&gt;æ“ä½œ&lt;/th&gt; &lt;/tr&gt; &lt;tr&gt; &lt;td&gt;å¼ ä¸‰&lt;/td&gt; &lt;td&gt;23&lt;/td&gt; &lt;td&gt;ç”·&lt;/td&gt; &lt;td&gt;&lt;a href=&quot;JavaScript:void(0);&quot;onclick=&quot;drop(this)&quot;&gt;åˆ é™¤&lt;/a&gt;&lt;/td&gt; &lt;/tr&gt; &lt;/table&gt;&lt;/body&gt;&lt;script&gt; //ä¸€ã€æ·»åŠ åŠŸèƒ½ //1.ä¸ºæ·»åŠ æŒ‰é’®ç»‘å®šå•å‡»äº‹ä»¶ document.getElementById(&quot;add&quot;).onclick = function()&#123; //2.åˆ›å»ºè¡Œå…ƒç´  let tr = document.createElement(&quot;tr&quot;); //3.åˆ›å»º4ä¸ªå•å…ƒæ ¼å…ƒç´  let nameTd = document.createElement(&quot;td&quot;); let ageTd = document.createElement(&quot;td&quot;); let genderTd = document.createElement(&quot;td&quot;); let deleteTd = document.createElement(&quot;td&quot;); //4.å°†tdæ·»åŠ åˆ°trä¸­ tr.appendChild(nameTd); tr.appendChild(ageTd); tr.appendChild(genderTd); tr.appendChild(deleteTd); //5.è·å–è¾“å…¥æ¡†çš„æ–‡æœ¬ä¿¡æ¯ let name = document.getElementById(&quot;name&quot;).value; let age = document.getElementById(&quot;age&quot;).value; let gender = document.getElementById(&quot;gender&quot;).value; //6.æ ¹æ®è·å–åˆ°çš„ä¿¡æ¯åˆ›å»º3ä¸ªæ–‡æœ¬å…ƒç´  let nameText = document.createTextNode(name); let ageText = document.createTextNode(age); let genderText = document.createTextNode(gender); //7.å°†3ä¸ªæ–‡æœ¬å…ƒç´ æ·»åŠ åˆ°tdä¸­ nameTd.appendChild(nameText); ageTd.appendChild(ageText); genderTd.appendChild(genderText); //8.åˆ›å»ºè¶…é“¾æ¥å…ƒç´ å’Œæ˜¾ç¤ºçš„æ–‡æœ¬ä»¥åŠæ·»åŠ hrefå±æ€§ let a = document.createElement(&quot;a&quot;); let aText = document.createTextNode(&quot;åˆ é™¤&quot;); a.setAttribute(&quot;href&quot;,&quot;JavaScript:void(0);&quot;); a.setAttribute(&quot;onclick&quot;,&quot;drop(this)&quot;); a.appendChild(aText); //9.å°†è¶…é“¾æ¥å…ƒç´ æ·»åŠ åˆ°tdä¸­ deleteTd.appendChild(a); //10.è·å–tableå…ƒç´ ï¼Œå°†træ·»åŠ åˆ°tableä¸­ let table = document.getElementById(&quot;tb&quot;); table.appendChild(tr); &#125; //äºŒã€åˆ é™¤çš„åŠŸèƒ½ //1.ä¸ºæ¯ä¸ªåˆ é™¤è¶…é“¾æ¥æ ‡ç­¾æ·»åŠ å•å‡»äº‹ä»¶çš„å±æ€§ //2.å®šä¹‰åˆ é™¤çš„æ–¹æ³• function drop(obj)&#123; //3.è·å–tableå…ƒç´  let table = obj.parentElement.parentElement.parentElement; //4.è·å–trå…ƒç´  let tr = obj.parentElement.parentElement; //5.é€šè¿‡tableåˆ é™¤tr table.removeChild(tr); &#125;&lt;/script&gt;&lt;/html&gt; CSS 12345678910111213table&#123; border: 1px solid; margin: auto; width: 500px;&#125;td,th&#123; text-align: center; border: 1px solid;&#125;div&#123; text-align: center; margin: 50px;&#125; å¯¹è±¡ç±» å®šä¹‰æ ¼å¼ï¼š 123456789class ç±»å&#123; constructor(å˜é‡åˆ—è¡¨)&#123; å˜é‡èµ‹å€¼; &#125; æ–¹æ³•å(å‚æ•°åˆ—è¡¨) &#123; æ–¹æ³•ä½“; return è¿”å›å€¼; &#125;&#125; ä½¿ç”¨æ ¼å¼ 12let å¯¹è±¡å = new ç±»å(å®é™…å˜é‡å€¼);å¯¹è±¡å.æ–¹æ³•å(); å­—é¢é‡ç±» 12345678910111213141516&lt;script&gt; //å®šä¹‰person let person = &#123; name : &quot;å¼ ä¸‰&quot;, age : 23, hobby : [&quot;å¬è¯¾&quot;,&quot;å­¦ä¹ &quot;], eat : function() &#123; document.write(&quot;åƒé¥­...&quot;); &#125; &#125;; //ä½¿ç”¨person document.write(person.name + &quot;,&quot; + person.age + &quot;,&quot; + person.hobby[0]+&quot;&lt;br&gt;&quot;); person.eat();&lt;/script&gt; ç»§æ‰¿ ç»§æ‰¿ï¼šè®©ç±»ä¸ç±»äº§ç”Ÿå­çˆ¶ç±»çš„å…³ç³»ï¼Œå­ç±»å¯ä»¥ä½¿ç”¨çˆ¶ç±»æœ‰æƒé™çš„æˆå‘˜ã€‚ ç»§æ‰¿å…³é”®å­—ï¼šextends é¡¶çº§çˆ¶ç±»ï¼šObject 1234567891011121314151617181920212223242526272829&lt;script&gt; //å®šä¹‰Personç±» class Person&#123; //æ„é€ æ–¹æ³• constructor(name,age)&#123; this.name = name; this.age = age; &#125; //eatæ–¹æ³• eat()&#123; document.write(&quot;åƒé¥­...&quot;); &#125; &#125; //å®šä¹‰Workerç±»ç»§æ‰¿Person class Worker extends Person&#123; constructor(name,age,salary)&#123; super(name,age); this.salary = salary; &#125; show()&#123; document.write(this.name + &quot;,&quot; + this.age + &quot;,&quot; + this.salary + &quot;&lt;br&gt;&quot;); &#125; &#125; //ä½¿ç”¨Worker let w = new Worker(&quot;å¼ ä¸‰&quot;,23,10000); w.show(); w.eat();&lt;/script&gt; å†…ç½®å¯¹è±¡å†…ç½®å¯¹è±¡æ˜¯ JavaScript æä¾›çš„å¸¦æœ‰å±æ€§å’Œæ–¹æ³•çš„ç‰¹æ®Šæ•°æ®ç±»å‹ï¼Œå¸¸è§çš„æœ‰æ™®é€šç±»å‹ã€JSONå’Œæ­£åˆ™è¡¨è¾¾å¼ æ™®é€šç±»å‹æ•°å­— Number æ–¹æ³•å è¯´æ˜ parseFloat(Sring) å°†ä¼ å…¥çš„å­—ç¬¦ä¸²è½¬ä¸ºæµ®ç‚¹æ•° parseInt() å°†ä¼ å…¥çš„å­—ç¬¦ä¸²æ•´æ•°è½¬ä¸ºæ•´æ•° 12345678&lt;script&gt; //1. parseFloat() å°†ä¼ å…¥çš„å­—ç¬¦ä¸²æµ®ç‚¹æ•°è½¬ä¸ºæµ®ç‚¹æ•° document.write(Number.parseFloat(&quot;3.14&quot;) + &quot;&lt;br&gt;&quot;); //2. parseInt() å°†ä¼ å…¥çš„å­—ç¬¦ä¸²æ•´æ•°è½¬ä¸ºæ•´æ•° document.write(Number.parseInt(&quot;100&quot;) + &quot;&lt;br&gt;&quot;); document.write(Number.parseInt(&quot;200abc&quot;) + &quot;&lt;br&gt;&quot;);//ä»æ•°å­—å¼€å§‹è½¬æ¢ï¼Œç›´åˆ°ä¸æ˜¯æ•°å­—&lt;/script&gt; Math æ–¹æ³•å è¯´æ˜ ceil(x) å‘ä¸Šå–æ•´ floor(x) å‘ä¸‹å–æ•´ round(x) å››èˆäº”å…¥ä¸ºæ•´æ•° random() éšæœºæ•°ï¼Œè¿”å›çš„æ˜¯0.0-1.0ä¹‹é—´çš„èŒƒå›´ï¼ˆå«å¤´ä¸å«å°¾ï¼‰ pow(x,y) å¹‚è¿ç®—ï¼Œxçš„yæ¬¡æ–¹ 1document.write(Math.pow(2,3) + &quot;&lt;br&gt;&quot;); // 8 æ—¥æœŸ Dateæ„é€ æ–¹æ³• æ„é€ æ–¹æ³• è¯´æ˜ Date() æ ¹æ®å½“å‰æ—¶é—´åˆ›å»ºå¯¹è±¡ Date(value) æ ¹æ®æŒ‡å®šæ¯«ç§’å€¼åˆ›å»ºå¯¹è±¡ Date(year, month, [day, hours, minutes, seconds, milliseconds]) æ ¹æ®æŒ‡å®šå­—æ®µåˆ›å»ºå¯¹è±¡ Dateæˆå‘˜æ–¹æ³• æˆå‘˜æ–¹æ³• è¯´æ˜ getFullYear() è·å–å¹´ä»½ getMonth() è·å–æœˆä»½ getDate() è·å–å¤©æ•°ï¼Œç›¸å¯¹äºæœˆä»½ getHours() è·å–å°æ—¶ getMinutes() è·å–åˆ†é’Ÿ getSeconds() è·å–ç§’æ•° getTime() è¿”å›æ®1970å¹´1æœˆ1æ—¥è‡³ä»Šçš„æ¯«ç§’æ•° toLocaleString() è¿”å›æœ¬åœ°æ—¥æœŸæ ¼å¼çš„å­—ç¬¦ä¸²2021&#x2F;2&#x2F;3ä¸‹åˆ8:20:20 å­—ç¬¦ä¸²String æ„é€ æ–¹æ³• æ„é€ æ–¹æ³• è¯´æ˜ gengenString(vale) æ ¹æ®æŒ‡å®šå­—ç¬¦ä¸²åˆ›å»ºå¯¹è±¡ let s &#x3D; â€œå­—ç¬¦ä¸²â€ ç›´æ¥èµ‹å€¼ æˆå‘˜æ–¹æ³• æˆå‘˜æ–¹æ³• è¯´æ˜ length è·å–å­—ç¬¦ä¸²é•¿åº¦ charAt(index) è·å–æŒ‡å®šç´¢å¼•å¤„çš„å­—ç¬¦ indexOf(value) è·å–æŒ‡å®šå­—ç¬¦ä¸²å‡ºç°çš„ç´¢å¼•ä½ç½®ï¼Œæ‰¾ä¸åˆ°ä¸º-1 substring(start, end) æ ¹æ®æŒ‡å®šç´¢å¼•èŒƒå›´æˆªå–å­—ç¬¦ä¸²ï¼ˆå«å¤´ä¸å«å°¾ï¼‰ split(value) æ ¹æ®æŒ‡å®šè§„åˆ™åˆ‡å‰²å­—ç¬¦ä¸²ï¼Œè¿”å›æ•°ç»„ replace(old, new) ä½¿ç”¨æ–°å­—ç¬¦æ›¿æ¢è€å­—ç¬¦ä¸² æ•°ç»„é›†åˆ Array æ–¹æ³• è¯´æ˜ push(value) æ·»åŠ å…ƒç´ åˆ°æ•°ç»„çš„æœ«å°¾ pop() åˆ é™¤æ•°ç»„æœ«å°¾çš„å…ƒç´  shift() åˆ é™¤æ•°ç»„æœ€å‰é¢çš„å…ƒç´  includes(value) åˆ¤æ–­æ•°ç»„æ˜¯å¦åŒ…å«ç»™å®šçš„å€¼ reverse() åè½¬æ•°ç»„ä¸­çš„å…ƒç´  sort() å¯¹æ•°ç»„å…ƒç´ è¿›è¡Œå‡åºæ’åº length è¿”å›æ•°ç»„çš„é•¿åº¦ é™åºæ’åºï¼šå…ˆsortï¼Œå†reverse Setï¼šJavaScriptä¸­çš„Seté›†åˆï¼Œå…ƒç´ å”¯ä¸€ï¼Œå­˜å–é¡ºåºä¸€è‡´ æ–¹æ³• è¯´æ˜ Set() åˆ›å»ºSeté›†åˆå¯¹è±¡ add(value) å‘é›†åˆä¸­æ·»åŠ å…ƒç´  size è·å–é›†åˆé•¿åº¦ keys() è·å–è¿­ä»£å™¨å¯¹è±¡ï¼ˆéå†æ–¹æ³•çœ‹å®ä¾‹ï¼‰ delete(value) åˆ é™¤æŒ‡å®šå…ƒç´  12345678910let s = new Set();// add(å…ƒç´ ) æ·»åŠ å…ƒç´ s.add(&quot;a&quot;);s.add(&quot;b&quot;);s.add(&quot;c&quot;);s.add(&quot;c&quot;);// keys() è·å–è¿­ä»£å™¨å¯¹è±¡let st = s.keys();//éå†é›†åˆfor(let i = 0; i &lt; s.size; i++)&#123; document.write(st.next().value + &quot;&lt;br&gt;&quot;);&#125; Mapï¼šJavaScript ä¸­çš„ Map é›†åˆï¼Œkey å”¯ä¸€ï¼Œå­˜å–é¡ºåºä¸€è‡´ æ–¹æ³• è¯´æ˜ Map() åˆ›å»ºMapé›†åˆå¯¹è±¡ set(key, value) å‘é›†åˆæ·»åŠ å…ƒç´  size è·å–é›†åˆé•¿åº¦ get(key) æ ¹æ®keyè·å–value entries() è·å–è¿­ä»£å™¨å¯¹è±¡ delete(key) æ ¹æ®keyåˆ é™¤é”®å€¼å¯¹ JSONJSONå…¥é—¨JSON(JavaScript Object Notation)ï¼šæ˜¯ä¸€ç§è½»é‡çº§çš„æ•°æ®äº¤æ¢æ ¼å¼ã€‚ åŸºäº ECMAScript è§„èŒƒçš„ä¸€ä¸ªå­é›†ï¼Œé‡‡ç”¨å®Œå…¨ç‹¬ç«‹äºç¼–ç¨‹è¯­è¨€çš„æ–‡æœ¬æ ¼å¼æ¥å­˜å‚¨å’Œè¡¨ç¤ºæ•°æ® ç®€æ´å’Œæ¸…æ™°çš„å±‚æ¬¡ç»“æ„ä½¿å¾— JSON æˆä¸ºç†æƒ³çš„æ•°æ®äº¤æ¢è¯­è¨€ï¼Œæ˜“äºäººé˜…è¯»å’Œç¼–å†™ï¼ŒåŒæ—¶ä¹Ÿæ˜“äºè®¡ç®—æœºè§£æå’Œ ç”Ÿæˆï¼Œå¹¶æœ‰æ•ˆçš„æå‡ç½‘ç»œä¼ è¾“æ•ˆç‡ã€‚ åˆ›å»ºæ ¼å¼ï¼šnameæ˜¯å­—ç¬¦ä¸²ç±»å‹ jsonå¸¸ç”¨æ–¹æ³• æ–¹æ³• è¯´æ˜ stringify(å¯¹è±¡) å°†æŒ‡å®šå¯¹è±¡è½¬æ¢ä¸ºjsonæ ¼å¼å­—ç¬¦ä¸² parse(å­—ç¬¦ä¸²) å°†æŒ‡å®šjsonæ ¼å¼å­—ç¬¦ä¸²è§£ææˆå¯¹è±¡ å…¥é—¨æ¡ˆä¾‹ 1234567891011121314 //å®šä¹‰å¤©æ°”å¯¹è±¡let weather = &#123; city : &quot;åŒ—äº¬&quot;, date : &quot;2088-08-08&quot;, wendu : &quot;10Â° ~ 23Â°&quot;,&#125;;//1.å°†å¤©æ°”å¯¹è±¡è½¬æ¢ä¸ºJSONæ ¼å¼çš„å­—ç¬¦ä¸²let str = JSON.stringify(weather);document.write(str + &quot;&lt;br&gt;&quot;);//2.å°†JSONæ ¼å¼å­—ç¬¦ä¸²è§£ææˆJSå¯¹è±¡let weather2 = JSON.parse(str);document.write(&quot;åŸå¸‚ï¼š&quot; + weather2.city + &quot;&lt;br&gt;&quot;); è½¬æ¢å·¥å…·æˆ‘ä»¬é™¤äº†å¯ä»¥åœ¨ JavaScript ä¸­æ¥ä½¿ç”¨ JSON ä»¥å¤–ï¼Œåœ¨ JAVA ä¸­åŒæ ·ä¹Ÿå¯ä»¥ä½¿ç”¨ JSONã€‚ JSON çš„è½¬æ¢å·¥å…·æ˜¯é€šè¿‡ JAVA å°è£…å¥½çš„ä¸€äº› JAR å·¥å…·åŒ…ï¼Œå¯ä»¥å°† JAVA å¯¹è±¡æˆ–é›†åˆè½¬æ¢æˆ JSON æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥å°† JSON æ ¼å¼çš„å­—ç¬¦ä¸²è½¬æˆ JAVA å¯¹è±¡ã€‚ Jacksonï¼šå¼€æºå…è´¹çš„ JSON è½¬æ¢å·¥å…·ï¼ŒSpringMVC è½¬æ¢é»˜è®¤ä½¿ç”¨ Jacksonã€‚ å¸¸ç”¨ç±» ç±»å è¯´æ˜ ObjectMapper æ˜¯Jacksonå·¥å…·åŒ…çš„æ ¸å¿ƒç±»ï¼Œæä¾›æ–¹æ³•æ¥å®ç°JSONå­—ç¬¦ä¸²å’Œå¯¹è±¡ä¹‹é—´çš„è½¬æ¢ TypeReference å¯¹é›†åˆæ³›å‹çš„ååºåˆ—åŒ–ï¼Œä½¿ç”¨TypeReferenceå¯ä»¥æ˜ç¡®çš„æŒ‡å®šååºåˆ—åŒ–çš„å¯¹è±¡ç±»å‹ ObjectMapperå¸¸ç”¨æ–¹æ³• æ–¹æ³• è¯´æ˜ String writeValueAsString(Object obj) å°†Javaå¯¹è±¡è½¬æ¢æˆJSONå­—ç¬¦ä¸² T readValue(String json, Class valueType) å°†JSONå­—ç¬¦ä¸²è½¬æ¢æˆJavaå¯¹è±¡ T readValue(String json, TypeReference valueTypeRef) å°†JSONå­—ç¬¦ä¸²è½¬æ¢æˆJavaå¯¹è±¡ æ–¹æ³•ç»ƒä¹ ï¼š å¯¹è±¡è½¬ JSONï¼ŒJSON è½¬å¯¹è±¡ 123456789public void test01() throws Exception&#123; //Userå¯¹è±¡è½¬json User user = new User(&quot;å¼ ä¸‰&quot;,23); String json = mapper.writeValueAsString(user); System.out.println(&quot;jsonå­—ç¬¦ä¸²ï¼š&quot; + json//jsonå­—ç¬¦ä¸² = &#123;&quot;name&quot;:&quot;å¼ ä¸‰&quot;,&quot;age&quot;:23&#125; //jsonè½¬Userå¯¹è±¡ User user2 = mapper.readValue(json, User.class); System.out.println(&quot;userå¯¹è±¡ï¼š&quot; + user2);//userå¯¹è±¡ = User&#123;name=&#x27;å¼ ä¸‰&#x27;, age=23&#125;&#125; Mapè½¬ JSONï¼ŒJSON è½¬ Map 1234567891011121314public void test02() throws Exception&#123; //map&lt;String,String&gt;è½¬json HashMap&lt;String,String&gt; map = new HashMap&lt;&gt;(); map.put(&quot;å§“å&quot;,&quot;å¼ ä¸‰&quot;); map.put(&quot;æ€§åˆ«&quot;,&quot;ç”·&quot;); String json = mapper.writeValueAsString(map); System.out.println(&quot;jsonå­—ç¬¦ä¸²ï¼š&quot; + json); //jsonè½¬map&lt;String,String&gt; HashMap&lt;String,String&gt; map2 = mapper.readValue(json, HashMap.class); System.out.println(&quot;mapå¯¹è±¡ï¼š&quot; + map2);&#125;//jsonå­—ç¬¦ä¸² = &#123;&quot;å§“å&quot;:&quot;å¼ ä¸‰&quot;,&quot;æ€§åˆ«&quot;:&quot;ç”·&quot;&#125;//mapå¯¹è±¡ = &#123;å§“å=å¼ ä¸‰, æ€§åˆ«=ç”·&#125; Mapè½¬ JSONï¼ŒJSON è½¬ Map 123456789101112131415public void test03() throws Exception&#123; //map&lt;String,User&gt;è½¬json HashMap&lt;String,User&gt; map = new HashMap&lt;&gt;(); map.put(&quot;seaä¸€ç­&quot;,new User(&quot;å¼ ä¸‰&quot;,23)); map.put(&quot;seaäºŒç­&quot;,new User(&quot;æå››&quot;,24)); String json = mapper.writeValueAsString(map); System.out.println(&quot;jsonå­—ç¬¦ä¸²ï¼š&quot; + json); //jsonè½¬map&lt;String,User&gt; HashMap&lt;String,User&gt; map2=mapper.readValue(json, new TypeReference&lt;HashMap&lt;String,User&gt;&gt;()&#123;&#125;); System.out.println(&quot;javaå¯¹è±¡ï¼š&quot; + map2);&#125;//jsonå­—ç¬¦ä¸² = &#123;&quot;seaä¸€ç­&quot;:&#123;&quot;name&quot;:&quot;å¼ ä¸‰&quot;,&quot;age&quot;:23&#125;,&quot;seaäºŒç­&quot;:&#123;....&#125;//mapå¯¹è±¡ = &#123;seaä¸€ç­=User&#123;name=&#x27;å¼ ä¸‰&#x27;, age=23&#125;, seaäºŒç­=User&#123;name=&#x27;æå››&#x27;, age=24&#125;&#125; List 123456789101112131415public void test05() throws Exception&#123; //List&lt;User&gt;è½¬json ArrayList&lt;User&gt; list = new ArrayList&lt;&gt;(); list.add(new User(&quot;å¼ ä¸‰&quot;,23)); list.add(new User(&quot;æå››&quot;,24)); String json = mapper.writeValueAsString(list); System.out.println(&quot;jsonå­—ç¬¦ä¸²ï¼š&quot; + json); //jsonè½¬List&lt;User&gt; ArrayList&lt;User&gt; list2 = mapper.readValue(json, new TypeReference&lt;ArrayList&lt;User&gt;&gt;()&#123;&#125;); System.out.println(&quot;javaå¯¹è±¡ï¼š&quot; + list2);&#125;//jsonå­—ç¬¦ä¸² = [&#123;&quot;name&quot;:&quot;å¼ ä¸‰&quot;,&quot;age&quot;:23&#125;,&#123;&quot;name&quot;:&quot;æå››&quot;,&quot;age&quot;:24&#125;]//listå¯¹è±¡ = [User&#123;name=&#x27;å¼ ä¸‰&#x27;, age=23&#125;, User&#123;name=&#x27;æå››&#x27;, age=24&#125;] æ­£åˆ™æ­£åˆ™è¡¨è¾¾å¼æ­£åˆ™è¡¨è¾¾å¼ï¼šæ˜¯ä¸€ç§å¯¹å­—ç¬¦ä¸²è¿›è¡ŒåŒ¹é…çš„è§„åˆ™ RegExpï¼š æ„é€ æ–¹æ³• æ„é€ æ–¹æ³• è¯´æ˜ RegExp(è§„åˆ™) æ ¹æ®æŒ‡å®šè§„åˆ™åˆ›å»ºå¯¹è±¡ let reg &#x3D; &#x2F;^è§„åˆ™$&#x2F; ç›´æ¥èµ‹å€¼ æˆå‘˜æ–¹æ³• æˆå‘˜æ–¹æ³• è¯´æ˜ test(åŒ¹é…çš„å­—ç¬¦ä¸²) æ ¹æ®æŒ‡å®šè§„åˆ™éªŒè¯å­—ç¬¦ä¸²æ˜¯å¦ç¬¦åˆ éªŒè¯ç”¨æˆ·ä½¿ç”¨ onsubmit è¡¨å•æäº¤äº‹ä»¶ 1234567891011121314151617181920212223242526272829&lt;form class=&quot;login-form&quot; action=&quot;#&quot; id=&quot;registered&quot; method=&quot;get&quot; autocomplete=&quot;off&quot;&gt; &lt;input type=&quot;text&quot; id=&quot;username&quot; name=&quot;username&quot;&gt; &lt;input type=&quot;password&quot; id=&quot;password&quot; name=&quot;password&quot;&gt; &lt;input type=&quot;submit&quot; value=&quot;æ³¨å†Œ&quot;&gt;&lt;/form&gt;&lt;script&gt; //1.ä¸ºè¡¨å•ç»‘å®šæäº¤äº‹ä»¶ åŒ¿åå‡½æ•° document.getElementById(&quot;registered&quot;).onsubmit = function() &#123; //2.è·å–å¡«å†™çš„ç”¨æˆ·åå’Œå¯†ç  let username = document.getElementById(&quot;username&quot;).value; let password = document.getElementById(&quot;password&quot;).value; //3.åˆ¤æ–­ç”¨æˆ·åæ˜¯å¦ç¬¦åˆè§„åˆ™ 4~16ä½çº¯å­—æ¯ let reg1 = /^[a-zA-Z]&#123;4,16&#125;$/; if(!reg1.test(username)) &#123; alert(&quot;ç”¨æˆ·åä¸ç¬¦åˆè§„åˆ™ï¼Œè¯·è¾“å…¥4åˆ°16ä½çš„çº¯å­—æ¯ï¼&quot;); return false; &#125; //4.åˆ¤æ–­å¯†ç æ˜¯å¦ç¬¦åˆè§„åˆ™ 6ä½çº¯æ•°å­— let reg2 = /^[\\d]&#123;6&#125;$/; if(!reg2.test(password)) &#123; alert(&quot;å¯†ç ä¸ç¬¦åˆè§„åˆ™ï¼Œè¯·è¾“å…¥6ä½çº¯æ•°å­—çš„å¯†ç ï¼&quot;); return false; &#125; //5.å¦‚æœæ‰€æœ‰æ¡ä»¶éƒ½æ»¡è¶³ï¼Œåˆ™æäº¤è¡¨å• return true; &#125;&lt;/script&gt; BOMBOMä»‹ç»BOM(Browser Object Model)ï¼šæµè§ˆå™¨å¯¹è±¡æ¨¡å‹ã€‚ å°†æµè§ˆå™¨çš„å„ä¸ªç»„æˆéƒ¨åˆ†å°è£…æˆä¸åŒçš„å¯¹è±¡ï¼Œæ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œæ“ä½œã€‚ WindowWindowsçª—å£å¯¹è±¡ï¼š å®šæ—¶å™¨ å”¯ä¸€æ ‡è¯† setTimeout(åŠŸèƒ½ï¼Œæ¯«ç§’å€¼)ï¼šè®¾ç½®ä¸€æ¬¡æ€§å®šæ—¶å™¨ã€‚ clearTimeout(æ ‡è¯†)ï¼šå–æ¶ˆä¸€æ¬¡æ€§å®šæ—¶å™¨ã€‚ å”¯ä¸€æ ‡è¯† setInterval(åŠŸèƒ½ï¼Œæ¯«ç§’å€¼)ï¼šè®¾ç½®å¾ªç¯å®šæ—¶å™¨ã€‚ clearInterval(æ ‡è¯†)ï¼šå–æ¶ˆå¾ªç¯å®šæ—¶å™¨ã€‚ åŠ è½½äº‹ä»¶ window.onloadï¼šåœ¨é¡µé¢åŠ è½½å®Œæ¯•åè§¦å‘æ­¤äº‹ä»¶çš„åŠŸèƒ½ 1234567891011121314151617181920&lt;script&gt; //ä¸€ã€å®šæ—¶å™¨ function fun()&#123; alert(&quot;è¯¥èµ·åºŠäº†ï¼&quot;); &#125; //è®¾ç½®ä¸€æ¬¡æ€§å®šæ—¶å™¨ let d1 = setTimeout(&quot;fun()&quot;,3000); //å–æ¶ˆä¸€æ¬¡æ€§å®šæ—¶å™¨ clearTimeout(d1); //è®¾ç½®å¾ªç¯å®šæ—¶å™¨ï¼Œ3ç§’å¼¹å‡ºä¸€æ¬¡ let d2 = setInterval(&quot;fun()&quot;,3000); //å–æ¶ˆå¾ªç¯å®šæ—¶å™¨ clearInterval(d2); //åŠ è½½äº‹ä»¶ let div = document.getElementById(&quot;div&quot;); alert(div);&lt;/script&gt; 12345678910111213141516171819&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt; &lt;title&gt;windowçª—å£å¯¹è±¡&lt;/title&gt; &lt;script&gt; function fun()&#123; alert(&quot;è¯¥èµ·åºŠäº†ï¼&quot;); &#125; //åŠ è½½äº‹ä»¶ window.onload = function()&#123; let div = document.getElementById(&quot;div&quot;); alert(div); &#125; &lt;/script&gt;&lt;/head&gt;&lt;body&gt; &lt;div id=&quot;div&quot;&gt;dddd&lt;/div&gt;&lt;/body&gt;&lt;/html&gt; LocationLocationåœ°å€æ å¯¹è±¡ï¼š href å±æ€§ï¼šæµè§ˆå™¨çš„åœ°å€æ ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸ºè¯¥å±æ€§è®¾ç½®æ–°çš„URLï¼Œä½¿æµè§ˆå™¨è¯»å–å¹¶æ˜¾ç¤ºæ–°URLçš„å†…å®¹ å®ç°æ•ˆæœï¼šç§’æ•°ä¼šè‡ªåŠ¨å˜å°ï¼Œå€’è®¡æ—¶ï¼Œ5ï¼Œ4ï¼Œ3ï¼Œ2ï¼Œ1 123456789101112131415161718192021&lt;body&gt; &lt;p&gt; æ³¨å†ŒæˆåŠŸï¼&lt;span id=&quot;time&quot;&gt;5&lt;/span&gt;ç§’ä¹‹åè‡ªåŠ¨è·³è½¬åˆ°é¦–é¡µ... &lt;/p&gt;&lt;/body&gt;&lt;script&gt; //1.å®šä¹‰æ–¹æ³•ã€‚æ”¹å˜ç§’æ•°ï¼Œè·³è½¬é¡µé¢ let num = 5; function showTime() &#123; num--; if(num &lt;= 0) &#123; //è·³è½¬é¦–é¡µ location.href = &quot;index.html&quot;; &#125; let span = document.getElementById(&quot;time&quot;); span.innerText = num; &#125; //2.è®¾ç½®å¾ªç¯å®šæ—¶å™¨ï¼Œæ¯1ç§’é’Ÿæ‰§è¡ŒshowTimeæ–¹æ³• setInterval(&quot;showTime()&quot;,1000);&lt;/script&gt; å°è£…å°è£…æ€æƒ³ï¼š å°è£…ï¼šå°†å¤æ‚çš„æ“ä½œè¿›è¡Œå°è£…éšè—ï¼Œå¯¹å¤–æä¾›æ›´åŠ ç®€å•çš„æ“ä½œã€‚ è·å–å…ƒç´ çš„æ–¹æ³• document.getElementById(idå€¼)ï¼šæ ¹æ® id å€¼è·å–å…ƒç´  document.getElementsByName(nameå€¼)ï¼šæ ¹æ® name å±æ€§å€¼è·å–å…ƒç´ ä»¬ document.getElementsByTagName(æ ‡ç­¾å)ï¼šæ ¹æ®æ ‡ç­¾åè·å–å…ƒç´ ä»¬ ä»£ç å®ç°ï¼š my.js 1234567891011function getById(id)&#123; return document.getElementById(id);&#125;function getByName(name) &#123; return document.getElementsByName(name);&#125;function getByTag(tag) &#123; return document.getElementsByTagName(tag);&#125; å°è£….html 12345678&lt;body&gt; &lt;div id=&quot;div1&quot;&gt;div1&lt;/div&gt;&lt;/body&gt;&lt;script src=&quot;my.js&quot;&gt;&lt;/script&gt; &lt;!--å¼•å…¥jsæ–‡ä»¶--&gt;&lt;script&gt; let div1 = getById(&quot;div1&quot;); alert(div1);&lt;/script&gt; JQueryç®€ä»‹jQuery æ˜¯ä¸€ä¸ª JavaScript åº“ æ‰€è°“çš„åº“ï¼Œå°±æ˜¯ä¸€ä¸ª JS æ–‡ä»¶ï¼Œé‡Œé¢å°è£…äº†å¾ˆå¤šé¢„å®šä¹‰çš„å‡½æ•°ï¼Œæ¯”å¦‚è·å–å…ƒç´ ï¼Œæ‰§è¡Œéšè—ã€ç§»åŠ¨ç­‰ï¼Œç›®çš„å°±æ˜¯åœ¨ä½¿ç”¨æ—¶ç›´æ¥è°ƒç”¨ï¼Œä¸éœ€è¦å†é‡å¤å®šä¹‰ï¼Œè¿™æ ·å°±å¯ä»¥æå¤§åœ°ç®€åŒ–äº† JavaScript ç¼–ç¨‹ã€‚ jQuery å®˜ç½‘ï¼šhttps://www.jquery.com å¼•å…¥jQæ–‡ä»¶ 12345&lt;!--å¼•å…¥ jQuery æ–‡ä»¶--&gt;&lt;script src=&quot;js/jquery-3.3.1.min.js&quot;&gt;&lt;/script&gt;&lt;script&gt; //jQè¯­å¥&lt;/script&gt; jQuery çš„æ ¸å¿ƒè¯­æ³• $() è¯­æ³•å¯¹è±¡è½¬æ¢jQuery æœ¬è´¨ä¸Šè™½ç„¶ä¹Ÿæ˜¯ JSï¼Œä½†äºŒè€…çš„ API æ–¹æ³•ä¸èƒ½æ··åˆä½¿ç”¨ï¼Œè‹¥æƒ³ä½¿ç”¨å¯¹æ–¹çš„ APIï¼Œéœ€è¦è¿›è¡Œå¯¹è±¡çš„è½¬æ¢ JS çš„ DOM å¯¹è±¡è½¬æ¢æˆ jQuery å¯¹è±¡ï¼š$(JSçš„DOMå¯¹è±¡); 1234// JSæ–¹å¼ï¼Œé€šè¿‡idå±æ€§å€¼è·å–divå…ƒç´ let jsDiv = document.getElementById(&quot;div&quot;);// å°† JS å¯¹è±¡è½¬æ¢ä¸ºjQueryå¯¹è±¡let jq = $(jsDiv); jQuery å¯¹è±¡è½¬æ¢æˆ JS å¯¹è±¡ jQueryå¯¹è±¡[ç´¢å¼•]; jQueryå¯¹è±¡.get(ç´¢å¼•); 1234//jQueryæ–¹å¼ï¼Œé€šè¿‡idå±æ€§å€¼è·å–divå…ƒç´ let jqDiv = $(&quot;#div&quot;);//å°† jQueryå¯¹è±¡è½¬æ¢ä¸ºJSå¯¹è±¡let js = jqDiv[0]; äº‹ä»¶æ“ä½œç»‘å®šè§£ç»‘åœ¨ jQuery ä¸­å°†äº‹ä»¶å°è£…æˆäº†å¯¹åº”çš„æ–¹æ³•ã€‚å»æ‰äº† JS ä¸­çš„ .on è¯­æ³• ç»‘å®šäº‹ä»¶ï¼šjQueryå¯¹è±¡.on(äº‹ä»¶åç§°,æ‰§è¡Œçš„åŠŸèƒ½); 1234//ç»™btn1æŒ‰é’®ç»‘å®šå•å‡»äº‹ä»¶$(&quot;#btn1&quot;).on(&quot;click&quot;,function()&#123; alert(&quot;ç‚¹æˆ‘å¹²å˜›?&quot;);&#125;); è§£ç»‘äº‹ä»¶ï¼šjQueryå¯¹è±¡.off(äº‹ä»¶åç§°);å¦‚æœä¸æŒ‡å®šäº‹ä»¶åç§°ï¼Œåˆ™ä¼šæŠŠè¯¥å¯¹è±¡ç»‘å®šçš„æ‰€æœ‰äº‹ä»¶éƒ½è§£ç»‘ 1234//é€šè¿‡btn2è§£ç»‘btn1çš„å•å‡»äº‹ä»¶$(&quot;#btn2&quot;).on(&quot;click&quot;,function()&#123; $(&quot;#btn1&quot;).off(&quot;click&quot;);&#125;); äº‹ä»¶åˆ‡æ¢äº‹ä»¶åˆ‡æ¢ï¼šéœ€è¦ç»™åŒä¸€ä¸ªå¯¹è±¡ç»‘å®šå¤šä¸ªäº‹ä»¶ï¼Œè€Œä¸”å¤šä¸ªäº‹ä»¶è¿˜æœ‰å…ˆåé¡ºåºå…³ç³» æ–¹å¼ä¸€ï¼šå•ç‹¬å®šä¹‰ $(å…ƒç´ ).äº‹ä»¶æ–¹æ³•å1(è¦æ‰§è¡Œçš„åŠŸèƒ½); $(å…ƒç´ ).äº‹ä»¶æ–¹æ³•å2(è¦æ‰§è¡Œçš„åŠŸèƒ½); 12345678910//å°†é¼ æ ‡ç§»åˆ°æŸå…ƒç´ ï¼Œæ·»åŠ cssæ ·å¼$(&quot;#div&quot;).mouseover(function()&#123; //èƒŒæ™¯è‰²ï¼šçº¢è‰² //$(&quot;#div&quot;).css(&quot;background&quot;,&quot;red&quot;); $(this).css(&quot;background&quot;,&quot;red&quot;);&#125;);$(&quot;#div&quot;).mouseout(function()&#123; //èƒŒæ™¯è‰²ï¼šè“è‰² $(this).css(&quot;background&quot;,&quot;blue&quot;);&#125;); æ–¹å¼äºŒï¼šé“¾å¼å®šä¹‰ $(å…ƒç´ ).äº‹ä»¶æ–¹æ³•å1(è¦æ‰§è¡Œçš„åŠŸèƒ½) .äº‹ä»¶æ–¹æ³•å2(è¦æ‰§è¡Œçš„åŠŸèƒ½); 12345$(&quot;#div&quot;).mouseover(function()&#123; $(this).css(&quot;background&quot;,&quot;red&quot;);&#125;).mouseout(function()&#123; $(this).css(&quot;background&quot;,&quot;blue&quot;);&#125;); éå†æ“ä½œ æ•°æ®å‡†å¤‡ï¼Œå®ç°æŒ‰é”®åéå†æ— åºåˆ—è¡¨ 12345678&lt;body&gt; &lt;input type=&quot;button&quot; id=&quot;btn&quot; value=&quot;éå†åˆ—è¡¨é¡¹&quot;&gt; &lt;ul&gt; &lt;li&gt;ä¼ æ™ºæ’­å®¢&lt;/li&gt; &lt;li&gt;é»‘é©¬ç¨‹åºå‘˜&lt;/li&gt; &lt;li&gt;ä¼ æ™ºä¸“ä¿®å­¦é™¢&lt;/li&gt; &lt;/ul&gt;&lt;/body&gt; forå¾ªç¯ 123for(let i = 0; i &lt; å®¹å™¨å¯¹è±¡é•¿åº¦; i++)&#123; æ‰§è¡ŒåŠŸèƒ½;&#125; å¯¹è±¡.eachæ–¹æ³• 123å®¹å™¨å¯¹è±¡.each(function(index,ele)&#123; æ‰§è¡ŒåŠŸèƒ½;&#125;); 123456$(&quot;#btn&quot;).click(function()&#123; let lis = $(&quot;li&quot;); lis.each(function(index,ele)&#123; alert(index + &quot;:&quot; + ele.innerHTML); &#125;);&#125;); $.each()æ–¹æ³• 123$.each(å®¹å™¨å¯¹è±¡,function(index,ele)&#123; æ‰§è¡ŒåŠŸèƒ½;&#125;); 123456$(&quot;#btn&quot;).click(function()&#123; let lis = $(&quot;li&quot;); $.each(lis,function(index,ele)&#123; alert(index + &quot;:&quot; + ele.innerHTML); &#125;);&#125;); for ofè¯­å¥ 123456$(&quot;#btn&quot;).click(function()&#123; let lis = $(&quot;li&quot;); for(ele of lis)&#123; alert(ele.innerHTML); &#125;&#125;); é€‰æ‹©å™¨åŸºæœ¬é€‰æ‹©å™¨é€‰æ‹©å™¨ï¼šç±»ä¼¼äº CSS çš„é€‰æ‹©å™¨ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬è·å–å…ƒç´ ã€‚ ä¸‹é¢æ‰€æœ‰çš„A Bå‡ä¸ºæ ‡ç­¾å é€‰æ‹©å™¨ è¯­æ³• ä½œç”¨ å…ƒç´ é€‰æ‹©å™¨ $(â€œå…ƒç´ çš„åç§°â€) æ ¹æ®å…ƒç´ åç§°è·å–å…ƒç´ å¯¹è±¡ï¼ˆæ•°ç»„ï¼‰ idé€‰æ‹©å™¨ $(â€œ#idçš„å±æ€§å€¼â€) æ ¹æ®idå±æ€§å€¼è·å–å…ƒç´ å¯¹è±¡ ç±»é€‰æ‹©å™¨ $(â€œ.classçš„å±æ€§å€¼â€) æ ¹æ®classå±æ€§å€¼è·å–å…ƒç´ å¯¹è±¡ï¼ˆæ•°ç»„ï¼‰ å±‚çº§é€‰æ‹©å™¨ é€‰æ‹©å™¨ è¯­æ³• ä½œç”¨ åä»£é€‰æ‹©å™¨ $(â€œA Bâ€) Aä¸‹çš„æ‰€æœ‰Bï¼ŒåŒ…æ‹¬Bçš„å­çº§ å­é€‰æ‹©å™¨ $(â€œA &gt; Bâ€) Aä¸‹çš„æ‰€æœ‰Bï¼Œä¸ åŒ…æ‹¬Bçš„å­çº§ å…„å¼Ÿé€‰æ‹©å™¨ $(â€œA + Bâ€) Aç›¸é‚»çš„ä¸‹ä¸€ä¸ªB å…„å¼Ÿé€‰æ‹©å™¨ $(â€œA ~ Bâ€) Aç›¸é‚»çš„æ‰€æœ‰B å±æ€§é€‰æ‹©å™¨ é€‰æ‹©å™¨ è¯­æ³• ä½œç”¨ å±æ€§åé€‰æ‹©å™¨ $(â€œA[å±æ€§å]â€) æ ¹æ®æŒ‡å®šå±æ€§åè·å–å…ƒç´ å¯¹è±¡ï¼ˆæ•°ç»„ï¼‰ å±æ€§å€¼é€‰æ‹©å™¨ $(â€œA[å±æ€§å&#x3D;å±æ€§å€¼]â€) æ ¹æ®æŒ‡å®šå±æ€§åå’Œå±æ€§å€¼è·å–å…ƒç´ å¯¹è±¡ï¼ˆæ•°ç»„ï¼‰ è¿‡æ»¤å™¨é€‰æ‹©å™¨ é€‰æ‹©å™¨ è¯­æ³• ä½œç”¨ é¦–å…ƒç´ é€‰æ‹©å™¨ $(â€œA:firstâ€) è·å–é€‰æ‹©çš„å…ƒç´ ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´  å°¾å…ƒç´ é€‰æ‹©å™¨ $(â€œA:lastâ€) è·å–é€‰æ‹©çš„å…ƒç´ ä¸­çš„æœ€åä¸€ä¸ªå…ƒç´  éå…ƒç´ é€‰æ‹©å™¨ $(â€œA:not(B)â€) ä¸åŒ…æ‹¬æŒ‡å®šå†…å®¹çš„å…ƒç´  å¶æ•°é€‰æ‹©å™¨ $(â€œA:evenâ€) å¶æ•°ï¼Œä»0å¼€å§‹è®¡æ•° å¥‡æ•°é€‰æ‹©å™¨ $(â€œA:oddâ€) å¥‡æ•°ï¼Œä»0å¼€å§‹è®¡æ•° ç­‰äºç´¢å¼•é€‰æ‹©å™¨ $(â€œA:eq(index)â€) æŒ‡å®šç´¢å¼•çš„å…ƒç´  å¤§äºç´¢å¼•é€‰æ‹©å™¨ $(â€œA:gt(index)â€) å¤§äºæŒ‡å®šç´¢å¼•çš„å…ƒç´  å°äºç´¢å¼•é€‰æ‹©å™¨ $(â€œA:lt(index)â€) å°äºæŒ‡å®šç´¢å¼•çš„å…ƒç´  12345678910111213141516171819202122232425&lt;body&gt; &lt;div&gt;div1&lt;/div&gt; &lt;div id=&quot;div2&quot;&gt;div2&lt;/div&gt; &lt;div&gt;div3&lt;/div&gt; &lt;div&gt;div4&lt;/div&gt;&lt;/body&gt;&lt;script src=&quot;js/jquery-3.3.1.min.js&quot;&gt;&lt;/script&gt;&lt;script&gt; // é¦–å…ƒç´ é€‰æ‹©å™¨ $(&quot;A:first&quot;); let div1 = $(&quot;div:first&quot;); //alert(div1.html()); // éå…ƒç´ é€‰æ‹©å™¨ $(&quot;A:not(B)&quot;); let divs1 = $(&quot;div:not(#div2)&quot;);//æ•°ç»„ // å¶æ•°é€‰æ‹©å™¨ $(&quot;A:even&quot;); let divs2 = $(&quot;div:even&quot;); alert(divs2.length); alert(divs2[0].innerHTML); alert(divs2[1].innerHTML); // ç­‰äºç´¢å¼•é€‰æ‹©å™¨ $(&quot;A:eq(index)&quot;); let div3 = $(&quot;div:eq(2)&quot;); //alert(div3.html());&lt;/script&gt; è¡¨å•å±æ€§é€‰æ‹©å™¨ é€‰æ‹©å™¨ è¯­æ³• ä½œç”¨ å¯ç”¨é€‰æ‹©å™¨ $(â€œA:enabledâ€) è·å¾—å¯ç”¨å…ƒç´  ä¸å¯ç”¨å…ƒç´ é€‰æ‹©å™¨ $(â€œA:disabledâ€) è·å¾—ä¸å¯ç”¨å…ƒç´  å•é€‰&#x2F;å¤é€‰æ¡†è¢«é€‰ä¸­çš„å…ƒç´  $(â€œA:checkedâ€) è·å–å•é€‰&#x2F;å¤é€‰æ¡†è¢«é€‰ä¸­çš„å…ƒç´  ä¸‹æ‹‰æ¡†è¢«é€‰ä¸­çš„å…ƒç´  $(â€œA:selectedâ€) è·å–ä¸‹æ‹‰æ¡†è¢«é€‰ä¸­çš„å…ƒç´  12345678910111213141516171819202122232425262728293031&lt;body&gt; &lt;input type=&quot;text&quot; disabled&gt; &lt;input type=&quot;text&quot; &gt; &lt;input type=&quot;radio&quot; name=&quot;gender&quot; value=&quot;men&quot; checked&gt;ç”· &lt;input type=&quot;radio&quot; name=&quot;gender&quot; value=&quot;women&quot;&gt;å¥³ &lt;input type=&quot;checkbox&quot; name=&quot;hobby&quot; value=&quot;study&quot; checked&gt;å­¦ä¹  &lt;input type=&quot;checkbox&quot; name=&quot;hobby&quot; value=&quot;sleep&quot; checked&gt;ç¡è§‰ &lt;select&gt; &lt;option&gt;---è¯·é€‰æ‹©---&lt;/option&gt; &lt;option selected&gt;æœ¬ç§‘&lt;/option&gt; &lt;option&gt;ä¸“ç§‘&lt;/option&gt; &lt;/select&gt;&lt;/body&gt;&lt;script src=&quot;js/jquery-3.3.1.min.js&quot;&gt;&lt;/script&gt;&lt;script&gt; // 1.å¯ç”¨å…ƒç´ é€‰æ‹©å™¨ $(&quot;A:enabled&quot;); let ins1 = $(&quot;input:enabled&quot;); // 2.ä¸å¯ç”¨å…ƒç´ é€‰æ‹©å™¨ $(&quot;A:disabled&quot;); let ins2 = $(&quot;input:disabled&quot;); // 3.å•é€‰/å¤é€‰æ¡†è¢«é€‰ä¸­çš„å…ƒç´  $(&quot;A:checked&quot;); let ins3 = $(&quot;input:checked&quot;); alert(ins3.length); alert(ins3[0].name); alert(ins3[1].value); // 4.ä¸‹æ‹‰æ¡†è¢«é€‰ä¸­çš„å…ƒç´  $(&quot;A:selected&quot;); let select = $(&quot;select option:selected&quot;); alert(select.html()); &lt;/script&gt; DOMæ–‡æœ¬æ“ä½œ æ–¹æ³• ä½œç”¨ html() è·å–æ ‡ç­¾çš„æ–‡æœ¬ html(value) è®¾ç½®æ ‡ç­¾çš„æ–‡æœ¬å†…å®¹ï¼Œè§£ææ ‡ç­¾ 1234//è·å–divæ ‡ç­¾çš„æ–‡æœ¬å†…å®¹let value = $(&quot;#div&quot;).html();//è®¾ç½®divæ ‡ç­¾çš„æ–‡æœ¬å†…å®¹$(&quot;#div&quot;).html(&quot;&lt;b&gt;æˆ‘æ˜¯div&lt;/b&gt;&quot;); å¯¹è±¡æ“ä½œ æ–¹æ³• ä½œç”¨ $(â€œå…ƒç´ â€) åˆ›å»ºæŒ‡å®šå…ƒç´  append(element) æ·»åŠ æˆæœ€åä¸€ä¸ªå­å…ƒç´ ï¼Œç”±æ·»åŠ è€…å¯¹è±¡è°ƒç”¨ appendTo(element) æ·»åŠ æˆæœ€åä¸€ä¸ªå­å…ƒç´ ï¼Œç”±è¢«æ·»åŠ è€…å¯¹è±¡è°ƒç”¨ prepend(element) æ·»åŠ æˆç¬¬ä¸€ä¸ªå­å…ƒç´ ï¼Œç”±æ·»åŠ è€…å¯¹è±¡è°ƒç”¨ prependTo(element) æ·»åŠ æˆç¬¬ä¸€ä¸ªå­å…ƒç´ ï¼Œç”±è¢«æ·»åŠ è€…å¯¹è±¡è°ƒç”¨ before(element) æ·»åŠ åˆ°å½“å‰å…ƒç´ çš„å‰é¢ï¼Œä¸¤è€…ä¹‹é—´æ˜¯å…„å¼Ÿå…³ç³»ï¼Œç”±æ·»åŠ è€…å¯¹è±¡è°ƒç”¨ after(element) æ·»åŠ åˆ°å½“å‰å…ƒç´ çš„åé¢ï¼Œä¸¤è€…ä¹‹é—´æ˜¯å…„å¼Ÿå…³ç³»ï¼Œç”±æ·»åŠ è€…å¯¹è±¡è°ƒç”¨ remove() åˆ é™¤æŒ‡å®šå…ƒç´ ï¼ˆè‡ªå·±ç§»é™¤è‡ªå·±ï¼‰ empty() æ¸…ç©ºæŒ‡å®šå…ƒç´ çš„æ‰€æœ‰å­å…ƒç´ ï¼ˆè‡ªå·±è¿˜åœ¨ï¼‰ åŒ—äº¬ ä¸Šæµ· åŠ æ²¹ 1234567891011121314151617// æŒ‰é’®ä¸€ï¼šæ·»åŠ ä¸€ä¸ªspanåˆ°div$(&quot;#btn1&quot;).click(function()&#123; let span = $(&quot;&lt;span&gt;span&lt;/span&gt;&quot;); $(&quot;#div&quot;).append(span);&#125;);//æŒ‰é’®äºŒï¼šå°†åŠ æ²¹æ·»åŠ åˆ°åŸå¸‚åˆ—è¡¨æœ€ä¸‹æ–¹$(&quot;#btn2&quot;).click(function()&#123; $(&quot;#city&quot;).append($(&quot;#jy&quot;));&#125;);//æŒ‰é’®ä¸‰ï¼šå°†åŠ æ²¹æ·»åŠ åˆ°åŸå¸‚åˆ—è¡¨æœ€ä¸Šæ–¹$(&quot;#btn3&quot;).click(function()&#123; $(&quot;#jy&quot;).prependTo($(&quot;#city&quot;));&#125;);//æŒ‰é’®å››ï¼šå°†åŠ æ²¹æ·»åŠ åˆ°åŒ—äº¬ä¸‹æ–¹$(&quot;#btn4&quot;).click(function()&#123; $(&quot;#bj&quot;).after($(&quot;#jy&quot;));&#125;); æ ·å¼æ“ä½œ æ–¹æ³• ä½œç”¨ css(name) æ ¹æ®æ ·å¼åç§°è·å–cssæ ·å¼ css(name,value) è®¾ç½®cssæ ·å¼ addClass(value) ç»™æŒ‡å®šçš„å¯¹è±¡æ·»åŠ æ ·å¼ç±»å removeClass(value) ç»™æŒ‡å®šçš„å¯¹è±¡åˆ é™¤æ ·å¼ç±»å toggleClass(value) æ²¡æœ‰æ ·å¼ç±»åå°±æ·»åŠ ï¼Œæœ‰å°±åˆ é™¤ï¼Œå¾ªç¯å¦‚æ­¤ 123.cls&#123; background: pink;&#125; 1&lt;div style=&quot;border: 1px solid red;&quot; id=&quot;div&quot;&gt;æˆ‘æ˜¯div&lt;/div&gt; 12345678910111213141516171819// 1.css(name) è·å–cssæ ·å¼$(&quot;#btn1&quot;).click(function()&#123; alert($(&quot;#div&quot;).css(&quot;border&quot;)); //1px solid rgb(255, 0, 0)&#125;);// 2.css(name,value) è®¾ç½®CSSæ ·å¼$(&quot;#btn2&quot;).click(function()&#123; $(&quot;#div&quot;).css(&quot;background&quot;,&quot;blue&quot;);&#125;);// 3.addClass(value) ç»™æŒ‡å®šçš„å¯¹è±¡æ·»åŠ æ ·å¼ç±»å$(&quot;#btn3&quot;).click(function()&#123; $(&quot;#div&quot;).addClass(&quot;cls&quot;); //clsæ˜¯ä¸€ä¸ªcssæ ·å¼&#125;);// 4.toggleClass(value) å¦‚æœæ²¡æœ‰æ ·å¼ç±»åï¼Œåˆ™æ·»åŠ ã€‚å¦‚æœæœ‰ï¼Œåˆ™åˆ é™¤$(&quot;#btn5&quot;).click(function()&#123; $(&quot;#div&quot;).toggleClass(&quot;cls&quot;);&#125;); å±æ€§æ“ä½œ æ–¹æ³• ä½œç”¨ attr(name,[value]) è·å¾—&#x2F;è®¾ç½®å±æ€§çš„å€¼ prop(name,[value]) è·å¾—&#x2F;è®¾ç½®å±æ€§çš„å€¼ï¼ˆchecked, selectedï¼‰ æ“ä½œå±æ€§ &nbsp;&nbsp; ç”· å¥³ ---è¯·é€‰æ‹©--- æœ¬ç§‘ ä¸“ç§‘ 12345678910111213141516171819202122&lt;script src=&quot;js/jquery-3.3.1.min.js&quot;&gt;&lt;/script&gt;&lt;script&gt; //æŒ‰é’®ä¸€ï¼šè·å–è¾“å…¥æ¡†çš„idå±æ€§ attr(name,[value]) $(&quot;#btn1&quot;).click(function()&#123; alert($(&quot;#username&quot;).attr(&quot;id&quot;)); &#125;); //æŒ‰é’®äºŒï¼šç»™è¾“å…¥æ¡†è®¾ç½®valueå±æ€§ attr(name,[value]) $(&quot;#btn2&quot;).click(function()&#123; $(&quot;#username&quot;).attr(&quot;value&quot;,&quot;hello...&quot;); &#125;); //æŒ‰é’®ä¸‰ï¼šé€‰ä¸­å¥³ prop(name,[value]) $(&quot;#btn3&quot;).click(function()&#123; $(&quot;#gender2&quot;).prop(&quot;checked&quot;,true); &#125;); //æŒ‰é’®å››ï¼šé€‰ä¸­æœ¬ç§‘ prop(name,[value]) $(&quot;#btn4&quot;).click(function()&#123; $(&quot;#bk&quot;).prop(&quot;selected&quot;,true); &#125;);&lt;/script&gt; AJAXæ¦‚è¿° AJAX(Asynchronous JavaScript And XML)ï¼šå¼‚æ­¥çš„ JavaScript å’Œ XMLã€‚ ä¸æ˜¯ä¸€ç§æ–°æŠ€æœ¯ï¼Œè€Œæ˜¯å¤šä¸ªæŠ€æœ¯ç»¼åˆï¼Œç”¨äºå¿«é€Ÿåˆ›å»ºåŠ¨æ€ç½‘é¡µçš„æŠ€æœ¯ã€‚ ä¸€èˆ¬çš„ç½‘é¡µå¦‚æœéœ€è¦æ›´æ–°å†…å®¹ï¼Œå¿…éœ€é‡æ–°åŠ è½½ä¸ªé¡µé¢ã€‚è€Œ AJAX é€šè¿‡æµè§ˆå™¨ä¸æœåŠ¡å™¨è¿›è¡Œå°‘é‡æ•°æ®äº¤æ¢ï¼Œå°±å¯ä»¥ä½¿ç½‘é¡µå®ç°å¼‚æ­¥æ›´æ–°ã€‚ä¹Ÿå°±æ˜¯åœ¨ä¸é‡æ–°åŠ è½½æ•´ä¸ªé¡µ é¢çš„æƒ…å†µä¸‹ï¼Œå¯¹ç½‘é¡µçš„éƒ¨åˆ†å†…å®¹è¿›è¡Œå±€éƒ¨æ›´æ–°ã€‚ å®ç°AJAXJSæ–¹å¼ æ ¸å¿ƒå¯¹è±¡ï¼šXMLHttpRequest ç”¨äºåœ¨åå°ä¸æœåŠ¡å™¨äº¤æ¢æ•°æ®ã€‚å¯ä»¥åœ¨ä¸é‡æ–°åŠ è½½æ•´ä¸ªç½‘é¡µçš„æƒ…å†µä¸‹ï¼Œå¯¹ç½‘é¡µçš„æŸéƒ¨åˆ†è¿›è¡Œæ›´æ–°ã€‚ æ‰“å¼€é“¾æ¥ï¼šopen(method,url,async) methodï¼šè¯·æ±‚çš„ç±»å‹ GET æˆ– POST urlï¼šè¯·æ±‚èµ„æºçš„è·¯å¾„ asyncï¼štrue(å¼‚æ­¥) æˆ– false(åŒæ­¥)ã€‚ å‘é€è¯·æ±‚ï¼šsend(String params) paramsï¼šè¯·æ±‚çš„å‚æ•°(POST ä¸“ç”¨) å¤„ç†å“åº”ï¼šonreadystatechange readyStateï¼š0-è¯·æ±‚æœªåˆå§‹åŒ–ï¼Œ1-æœåŠ¡å™¨è¿æ¥å·²å»ºç«‹ï¼Œ2-è¯·æ±‚å·²æ¥æ”¶ï¼Œ3-è¯·æ±‚å¤„ç†ä¸­ï¼Œ4-è¯·æ±‚å·²å®Œæˆï¼Œä¸”å“åº”å·²å°±ç»ªã€‚ statusï¼š200-å“åº”å·²å…¨éƒ¨ OKã€‚ è·å¾—å“åº”æ•°æ®å½¢å¼ responseTextï¼šè·å¾—å­—ç¬¦ä¸²å½¢å¼çš„å“åº”æ•°æ®ã€‚ responseXMLï¼šè·å¾— XML å½¢å¼çš„å“åº”æ•°æ®ã€‚ é¼ æ ‡ç§»å‡ºè¾“å…¥æ¡†ï¼Œåˆ¤æ–­ç”¨æˆ·åæ˜¯å¦è¢«æ³¨å†Œï¼š Servlet 12345678910111213141516171819202122232425@WebServlet(&quot;/userServlet&quot;)public class UserServlet extends HttpServlet &#123; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; //è®¾ç½®è¯·æ±‚å’Œå“åº”çš„ä¹±ç  req.setCharacterEncoding(&quot;UTF-8&quot;); resp.setContentType(&quot;text/html;charset=UTF-8&quot;); //1.è·å–è¯·æ±‚å‚æ•° String username = req.getParameter(&quot;username&quot;); //æ¨¡æ‹ŸæœåŠ¡å™¨å¤„ç†è¯·æ±‚éœ€è¦1ç§’é’Ÿ Thread.sleep(5000); //2.åˆ¤æ–­å§“åæ˜¯å¦å·²æ³¨å†Œ if (&quot;zhangsan&quot;.equals(username)) &#123; resp.getWriter().write(&quot;&lt;font color=&#x27;red&#x27;&gt;ç”¨æˆ·åå·²æ³¨å†Œ&quot;); &#125; else &#123; resp.getWriter().write(&quot;&lt;font color=&#x27;green&#x27;&gt;ç”¨æˆ·åå¯ç”¨&quot;); &#125; &#125; @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; doGet(req, resp); &#125;&#125; htmlæ–‡ä»¶ ç”¨æˆ·æ³¨å†Œ å§“åï¼š å¯†ç ï¼š 123456789101112131415161718192021222324&lt;script&gt; //1.ä¸ºå§“åç»‘å®šå¤±å»ç„¦ç‚¹äº‹ä»¶ document.getElementById(&quot;username&quot;).onblur = function() &#123; //2.åˆ›å»ºXMLHttpRequestæ ¸å¿ƒå¯¹è±¡ let xmlHttp = new XMLHttpRequest(); //3.æ‰“å¼€é“¾æ¥ let username = document.getElementById(&quot;username&quot;).value; xmlHttp.open(&quot;GET&quot;, &quot;userServlet?username=&quot; + username, true); //4.å‘é€è¯·æ±‚ xmlHttp.send(); //5.å¤„ç†å“åº” xmlHttp.onreadystatechange = function() &#123; //åˆ¤æ–­è¯·æ±‚å’Œå“åº”æ˜¯å¦æˆåŠŸ if(xmlHttp.readyState == 4 &amp;&amp; xmlHttp.status == 200) &#123; //å°†å“åº”çš„æ•°æ®æ˜¾ç¤ºåˆ°spanæ ‡ç­¾ document.getElementById(&quot;uSpan&quot;).innerHTML = xmlHttp.responseText; &#125; &#125; &#125;&lt;/script&gt;&lt;/html&gt; JQæ–¹å¼æ ¸å¿ƒè¯­æ³•ï¼š$.ajax(&#123;name:value,name:value,â€¦&#125;); urlï¼šè¯·æ±‚çš„èµ„æºè·¯å¾„ã€‚ asyncï¼šæ˜¯å¦å¼‚æ­¥è¯·æ±‚ï¼Œtrue-æ˜¯ï¼Œfalse-å¦ (é»˜è®¤æ˜¯ true)ã€‚ dataï¼šå‘é€åˆ°æœåŠ¡å™¨çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯é”®å€¼å¯¹æˆ–è€… js å¯¹è±¡å½¢å¼ã€‚ typeï¼šè¯·æ±‚æ–¹å¼ï¼ŒPOST æˆ– GET (é»˜è®¤æ˜¯ GET)ã€‚ dataTypeï¼šé¢„æœŸçš„è¿”å›æ•°æ®çš„ç±»å‹ï¼Œå–å€¼å¯ä»¥æ˜¯ xml, html, js, json, textç­‰ã€‚ successï¼šè¯·æ±‚æˆåŠŸæ—¶è°ƒç”¨çš„å›è°ƒå‡½æ•°ã€‚ errorï¼šè¯·æ±‚å¤±è´¥æ—¶è°ƒç”¨çš„å›è°ƒå‡½æ•°ã€‚ 1234567891011121314151617181920212223242526272829&lt;script src=&quot;js/jquery-3.3.1.min.js&quot;&gt;&lt;/script&gt;&lt;script&gt; //1.ä¸ºç”¨æˆ·åç»‘å®šå¤±å»ç„¦ç‚¹äº‹ä»¶ $(&quot;#username&quot;).blur(function () &#123; let username = $(&quot;#username&quot;).val(); //2.jQueryçš„é€šç”¨æ–¹å¼å®ç°AJAX $.ajax(&#123; //è¯·æ±‚èµ„æºè·¯å¾„ url:&quot;userServletxxx&quot;, //æ˜¯å¦å¼‚æ­¥ async:true, //è¯·æ±‚å‚æ•° data:&quot;username=&quot;+username, //è¯·æ±‚æ–¹å¼ type:&quot;POST&quot;, //æ•°æ®å½¢å¼ dataType:&quot;text&quot;, //è¯·æ±‚æˆåŠŸåè°ƒç”¨çš„å›è°ƒå‡½æ•° success:function (data) &#123; //å°†å“åº”çš„æ•°æ®æ˜¾ç¤ºåˆ°spanæ ‡ç­¾ $(&quot;#uSpan&quot;).html(data); &#125;, //è¯·æ±‚å¤±è´¥åè°ƒç”¨çš„å›è°ƒå‡½æ•° error:function () &#123; alert(&quot;æ“ä½œå¤±è´¥...&quot;); &#125; &#125;); &#125;);&lt;/script&gt; åˆ†é¡µçŸ¥è¯† VUEæ¦‚è¿°Vueæ˜¯ä¸€å¥—æ„å»ºç”¨æˆ·ç•Œé¢çš„æ¸è¿›å¼å‰ç«¯æ¡†æ¶ã€‚ Vueåªå…³æ³¨è§†å›¾å±‚ï¼Œå¹¶ä¸”éå¸¸å®¹æ˜“å­¦ä¹ ï¼Œè¿˜å¯ä»¥å¾ˆæ–¹ä¾¿çš„ä¸å…¶å®ƒåº“æˆ–å·²æœ‰é¡¹ç›®æ•´åˆã€‚é€šè¿‡å°½å¯èƒ½ç®€å•çš„APIæ¥å®ç°å“åº”æ•°æ®çš„ç»‘å®šå’Œç»„åˆçš„è§†å›¾ç»„ä»¶ã€‚ ç‰¹ç‚¹ï¼š æ˜“ç”¨ï¼šåœ¨æœ‰HTMLCSSJavaScriptçš„åŸºç¡€ä¸Šï¼Œå¿«é€Ÿä¸Šæ‰‹ã€‚ çµæ´»ï¼šç®€å•å°å·§çš„æ ¸å¿ƒï¼Œæ¸è¿›å¼æŠ€æœ¯æ ˆï¼Œè¶³ä»¥åº”ä»˜ä»»ä½•è§„æ¨¡çš„åº”ç”¨ã€‚ æ€§èƒ½ï¼š20kbmin+gzipè¿è¡Œå¤§å°ã€è¶…å¿«è™šæ‹ŸDOMã€æœ€çœå¿ƒçš„ä¼˜åŒ–ã€‚ åŸºæœ¬è¯­æ³• Vue æ ¸å¿ƒå¯¹è±¡ï¼šæ¯ä¸€ä¸ª Vue ç¨‹åºéƒ½æ˜¯ä»ä¸€ä¸ª Vue æ ¸å¿ƒå¯¹è±¡å¼€å§‹çš„ã€‚ 123let vm = new Vue(&#123; é€‰é¡¹åˆ—è¡¨;&#125;); é€‰é¡¹åˆ—è¡¨ elé€‰é¡¹ï¼šç”¨äºæ¥æ”¶è·å–åˆ°é¡µé¢ä¸­çš„å…ƒç´ ï¼ˆæ ¹æ®å¸¸ç”¨é€‰æ‹©å™¨è·å–ï¼‰ dataé€‰é¡¹ï¼šç”¨äºä¿å­˜å½“å‰Vueå¯¹è±¡ä¸­çš„æ•°æ®ï¼Œåœ¨è§†å›¾ä¸­å£°æ˜çš„å˜é‡éœ€è¦åœ¨æ­¤å¤„èµ‹å€¼ methodsé€‰é¡¹ï¼šç”¨äºå®šä¹‰æ–¹æ³•ï¼Œæ–¹æ³•å¯ä»¥ç›´æ¥é€šè¿‡å¯¹è±¡åè°ƒç”¨ï¼Œthisä»£è¡¨å½“å‰Vueå¯¹è±¡ æ•°æ®ç»‘å®šï¼šåœ¨è§†å›¾éƒ¨åˆ†è·å–è„šæœ¬éƒ¨åˆ†çš„æ•°æ® 1&#123;&#123;éå˜é‡å&#125;&#125; 12345678910111213141516171819202122232425262728&lt;body&gt; &lt;!-- è§†å›¾ --&gt; &lt;div id=&quot;div&quot;&gt; &lt;div&gt;å§“åï¼š&#123;&#123;name&#125;&#125;&lt;/div&gt; &lt;div&gt;ç­çº§ï¼š&#123;&#123;classRoom&#125;&#125;&lt;/div&gt; &lt;button onclick=&quot;hi()&quot;&gt;æ‰“æ‹›å‘¼&lt;/button&gt; &lt;/div&gt;&lt;/body&gt;&lt;script src=&quot;js/vue.js&quot;&gt;&lt;/script&gt;&lt;script&gt; // è„šæœ¬ let vm = new Vue(&#123; el:&quot;#div&quot;, data:&#123; name:&quot;å¼ ä¸‰&quot;, classRoom:&quot;seaç¨‹åºå‘˜&quot; &#125;, methods:&#123; study()&#123; alert(this.name + &quot;æ­£åœ¨&quot; + this.classRoom + &quot;å¥½å¥½å­¦ä¹ !&quot;); &#125; &#125; &#125;); //å®šä¹‰æ‰“æ‹›å‘¼æ–¹æ³• æŒ‰ä¸€ä¸‹æŒ‰é’®å°±å¼¹å‡º function hi()&#123; vm.study(); &#125;&lt;/script&gt; å¸¸ç”¨æŒ‡ä»¤æŒ‡ä»¤ä»‹ç»æŒ‡ä»¤ï¼šæ˜¯å¸¦æœ‰ v- å‰ç¼€çš„ç‰¹æ®Šå±æ€§ï¼Œä¸åŒæŒ‡ä»¤å…·æœ‰ä¸åŒå«ä¹‰ ä½¿ç”¨æ–¹æ³•ï¼šé€šå¸¸ç¼–å†™åœ¨æ ‡ç­¾çš„å±æ€§ä¸Šï¼Œå€¼å¯ä»¥ä½¿ç”¨ JS çš„è¡¨è¾¾å¼ æ–‡æœ¬æ’å€¼v-htmlï¼šæŠŠæ–‡æœ¬è§£æä¸º HTML ä»£ç  123456789101112131415&lt;body&gt; &lt;div id=&quot;div&quot;&gt; &lt;div&gt;&#123;&#123;msg&#125;&#125;&lt;/div&gt; &lt;!--æ ‡ç­¾ä¸è§£æ--&gt; &lt;div v-html=&quot;msg&quot;&gt;&lt;/div&gt; &lt;!--åŠ ç²—æ˜¾ç¤º--&gt; &lt;/div&gt;&lt;/body&gt;&lt;script src=&quot;js/vue.js&quot;&gt;&lt;/script&gt;&lt;script&gt; new Vue(&#123; el:&quot;#div&quot;, data:&#123; msg:&quot;&lt;b&gt;Hello Vue&lt;/b&gt;&quot; &#125; &#125;);&lt;/script&gt; ç»‘å®šå±æ€§v-bindï¼šä¸º HTML æ ‡ç­¾ç»‘å®šå±æ€§å€¼ 1234567891011121314151617181920212223242526272829&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;ç»‘å®šå±æ€§&lt;/title&gt; &lt;style&gt; .my&#123; border: 1px solid red; &#125; &lt;/style&gt;&lt;/head&gt;&lt;body&gt; &lt;div id=&quot;div&quot;&gt; &lt;a v-bind:href=&quot;url&quot;&gt;ç™¾åº¦ä¸€ä¸‹&lt;/a&gt; &lt;br&gt; &lt;a :href=&quot;url&quot;&gt;ç™¾åº¦ä¸€ä¸‹&lt;/a&gt; &lt;br&gt; &lt;div :class=&quot;cls&quot;&gt;æˆ‘æ˜¯div&lt;/div&gt; &lt;/div&gt;&lt;/body&gt;&lt;script src=&quot;js/vue.js&quot;&gt;&lt;/script&gt;&lt;script&gt; new Vue(&#123; el:&quot;#div&quot;, data:&#123; url:&quot;https://www.baidu.com&quot;, cls:&quot;my&quot; &#125; &#125;);&lt;/script&gt;&lt;/html&gt; æ¡ä»¶æ¸²æŸ“v-ifï¼šæ¡ä»¶æ€§çš„æ¸²æŸ“æŸå…ƒç´ ï¼Œåˆ¤å®šä¸ºçœŸæ—¶æ¸²æŸ“ï¼Œå¦åˆ™ä¸æ¸²æŸ“v-elseï¼šæ¡ä»¶æ€§çš„æ¸²æŸ“v-else-ifï¼šæ¡ä»¶æ€§çš„æ¸²æŸ“ v-showï¼šæ ¹æ®æ¡ä»¶å±•ç¤ºæŸå…ƒç´ ï¼ŒåŒºåˆ«åœ¨äºåˆ‡æ¢çš„æ˜¯displayå±æ€§çš„å€¼ 12345678910111213141516171819&lt;body&gt; &lt;div id=&quot;div&quot;&gt; &lt;!-- åˆ¤æ–­numçš„å€¼ï¼Œå¯¹3å–ä½™ ä½™æ•°ä¸º0æ˜¾ç¤ºdiv1 ä½™æ•°ä¸º1æ˜¾ç¤ºdiv2 ä½™æ•°ä¸º2æ˜¾ç¤ºdiv3 --&gt; &lt;div v-if=&quot;num % 3 == 0&quot;&gt;div1&lt;/div&gt; &lt;div v-else-if=&quot;num % 3 == 1&quot;&gt;div2&lt;/div&gt; &lt;div v-else=&quot;num % 3 == 2&quot;&gt;div3&lt;/div&gt; &lt;div v-show=&quot;flag&quot;&gt;div4&lt;/div&gt; &lt;/div&gt;&lt;/body&gt;&lt;script src=&quot;js/vue.js&quot;&gt;&lt;/script&gt;&lt;script&gt; new Vue(&#123; el:&quot;#div&quot;, data:&#123; num:1, flag:false &#125; &#125;);&lt;/script&gt; åˆ—è¡¨æ¸²æŸ“v-forï¼šåˆ—è¡¨æ¸²æŸ“ï¼Œéå†å®¹å™¨çš„å…ƒç´ æˆ–è€…å¯¹è±¡çš„å±æ€§ 12345678910111213141516171819202122232425&lt;body&gt; &lt;div id=&quot;div&quot;&gt; &lt;ul&gt; &lt;li v-for=&quot;name in names&quot;&gt; &#123;&#123;name&#125;&#125; &lt;/li&gt; &lt;li v-for=&quot;value in student&quot;&gt; &#123;&#123;value&#125;&#125; &lt;/li&gt; &lt;/ul&gt; &lt;/div&gt;&lt;/body&gt;&lt;script src=&quot;js/vue.js&quot;&gt;&lt;/script&gt;&lt;script&gt; new Vue(&#123; el:&quot;#div&quot;, data:&#123; names:[&quot;å¼ ä¸‰&quot;,&quot;æå››&quot;,&quot;ç‹äº”&quot;], student:&#123; name:&quot;å¼ ä¸‰&quot;, age:23 &#125; &#125; &#125;);&lt;/script&gt; äº‹ä»¶ç»‘å®šv-onï¼šä¸º HTML æ ‡ç­¾ç»‘å®šäº‹ä»¶ï¼Œæœ‰ç®€å†™æ–¹å¼ 123456789101112131415161718192021&lt;body&gt; &lt;div id=&quot;div&quot;&gt; &lt;div&gt;&#123;&#123;name&#125;&#125;&lt;/div&gt; &lt;button v-on:click=&quot;change()&quot;&gt;æ”¹å˜divçš„å†…å®¹&lt;/button&gt; &lt;button @click=&quot;change()&quot;&gt;æ”¹å˜divçš„å†…å®¹&lt;/button&gt; &lt;!--æŠŠseaæ”¹æˆä¼ æ™ºæ’­å®¢--&gt; &lt;/div&gt;&lt;/body&gt;&lt;script src=&quot;js/vue.js&quot;&gt;&lt;/script&gt;&lt;script&gt; new Vue(&#123; el:&quot;#div&quot;, data:&#123; name:&quot;seaç¨‹åºå‘˜&quot; &#125;, methods:&#123; change()&#123; this.name = &quot;ä¼ æ™ºæ’­å®¢&quot; &#125; &#125; &#125;);&lt;/script&gt; è¡¨å•ç»‘å®š è¡¨å•ç»‘å®šv-modelï¼šåœ¨è¡¨å•å…ƒç´ ä¸Šåˆ›å»ºåŒå‘æ•°æ®ç»‘å®š åŒå‘æ•°æ®ç»‘å®šæ›´æ–°dataæ•°æ®ï¼Œé¡µé¢ä¸­çš„æ•°æ®ä¹Ÿä¼šæ›´æ–°ï¼›æ›´æ–°é¡µé¢æ•°æ®ï¼Œdataæ•°æ®ä¹Ÿä¼šæ›´æ–° MVVMæ¨¡å‹(ModelViewViewModel)ï¼šæ˜¯MVCæ¨¡å¼çš„æ”¹è¿›ç‰ˆåœ¨å‰ç«¯é¡µé¢ä¸­ï¼ŒJSå¯¹è±¡è¡¨ç¤ºModelï¼Œé¡µé¢è¡¨ç¤ºViewï¼Œä¸¤è€…åšåˆ°äº†æœ€å¤§é™åº¦çš„åˆ†ç¦»ã€‚å°†Modelå’ŒViewå…³è”èµ·æ¥çš„å°±æ˜¯ViewModelï¼Œå®ƒæ˜¯æ¡¥æ¢ã€‚ViewModelè´Ÿè´£æŠŠModelçš„æ•°æ®åŒæ­¥åˆ°Viewæ˜¾ç¤ºå‡ºæ¥ï¼Œè¿˜è´Ÿè´£æŠŠViewä¿®æ”¹çš„æ•°æ®åŒæ­¥å›Modelã€‚ 123456789101112131415161718&lt;body&gt; &lt;div id=&quot;div&quot;&gt; &lt;form autocomplete=&quot;off&quot;&gt; å§“åï¼š&lt;input type=&quot;text&quot; name=&quot;username&quot; v-model=&quot;username&quot;&gt; &lt;br&gt; å¹´é¾„ï¼š&lt;input type=&quot;number&quot; name=&quot;age&quot; v-model=&quot;age&quot;&gt; &lt;/form&gt; &lt;/div&gt;&lt;/body&gt;&lt;script src=&quot;js/vue.js&quot;&gt;&lt;/script&gt;&lt;script&gt; new Vue(&#123; el:&quot;#div&quot;, data:&#123; username:&quot;å¼ ä¸‰&quot;, //è¾“å…¥æ¡†å†…å®¹ä»ç½‘é¡µæ›´æ”¹åï¼Œæ›´æ–°ä¸ºä¿®æ”¹åçš„å€¼ age:23 &#125; &#125;);&lt;/script&gt; ElementElementï¼šç½‘ç«™å¿«é€Ÿæˆå‹å·¥å…·ï¼Œæ˜¯é¥¿äº†ä¹ˆå…¬å¸å‰ç«¯å¼€å‘å›¢é˜Ÿæä¾›çš„ä¸€å¥—åŸºäºVueçš„ç½‘ç«™ç»„ä»¶åº“ï¼Œä½¿ç”¨Elementå‰æå¿…é¡»è¦æœ‰Vue ç»„ä»¶ï¼šç»„æˆç½‘é¡µçš„éƒ¨ä»¶ï¼Œä¾‹å¦‚è¶…é“¾æ¥ã€æŒ‰é’®ã€å›¾ç‰‡ã€è¡¨æ ¼ç­‰ç­‰ Elementå®˜ç½‘ï¼šhttps://element.eleme.cn/#/zh-CN å¼€å‘æ­¥éª¤ï¼š ä¸‹è½½ Element æ ¸å¿ƒåº“ å¼•å…¥ Element æ ·å¼æ–‡ä»¶ å¼•å…¥ Vue æ ¸å¿ƒ js æ–‡ä»¶ å¼•å…¥ Element æ ¸å¿ƒ js æ–‡ä»¶ ç¼–å†™æŒ‰é’®æ ‡ç­¾ é€šè¿‡ Vue æ ¸å¿ƒå¯¹è±¡åŠ è½½å…ƒç´  ä»£ç å®ç° 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt; &lt;title&gt;å¿«é€Ÿå…¥é—¨&lt;/title&gt; &lt;link rel=&quot;stylesheet&quot; href=&quot;element-ui/lib/theme-chalk/index.css&quot;&gt; &lt;script src=&quot;js/vue.js&quot;&gt;&lt;/script&gt; &lt;script src=&quot;element-ui/lib/index.js&quot;&gt;&lt;/script&gt;&lt;/head&gt;&lt;body&gt; &lt;button&gt;æˆ‘æ˜¯æŒ‰é’®&lt;/button&gt; &lt;br&gt; &lt;div id=&quot;div&quot;&gt; &lt;el-row&gt; &lt;el-button&gt;é»˜è®¤æŒ‰é’®&lt;/el-button&gt; &lt;el-button type=&quot;primary&quot;&gt;ä¸»è¦æŒ‰é’®&lt;/el-button&gt; &lt;el-button type=&quot;success&quot;&gt;æˆåŠŸæŒ‰é’®&lt;/el-button&gt; &lt;el-button type=&quot;info&quot;&gt;ä¿¡æ¯æŒ‰é’®&lt;/el-button&gt; &lt;el-button type=&quot;warning&quot;&gt;è­¦å‘ŠæŒ‰é’®&lt;/el-button&gt; &lt;el-button type=&quot;danger&quot;&gt;å±é™©æŒ‰é’®&lt;/el-button&gt; &lt;/el-row&gt; &lt;br&gt; &lt;el-row&gt; &lt;el-button plain&gt;æœ´ç´ æŒ‰é’®&lt;/el-button&gt; &lt;el-button type=&quot;primary&quot; plain&gt;ä¸»è¦æŒ‰é’®&lt;/el-button&gt; &lt;el-button type=&quot;success&quot; plain&gt;æˆåŠŸæŒ‰é’®&lt;/el-button&gt; &lt;el-button type=&quot;info&quot; plain&gt;ä¿¡æ¯æŒ‰é’®&lt;/el-button&gt; &lt;el-button type=&quot;warning&quot; plain&gt;è­¦å‘ŠæŒ‰é’®&lt;/el-button&gt; &lt;el-button type=&quot;danger&quot; plain&gt;å±é™©æŒ‰é’®&lt;/el-button&gt; &lt;/el-row&gt; &lt;br&gt; &lt;el-row&gt; &lt;el-button round&gt;åœ†è§’æŒ‰é’®&lt;/el-button&gt; &lt;el-button type=&quot;primary&quot; round&gt;ä¸»è¦æŒ‰é’®&lt;/el-button&gt; &lt;el-button type=&quot;success&quot; round&gt;æˆåŠŸæŒ‰é’®&lt;/el-button&gt; &lt;el-button type=&quot;info&quot; round&gt;ä¿¡æ¯æŒ‰é’®&lt;/el-button&gt; &lt;el-button type=&quot;warning&quot; round&gt;è­¦å‘ŠæŒ‰é’®&lt;/el-button&gt; &lt;el-button type=&quot;danger&quot; round&gt;å±é™©æŒ‰é’®&lt;/el-button&gt; &lt;/el-row&gt; &lt;br&gt; &lt;el-row&gt; &lt;el-button icon=&quot;el-icon-search&quot; circle&gt;&lt;/el-button&gt; &lt;el-button type=&quot;primary&quot; icon=&quot;el-icon-edit&quot; circle&gt;&lt;/el-button&gt; &lt;el-button type=&quot;success&quot; icon=&quot;el-icon-check&quot; circle&gt;&lt;/el-button&gt; &lt;el-button type=&quot;info&quot; icon=&quot;el-icon-message&quot; circle&gt;&lt;/el-button&gt; &lt;el-button type=&quot;warning&quot; icon=&quot;el-icon-star-off&quot; circle&gt;&lt;/el-button&gt; &lt;el-button type=&quot;danger&quot; icon=&quot;el-icon-delete&quot; circle&gt;&lt;/el-button&gt; &lt;/el-row&gt; &lt;/div&gt;&lt;/body&gt;&lt;script&gt; new Vue(&#123; el:&quot;#div&quot; &#125;);&lt;/script&gt;&lt;/html&gt; è‡ªå®šä¹‰å¯¹ç»„ä»¶çš„å°è£… å®šä¹‰æ ¼å¼ 12345Vue.component(ç»„ä»¶åç§°, &#123; props:ç»„ä»¶çš„å±æ€§, data: ç»„ä»¶çš„æ•°æ®å‡½æ•°, template: ç»„ä»¶è§£æçš„æ ‡ç­¾æ¨¡æ¿&#125;) ä»£ç å®ç° 1234567891011121314151617181920212223&lt;body&gt; &lt;div id=&quot;div&quot;&gt; &lt;my-button&gt;æˆ‘çš„æŒ‰é’®&lt;/my-button&gt; &lt;/div&gt;&lt;/body&gt;&lt;script&gt; Vue.component(&quot;my-button&quot;,&#123; // å±æ€§ props:[&quot;style&quot;], // æ•°æ®å‡½æ•° data: function()&#123; return&#123; msg:&quot;æˆ‘çš„æŒ‰é’®&quot; &#125; &#125;, //è§£ææ ‡ç­¾æ¨¡æ¿ template:&quot;&lt;button style=&#x27;color:red&#x27;&gt;&#123;&#123;msg&#125;&#125;&lt;/button&gt;&quot; &#125;); new Vue(&#123; el:&quot;#div&quot; &#125;);&lt;/script&gt; æ•ˆæœ æˆ‘çš„æŒ‰é’® ç”Ÿå‘½å‘¨æœŸ ç”Ÿå‘½å‘¨æœŸ ç”Ÿå‘½å‘¨æœŸå…«ä¸ªé˜¶æ®µ å¼‚æ­¥æ“ä½œåœ¨Vueä¸­å‘é€å¼‚æ­¥è¯·æ±‚ï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯AJAXï¼Œä½¿ç”¨axiosè¿™ä¸ªæ’ä»¶æ¥ç®€åŒ–æ“ä½œ ä½¿ç”¨æ­¥éª¤ï¼š1.å¼•å…¥axiosæ ¸å¿ƒjsæ–‡ä»¶2.è°ƒç”¨axioså¯¹è±¡çš„æ–¹æ³•æ¥å‘èµ·å¼‚æ­¥è¯·æ±‚3.è°ƒç”¨axioså¯¹è±¡çš„æ–¹æ³•æ¥å¤„ç†å“åº”çš„æ•°æ® axioså¸¸ç”¨æ–¹æ³•ï¼š æ–¹æ³• ä½œç”¨ get(è¯·æ±‚çš„èµ„æºè·¯å¾„ä¸è¯·æ±‚çš„å‚æ•°) å‘èµ·GETæ–¹å¼è¯·æ±‚ post(è¯·æ±‚çš„èµ„æºè·¯å¾„**,** è¯·æ±‚çš„å‚æ•°) å‘èµ·POSTæ–¹å¼è¯·æ±‚ then(response) è¯·æ±‚æˆåŠŸåçš„å›è°ƒå‡½æ•°ï¼Œé€šè¿‡responseè·å–å“åº”çš„æ•°æ® catch(error) è¯·æ±‚å¤±è´¥åçš„å›è°ƒå‡½æ•°ï¼Œé€šè¿‡errorè·å–é”™è¯¯ä¿¡æ¯ ä»£ç å®ç° Servletç±»ï¼š 1234567891011121314151617181920@WebServlet(&quot;/testServlet&quot;)public class TestServlet extends HttpServlet &#123; @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp)&#123; //è®¾ç½®è¯·æ±‚å“åº”ç¼–ç  req.setCharacterEncoding(&quot;UTF-8&quot;); resp.setContentType(&quot;text/html;charset=UTF-8&quot;); //è·å–è¯·æ±‚å‚æ•° String name = req.getParameter(&quot;name&quot;); System.out.println(name); //å“åº”å®¢æˆ·ç«¯ resp.getWriter().write(&quot;è¯·æ±‚æˆåŠŸ&quot;); &#125; @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp)&#123; doGet(req, resp); &#125;&#125; HTMLæ–‡ä»¶ï¼š 12345678910111213141516171819202122232425262728293031323334&lt;body&gt; &lt;div id=&quot;div&quot;&gt; &#123;&#123;name&#125;&#125; &lt;button @click=&quot;send()&quot;&gt;å‘èµ·è¯·æ±‚&lt;/button&gt; &lt;/div&gt;&lt;/body&gt;&lt;script&gt; new Vue(&#123; el: &quot;#div&quot;, data:&#123; name: &quot;å¼ ä¸‰&quot; &#125;, methods: &#123; send() &#123; //GETæ–¹å¼è¯·æ±‚ /*axios.get(&quot;testServlet?name=&quot; + this.name) .then(resp =&gt; &#123; alert(resp.data); &#125;) .catch(error =&gt; &#123; alert(error); &#125;)*/ //POSTæ–¹å¼è¯·æ±‚ axios.post(&quot;testServlet&quot;, &quot;name=&quot; + this.name) .then(resp =&gt; &#123; alert(resp.data); &#125;) .catch(error =&gt; &#123; alert(error); &#125;); &#125; &#125; &#125;);&lt;/script&gt; Nginxå®‰è£…è½¯ä»¶Nginx æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ HTTP å’Œåå‘ä»£ç† Web æœåŠ¡å™¨ï¼ŒåŒæ—¶ä¹Ÿæä¾›äº† IMAP/POP3/SMTP æœåŠ¡ Nginx ä¸¤ä¸ªæœ€æ ¸å¿ƒçš„åŠŸèƒ½ï¼šé«˜æ€§èƒ½çš„é™æ€ Web æœåŠ¡å™¨ï¼Œåå‘ä»£ç† å®‰è£…æŒ‡ä»¤ï¼šsudo apt-get install nginx æŸ¥çœ‹ç‰ˆæœ¬ï¼šnginx -v ç³»ç»ŸæŒ‡ä»¤ï¼šsystemctl / service start/restart/stop/status nginx é…ç½®æ–‡ä»¶å®‰è£…ç›®å½•ï¼š/etc/nginx æ—¥å¿—æ–‡ä»¶ï¼š/var/log/nginx é…ç½®æ–‡ä»¶nginx.conf æ–‡ä»¶æ—¶ Nginx çš„ä¸»é…ç½®æ–‡ä»¶ main éƒ¨åˆ† events éƒ¨åˆ† server éƒ¨åˆ† root è®¾ç½®çš„è·¯å¾„ä¼šæ‹¼æ¥ä¸Š location çš„è·¯å¾„ï¼Œç„¶åå»æœ€ç»ˆè·¯å¾„å¯»æ‰¾å¯¹åº”çš„æ–‡ä»¶ å‘å¸ƒé¡¹ç›® åˆ›å»ºä¸€ä¸ª toutiao ç›®å½• 12cd /homemkdir toutiao å°†é¡¹ç›®ä¸Šä¼ åˆ° toutiao ç›®å½• è§£å‹é¡¹ç›® unzip web.zip ç¼–è¾‘ Nginx é…ç½®æ–‡ä»¶ nginx.conf 12345678server &#123; listen 80; server_name localhost; location / &#123; root /home/seazean/toutiao; index index.html index.htm; &#125;&#125; é‡å¯ Nginx æœåŠ¡ï¼šsystemctl restart nginx æµè§ˆå™¨æ‰“å¼€ç½‘å€ï¼šhttp://127.0.0.1:80 åå‘ä»£ç† æ— æ³•è®¿é—® Googleï¼Œå¯ä»¥é…ç½®ä¸€ä¸ªä»£ç†æœåŠ¡å™¨ï¼Œå‘é€è¯·æ±‚åˆ°ä»£ç†æœåŠ¡å™¨ï¼Œä»£ç†æœåŠ¡å™¨ç»è¿‡è½¬å‘ï¼Œå†å°†è¯·æ±‚è½¬å‘ç»™ Googleï¼Œè¿”å›ç»“æœä¹‹åï¼Œå†æ¬¡è½¬å‘ç»™ç”¨æˆ·ï¼Œè¿™ä¸ªå«åšæ­£å‘ä»£ç†ï¼Œæ­£å‘ä»£ç†å¯¹äºç”¨æˆ·æ¥è¯´ï¼Œæ˜¯æœ‰æ„ŸçŸ¥çš„ æ­£å‘ä»£ç†ï¼ˆforward proxyï¼‰ï¼šæ˜¯ä¸€ä¸ªä½äºå®¢æˆ·ç«¯å’Œç›®æ ‡æœåŠ¡å™¨ä¹‹é—´çš„ä»£ç†æœåŠ¡å™¨ï¼Œä¸ºäº†ä»ç›®æ ‡æœåŠ¡å™¨å–å¾—å†…å®¹ï¼Œå®¢æˆ·ç«¯å‘ä»£ç†æœåŠ¡å™¨å‘é€ä¸€ä¸ªè¯·æ±‚å¹¶æŒ‡å®šç›®æ ‡ï¼Œç„¶åä»£ç†æœåŠ¡å™¨å‘ç›®æ ‡æœåŠ¡å™¨è½¬äº¤è¯·æ±‚å¹¶å°†è·å¾—çš„å†…å®¹è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œæ­£å‘ä»£ç†ï¼Œå…¶å®æ˜¯\"ä»£ç†æœåŠ¡å™¨\"ä»£ç†äº†å½“å‰\"å®¢æˆ·ç«¯\"ï¼Œå»å’Œ\"ç›®æ ‡æœåŠ¡å™¨\"è¿›è¡Œäº¤äº’ ä½œç”¨ï¼š çªç ´è®¿é—®é™åˆ¶ï¼šé€šè¿‡ä»£ç†æœåŠ¡å™¨ï¼Œå¯ä»¥çªç ´è‡ªèº« IP è®¿é—®é™åˆ¶ï¼Œè®¿é—®å›½å¤–ç½‘ç«™ï¼Œæ•™è‚²ç½‘ç­‰ æé«˜è®¿é—®é€Ÿåº¦ï¼šä»£ç†æœåŠ¡å™¨éƒ½è®¾ç½®ä¸€ä¸ªè¾ƒå¤§çš„ç¡¬ç›˜ç¼“å†²åŒºï¼Œä¼šå°†éƒ¨åˆ†è¯·æ±‚çš„å“åº”ä¿å­˜åˆ°ç¼“å†²åŒºä¸­ï¼Œå½“å…¶ä»–ç”¨æˆ·å†è®¿é—®ç›¸åŒçš„ä¿¡æ¯æ—¶ï¼Œ åˆ™ç›´æ¥ç”±ç¼“å†²åŒºä¸­å–å‡ºä¿¡æ¯ï¼Œä¼ ç»™ç”¨æˆ·ï¼Œä»¥æé«˜è®¿é—®é€Ÿåº¦ éšè—å®¢æˆ·ç«¯çœŸå® IPï¼šéšè—è‡ªå·±çš„ IPï¼Œå…å—æ”»å‡» åå‘ä»£ç†ï¼ˆreverse proxyï¼‰ï¼šæ˜¯æŒ‡ä»¥ä»£ç†æœåŠ¡å™¨æ¥æ¥å— Internet ä¸Šçš„è¿æ¥è¯·æ±‚ï¼Œç„¶åå°†è¯·æ±‚è½¬å‘ç»™å†…éƒ¨ç½‘ç»œä¸Šçš„æœåŠ¡å™¨ï¼Œå¹¶å°†ä»æœåŠ¡å™¨ä¸Šå¾—åˆ°çš„ç»“æœè¿”å›ç»™ Internet ä¸Šè¯·æ±‚è¿æ¥çš„å®¢æˆ·ç«¯ï¼Œæ­¤æ—¶ä»£ç†æœåŠ¡å™¨å¯¹å¤–å°±è¡¨ç°ä¸ºä¸€ä¸ªåå‘ä»£ç†æœåŠ¡å™¨ï¼Œåå‘ä»£ç†ï¼Œå…¶å®æ˜¯\"ä»£ç†æœåŠ¡å™¨\"ä»£ç†äº†\"ç›®æ ‡æœåŠ¡å™¨\"ï¼Œå»å’Œå½“å‰\"å®¢æˆ·ç«¯\"è¿›è¡Œäº¤äº’ ä½œç”¨ï¼š éšè—æœåŠ¡å™¨çœŸå® IPï¼šä½¿ç”¨åå‘ä»£ç†ï¼Œå¯ä»¥å¯¹å®¢æˆ·ç«¯éšè—æœåŠ¡å™¨çš„ IP åœ°å€ è´Ÿè½½å‡è¡¡ï¼šæ ¹æ®æ‰€æœ‰çœŸå®æœåŠ¡å™¨çš„è´Ÿè½½æƒ…å†µï¼Œå°†å®¢æˆ·ç«¯è¯·æ±‚åˆ†å‘åˆ°ä¸åŒçš„çœŸå®æœåŠ¡å™¨ä¸Š æé«˜è®¿é—®é€Ÿåº¦ï¼šåå‘ä»£ç†æœåŠ¡å™¨å¯ä»¥å¯¹äºé™æ€å†…å®¹åŠçŸ­æ—¶é—´å†…æœ‰å¤§é‡è®¿é—®è¯·æ±‚çš„åŠ¨æ€å†…å®¹æä¾›ç¼“å­˜æœåŠ¡ æä¾›å®‰å…¨ä¿éšœï¼šåå‘ä»£ç†æœåŠ¡å™¨å¯ä»¥ä½œä¸ºåº”ç”¨å±‚é˜²ç«å¢™ï¼Œä¸ºç½‘ç«™æä¾›å¯¹åŸºäº Web çš„æ”»å‡»è¡Œä¸ºï¼ˆä¾‹å¦‚ DoS/DDoSï¼‰çš„é˜²æŠ¤ï¼Œæ›´å®¹æ˜“æ’æŸ¥æ¶æ„è½¯ä»¶ç­‰ åŒºåˆ«ï¼š æ­£å‘ä»£ç†å…¶å®æ˜¯å®¢æˆ·ç«¯çš„ä»£ç†ï¼Œå¸®åŠ©å®¢æˆ·ç«¯è®¿é—®å…¶æ— æ³•è®¿é—®çš„æœåŠ¡å™¨èµ„æºï¼›åå‘ä»£ç†åˆ™æ˜¯æœåŠ¡å™¨çš„ä»£ç†ï¼Œå¸®åŠ©æœåŠ¡å™¨åšè´Ÿè½½å‡è¡¡ï¼Œå®‰å…¨é˜²æŠ¤ç­‰ æ­£å‘ä»£ç†ä¸€èˆ¬æ˜¯å®¢æˆ·ç«¯æ¶è®¾çš„ï¼Œæ¯”å¦‚åœ¨è‡ªå·±çš„æœºå™¨ä¸Šå®‰è£…ä¸€ä¸ªä»£ç†è½¯ä»¶ï¼›åå‘ä»£ç†ä¸€èˆ¬æ˜¯æœåŠ¡å™¨æ¶è®¾çš„ï¼Œæ¯”å¦‚åœ¨è‡ªå·±çš„æœºå™¨é›†ç¾¤ä¸­éƒ¨ç½²ä¸€ä¸ªåå‘ä»£ç†æœåŠ¡å™¨ æ­£å‘ä»£ç†ä¸­ï¼ŒæœåŠ¡å™¨ä¸çŸ¥é“çœŸæ­£çš„å®¢æˆ·ç«¯åˆ°åº•æ˜¯è°ï¼Œä»¥ä¸ºè®¿é—®è‡ªå·±çš„å°±æ˜¯çœŸå®çš„å®¢æˆ·ç«¯ï¼›åå‘ä»£ç†ä¸­ï¼Œå®¢æˆ·ç«¯ä¸çŸ¥é“çœŸæ­£çš„æœåŠ¡å™¨æ˜¯è°ï¼Œä»¥ä¸ºè‡ªå·±è®¿é—®çš„å°±æ˜¯çœŸå®çš„æœåŠ¡å™¨ æ­£å‘ä»£ç†å’Œåå‘ä»£ç†çš„ä½œç”¨å’Œç›®çš„ä¸åŒã€‚æ­£å‘ä»£ç†ä¸»è¦æ˜¯ç”¨æ¥è§£å†³è®¿é—®é™åˆ¶é—®é¢˜ï¼›è€Œåå‘ä»£ç†åˆ™æ˜¯æä¾›è´Ÿè½½å‡è¡¡ã€å®‰å…¨é˜²æŠ¤ç­‰ä½œç”¨ï¼›äºŒè€…å‡èƒ½æé«˜è®¿é—®é€Ÿåº¦","categories":[],"tags":[]},{"title":"","slug":"Tool","date":"2025-05-20T16:25:06.365Z","updated":"2023-04-07T03:39:44.000Z","comments":true,"path":"2025/05/21/Tool/","link":"","permalink":"https://dddwah11.github.io/2025/05/21/Tool/","excerpt":"","text":"GitGitæ¦‚è¿°ç‰ˆæœ¬ç³»ç»ŸSVN æ˜¯é›†ä¸­å¼ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿï¼Œç‰ˆæœ¬åº“æ˜¯é›†ä¸­æ”¾åœ¨ä¸­å¤®æœåŠ¡å™¨çš„ï¼Œè€Œå¼€å‘äººå‘˜å·¥ä½œçš„æ—¶å€™ï¼Œç”¨çš„éƒ½æ˜¯è‡ªå·±çš„ç”µè„‘ï¼Œæ‰€ä»¥é¦–å…ˆè¦ä»ä¸­å¤®æœåŠ¡å™¨ä¸‹è½½æœ€æ–°çš„ç‰ˆæœ¬ï¼Œç„¶åå¼€å‘ï¼Œå¼€å‘å®Œåï¼Œéœ€è¦æŠŠè‡ªå·±å¼€å‘çš„ä»£ç æäº¤åˆ°ä¸­å¤®æœåŠ¡å™¨ã€‚ é›†ä¸­å¼ç‰ˆæœ¬æ§åˆ¶å·¥å…·ç¼ºç‚¹ï¼šæœåŠ¡å™¨å•ç‚¹æ•…éšœã€å®¹é”™æ€§å·® Git æ˜¯åˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿï¼ˆDistributed Version Control Systemï¼Œç®€ç§° DVCSï¼‰ ï¼Œåˆ†ä¸ºä¸¤ç§ç±»å‹çš„ä»“åº“ï¼š æœ¬åœ°ä»“åº“å’Œè¿œç¨‹ä»“åº“ï¼š æœ¬åœ°ä»“åº“ï¼šæ˜¯åœ¨å¼€å‘äººå‘˜è‡ªå·±ç”µè„‘ä¸Šçš„ Git ä»“åº“ è¿œç¨‹ä»“åº“ï¼šæ˜¯åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„ Git ä»“åº“ å·¥ä½œæµç¨‹1ï¼ä»è¿œç¨‹ä»“åº“ä¸­å…‹éš†ä»£ç åˆ°æœ¬åœ°ä»“åº“ 2ï¼ä»æœ¬åœ°ä»“åº“ä¸­ checkout ä»£ç ç„¶åè¿›è¡Œä»£ç ä¿®æ”¹ 3ï¼åœ¨æäº¤å‰å…ˆå°†ä»£ç æäº¤åˆ°æš‚å­˜åŒº 4ï¼æäº¤åˆ°æœ¬åœ°ä»“åº“ã€‚æœ¬åœ°ä»“åº“ä¸­ä¿å­˜ä¿®æ”¹çš„å„ä¸ªå†å²ç‰ˆæœ¬ 5ï¼ä¿®æ”¹å®Œæˆåï¼Œéœ€è¦å’Œå›¢é˜Ÿæˆå‘˜å…±äº«ä»£ç æ—¶ï¼Œå°†ä»£ç  push åˆ°è¿œç¨‹ä»“åº“ Gitå®‰è£…ä¸‹è½½åœ°å€ï¼š https://git-scm.com/download ä»£ç æ‰˜ç®¡Git ä¸­å­˜åœ¨ä¸¤ç§ç±»å‹çš„ä»“åº“ï¼Œå³æœ¬åœ°ä»“åº“å’Œè¿œç¨‹ä»“åº“ã€‚é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•æ­å»ºGitè¿œç¨‹ä»“åº“å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å€ŸåŠ©äº’è”ç½‘ä¸Šæä¾›çš„ä¸€äº›ä»£ç æ‰˜ç®¡æœåŠ¡æ¥å®ç°ï¼Œå…¶ä¸­æ¯”è¾ƒå¸¸ç”¨çš„æœ‰ GitHubã€ç äº‘ã€GitLab ç­‰ã€‚ GitHubï¼ˆåœ°å€ï¼šhttps://github.com/ï¼‰æ˜¯ä¸€ä¸ªé¢å‘å¼€æºåŠç§æœ‰è½¯ä»¶é¡¹ç›®çš„æ‰˜ç®¡å¹³å°ï¼Œå› ä¸ºåªæ”¯æŒ Git ä½œä¸ºå”¯ä¸€çš„ç‰ˆæœ¬åº“æ ¼å¼è¿›è¡Œæ‰˜ç®¡ï¼Œæ•…å GitHub ç äº‘ï¼ˆåœ°å€ï¼š https://gitee.com/ï¼‰æ˜¯å›½å†…çš„ä¸€ä¸ªä»£ç æ‰˜ç®¡å¹³å°ï¼Œç”±äºæœåŠ¡å™¨åœ¨å›½å†…ï¼Œæ‰€ä»¥ç›¸æ¯”äº GitHubï¼Œç äº‘é€Ÿåº¦ä¼šæ›´å¿« GitLabï¼ˆåœ°å€ï¼š https://about.gitlab.com/ ï¼‰æ˜¯ä¸€ä¸ªç”¨äºä»“åº“ç®¡ç†ç³»ç»Ÿçš„å¼€æºé¡¹ç›®ï¼Œä½¿ç”¨ Git ä½œä¸ºä»£ç ç®¡ç†å·¥å…·ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šæ­å»ºèµ·æ¥çš„ web æœåŠ¡ ç¯å¢ƒé…ç½®å®‰è£… Git åé¦–å…ˆè¦è®¾ç½®ç”¨æˆ·åç§°å’Œ email åœ°å€ï¼Œå› ä¸ºæ¯æ¬¡ Git æäº¤éƒ½ä¼šä½¿ç”¨è¯¥ç”¨æˆ·ä¿¡æ¯ï¼Œæ­¤ä¿¡æ¯å’Œæ³¨å†Œçš„ä»£ç æ‰˜ç®¡å¹³å°çš„ä¿¡æ¯æ— å…³ è®¾ç½®ç”¨æˆ·ä¿¡æ¯ï¼š git config â€“global user.name â€œSeazeanâ€ git config â€“global user.email â€œ&#105;&#x6d;&#115;&#101;&#x61;&#122;&#101;&#97;&#110;&#64;&#103;&#x6d;&#97;&#105;&#108;&#x2e;&#99;&#x6f;&#x6d;â€œ &#x2F;&#x2F;ç”¨æˆ·åå’Œé‚®ç®±å¯ä»¥éšæ„å¡«å†™ï¼Œä¸ä¼šæ ¡å¯¹ æŸ¥çœ‹é…ç½®ä¿¡æ¯ï¼š git config â€“list git config user.name é€šè¿‡ä¸Šé¢çš„å‘½ä»¤è®¾ç½®çš„ä¿¡æ¯ä¼šä¿å­˜åœ¨ç”¨æˆ·ç›®å½•ä¸‹ &#x2F;.gitconfig æ–‡ä»¶ä¸­ æœ¬åœ°ä»“åº“è·å–ä»“åº“ æœ¬åœ°ä»“åº“åˆå§‹åŒ– åœ¨ç”µè„‘çš„ä»»æ„ä½ç½®åˆ›å»ºä¸€ä¸ªç©ºç›®å½•ï¼ˆä¾‹å¦‚ repo1ï¼‰ä½œä¸ºæœ¬åœ° Git ä»“åº“ è¿›å…¥è¿™ä¸ªç›®å½•ä¸­ï¼Œç‚¹å‡»å³é”®æ‰“å¼€ Git bash çª—å£ æ‰§è¡Œå‘½ä»¤ git init å¦‚æœåœ¨å½“å‰ç›®å½•ä¸­çœ‹åˆ° .git æ–‡ä»¶å¤¹ï¼ˆæ­¤æ–‡ä»¶å¤¹ä¸ºéšè—æ–‡ä»¶å¤¹ï¼‰åˆ™è¯´æ˜ Git ä»“åº“åˆ›å»ºæˆåŠŸ è¿œç¨‹ä»“åº“å…‹éš†é€šè¿‡ Git æä¾›çš„å‘½ä»¤ä»è¿œç¨‹ä»“åº“è¿›è¡Œå…‹éš†ï¼Œå°†è¿œç¨‹ä»“åº“å…‹éš†åˆ°æœ¬åœ° å‘½ä»¤ï¼šgit clone è¿œç¨‹ Git ä»“åº“åœ°å€ï¼ˆHTTPS æˆ–è€… SSHï¼‰ ç”Ÿæˆ SSH å…¬é’¥æ­¥éª¤ è®¾ç½®è´¦æˆ· cd ~&#x2F;.sshï¼ˆæŸ¥çœ‹æ˜¯å¦ç”Ÿæˆè¿‡ SSH å…¬é’¥ï¼‰user ç›®å½•ä¸‹ ç”Ÿæˆ SSH å…¬é’¥ï¼šssh-keygen -t rsa -C &quot;email&quot; -t æŒ‡å®šå¯†é’¥ç±»å‹ï¼Œé»˜è®¤æ˜¯ rsa ï¼Œå¯ä»¥çœç•¥ -C è®¾ç½®æ³¨é‡Šæ–‡å­—ï¼Œæ¯”å¦‚é‚®ç®± -f æŒ‡å®šå¯†é’¥æ–‡ä»¶å­˜å‚¨æ–‡ä»¶å æŸ¥çœ‹å‘½ä»¤ï¼šcat ~&#x2F;.ssh&#x2F;id_rsa.pub å…¬é’¥æµ‹è¯•å‘½ä»¤ï¼šssh -T &#x67;&#105;&#116;&#64;&#x67;&#105;&#x74;&#x68;&#117;&#98;&#46;&#x63;&#x6f;&#109; å·¥ä½œè¿‡ç¨‹ ç‰ˆæœ¬åº“ï¼š.git éšè—æ–‡ä»¶å¤¹å°±æ˜¯ç‰ˆæœ¬åº“ï¼Œç‰ˆæœ¬åº“ä¸­å­˜å‚¨äº†å¾ˆå¤šé…ç½®ä¿¡æ¯ã€æ—¥å¿—ä¿¡æ¯å’Œæ–‡ä»¶ç‰ˆæœ¬ä¿¡æ¯ç­‰ å·¥ä½œç›®å½•ï¼ˆå·¥ä½œåŒºï¼‰ï¼šåŒ…å« .git æ–‡ä»¶å¤¹çš„ç›®å½•å°±æ˜¯å·¥ä½œç›®å½•ï¼Œä¸»è¦ç”¨äºå­˜æ”¾å¼€å‘çš„ä»£ç  æš‚å­˜åŒºï¼š.git æ–‡ä»¶å¤¹ä¸­æœ‰å¾ˆå¤šæ–‡ä»¶ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ª index æ–‡ä»¶å°±æ˜¯æš‚å­˜åŒºï¼Œä¹Ÿå¯ä»¥å«åš stageï¼Œæš‚å­˜åŒºæ˜¯ä¸€ä¸ªä¸´æ—¶ä¿å­˜ä¿®æ”¹æ–‡ä»¶çš„åœ°æ–¹ æ–‡ä»¶æ“ä½œå¸¸ç”¨å‘½ä»¤ å‘½ä»¤ ä½œç”¨ git status æŸ¥çœ‹ git çŠ¶æ€ ï¼ˆæ–‡ä»¶æ˜¯å¦è¿›è¡Œäº†æ·»åŠ ã€æäº¤æ“ä½œï¼‰ git add filename æ·»åŠ ï¼Œå°†æŒ‡å®šæ–‡ä»¶æ·»åŠ åˆ°æš‚å­˜åŒº git commit -m â€˜messageâ€™ æäº¤ï¼Œå°†æš‚å­˜åŒºæ–‡ä»¶æäº¤åˆ°æœ¬åœ°ä»“åº“ï¼Œåˆ é™¤æš‚å­˜åŒºçš„è¯¥æ–‡ä»¶ git commit â€“amend ä¿®æ”¹ commit çš„ message git rm filename åˆ é™¤ï¼Œåˆ é™¤å·¥ä½œåŒºçš„æ–‡ä»¶ï¼Œä¸æ˜¯ä»“åº“ï¼Œéœ€è¦æäº¤ git mv filename ç§»åŠ¨æˆ–é‡å‘½åå·¥ä½œåŒºæ–‡ä»¶ git reset filename ä½¿ç”¨å½“å‰åˆ†æ”¯ä¸Šçš„ä¿®æ”¹è¦†ç›–æš‚å­˜åŒºï¼Œå°†æš‚å­˜åŒºçš„æ–‡ä»¶å–æ¶ˆæš‚å­˜ git checkout filename ä½¿ç”¨æš‚å­˜åŒºçš„ä¿®æ”¹è¦†ç›–å·¥ä½œç›®å½•ï¼Œç”¨æ¥æ’¤é”€æœ¬æ¬¡ä¿®æ”¹(å±é™©) git log æŸ¥çœ‹æ—¥å¿—ï¼ˆ git æäº¤çš„å†å²æ—¥å¿—ï¼‰ git reflog å¯ä»¥æŸ¥çœ‹æ‰€æœ‰åˆ†æ”¯çš„æ‰€æœ‰æ“ä½œè®°å½•ï¼ˆåŒ…æ‹¬å·²ç»è¢«åˆ é™¤çš„ commit è®°å½•çš„æ“ä½œï¼‰ å…¶ä»–æŒ‡ä»¤ï¼šå¯ä»¥è·³è¿‡æš‚å­˜åŒºåŸŸç›´æ¥ä»åˆ†æ”¯ä¸­å–å‡ºä¿®æ”¹ï¼Œæˆ–è€…ç›´æ¥æäº¤ä¿®æ”¹åˆ°åˆ†æ”¯ä¸­ git commit -a ç›´æ¥æŠŠæ‰€æœ‰æ–‡ä»¶çš„ä¿®æ”¹æ·»åŠ åˆ°æš‚å­˜åŒºç„¶åæ‰§è¡Œæäº¤ git checkout HEAD â€“ files å–å‡ºæœ€åä¸€æ¬¡ä¿®æ”¹ï¼Œå¯ä»¥ç”¨æ¥è¿›è¡Œå›æ»šæ“ä½œ æ–‡ä»¶çŠ¶æ€ Git å·¥ä½œç›®å½•ä¸‹çš„æ–‡ä»¶å­˜åœ¨ä¸¤ç§çŠ¶æ€ï¼š untracked æœªè·Ÿè¸ªï¼ˆæœªè¢«çº³å…¥ç‰ˆæœ¬æ§åˆ¶ï¼‰ tracked å·²è·Ÿè¸ªï¼ˆè¢«çº³å…¥ç‰ˆæœ¬æ§åˆ¶ï¼‰ Unmodified æœªä¿®æ”¹çŠ¶æ€ Modified å·²ä¿®æ”¹çŠ¶æ€ Staged å·²æš‚å­˜çŠ¶æ€ æŸ¥çœ‹æ–‡ä»¶çŠ¶æ€ï¼šæ–‡ä»¶çš„çŠ¶æ€ä¼šéšç€æˆ‘ä»¬æ‰§è¡Œ Git çš„å‘½ä»¤å‘ç”Ÿå˜åŒ– git status æŸ¥çœ‹æ–‡ä»¶çŠ¶æ€ git status â€“s æŸ¥çœ‹æ›´ç®€æ´çš„æ–‡ä»¶çŠ¶æ€ æ–‡ä»¶å¿½ç•¥ä¸€èˆ¬æˆ‘ä»¬æ€»ä¼šæœ‰äº›æ–‡ä»¶æ— éœ€çº³å…¥Git çš„ç®¡ç†ï¼Œä¹Ÿä¸å¸Œæœ›å®ƒä»¬æ€»å‡ºç°åœ¨æœªè·Ÿè¸ªæ–‡ä»¶åˆ—è¡¨ã€‚ é€šå¸¸éƒ½æ˜¯äº›è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶ï¼Œæ¯”å¦‚æ—¥å¿—æ–‡ä»¶ï¼Œæˆ–è€…ç¼–è¯‘è¿‡ç¨‹ä¸­åˆ›å»ºçš„ä¸´æ—¶æ–‡ä»¶ç­‰ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å·¥ä½œç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªåä¸º .gitignore çš„æ–‡ä»¶ï¼ˆæ–‡ä»¶åç§°å›ºå®šï¼‰ï¼Œåˆ—å‡ºè¦å¿½ç•¥çš„æ–‡ä»¶æ¨¡å¼ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š 123456789101112# no .a files*.a# but do track lib.a, even though you&#x27;re ignoring .a files above!lib.a# only ignore the TODO file in the current directory, not subdir/TODO/TODO# ignore all files in the build/ directorybuild/# ignore doc/notes.txt, but not doc/server/arch.txtdoc/*.txt# ignore all .pdf files in the doc/ directorydoc/**/*.pdf è¿œç¨‹ä»“åº“å·¥ä½œæµç¨‹Git æœ‰å››ä¸ªå·¥ä½œç©ºé—´çš„æ¦‚å¿µï¼Œåˆ†åˆ«ä¸º å·¥ä½œç©ºé—´ã€æš‚å­˜åŒºã€æœ¬åœ°ä»“åº“ã€è¿œç¨‹ä»“åº“ã€‚ pull &#x3D; fetch + merge fetch æ˜¯ä»è¿œç¨‹ä»“åº“æ›´æ–°åˆ°æœ¬åœ°ä»“åº“ï¼Œpullæ˜¯ä»è¿œç¨‹ä»“åº“ç›´æ¥æ›´æ–°åˆ°å·¥ä½œç©ºé—´ä¸­ æŸ¥çœ‹ä»“åº“git remoteï¼šæ˜¾ç¤ºæ‰€æœ‰è¿œç¨‹ä»“åº“çš„ç®€å†™ git remote -vï¼šæ˜¾ç¤ºæ‰€æœ‰è¿œç¨‹ä»“åº“ git remote show ï¼šæ˜¾ç¤ºæŸä¸ªè¿œç¨‹ä»“åº“çš„è¯¦ç»†ä¿¡æ¯ æ·»åŠ ä»“åº“git remote add ï¼šæ·»åŠ ä¸€ä¸ªæ–°çš„è¿œç¨‹ä»“åº“ï¼Œå¹¶æŒ‡å®šä¸€ä¸ªå¯ä»¥å¼•ç”¨çš„ç®€å†™ å…‹éš†ä»“åº“git clone (HTTPS or SSH)ï¼šå…‹éš†è¿œç¨‹ä»“åº“ Git å…‹éš†çš„æ˜¯è¯¥ Git ä»“åº“æœåŠ¡å™¨ä¸Šçš„å‡ ä¹æ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬æ—¥å¿—ä¿¡æ¯ã€å†å²è®°å½•ç­‰ï¼‰ï¼Œè€Œä¸ä»…ä»…æ˜¯å¤åˆ¶å·¥ä½œæ‰€éœ€è¦çš„æ–‡ä»¶ï¼Œå½“ä½ æ‰§è¡Œ git clone å‘½ä»¤çš„æ—¶å€™ï¼Œé»˜è®¤é…ç½®ä¸‹è¿œç¨‹ Git ä»“åº“ä¸­çš„æ¯ä¸€ä¸ªæ–‡ä»¶çš„æ¯ä¸€ä¸ªç‰ˆæœ¬éƒ½å°†è¢«æ‹‰å–ä¸‹æ¥ã€‚ åˆ é™¤ä»“åº“git remote rm ï¼šç§»é™¤è¿œç¨‹ä»“åº“ï¼Œä»æœ¬åœ°ç§»é™¤è¿œç¨‹ä»“åº“çš„è®°å½•ï¼Œå¹¶ä¸ä¼šå½±å“åˆ°è¿œç¨‹ä»“åº“ æ‹‰å–ä»“åº“git fetch ï¼šä»è¿œç¨‹ä»“åº“è·å–æœ€æ–°ç‰ˆæœ¬åˆ°æœ¬åœ°ä»“åº“ï¼Œä¸ä¼šè‡ªåŠ¨ merge git pull ï¼šä»è¿œç¨‹ä»“åº“è·å–æœ€æ–°ç‰ˆæœ¬å¹¶ merge åˆ°æœ¬åœ°ä»“åº“ æ³¨æ„ï¼šå¦‚æœå½“å‰æœ¬åœ°ä»“åº“ä¸æ˜¯ä»è¿œç¨‹ä»“åº“å…‹éš†ï¼Œè€Œæ˜¯æœ¬åœ°åˆ›å»ºçš„ä»“åº“ï¼Œå¹¶ä¸”ä»“åº“ä¸­å­˜åœ¨æ–‡ä»¶ï¼Œæ­¤æ—¶å†ä»è¿œç¨‹ä»“åº“æ‹‰å–æ–‡ä»¶çš„æ—¶å€™ä¼šæŠ¥é”™ï¼ˆfatal: refusing to merge unrelated histories ï¼‰ï¼Œè§£å†³æ­¤é—®é¢˜å¯ä»¥åœ¨ git pull å‘½ä»¤ååŠ å…¥å‚æ•° â€“allow-unrelated-histories æ¨é€ä»“åº“git push ï¼šä¸Šä¼ æœ¬åœ°æŒ‡å®šåˆ†æ”¯åˆ°è¿œç¨‹ä»“åº“ ç‰ˆæœ¬ç®¡ç† å‘½ä»¤ï¼šgit reset â€“hard ç‰ˆæœ¬å”¯ä¸€ç´¢å¼•å€¼ åˆ†æ”¯ç®¡ç†æŸ¥çœ‹åˆ†æ”¯git branchï¼šåˆ—å‡ºæ‰€æœ‰æœ¬åœ°åˆ†æ”¯ git branch -rï¼šåˆ—å‡ºæ‰€æœ‰è¿œç¨‹åˆ†æ”¯ git branch -aï¼šåˆ—å‡ºæ‰€æœ‰æœ¬åœ°åˆ†æ”¯å’Œè¿œç¨‹åˆ†æ”¯ åˆ›å»ºåˆ†æ”¯git branch branch-nameï¼šæ–°å»ºä¸€ä¸ªåˆ†æ”¯ï¼Œä½†ä¾ç„¶åœç•™åœ¨å½“å‰åˆ†æ”¯ git checkout -b branch-nameï¼šæ–°å»ºä¸€ä¸ªåˆ†æ”¯ï¼Œå¹¶åˆ‡æ¢åˆ°è¯¥åˆ†æ”¯ æ¨é€åˆ†æ”¯git push origin branch-nameï¼šæ¨é€åˆ°è¿œç¨‹ä»“åº“ï¼Œorigin æ˜¯å¼•ç”¨å åˆ‡æ¢åˆ†æ”¯git checkout branch-nameï¼šåˆ‡æ¢åˆ° branch-name åˆ†æ”¯ åˆå¹¶åˆ†æ”¯git merge branch-nameï¼šåˆå¹¶æŒ‡å®šåˆ†æ”¯åˆ°å½“å‰åˆ†æ”¯ æœ‰æ—¶å€™åˆå¹¶æ“ä½œä¸ä¼šå¦‚æ­¤é¡ºåˆ©ã€‚ å¦‚æœä½ åœ¨ä¸¤ä¸ªä¸åŒçš„åˆ†æ”¯ä¸­ï¼Œå¯¹åŒä¸€ä¸ªæ–‡ä»¶çš„åŒä¸€ä¸ªéƒ¨åˆ†è¿›è¡Œäº†ä¸åŒçš„ä¿®æ”¹ï¼ŒGit å°±æ²¡åŠæ³•åˆå¹¶å®ƒä»¬ï¼ŒåŒæ—¶ä¼šæç¤ºæ–‡ä»¶å†²çªã€‚æ­¤æ—¶éœ€è¦æˆ‘ä»¬æ‰“å¼€å†²çªçš„æ–‡ä»¶å¹¶ä¿®å¤å†²çªå†…å®¹ï¼Œæœ€åæ‰§è¡Œ git add å‘½ä»¤æ¥æ ‡è¯†å†²çªå·²è§£å†³ â€‹ åˆ é™¤åˆ†æ”¯git branch -d branch-nameï¼šåˆ é™¤åˆ†æ”¯ git push origin â€“d branch-nameï¼šåˆ é™¤è¿œç¨‹ä»“åº“ä¸­çš„åˆ†æ”¯ ï¼ˆorigin æ˜¯å¼•ç”¨åï¼‰ å¦‚æœè¦åˆ é™¤çš„åˆ†æ”¯ä¸­è¿›è¡Œäº†å¼€å‘åŠ¨ä½œï¼Œæ­¤æ—¶æ‰§è¡Œåˆ é™¤å‘½ä»¤å¹¶ä¸ä¼šåˆ é™¤åˆ†æ”¯ï¼Œå¦‚æœåšæŒè¦åˆ é™¤æ­¤åˆ†æ”¯ï¼Œå¯ä»¥å°†å‘½ä»¤ä¸­çš„ -d å‚æ•°æ”¹ä¸º -Dï¼šgit branch -D branch-name æ ‡ç­¾ç®¡ç†æŸ¥çœ‹æ ‡ç­¾git tagï¼šåˆ—å‡ºæ‰€æœ‰ tag git show tag-nameï¼šæŸ¥çœ‹ tag è¯¦ç»†ä¿¡æ¯ æ ‡ç­¾ä½œç”¨ï¼šåœ¨å¼€å‘çš„ä¸€äº›å…³é”®æ—¶æœŸï¼Œä½¿ç”¨æ ‡ç­¾æ¥è®°å½•è¿™äº›å…³é”®æ—¶åˆ»ï¼Œä¿å­˜å¿«ç…§ï¼Œä¾‹å¦‚å‘å¸ƒç‰ˆæœ¬ã€æœ‰é‡å¤§ä¿®æ”¹ã€å‡çº§çš„æ—¶å€™ã€ä¼šä½¿ç”¨æ ‡ç­¾è®°å½•è¿™äº›æ—¶åˆ»ï¼Œæ¥æ°¸ä¹…æ ‡è®°é¡¹ç›®ä¸­çš„å…³é”®å†å²æ—¶åˆ» æ–°å»ºæ ‡ç­¾git tag tag-nameï¼šæ–°å»ºæ ‡ç­¾ï¼Œå¦‚ï¼ˆgit tag v1.0.1ï¼‰ æ¨é€æ ‡ç­¾git push [remotename] [tagname]ï¼šæ¨é€åˆ°è¿œç¨‹ä»“åº“ git push [remotename] â€“tagsï¼šæ¨é€æ‰€æœ‰çš„æ ‡ç­¾ åˆ‡æ¢æ ‡ç­¾git checkout tag-nameï¼šåˆ‡æ¢æ ‡ç­¾ åˆ é™¤æ ‡ç­¾git tag -d tag-nameï¼šåˆ é™¤æœ¬åœ°æ ‡ç­¾ git push origin :refs&#x2F;tags&#x2F; tag-nameï¼šåˆ é™¤è¿œç¨‹æ ‡ç­¾ IDEAæ“ä½œç¯å¢ƒé…ç½®File â†’ Settings æ‰“å¼€è®¾ç½®çª—å£ï¼Œæ‰¾åˆ° Version Control ä¸‹çš„ git é€‰é¡¹ é€‰æ‹© git çš„å®‰è£…ç›®å½•åå¯ä»¥ç‚¹å‡» Test æŒ‰é’®æµ‹è¯•æ˜¯å¦æ­£ç¡®é…ç½®ï¼šD:\\Program Files\\Git\\cmd\\git.exe åˆ›å»ºä»“åº“1ã€VCS â†’ Import into Version Control â†’ Create Git Repository 2ã€é€‰æ‹©å·¥ç¨‹æ‰€åœ¨çš„ç›®å½•,è¿™æ ·å°±åˆ›å»ºå¥½æœ¬åœ°ä»“åº“äº† 3ã€ç‚¹å‡»gitåè¾¹çš„å¯¹å‹¾,å°†å½“å‰é¡¹ç›®ä»£ç æäº¤åˆ°æœ¬åœ°ä»“åº“ â€‹ æ³¨æ„: é¡¹ç›®ä¸­çš„é…ç½®æ–‡ä»¶ä¸éœ€è¦æäº¤åˆ°æœ¬åœ°ä»“åº“ä¸­,æäº¤æ—¶,å¿½ç•¥æ‰å³å¯ æ–‡ä»¶æ“ä½œå³é”®é¡¹ç›®åæ‰“å¼€èœå• Git â†’ Add â†’ commit ç‰ˆæœ¬ç®¡ç† ç‰ˆæœ¬å¯¹æ¯” ç‰ˆæœ¬åˆ‡æ¢æ–¹å¼ä¸€ï¼šæ§åˆ¶å° Version Control â†’ Log â†’ å³é”® Reset Current Branch â†’ Resetï¼Œè¿™ç§åˆ‡æ¢ä¼šæŠ›å¼ƒåŸæ¥çš„æäº¤è®°å½• ç‰ˆæœ¬åˆ‡æ¢æ–¹å¼äºŒï¼šæ§åˆ¶å° Version Control â†’ Log â†’ Revert Commit â†’ Merge â†’ å¤„ç†ä»£ç  â†’ commitï¼Œè¿™ç§åˆ‡æ¢ä¼šå½“æˆä¸€ä¸ªæ–°çš„æäº¤è®°å½•ï¼Œä¹‹å‰çš„æäº¤è®°å½•ä¹Ÿéƒ½ä¿ç•™ â€‹ åˆ†æ”¯ç®¡ç† åˆ›å»ºåˆ†æ”¯ï¼šVCS â†’ Git â†’ Branches â†’ New Branch â†’ ç»™åˆ†æ”¯èµ·åå­— â†’ ok åˆ‡æ¢åˆ†æ”¯ï¼šidea å³ä¸‹è§’ Git â†’ é€‰æ‹©è¦åˆ‡æ¢çš„åˆ†æ”¯ â†’ checkout åˆå¹¶åˆ†æ”¯ï¼šVCS â†’ Git â†’ Merge changes â†’ é€‰æ‹©è¦åˆå¹¶çš„åˆ†æ”¯ â†’ merge åˆ é™¤åˆ†æ”¯ï¼šidea å³ä¸‹è§’ â†’ é€‰ä¸­è¦åˆ é™¤çš„åˆ†æ”¯ â†’ Delete æ¨é€ä»“åº“ VCS â†’ Git â†’ Push â†’ ç‚¹å‡» master Define remote å°†è¿œç¨‹ä»“åº“çš„ url è·¯å¾„å¤åˆ¶è¿‡æ¥ â†’ Push å…‹éš†ä»“åº“File â†’ Close Project â†’ Checkout from Version Control â†’ Git â†’ æŒ‡å®šè¿œç¨‹ä»“åº“çš„è·¯å¾„ â†’ æŒ‡å®šæœ¬åœ°å­˜æ”¾çš„è·¯å¾„ â†’ clone Linuxæ“ä½œç³»ç»Ÿæ“ä½œç³»ç»Ÿï¼ˆOperation Systemï¼‰ï¼Œæ˜¯ç®¡ç†è®¡ç®—æœºç¡¬ä»¶ä¸è½¯ä»¶èµ„æºçš„è®¡ç®—æœºç¨‹åºï¼ŒåŒæ—¶ä¹Ÿæ˜¯è®¡ç®—æœºç³»ç»Ÿçš„å†…æ ¸ä¸åŸºçŸ³ã€‚æ“ä½œç³»ç»Ÿéœ€è¦å¤„ç†ç®¡ç†ä¸é…ç½®å†…å­˜ã€å†³å®šç³»ç»Ÿèµ„æºä¾›éœ€çš„ä¼˜å…ˆæ¬¡åºã€æ§åˆ¶è¾“å…¥è®¾å¤‡ä¸è¾“å‡ºè®¾å¤‡ã€æ“ä½œç½‘ç»œä¸ç®¡ç†æ–‡ä»¶ç³»ç»Ÿç­‰åŸºæœ¬äº‹åŠ¡ï¼Œæ“ä½œç³»ç»Ÿä¹Ÿæä¾›ä¸€ä¸ªè®©ç”¨æˆ·ä¸ç³»ç»Ÿäº¤äº’çš„æ“ä½œç•Œé¢ æ“ä½œç³»ç»Ÿä½œä¸ºæ¥å£çš„ç¤ºæ„å›¾ï¼š ç§»åŠ¨è®¾å¤‡æ“ä½œç³»ç»Ÿï¼š Linuxç³»ç»Ÿç³»ç»Ÿä»‹ç»ä»å†…åˆ°ä½ä¾æ¬¡æ˜¯ç¡¬ä»¶ â†’ å†…æ ¸å±‚ â†’ Shell å±‚ â†’ åº”ç”¨å±‚ â†’ ç”¨æˆ· å†…æ ¸å±‚ï¼šæ ¸å¿ƒå’ŒåŸºç¡€ï¼Œé™„ç€åœ¨ç¡¬ä»¶å¹³å°ä¸Šï¼Œæ§åˆ¶å’Œç®¡ç†ç³»ç»Ÿå†…çš„å„ç§èµ„æºï¼Œæœ‰æ•ˆçš„ç»„ç»‡è¿›ç¨‹çš„è¿è¡Œï¼Œæ‰©å±•ç¡¬ä»¶çš„åŠŸèƒ½ï¼Œæé«˜èµ„æºåˆ©ç”¨æ•ˆç‡ï¼Œä¸ºç”¨æˆ·æä¾›å®‰å…¨å¯é çš„åº”ç”¨ç¯å¢ƒã€‚ Shell å±‚ï¼šä¸ç”¨æˆ·ç›´æ¥äº¤äº’çš„ç•Œé¢ã€‚ç”¨æˆ·å¯ä»¥åœ¨æç¤ºç¬¦ä¸‹è¾“å…¥å‘½ä»¤è¡Œï¼Œç”± Shell è§£é‡Šæ‰§è¡Œå¹¶è¾“å‡ºç›¸åº”ç»“æœæˆ–è€…æœ‰å…³ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹ŸæŠŠ Shell ç§°ä½œå‘½ä»¤è§£é‡Šå™¨ï¼Œåˆ©ç”¨ç³»ç»Ÿæä¾›çš„ä¸°å¯Œå‘½ä»¤å¯ä»¥å¿«æ·è€Œç®€ä¾¿åœ°å®Œæˆè®¸å¤šå·¥ä½œã€‚ æ–‡ä»¶ç³»ç»ŸLinux æ–‡ä»¶ç³»ç»Ÿç›®å½•ç»“æ„å’Œç†ŸçŸ¥çš„ windows ç³»ç»Ÿæœ‰è¾ƒå¤§åŒºåˆ«ï¼Œæ²¡æœ‰å„ç§ç›˜ç¬¦çš„æ¦‚å¿µã€‚æ ¹ç›®å½•åªæœ‰ä¸€ä¸ª&#x2F;ï¼Œé‡‡ç”¨å±‚çº§å¼çš„æ ‘çŠ¶ç›®å½•ç»“æ„ã€‚ è¿œç¨‹è¿æ¥è®¾ç½®IPNATé¦–å…ˆè®¾ç½®è™šæ‹Ÿæœºä¸­ NAT æ¨¡å¼çš„é€‰é¡¹ï¼Œæ‰“å¼€ VMwareï¼Œç‚¹å‡»ç¼–è¾‘ä¸‹çš„è™šæ‹Ÿç½‘ç»œç¼–è¾‘å™¨ï¼Œè®¾ç½® NAT å‚æ•° æ³¨æ„ï¼šVMware Network Adapter VMnet8 ä¿è¯æ˜¯å¯ç”¨çŠ¶æ€ â€‹ é™æ€IPåœ¨æ™®é€šç”¨æˆ·ä¸‹ä¸èƒ½ä¿®æ”¹ç½‘å¡çš„é…ç½®ä¿¡æ¯ï¼›æ‰€ä»¥æˆ‘ä»¬è¦åˆ‡æ¢åˆ° root ç”¨æˆ·è¿›è¡Œ ip é…ç½®ï¼šsu root&#x2F;su ä¿®æ”¹ç½‘å¡é…ç½®æ–‡ä»¶ï¼švim /etc/sysconfig/network-scripts/ifcfg-ens33 ä¿®æ”¹æ–‡ä»¶å†…å®¹ 12345678910111213141516171819202122232425TYPE=EthernetPROXY_METHOD=noneBROWSER_ONLY=noBOOTPROTO=staticIPADDR=10.2.111.62NETMASK=255.255.252.0GATEWAY=10.2.111.254DEFROUTE=yesIPV4_FAILURE_FATAL=noIPV6INIT=yesIPV6_AUTOCONF=yesIPV6_DEFROUTE=yesIPV6_FAILURE_FATAL=noIPV6_ADDR_GEN_MODE=stable-privacyNAME=ens33UUID=2c2371f1-ef29-4514-a568-c4904bd11c82DEVICE=ens33ONBOOT=true###########################BOOTPROTOè®¾ç½®ä¸ºé™æ€staticIPADDRè®¾ç½®ipåœ°å€NETMASKè®¾ç½®å­ç½‘æ©ç GATEWAYè®¾ç½®ç½‘å…³ONBOOTè®¾ç½®ä¸ºtrueåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶æ˜¯å¦æ¿€æ´»ç½‘å¡æ‰§è¡Œä¿å­˜ :wq! é‡å¯ç½‘ç»œï¼šsystemctl restart network æŸ¥çœ‹IPï¼šifconfig å®¿ä¸»æœº ping è™šæ‹Ÿæœºï¼Œè™šæ‹Ÿæœº ping å®¿ä¸»æœº åœ¨è™šæ‹Ÿæœºä¸­è®¿é—®ç½‘ç»œï¼Œéœ€è¦å¢åŠ ä¸€å— NAT ç½‘å¡ ã€è™šæ‹Ÿæœºã€‘â€“ã€è®¾ç½®ã€‘â€“ã€æ·»åŠ ã€‘ è¿œç¨‹ç™»é™†æœåŠ¡å™¨ç»´æŠ¤å·¥ä½œ éƒ½æ˜¯åœ¨ è¿œç¨‹ é€šè¿‡ SSH å®¢æˆ·ç«¯ æ¥å®Œæˆçš„ï¼Œ å¹¶æ²¡æœ‰å›¾å½¢ç•Œé¢ï¼Œ æ‰€æœ‰çš„ç»´æŠ¤å·¥ä½œéƒ½éœ€è¦é€šè¿‡å‘½ä»¤æ¥å®Œæˆï¼ŒLinux æœåŠ¡å™¨éœ€è¦å®‰è£… SSH ç›¸å…³æœåŠ¡ é¦–å…ˆæ‰§è¡Œ sudo apt-get install openssh-server æŒ‡ä»¤ï¼Œæ¥ä¸‹æ¥ç”¨ xshell è¿æ¥ å…ˆç”¨æ™®é€šç”¨æˆ·ç™»å½•ï¼Œç„¶åè½¬æˆ root ç”¨æˆ·ç®¡ç†Linux ç³»ç»Ÿæ˜¯ä¸€ä¸ªå¤šç”¨æˆ·ã€å¤šä»»åŠ¡çš„æ“ä½œç³»ç»Ÿã€‚å¤šç”¨æˆ·æ˜¯æŒ‡åœ¨ Linux æ“ä½œç³»ç»Ÿä¸­å¯ä»¥åˆ›å»ºå¤šä¸ªç”¨æˆ·ï¼Œè€Œè¿™äº›å¤šç”¨æˆ·åˆå¯ä»¥åŒæ—¶æ‰§è¡Œå„è‡ªä¸åŒçš„ä»»åŠ¡ï¼Œè€Œäº’ä¸å½±å“ åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œä¼šå­˜åœ¨ç€ä»¥ä¸‹å‡ ä¸ªæ¦‚å¿µï¼š ç”¨æˆ·åï¼šç”¨æˆ·çš„åç§° ç”¨æˆ·æ‰€å±çš„ç»„ï¼šå½“å‰ç”¨æˆ·æ‰€å±çš„ç»„ ç”¨æˆ·çš„å®¶ç›®å½•ï¼šå½“å‰è´¦å·ç™»å½•æˆåŠŸä¹‹åçš„ç›®å½•ï¼Œå°±å«åšè¯¥ç”¨æˆ·çš„å®¶ç›®å½• ç”¨æˆ·ç®¡ç†å½“å‰ç”¨æˆ·lognameï¼šç”¨äºæ˜¾ç¤ºç›®å‰ç”¨æˆ·çš„åç§° â€“helpï¼šåœ¨çº¿å¸®åŠ© â€“vesionï¼šæ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯ åˆ‡æ¢ç”¨æˆ·su UserNameï¼šåˆ‡æ¢ç”¨æˆ· su -c comman rootï¼šåˆ‡æ¢ç”¨æˆ·ä¸º root å¹¶åœ¨æ‰§è¡Œ comman æŒ‡ä»¤åé€€å‡ºè¿”å›åŸä½¿ç”¨è€… suï¼šåˆ‡æ¢åˆ° root ç”¨æˆ· ç”¨æˆ·æ·»åŠ å‘½ä»¤ï¼šuseradd [options] ç”¨æˆ·å å‚æ•°è¯´æ˜ï¼š -c comment æŒ‡å®šä¸€æ®µæ³¨é‡Šæ€§æè¿° -d æŒ‡å®šç”¨æˆ·ä¸»ç›®å½•ï¼Œå¦‚æœæ­¤ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ™åŒæ—¶ä½¿ç”¨ -m é€‰é¡¹ï¼Œå¯ä»¥åˆ›å»ºä¸»ç›®å½• -m åˆ›å»ºç”¨æˆ·çš„ä¸»ç›®å½• -g ç”¨æˆ·ç»„ï¼ŒæŒ‡å®šç”¨æˆ·æ‰€å±çš„ç”¨æˆ·ç»„ -G ç”¨æˆ·ç»„ï¼Œç”¨æˆ·ç»„ æŒ‡å®šç”¨æˆ·æ‰€å±çš„é™„åŠ ç»„ -s Shell æ–‡ä»¶ æŒ‡å®šç”¨æˆ·çš„ç™»å½• Shell -u ç”¨æˆ·å·ï¼ŒæŒ‡å®šç”¨æˆ·çš„ç”¨æˆ·å·ï¼Œå¦‚æœåŒæ—¶æœ‰ -o é€‰é¡¹ï¼Œåˆ™å¯ä»¥é‡å¤ä½¿ç”¨å…¶ä»–ç”¨æˆ·çš„æ ‡è¯†å·ã€‚ å¦‚ä½•çŸ¥é“æ·»åŠ ç”¨æˆ·æˆåŠŸå‘¢ï¼Ÿ é€šè¿‡æŒ‡ä»¤ cat &#x2F;etc&#x2F;passwd æŸ¥çœ‹ 12seazean:x: 1000:1000:Seazean:/home/seazean:/bin/bashç”¨æˆ·å å¯†ç  ç”¨æˆ·ID ç»„ID æ³¨é‡Š å®¶ç›®å½• shellç¨‹åº useradd -m Username æ–°å»ºç”¨æˆ·æˆåŠŸä¹‹åï¼Œä¼šå»ºç«‹ home ç›®å½•ï¼Œä½†æ˜¯æ­¤æ—¶æœ‰é—®é¢˜æ²¡æœ‰æŒ‡å®š shell çš„ç‰ˆæœ¬ï¼Œä¸æ˜¯æˆ‘ä»¬ç†ŸçŸ¥çš„ bashï¼ŒåŠŸèƒ½ä¸Šæœ‰å¾ˆå¤šé™åˆ¶ï¼Œè¿›è¡Œ sudo useradd -m -s &#x2F;bin&#x2F;bash Username ç”¨æˆ·å¯†ç ç³»ç»Ÿå®‰è£…å¥½é»˜è®¤çš„ root ç”¨æˆ·æ˜¯æ²¡æœ‰å¯†ç çš„ï¼Œéœ€è¦ç»™ root è®¾ç½®ä¸€ä¸ªå¯†ç  sudo passwd root. æ™®é€šç”¨æˆ·ï¼šsudo passwd UserName ç®¡ç†å‘˜ç”¨æˆ·ï¼špasswd [options] UserName -lï¼šé”å®šå¯†ç ï¼Œå³ç¦ç”¨è´¦å· -uï¼šå¯†ç è§£é” -dï¼šä½¿è´¦å·æ— å¯†ç  -fï¼šå¼ºè¿«ç”¨æˆ·ä¸‹æ¬¡ç™»å½•æ—¶ä¿®æ”¹å¯†ç  ç”¨æˆ·æƒé™usermod å‘½ä»¤é€šè¿‡ä¿®æ”¹ç³»ç»Ÿå¸æˆ·æ–‡ä»¶æ¥ä¿®æ”¹ç”¨æˆ·è´¦æˆ·ä¿¡æ¯ ä¿®æ”¹ç”¨æˆ·è´¦å·å°±æ˜¯æ ¹æ®å®é™…æƒ…å†µæ›´æ”¹ç”¨æˆ·çš„æœ‰å…³å±æ€§ï¼Œå¦‚ç”¨æˆ·å·ã€ä¸»ç›®å½•ã€ç”¨æˆ·ç»„ã€ç™»å½• Shell ç­‰ æ™®é€šç”¨æˆ·ï¼šsudo usermod [options] Username ç®¡ç†å‘˜ç”¨æˆ·ï¼šusermod [options] Username usermod -l newName Username -l æ–°çš„ç™»å½•åç§° ç”¨æˆ·åˆ é™¤åˆ é™¤ç”¨æˆ·è´¦å·å°±æ˜¯è¦å°† &#x2F;etc&#x2F;passwd ç­‰ç³»ç»Ÿæ–‡ä»¶ä¸­çš„è¯¥ç”¨æˆ·è®°å½•åˆ é™¤ï¼Œå¿…è¦æ—¶è¿˜åˆ é™¤ç”¨æˆ·çš„ä¸»ç›®å½• æ™®é€šç”¨æˆ·ï¼šsudo userdel [options] Username ç®¡ç†å‘˜ç”¨æˆ·ï¼šuserdel [options] Username -fï¼šå¼ºåˆ¶åˆ é™¤ç”¨æˆ·ï¼Œå³ä½¿ç”¨æˆ·å½“å‰å·²ç™»å½• -rï¼šåˆ é™¤ç”¨æˆ·çš„åŒæ—¶ï¼Œåˆ é™¤ä¸ç”¨æˆ·ç›¸å…³çš„æ‰€æœ‰æ–‡ä»¶ ç”¨æˆ·ç»„ç®¡ç†ç»„ç®¡ç†æ·»åŠ ç»„ï¼šgroupadd ç»„å åˆ›å»ºç”¨æˆ·çš„æ—¶åŠ å…¥ç»„ï¼šuseradd -m -g ç»„å ç”¨æˆ·åâ€‹ æ·»åŠ ç”¨æˆ·ç»„æ–°å¢ä¸€ä¸ªç”¨æˆ·ç»„ï¼ˆç»„åå¯è§åçŸ¥æ„ï¼Œç¬¦åˆè§„èŒƒå³å¯ï¼‰ï¼Œç„¶åå°†ç”¨æˆ·æ·»åŠ åˆ°ç»„ä¸­ï¼Œéœ€è¦ä½¿ç”¨ç®¡ç†å‘˜æƒé™ å‘½ä»¤ï¼šgroupadd [options] Groupname -g GID æŒ‡å®šæ–°ç”¨æˆ·ç»„çš„ç»„æ ‡è¯†å·ï¼ˆGIDï¼‰ -o ä¸€èˆ¬ä¸ -g é€‰é¡¹åŒæ—¶ä½¿ç”¨ï¼Œè¡¨ç¤ºæ–°ç”¨æˆ·ç»„çš„ GID å¯ä»¥ä¸ç³»ç»Ÿå·²æœ‰ç”¨æˆ·ç»„çš„ GID ç›¸åŒ æ–°å¢ç”¨æˆ·ç»„ Seazeanï¼šgroupadd Seazean ä¿®æ”¹ç”¨æˆ·ç»„éœ€è¦ä½¿ç”¨ç®¡ç†å‘˜æƒé™ å‘½ä»¤ï¼šgroupmod [options] Groupname -g GID ä¸ºç”¨æˆ·ç»„æŒ‡å®šæ–°çš„ç»„æ ‡è¯†å·ã€‚ -o ä¸ -g é€‰é¡¹åŒæ—¶ä½¿ç”¨ï¼Œç”¨æˆ·ç»„çš„æ–° GID å¯ä»¥ä¸ç³»ç»Ÿå·²æœ‰ç”¨æˆ·ç»„çš„ GID ç›¸åŒ -n æ–°ç”¨æˆ·ç»„ å°†ç”¨æˆ·ç»„çš„åå­—æ”¹ä¸ºæ–°åå­— ä¿®æ”¹ Seazean ç»„åä¸º zhyï¼šgroupmod -n zhy Seazean åˆ é™¤ç”¨æˆ·ç»„ æ™®é€šç”¨æˆ·ï¼šsudo groupdel Groupname ç®¡ç†å‘˜ç”¨æˆ·ï¼šgroupdel Groupname -f ç”¨æˆ·çš„ä¸»ç»„ä¹Ÿç»§ç»­åˆ é™¤ -h æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ ç”¨æˆ·æ‰€å±ç»„æŸ¥è¯¢ç”¨æˆ·æ‰€å±ç»„ï¼šgroups Username æŸ¥çœ‹ç”¨æˆ·åŠç»„ä¿¡æ¯ï¼šid Username åˆ›å»ºç”¨æˆ·çš„æ—¶åŠ å…¥ç»„ï¼šuseradd -m -g Groupname Username ä¿®æ”¹ç”¨æˆ·æ‰€å±ç»„ï¼šusermod -g Groupname Username usermodå¸¸ç”¨é€‰é¡¹ï¼š -d ç”¨æˆ·çš„æ–°ä¸»ç›®å½• -l æ–°çš„ç™»å½•åç§° gpasswdgpasswd æ˜¯ Linux å·¥ä½œç»„æ–‡ä»¶ &#x2F;etc&#x2F;group å’Œ &#x2F;etc&#x2F;gshadow ç®¡ç†å·¥å…·ï¼Œç”¨äºå°†ä¸€ä¸ªç”¨æˆ·æ·»åŠ åˆ°ç»„æˆ–ä»ç»„ä¸­åˆ é™¤ å‘½ä»¤ï¼šgpasswd é€‰é¡¹ Username Groupname -a å‘ç»„ GROUP ä¸­æ·»åŠ ç”¨æˆ· USER -d ä»ç»„ GROUP ä¸­æ·»åŠ æˆ–åˆ é™¤ç”¨æˆ· æŸ¥çœ‹ç”¨æˆ·ç»„ä¸‹æ‰€æœ‰ç”¨æˆ·ï¼ˆæ‰€æœ‰ç”¨æˆ·ï¼‰ï¼šgrep â€˜Groupnameâ€™ &#x2F;etc&#x2F;group ç³»ç»Ÿç®¡ç†manåœ¨æ§åˆ¶å°è¾“å…¥ï¼šå‘½ä»¤å -h&#x2F; -help&#x2F; â€“h &#x2F;ç©º å¯ä»¥çœ‹åˆ°å‘½ä»¤çš„å¸®åŠ©æ–‡æ¡£ man [æŒ‡ä»¤åç§°]ï¼šæŸ¥çœ‹å¸®åŠ©æ–‡æ¡£ï¼Œæ¯”å¦‚ man lsï¼Œé€€å‡ºæ–¹å¼ q datedate å¯ä»¥ç”¨æ¥æ˜¾ç¤ºæˆ–è®¾å®šç³»ç»Ÿçš„æ—¥æœŸä¸æ—¶é—´ å‘½ä»¤ï¼šdate [options] -d&lt;å­—ç¬¦ä¸²&gt;ï¼šæ˜¾ç¤ºå­—ç¬¦ä¸²æ‰€æŒ‡çš„æ—¥æœŸä¸æ—¶é—´ï¼Œå­—ç¬¦ä¸²å‰åå¿…é¡»åŠ ä¸ŠåŒå¼•å·ï¼› -s&lt;å­—ç¬¦ä¸²&gt;ï¼šæ ¹æ®å­—ç¬¦ä¸²æ¥è®¾ç½®æ—¥æœŸä¸æ—¶é—´ï¼Œå­—ç¬¦ä¸²å‰åå¿…é¡»åŠ ä¸ŠåŒå¼•å· -uï¼šæ˜¾ç¤º GMT â€“versionï¼šæ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯ æŸ¥çœ‹æ—¶é—´ï¼šdate â†’ 2020å¹´ 11æœˆ 30æ—¥ æ˜ŸæœŸä¸€ 17:10:54 CST æŸ¥çœ‹æŒ‡å®šæ ¼å¼æ—¶é—´ï¼šdate â€œ+%Y-%m-%d %H:%M:%Sâ€ â†’ 2020-11-30 17:11:44 è®¾ç½®æ—¥æœŸæŒ‡ä»¤ï¼šdate -s â€œ2019-12-23 19:21:00â€ idid ä¼šæ˜¾ç¤ºç”¨æˆ·ä»¥åŠæ‰€å±ç¾¤ç»„çš„å®é™…ä¸æœ‰æ•ˆ IDï¼Œè‹¥ä¸¤ä¸ª ID ç›¸åŒåˆ™ä»…æ˜¾ç¤ºå®é™… IDï¼›è‹¥ä»…æŒ‡å®šç”¨æˆ·åç§°ï¼Œåˆ™æ˜¾ç¤ºç›®å‰ç”¨æˆ·çš„ ID å‘½ä»¤ï¼šid [-gGnru] [â€“help] [â€“version] [ç”¨æˆ·åç§°] &#x2F;&#x2F;å‚æ•°çš„é¡ºåº -g æˆ–â€“groupï¼šæ˜¾ç¤ºç”¨æˆ·æ‰€å±ç¾¤ç»„çš„ ID -G æˆ–â€“groupsï¼šæ˜¾ç¤ºç”¨æˆ·æ‰€å±é™„åŠ ç¾¤ç»„çš„ ID -n æˆ–â€“nameï¼šæ˜¾ç¤ºç”¨æˆ·ï¼Œæ‰€å±ç¾¤ç»„æˆ–é™„åŠ ç¾¤ç»„çš„åç§°ã€‚ -r æˆ–â€“realï¼šæ˜¾ç¤ºå®é™… ID -u æˆ–â€“userï¼šæ˜¾ç¤ºç”¨æˆ· ID id å‘½ä»¤å‚æ•°è™½ç„¶å¾ˆå¤šï¼Œä½†æ˜¯å¸¸ç”¨çš„æ˜¯ä¸å¸¦å‚æ•°çš„ id å‘½ä»¤ï¼Œä¸»è¦çœ‹ uid å’Œç»„ä¿¡æ¯ sudosudoï¼šæ§åˆ¶ç”¨æˆ·å¯¹ç³»ç»Ÿå‘½ä»¤çš„ä½¿ç”¨æƒé™ï¼Œé€šè¿‡ sudo å¯ä»¥æé«˜æ™®é€šç”¨æˆ·çš„æ“ä½œæƒé™ -V æ˜¾ç¤ºç‰ˆæœ¬ç¼–å· -h ä¼šæ˜¾ç¤ºç‰ˆæœ¬ç¼–å·åŠæŒ‡ä»¤çš„ä½¿ç”¨æ–¹å¼è¯´æ˜ -l æ˜¾ç¤ºå‡ºè‡ªå·±ï¼ˆæ‰§è¡Œ sudo çš„ä½¿ç”¨è€…ï¼‰çš„æƒé™ -command è¦ä»¥ç³»ç»Ÿç®¡ç†è€…èº«ä»½ï¼ˆæˆ–ä»¥ -u æ›´æ”¹ä¸ºå…¶ä»–äººï¼‰æ‰§è¡Œçš„æŒ‡ä»¤ sudo -u root command -lï¼šæŒ‡å®š root ç”¨æˆ·æ‰§è¡ŒæŒ‡ä»¤ command toptopï¼šç”¨äºå®æ—¶æ˜¾ç¤º process çš„åŠ¨æ€ -cï¼šcommand å±æ€§è¿›è¡Œäº†å‘½ä»¤è¡¥å…¨ -p è¿›ç¨‹å·ï¼šæ˜¾ç¤ºæŒ‡å®š pid çš„è¿›ç¨‹ä¿¡æ¯ -d ç§’æ•°ï¼šè¡¨ç¤ºè¿›ç¨‹ç•Œé¢æ›´æ–°æ—¶é—´ï¼ˆæ¯å‡ ç§’åˆ·æ–°ä¸€æ¬¡ï¼‰ -H è¡¨ç¤ºçº¿ç¨‹æ¨¡å¼ top -Hp è¿›ç¨‹ idï¼šåˆ†æè¯¥è¿›ç¨‹å†…å„çº¿ç¨‹çš„ CPU ä½¿ç”¨æƒ…å†µ å„è¿›ç¨‹ï¼ˆä»»åŠ¡ï¼‰çš„çŠ¶æ€ç›‘æ§å±æ€§è§£é‡Šè¯´æ˜ï¼š PID â€” è¿›ç¨‹ id TID â€” çº¿ç¨‹ id USER â€” è¿›ç¨‹æ‰€æœ‰è€… PR â€” è¿›ç¨‹ä¼˜å…ˆçº§ NI â€” nice å€¼ï¼Œè´Ÿå€¼è¡¨ç¤ºé«˜ä¼˜å…ˆçº§ï¼Œæ­£å€¼è¡¨ç¤ºä½ä¼˜å…ˆçº§ VIRT â€” è¿›ç¨‹ä½¿ç”¨çš„è™šæ‹Ÿå†…å­˜æ€»é‡ï¼Œå•ä½ kbï¼ŒVIRT&#x3D;SWAP+RES RES â€” è¿›ç¨‹ä½¿ç”¨çš„ã€æœªè¢«æ¢å‡ºçš„ç‰©ç†å†…å­˜å¤§å°ï¼Œå•ä½ kbï¼ŒRES&#x3D;CODE+DATA SHR â€” å…±äº«å†…å­˜å¤§å°ï¼Œå•ä½ kb S â€” è¿›ç¨‹çŠ¶æ€ï¼ŒD&#x3D;ä¸å¯ä¸­æ–­çš„ç¡çœ çŠ¶æ€ R&#x3D;è¿è¡Œ S&#x3D;ç¡çœ  T&#x3D;è·Ÿè¸ª&#x2F;åœæ­¢ Z&#x3D;åƒµå°¸è¿›ç¨‹ %CPU â€” ä¸Šæ¬¡æ›´æ–°åˆ°ç°åœ¨çš„ CPU æ—¶é—´å ç”¨ç™¾åˆ†æ¯” %MEM â€” è¿›ç¨‹ä½¿ç”¨çš„ç‰©ç†å†…å­˜ç™¾åˆ†æ¯” TIME+ â€” è¿›ç¨‹ä½¿ç”¨çš„ CPU æ—¶é—´æ€»è®¡ï¼Œå•ä½ 1&#x2F;100 ç§’ COMMAND â€” è¿›ç¨‹åç§°ï¼ˆå‘½ä»¤å&#x2F;å‘½ä»¤è¡Œï¼‰ psLinux ç³»ç»Ÿä¸­æŸ¥çœ‹è¿›ç¨‹ä½¿ç”¨æƒ…å†µçš„å‘½ä»¤æ˜¯ ps æŒ‡ä»¤ å‘½ä»¤ï¼šps -e: æ˜¾ç¤ºæ‰€æœ‰è¿›ç¨‹ -f: å…¨æ ¼å¼ a: æ˜¾ç¤ºç»ˆç«¯ä¸Šçš„æ‰€æœ‰è¿›ç¨‹ u: ä»¥ç”¨æˆ·çš„æ ¼å¼æ¥æ˜¾ç¤ºè¿›ç¨‹ä¿¡æ¯ x: æ˜¾ç¤ºåå°è¿è¡Œçš„è¿›ç¨‹ -Tï¼šå¼€å¯çº¿ç¨‹æŸ¥çœ‹ -pï¼šæŒ‡å®šçº¿ç¨‹å· ä¸€èˆ¬å¸¸ç”¨æ ¼å¼ä¸º ps -ef æˆ–è€… ps aux ä¸¤ç§ã€‚æ˜¾ç¤ºçš„ä¿¡æ¯å¤§ä½“ä¸€è‡´ï¼Œç•¥æœ‰åŒºåˆ«ï¼š å¦‚æœæƒ³æŸ¥çœ‹è¿›ç¨‹çš„ CPU å ç”¨ç‡å’Œå†…å­˜å ç”¨ç‡ï¼Œå¯ä»¥ä½¿ç”¨ aux å¦‚æœæƒ³æŸ¥çœ‹è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ ID å’Œå®Œæ•´çš„ COMMAND å‘½ä»¤ï¼Œå¯ä»¥ä½¿ç”¨ ef ps -T -p &lt;pid&gt;ï¼šæ˜¾ç¤ºæŸä¸ªè¿›ç¨‹çš„çº¿ç¨‹ ps å’Œ top åŒºåˆ«ï¼š ps å‘½ä»¤ï¼šå¯ä»¥æŸ¥çœ‹è¿›ç¨‹çš„ç¬é—´ä¿¡æ¯ï¼Œæ˜¯ç³»ç»Ÿåœ¨è¿‡å»æ‰§è¡Œçš„è¿›ç¨‹çš„é™æ€å¿«ç…§ top å‘½ä»¤ï¼šå¯ä»¥æŒç»­çš„ç›‘è§†è¿›ç¨‹çš„åŠ¨æ€ä¿¡æ¯ killLinux kill å‘½ä»¤ç”¨äºåˆ é™¤æ‰§è¡Œä¸­çš„ç¨‹åºæˆ–å·¥ä½œï¼Œå¹¶ä¸æ˜¯è®©è¿›ç¨‹ç›´æ¥åœæ­¢ï¼Œè€Œæ˜¯ç»™è¿›ç¨‹å‘ä¸€ä¸ªä¿¡å·ï¼Œå¯ä»¥è¿›å…¥ç»ˆæ­¢é€»è¾‘ å‘½ä»¤ï¼škill [-s &lt;ä¿¡æ¯åç§°æˆ–ç¼–å·&gt;] [ç¨‹åº] æˆ– kill [-l &lt;ä¿¡æ¯ç¼–å·&gt;] -l &lt;ä¿¡æ¯ç¼–å·&gt;ï¼šè‹¥ä¸åŠ &lt;ä¿¡æ¯ç¼–å·&gt;é€‰é¡¹ï¼Œåˆ™-lå‚æ•°ä¼šåˆ—å‡ºå…¨éƒ¨çš„ä¿¡æ¯åç§° -s &lt;ä¿¡æ¯åç§°æˆ–ç¼–å·&gt;ï¼šæŒ‡å®šè¦é€å‡ºçš„ä¿¡æ¯ -KILLï¼šå¼ºåˆ¶æ€æ­»è¿›ç¨‹ -9ï¼šå½»åº•æ€æ­»è¿›ç¨‹ï¼ˆå¸¸ç”¨ï¼‰ [ç¨‹åº] ç¨‹åºçš„ PIDã€PGIDã€å·¥ä½œç¼–å· kill 15642 . kill -KILL 15642. kill -9 15642 æ€æ­»æŒ‡å®šç”¨æˆ·æ‰€æœ‰è¿›ç¨‹ï¼š è¿‡æ»¤å‡º user ç”¨æˆ·è¿›ç¨‹ ï¼škill -9 $(ps -ef | grep user) ç›´æ¥æ€æ­»ï¼škill -u user shutdownshutdown å‘½ä»¤å¯ä»¥ç”¨æ¥è¿›è¡Œå…³é—­ç³»ç»Ÿï¼Œå¹¶ä¸”åœ¨å…³æœºä»¥å‰ä¼ é€è®¯æ¯ç»™æ‰€æœ‰ä½¿ç”¨è€…æ­£åœ¨æ‰§è¡Œçš„ç¨‹åºï¼Œshutdown ä¹Ÿå¯ä»¥ç”¨æ¥é‡å¼€æœº æ™®é€šç”¨æˆ·ï¼šsudo shutdown [-t seconds] [-rkhncfF] time [message] ç®¡ç†å‘˜ç”¨æˆ·ï¼šshutdown [-t seconds] [-rkhncfF] time [message] -t secondsï¼šè®¾å®šåœ¨å‡ ç§’é’Ÿä¹‹åè¿›è¡Œå…³æœºç¨‹åº -kï¼šå¹¶ä¸ä¼šçœŸçš„å…³æœºï¼Œåªæ˜¯å°†è­¦å‘Šè®¯æ¯ä¼ é€ç»™æ‰€æœ‰ä½¿ç”¨è€… -rï¼šå…³æœºåé‡æ–°å¼€æœº -hï¼šå…³æœºååœæœº -nï¼šä¸é‡‡ç”¨æ­£å¸¸ç¨‹åºæ¥å…³æœºï¼Œç”¨å¼ºè¿«çš„æ–¹å¼æ€æ‰æ‰€æœ‰æ‰§è¡Œä¸­çš„ç¨‹åºåè‡ªè¡Œå…³æœº -cï¼šå–æ¶ˆç›®å‰å·²ç»è¿›è¡Œä¸­çš„å…³æœºåŠ¨ä½œ -fï¼šå…³æœºæ—¶ï¼Œä¸åš fcsk åŠ¨ä½œï¼ˆæ£€æŸ¥ Linux æ¡£ç³»ç»Ÿï¼‰ -Fï¼šå…³æœºæ—¶ï¼Œå¼ºè¿«è¿›è¡Œ fsck åŠ¨ä½œ timeï¼šè®¾å®šå…³æœºçš„æ—¶é—´ messageï¼šä¼ é€ç»™æ‰€æœ‰ä½¿ç”¨è€…çš„è­¦å‘Šè®¯æ¯ ç«‹å³å…³æœºï¼šshutdown -h now æˆ–è€… shudown now æŒ‡å®š 1 åˆ†é’Ÿåå…³æœºå¹¶æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯ï¼šshutdown +1 &quot;System will shutdown after 1 minutes&quot; æŒ‡å®š 1 åˆ†é’Ÿåé‡å¯å¹¶å‘å‡ºè­¦å‘Šä¿¡æ¯ï¼šshutdown â€“r +1 &quot;1åˆ†é’Ÿåå…³æœºé‡å¯&quot; rebootreboot å‘½ä»¤ç”¨äºç”¨æ¥é‡æ–°å¯åŠ¨è®¡ç®—æœº å‘½ä»¤ï¼šreboot [-n] [-w] [-d] [-f] [-i] -nï¼šåœ¨é‡å¼€æœºå‰ä¸åšå°†è®°å¿†ä½“èµ„æ–™å†™å›ç¡¬ç›˜çš„åŠ¨ä½œ -wï¼šå¹¶ä¸ä¼šçœŸçš„é‡å¼€æœºï¼Œåªæ˜¯æŠŠè®°å½•å†™åˆ° &#x2F;var&#x2F;log&#x2F;wtmp æ¡£æ¡ˆé‡Œ -dï¼šä¸æŠŠè®°å½•å†™åˆ° &#x2F;var&#x2F;log&#x2F;wtmp æ¡£æ¡ˆé‡Œï¼ˆ-n è¿™ä¸ªå‚æ•°åŒ…å«äº† -dï¼‰ -fï¼šå¼ºè¿«é‡å¼€æœºï¼Œä¸å‘¼å« shutdown è¿™ä¸ªæŒ‡ä»¤ -iï¼šåœ¨é‡å¼€æœºä¹‹å‰å…ˆæŠŠæ‰€æœ‰ç½‘ç»œç›¸å…³çš„è£…ç½®å…ˆåœæ­¢ whowho å‘½ä»¤ç”¨äºæ˜¾ç¤ºç³»ç»Ÿä¸­æœ‰å“ªäº›ä½¿ç”¨è€…æ­£åœ¨ä¸Šé¢ï¼Œæ˜¾ç¤ºçš„èµ„æ–™åŒ…å«äº†ä½¿ç”¨è€… IDã€ä½¿ç”¨çš„ç»ˆç«¯æœºã€ä¸Šçº¿æ—¶é—´ã€CPU ä½¿ç”¨é‡ã€åŠ¨ä½œç­‰ç­‰ å‘½ä»¤ï¼šwho - [husfV] [user] -H æˆ– â€“headingï¼šæ˜¾ç¤ºå„æ ä½çš„æ ‡é¢˜ä¿¡æ¯åˆ—ï¼ˆå¸¸ç”¨ who -Hï¼‰ -i æˆ– -u æˆ– â€“idleï¼šæ˜¾ç¤ºé—²ç½®æ—¶é—´ï¼Œè‹¥è¯¥ç”¨æˆ·åœ¨å‰ä¸€åˆ†é’Ÿä¹‹å†…æœ‰è¿›è¡Œä»»ä½•åŠ¨ä½œï¼Œå°†æ ‡ç¤ºæˆ . å·ï¼Œå¦‚æœè¯¥ç”¨æˆ·å·²è¶…è¿‡ 24 å°æ—¶æ²¡æœ‰ä»»ä½•åŠ¨ä½œï¼Œåˆ™æ ‡ç¤ºå‡º old å­—ç¬¦ä¸² -mï¼šæ­¤å‚æ•°çš„æ•ˆæœå’ŒæŒ‡å®š am i å­—ç¬¦ä¸²ç›¸åŒ -q æˆ–â€“countï¼šåªæ˜¾ç¤ºç™»å…¥ç³»ç»Ÿçš„å¸å·åç§°å’Œæ€»äººæ•° -sï¼šæ­¤å‚æ•°å°†å¿½ç•¥ä¸äºˆå¤„ç†ï¼Œä»…è´Ÿè´£è§£å†³whoæŒ‡ä»¤å…¶ä»–ç‰ˆæœ¬çš„å…¼å®¹æ€§é—®é¢˜ -w æˆ–-Tæˆ–â€“mesgæˆ–â€“messageæˆ–â€“writableï¼šæ˜¾ç¤ºç”¨æˆ·çš„ä¿¡æ¯çŠ¶æ€æ  â€“helpï¼šåœ¨çº¿å¸®åŠ© â€“versionï¼šæ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯ systemctlå‘½ä»¤ï¼šsystemctl [command] [unit] â€“version æŸ¥çœ‹ç‰ˆæœ¬å· startï¼šç«‹åˆ»å¯åŠ¨åé¢æ¥çš„ unit stopï¼šç«‹åˆ»å…³é—­åé¢æ¥çš„ unit restartï¼šç«‹åˆ»å…³é—­åå¯åŠ¨åé¢æ¥çš„ unitï¼Œäº¦å³æ‰§è¡Œ stop å† start çš„æ„æ€ reloadï¼šä¸å…³é—­ unit çš„æƒ…å†µä¸‹ï¼Œé‡æ–°è½½å…¥é…ç½®æ–‡ä»¶ï¼Œè®©è®¾ç½®ç”Ÿæ•ˆ statusï¼šç›®å‰åé¢æ¥çš„è¿™ä¸ª unit çš„çŠ¶æ€ï¼Œä¼šåˆ—å‡ºæœ‰æ²¡æœ‰æ­£åœ¨æ‰§è¡Œã€å¼€æœºæ—¶æ˜¯å¦å¯åŠ¨ç­‰ä¿¡æ¯ enableï¼šè®¾ç½®ä¸‹æ¬¡å¼€æœºæ—¶ï¼Œåé¢æ¥çš„ unit ä¼šè¢«å¯åŠ¨ disableï¼šè®¾ç½®ä¸‹æ¬¡å¼€æœºæ—¶ï¼Œåé¢æ¥çš„ unit ä¸ä¼šè¢«å¯åŠ¨ is-activeï¼šç›®å‰æœ‰æ²¡æœ‰æ­£åœ¨è¿è¡Œä¸­ is-enableï¼šå¼€æœºæ—¶æœ‰æ²¡æœ‰é»˜è®¤è¦å¯ç”¨è¿™ä¸ª unit kill ï¼šä¸è¦è¢« kill è¿™ä¸ªåå­—å“ç€äº†ï¼Œå®ƒå…¶å®æ˜¯å‘è¿è¡Œ unit çš„è¿›ç¨‹å‘é€ä¿¡å· showï¼šåˆ—å‡º unit çš„é…ç½® maskï¼šæ³¨é”€ unitï¼Œæ³¨é”€åä½ å°±æ— æ³•å¯åŠ¨è¿™ä¸ª unit äº† unmaskï¼šå–æ¶ˆå¯¹ unit çš„æ³¨é”€ timedatectltimedatectlç”¨äºæ§åˆ¶ç³»ç»Ÿæ—¶é—´å’Œæ—¥æœŸã€‚å¯ä»¥æŸ¥è¯¢å’Œæ›´æ”¹ç³»ç»Ÿæ—¶é’Ÿäºè®¾å®šï¼ŒåŒæ—¶å¯ä»¥è®¾å®šå’Œä¿®æ”¹æ—¶åŒºä¿¡æ¯ã€‚åœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿæ—¶é—´çš„æ˜¾ç¤ºä¼šå’Œå®é™…å‡ºç°ä¸åŒæ­¥ï¼›æˆ‘ä»¬ä¸ºäº†æ ¡æ­£æœåŠ¡å™¨æ—¶é—´ã€æ—¶åŒºä¼šä½¿ç”¨timedatectlå‘½ä»¤ timedatectlï¼šæ˜¾ç¤ºç³»ç»Ÿçš„æ—¶é—´ä¿¡æ¯ timedatectl statusï¼šæ˜¾ç¤ºç³»ç»Ÿçš„å½“å‰æ—¶é—´å’Œæ—¥æœŸ timedatectl | grep Timeï¼šæŸ¥çœ‹å½“å‰æ—¶åŒº timedatectl list-timezonesï¼šæŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„æ—¶åŒº timedatectl set-timezone â€œAsia&#x2F;Shanghaiâ€ï¼šè®¾ç½®æœ¬åœ°æ—¶åŒºä¸ºä¸Šæµ· timedatectl set-ntp true&#x2F;falseï¼šå¯ç”¨&#x2F;ç¦ç”¨æ—¶é—´åŒæ­¥ timedatectl set-time â€œ2020-12-20 20:45:00â€ï¼šæ—¶é—´åŒæ­¥å…³é—­åå¯ä»¥è®¾å®šæ—¶é—´ NTP å³ Network Time Protocolï¼ˆç½‘ç»œæ—¶é—´åè®®ï¼‰ï¼Œæ˜¯ä¸€ä¸ªäº’è”ç½‘åè®®ï¼Œç”¨äºåŒæ­¥è®¡ç®—æœºä¹‹é—´çš„ç³»ç»Ÿæ—¶é’Ÿï¼Œtimedatectl å®ç”¨ç¨‹åºå¯ä»¥è‡ªåŠ¨åŒæ­¥ä½ çš„Linuxç³»ç»Ÿæ—¶é’Ÿåˆ°ä½¿ç”¨NTPçš„è¿œç¨‹æœåŠ¡å™¨ clearclear å‘½ä»¤ç”¨äºæ¸…é™¤å±å¹• é€šè¿‡æ‰§è¡Œ clear å‘½ä»¤ï¼Œå°±å¯ä»¥æŠŠç¼“å†²åŒºçš„å‘½ä»¤å…¨éƒ¨æ¸…ç†å¹²å‡€ exitexit å‘½ä»¤ç”¨äºé€€å‡ºç›®å‰çš„ shell æ‰§è¡Œ exit å¯ä½¿ shell ä»¥æŒ‡å®šçš„çŠ¶æ€å€¼é€€å‡ºã€‚è‹¥ä¸è®¾ç½®çŠ¶æ€å€¼å‚æ•°ï¼Œåˆ™ shell ä»¥é¢„è®¾å€¼é€€å‡ºã€‚çŠ¶æ€å€¼ 0 ä»£è¡¨æ‰§è¡ŒæˆåŠŸï¼Œå…¶ä»–å€¼ä»£è¡¨æ‰§è¡Œå¤±è´¥ï¼›exit ä¹Ÿå¯ç”¨åœ¨ scriptï¼Œç¦»å¼€æ­£åœ¨æ‰§è¡Œçš„ scriptï¼Œå›åˆ° shell å‘½ä»¤ï¼šexit [çŠ¶æ€å€¼] 0 è¡¨ç¤ºæˆåŠŸï¼ˆZero - Successï¼‰ é 0 è¡¨ç¤ºå¤±è´¥ï¼ˆNon-Zero - Failureï¼‰ 2 è¡¨ç¤ºç”¨æ³•ä¸å½“ï¼ˆIncorrect Usageï¼‰ 127 è¡¨ç¤ºå‘½ä»¤æ²¡æœ‰æ‰¾åˆ°ï¼ˆCommand Not Foundï¼‰ 126 è¡¨ç¤ºä¸æ˜¯å¯æ‰§è¡Œçš„ï¼ˆNot an executableï¼‰ å¤§äºç­‰äº 128 ä¿¡å·äº§ç”Ÿ æ–‡ä»¶ç®¡ç†å¸¸ç”¨å‘½ä»¤lslså‘½ä»¤ç›¸å½“äºæˆ‘ä»¬åœ¨Windowsç³»ç»Ÿä¸­æ‰“å¼€ç£ç›˜ã€æˆ–è€…æ‰“å¼€æ–‡ä»¶å¤¹çœ‹åˆ°çš„ç›®å½•ä»¥åŠæ–‡ä»¶çš„æ˜ç»†ã€‚ å‘½ä»¤ï¼šls [options] ç›®å½•åç§° -a ï¼šå…¨éƒ¨çš„æ–‡ä»¶ï¼Œè¿åŒéšè—æ¡£( å¼€å¤´ä¸º . çš„æ–‡ä»¶) ä¸€èµ·åˆ—å‡ºæ¥(å¸¸ç”¨) -d ï¼šä»…åˆ—å‡ºç›®å½•æœ¬èº«ï¼Œè€Œä¸æ˜¯åˆ—å‡ºç›®å½•å†…çš„æ–‡ä»¶æ•°æ®(å¸¸ç”¨) -l ï¼šæ˜¾ç¤ºä¸éšè—çš„æ–‡ä»¶ä¸æ–‡ä»¶å¤¹çš„è¯¦ç»†ä¿¡æ¯ï¼›(å¸¸ç”¨) ls -al &#x3D; ll å‘½ä»¤ï¼šæ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶ä¸æ–‡ä»¶å¤¹çš„è¯¦ç»†ä¿¡æ¯ pwdpwd æ˜¯ Print Working Directory çš„ç¼©å†™ï¼Œä¹Ÿå°±æ˜¯æ˜¾ç¤ºç›®å‰æ‰€åœ¨å½“å‰ç›®å½•çš„å‘½ä»¤ å‘½ä»¤ï¼špwd é€‰é¡¹ -L æ‰“å° $PWD å˜é‡çš„å€¼ï¼Œå¦‚æœå®ƒåŒ…å«äº†å½“å‰çš„å·¥ä½œç›®å½• -P æ‰“å°å½“å‰çš„ç‰©ç†è·¯å¾„ï¼Œä¸å¸¦æœ‰ä»»ä½•çš„ç¬¦å·é“¾æ¥ cdcd æ˜¯ Change Directory çš„ç¼©å†™ï¼Œè¿™æ˜¯ç”¨æ¥å˜æ¢å·¥ä½œç›®å½•çš„å‘½ä»¤ å‘½ä»¤ï¼šcd [ç›¸å¯¹è·¯å¾„æˆ–ç»å¯¹è·¯å¾„] cd ~ ï¼šè¡¨ç¤ºå›åˆ°æ ¹ç›®å½• cd .. ï¼šè¿”å›ä¸Šçº§ç›®å½• ç›¸å¯¹è·¯å¾„ åœ¨è¾“å…¥è·¯å¾„æ—¶, æœ€å‰é¢ä¸æ˜¯ä»¥ / å¼€å§‹çš„ , è¡¨ç¤ºç›¸å¯¹å½“å‰ç›®å½•æ‰€åœ¨çš„ç›®å½•ä½ç½® ä¾‹å¦‚ï¼š &#x2F;usr&#x2F;share&#x2F;doc ç»å¯¹è·¯å¾„ åœ¨è¾“å…¥è·¯å¾„æ—¶, æœ€å‰é¢æ˜¯ä»¥ / å¼€å§‹çš„, è¡¨ç¤ºä»æ ¹ç›®å½•å¼€å§‹çš„å…·ä½“ç›®å½•ä½ç½® ç”± &#x2F;usr&#x2F;share&#x2F;doc åˆ° &#x2F;usr&#x2F;share&#x2F;man æ—¶ï¼Œå¯ä»¥å†™æˆï¼š cd ..&#x2F;man ä¼˜ç‚¹ï¼šå®šä½å‡†ç¡®, ä¸ä¼šå› ä¸º å·¥ä½œç›®å½•å˜åŒ– è€Œå˜åŒ– mkdirmkdirå‘½ä»¤ç”¨äºå»ºç«‹åç§°ä¸º dirName ä¹‹å­ç›®å½• å‘½ä»¤ï¼šmkdir [-p] dirName -p ç¡®ä¿ç›®å½•åç§°å­˜åœ¨ï¼Œä¸å­˜åœ¨çš„å°±å»ºä¸€ä¸ªï¼Œç”¨æ¥åˆ›å»ºå¤šçº§ç›®å½•ã€‚ mkdir -p aaa/bbbï¼šåœ¨ aaa ç›®å½•ä¸‹ï¼Œåˆ›å»ºä¸€ä¸ª bbb çš„å­ç›®å½•ã€‚ è‹¥ aaa ç›®å½•åŸæœ¬ä¸å­˜åœ¨ï¼Œåˆ™å»ºç«‹ä¸€ä¸ª rmdirrmdirå‘½ä»¤åˆ é™¤ç©ºçš„ç›®å½• å‘½ä»¤ï¼šrmdir [-p] dirName -p æ˜¯å½“å­ç›®å½•è¢«åˆ é™¤åä½¿å®ƒä¹Ÿæˆä¸ºç©ºç›®å½•çš„è¯ï¼Œåˆ™é¡ºä¾¿ä¸€å¹¶åˆ é™¤ rmdir -p aaa/bbbï¼šåœ¨ aaa ç›®å½•ä¸­ï¼Œåˆ é™¤åä¸º bbb çš„å­ç›®å½•ã€‚è‹¥ bbb åˆ é™¤åï¼Œaaa ç›®å½•æˆä¸ºç©ºç›®å½•ï¼Œåˆ™ aaa åŒæ—¶ä¹Ÿä¼šè¢«åˆ é™¤ cpcp å‘½ä»¤ä¸»è¦ç”¨äºå¤åˆ¶æ–‡ä»¶æˆ–ç›®å½• å‘½ä»¤ï¼šcp [options] sourceâ€¦ directory -aï¼šæ­¤é€‰é¡¹é€šå¸¸åœ¨å¤åˆ¶ç›®å½•æ—¶ä½¿ç”¨ï¼Œå®ƒä¿ç•™é“¾æ¥ã€æ–‡ä»¶å±æ€§ï¼Œå¹¶å¤åˆ¶ç›®å½•ä¸‹çš„æ‰€æœ‰å†…å®¹ã€‚å…¶ä½œç”¨ç­‰äºdpRå‚æ•°ç»„åˆ -dï¼šå¤åˆ¶æ—¶ä¿ç•™é“¾æ¥ã€‚è¿™é‡Œæ‰€è¯´çš„é“¾æ¥ç›¸å½“äºWindowsç³»ç»Ÿä¸­çš„å¿«æ·æ–¹å¼ -fï¼šè¦†ç›–å·²ç»å­˜åœ¨çš„ç›®æ ‡æ–‡ä»¶è€Œä¸ç»™å‡ºæç¤º -iï¼šä¸ -f é€‰é¡¹ç›¸åï¼Œåœ¨è¦†ç›–ç›®æ ‡æ–‡ä»¶ä¹‹å‰ç»™å‡ºæç¤ºï¼Œè¦æ±‚ç”¨æˆ·ç¡®è®¤æ˜¯å¦è¦†ç›–ï¼Œå›ç­” y æ—¶ç›®æ ‡æ–‡ä»¶å°†è¢«è¦†ç›– -pï¼šé™¤å¤åˆ¶æ–‡ä»¶çš„å†…å®¹å¤–ï¼Œè¿˜æŠŠä¿®æ”¹æ—¶é—´å’Œè®¿é—®æƒé™ä¹Ÿå¤åˆ¶åˆ°æ–°æ–‡ä»¶ä¸­ -r&#x2F;Rï¼šè‹¥ç»™å‡ºçš„æºæ–‡ä»¶æ˜¯ä¸€ä¸ªç›®å½•æ–‡ä»¶ï¼Œæ­¤æ—¶å°†å¤åˆ¶è¯¥ç›®å½•ä¸‹æ‰€æœ‰çš„å­ç›®å½•å’Œæ–‡ä»¶ -lï¼šä¸å¤åˆ¶æ–‡ä»¶ï¼Œåªæ˜¯ç”Ÿæˆé“¾æ¥æ–‡ä»¶ cp â€“r aaa/* cccï¼šå¤åˆ¶ aaa ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åˆ° cccï¼Œä¸åŠ å‚æ•° -r æˆ–è€… -Rï¼Œåªå¤åˆ¶æ–‡ä»¶ï¼Œè€Œç•¥è¿‡ç›®å½• rmrmå‘½ä»¤ç”¨äºåˆ é™¤ä¸€ä¸ªæ–‡ä»¶æˆ–è€…ç›®å½•ã€‚ å‘½ä»¤ï¼šrm [options] nameâ€¦ -i åˆ é™¤å‰é€ä¸€è¯¢é—®ç¡®è®¤ã€‚ -f å³ä½¿åŸæ¡£æ¡ˆå±æ€§è®¾ä¸ºå”¯è¯»ï¼Œäº¦ç›´æ¥åˆ é™¤ï¼Œæ— éœ€é€ä¸€ç¡®è®¤ -r å°†ç›®å½•åŠä»¥ä¸‹ä¹‹æ¡£æ¡ˆäº¦é€ä¸€åˆ é™¤ï¼Œé€’å½’åˆ é™¤ æ³¨ï¼šæ–‡ä»¶ä¸€æ—¦é€šè¿‡ rm å‘½ä»¤åˆ é™¤ï¼Œåˆ™æ— æ³•æ¢å¤ï¼Œæ‰€ä»¥å¿…é¡»æ ¼å¤–å°å¿ƒåœ°ä½¿ç”¨è¯¥å‘½ä»¤ mvmv å‘½ä»¤ç”¨æ¥ä¸ºæ–‡ä»¶æˆ–ç›®å½•æ”¹åã€æˆ–å°†æ–‡ä»¶æˆ–ç›®å½•ç§»å…¥å…¶å®ƒä½ç½® 12mv [options] source destmv [options] source... directory -iï¼šè‹¥æŒ‡å®šç›®å½•å·²æœ‰åŒåæ–‡ä»¶ï¼Œåˆ™å…ˆè¯¢é—®æ˜¯å¦è¦†ç›–æ—§æ–‡ä»¶ -fï¼šåœ¨ mv æ“ä½œè¦è¦†ç›–æŸå·²æœ‰çš„ç›®æ ‡æ–‡ä»¶æ—¶ä¸ç»™ä»»ä½•æŒ‡ç¤º å‘½ä»¤æ ¼å¼ è¿è¡Œç»“æœ mv æ–‡ä»¶å æ–‡ä»¶å å°†æºæ–‡ä»¶åæ”¹ä¸ºç›®æ ‡æ–‡ä»¶å mv æ–‡ä»¶å ç›®å½•å å°†æ–‡ä»¶ç§»åŠ¨åˆ°ç›®æ ‡ç›®å½• mv ç›®å½•å ç›®å½•å ç›®æ ‡ç›®å½•å·²å­˜åœ¨ï¼Œå°†æºç›®å½•ç§»åŠ¨åˆ°ç›®æ ‡ç›®å½•ã€‚ç›®æ ‡ç›®å½•ä¸å­˜åœ¨åˆ™æ”¹å mv ç›®å½•å æ–‡ä»¶å å‡ºé”™ æ–‡ä»¶å±æ€§åŸºæœ¬å±æ€§Linux ç³»ç»Ÿæ˜¯ä¸€ç§å…¸å‹çš„å¤šç”¨æˆ·ç³»ç»Ÿï¼Œä¸åŒçš„ç”¨æˆ·å¤„äºä¸åŒçš„åœ°ä½ï¼Œæ‹¥æœ‰ä¸åŒçš„æƒé™ã€‚ä¸ºäº†ä¿æŠ¤ç³»ç»Ÿçš„å®‰å…¨æ€§ï¼ŒLinuxç³»ç»Ÿå¯¹ä¸åŒçš„ç”¨æˆ·è®¿é—®åŒä¸€æ–‡ä»¶ï¼ˆåŒ…æ‹¬ç›®å½•æ–‡ä»¶ï¼‰çš„æƒé™åšäº†ä¸åŒçš„è§„å®š åœ¨Linuxä¸­ç¬¬ä¸€ä¸ªå­—ç¬¦ä»£è¡¨è¿™ä¸ªæ–‡ä»¶æ˜¯ç›®å½•ã€æ–‡ä»¶æˆ–é“¾æ¥æ–‡ä»¶ç­‰ç­‰ã€‚ å½“ä¸º d åˆ™æ˜¯ç›®å½• å½“ä¸º - åˆ™æ˜¯æ–‡ä»¶ è‹¥æ˜¯ l åˆ™è¡¨ç¤ºä¸ºé“¾æ¥æ–‡æ¡£ link file è‹¥æ˜¯ b åˆ™è¡¨ç¤ºä¸ºè£…ç½®æ–‡ä»¶é‡Œé¢çš„å¯ä¾›å‚¨å­˜çš„æ¥å£è®¾å¤‡(å¯éšæœºå­˜å–è£…ç½®) è‹¥æ˜¯ c åˆ™è¡¨ç¤ºä¸ºè£…ç½®æ–‡ä»¶é‡Œé¢çš„ä¸²è¡Œç«¯å£è®¾å¤‡ï¼Œä¾‹å¦‚é”®ç›˜ã€é¼ æ ‡(ä¸€æ¬¡æ€§è¯»å–è£…ç½®) æ¥ä¸‹æ¥çš„å­—ç¬¦ï¼Œä»¥ä¸‰ä¸ªä¸ºä¸€ç»„ï¼Œå‡ä¸º[rwx] çš„ä¸‰ä¸ªå‚æ•°ç»„åˆã€‚å…¶ä¸­ï¼Œ[ r ]ä»£è¡¨å¯è¯»(read)ã€[ w ]ä»£è¡¨å¯å†™(write)ã€[ x ]ä»£è¡¨å¯æ‰§è¡Œ(execute)ã€‚ è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸‰ä¸ªæƒé™çš„ä½ç½®ä¸ä¼šæ”¹å˜ï¼Œå¦‚æœæ²¡æœ‰æƒé™ï¼Œå°±ä¼šå‡ºç°[ - ]ã€‚ ä»å·¦è‡³å³ç”¨ 0-9 è¿™äº›æ•°å­—æ¥è¡¨ç¤ºï¼š ç¬¬ 0 ä½ç¡®å®šæ–‡ä»¶ç±»å‹ ç¬¬ 1-3 ä½ç¡®å®šå±ä¸»æ‹¥æœ‰è¯¥æ–‡ä»¶çš„æƒé™ ç¬¬ 4-6 ä½ç¡®å®šå±ç»„æ‹¥æœ‰è¯¥æ–‡ä»¶çš„æƒé™ ç¬¬ 7-9 ä½ç¡®å®šå…¶ä»–ç”¨æˆ·æ‹¥æœ‰è¯¥æ–‡ä»¶çš„æƒé™ æ–‡ä»¶ä¿¡æ¯å¯¹äºä¸€ä¸ªæ–‡ä»¶ï¼Œéƒ½æœ‰ä¸€ä¸ªç‰¹å®šçš„æ‰€æœ‰è€…ï¼Œä¹Ÿå°±æ˜¯å¯¹è¯¥æ–‡ä»¶å…·æœ‰æ‰€æœ‰æƒçš„ç”¨æˆ·ï¼ˆå±ä¸»ï¼‰ï¼›è¿˜æœ‰è¿™ä¸ªæ–‡ä»¶æ˜¯å±äºå“ªä¸ªç»„çš„ï¼ˆå±ç»„ï¼‰ æ–‡ä»¶çš„ã€å±ä¸»ã€‘æœ‰ä¸€å¥—ã€è¯»å†™æ‰§è¡Œæƒé™rwxã€‘ æ–‡ä»¶çš„ã€å±ç»„ã€‘æœ‰ä¸€å¥—ã€è¯»å†™æ‰§è¡Œæƒé™rwxã€‘ ls -l å¯ä»¥æŸ¥çœ‹æ–‡ä»¶å¤¹ä¸‹æ–‡ä»¶çš„è¯¦ç»†ä¿¡æ¯, ä»å·¦åˆ°å³ ä¾æ¬¡æ˜¯: æƒé™ï¼ˆA åŒºåŸŸï¼‰ï¼š ç¬¬ä¸€ä¸ªå­—ç¬¦å¦‚æœæ˜¯ d è¡¨ç¤ºç›®å½• ç¡¬é“¾æ¥æ•°ï¼ˆB åŒºåŸŸï¼‰ï¼šé€šä¿—çš„è®²å°±æ˜¯æœ‰å¤šå°‘ç§æ–¹å¼, å¯ä»¥è®¿é—®å½“å‰ç›®å½•å’Œæ–‡ä»¶ å±ä¸»ï¼ˆC åŒºåŸŸï¼‰ï¼šæ–‡ä»¶æ˜¯æ‰€æœ‰è€…ã€æˆ–æ˜¯å«åšå±ä¸» å±ç»„ï¼ˆD åŒºåŸŸï¼‰ï¼š æ–‡ä»¶å±äºå“ªä¸ªç»„ å¤§å°ï¼ˆE åŒºåŸŸï¼‰ï¼šæ–‡ä»¶å¤§å° æ—¶é—´ï¼ˆF åŒºåŸŸï¼‰ï¼šæœ€åä¸€æ¬¡è®¿é—®æ—¶é—´ åç§°ï¼ˆG åŒºåŸŸï¼‰ï¼šæ–‡ä»¶çš„åç§° æ›´æ”¹æƒé™æƒé™æ¦‚è¿°Linux æ–‡ä»¶å±æ€§æœ‰ä¸¤ç§è®¾ç½®æ–¹æ³•ï¼Œä¸€ç§æ˜¯æ•°å­—ï¼Œä¸€ç§æ˜¯ç¬¦å· Linux çš„æ–‡ä»¶è°ƒç”¨æƒé™åˆ†ä¸ºä¸‰çº§ : æ–‡ä»¶å±ä¸»ã€å±ç»„ã€å…¶ä»–ï¼Œåˆ©ç”¨ chmod å¯ä»¥æ§åˆ¶æ–‡ä»¶å¦‚ä½•è¢«ä»–äººæ‰€è°ƒç”¨ã€‚ 12chmod [-cfvR] [--help] [--version] mode file...mode : æƒé™è®¾å®šå­—ä¸²,æ ¼å¼: [ugoa...][[+-=][rwxX]...][,...] u è¡¨ç¤ºæ¡£æ¡ˆçš„æ‹¥æœ‰è€…ï¼Œg è¡¨ç¤ºä¸è¯¥æ¡£æ¡ˆæ‹¥æœ‰è€…å±äºåŒä¸€ä¸ª group è€…ï¼Œo è¡¨ç¤ºå…¶ä»–çš„äººï¼Œa è¡¨ç¤ºè¿™ä¸‰è€…çš†æ˜¯ +è¡¨ç¤ºå¢åŠ æƒé™ã€- è¡¨ç¤ºå–æ¶ˆæƒé™ã€&#x3D; è¡¨ç¤ºå”¯ä¸€è®¾å®šæƒé™ r è¡¨ç¤ºå¯è¯»å–ï¼Œw è¡¨ç¤ºå¯å†™å…¥ï¼Œx è¡¨ç¤ºå¯æ‰§è¡Œï¼ŒX è¡¨ç¤ºåªæœ‰è¯¥æ¡£æ¡ˆæ˜¯ä¸ªå­ç›®å½•æˆ–è€…è¯¥æ¡£æ¡ˆå·²ç»è¢«è®¾å®šè¿‡ä¸ºå¯æ‰§è¡Œ æ•°å­—æƒé™å‘½ä»¤ï¼šchmod [-R] xyz æ–‡ä»¶æˆ–ç›®å½• xyz : å°±æ˜¯åˆšåˆšæåˆ°çš„æ•°å­—ç±»å‹çš„æƒé™å±æ€§ï¼Œä¸º rwx å±æ€§æ•°å€¼çš„ç›¸åŠ  -R : è¿›è¡Œé€’å½’ï¼ˆrecursiveï¼‰çš„æŒç»­å˜æ›´ï¼Œäº¦å³è¿åŒæ¬¡ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶éƒ½ä¼šå˜æ›´ æ–‡ä»¶çš„æƒé™å­—ç¬¦ä¸ºï¼š[-rwxrwxrwx]ï¼Œ è¿™ä¹ä¸ªæƒé™æ˜¯ä¸‰ä¸‰ä¸€ç»„çš„ï¼Œæˆ‘ä»¬ä½¿ç”¨æ•°å­—æ¥ä»£è¡¨å„ä¸ªæƒé™ å„æƒé™çš„æ•°å­—å¯¹ç…§è¡¨ï¼š[r]:4ã€[w]:2ã€[x]:1ã€[-]:0 æ¯ç§èº«ä»½ï¼ˆowner&#x2F;group&#x2F;othersï¼‰çš„ä¸‰ä¸ªæƒé™ï¼ˆr&#x2F;w&#x2F;xï¼‰åˆ†æ•°æ˜¯éœ€è¦ç´¯åŠ çš„ï¼Œä¾‹å¦‚æƒé™ä¸ºï¼š[-rwxrwxâ€”] åˆ†æ•°æ˜¯ owner &#x3D; rwx &#x3D; 4+2+1 &#x3D; 7 group &#x3D; rwx &#x3D; 4+2+1 &#x3D; 7 others&#x3D; â€” &#x3D; 0+0+0 &#x3D; 0 è¡¨ç¤ºä¸ºï¼šchmod -R 770 æ–‡ä»¶å ç¬¦å·æƒé™ user å±ä¸»æƒé™ group å±ç»„æƒé™ others å…¶ä»–æƒé™ all å…¨éƒ¨çš„èº«ä»½ æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ u g o a æ¥ä»£è¡¨èº«ä»½çš„æƒé™ï¼Œè¯»å†™çš„æƒé™å¯ä»¥å†™æˆ r w x chmod u=rwx,g=rx,o=r a.txtï¼šå°†as.txtçš„æƒé™è®¾ç½®ä¸º -rwxr-xrâ€“ chmod a-r a.txtï¼šå°†æ–‡ä»¶çš„æ‰€æœ‰æƒé™å»é™¤ r æ›´æ”¹å±ç»„chgrp å‘½ä»¤ç”¨äºå˜æ›´æ–‡ä»¶æˆ–ç›®å½•çš„æ‰€å±ç¾¤ç»„ æ–‡ä»¶æˆ–ç›®å½•æƒé™çš„çš„æ‹¥æœ‰è€…ç”±æ‰€å±ç¾¤ç»„æ¥ç®¡ç†ï¼Œå¯ä»¥ä½¿ç”¨ chgrp æŒ‡ä»¤å»å˜æ›´æ–‡ä»¶ä¸ç›®å½•çš„æ‰€å±ç¾¤ç»„ 12chgrp [-cfhRv][--help][--version][æ‰€å±ç¾¤ç»„][æ–‡ä»¶æˆ–ç›®å½•...]chgrp [-cfhRv][--help][--reference=&lt;å‚è€ƒæ–‡ä»¶æˆ–ç›®å½•&gt;][--version][æ–‡ä»¶æˆ–ç›®å½•...] chgrp -v root aaaï¼šå°†æ–‡ä»¶ aaa çš„å±ç»„æ›´æ”¹æˆ rootï¼ˆå…¶ä»–ä¹Ÿå¯ä»¥ï¼‰ æ›´æ”¹å±ä¸»åˆ©ç”¨ chown å¯ä»¥å°†æ¡£æ¡ˆçš„æ‹¥æœ‰è€…åŠ ä»¥æ”¹å˜ã€‚ ä½¿ç”¨æƒé™ : ç®¡ç†å‘˜è´¦æˆ· 12chown [â€“R] å±ä¸»å æ–‡ä»¶åchown [-R] å±ä¸»å:å±ç»„å æ–‡ä»¶å chown root aaaï¼šå°†æ–‡ä»¶aaaçš„å±ä¸»æ›´æ”¹æˆroot chown seazean:seazean aaaï¼šå°†æ–‡ä»¶aaaçš„å±ä¸»å’Œå±ç»„æ›´æ”¹ä¸ºseazean æ–‡ä»¶æ“ä½œtouchtouch å‘½ä»¤ç”¨äºåˆ›å»ºæ–‡ä»¶ã€ä¿®æ”¹æ–‡ä»¶æˆ–è€…ç›®å½•çš„æ—¶é—´å±æ€§ï¼ŒåŒ…æ‹¬å­˜å–æ—¶é—´å’Œæ›´æ”¹æ—¶é—´ã€‚è‹¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç³»ç»Ÿä¼šå»ºç«‹ä¸€ä¸ªæ–°çš„æ–‡ä»¶ 1touch [-acfm][-d&lt;æ—¥æœŸæ—¶é—´&gt;][-r&lt;å‚è€ƒæ–‡ä»¶æˆ–ç›®å½•&gt;] [-t&lt;æ—¥æœŸæ—¶é—´&gt;][--help][--version][æ–‡ä»¶æˆ–ç›®å½•â€¦] -a æ”¹å˜æ¡£æ¡ˆçš„è¯»å–æ—¶é—´è®°å½• -m æ”¹å˜æ¡£æ¡ˆçš„ä¿®æ”¹æ—¶é—´è®°å½• -c å‡å¦‚ç›®çš„æ¡£æ¡ˆä¸å­˜åœ¨ï¼Œä¸ä¼šå»ºç«‹æ–°çš„æ¡£æ¡ˆã€‚ä¸ â€“no-create çš„æ•ˆæœä¸€æ · -f ä¸ä½¿ç”¨ï¼Œæ˜¯ä¸ºäº†ä¸å…¶ä»– unix ç³»ç»Ÿçš„ç›¸å®¹æ€§è€Œä¿ç•™ -r ä½¿ç”¨å‚è€ƒæ¡£çš„æ—¶é—´è®°å½•ï¼Œä¸ â€“file çš„æ•ˆæœä¸€æ · -d è®¾å®šæ—¶é—´ä¸æ—¥æœŸï¼Œå¯ä»¥ä½¿ç”¨å„ç§ä¸åŒçš„æ ¼å¼ -t è®¾å®šæ¡£æ¡ˆçš„æ—¶é—´è®°å½•ï¼Œæ ¼å¼ä¸ date æŒ‡ä»¤ç›¸åŒ â€“no-create ä¸ä¼šå»ºç«‹æ–°æ¡£æ¡ˆ â€“help åˆ—å‡ºæŒ‡ä»¤æ ¼å¼ â€“version åˆ—å‡ºç‰ˆæœ¬è®¯æ¯ touch t.txtï¼šåˆ›å»º t.txt æ–‡ä»¶ touch t&#123;1..10&#125;.txtï¼šåˆ›å»º10 ä¸ªåä¸º t1.txt åˆ° t10.txt çš„ç©ºæ–‡ä»¶ touch t.txtï¼šæ›´æ”¹ t.txt çš„è®¿é—®æ—¶é—´ä¸ºç°åœ¨ statstat å‘½ä»¤ç”¨äºæ˜¾ç¤º inode å†…å®¹ å‘½ä»¤ï¼šstat [æ–‡ä»¶æˆ–ç›®å½•] catcat æ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶æŸ¥çœ‹å’Œè¿æ¥å·¥å…·ï¼Œç”¨äºå°æ–‡ä»¶ å‘½ä»¤ï¼šcat [-AbeEnstTuv] [â€“help] [â€“version] Filename -n æ˜¾ç¤ºæ–‡ä»¶åŠ ä¸Šè¡Œå· -b å’Œ -n ç›¸ä¼¼ï¼Œåªä¸è¿‡å¯¹äºç©ºç™½è¡Œä¸ç¼–å· lessless ç”¨äºæŸ¥çœ‹æ–‡ä»¶ï¼Œä½†æ˜¯ less åœ¨æŸ¥çœ‹ä¹‹å‰ä¸ä¼šåŠ è½½æ•´ä¸ªæ–‡ä»¶ï¼Œç”¨äºå¤§æ–‡ä»¶ å‘½ä»¤ï¼šless [options] Filename -N æ˜¾ç¤ºæ¯è¡Œè¡Œå· tailtail å‘½ä»¤å¯ç”¨äºæŸ¥çœ‹æ–‡ä»¶çš„å†…å®¹ï¼Œæœ‰ä¸€ä¸ªå¸¸ç”¨çš„å‚æ•° -f å¸¸ç”¨äºæŸ¥é˜…æ­£åœ¨æ”¹å˜çš„æ—¥å¿—æ–‡ä»¶ å‘½ä»¤ï¼štail [options] Filename -f å¾ªç¯è¯»å–,åŠ¨æ€æ˜¾ç¤ºæ–‡æ¡£çš„æœ€åå†…å®¹ -n æ˜¾ç¤ºæ–‡ä»¶çš„å°¾éƒ¨ n è¡Œå†…å®¹ -c æ˜¾ç¤ºå­—èŠ‚æ•° -nf æŸ¥çœ‹æœ€åå‡ è¡Œæ—¥å¿—ä¿¡æ¯ tail -f filenameï¼šåŠ¨æ€æ˜¾ç¤ºæœ€å°¾éƒ¨çš„å†…å®¹ tail -n +2 txtfile.txtï¼šæ˜¾ç¤ºæ–‡ä»¶ txtfile.txt çš„å†…å®¹ï¼Œä»ç¬¬ 2 è¡Œè‡³æ–‡ä»¶æœ«å°¾ tail -n 2 txtfile.txtï¼šæ˜¾ç¤ºæ–‡ä»¶ txtfile.txt çš„å†…å®¹ï¼Œæœ€å 2 è¡Œ headhead å‘½ä»¤å¯ç”¨äºæŸ¥çœ‹æ–‡ä»¶çš„å¼€å¤´éƒ¨åˆ†çš„å†…å®¹ï¼Œæœ‰ä¸€ä¸ªå¸¸ç”¨çš„å‚æ•° -n ç”¨äºæ˜¾ç¤ºè¡Œæ•°ï¼Œé»˜è®¤ä¸º 10 -q éšè—æ–‡ä»¶å -v æ˜¾ç¤ºæ–‡ä»¶å -c æ˜¾ç¤ºçš„å­—èŠ‚æ•° -n æ˜¾ç¤ºçš„è¡Œæ•° head -n Filenameï¼šæŸ¥çœ‹æ–‡ä»¶çš„å‰ä¸€éƒ¨åˆ† head -n 20 Filenameï¼šæŸ¥çœ‹æ–‡ä»¶çš„å‰ 20 è¡Œ grepgrep æŒ‡ä»¤ç”¨äºæŸ¥æ‰¾å†…å®¹åŒ…å«æŒ‡å®šçš„èŒƒæœ¬æ ·å¼çš„æ–‡ä»¶ï¼Œè‹¥ä¸æŒ‡å®šä»»ä½•æ–‡ä»¶åç§°ï¼Œæˆ–æ˜¯æ‰€ç»™äºˆçš„æ–‡ä»¶åä¸º -ï¼Œåˆ™ grep æŒ‡ä»¤ä¼šä»æ ‡å‡†è¾“å…¥è®¾å¤‡è¯»å–æ•°æ® 1grep [-abcEFGhHilLnqrsvVwxy][-A&lt;æ˜¾ç¤ºåˆ—æ•°&gt;][-B&lt;æ˜¾ç¤ºåˆ—æ•°&gt;][-C&lt;æ˜¾ç¤ºåˆ—æ•°&gt;][-d&lt;è¿›è¡ŒåŠ¨ä½œ&gt;][-e&lt;èŒƒæœ¬æ ·å¼&gt;][-f&lt;èŒƒæœ¬æ–‡ä»¶&gt;][--help][èŒƒæœ¬æ ·å¼][æ–‡ä»¶æˆ–ç›®å½•...] -c åªè¾“å‡ºåŒ¹é…è¡Œçš„è®¡æ•° -i ä¸åŒºåˆ†å¤§å°å†™ -h æŸ¥è¯¢å¤šæ–‡ä»¶æ—¶ä¸æ˜¾ç¤ºæ–‡ä»¶å -l æŸ¥è¯¢å¤šæ–‡ä»¶æ—¶åªè¾“å‡ºåŒ…å«åŒ¹é…å­—ç¬¦çš„æ–‡ä»¶å -n æ˜¾ç¤ºåŒ¹é…è¡ŒåŠè¡Œå· -s ä¸æ˜¾ç¤ºä¸å­˜åœ¨æˆ–æ— åŒ¹é…æ–‡æœ¬çš„é”™è¯¯ä¿¡æ¯ -v æ˜¾ç¤ºä¸åŒ…å«åŒ¹é…æ–‡æœ¬çš„æ‰€æœ‰è¡Œ â€“color&#x3D;auto å¯ä»¥å°†æ‰¾åˆ°çš„å…³é”®è¯éƒ¨åˆ†åŠ ä¸Šé¢œè‰²çš„æ˜¾ç¤º **ç®¡é“ç¬¦ |**ï¼šè¡¨ç¤ºå°†å‰ä¸€ä¸ªå‘½ä»¤å¤„ç†çš„ç»“æœä¼ é€’ç»™åé¢çš„å‘½ä»¤å¤„ç† grep aaaa Filename ï¼šæ˜¾ç¤ºå­˜åœ¨å…³é”®å­— aaaa çš„è¡Œ grep -n aaaa Filenameï¼šæ˜¾ç¤ºå­˜åœ¨å…³é”®å­— aaaa çš„è¡Œï¼Œä¸”æ˜¾ç¤ºè¡Œå· grep -i aaaa Filenameï¼šå¿½ç•¥å¤§å°å†™ï¼Œæ˜¾ç¤ºå­˜åœ¨å…³é”®å­— aaaa çš„è¡Œ grep -v aaaa Filenameï¼šæ˜¾ç¤ºå­˜åœ¨å…³é”®å­— aaaa çš„æ‰€æœ‰è¡Œ ps -ef | grep sshdï¼šæŸ¥æ‰¾åŒ…å« sshd è¿›ç¨‹çš„è¿›ç¨‹ä¿¡æ¯ ps -ef | grep -c sshdï¼šæŸ¥æ‰¾ sshd ç›¸å…³çš„è¿›ç¨‹ä¸ªæ•° echoå°†å­—ç¬¦ä¸²è¾“å‡ºåˆ°æ§åˆ¶å° , é€šå¸¸å’Œé‡å®šå‘è”åˆä½¿ç”¨ å‘½ä»¤ï¼šecho stringï¼Œå¦‚æœå­—ç¬¦ä¸²æœ‰ç©ºæ ¼, ä¸ºäº†é¿å…æ­§ä¹‰ è¯·å¢åŠ  åŒå¼•å· æˆ–è€… å•å¼•å· é€šè¿‡ å‘½ä»¤ &gt; æ–‡ä»¶ å°†å‘½ä»¤çš„æˆåŠŸç»“æœè¦†ç›–æŒ‡å®šæ–‡ä»¶å†…å®¹ é€šè¿‡ å‘½ä»¤ &gt;&gt; æ–‡ä»¶ å°†å‘½ä»¤çš„æˆåŠŸç»“æœè¿½åŠ æŒ‡å®šæ–‡ä»¶çš„åé¢ é€šè¿‡ å‘½ä»¤ &amp;&gt;&gt; æ–‡ä»¶ å°† å‘½ä»¤çš„å¤±è´¥ç»“æœè¿½åŠ æŒ‡å®šæ–‡ä»¶çš„åé¢ echo &quot;ç¨‹åºå‘˜&quot; &gt;&gt; a.txtï¼šå°†ç¨‹åºå‘˜è¿½åŠ åˆ° a.txt åé¢ cat ä¸å­˜åœ¨çš„ç›®å½• &amp;&gt;&gt; error.logï¼šå°†é”™è¯¯ä¿¡æ¯è¿½åŠ åˆ° error.log æ–‡ä»¶ awkAWK æ˜¯ä¸€ç§å¤„ç†æ–‡æœ¬æ–‡ä»¶çš„è¯­è¨€ï¼Œæ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ–‡æœ¬åˆ†æå·¥å…· 12awk [options] &#x27;script&#x27; var=value file(s)awk [options] -f scriptfile var=value file(s) -F fsï¼šæŒ‡å®šè¾“å…¥æ–‡ä»¶æŠ˜åˆ†éš”ç¬¦ï¼Œfs æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–è€…æ˜¯ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ -vï¼švar&#x3D;value èµ‹å€¼ä¸€ä¸ªç”¨æˆ·å®šä¹‰å˜é‡ -fï¼šä»è„šæœ¬æ–‡ä»¶ä¸­è¯»å– awk å‘½ä»¤ $nï¼šè·å–ç¬¬å‡ æ®µå†…å®¹ $0ï¼šè·å–å½“å‰è¡Œ å†…å®¹ NFï¼šè¡¨ç¤ºå½“å‰è¡Œå…±æœ‰å¤šå°‘ä¸ªå­—æ®µ $NFï¼šä»£è¡¨æœ€åä¸€ä¸ªå­—æ®µ $(NF-1)ï¼šä»£è¡¨å€’æ•°ç¬¬äºŒä¸ªå­—æ®µ NRï¼šä»£è¡¨å¤„ç†çš„æ˜¯ç¬¬å‡ è¡Œ 123å‘½ä»¤ï¼šawk &#x27;BEGIN&#123;åˆå§‹åŒ–æ“ä½œ&#125;&#123;æ¯è¡Œéƒ½æ‰§è¡Œ&#125; END&#123;ç»“æŸæ—¶æ“ä½œ&#125;&#x27; æ–‡ä»¶åBEGIN&#123; è¿™é‡Œé¢æ”¾çš„æ˜¯æ‰§è¡Œå‰çš„è¯­å¥ &#125;&#123;è¿™é‡Œé¢æ”¾çš„æ˜¯å¤„ç†æ¯ä¸€è¡Œæ—¶è¦æ‰§è¡Œçš„è¯­å¥&#125;END &#123;è¿™é‡Œé¢æ”¾çš„æ˜¯å¤„ç†å®Œæ‰€æœ‰çš„è¡Œåè¦æ‰§è¡Œçš„è¯­å¥ &#125; 1234567//å‡†å¤‡æ•°æ®zhangsan 68 99 26lisi 98 66 96wangwu 38 33 86zhaoliu 78 44 36maq 88 22 66zhouba 98 44 46 cat a.txt | awk &#39;/zhang|li/&#39;ï¼šæœç´¢å«æœ‰ zhang å’Œ li çš„å­¦ç”Ÿæˆç»© awk &quot;/zhang|li/&quot; a.txt ï¼šåŒä¸Šä¸€ä¸ªå‘½ä»¤ï¼Œæ•ˆæœä¸€æ · 123zhangsan 68 99 26lisi 98 66 96zhaoliu 78 44 36 cat a.txt | awk -F &#39; &#39; &#39;&#123;print $1,$2,$3&#125;&#39;ï¼šæŒ‰ç…§ç©ºæ ¼åˆ†å‰²ï¼Œæ‰“å° ä¸€äºŒä¸‰åˆ—å†…å®¹ awk -F &#39; &#39; &#39;&#123;OFS=&quot;\\t&quot;&#125;&#123;print $1,$2,$3&#125;&#39;ï¼šæŒ‰ç…§åˆ¶è¡¨ç¬¦ tab è¿›è¡Œåˆ†å‰²ï¼Œæ‰“å°ä¸€äºŒä¸‰åˆ—\\bï¼šé€€æ ¼ \\fï¼šæ¢é¡µ \\nï¼šæ¢è¡Œ \\rï¼šå›è½¦ \\tï¼šåˆ¶è¡¨ç¬¦ 123456zhangsan 68 99lisi 98 66wangwu 38 33zhaoliu 78 44maq 88 22zhouba 98 44 awk -F &#39;,&#39; &#39;&#123;print toupper($1)&#125;&#39; a.txtï¼šæ ¹æ®é€—å·åˆ†å‰²ï¼Œæ‰“å°å†…å®¹ï¼Œç¬¬ä¸€æ®µå¤§å†™ å‡½æ•°å å«ä¹‰ ä½œç”¨ toupper() upper å­—ç¬¦ è½¬æˆ å¤§å†™ tolower() lower å­—ç¬¦ è½¬æˆå°å†™ length() length è¿”å› å­—ç¬¦é•¿åº¦ awk -F &#39; &#39; &#39;BEGIN&#123;&#125;&#123;total=total+$4&#125; END&#123;print total&#125;&#39; a.txtï¼šè®¡ç®—çš„æ˜¯ç¬¬4åˆ—çš„æ€»åˆ† awk -F &#39; &#39; &#39;BEGIN&#123;&#125;&#123;total=total+$4&#125; END&#123;print total, NR&#125;&#39; a.txt ï¼šæŸ¥çœ‹æ€»åˆ†, æ€»äººæ•° awk -F &#39; &#39; &#39;BEGIN&#123;&#125;&#123;total=total+$4&#125; END&#123;print total, NR, (total/NR)&#125;&#39; a.txtï¼šæŸ¥çœ‹æ€»åˆ†, æ€»äººæ•°ï¼Œå¹³å‡æ•° cat a.txt | awk -F &#39; &#39; &#39;BEGIN&#123;&#125;&#123;total=total+$4&#125; END&#123;print total&#125;&#39; ï¼šå¯ä»¥è¿™æ ·å†™ findfind å‘½ä»¤ç”¨æ¥åœ¨æŒ‡å®šç›®å½•ä¸‹æŸ¥æ‰¾æ–‡ä»¶ï¼Œå¦‚æœä½¿ç”¨è¯¥å‘½ä»¤ä¸è®¾ç½®ä»»ä½•å‚æ•°ï¼Œå°†åœ¨å½“å‰ç›®å½•ä¸‹æŸ¥æ‰¾å­ç›®å½•ä¸æ–‡ä»¶ï¼Œå¹¶ä¸”å°†æŸ¥æ‰¾åˆ°çš„å­ç›®å½•å’Œæ–‡ä»¶å…¨éƒ¨è¿›è¡Œæ˜¾ç¤º å‘½ä»¤ï¼šfind &lt;æŒ‡å®šç›®å½•&gt; &lt;æŒ‡å®šæ¡ä»¶&gt; &lt;æŒ‡å®šå†…å®¹&gt; find . -name &quot;*.gz&quot;ï¼šå°†ç›®å‰ç›®å½•åŠå…¶å­ç›®å½•ä¸‹æ‰€æœ‰å»¶ä¼¸æ¡£åæ˜¯ gz çš„æ–‡ä»¶æŸ¥è¯¢å‡ºæ¥ find . -ctime -1ï¼šå°†ç›®å‰ç›®å½•åŠå…¶å­ç›®å½•ä¸‹æ‰€æœ‰æœ€è¿‘ 1 å¤©å†…æ›´æ–°è¿‡çš„æ–‡ä»¶æŸ¥è¯¢å‡ºæ¥ find / -name &#39;seazean&#39;ï¼šå…¨å±€æœç´¢ seazean readread å‘½ä»¤ç”¨äºä»æ ‡å‡†è¾“å…¥è¯»å–æ•°å€¼ 1read [-ers] [-a aname] [-d delim] [-i text] [-n nchars] [-N nchars] [-p prompt] [-t timeout] [-u fd] [name ...] sortLinux sort å‘½ä»¤ç”¨äºå°†æ–‡æœ¬æ–‡ä»¶å†…å®¹åŠ ä»¥æ’åº 1sort [-bcdfimMnr][æ–‡ä»¶] -n ä¾ç…§æ•°å€¼çš„å¤§å°æ’åº -r ä»¥ç›¸åçš„é¡ºåºæ¥æ’åºï¼ˆsort é»˜è®¤çš„æ’åºæ–¹å¼æ˜¯å‡åºï¼Œæ”¹æˆé™åºï¼ŒåŠ  -rï¼‰ -u å»æ‰é‡å¤ é¢è¯•é¢˜ï¼šä¸€åˆ—æ•°å­—ï¼Œè¾“å‡ºæœ€å¤§çš„ 4 ä¸ªä¸é‡å¤çš„æ•° 12sort -ur a.txt | head -n 4sort -r a.txt | uniq | head -n 4 uniquniq ç”¨äºé‡å¤æ•°æ®å¤„ç†ï¼Œä½¿ç”¨å‰å…ˆ sort æ’åº 1uniq [OPTION]... [INPUT [OUTPUT]] -c åœ¨æ•°æ®è¡Œå‰å‡ºç°çš„æ¬¡æ•° -d åªæ‰“å°é‡å¤çš„è¡Œï¼Œé‡å¤çš„è¡Œåªæ˜¾ç¤ºä¸€æ¬¡ -D åªæ‰“å°é‡å¤çš„è¡Œï¼Œé‡å¤çš„è¡Œå‡ºç°å¤šå°‘æ¬¡å°±æ˜¾ç¤ºå¤šå°‘æ¬¡ -f å¿½ç•¥è¡Œé¦–çš„å‡ ä¸ªå­—æ®µ -i å¿½ç•¥å¤§å°å†™ -s å¿½ç•¥è¡Œé¦–çš„å‡ ä¸ªå­—æ¯ -u åªæ‰“å°å”¯ä¸€çš„è¡Œ -w æ¯”è¾ƒä¸è¶…è¿‡ n ä¸ªå­—æ¯ æ–‡ä»¶å‹ç¼©tartar çš„ä¸»è¦åŠŸèƒ½æ˜¯æ‰“åŒ…ã€å‹ç¼©å’Œè§£å‹æ–‡ä»¶ï¼Œtar æœ¬èº«ä¸å…·æœ‰å‹ç¼©åŠŸèƒ½ï¼Œæ˜¯è°ƒç”¨å‹ç¼©åŠŸèƒ½å®ç°çš„ã€‚ å‘½ä»¤ï¼štar [å¿…è¦å‚æ•°] [é€‰æ‹©å‚æ•°] [æ–‡ä»¶] -c äº§ç”Ÿ .tar æ–‡ä»¶ -v æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ -z æ‰“åŒ…åŒæ—¶å‹ç¼© -f æŒ‡å®šå‹ç¼©åçš„æ–‡ä»¶å -x è§£å‹ .tar æ–‡ä»¶ -t åˆ—å‡º tar æ–‡ä»¶ä¸­åŒ…å«çš„æ–‡ä»¶çš„ä¿¡æ¯ -r é™„åŠ æ–°çš„æ–‡ä»¶åˆ°taræ–‡ä»¶ä¸­ tar -cvf txt.tar txtfile.txt ï¼šå°† txtfile.txt æ–‡ä»¶æ‰“åŒ…ï¼ˆä»…æ‰“åŒ…ï¼Œä¸å‹ç¼©ï¼‰ tar -zcvf combine.tar.gz 1.txt 2.txt 3.txtï¼šå°† 123.txt æ–‡ä»¶æ‰“åŒ…å‹ç¼©ï¼ˆgzipï¼‰ tar -ztvf txt.tar.gzï¼šæŸ¥çœ‹ tar ä¸­æœ‰å“ªäº›æ–‡ä»¶ tar -zxvf Filename -C ç›®æ ‡è·¯å¾„ï¼šè§£å‹ gzipgzipå‘½ä»¤ç”¨äºå‹ç¼©æ–‡ä»¶ã€‚ gzipæ˜¯ä¸ªä½¿ç”¨å¹¿æ³›çš„å‹ç¼©ç¨‹åºï¼Œæ–‡ä»¶ç»å®ƒå‹ç¼©è¿‡åï¼Œå…¶åç§°åé¢ä¼šå¤šå‡ºâ€.gzâ€çš„æ‰©å±•å gzip * ï¼šå‹ç¼©ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œåˆ é™¤æºæ–‡ä»¶ã€‚ä¸æ”¯æŒç›´æ¥å‹ç¼©ç›®å½• gzip -rv ç›®å½•åï¼šé€’å½’å‹ç¼©ç›®å½• gzip -dv *ï¼šè§£å‹æ–‡ä»¶å¹¶åˆ—å‡ºè¯¦ç»†ä¿¡æ¯ gunzipgunzipå‘½ä»¤ç”¨äºè§£å‹æ–‡ä»¶ã€‚ç”¨äºè§£å¼€è¢«gzipå‹ç¼©è¿‡çš„æ–‡ä»¶ å‘½ä»¤ï¼šgunzip [options] [æ–‡ä»¶æˆ–è€…ç›®å½•] gunzip 001.gz ï¼šè§£å‹001.gzæ–‡ä»¶ zipzip å‘½ä»¤ç”¨äºå‹ç¼©æ–‡ä»¶ã€‚ zip æ˜¯ä¸ªä½¿ç”¨å¹¿æ³›çš„å‹ç¼©ç¨‹åºï¼Œæ–‡ä»¶ç»å®ƒå‹ç¼©åä¼šå¦å¤–äº§ç”Ÿå…·æœ‰ .zip æ‰©å±•åçš„å‹ç¼©æ–‡ä»¶ å‘½ä»¤ï¼šzip [å¿…è¦å‚æ•°] [é€‰æ‹©å‚æ•°] [æ–‡ä»¶] -q ä¸æ˜¾ç¤ºæŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹ -r é€’å½’å¤„ç†ï¼Œå°†æŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å’Œå­ç›®å½•ä¸€å¹¶å¤„ç† zip -q -r z.zip *ï¼šå°†è¯¥ç›®å½•çš„æ–‡ä»¶å…¨éƒ¨å‹ç¼© unzipunzip å‘½ä»¤ç”¨äºè§£å‹ç¼© zip æ–‡ä»¶ï¼Œunzip ä¸º .zip å‹ç¼©æ–‡ä»¶çš„è§£å‹ç¼©ç¨‹åº å‘½ä»¤ï¼šunzip [å¿…è¦å‚æ•°] [é€‰æ‹©å‚æ•°] [æ–‡ä»¶] -l æŸ¥çœ‹å‹ç¼©æ–‡ä»¶å†…æ‰€åŒ…å«çš„æ–‡ä»¶ -d&lt;ç›®å½•&gt; æŒ‡å®šæ–‡ä»¶è§£å‹ç¼©åæ‰€è¦å­˜å‚¨çš„ç›®å½•ã€‚ unzip -l z.zip ï¼šæŸ¥çœ‹å‹ç¼©æ–‡ä»¶ä¸­åŒ…å«çš„æ–‡ä»¶ unzip -d ./unFiles z.zipï¼šæŠŠæ–‡ä»¶è§£å‹åˆ°æŒ‡å®šçš„ç›®å½•ä¸‹ bzip2bzip2 å‘½ä»¤æ˜¯ .bz2 æ–‡ä»¶çš„å‹ç¼©ç¨‹åºã€‚ bzip2 é‡‡ç”¨æ–°çš„å‹ç¼©æ¼”ç®—æ³•ï¼Œå‹ç¼©æ•ˆæœæ¯”ä¼ ç»Ÿçš„ LZ77&#x2F;LZ78 å‹ç¼©æ¼”ç®—æ³•å¥½ï¼Œè‹¥ä¸åŠ ä»»ä½•å‚æ•°ï¼Œbzip2 å‹ç¼©å®Œæ–‡ä»¶åä¼šäº§ç”Ÿ .bz2 çš„å‹ç¼©æ–‡ä»¶ï¼Œå¹¶åˆ é™¤åŸå§‹çš„æ–‡ä»¶ 1bzip2 [-cdfhkLstvVz][--repetitive-best][--repetitive-fast][- å‹ç¼©ç­‰çº§][è¦å‹ç¼©çš„æ–‡ä»¶] å‹ç¼©ï¼šbzip2 a.txt bunzip2bunzip2 å‘½ä»¤æ˜¯ .bz2 æ–‡ä»¶çš„è§£å‹ç¼©ç¨‹åºã€‚ å‘½ä»¤ï¼šbunzip2 [-fkLsvV] [.bz2å‹ç¼©æ–‡ä»¶] -v è§£å‹ç¼©æ–‡ä»¶æ—¶ï¼Œæ˜¾ç¤ºè¯¦ç»†çš„ä¿¡æ¯ã€‚ è§£å‹ï¼šbunzip2 -v a.bz2 æ–‡ä»¶ç¼–è¾‘Vimvimï¼šæ˜¯ä» vi å‘å±•å‡ºæ¥çš„ä¸€ä¸ªæ–‡æœ¬ç¼–è¾‘å™¨ å‘½ä»¤æ¨¡å¼ï¼šåœ¨ Linux ç»ˆç«¯ä¸­è¾“å…¥vim æ–‡ä»¶å å°±è¿›å…¥äº†å‘½ä»¤æ¨¡å¼ï¼Œä½†ä¸èƒ½è¾“å…¥æ–‡å­— ç¼–è¾‘æ¨¡å¼ï¼šåœ¨å‘½ä»¤æ¨¡å¼ä¸‹æŒ‰ i å°±ä¼šè¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼Œæ­¤æ—¶å¯ä»¥å†™å…¥ç¨‹å¼ï¼ŒæŒ‰ Esc å¯å›åˆ°å‘½ä»¤æ¨¡å¼ æœ«è¡Œæ¨¡å¼ï¼šåœ¨å‘½ä»¤æ¨¡å¼ä¸‹æŒ‰ : è¿›å…¥æœ«è¡Œæ¨¡å¼ï¼Œå·¦ä¸‹è§’ä¼šæœ‰ä¸€ä¸ªå†’å·ï¼Œå¯ä»¥æ•²å…¥å‘½ä»¤å¹¶æ‰§è¡Œ æ‰“å¼€æ–‡ä»¶Ubuntu é»˜è®¤æ²¡æœ‰å®‰è£… vimï¼Œéœ€è¦å…ˆå®‰è£… vimï¼Œå®‰è£…å‘½ä»¤ï¼šsudo apt-get install vim Vim æœ‰ä¸‰ç§æ¨¡å¼ï¼šå‘½ä»¤æ¨¡å¼ï¼ˆCommand modeï¼‰ã€æ’å…¥æ¨¡å¼ï¼ˆInsert modeï¼‰ã€æœ«è¡Œæ¨¡å¼ï¼ˆLast Line modeï¼‰ Vim ä½¿ç”¨çš„é€‰é¡¹ è¯´æ˜ å¸¸ç”¨ vim filename æ‰“å¼€æˆ–æ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œå°†å…‰æ ‡ç½®äºç¬¬ä¸€è¡Œé¦–éƒ¨ å¸¸ç”¨ vim -r filename æ¢å¤ä¸Šæ¬¡vimæ‰“å¼€æ—¶å´©æºƒçš„æ–‡ä»¶ vim -R filename æŠŠæŒ‡å®šçš„æ–‡ä»¶ä»¥åªè¯»çš„æ–¹å¼æ”¾å…¥Vimç¼–è¾‘å™¨ vim + filename æ‰“å¼€æ–‡ä»¶ï¼Œå°†å…‰æ ‡ç½®äºæœ€åä¸€è¡Œçš„é¦–éƒ¨ å¸¸ç”¨ vim +n filename æ‰“å¼€æ–‡ä»¶ï¼Œå°†å…‰æ ‡ç½®äºnè¡Œçš„é¦–éƒ¨ å¸¸ç”¨ vim +&#x2F;pattern filename æ‰“å¼€æ–‡ä»¶ï¼Œå°†å…‰æ ‡ç½®äºç¬¬ä¸€ä¸ªä¸patternåŒ¹é…çš„ä½ç½® vim -c command filename å¯¹æ–‡ä»¶ç¼–è¾‘å‰ï¼Œå…ˆæ‰§è¡ŒæŒ‡å®šçš„å‘½ä»¤ æ’å…¥æ¨¡å¼åœ¨å‘½ä»¤æ¨¡å¼ä¸‹ï¼Œé€šè¿‡æŒ‰ä¸‹ iã€Iã€aã€Aã€oã€O è¿™ 6 ä¸ªå­—æ¯è¿›å…¥æ’å…¥æ¨¡å¼ å¿«æ·é”® åŠŸèƒ½æè¿° i åœ¨å…‰æ ‡æ‰€åœ¨ä½ç½®æ’å…¥æ–‡æœ¬ï¼Œå…‰æ ‡åçš„æ–‡æœ¬å‘å³ç§»åŠ¨ I åœ¨å…‰æ ‡æ‰€åœ¨è¡Œçš„è¡Œé¦–æ’å…¥æ–‡æœ¬ï¼Œè¡Œé¦–æ˜¯è¯¥è¡Œçš„ç¬¬ä¸€ä¸ªéç©ºç™½å­—ç¬¦ o åœ¨å…‰æ ‡æ‰€åœ¨è¡Œçš„ä¸‹é¢æ’å…¥æ–°çš„ä¸€è¡Œï¼Œå…‰æ ‡åœåœ¨ç©ºè¡Œé¦– O åœ¨å…‰æ ‡æ‰€åœ¨è¡Œçš„ä¸Šé¢æ’å…¥æ–°çš„ä¸€è¡Œï¼Œå…‰æ ‡åœåœ¨ç©ºè¡Œé¦– a åœ¨å…‰æ ‡æ‰€åœ¨ä½ç½®ä¹‹åæ’å…¥æ–‡æœ¬ A åœ¨å…‰æ ‡æ‰€åœ¨è¡Œçš„è¡Œå°¾æ’å…¥æ–‡æœ¬ æŒ‰ä¸‹ ESC é”®ï¼Œç¦»å¼€æ’å…¥æ¨¡å¼ï¼Œè¿›å…¥å‘½ä»¤æ¨¡å¼ å› ä¸ºæˆ‘ä»¬æ˜¯ä¸€ä¸ªç©ºæ–‡ä»¶ï¼Œæ‰€ä»¥ä½¿ç”¨ã€Iã€‘æˆ–è€…ã€iã€‘éƒ½å¯ä»¥ å¦‚æœé‡Œé¢çš„æ–‡æœ¬å¾ˆå¤šï¼Œè¦ä½¿ç”¨ã€Aã€‘è¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼Œå³åœ¨è¡Œæœ«æ·»åŠ æ–‡æœ¬ å‘½ä»¤æ¨¡å¼Vim æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼ˆæ–‡ä»¶å¯ä»¥å­˜åœ¨ï¼Œä¹Ÿå¯ä»¥ä¸å­˜åœ¨ï¼‰ï¼Œé»˜è®¤è¿›å…¥å‘½ä»¤æ¨¡å¼ã€‚åœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œ è¾“å…¥çš„å­—ç¬¦ä¼šè¢«å½“åšæŒ‡ä»¤ï¼Œè€Œä¸ä¼šè¢«å½“åšè¦è¾“å…¥çš„æ–‡å­— ç§»åŠ¨å…‰æ ‡ å¿«æ·é”® åŠŸèƒ½æè¿° w å…‰æ ‡ç§»åŠ¨è‡³ä¸‹ä¸€ä¸ªå•è¯çš„å•è¯é¦– b å…‰æ ‡ç§»åŠ¨è‡³ä¸Šä¸€ä¸ªå•è¯çš„å•è¯é¦– e å…‰æ ‡ç§»åŠ¨è‡³ä¸‹ä¸€ä¸ªå•è¯çš„å•è¯å°¾ 0 å…‰æ ‡ç§»åŠ¨è‡³å½“å‰è¡Œçš„è¡Œé¦– ^ è¡Œé¦–, ç¬¬ä¸€ä¸ªä¸æ˜¯ç©ºç™½å­—ç¬¦çš„ä½ç½® $ å…‰æ ‡ç§»åŠ¨è‡³å½“å‰è¡Œçš„è¡Œå°¾ gg å…‰æ ‡ç§»åŠ¨è‡³æ–‡ä»¶å¼€å¤´ G å…‰æ ‡ç§»åŠ¨è‡³æ–‡ä»¶æœ«å°¾ ngg å…‰æ ‡ç§»åŠ¨è‡³ç¬¬nè¡Œ nG å…‰æ ‡ç§»åŠ¨è‡³ç¬¬nè¡Œ :n å…‰æ ‡ç§»åŠ¨è‡³ç¬¬nè¡Œ é€‰ä¸­æ–‡æœ¬åœ¨ vi&#x2F;vim ä¸­è¦é€‰æ‹©æ–‡æœ¬ï¼Œéœ€è¦æ˜¾ç¤º visual å‘½ä»¤åˆ‡æ¢åˆ°å¯è§†æ¨¡å¼ vi&#x2F;vim ä¸­æä¾›äº†ä¸‰ç§å¯è§†æ¨¡å¼ï¼Œæ–¹ä¾¿ç¨‹åºå‘˜çš„é€‰æ‹©é€‰ä¸­æ–‡æœ¬çš„æ–¹å¼ æŒ‰ ESC å¯ä»¥æ”¾å¼ƒé€‰ä¸­, è¿”å›åˆ°å‘½ä»¤æ¨¡å¼ å‘½ä»¤ æ¨¡å¼ åŠŸèƒ½ v å¯è§†æ¨¡å¼ ä»å…‰æ ‡ä½ç½®å¼€å§‹æŒ‰ç…§æ­£å¸¸æ¨¡å¼é€‰æ‹©æ–‡æœ¬ V å¯è§†åŒ–æ¨¡å¼ é€‰ä¸­å…‰æ ‡ç»è¿‡çš„å®Œæ•´è¡Œ Ctrl + v å¯æ˜¯å—æ¨¡å¼ å‚ç›´æ–¹å‘é€‰ä¸­æ–‡æœ¬ æ’¤é”€åˆ é™¤åœ¨å­¦ä¹ ç¼–è¾‘å‘½ä»¤ä¹‹å‰,å…ˆè¦çŸ¥é“æ€æ ·æ’¤é”€ä¹‹å‰ä¸€æ¬¡é”™è¯¯çš„ç¼–è¾‘æ“ä½œ å‘½ä»¤ è‹±æ–‡ åŠŸèƒ½ u undo æ’¤é”€ä¸Šæ¬¡çš„å‘½ä»¤(ctrl + z) Ctrl + r uredo æ¢å¤æ’¤é”€çš„å‘½ä»¤ åˆ é™¤çš„å†…å®¹æ­¤æ—¶å¹¶æ²¡æœ‰çœŸæ­£çš„è¢«åˆ é™¤ï¼Œåœ¨å‰ªåˆ‡æ¿ä¸­ï¼ŒæŒ‰ä¸‹ p é”®ï¼Œå¯ä»¥å°†åˆ é™¤çš„å†…å®¹ç²˜è´´å›æ¥ å¿«æ·é”® åŠŸèƒ½æè¿° x åˆ é™¤å…‰æ ‡æ‰€åœ¨ä½ç½®çš„å­—ç¬¦ d åˆ é™¤ç§»åŠ¨å‘½ä»¤å¯¹åº”çš„å†…å®¹ dd åˆ é™¤å…‰æ ‡æ‰€åœ¨è¡Œçš„å†…å®¹ D åˆ é™¤å…‰æ ‡ä½ç½®åˆ°è¡Œå°¾çš„å†…å®¹ :n1,n2 åˆ é™¤ä» a1 åˆ° a2 è¡Œçš„æ–‡æœ¬å†…å®¹ åˆ é™¤å‘½ä»¤å¯ä»¥å’Œç§»åŠ¨å‘½ä»¤è¿ç”¨, ä»¥ä¸‹æ˜¯å¸¸è§çš„ç»„åˆå‘½ä»¤(æ‰©å±•): å‘½ä»¤ ä½œç”¨ dw åˆ é™¤ä»å…‰æ ‡ä½ç½®åˆ°å•è¯æœ«å°¾ d} åˆ é™¤ä»å…‰æ ‡ä½ç½®åˆ°æ®µè½æœ«å°¾ dG åˆ é™¤å…‰æ ‡æ‰€è¡Œåˆ°æ–‡ä»¶æœ«å°¾çš„æ‰€æœ‰å†…å®¹ ndd åˆ é™¤å½“å‰è¡Œï¼ˆåŒ…æ‹¬æ­¤è¡Œï¼‰åˆ°å n è¡Œå†…å®¹ å¤åˆ¶ç²˜è´´vim ä¸­æä¾›æœ‰ä¸€ä¸ª è¢«å¤åˆ¶æ–‡æœ¬çš„ç¼“å†²åŒº å¤åˆ¶å‘½ä»¤ä¼šå°†é€‰ä¸­çš„æ–‡å­—ä¿å­˜åœ¨ç¼“å†²åŒº åˆ é™¤å‘½ä»¤åˆ é™¤çš„æ–‡å­—ä¼šè¢«ä¿å­˜åœ¨ç¼“å†²åŒº åœ¨éœ€è¦çš„ä½ç½®ï¼Œä½¿ç”¨ç²˜è´´å‘½ä»¤å¯ä»¥å°†ç¼“å†²å¯¹çš„æ–‡å­—æ’å…¥åˆ°å…‰æ ‡æ‰€åœ¨çš„ä½ç½® vim ä¸­çš„æ–‡æœ¬ç¼“å†²åŒºåªæœ‰ä¸€ä¸ªï¼Œå¦‚æœåç»­åšè¿‡å¤åˆ¶ã€å‰ªåˆ‡æ“ä½œï¼Œä¹‹å‰ç¼“å†²åŒºä¸­çš„å†…å®¹ä¼šè¢«æ›¿æ¢ å¿«æ·é”® åŠŸèƒ½æè¿° y å¤åˆ¶å·²é€‰ä¸­çš„æ–‡æœ¬åˆ°å‰ªåˆ‡æ¿ yy å°†å…‰æ ‡æ‰€åœ¨è¡Œå¤åˆ¶åˆ°å‰ªåˆ‡æ¿ nyy å¤åˆ¶ä»å…‰æ ‡æ‰€åœ¨è¡Œåˆ°å‘ä¸‹nè¡Œ p å°†å‰ªåˆ‡æ¿ä¸­çš„å†…å®¹ç²˜è´´åˆ°å…‰æ ‡å P å°†å‰ªåˆ‡æ¿ä¸­çš„å†…å®¹ç²˜è´´åˆ°å…‰æ ‡å‰ æ³¨æ„ï¼švim ä¸­çš„æ–‡æœ¬ç¼“å†²åŒºå’Œç³»ç»Ÿçš„å‰ªåˆ‡æ¿ä¸æ˜¯åŒä¸€ä¸ªï¼Œåœ¨å…¶ä»–è½¯ä»¶ä¸­ä½¿ç”¨ Ctrl + C å¤åˆ¶çš„å†…å®¹ï¼Œä¸èƒ½åœ¨ vim ä¸­é€šè¿‡ p å‘½ä»¤ç²˜è´´ï¼Œå¯ä»¥åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ä½¿ç”¨é¼ æ ‡å³é”®ç²˜è´´ æŸ¥æ‰¾æ›¿æ¢æŸ¥æ‰¾ å¿«æ·é”® åŠŸèƒ½æè¿° &#x2F;abc ä»å…‰æ ‡æ‰€åœ¨ä½ç½®å‘åæŸ¥æ‰¾å­—ç¬¦ä¸² abc &#x2F;^abc æŸ¥æ‰¾ä»¥ abc ä¸ºè¡Œé¦–çš„è¡Œ &#x2F;abc$ æŸ¥æ‰¾ä»¥ abc ä¸ºè¡Œå°¾çš„è¡Œ ?abc ä»å…‰æ ‡æ‰€åœ¨ä½ç½®å‘å‰æŸ¥æ‰¾å­—ç¬¦ä¸² abc * å‘åæŸ¥æ‰¾å½“å‰å…‰æ ‡æ‰€åœ¨å•è¯ # å‘å‰æŸ¥æ‰¾å½“å‰å…‰æ ‡æ‰€åœ¨å•è¯ n æŸ¥æ‰¾ä¸‹ä¸€ä¸ªï¼Œå‘åŒä¸€æ–¹å‘é‡å¤ä¸Šæ¬¡çš„æŸ¥æ‰¾æŒ‡ä»¤ N æŸ¥æ‰¾ä¸Šä¸€ä¸ªï¼Œå‘ç›¸åæ–¹å‘é‡å¤ä¸Šæ¬¡çš„æŸ¥æ‰¾æŒ‡ä»¤ æ›¿æ¢ï¼š å‘½ä»¤ åŠŸèƒ½ å·¥ä½œæ¨¡å¼ r æ›¿æ¢å½“å‰å­—ç¬¦ å‘½ä»¤æ¨¡å¼ R æ›¿æ¢å½“å‰è¡Œå…‰æ ‡åçš„å­—ç¬¦ æ›¿æ¢æ¨¡å¼ å…‰æ ‡é€‰ä¸­è¦æ›¿æ¢çš„å­—ç¬¦ R å‘½ä»¤å¯ä»¥è¿›å…¥æ›¿æ¢æ¨¡å¼ï¼Œæ›¿æ¢å®Œæˆåï¼ŒæŒ‰ä¸‹ ESC å¯ä»¥å›åˆ°å‘½ä»¤æ¨¡å¼ æ›¿æ¢å‘½ä»¤çš„ä½œç”¨å°±æ˜¯ä¸ç”¨è¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼Œå¯¹æ–‡ä»¶è¿›è¡Œè½»é‡çº§çš„ä¿®æ”¹ æœ«è¡Œæ¨¡å¼åœ¨å‘½ä»¤æ¨¡å¼ä¸‹ï¼ŒæŒ‰ä¸‹ : é”®è¿›å…¥æœ«è¡Œæ¨¡å¼ å‘½ä»¤ åŠŸèƒ½æè¿° :wq ä¿å­˜å¹¶é€€å‡º Vim ç¼–è¾‘å™¨ :wq! ä¿å­˜å¹¶å¼ºåˆ¶é€€å‡º Vim ç¼–è¾‘å™¨ :q ä¸ä¿å­˜ä¸”é€€å‡º Vim ç¼–è¾‘å™¨ :q! ä¸ä¿å­˜ä¸”å¼ºåˆ¶é€€å‡º Vim ç¼–è¾‘å™¨ :w ä¿å­˜ä½†æ˜¯ä¸é€€å‡º Vim ç¼–è¾‘å™¨ :w! å¼ºåˆ¶ä¿å­˜ä½†æ˜¯ä¸é€€å‡º Vim ç¼–è¾‘å™¨ :w filename å¦å­˜åˆ° filename æ–‡ä»¶ x! ä¿å­˜æ–‡æœ¬ï¼Œé€€å‡ºä¿å­˜ä½†æ˜¯ä¸é€€å‡º Vim ç¼–è¾‘å™¨ï¼Œæ›´é€šç”¨çš„å‘½ä»¤ ZZ ç›´æ¥é€€å‡ºä¿å­˜ä½†æ˜¯ä¸é€€å‡º Vim ç¼–è¾‘å™¨ :n å…‰æ ‡ç§»åŠ¨è‡³ç¬¬ n è¡Œè¡Œé¦– å¼‚å¸¸å¤„ç† å¦‚æœ vim å¼‚å¸¸é€€å‡º, åœ¨ç£ç›˜ä¸Šå¯èƒ½ä¼šä¿å­˜æœ‰ äº¤æ¢æ–‡ä»¶ ä¸‹æ¬¡å†ä½¿ç”¨ vim ç¼–è¾‘æ–‡ä»¶æ—¶ï¼Œä¼šçœ‹åˆ°ä»¥ä¸‹å±å¹•ä¿¡æ¯ï¼š ls -a ä¸€ä¸‹ï¼Œä¼šçœ‹åˆ°éšè—çš„ .swp æ–‡ä»¶ï¼Œåˆ é™¤äº†æ­¤æ–‡ä»¶å³å¯ é“¾æ¥1ln [-sf] source_filename dist_filename -sï¼šé»˜è®¤æ˜¯å®ä½“é“¾æ¥ï¼ŒåŠ  -s ä¸ºç¬¦å·é“¾æ¥ -fï¼šå¦‚æœç›®æ ‡æ–‡ä»¶å­˜åœ¨æ—¶ï¼Œå…ˆåˆ é™¤ç›®æ ‡æ–‡ä»¶ å®ä½“é“¾æ¥ï¼š åœ¨ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ¡ç›®ï¼Œè®°å½•ç€æ–‡ä»¶åä¸ inode ç¼–å·ï¼Œè¿™ä¸ª inode å°±æ˜¯æºæ–‡ä»¶çš„ inode åˆ é™¤ä»»æ„ä¸€ä¸ªæ¡ç›®ï¼Œæ–‡ä»¶è¿˜æ˜¯å­˜åœ¨ï¼Œåªè¦å¼•ç”¨æ•°é‡ä¸ä¸º 0 ä¸èƒ½è·¨è¶Šæ–‡ä»¶ç³»ç»Ÿã€ä¸èƒ½å¯¹ç›®å½•è¿›è¡Œé“¾æ¥ 1234ln /etc/crontab .ll34474855 -rw-r--r--. 2 root root 451 Jun 10 2014 crontab34474855 -rw-r--r--. 2 root root 451 Jun 10 2014 /etc/crontab ç¬¦å·é“¾æ¥ï¼š ç¬¦å·é“¾æ¥æ–‡ä»¶ä¿å­˜ç€æºæ–‡ä»¶æ‰€åœ¨çš„ç»å¯¹è·¯å¾„ï¼Œåœ¨è¯»å–æ—¶ä¼šå®šä½åˆ°æºæ–‡ä»¶ä¸Šï¼Œå¯ä»¥ç†è§£ä¸º Windows çš„å¿«æ·æ–¹å¼ å½“æºæ–‡ä»¶è¢«åˆ é™¤äº†ï¼Œé“¾æ¥æ–‡ä»¶å°±æ‰“ä¸å¼€äº† è®°å½•çš„æ˜¯è·¯å¾„ï¼Œæ‰€ä»¥å¯ä»¥ä¸ºç›®å½•å»ºç«‹ç¬¦å·é“¾æ¥ 1234474855 -rw-r--r--. 2 root root 451 Jun 10 2014 /etc/crontab53745909 lrwxrwxrwx. 1 root root 12 Jun 23 22:31 /root/crontab2 -&gt; /etc/crontab è¿›ç¨‹ç®¡ç†æŸ¥çœ‹è¿›ç¨‹ps æŒ‡ä»¤ï¼šæŸ¥çœ‹æŸä¸ªæ—¶é—´ç‚¹çš„è¿›ç¨‹ä¿¡æ¯ top æŒ‡ä»¤ï¼šå®æ—¶æ˜¾ç¤ºè¿›ç¨‹ä¿¡æ¯ pstreeï¼šæŸ¥çœ‹è¿›ç¨‹æ ‘ 1pstree -A #æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹æ ‘ è¿›ç¨‹ IDè¿›ç¨‹å·ï¼š è¿›ç¨‹å·ä¸º 0 çš„è¿›ç¨‹é€šå¸¸æ˜¯è°ƒåº¦è¿›ç¨‹ï¼Œå¸¸å¸¸è¢«ç§°ä¸ºäº¤æ¢è¿›ç¨‹ï¼ˆswapperï¼‰ï¼Œè¯¥è¿›ç¨‹æ˜¯å†…æ ¸çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå¹¶ä¸æ‰§è¡Œä»»ä½•ç£ç›˜ä¸Šçš„ç¨‹åºï¼Œå› æ­¤ä¹Ÿè¢«ç§°ä¸ºç³»ç»Ÿè¿›ç¨‹ è¿›ç¨‹å·ä¸º 1 æ˜¯ init è¿›ç¨‹ï¼Œæ˜¯ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ï¼Œåœ¨è‡ªä¸¾è¿‡ç¨‹ç»“æŸæ—¶ç”±å†…æ ¸è°ƒç”¨ï¼Œinit è¿›ç¨‹ç»ä¸ä¼šç»ˆæ­¢ï¼Œæ˜¯ä¸€ä¸ªæ™®é€šçš„ç”¨æˆ·è¿›ç¨‹ï¼Œä½†æ˜¯å®ƒä»¥è¶…çº§ç”¨æˆ·ç‰¹æƒè¿è¡Œ çˆ¶è¿›ç¨‹ ID ä¸º 0 çš„è¿›ç¨‹é€šå¸¸æ˜¯å†…æ ¸è¿›ç¨‹ï¼Œä½œä¸ºç³»ç»Ÿè‡ªä¸¾è¿‡ç¨‹çš„ä¸€éƒ¨åˆ†è€Œå¯åŠ¨ï¼Œinit è¿›ç¨‹æ˜¯ä¸ªä¾‹å¤–ï¼Œå®ƒçš„çˆ¶è¿›ç¨‹æ˜¯ 0ï¼Œä½†å®ƒæ˜¯ç”¨æˆ·è¿›ç¨‹ ä¸»å­˜ &#x3D; RAM + BIOS éƒ¨åˆ†çš„ ROM DISKï¼šå­˜æ”¾ OS å’Œ Bootloader BIOSï¼šåŸºäº I&#x2F;O å¤„ç†ç³»ç»Ÿ Bootloaderï¼šåŠ è½½ OSï¼Œå°† OS æ”¾å…¥å†…å­˜ è‡ªä¸¾ç¨‹åºå­˜å‚¨åœ¨å†…å­˜ä¸­ ROMï¼Œç”¨æ¥åŠ è½½æ“ä½œç³»ç»Ÿï¼Œåˆå§‹åŒ– CPUã€å¯„å­˜å™¨ã€å†…å­˜ç­‰ã€‚CPU çš„ç¨‹åºè®¡æ•°å™¨æŒ‡è‡ªä¸¾ç¨‹åºç¬¬ä¸€æ¡æŒ‡ä»¤ï¼Œå½“è®¡ç®—æœºé€šç”µï¼ŒCPU å¼€å§‹è¯»å–å¹¶æ‰§è¡Œè‡ªä¸¾ç¨‹åºï¼Œå°†æ“ä½œç³»ç»Ÿï¼ˆä¸æ˜¯å…¨éƒ¨ï¼Œåªæ˜¯å¯åŠ¨è®¡ç®—æœºçš„é‚£éƒ¨åˆ†ç¨‹åºï¼‰è£…å…¥ RAM ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯è‡ªä¸¾è¿‡ç¨‹ã€‚è£…å…¥å®Œæˆåç¨‹åºè®¡æ•°å™¨è®¾ç½®ä¸º RAM ä¸­æ“ä½œç³»ç»Ÿçš„ç¬¬ä¸€æ¡æŒ‡ä»¤ï¼Œæ¥ä¸‹æ¥ CPU å°†å¼€å§‹æ‰§è¡Œï¼ˆå¯åŠ¨ï¼‰æ“ä½œç³»ç»Ÿçš„æŒ‡ä»¤ å­˜å‚¨åœ¨ ROM ä¸­ä¿ç•™å¾ˆå°çš„è‡ªä¸¾è£…å…¥ç¨‹åºï¼Œå®Œæ•´åŠŸèƒ½çš„è‡ªä¸¾ç¨‹åºä¿å­˜åœ¨ç£ç›˜çš„å¯åŠ¨å—ä¸Šï¼Œå¯åŠ¨å—ä½äºç£ç›˜çš„å›ºå®šä½ï¼Œæ‹¥æœ‰å¯åŠ¨åˆ†åŒºçš„ç£ç›˜ç§°ä¸ºå¯åŠ¨ç£ç›˜æˆ–ç³»ç»Ÿç£ç›˜ï¼ˆC ç›˜ï¼‰ è¿›ç¨‹çŠ¶æ€ çŠ¶æ€ è¯´æ˜ R running or runnable (on run queue) æ­£åœ¨æ‰§è¡Œæˆ–è€…å¯æ‰§è¡Œï¼Œæ­¤æ—¶è¿›ç¨‹ä½äºæ‰§è¡Œé˜Ÿåˆ—ä¸­ D uninterruptible sleep (usually I&#x2F;O) ä¸å¯ä¸­æ–­é˜»å¡ï¼Œé€šå¸¸ä¸º IO é˜»å¡ S interruptible sleep (waiting for an event to complete) å¯ä¸­æ–­é˜»å¡ï¼Œæ­¤æ—¶è¿›ç¨‹æ­£åœ¨ç­‰å¾…æŸä¸ªäº‹ä»¶å®Œæˆ Z zombie (terminated but not reaped by its parent) åƒµæ­»ï¼Œè¿›ç¨‹å·²ç»ç»ˆæ­¢ä½†æ˜¯å°šæœªè¢«å…¶çˆ¶è¿›ç¨‹è·å–ä¿¡æ¯ T stopped (either by a job control signal or because it is being traced) ç»“æŸï¼Œè¿›ç¨‹æ—¢å¯ä»¥è¢«ä½œä¸šæ§åˆ¶ä¿¡å·ç»“æŸï¼Œä¹Ÿå¯èƒ½æ˜¯æ­£åœ¨è¢«è¿½è¸ª å­¤å„¿è¿›ç¨‹ï¼š ä¸€ä¸ªçˆ¶è¿›ç¨‹é€€å‡ºï¼Œè€Œå®ƒçš„ä¸€ä¸ªæˆ–å¤šä¸ªå­è¿›ç¨‹è¿˜åœ¨è¿è¡Œï¼Œé‚£ä¹ˆè¿™äº›å­è¿›ç¨‹å°†æˆä¸ºå­¤å„¿è¿›ç¨‹ å­¤å„¿è¿›ç¨‹å°†è¢« init è¿›ç¨‹æ‰€æ”¶å…»ï¼Œå¹¶ç”± init è¿›ç¨‹å¯¹å®ƒä»¬å®ŒæˆçŠ¶æ€æ”¶é›†å·¥ä½œï¼Œæ‰€ä»¥å­¤å„¿è¿›ç¨‹ä¸ä¼šå¯¹ç³»ç»Ÿé€ æˆå±å®³ åƒµå°¸è¿›ç¨‹ï¼š ä¸€ä¸ªå­è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦åœ¨å­è¿›ç¨‹é€€å‡ºæ—¶ä¸ä¼šé‡Šæ”¾ï¼Œåªæœ‰å½“çˆ¶è¿›ç¨‹é€šè¿‡ wait() æˆ– waitpid() è·å–äº†å­è¿›ç¨‹ä¿¡æ¯åæ‰ä¼šé‡Šæ”¾ã€‚å¦‚æœå­è¿›ç¨‹é€€å‡ºï¼Œè€Œçˆ¶è¿›ç¨‹å¹¶æ²¡æœ‰è°ƒç”¨ wait() æˆ– waitpid()ï¼Œé‚£ä¹ˆå­è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦ä»ç„¶ä¿å­˜åœ¨ç³»ç»Ÿä¸­ï¼Œè¿™ç§è¿›ç¨‹ç§°ä¹‹ä¸ºåƒµå°¸è¿›ç¨‹ åƒµå°¸è¿›ç¨‹é€šè¿‡ ps å‘½ä»¤æ˜¾ç¤ºå‡ºæ¥çš„çŠ¶æ€ä¸º Zï¼ˆzombieï¼‰ ç³»ç»Ÿæ‰€èƒ½ä½¿ç”¨çš„è¿›ç¨‹å·æ˜¯æœ‰é™çš„ï¼Œäº§ç”Ÿå¤§é‡åƒµå°¸è¿›ç¨‹ï¼Œä¼šå¯¼è‡´ç³»ç»Ÿæ²¡æœ‰å¯ç”¨çš„è¿›ç¨‹å·è€Œä¸èƒ½äº§ç”Ÿæ–°çš„è¿›ç¨‹ è¦æ¶ˆç­ç³»ç»Ÿä¸­å¤§é‡çš„åƒµå°¸è¿›ç¨‹ï¼Œåªéœ€è¦å°†å…¶çˆ¶è¿›ç¨‹æ€æ­»ï¼Œæ­¤æ—¶åƒµå°¸è¿›ç¨‹å°±ä¼šå˜æˆå­¤å„¿è¿›ç¨‹ï¼Œä»è€Œè¢« init è¿›ç¨‹æ‰€æ”¶å…»ï¼Œè¿™æ · init è¿›ç¨‹å°±ä¼šé‡Šæ”¾æ‰€æœ‰çš„åƒµå°¸è¿›ç¨‹æ‰€å æœ‰çš„èµ„æºï¼Œä»è€Œç»“æŸåƒµå°¸è¿›ç¨‹ è¡¥å……ï¼š å®ˆæŠ¤è¿›ç¨‹(daemon)æ˜¯ä¸€ç±»åœ¨åå°è¿è¡Œçš„ç‰¹æ®Šè¿›ç¨‹ï¼Œç”¨äºæ‰§è¡Œç‰¹å®šçš„ç³»ç»Ÿä»»åŠ¡ã€‚ å®ˆæŠ¤è¿›ç¨‹æ˜¯è„±ç¦»äºç»ˆç«¯å¹¶ä¸”åœ¨åå°è¿è¡Œçš„è¿›ç¨‹ï¼Œè„±ç¦»ç»ˆç«¯æ˜¯ä¸ºäº†é¿å…åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­çš„ä¿¡æ¯åœ¨ç»ˆç«¯ä¸Šæ˜¾ç¤ºï¼Œå¹¶ä¸”è¿›ç¨‹ä¹Ÿä¸ä¼šè¢«ä»»ä½•ç»ˆç«¯æ‰€äº§ç”Ÿçš„ç»ˆç«¯ä¿¡æ¯æ‰€æ‰“æ–­ å¾ˆå¤šå®ˆæŠ¤è¿›ç¨‹åœ¨ç³»ç»Ÿå¼•å¯¼çš„æ—¶å€™å¯åŠ¨ï¼Œå¹¶ä¸”ä¸€ç›´è¿è¡Œç›´åˆ°ç³»ç»Ÿå…³é—­ï¼›å¦ä¸€äº›åªåœ¨éœ€è¦çš„æ—¶å€™æ‰å¯åŠ¨ï¼Œå®Œæˆä»»åŠ¡åå°±è‡ªåŠ¨ç»“æŸ çŠ¶æ€æ”¹å˜SIGCHLDå½“ä¸€ä¸ªå­è¿›ç¨‹æ”¹å˜äº†å®ƒçš„çŠ¶æ€æ—¶ï¼ˆåœæ­¢è¿è¡Œï¼Œç»§ç»­è¿è¡Œæˆ–è€…é€€å‡ºï¼‰ï¼Œæœ‰ä¸¤ä»¶äº‹ä¼šå‘ç”Ÿåœ¨çˆ¶è¿›ç¨‹ä¸­ï¼š å¾—åˆ° SIGCHLD ä¿¡å· waitpid() æˆ–è€… wait() è°ƒç”¨ä¼šè¿”å› å­è¿›ç¨‹å‘é€çš„ SIGCHLD ä¿¡å·åŒ…å«äº†å­è¿›ç¨‹çš„ä¿¡æ¯ï¼Œæ¯”å¦‚è¿›ç¨‹ IDã€è¿›ç¨‹çŠ¶æ€ã€è¿›ç¨‹ä½¿ç”¨ CPU çš„æ—¶é—´ç­‰ï¼›åœ¨å­è¿›ç¨‹é€€å‡ºæ—¶è¿›ç¨‹æè¿°ç¬¦ä¸ä¼šç«‹å³é‡Šæ”¾ï¼Œçˆ¶è¿›ç¨‹é€šè¿‡ wait() å’Œ waitpid() æ¥è·å¾—ä¸€ä¸ªå·²ç»é€€å‡ºçš„å­è¿›ç¨‹çš„ä¿¡æ¯ï¼Œé‡Šæ”¾å­è¿›ç¨‹çš„ PCB wait1pid_t wait(int *status) å‚æ•°ï¼šstatus ç”¨æ¥ä¿å­˜è¢«æ”¶é›†çš„å­è¿›ç¨‹é€€å‡ºæ—¶çš„çŠ¶æ€ï¼Œå¦‚æœä¸å…³å¿ƒå­è¿›ç¨‹å¦‚ä½•é”€æ¯ï¼Œå¯ä»¥è®¾ç½®è¿™ä¸ªå‚æ•°ä¸º NULL çˆ¶è¿›ç¨‹è°ƒç”¨ wait() ä¼šé˜»å¡ç­‰å¾…ï¼Œç›´åˆ°æ”¶åˆ°ä¸€ä¸ªå­è¿›ç¨‹é€€å‡ºçš„ SIGCHLD ä¿¡å·ï¼Œwait() å‡½æ•°å°±ä¼šé”€æ¯å­è¿›ç¨‹å¹¶è¿”å› æˆåŠŸï¼Œè¿”å›è¢«æ”¶é›†çš„å­è¿›ç¨‹çš„è¿›ç¨‹ ID å¤±è´¥ï¼Œè¿”å› -1ï¼ŒåŒæ—¶ errno è¢«ç½®ä¸º ECHILDï¼ˆå¦‚æœè°ƒç”¨è¿›ç¨‹æ²¡æœ‰å­è¿›ç¨‹ï¼Œè°ƒç”¨å°±ä¼šå¤±è´¥ï¼‰ waitpid1pid_t waitpid(pid_t pid, int *status, int options) ä½œç”¨å’Œ wait() å®Œå…¨ç›¸åŒï¼Œåªæ˜¯å¤šäº†ä¸¤ä¸ªå¯æ§åˆ¶çš„å‚æ•° pid å’Œ options pidï¼šæŒ‡ç¤ºä¸€ä¸ªå­è¿›ç¨‹çš„ IDï¼Œè¡¨ç¤ºåªå…³å¿ƒè¿™ä¸ªå­è¿›ç¨‹é€€å‡ºçš„ SIGCHLD ä¿¡å·ï¼›å¦‚æœ pid&#x3D;-1 æ—¶ï¼Œé‚£ä¹ˆå’Œ wait() ä½œç”¨ç›¸åŒï¼Œéƒ½æ˜¯å…³æ³¨æ‰€æœ‰å­è¿›ç¨‹é€€å‡ºçš„ SIGCHLD ä¿¡å· optionsï¼šä¸»è¦æœ‰ WNOHANG å’Œ WUNTRACED ä¸¤ä¸ªï¼ŒWNOHANG å¯ä»¥ä½¿ waitpid() è°ƒç”¨å˜æˆéé˜»å¡çš„ï¼Œå°±æ˜¯ä¼šç«‹å³è¿”å›ï¼Œçˆ¶è¿›ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œå…¶å®ƒä»»åŠ¡ ç½‘ç»œç®¡ç†network å¯åŠ¨ï¼šservice network start åœæ­¢ï¼šservice network stop é‡å¯ï¼šservice network restart ifconfigifconfig æ˜¯ Linux ä¸­ç”¨äºæ˜¾ç¤ºæˆ–é…ç½®ç½‘ç»œè®¾å¤‡çš„å‘½ä»¤ï¼Œè‹±æ–‡å…¨ç§°æ˜¯ network interfaces configuring ifconfig å‘½ä»¤ç”¨äºæ˜¾ç¤ºæˆ–è®¾ç½®ç½‘ç»œè®¾å¤‡ã€‚ifconfig å¯è®¾ç½®ç½‘ç»œè®¾å¤‡çš„çŠ¶æ€ï¼Œæˆ–æ˜¯æ˜¾ç¤ºç›®å‰çš„è®¾ç½® 1ifconfig [ç½‘ç»œè®¾å¤‡][down up -allmulti -arp -promisc][add&lt;åœ°å€&gt;][del&lt;åœ°å€&gt;][&lt;hw&lt;ç½‘ç»œè®¾å¤‡ç±»å‹&gt;&lt;ç¡¬ä»¶åœ°å€&gt;][io_addr&lt;I/Oåœ°å€&gt;][irq&lt;IRQåœ°å€&gt;][media&lt;ç½‘ç»œåª’ä»‹ç±»å‹&gt;][mem_start&lt;å†…å­˜åœ°å€&gt;][metric&lt;æ•°ç›®&gt;][mtu&lt;å­—èŠ‚&gt;][netmask&lt;å­ç½‘æ©ç &gt;][tunnel&lt;åœ°å€&gt;][-broadcast&lt;åœ°å€&gt;][-pointopoint&lt;åœ°å€&gt;][IPåœ°å€] ifconfigï¼šæ˜¾ç¤ºæ¿€æ´»çš„ç½‘å¡ä¿¡æ¯ ens ens33ï¼ˆæˆ– eth0ï¼‰è¡¨ç¤ºç¬¬ä¸€å—ç½‘å¡ï¼ŒIPåœ°å€æ˜¯ 192.168.0.137ï¼Œå¹¿æ’­åœ°å€ broadcast 192.168.0.255ï¼Œæ©ç åœ°å€netmask 255.255.255.0 ï¼Œinet6 å¯¹åº”çš„æ˜¯ ipv6 lo æ˜¯è¡¨ç¤ºä¸»æœºçš„å›ååœ°å€ï¼Œç”¨æ¥æµ‹è¯•ä¸€ä¸ªç½‘ç»œç¨‹åºï¼Œä½†åˆä¸æƒ³è®©å±€åŸŸç½‘æˆ–å¤–ç½‘çš„ç”¨æˆ·èƒ½å¤ŸæŸ¥çœ‹ï¼Œåªèƒ½åœ¨æ­¤å°ä¸»æœºä¸Šè¿è¡Œå’ŒæŸ¥çœ‹æ‰€ç”¨çš„ç½‘ç»œæ¥å£ ifconfig ens33 downï¼šå…³é—­ç½‘å¡ ifconfig ens33 upï¼šå¯ç”¨ç½‘å¡ pingping å‘½ä»¤ç”¨äºæ£€æµ‹ä¸»æœº æ‰§è¡Œ ping æŒ‡ä»¤ä¼šä½¿ç”¨ ICMP ä¼ è¾“åè®®ï¼Œå‘å‡ºè¦æ±‚å›åº”çš„ä¿¡æ¯ï¼Œè‹¥è¿œç«¯ä¸»æœºçš„ç½‘ç»œåŠŸèƒ½æ²¡æœ‰é—®é¢˜ï¼Œå°±ä¼šå›åº”è¯¥ä¿¡æ¯ 1ping [-dfnqrRv][-c&lt;å®Œæˆæ¬¡æ•°&gt;][-i&lt;é—´éš”ç§’æ•°&gt;][-I&lt;ç½‘ç»œç•Œé¢&gt;][-l&lt;å‰ç½®è½½å…¥&gt;][-p&lt;èŒƒæœ¬æ ·å¼&gt;][-s&lt;æ•°æ®åŒ…å¤§å°&gt;][-t&lt;å­˜æ´»æ•°å€¼&gt;][ä¸»æœºåç§°æˆ–IPåœ°å€] -c&lt;å®Œæˆæ¬¡æ•°&gt;ï¼šè®¾ç½®å®Œæˆè¦æ±‚å›åº”çš„æ¬¡æ•°ï¼› ping -c 2 www.baidu.com icmp_seqï¼šping åºåˆ—ï¼Œä»1å¼€å§‹ ttlï¼šIP ç”Ÿå­˜æ—¶é—´å€¼ timeï¼šå“åº”æ—¶é—´,æ•°å€¼è¶Šå°ï¼Œè”é€šé€Ÿåº¦è¶Šå¿« netstatnetstat å‘½ä»¤ç”¨äºæ˜¾ç¤ºç½‘ç»œçŠ¶æ€ 1netstat [-acCeFghilMnNoprstuvVwx][-A&lt;ç½‘ç»œç±»å‹&gt;][--ip] -a æ˜¾ç¤ºæ‰€æœ‰è¿çº¿ä¸­çš„ Socketï¼Œæ˜¾ç¤ºè¯¦ç»†çš„è¿æ¥çŠ¶å†µ -i æ˜¾ç¤ºç½‘ç»œç•Œé¢ä¿¡æ¯è¡¨å•ï¼Œæ˜¾ç¤ºç½‘å¡åˆ—è¡¨ -p æ˜¾ç¤ºæ­£åœ¨ä½¿ç”¨ Socket çš„ç¨‹åºè¯†åˆ«ç å’Œç¨‹åºåç§° -n æ˜¾ç¤ºä½¿ç”¨ IP åœ°å€ï¼Œè€Œä¸é€šè¿‡åŸŸåæœåŠ¡å™¨ -t æ˜¾ç¤º TCP ä¼ è¾“åè®®çš„è¿çº¿çŠ¶å†µã€‚ -u æ˜¾ç¤º UDP ä¼ è¾“åè®®çš„è¿çº¿çŠ¶å†µ -aptnï¼šæŸ¥çœ‹æ‰€æœ‰ TCP å¼€å¯ç«¯å£ -apunï¼šæŸ¥çœ‹æ‰€æœ‰ UDP å¼€å¯ç«¯å£ è¡¥å……ï¼š netstat -apn | grep portï¼šæŸ¥çœ‹æŒ‡å®šç«¯å£å· lsof -i:port ï¼šæŸ¥çœ‹æŒ‡å®šç«¯å£å· ç£ç›˜ç®¡ç†æŒ‚è½½æ¦‚å¿µåœ¨å®‰è£… Linux ç³»ç»Ÿæ—¶è®¾ç«‹çš„å„ä¸ªåˆ†åŒºï¼Œå¦‚æ ¹åˆ†åŒºã€&#x2F;boot åˆ†åŒºç­‰éƒ½æ˜¯è‡ªåŠ¨æŒ‚è½½çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸éœ€è¦äººä¸ºæ“ä½œï¼Œå¼€æœºå°±ä¼šè‡ªåŠ¨æŒ‚è½½ã€‚ä½†æ˜¯å…‰ç›˜ã€U ç›˜ç­‰å­˜å‚¨è®¾å¤‡å¦‚æœéœ€è¦ä½¿ç”¨ï¼Œå°±å¿…é¡»äººä¸ºçš„è¿›è¡ŒæŒ‚è½½ åœ¨ Windows ä¸‹æ’å…¥ U ç›˜ä¹Ÿæ˜¯éœ€è¦æŒ‚è½½ï¼ˆåˆ†é…ç›˜ç¬¦ï¼‰çš„ï¼Œåªä¸è¿‡ Windows ä¸‹åˆ†é…ç›˜ç¬¦æ˜¯è‡ªåŠ¨çš„ã€‚å…¶å®æŒ‚è½½å¯ä»¥ç†è§£ä¸º Windows å½“ä¸­çš„åˆ†é…ç›˜ç¬¦ï¼Œåªä¸è¿‡ Windows å½“ä¸­æ˜¯ä»¥è‹±æ–‡å­—æ¯ ABCD ç­‰ä½œä¸ºç›˜ç¬¦ï¼Œè€Œ Linux æ˜¯æ‹¿ç³»ç»Ÿç›®å½•ä½œä¸ºç›˜ç¬¦ï¼Œå½“ç„¶ Linux å½“ä¸­ä¹Ÿä¸å«ç›˜ç¬¦ï¼Œè€Œæ˜¯ç§°ä¸ºæŒ‚è½½ç‚¹ï¼Œè€ŒæŠŠä¸ºåˆ†åŒºæˆ–è€…å…‰ç›˜ç­‰å­˜å‚¨è®¾å¤‡åˆ†é…ä¸€ä¸ªæŒ‚è½½ç‚¹çš„è¿‡ç¨‹ç§°ä¸ºæŒ‚è½½ Linux ä¸­çš„æ ¹ç›®å½•ä»¥å¤–çš„æ–‡ä»¶è¦æƒ³è¢«è®¿é—®ï¼Œéœ€è¦å°†å…¶å…³è”åˆ°æ ¹ç›®å½•ä¸‹çš„æŸä¸ªç›®å½•æ¥å®ç°ï¼Œè¿™ç§å…³è”æ“ä½œå°±æ˜¯æŒ‚è½½ï¼Œè¿™ä¸ªç›®å½•å°±æ˜¯æŒ‚è½½ç‚¹ï¼Œè§£é™¤æ¬¡å…³è”å…³ç³»çš„è¿‡ç¨‹ç§°ä¹‹ä¸ºå¸è½½ æŒ‚è½½ç‚¹çš„ç›®å½•éœ€è¦ä»¥ä¸‹å‡ ä¸ªè¦æ±‚ï¼š ç›®å½•è¦å…ˆå­˜åœ¨ï¼Œå¯ä»¥ç”¨ mkdir å‘½ä»¤æ–°å»ºç›®å½• æŒ‚è½½ç‚¹ç›®å½•ä¸å¯è¢«å…¶ä»–è¿›ç¨‹ä½¿ç”¨åˆ° æŒ‚è½½ç‚¹ä¸‹åŸæœ‰æ–‡ä»¶å°†è¢«éšè— lsblklsblk å‘½ä»¤çš„è‹±æ–‡æ˜¯ list blockï¼Œå³ç”¨äºåˆ—å‡ºæ‰€æœ‰å¯ç”¨å—è®¾å¤‡çš„ä¿¡æ¯ï¼Œè€Œä¸”è¿˜èƒ½æ˜¾ç¤ºä»–ä»¬ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œä½†æ˜¯ä¸ä¼šåˆ—å‡º RAM ç›˜çš„ä¿¡æ¯ å‘½ä»¤ï¼šlsblk [å‚æ•°] lsblkï¼šä»¥æ ‘çŠ¶åˆ—å‡ºæ‰€æœ‰å—è®¾å¤‡ NAMEï¼šè¿™æ˜¯å—è®¾å¤‡å MAJï¼šMIN : æœ¬æ æ˜¾ç¤ºä¸»è¦å’Œæ¬¡è¦è®¾å¤‡å· RMï¼šæœ¬æ æ˜¾ç¤ºè®¾å¤‡æ˜¯å¦å¯ç§»åŠ¨è®¾å¤‡ï¼Œåœ¨ä¸Šé¢è®¾å¤‡ sr0 çš„ RM å€¼ç­‰äº 1ï¼Œè¿™è¯´æ˜ä»–ä»¬æ˜¯å¯ç§»åŠ¨è®¾å¤‡ SIZEï¼šæœ¬æ åˆ—å‡ºè®¾å¤‡çš„å®¹é‡å¤§å°ä¿¡æ¯ ROï¼šè¯¥é¡¹è¡¨æ˜è®¾å¤‡æ˜¯å¦ä¸ºåªè¯»ï¼Œåœ¨æœ¬æ¡ˆä¾‹ä¸­ï¼Œæ‰€æœ‰è®¾å¤‡çš„ RO å€¼ä¸º 0ï¼Œè¡¨æ˜ä»–ä»¬ä¸æ˜¯åªè¯»çš„ TYPEï¼šæœ¬æ æ˜¾ç¤ºå—è®¾å¤‡æ˜¯å¦æ˜¯ç£ç›˜æˆ–ç£ç›˜ä¸Šçš„ä¸€ä¸ªåˆ†åŒºã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œsda å’Œ sdb æ˜¯ç£ç›˜ï¼Œè€Œ sr0 æ˜¯åªè¯»å­˜å‚¨ï¼ˆromï¼‰ã€‚ MOUNTPOINTï¼šæœ¬æ æŒ‡å‡ºè®¾å¤‡æŒ‚è½½çš„æŒ‚è½½ç‚¹ã€‚ lsblk -fï¼šä¸ä¼šåˆ—å‡ºæ‰€æœ‰ç©ºè®¾å¤‡ NAMEè¡¨ç¤ºè®¾å¤‡åç§° FSTYPEè¡¨ç¤ºæ–‡ä»¶ç±»å‹ LABELè¡¨ç¤ºè®¾å¤‡æ ‡ç­¾ UUIDè®¾å¤‡ç¼–å· MOUNTPOINTè¡¨ç¤ºè®¾å¤‡çš„æŒ‚è½½ç‚¹ df df å‘½ä»¤ç”¨äºæ˜¾ç¤ºç›®å‰åœ¨ Linux ç³»ç»Ÿä¸Šçš„æ–‡ä»¶ç³»ç»Ÿçš„ç£ç›˜ä½¿ç”¨æƒ…å†µç»Ÿè®¡ã€‚ å‘½ä»¤ï¼šdf [options]â€¦ [FILE]â€¦ -h ä½¿ç”¨äººç±»å¯è¯»çš„æ ¼å¼(é¢„è®¾å€¼æ˜¯ä¸åŠ è¿™ä¸ªé€‰é¡¹çš„â€¦) â€“total è®¡ç®—æ‰€æœ‰çš„æ•°æ®ä¹‹å’Œ ç¬¬ä¸€åˆ—æŒ‡å®šæ–‡ä»¶ç³»ç»Ÿçš„åç§°ï¼›ç¬¬äºŒåˆ—æŒ‡å®šä¸€ä¸ªç‰¹å®šçš„æ–‡ä»¶ç³»ç»Ÿï¼Œ1K æ˜¯ 1024 å­—èŠ‚ä¸ºå•ä½çš„æ€»å®¹é‡ï¼›å·²ç”¨å’Œå¯ç”¨åˆ—åˆ†åˆ«æŒ‡å®šçš„å®¹é‡ï¼›æœ€åä¸€ä¸ªå·²ç”¨åˆ—æŒ‡å®šä½¿ç”¨çš„å®¹é‡çš„ç™¾åˆ†æ¯”ï¼›æœ€åä¸€æ æŒ‡å®šçš„æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ç‚¹ mountmount å‘½ä»¤æ˜¯ç»å¸¸ä¼šä½¿ç”¨åˆ°çš„å‘½ä»¤ï¼Œå®ƒç”¨äºæŒ‚è½½ Linux ç³»ç»Ÿå¤–çš„æ–‡ä»¶ ä½¿ç”¨è€…æƒé™ï¼šæ‰€æœ‰ç”¨æˆ·ï¼Œè®¾ç½®çº§åˆ«çš„éœ€è¦ç®¡ç†å‘˜ 1234mount [-hV]mount -a [-fFnrsvw] [-t vfstype]mount [-fnrsvw] [-o options [,...]] device | dirmount [-fnrsvw] [-t vfstype] [-o options] device dir -tï¼šæŒ‡å®šæ¡£æ¡ˆç³»ç»Ÿçš„å‹æ€ï¼Œé€šå¸¸ä¸å¿…æŒ‡å®šã€‚mount ä¼šè‡ªåŠ¨é€‰æ‹©æ­£ç¡®çš„å‹æ€ã€‚ é€šè¿‡æŒ‚è½½çš„æ–¹å¼æŸ¥çœ‹ Linux CD&#x2F;DVD å…‰é©±ï¼ŒæŸ¥çœ‹ ubuntu-20.04.1-desktop-amd64.iso çš„æ–‡ä»¶ è¿›å…¥ã€è™šæ‹Ÿæœºã€‘â€“ã€è®¾ç½®ã€‘ï¼Œè®¾ç½® CD&#x2F;DVD çš„å†…å®¹ï¼Œubuntu-20.04.1-desktop-amd64.iso åˆ›å»ºæŒ‚è½½ç‚¹ï¼ˆæ³¨æ„ï¼šä¸€èˆ¬ç”¨æˆ·æ— æ³•æŒ‚è½½ cdromï¼Œåªæœ‰ root ç”¨æˆ·æ‰å¯ä»¥æ“ä½œï¼‰ mkdir -p /mnt/cdrom ï¼šåˆ‡æ¢åˆ° root ä¸‹åˆ›å»ºä¸€ä¸ªæŒ‚è½½ç‚¹ï¼ˆå…¶å®å°±æ˜¯åˆ›å»ºä¸€ä¸ªç›®å½•ï¼‰ å¼€å§‹æŒ‚è½½mount -t auto /dev/cdrom /mnt/cdromï¼šé€šè¿‡æŒ‚è½½ç‚¹çš„æ–¹å¼æŸ¥çœ‹ä¸Šé¢çš„ã€ISOæ–‡ä»¶å†…å®¹ã€‘ æŸ¥çœ‹æŒ‚è½½å†…å®¹ï¼šls -l -a ./mnt/cdrom/ å¸è½½ cdromï¼šumount /mnt/cdrom/ é˜²ç«å¢™æ¦‚è¿°é˜²ç«å¢™æŠ€æœ¯æ˜¯é€šè¿‡æœ‰æœºç»“åˆå„ç±»ç”¨äºå®‰å…¨ç®¡ç†ä¸ç­›é€‰çš„è½¯ä»¶å’Œç¡¬ä»¶è®¾å¤‡ï¼Œå¸®åŠ©è®¡ç®—æœºç½‘ç»œäºå…¶å†…ã€å¤–ç½‘ä¹‹é—´æ„å»ºä¸€é“ç›¸å¯¹éš”ç»çš„ä¿æŠ¤å±éšœï¼Œä»¥ä¿æŠ¤ç”¨æˆ·èµ„æ–™ä¸ä¿¡æ¯å®‰å…¨æ€§çš„ä¸€ç§æŠ€æœ¯ã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒLinux ç³»ç»Ÿçš„é˜²ç«å¢™çŠ¶æ€æ˜¯æ‰“å¼€çš„ çŠ¶æ€å¯åŠ¨è¯­æ³•ï¼šservice name status æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€ï¼šservice iptables status ä¸´æ—¶å¼€å¯ï¼šservice iptables start ä¸´æ—¶å…³é—­ï¼šservice iptables stop å¼€æœºå¯åŠ¨ï¼šchkconfig iptables on å¼€æœºå…³é—­ï¼šchkconfig iptables off æ”¾è¡Œè®¾ç½®ç«¯å£é˜²ç«å¢™æ”¾è¡Œ ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼švim /etc/sysconfig/iptables æ·»åŠ æ”¾è¡Œç«¯å£ï¼š-A INPUT -m state --state NEW -m tcp -p tcp --dport ç«¯å£å· -j ACCEPT é‡æ–°åŠ è½½é˜²ç«å¢™è§„åˆ™ï¼šservice iptables reload å¤‡æ³¨ï¼šé»˜è®¤æƒ…å†µä¸‹ 22 ç«¯å£å·æ˜¯æ”¾è¡Œçš„ Shellå…¥é—¨æ¦‚å¿µShell è„šæœ¬ï¼ˆshell scriptï¼‰ï¼Œæ˜¯ä¸€ç§ä¸º shell ç¼–å†™çš„è„šæœ¬ç¨‹åºï¼Œåˆç§° Shell å‘½ä»¤ç¨¿ã€ç¨‹åºåŒ–è„šæœ¬ï¼Œæ˜¯ä¸€ç§è®¡ç®—æœºç¨‹åºä½¿ç”¨çš„æ–‡æœ¬æ–‡ä»¶ï¼Œå†…å®¹ç”±ä¸€è¿ä¸²çš„ shell å‘½ä»¤ç»„æˆï¼Œç»ç”± Unix Shell ç›´è¯‘å…¶å†…å®¹åè¿ä½œ Shell è¢«å½“æˆæ˜¯ä¸€ç§è„šæœ¬è¯­è¨€æ¥è®¾è®¡ï¼Œå…¶è¿ä½œæ–¹å¼ä¸è§£é‡Šå‹è¯­è¨€ç›¸å½“ï¼Œç”± Unix shell æ‰®æ¼”å‘½ä»¤è¡Œè§£é‡Šå™¨çš„è§’è‰²ï¼Œåœ¨è¯»å– shell è„šæœ¬ä¹‹åï¼Œä¾åºè¿è¡Œå…¶ä¸­çš„ shell å‘½ä»¤ï¼Œä¹‹åè¾“å‡ºç»“æœ ç¯å¢ƒShell ç¼–ç¨‹è·Ÿ JavaScriptã€php ç¼–ç¨‹ä¸€æ ·ï¼Œåªè¦æœ‰ä¸€ä¸ªèƒ½ç¼–å†™ä»£ç çš„æ–‡æœ¬ç¼–è¾‘å™¨å’Œä¸€ä¸ªèƒ½è§£é‡Šæ‰§è¡Œçš„è„šæœ¬è§£é‡Šå™¨å°±å¯ä»¥äº†ã€‚ cat /etc/shellsï¼šæŸ¥çœ‹è§£é‡Šå™¨ Linux çš„ Shell ç§ç±»ä¼—å¤šï¼Œå¸¸è§çš„æœ‰ï¼š Bourne Shellï¼ˆ&#x2F;usr&#x2F;bin&#x2F;shæˆ–&#x2F;bin&#x2F;shï¼‰ Bourne Again Shellï¼ˆ&#x2F;bin&#x2F;bashï¼‰ï¼šBash æ˜¯å¤§å¤šæ•°Linux ç³»ç»Ÿé»˜è®¤çš„ Shell C Shellï¼ˆ&#x2F;usr&#x2F;bin&#x2F;cshï¼‰ K Shellï¼ˆ&#x2F;usr&#x2F;bin&#x2F;kshï¼‰ Shell for Rootï¼ˆ&#x2F;sbin&#x2F;shï¼‰ ç­‰ç­‰â€¦â€¦ ç¬¬ä¸€ä¸ªshell æ–°å»º s.sh æ–‡ä»¶ï¼štouch s.sh ç¼–è¾‘ s.sh æ–‡ä»¶ï¼švim s.sh 123456789101112#!/bin/bash --- æŒ‡å®šè„šæœ¬è§£é‡Šå™¨echo &quot;ä½ å¥½ï¼Œshell !&quot; ---å‘çª—å£è¾“å…¥æ–‡æœ¬:&lt;&lt;!å†™shellçš„ä¹ æƒ¯ ç¬¬ä¸€è¡ŒæŒ‡å®šè§£é‡Šå™¨æ–‡ä»¶æ˜¯shä¸ºåç¼€åæ‹¬å·æˆå¯¹ä¹¦å†™æ³¨é‡Šçš„æ—¶å€™å°½é‡ä¸ç”¨ä¸­æ–‡æ³¨é‡Šã€‚ä¸å‹å¥½ã€‚[] æ‹¬å·ä¸¤ç«¯è¦è¦æœ‰ç©ºæ ¼ã€‚ [ neirong ]ä¹ æƒ¯ä»£ç ç´¢å¼•ï¼Œå¢åŠ é˜…è¯»æ€§å†™è¯­å¥çš„æ—¶å€™ï¼Œå°½é‡å†™å…¨äº†ï¼Œæ¯”å¦‚ifã€‚ã€‚ã€‚! æŸ¥çœ‹ s.shæ–‡ä»¶ï¼šls -l s.shæ–‡ä»¶æƒé™æ˜¯ã€-rw-rw-râ€“ã€‘ chmod a+x s.sh s.shæ–‡ä»¶æƒé™æ˜¯ã€-rwxrwxr-xã€‘ æ‰§è¡Œæ–‡ä»¶ï¼š.&#x2F;s.sh æˆ–è€…ç›´æ¥ bash s.sh æ³¨æ„ï¼š #! æ˜¯ä¸€ä¸ªçº¦å®šçš„æ ‡è®°ï¼Œå‘Šè¯‰ç³»ç»Ÿè¿™ä¸ªè„šæœ¬éœ€è¦ä»€ä¹ˆè§£é‡Šå™¨æ¥æ‰§è¡Œï¼Œå³ä½¿ç”¨å“ªä¸€ç§ Shell echo å‘½ä»¤ç”¨äºå‘çª—å£è¾“å‡ºæ–‡æœ¬ æ³¨é‡Š å•è¡Œæ³¨é‡Šï¼šä»¥ # å¼€å¤´çš„è¡Œå°±æ˜¯æ³¨é‡Šï¼Œä¼šè¢«è§£é‡Šå™¨å¿½ç•¥ å¤šè¡Œæ³¨é‡Šï¼š 1234:&lt;&lt;EOFæ³¨é‡Šå†…å®¹...æ³¨é‡Šå†…å®¹...EOF 12345:&lt;&lt;! -----è¿™é‡Œçš„ç¬¦å·è¦å’Œç»“å°¾å¤„çš„ä¸€æ ·æ³¨é‡Šå†…å®¹...æ³¨é‡Šå†…å®¹...æ³¨é‡Šå†…å®¹...! å˜é‡å®šä¹‰å˜é‡å˜é‡åå’Œç­‰å·ä¹‹é—´ä¸èƒ½æœ‰ç©ºæ ¼ï¼Œè¿™å¯èƒ½å’Œä½ ç†Ÿæ‚‰çš„æ‰€æœ‰ç¼–ç¨‹è¯­è¨€éƒ½ä¸ä¸€æ ·ã€‚åŒæ—¶ï¼Œå˜é‡åçš„å‘½åé¡»éµå¾ªå¦‚ä¸‹è§„åˆ™ï¼š å‘½ååªèƒ½ä½¿ç”¨è‹±æ–‡å­—æ¯ï¼Œæ•°å­—å’Œä¸‹åˆ’çº¿ï¼Œé¦–ä¸ªå­—ç¬¦ä¸èƒ½ä»¥æ•°å­—å¼€å¤´ã€‚ ä¸­é—´ä¸èƒ½æœ‰ç©ºæ ¼ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹åˆ’çº¿ï¼ˆ_ï¼‰ã€‚ ä¸èƒ½ä½¿ç”¨æ ‡ç‚¹ç¬¦å·ã€‚ ä¸èƒ½ä½¿ç”¨bashé‡Œçš„å…³é”®å­—ï¼ˆå¯ç”¨helpå‘½ä»¤æŸ¥çœ‹ä¿ç•™å…³é”®å­—ï¼‰ã€‚ ä½¿ç”¨å˜é‡ ä½¿ç”¨ä¸€ä¸ªå®šä¹‰è¿‡çš„å˜é‡ï¼Œåªè¦åœ¨å˜é‡åå‰é¢åŠ ç¾å…ƒç¬¦å·$å³å¯ 1234name=&quot;seazean&quot;echo $nameecho $&#123;name&#125;name=&quot;zhy&quot; å·²å®šä¹‰çš„å˜é‡ï¼Œå¯ä»¥è¢«é‡æ–°å®šä¹‰å˜é‡å å¤–é¢çš„èŠ±æ‹¬å·æ˜¯å¯é€‰çš„ï¼ŒåŠ ä¸åŠ éƒ½è¡Œï¼ŒåŠ èŠ±æ‹¬å·æ˜¯ä¸ºäº†å¸®åŠ©è§£é‡Šå™¨è¯†åˆ«å˜é‡çš„è¾¹ç•Œã€‚æ¨èåŠ ï¼ï¼ 12æ¯”å¦‚ï¼šecho &quot;I am good at $&#123;shell-t&#125;Script&quot;é€šè¿‡ä¸Šé¢çš„è„šæœ¬æˆ‘ä»¬å‘ç°ï¼Œå¦‚æœä¸ç»™shell-tå˜é‡åŠ èŠ±æ‹¬å·ï¼Œå†™æˆecho &quot;I am good at $shell-tScript&quot;ï¼Œè§£é‡Šå™¨shellå°±ä¼šæŠŠ$shell-tScriptå½“æˆä¸€ä¸ªå˜é‡ï¼Œç”±äºæˆ‘ä»¬å‰é¢æ²¡æœ‰å®šä¹‰shell-tå˜é‡ï¼Œé‚£ä¹ˆè§£é‡Šå™¨æ‰§è¡Œæ‰§è¡Œçš„ç»“æœè‡ªç„¶å°±ä¸ºç©ºäº†ã€‚ åªè¯»å˜é‡ä½¿ç”¨ readonly å‘½ä»¤å¯ä»¥å°†å˜é‡å®šä¹‰ä¸ºåªè¯»å˜é‡ï¼Œåªè¯»å˜é‡çš„å€¼ä¸èƒ½è¢«æ”¹å˜ã€‚(ç±»ä¼¼äºfinal) 12345#!/bin/bashmyUrl=&quot;https://www.baidu.com&quot;readonly myUrlmyUrl=&quot;https://cn.bing.com/&quot; #æŠ¥é”™ myUrl readonly åˆ é™¤å˜é‡ä½¿ç”¨ unset å‘½ä»¤å¯ä»¥åˆ é™¤å˜é‡ï¼Œå˜é‡è¢«åˆ é™¤åä¸èƒ½å†æ¬¡ä½¿ç”¨ã€‚ è¯­æ³•ï¼šunset variable_name 1234#!/bin/shmyUrl=&quot;https://www.baidu.com&quot;unset myUrlecho $myUrl å®šä¹‰myUrlå˜é‡ï¼Œé€šè¿‡unsetåˆ é™¤å˜é‡ï¼Œç„¶åé€šè¿‡echoè¿›è¡Œè¾“å‡ºï¼Œç»“æœæ˜¯ä¸ºç©ºï¼Œæ²¡æœ‰ä»»ä½•çš„ç»“æœè¾“å‡ºã€‚ å­—ç¬¦å˜é‡ å­—ç¬¦ä¸²æ˜¯shellç¼–ç¨‹ä¸­æœ€å¸¸ç”¨ä¹Ÿæ˜¯æœ€æœ‰ç”¨çš„æ•°æ®ç±»å‹ï¼Œå­—ç¬¦ä¸²å¯ä»¥ç”¨å•å¼•å·ï¼Œä¹Ÿå¯ä»¥ç”¨åŒå¼•å·ï¼Œä¹Ÿå¯ä»¥ä¸ç”¨å¼•å·ï¼Œåœ¨Java SEä¸­æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå­—ç¬¦ä¸²é€šè¿‡Stirng s&#x3D;â€œabcâ€ åŒå¼•å·çš„å½¢å¼è¿›è¡Œå®šä¹‰ï¼Œè€Œåœ¨shellä¸­ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚ å¼•å· å•å¼•å· 1str=&#x27;this is a string variable&#x27; å•å¼•å·å­—ç¬¦ä¸²çš„é™åˆ¶ï¼š å•å¼•å·é‡Œçš„ä»»ä½•å­—ç¬¦éƒ½ä¼šåŸæ ·è¾“å‡ºï¼Œå•å¼•å·å­—ç¬¦ä¸²ä¸­çš„å˜é‡æ˜¯æ— æ•ˆçš„ï¼› å•å¼•å·å­—ä¸²ä¸­ä¸èƒ½å‡ºç°å•ç‹¬ä¸€ä¸ªçš„å•å¼•å·ï¼ˆå¯¹å•å¼•å·ä½¿ç”¨è½¬ä¹‰ç¬¦åä¹Ÿä¸è¡Œï¼‰ï¼Œä½†å¯æˆå¯¹å‡ºç°ï¼Œä½œä¸ºå­—ç¬¦ä¸²æ‹¼æ¥ä½¿ç”¨ã€‚ åŒå¼•å· 123your_name=&#x27;frank&#x27;str=&quot;Hello,\\&quot;$your_name\\&quot;! \\n&quot;echo -e $str #Hello, &quot;frank&quot;! åŒå¼•å·çš„ä¼˜ç‚¹ï¼š åŒå¼•å·é‡Œå¯ä»¥æœ‰å˜é‡ åŒå¼•å·é‡Œå¯ä»¥å‡ºç°è½¬ä¹‰å­—ç¬¦ æ‹¼æ¥å­—ç¬¦ä¸²123456your_name=&quot;frank&quot;# ä½¿ç”¨åŒå¼•å·æ‹¼æ¥greeting=&quot;hello, &quot;$your_name&quot; !&quot;greeting_1=&quot;hello, $&#123;your_name&#125; !&quot;echo $greeting $greeting_1#hello,frank! hello,frank è·å–å­—ç¬¦ä¸²é•¿åº¦å‘½ä»¤ï¼š&#96;$","categories":[],"tags":[]},{"title":"","slug":"SSM","date":"2025-05-20T16:25:06.362Z","updated":"2023-04-07T03:39:44.000Z","comments":true,"path":"2025/05/21/SSM/","link":"","permalink":"https://dddwah11.github.io/2025/05/21/SSM/","excerpt":"","text":"MyBatisåŸºæœ¬ä»‹ç»ORMï¼ˆObject Relational Mappingï¼‰ï¼š å¯¹è±¡å…³ç³»æ˜ å°„ï¼ŒæŒ‡çš„æ˜¯æŒä¹…åŒ–æ•°æ®å’Œå®ä½“å¯¹è±¡çš„æ˜ å°„æ¨¡å¼ï¼Œè§£å†³é¢å‘å¯¹è±¡ä¸å…³ç³»å‹æ•°æ®åº“å­˜åœ¨çš„äº’ä¸åŒ¹é…çš„ç°è±¡ MyBatisï¼š MyBatis æ˜¯ä¸€ä¸ªä¼˜ç§€çš„åŸºäº Java çš„æŒä¹…å±‚æ¡†æ¶ï¼Œå®ƒå†…éƒ¨å°è£…äº† JDBCï¼Œä½¿å¼€å‘è€…åªéœ€å…³æ³¨ SQL è¯­å¥æœ¬èº«ï¼Œè€Œä¸éœ€è¦èŠ±è´¹ç²¾åŠ›å»å¤„ç†åŠ è½½é©±åŠ¨ã€åˆ›å»ºè¿æ¥ã€åˆ›å»º Statement ç­‰è¿‡ç¨‹ã€‚ MyBatis é€šè¿‡ XML æˆ–æ³¨è§£çš„æ–¹å¼å°†è¦æ‰§è¡Œçš„å„ç§ Statement é…ç½®èµ·æ¥ï¼Œå¹¶é€šè¿‡ Java å¯¹è±¡å’Œ Statement ä¸­ SQL çš„åŠ¨æ€å‚æ•°è¿›è¡Œæ˜ å°„ç”Ÿæˆæœ€ç»ˆæ‰§è¡Œçš„ SQL è¯­å¥ã€‚ MyBatis æ¡†æ¶æ‰§è¡Œ SQL å¹¶å°†ç»“æœæ˜ å°„ä¸º Java å¯¹è±¡å¹¶è¿”å›ã€‚é‡‡ç”¨ ORM æ€æƒ³è§£å†³äº†å®ä½“å’Œæ•°æ®åº“æ˜ å°„çš„é—®é¢˜ï¼Œå¯¹ JDBC è¿›è¡Œäº†å°è£…ï¼Œå±è”½äº† JDBC åº•å±‚ API çš„è°ƒç”¨ç»†èŠ‚ï¼Œä½¿æˆ‘ä»¬ä¸ç”¨æ“ä½œ JDBC APIï¼Œå°±å¯ä»¥å®Œæˆå¯¹æ•°æ®åº“çš„æŒä¹…åŒ–æ“ä½œã€‚ MyBatis å®˜ç½‘åœ°å€ï¼šhttp://www.mybatis.org/mybatis-3/ å‚è€ƒè§†é¢‘ï¼šhttps://space.bilibili.com/37974444/ åŸºæœ¬æ“ä½œç›¸å…³APIResourcesï¼šåŠ è½½èµ„æºçš„å·¥å…·ç±» InputStream getResourceAsStream(String fileName)ï¼šé€šè¿‡ç±»åŠ è½½å™¨è¿”å›æŒ‡å®šèµ„æºçš„å­—èŠ‚æµ å‚æ•° fileName æ˜¯æ”¾åœ¨ src çš„æ ¸å¿ƒé…ç½®æ–‡ä»¶åï¼šMyBatisConfig.xml SqlSessionFactoryBuilderï¼šæ„å»ºå™¨ï¼Œç”¨æ¥è·å– SqlSessionFactory å·¥å‚å¯¹è±¡ SqlSessionFactory build(InputStream is)ï¼šé€šè¿‡æŒ‡å®šèµ„æºçš„å­—èŠ‚è¾“å…¥æµè·å– SqlSession å·¥å‚å¯¹è±¡ SqlSessionFactoryï¼šè·å– SqlSession æ„å»ºè€…å¯¹è±¡çš„å·¥å‚æ¥å£ SqlSession openSession()ï¼šè·å– SqlSession æ„å»ºè€…å¯¹è±¡ï¼Œå¹¶å¼€å¯æ‰‹åŠ¨æäº¤äº‹åŠ¡ SqlSession openSession(boolean)ï¼šè·å– SqlSession æ„å»ºè€…å¯¹è±¡ï¼Œå‚æ•°ä¸º true å¼€å¯è‡ªåŠ¨æäº¤äº‹åŠ¡ SqlSessionï¼šæ„å»ºè€…å¯¹è±¡æ¥å£ï¼Œç”¨äºæ‰§è¡Œ SQLã€ç®¡ç†äº‹åŠ¡ã€æ¥å£ä»£ç† SqlSession ä»£è¡¨å’Œæ•°æ®åº“çš„ä¸€æ¬¡ä¼šè¯ï¼Œç”¨å®Œå¿…é¡»å…³é—­ SqlSession å’Œ Connection ä¸€æ ·éƒ½æ˜¯éçº¿ç¨‹å®‰å…¨ï¼Œæ¯æ¬¡ä½¿ç”¨éƒ½åº”è¯¥å»è·å–æ–°çš„å¯¹è±¡ æ³¨ï¼šupdate æ•°æ®éœ€è¦æäº¤äº‹åŠ¡ï¼Œæˆ–å¼€å¯é»˜è®¤æäº¤ SqlSession å¸¸ç”¨ APIï¼š æ–¹æ³• è¯´æ˜ List selectList(String statement,Object parameter) æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ï¼Œè¿”å›Listé›†åˆ T selectOne(String statement,Object parameter) æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ï¼Œè¿”å›ä¸€ä¸ªç»“æœå¯¹è±¡ int insert(String statement,Object parameter) æ‰§è¡Œæ–°å¢è¯­å¥ï¼Œè¿”å›å½±å“è¡Œæ•° int update(String statement,Object parameter) æ‰§è¡Œåˆ é™¤è¯­å¥ï¼Œè¿”å›å½±å“è¡Œæ•° int delete(String statement,Object parameter) æ‰§è¡Œä¿®æ”¹è¯­å¥ï¼Œè¿”å›å½±å“è¡Œæ•° void commit() æäº¤äº‹åŠ¡ void rollback() å›æ»šäº‹åŠ¡ T getMapper(Class cls) è·å–æŒ‡å®šæ¥å£çš„ä»£ç†å®ç°ç±»å¯¹è±¡ void close() é‡Šæ”¾èµ„æº æ˜ å°„é…ç½®æ˜ å°„é…ç½®æ–‡ä»¶åŒ…å«äº†æ•°æ®å’Œå¯¹è±¡ä¹‹é—´çš„æ˜ å°„å…³ç³»ä»¥åŠè¦æ‰§è¡Œçš„ SQL è¯­å¥ï¼Œæ”¾åœ¨ src ç›®å½•ä¸‹ å‘½åï¼šStudentMapper.xml æ˜ å°„é…ç½®æ–‡ä»¶çš„æ–‡ä»¶å¤´ï¼š 1234&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt; æ ¹æ ‡ç­¾ï¼š ï¼šæ ¸å¿ƒæ ¹æ ‡ç­¾ namespaceï¼šå±æ€§ï¼Œåç§°ç©ºé—´ åŠŸèƒ½æ ‡ç­¾ï¼š &lt; select &gt;ï¼šæŸ¥è¯¢åŠŸèƒ½æ ‡ç­¾ ï¼šæ–°å¢åŠŸèƒ½æ ‡ç­¾ ï¼šä¿®æ”¹åŠŸèƒ½æ ‡ç­¾ ï¼šåˆ é™¤åŠŸèƒ½æ ‡ç­¾ idï¼šå±æ€§ï¼Œå”¯ä¸€æ ‡è¯†ï¼Œé…åˆåç§°ç©ºé—´ä½¿ç”¨ resultTypeï¼šæŒ‡å®šç»“æœæ˜ å°„å¯¹è±¡ç±»å‹ï¼Œå’Œå¯¹åº”çš„æ–¹æ³•çš„è¿”å›å€¼ç±»å‹ï¼ˆå…¨é™å®šåï¼‰ä¿æŒä¸€è‡´ï¼Œä½†æ˜¯å¦‚æœè¿”å›å€¼æ˜¯ List åˆ™å’Œå…¶æ³›å‹ä¿æŒä¸€è‡´ parameterTypeï¼šæŒ‡å®šå‚æ•°æ˜ å°„å¯¹è±¡ç±»å‹ï¼Œå¿…é¡»å’Œå¯¹åº”çš„æ–¹æ³•çš„å‚æ•°ç±»å‹ï¼ˆå…¨é™å®šåï¼‰ä¿æŒä¸€è‡´ statementTypeï¼šå¯é€‰ STATEMENTï¼ŒPREPARED æˆ– CALLABLEï¼Œé»˜è®¤å€¼ï¼šPREPARED STATEMENTï¼šç›´æ¥æ“ä½œ SQLï¼Œä½¿ç”¨ Statement ä¸è¿›è¡Œé¢„ç¼–è¯‘ï¼Œè·å–æ•°æ®ï¼š$ PREPAREDï¼šé¢„å¤„ç†å‚æ•°ï¼Œä½¿ç”¨ PreparedStatement è¿›è¡Œé¢„ç¼–è¯‘ï¼Œè·å–æ•°æ®ï¼š# CALLABLEï¼šæ‰§è¡Œå­˜å‚¨è¿‡ç¨‹ï¼ŒCallableStatement å‚æ•°è·å–æ–¹å¼ï¼š SQL è·å–å‚æ•°ï¼š#&#123;å±æ€§å&#125; 12345&lt;mapper namespace=&quot;StudentMapper&quot;&gt; &lt;select id=&quot;selectById&quot; resultType=&quot;student&quot; parameterType=&quot;int&quot;&gt; SELECT * FROM student WHERE id = #&#123;id&#125; &lt;/select&gt;&lt;mapper/&gt; å¼ºçƒˆæ¨èå®˜æ–¹æ–‡æ¡£ï¼šhttps://mybatis.org/mybatis-3/zh/sqlmap-xml.html æ ¸å¿ƒé…ç½®æ ¸å¿ƒé…ç½®æ–‡ä»¶åŒ…å«äº† MyBatis æœ€æ ¸å¿ƒçš„è®¾ç½®å’Œå±æ€§ä¿¡æ¯ï¼Œå¦‚æ•°æ®åº“çš„è¿æ¥ã€äº‹åŠ¡ã€è¿æ¥æ± ä¿¡æ¯ç­‰ å‘½åï¼šMyBatisConfig.xml æ ¸å¿ƒé…ç½®æ–‡ä»¶çš„æ–‡ä»¶å¤´ï¼š 12&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;&lt;!DOCTYPE configuration PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt; æ ¹æ ‡ç­¾ï¼š ï¼šæ ¸å¿ƒæ ¹æ ‡ç­¾ å¼•å…¥è¿æ¥é…ç½®æ–‡ä»¶ï¼š ï¼š å¼•å…¥æ•°æ®åº“è¿æ¥é…ç½®æ–‡ä»¶æ ‡ç­¾ resourceï¼šå±æ€§ï¼ŒæŒ‡å®šé…ç½®æ–‡ä»¶å 1&lt;properties resource=&quot;jdbc.properties&quot;/&gt; è°ƒæ•´è®¾ç½® ï¼šå¯ä»¥æ”¹å˜ Mybatis è¿è¡Œæ—¶è¡Œä¸º èµ·åˆ«åï¼š ï¼šä¸ºå…¨ç±»åèµ·åˆ«åçš„çˆ¶æ ‡ç­¾ ï¼šä¸ºå…¨ç±»åèµ·åˆ«åçš„å­æ ‡ç­¾ typeï¼šæŒ‡å®šå…¨ç±»å aliasï¼šæŒ‡å®šåˆ«å ï¼šä¸ºæŒ‡å®šåŒ…ä¸‹æ‰€æœ‰ç±»èµ·åˆ«åçš„å­æ ‡ç­¾ï¼Œåˆ«åå°±æ˜¯ç±»åï¼Œé¦–å­—æ¯å°å†™ 123456&lt;!--èµ·åˆ«å--&gt;&lt;typeAliases&gt; &lt;typeAlias type=&quot;bean.Student&quot; alias=&quot;student&quot;/&gt; &lt;package name=&quot;com.seazean.bean&quot;/&gt; &lt;!--äºŒé€‰ä¸€--&gt;&lt;/typeAliase&gt; è‡ªå¸¦åˆ«åï¼š åˆ«å æ•°æ®ç±»å‹ string java.lang.String long java.lang.Lang int java.lang.Integer double java.lang.Double boolean java.lang.Boolean â€¦. â€¦â€¦ é…ç½®ç¯å¢ƒï¼Œå¯ä»¥é…ç½®å¤šä¸ªæ ‡ç­¾ ï¼šé…ç½®æ•°æ®åº“ç¯å¢ƒæ ‡ç­¾ï¼Œdefault å±æ€§æŒ‡å®šå“ªä¸ª environment ï¼šé…ç½®æ•°æ®åº“ç¯å¢ƒå­æ ‡ç­¾ï¼Œid å±æ€§æ˜¯å”¯ä¸€æ ‡è¯†ï¼Œä¸ default å¯¹åº” ï¼šäº‹åŠ¡ç®¡ç†æ ‡ç­¾ï¼Œtype å±æ€§é»˜è®¤ JDBC äº‹åŠ¡ ï¼šæ•°æ®æºæ ‡ç­¾ type å±æ€§ï¼šPOOLED ä½¿ç”¨è¿æ¥æ± ï¼ˆMyBatis å†…ç½®ï¼‰ï¼ŒUNPOOLED ä¸ä½¿ç”¨è¿æ¥æ±  ï¼šæ•°æ®åº“è¿æ¥ä¿¡æ¯æ ‡ç­¾ã€‚ name å±æ€§å–å€¼ï¼šdriverï¼Œurlï¼Œusernameï¼Œpassword value å±æ€§å–å€¼ï¼šä¸ name å¯¹åº” å¼•å…¥æ˜ å°„é…ç½®æ–‡ä»¶ ï¼šå¼•å…¥æ˜ å°„é…ç½®æ–‡ä»¶æ ‡ç­¾ ï¼šå¼•å…¥æ˜ å°„é…ç½®æ–‡ä»¶å­æ ‡ç­¾ resourceï¼šå±æ€§æŒ‡å®šæ˜ å°„é…ç½®æ–‡ä»¶çš„åç§° urlï¼šå¼•ç”¨ç½‘è·¯è·¯å¾„æˆ–è€…ç£ç›˜è·¯å¾„ä¸‹çš„ sql æ˜ å°„æ–‡ä»¶ classï¼šæŒ‡å®šæ˜ å°„é…ç½®ç±» ï¼šæ‰¹é‡æ³¨å†Œ å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šhttps://mybatis.org/mybatis-3/zh/configuration.html #{}å’Œ${}#{}ï¼šå ä½ç¬¦ï¼Œä¼ å…¥çš„å†…å®¹ä¼šä½œä¸ºå­—ç¬¦ä¸²åŠ ä¸Šå¼•å·ï¼Œä»¥é¢„ç¼–è¯‘çš„æ–¹å¼ä¼ å…¥ï¼Œå°† sql ä¸­çš„ #{} æ›¿æ¢ä¸º ? å·ï¼Œè°ƒç”¨ PreparedStatement çš„ set æ–¹æ³•æ¥èµ‹å€¼ï¼Œæœ‰æ•ˆçš„é˜²æ­¢ SQL æ³¨å…¥ï¼Œæé«˜ç³»ç»Ÿå®‰å…¨æ€§ ${}ï¼šæ‹¼æ¥ç¬¦ï¼Œä¼ å…¥çš„å†…å®¹ä¼šç›´æ¥æ›¿æ¢æ‹¼æ¥ï¼Œä¸ä¼šåŠ ä¸Šå¼•å·ï¼Œå¯èƒ½å­˜åœ¨ sql æ³¨å…¥çš„å®‰å…¨éšæ‚£ èƒ½ç”¨ #{} çš„åœ°æ–¹å°±ç”¨ #{}ï¼Œä¸ç”¨æˆ–å°‘ç”¨ ${} å¿…é¡»ä½¿ç”¨ ${} çš„æƒ…å†µï¼š è¡¨åä½œå‚æ•°æ—¶ï¼Œå¦‚ï¼šSELECT * FROM $&#123;tableName&#125; order by æ—¶ï¼Œå¦‚ï¼šSELECT * FROM t_user ORDER BY $&#123;columnName&#125; sql è¯­å¥ä½¿ç”¨ #{}ï¼Œproperties æ–‡ä»¶å†…å®¹è·å–ä½¿ç”¨ ${} æ—¥å¿—æ–‡ä»¶åœ¨æ—¥å¸¸å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæ’æŸ¥é—®é¢˜æ—¶éœ€è¦è¾“å‡º MyBatis çœŸæ­£æ‰§è¡Œçš„ SQL è¯­å¥ã€å‚æ•°ã€ç»“æœç­‰ä¿¡æ¯ï¼Œå°±å¯ä»¥å€ŸåŠ© log4j çš„åŠŸèƒ½æ¥å®ç°æ‰§è¡Œä¿¡æ¯çš„è¾“å‡ºã€‚ åœ¨æ ¸å¿ƒé…ç½®æ–‡ä»¶æ ¹æ ‡ç­¾å†…é…ç½® log4j 1234&lt;!--é…ç½®LOG4J--&gt;&lt;settings&gt; &lt;setting name=&quot;logImpl&quot; value=&quot;log4j&quot;/&gt;&lt;/settings&gt; åœ¨ src ç›®å½•ä¸‹åˆ›å»º log4j.properties 123456789101112# Global logging configurationlog4j.rootLogger=DEBUG, stdout# Console output...log4j.appender.stdout=org.apache.log4j.ConsoleAppenderlog4j.appender.stdout.layout=org.apache.log4j.PatternLayoutlog4j.appender.stdout.layout.ConversionPattern=%5p [%t] - %m%n#è¾“å‡ºåˆ°æ—¥å¿—æ–‡ä»¶ #log4j.appender.file=org.apache.log4j.FileAppender #log4j.appender.file.File=../logs/iask.log #log4j.appender.file.layout=org.apache.log4j.PatternLayout #log4j.appender.file.layout.ConversionPattern=%d&#123;yyyy-MM-dd HH:mm:ss&#125; %l %m%n pom.xml 12345678910&lt;dependency&gt; &lt;groupId&gt;org.slf4j&lt;/groupId&gt; &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt; &lt;version&gt;1.7.21&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.slf4j&lt;/groupId&gt; &lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt; &lt;version&gt;1.7.21&lt;/version&gt;&lt;/dependency&gt; ä»£ç å®ç° å®ä½“ç±» 123456public class Student &#123; private Integer id; private String name; private Integer age; .....&#125; StudentMapper 12345678910111213141516public interface StudentMapper &#123; //æŸ¥è¯¢å…¨éƒ¨ public abstract List&lt;Student&gt; selectAll(); //æ ¹æ®idæŸ¥è¯¢ public abstract Student selectById(Integer id); //æ–°å¢æ•°æ® public abstract Integer insert(Student stu); //ä¿®æ”¹æ•°æ® public abstract Integer update(Student stu); //åˆ é™¤æ•°æ® public abstract Integer delete(Integer id);&#125; config.properties 1234driver=com.mysql.jdbc.Driverurl=jdbc:mysql://192.168.2.184:3306/db1username=rootpassword=123456 MyBatisConfig.xml 123456789101112131415161718192021222324252627282930313233343536373839404142&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;&lt;!DOCTYPE configuration PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;&lt;!--æ ¸å¿ƒæ ¹æ ‡ç­¾--&gt;&lt;configuration&gt; &lt;!--å¼•å…¥æ•°æ®åº“è¿æ¥çš„é…ç½®æ–‡ä»¶--&gt; &lt;properties resource=&quot;jdbc.properties&quot;/&gt; &lt;!--é…ç½®LOG4J--&gt; &lt;settings&gt; &lt;setting name=&quot;logImpl&quot; value=&quot;log4j&quot;/&gt; &lt;/settings&gt; &lt;!--èµ·åˆ«å--&gt; &lt;typeAliases&gt; &lt;typeAlias type=&quot;bean.Student&quot; alias=&quot;student&quot;/&gt; &lt;!--&lt;package name=&quot;bean&quot;/&gt;--&gt; &lt;/typeAliases&gt; &lt;!--é…ç½®æ•°æ®åº“ç¯å¢ƒï¼Œå¯ä»¥å¤šä¸ªç¯å¢ƒï¼ŒdefaultæŒ‡å®šå“ªä¸ª--&gt; &lt;environments default=&quot;mysql&quot;&gt; &lt;!--idå±æ€§å”¯ä¸€æ ‡è¯†--&gt; &lt;environment id=&quot;mysql&quot;&gt; &lt;!--äº‹åŠ¡ç®¡ç†ï¼Œtypeå±æ€§ï¼Œé»˜è®¤JDBCäº‹åŠ¡--&gt; &lt;transactionManager type=&quot;JDBC&quot;&gt;&lt;/transactionManager&gt; &lt;!--æ•°æ®æºä¿¡æ¯ typeå±æ€§è¿æ¥æ± --&gt; &lt;dataSource type=&quot;POOLED&quot;&gt; &lt;!--propertyè·å–æ•°æ®åº“è¿æ¥çš„é…ç½®ä¿¡æ¯--&gt; &lt;property name=&quot;driver&quot; value=&quot;$&#123;driver&#125;&quot;/&gt; &lt;property name=&quot;url&quot; value=&quot;$&#123;url&#125;&quot;/&gt; &lt;property name=&quot;username&quot; value=&quot;$&#123;username&#125;&quot;/&gt; &lt;property name=&quot;password&quot; value=&quot;$&#123;password&#125;&quot;/&gt; &lt;/dataSource&gt; &lt;/environment&gt; &lt;/environments&gt; &lt;!--å¼•å…¥æ˜ å°„é…ç½®æ–‡ä»¶--&gt; &lt;mappers&gt; &lt;!--mapperå¼•å…¥æŒ‡å®šçš„æ˜ å°„é…ç½® resourceå±æ€§æ‰§è¡Œçš„æ˜ å°„é…ç½®æ–‡ä»¶çš„åç§°--&gt; &lt;mapper resource=&quot;StudentMapper.xml&quot;/&gt; &lt;/mappers&gt;&lt;/configuration&gt; StudentMapper.xml 123456789101112131415161718192021222324252627&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;&lt;mapper namespace=&quot;StudentMapper&quot;&gt; &lt;select id=&quot;selectAll&quot; resultType=&quot;student&quot;&gt; SELECT * FROM student &lt;/select&gt; &lt;select id=&quot;selectById&quot; resultType=&quot;student&quot; parameterType=&quot;int&quot;&gt; SELECT * FROM student WHERE id = #&#123;id&#125; &lt;/select&gt; &lt;insert id=&quot;insert&quot; parameterType=&quot;student&quot;&gt; INSERT INTO student VALUES (#&#123;id&#125;,#&#123;name&#125;,#&#123;age&#125;) &lt;/insert&gt; &lt;update id=&quot;update&quot; parameterType=&quot;student&quot;&gt; UPDATE student SET name = #&#123;name&#125;, age = #&#123;age&#125; WHERE id = #&#123;id&#125; &lt;/update&gt; &lt;delete id=&quot;delete&quot; parameterType=&quot;student&quot;&gt; DELETE FROM student WHERE id = #&#123;id&#125; &lt;/delete&gt;&lt;/mapper&gt; æ§åˆ¶å±‚æµ‹è¯•ä»£ç ï¼šæ ¹æ® id æŸ¥è¯¢ 123456789101112131415161718192021@Testpublic void selectById() throws Exception&#123; //1.åŠ è½½æ ¸å¿ƒé…ç½®æ–‡ä»¶ InputStream is = Resources.getResourceAsStream(&quot;MyBatisConfig.xml&quot;); //2.è·å–SqlSessionå·¥å‚å¯¹è±¡ SqlSessionFactory ssf = new SqlSessionFactoryBuilder().build(is); //3.é€šè¿‡å·¥å‚å¯¹è±¡è·å–SqlSessionå¯¹è±¡ SqlSession sqlSession = ssf.openSession(); //4.æ‰§è¡Œæ˜ å°„é…ç½®æ–‡ä»¶ä¸­çš„sqlè¯­å¥ï¼Œå¹¶æ¥æ”¶ç»“æœ Student stu = sqlSession.selectOne(&quot;StudentMapper.selectById&quot;, 3); //5.å¤„ç†ç»“æœ System.out.println(stu); //6.é‡Šæ”¾èµ„æº sqlSession.close(); is.close();&#125; æ§åˆ¶å±‚æµ‹è¯•ä»£ç ï¼šæ–°å¢åŠŸèƒ½ 123456789101112131415161718192021@Testpublic void insert() throws Exception&#123; //1.åŠ è½½æ ¸å¿ƒé…ç½®æ–‡ä»¶ //2.è·å–SqlSessionå·¥å‚å¯¹è±¡ //3.é€šè¿‡å·¥å‚å¯¹è±¡è·å–SqlSessionå¯¹è±¡ SqlSession sqlSession = sqlSessionFactory.openSession(true); //4.æ‰§è¡Œæ˜ å°„é…ç½®æ–‡ä»¶ä¸­çš„sqlè¯­å¥ï¼Œå¹¶æ¥æ”¶ç»“æœ Student stu = new Student(5, &quot;å‘¨ä¸ƒ&quot;, 27); int result = sqlSession.insert(&quot;StudentMapper.insert&quot;, stu); //5.æäº¤äº‹åŠ¡ //sqlSession.commit(); //6.å¤„ç†ç»“æœ System.out.println(result); //7.é‡Šæ”¾èµ„æº sqlSession.close(); is.close();&#125; æ‰¹é‡æ“ä½œä¸‰ç§æ–¹å¼å®ç°æ‰¹é‡æ“ä½œï¼š æ ‡ç­¾å±æ€§ï¼šè¿™ç§æ–¹å¼å±äºå…¨å±€æ‰¹é‡ 123&lt;settings&gt; &lt;setting name=&quot;defaultExecutorType&quot; value=&quot;BATCH&quot;/&gt;&lt;/settings&gt; defaultExecutorTypeï¼šé…ç½®é»˜è®¤çš„æ‰§è¡Œå™¨ SIMPLE å°±æ˜¯æ™®é€šçš„æ‰§è¡Œå™¨ï¼ˆé»˜è®¤ï¼Œæ¯æ¬¡æ‰§è¡Œéƒ½è¦é‡æ–°è®¾ç½®å‚æ•°ï¼‰ REUSE æ‰§è¡Œå™¨ä¼šé‡ç”¨é¢„å¤„ç†è¯­å¥ï¼ˆåªé¢„è®¾ç½®ä¸€æ¬¡å‚æ•°ï¼Œå¤šæ¬¡æ‰§è¡Œï¼‰ BATCH æ‰§è¡Œå™¨ä¸ä»…é‡ç”¨è¯­å¥è¿˜ä¼šæ‰§è¡Œæ‰¹é‡æ›´æ–°ï¼ˆåªé’ˆå¯¹ä¿®æ”¹æ“ä½œï¼‰ SqlSession ä¼šè¯å†…æ‰¹é‡æ“ä½œï¼š 1234567891011121314151617181920public void testBatch() throws IOException&#123; SqlSessionFactory sqlSessionFactory = getSqlSessionFactory(); // å¯ä»¥æ‰§è¡Œæ‰¹é‡æ“ä½œçš„sqlSession SqlSession openSession = sqlSessionFactory.openSession(ExecutorType.BATCH); long start = System.currentTimeMillis(); try&#123; EmployeeMapper mapper = openSession.getMapper(EmployeeMapper.class); for (int i = 0; i &lt; 10000; i++) &#123; mapper.addEmp(new Employee(UUID.randomUUID().toString().substring(0, 5), &quot;b&quot;, &quot;1&quot;)); &#125; openSession.commit(); long end = System.currentTimeMillis(); // æ‰¹é‡ï¼šï¼ˆé¢„ç¼–è¯‘sqlä¸€æ¬¡==&gt;è®¾ç½®å‚æ•°===&gt;10000æ¬¡===&gt;æ‰§è¡Œ1æ¬¡ï¼ˆç±»ä¼¼ç®¡é“ï¼‰ï¼‰ // éæ‰¹é‡ï¼šï¼ˆé¢„ç¼–è¯‘sql=è®¾ç½®å‚æ•°=æ‰§è¡Œï¼‰==ã€‹10000 è€—æ—¶æ›´å¤š System.out.println(&quot;æ‰§è¡Œæ—¶é•¿ï¼š&quot; + (end - start)); &#125;finally&#123; openSession.close(); &#125;&#125; Spring é…ç½®æ–‡ä»¶æ–¹å¼ï¼ˆapplicationContext.xmlï¼‰ï¼š 12345&lt;!--é…ç½®ä¸€ä¸ªå¯ä»¥è¿›è¡Œæ‰¹é‡æ‰§è¡Œçš„sqlSession --&gt;&lt;bean id=&quot;sqlSession&quot; class=&quot;org.mybatis.spring.SqlSessionTemplate&quot;&gt; &lt;constructor-arg name=&quot;sqlSessionFactory&quot; ref=&quot;sqlSessionFactoryBean&quot;/&gt; &lt;constructor-arg name=&quot;executorType&quot; value=&quot;BATCH&quot;/&gt;&lt;/bean&gt; 12@Autowiredprivate SqlSession sqlSession; ä»£ç†å¼€å‘ä»£ç†è§„åˆ™åˆ†å±‚æ€æƒ³ï¼šæ§åˆ¶å±‚ï¼ˆcontrollerï¼‰ã€ä¸šåŠ¡å±‚ï¼ˆserviceï¼‰ã€æŒä¹…å±‚ï¼ˆdaoï¼‰ è°ƒç”¨æµç¨‹ï¼š ä¼ ç»Ÿæ–¹å¼å®ç° DAO å±‚ï¼Œéœ€è¦å†™æ¥å£å’Œå®ç°ç±»ã€‚é‡‡ç”¨ Mybatis çš„ä»£ç†å¼€å‘æ–¹å¼å®ç° DAO å±‚çš„å¼€å‘ï¼Œåªéœ€è¦ç¼–å†™ Mapper æ¥å£ï¼ˆç›¸å½“äº Dao æ¥å£ï¼‰ï¼Œç”± Mybatis æ¡†æ¶æ ¹æ®æ¥å£å®šä¹‰åˆ›å»ºæ¥å£çš„åŠ¨æ€ä»£ç†å¯¹è±¡ æ¥å£å¼€å‘æ–¹å¼ï¼š å®šä¹‰æ¥å£ æ“ä½œæ•°æ®åº“ï¼ŒMyBatis æ¡†æ¶æ ¹æ®æ¥å£ï¼Œé€šè¿‡åŠ¨æ€ä»£ç†çš„æ–¹å¼ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œè´Ÿè´£æ•°æ®åº“çš„æ“ä½œ Mapper æ¥å£å¼€å‘éœ€è¦éµå¾ªä»¥ä¸‹è§„èŒƒï¼š Mapper.xml æ–‡ä»¶ä¸­çš„ namespace ä¸ DAO å±‚ mapper æ¥å£çš„å…¨ç±»åç›¸åŒ Mapper.xml æ–‡ä»¶ä¸­çš„å¢åˆ æ”¹æŸ¥æ ‡ç­¾çš„idå±æ€§å’Œ DAO å±‚ Mapper æ¥å£æ–¹æ³•åç›¸åŒ Mapper.xml æ–‡ä»¶ä¸­çš„å¢åˆ æ”¹æŸ¥æ ‡ç­¾çš„ parameterType å±æ€§å’Œ DAO å±‚ Mapper æ¥å£æ–¹æ³•çš„å‚æ•°ç›¸åŒ Mapper.xml æ–‡ä»¶ä¸­çš„å¢åˆ æ”¹æŸ¥æ ‡ç­¾çš„ resultType å±æ€§å’Œ DAO å±‚ Mapper æ¥å£æ–¹æ³•çš„è¿”å›å€¼ç›¸åŒ å®ç°åŸç†é€šè¿‡åŠ¨æ€ä»£ç†å¼€å‘æ¨¡å¼ï¼Œåªç¼–å†™ä¸€ä¸ªæ¥å£ä¸å†™å®ç°ç±»ï¼Œé€šè¿‡ getMapper() æ–¹æ³•æœ€ç»ˆè·å–åˆ° MapperProxy ä»£ç†å¯¹è±¡ï¼Œè€Œè¿™ä¸ªä»£ç†å¯¹è±¡æ˜¯ MyBatis ä½¿ç”¨äº† JDK çš„åŠ¨æ€ä»£ç†æŠ€æœ¯ç”Ÿæˆçš„ åŠ¨æ€ä»£ç†å®ç°ç±»å¯¹è±¡åœ¨æ‰§è¡Œæ–¹æ³•æ—¶æœ€ç»ˆè°ƒç”¨äº† MapperMethod.execute() æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸­é€šè¿‡ switch case è¯­å¥æ ¹æ®æ“ä½œç±»å‹æ¥åˆ¤æ–­æ˜¯æ–°å¢ã€ä¿®æ”¹ã€åˆ é™¤ã€æŸ¥è¯¢æ“ä½œï¼Œæœ€åä¸€æ­¥å›åˆ°äº† MyBatis æœ€åŸç”Ÿçš„ SqlSession æ–¹å¼æ¥æ‰§è¡Œå¢åˆ æ”¹æŸ¥ ä»£ç å®ç°ï¼š 12345678910111213141516171819202122232425262728293031323334353637public Student selectById(Integer id) &#123; Student stu = null; SqlSession sqlSession = null; InputStream is = null; try&#123; //1.åŠ è½½æ ¸å¿ƒé…ç½®æ–‡ä»¶ is = Resources.getResourceAsStream(&quot;MyBatisConfig.xml&quot;); //2.è·å–SqlSessionå·¥å‚å¯¹è±¡ SqlSessionFactory s = new SqlSessionFactoryBuilder().build(is); //3.é€šè¿‡å·¥å‚å¯¹è±¡è·å–SqlSessionå¯¹è±¡ sqlSession = s.openSession(true); //4.è·å–StudentMapperæ¥å£çš„å®ç°ç±»å¯¹è±¡ StudentMapper mapper = sqlSession.getMapper(StudentMapper.class); //5.é€šè¿‡å®ç°ç±»å¯¹è±¡è°ƒç”¨æ–¹æ³•ï¼Œæ¥æ”¶ç»“æœ stu = mapper.selectById(id); &#125; catch (Exception e) &#123; e.getMessage(); &#125; finally &#123; //6.é‡Šæ”¾èµ„æº if(sqlSession != null) &#123; sqlSession.close(); &#125; if(is != null) &#123; try &#123; is.close(); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; &#125; &#125; //7.è¿”å›ç»“æœ return stu;&#125; ç»“æœæ˜ å°„ç›¸å…³æ ‡ç­¾ï¼šè¿”å›ç»“æœæ˜ å°„å¯¹è±¡ç±»å‹ï¼Œå’Œå¯¹åº”æ–¹æ³•çš„è¿”å›å€¼ç±»å‹ä¿æŒä¸€è‡´ï¼Œä½†æ˜¯å¦‚æœè¿”å›å€¼æ˜¯ List åˆ™å’Œå…¶æ³›å‹ä¿æŒä¸€è‡´ ï¼šè¿”å›ä¸€æ¡è®°å½•çš„ Mapï¼Œkey æ˜¯åˆ—åï¼Œvalue æ˜¯å¯¹åº”çš„å€¼ï¼Œç”¨æ¥é…ç½®å­—æ®µå’Œå¯¹è±¡å±æ€§çš„æ˜ å°„å…³ç³»æ ‡ç­¾ï¼Œç»“æœæ˜ å°„ï¼ˆå’Œ resultType äºŒé€‰ä¸€ï¼‰ id å±æ€§ï¼šå”¯ä¸€æ ‡è¯† type å±æ€§ï¼šå®ä½“å¯¹è±¡ç±»å‹ autoMapping å±æ€§ï¼šç»“æœè‡ªåŠ¨æ˜ å°„ å†…çš„æ ¸å¿ƒé…ç½®æ–‡ä»¶æ ‡ç­¾ï¼š ï¼šé…ç½®ä¸»é”®æ˜ å°„å…³ç³»æ ‡ç­¾ ï¼šé…ç½®éä¸»é”®æ˜ å°„å…³ç³»æ ‡ç­¾ column å±æ€§ï¼šè¡¨ä¸­å­—æ®µåç§° property å±æ€§ï¼š å®ä½“å¯¹è±¡å˜é‡åç§° ï¼šé…ç½®è¢«åŒ…å«å•ä¸ªå¯¹è±¡çš„æ˜ å°„å…³ç³»æ ‡ç­¾ï¼ŒåµŒå¥—å°è£…ç»“æœé›†ï¼ˆå¤šå¯¹ä¸€ã€ä¸€å¯¹ä¸€ï¼‰ property å±æ€§ï¼šè¢«åŒ…å«å¯¹è±¡çš„å˜é‡åï¼Œè¦è¿›è¡Œæ˜ å°„çš„å±æ€§å javaType å±æ€§ï¼šè¢«åŒ…å«å¯¹è±¡çš„æ•°æ®ç±»å‹ï¼Œè¦è¿›è¡Œæ˜ å°„çš„å±æ€§çš„ç±»å‹ï¼ˆJava ä¸­çš„ Bean ç±»ï¼‰ select å±æ€§ï¼šåŠ è½½å¤æ‚ç±»å‹å±æ€§çš„æ˜ å°„è¯­å¥çš„ IDï¼Œä¼šä» column å±æ€§æŒ‡å®šçš„åˆ—ä¸­æ£€ç´¢æ•°æ®ï¼Œä½œä¸ºå‚æ•°ä¼ é€’ç»™ç›®æ ‡ select è¯­å¥ ï¼šé…ç½®è¢«åŒ…å«é›†åˆå¯¹è±¡çš„æ˜ å°„å…³ç³»æ ‡ç­¾ï¼ŒåµŒå¥—å°è£…ç»“æœé›†ï¼ˆä¸€å¯¹å¤šã€å¤šå¯¹å¤šï¼‰ property å±æ€§ï¼šè¢«åŒ…å«é›†åˆå¯¹è±¡çš„å˜é‡å ofType å±æ€§ï¼šé›†åˆä¸­ä¿å­˜çš„å¯¹è±¡æ•°æ®ç±»å‹ ï¼šé‰´åˆ«å™¨ï¼Œç”¨æ¥åˆ¤æ–­æŸåˆ—çš„å€¼ï¼Œæ ¹æ®å¾—åˆ°æŸåˆ—çš„ä¸åŒå€¼åšå‡ºä¸åŒè‡ªå®šä¹‰çš„å°è£…è¡Œä¸º è‡ªå®šä¹‰å°è£…è§„åˆ™å¯ä»¥å°†æ•°æ®åº“ä¸­æ¯”è¾ƒå¤æ‚çš„æ•°æ®ç±»å‹æ˜ å°„ä¸º JavaBean ä¸­çš„å±æ€§ åµŒå¥—æŸ¥è¯¢å­æŸ¥è¯¢ï¼š 123456public class Blog &#123; private int id; private String msg; private Author author; // set + get&#125; 1234567891011&lt;resultMap id=&quot;blogResult&quot; type=&quot;Blog&quot; autoMapping = &quot;true&quot;&gt; &lt;association property=&quot;author&quot; column=&quot;author_id&quot; javaType=&quot;Author&quot; select=&quot;selectAuthor&quot;/&gt;&lt;/resultMap&gt;&lt;select id=&quot;selectBlog&quot; resultMap=&quot;blogResult&quot;&gt; SELECT * FROM BLOG WHERE ID = #&#123;id&#125;&lt;/select&gt;&lt;select id=&quot;selectAuthor&quot; resultType=&quot;Author&quot;&gt; SELECT * FROM AUTHOR WHERE ID = #&#123;id&#125;&lt;/select&gt; å¾ªç¯å¼•ç”¨ï¼šé€šè¿‡ç¼“å­˜è§£å†³ 123456&lt;resultMap id=&quot;blogResult&quot; type=&quot;Blog&quot; autoMapping = &quot;true&quot;&gt; &lt;id column=&quot;id&quot; property=&quot;id&quot;/&gt; &lt;collection property=&quot;comment&quot; ofType=&quot;Comment&quot;&gt; &lt;association property=&quot;blog&quot; javaType=&quot;Blog&quot; resultMap=&quot;blogResult&quot;/&gt;&lt;!--y--&gt; &lt;/collection&gt;&lt;/resultMap å¤šè¡¨æŸ¥è¯¢ä¸€å¯¹ä¸€ä¸€å¯¹ä¸€å®ç°ï¼š æ•°æ®å‡†å¤‡ 1234567891011121314CREATE TABLE person( id INT PRIMARY KEY AUTO_INCREMENT, name VARCHAR(20), age INT);INSERT INTO person VALUES (NULL,&#x27;å¼ ä¸‰&#x27;,23),(NULL,&#x27;æå››&#x27;,24),(NULL,&#x27;ç‹äº”&#x27;,25);CREATE TABLE card( id INT PRIMARY KEY AUTO_INCREMENT, number VARCHAR(30), pid INT, CONSTRAINT cp_fk FOREIGN KEY (pid) REFERENCES person(id));INSERT INTO card VALUES (NULL,&#x27;12345&#x27;,1),(NULL,&#x27;23456&#x27;,2),(NULL,&#x27;34567&#x27;,3); bean ç±» 123456789101112public class Card &#123; private Integer id; //ä¸»é”®id private String number; //èº«ä»½è¯å· private Person p; //æ‰€å±äººçš„å¯¹è±¡ ......&#125;public class Person &#123; private Integer id; //ä¸»é”®id private String name; //äººçš„å§“å private Integer age; //äººçš„å¹´é¾„&#125; é…ç½®æ–‡ä»¶ OneToOneMapper.xmlï¼ŒMyBatisConfig.xml éœ€è¦å¼•å…¥ï¼ˆå¯ä»¥æŠŠ bean åŒ…ä¸‹èµ·åˆ«åï¼‰ 12345678910111213141516171819202122232425262728&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;&lt;mapper namespace=&quot;OneToOneMapper&quot;&gt; &lt;!--é…ç½®å­—æ®µå’Œå®ä½“å¯¹è±¡å±æ€§çš„æ˜ å°„å…³ç³»--&gt; &lt;resultMap id=&quot;oneToOne&quot; type=&quot;card&quot;&gt; &lt;!--column è¡¨ä¸­å­—æ®µåç§°ï¼Œproperty å®ä½“å¯¹è±¡å˜é‡åç§°--&gt; &lt;id column=&quot;cid&quot; property=&quot;id&quot; /&gt; &lt;result column=&quot;number&quot; property=&quot;number&quot; /&gt; &lt;!-- associationï¼šé…ç½®è¢«åŒ…å«å¯¹è±¡çš„æ˜ å°„å…³ç³» propertyï¼šè¢«åŒ…å«å¯¹è±¡çš„å˜é‡å javaTypeï¼šè¢«åŒ…å«å¯¹è±¡çš„æ•°æ®ç±»å‹ --&gt; &lt;association property=&quot;p&quot; javaType=&quot;bean.Person&quot;&gt; &lt;id column=&quot;pid&quot; property=&quot;id&quot; /&gt; &lt;result column=&quot;name&quot; property=&quot;name&quot; /&gt; &lt;result column=&quot;age&quot; property=&quot;age&quot; /&gt; &lt;/association&gt; &lt;/resultMap&gt; &lt;select id=&quot;selectAll&quot; resultMap=&quot;oneToOne&quot;&gt; &lt;!--SQL--&gt; SELECT c.id cid,number,pid,NAME,age FROM card c,person p WHERE c.pid=p.id &lt;/select&gt;&lt;/mapper&gt; æ ¸å¿ƒé…ç½®æ–‡ä»¶ MyBatisConfig.xml 123456&lt;!-- mapperså¼•å…¥æ˜ å°„é…ç½®æ–‡ä»¶ --&gt;&lt;mappers&gt; &lt;mapper resource=&quot;one_to_one/OneToOneMapper.xml&quot;/&gt; &lt;mapper resource=&quot;one_to_many/OneToManyMapper.xml&quot;/&gt; &lt;mapper resource=&quot;many_to_many/ManyToManyMapper.xml&quot;/&gt;&lt;/mappers&gt; æµ‹è¯•ç±» 12345678910111213141516171819202122232425262728public class Test01 &#123; @Test public void selectAll() throws Exception&#123; //1.åŠ è½½æ ¸å¿ƒé…ç½®æ–‡ä»¶ InputStream is = Resources.getResourceAsStream(&quot;MyBatisConfig.xml&quot;); //2.è·å–SqlSessionå·¥å‚å¯¹è±¡ SqlSessionFactory ssf = new SqlSessionFactoryBuilder().build(is); //3.é€šè¿‡å·¥å‚å¯¹è±¡è·å–SqlSessionå¯¹è±¡ SqlSession sqlSession = ssf.openSession(true); //4.è·å–OneToOneMapperæ¥å£çš„å®ç°ç±»å¯¹è±¡ OneToOneMapper mapper = sqlSession.getMapper(OneToOneMapper.class); //5.è°ƒç”¨å®ç°ç±»çš„æ–¹æ³•ï¼Œæ¥æ”¶ç»“æœ List&lt;Card&gt; list = mapper.selectAll(); //6.å¤„ç†ç»“æœ for (Card c : list) &#123; System.out.println(c); &#125; //7.é‡Šæ”¾èµ„æº sqlSession.close(); is.close(); &#125;&#125; ä¸€å¯¹å¤šä¸€å¯¹å¤šå®ç°ï¼š æ•°æ®å‡†å¤‡ 1234567891011121314CREATE TABLE classes( id INT PRIMARY KEY AUTO_INCREMENT, name VARCHAR(20));INSERT INTO classes VALUES (NULL,&#x27;ç¨‹åºä¸€ç­&#x27;),(NULL,&#x27;ç¨‹åºäºŒç­&#x27;)CREATE TABLE student( id INT PRIMARY KEY AUTO_INCREMENT, name VARCHAR(30), age INT, cid INT, CONSTRAINT cs_fk FOREIGN KEY (cid) REFERENCES classes(id));INSERT INTO student VALUES (NULL,&#x27;å¼ ä¸‰&#x27;,23,1),(NULL,&#x27;æå››&#x27;,24,1),(NULL,&#x27;ç‹äº”&#x27;,25,2); bean ç±» 1234567891011public class Classes &#123; private Integer id; //ä¸»é”®id private String name; //ç­çº§åç§° private List&lt;Student&gt; students; //ç­çº§ä¸­æ‰€æœ‰å­¦ç”Ÿå¯¹è±¡ ........&#125;public class Student &#123; private Integer id; //ä¸»é”®id private String name; //å­¦ç”Ÿå§“å private Integer age; //å­¦ç”Ÿå¹´é¾„&#125; æ˜ å°„é…ç½®æ–‡ä»¶ 12345678910111213141516&lt;mapper namespace=&quot;OneToManyMapper&quot;&gt; &lt;resultMap id=&quot;oneToMany&quot; type=&quot;bean.Classes&quot;&gt; &lt;id column=&quot;cid&quot; property=&quot;id&quot;/&gt; &lt;result column=&quot;cname&quot; property=&quot;name&quot;/&gt; &lt;!--collectionï¼šé…ç½®è¢«åŒ…å«çš„é›†åˆå¯¹è±¡æ˜ å°„å…³ç³»--&gt; &lt;collection property=&quot;students&quot; ofType=&quot;bean.Student&quot;&gt; &lt;id column=&quot;sid&quot; property=&quot;id&quot;/&gt; &lt;result column=&quot;sname&quot; property=&quot;name&quot;/&gt; &lt;result column=&quot;sage&quot; property=&quot;age&quot;/&gt; &lt;/collection&gt; &lt;/resultMap&gt; &lt;select id=&quot;selectAll&quot; resultMap=&quot;oneToMany&quot;&gt; &lt;!--SQL--&gt; SELECT c.id cid,c.name cname,s.id sid,s.name sname,s.age sage FROM classes c,student s WHERE c.id=s.cid &lt;/select&gt;&lt;/mapper&gt; ä»£ç å®ç°ç‰‡æ®µ 1234567891011121314//4.è·å–OneToManyMapperæ¥å£çš„å®ç°ç±»å¯¹è±¡OneToManyMapper mapper = sqlSession.getMapper(OneToManyMapper.class);//5.è°ƒç”¨å®ç°ç±»çš„æ–¹æ³•ï¼Œæ¥æ”¶ç»“æœList&lt;Classes&gt; classes = mapper.selectAll();//6.å¤„ç†ç»“æœfor (Classes cls : classes) &#123; System.out.println(cls.getId() + &quot;,&quot; + cls.getName()); List&lt;Student&gt; students = cls.getStudents(); for (Student student : students) &#123; System.out.println(&quot;\\t&quot; + student); &#125;&#125; å¤šå¯¹å¤šå­¦ç”Ÿè¯¾ç¨‹ä¾‹å­ï¼Œä¸­é—´è¡¨ä¸éœ€è¦ bean å®ä½“ç±» æ•°æ®å‡†å¤‡ 1234567891011121314CREATE TABLE course( id INT PRIMARY KEY AUTO_INCREMENT, name VARCHAR(20));INSERT INTO course VALUES (NULL,&#x27;è¯­æ–‡&#x27;),(NULL,&#x27;æ•°å­¦&#x27;);CREATE TABLE stu_cr( id INT PRIMARY KEY AUTO_INCREMENT, sid INT, cid INT, CONSTRAINT sc_fk1 FOREIGN KEY (sid) REFERENCES student(id), CONSTRAINT sc_fk2 FOREIGN KEY (cid) REFERENCES course(id));INSERT INTO stu_cr VALUES (NULL,1,1),(NULL,1,2),(NULL,2,1),(NULL,2,2); beanç±» 12345678910public class Student &#123; private Integer id; //ä¸»é”®id private String name; //å­¦ç”Ÿå§“å private Integer age; //å­¦ç”Ÿå¹´é¾„ private List&lt;Course&gt; courses; // å­¦ç”Ÿæ‰€é€‰æ‹©çš„è¯¾ç¨‹é›†åˆ&#125;public class Course &#123; private Integer id; //ä¸»é”®id private String name; //è¯¾ç¨‹åç§°&#125; é…ç½®æ–‡ä»¶ 123456789101112131415&lt;mapper namespace=&quot;ManyToManyMapper&quot;&gt; &lt;resultMap id=&quot;manyToMany&quot; type=&quot;Bean.Student&quot;&gt; &lt;id column=&quot;sid&quot; property=&quot;id&quot;/&gt; &lt;result column=&quot;sname&quot; property=&quot;name&quot;/&gt; &lt;result column=&quot;sage&quot; property=&quot;age&quot;/&gt; &lt;collection property=&quot;courses&quot; ofType=&quot;Bean.Course&quot;&gt; &lt;id column=&quot;cid&quot; property=&quot;id&quot;/&gt; &lt;result column=&quot;cname&quot; property=&quot;name&quot;/&gt; &lt;/collection&gt; &lt;/resultMap&gt; &lt;select id=&quot;selectAll&quot; resultMap=&quot;manyToMany&quot;&gt; &lt;!--SQL--&gt; SELECT sc.sid,s.name sname,s.age sage,sc.cid,c.name cname FROM student s,course c,stu_cr sc WHERE sc.sid=s.id AND sc.cid=c.id &lt;/select&gt;&lt;/mapper&gt; é‰´åˆ«å™¨éœ€æ±‚ï¼šå¦‚æœæŸ¥è¯¢ç»“æœæ˜¯å¥³æ€§ï¼Œåˆ™æŠŠéƒ¨é—¨ä¿¡æ¯æŸ¥è¯¢å‡ºæ¥ï¼Œå¦åˆ™ä¸æŸ¥è¯¢ ï¼›å¦‚æœæ˜¯ç”·æ€§ï¼ŒæŠŠ last_name è¿™ä¸€åˆ—çš„å€¼èµ‹å€¼ 1234567891011121314151617181920&lt;!-- columnï¼šæŒ‡å®šè¦åˆ¤æ–­çš„åˆ—å javaTypeï¼šåˆ—å€¼å¯¹åº”çš„javaç±»å‹ --&gt;&lt;discriminator javaType=&quot;string&quot; column=&quot;gender&quot;&gt; &lt;!-- å¥³ç”Ÿ --&gt; &lt;!-- resultTypeä¸å¯ç¼ºå°‘ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨resutlMap --&gt; &lt;case value=&quot;0&quot; resultType=&quot;com.bean.Employee&quot;&gt; &lt;association property=&quot;dept&quot; select=&quot;com.dao.DepartmentMapper.getDeptById&quot; column=&quot;d_id&quot;&gt; &lt;/association&gt; &lt;/case&gt; &lt;!-- ç”·ç”Ÿ --&gt; &lt;case value=&quot;1&quot; resultType=&quot;com.bean.Employee&quot;&gt; &lt;id column=&quot;id&quot; property=&quot;id&quot;/&gt; &lt;result column=&quot;last_name&quot; property=&quot;lastName&quot;/&gt; &lt;result column=&quot;gender&quot; property=&quot;gender&quot;/&gt; &lt;/case&gt;&lt;/discriminator&gt; å»¶è¿ŸåŠ è½½ä¸¤ç§åŠ è½½ç«‹å³åŠ è½½ï¼šåªè¦è°ƒç”¨æ–¹æ³•ï¼Œé©¬ä¸Šå‘èµ·æŸ¥è¯¢ å»¶è¿ŸåŠ è½½ï¼šåœ¨éœ€è¦ç”¨åˆ°æ•°æ®æ—¶æ‰è¿›è¡ŒåŠ è½½ï¼Œä¸éœ€è¦ç”¨åˆ°æ•°æ®æ—¶å°±ä¸åŠ è½½æ•°æ®ï¼Œå»¶è¿ŸåŠ è½½ä¹Ÿç§°æ‡’åŠ è½½ ä¼˜ç‚¹ï¼š å…ˆä»å•è¡¨æŸ¥è¯¢ï¼Œéœ€è¦æ—¶å†ä»å…³è”è¡¨å»å…³è”æŸ¥è¯¢ï¼Œæé«˜æ•°æ®åº“æ€§èƒ½ï¼Œå› ä¸ºæŸ¥è¯¢å•è¡¨è¦æ¯”å…³è”æŸ¥è¯¢å¤šå¼ è¡¨é€Ÿåº¦è¦å¿«ï¼ŒèŠ‚çœèµ„æº åå¤„ï¼šåªæœ‰å½“éœ€è¦ç”¨åˆ°æ•°æ®æ—¶ï¼Œæ‰ä¼šè¿›è¡Œæ•°æ®åº“æŸ¥è¯¢ï¼Œè¿™æ ·åœ¨å¤§æ‰¹é‡æ•°æ®æŸ¥è¯¢æ—¶ï¼ŒæŸ¥è¯¢å·¥ä½œä¹Ÿè¦æ¶ˆè€—æ—¶é—´ï¼Œæ‰€ä»¥å¯èƒ½é€ æˆç”¨æˆ·ç­‰å¾…æ—¶é—´å˜é•¿ï¼Œé€ æˆç”¨æˆ·ä½“éªŒä¸‹é™ æ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼š æ ‡ç­¾å æè¿° é»˜è®¤å€¼ lazyLoadingEnabled å»¶è¿ŸåŠ è½½çš„å…¨å±€å¼€å…³ã€‚å½“å¼€å¯æ—¶ï¼Œæ‰€æœ‰å…³è”å¯¹è±¡éƒ½ä¼šå»¶è¿ŸåŠ è½½ï¼Œç‰¹å®šå…³è”å…³ç³»ä¸­å¯é€šè¿‡è®¾ç½® fetchType å±æ€§æ¥è¦†ç›–è¯¥é¡¹çš„å¼€å…³çŠ¶æ€ã€‚ false aggressiveLazyLoading å¼€å¯æ—¶ï¼Œä»»ä¸€æ–¹æ³•çš„è°ƒç”¨éƒ½ä¼šåŠ è½½è¯¥å¯¹è±¡çš„æ‰€æœ‰å»¶è¿ŸåŠ è½½å±æ€§ã€‚å¦åˆ™æ¯ä¸ªå»¶è¿ŸåŠ è½½å±æ€§ä¼šæŒ‰éœ€åŠ è½½ï¼ˆå‚è€ƒ lazyLoadTriggerMethodsï¼‰ false 1234&lt;settings&gt; &lt;setting name=&quot;lazyLoadingEnabled&quot; value=&quot;true&quot;/&gt; &lt;setting name=&quot;aggressiveLazyLoading&quot; value=&quot;false&quot;/&gt; &lt;/settings&gt; assocationåˆ†å¸ƒæŸ¥è¯¢ï¼šå…ˆæŒ‰ç…§èº«ä»½ id æŸ¥è¯¢æ‰€å±äººçš„ idã€ç„¶åæ ¹æ®æ‰€å±äººçš„ id å»æŸ¥è¯¢äººçš„å…¨éƒ¨ä¿¡æ¯ï¼Œè¿™å°±æ˜¯åˆ†æ­¥æŸ¥è¯¢ æ˜ å°„é…ç½®æ–‡ä»¶ OneToOneMapper.xml ä¸€å¯¹ä¸€æ˜ å°„ï¼š column å±æ€§è¡¨ç¤ºç»™è¦è°ƒç”¨çš„å…¶å®ƒçš„ select æ ‡ç­¾ä¼ å…¥çš„å‚æ•° select å±æ€§è¡¨ç¤ºè°ƒç”¨å…¶å®ƒçš„ select æ ‡ç­¾ fetchType&#x3D;â€lazyâ€ è¡¨ç¤ºå»¶è¿ŸåŠ è½½ï¼ˆå±€éƒ¨é…ç½®ï¼Œåªæœ‰é…ç½®äº†è¿™ä¸ªçš„åœ°æ–¹æ‰ä¼šå»¶è¿ŸåŠ è½½ï¼‰ 1234567891011121314151617&lt;mapper namespace=&quot;OneToOneMapper&quot;&gt; &lt;!--é…ç½®å­—æ®µå’Œå®ä½“å¯¹è±¡å±æ€§çš„æ˜ å°„å…³ç³»--&gt; &lt;resultMap id=&quot;oneToOne&quot; type=&quot;card&quot;&gt; &lt;id column=&quot;id&quot; property=&quot;id&quot; /&gt; &lt;result column=&quot;number&quot; property=&quot;number&quot; /&gt; &lt;association property=&quot;p&quot; javaType=&quot;bean.Person&quot; column=&quot;pid&quot; select=&quot;one_to_one.PersonMapper.findPersonByid&quot; fetchType=&quot;lazy&quot;&gt; &lt;!--éœ€è¦é…ç½®æ–°çš„æ˜ å°„æ–‡ä»¶--&gt; &lt;/association&gt; &lt;/resultMap&gt; &lt;select id=&quot;selectAll&quot; resultMap=&quot;oneToOne&quot;&gt; SELECT * FROM card &lt;!--æŸ¥è¯¢å…¨éƒ¨ï¼Œè´Ÿè´£æ ¹æ®æ¡ä»¶ç›´æ¥å…¨éƒ¨åŠ è½½--&gt; &lt;/select&gt;&lt;/mapper&gt; PersonMapper.xml 12345&lt;mapper namespace=&quot;one_to_one.PersonMapper&quot;&gt; &lt;select id=&quot;findPersonByid&quot; parameterType=&quot;int&quot; resultType=&quot;person&quot;&gt; SELECT * FROM person WHERE id=#&#123;pid&#125; &lt;/select&gt;&lt;/mapper&gt; PersonMapper.java 123public interface PersonMapper &#123; User findPersonByid(int id);&#125; æµ‹è¯•æ–‡ä»¶ 1234567891011121314151617public class Test01 &#123; @Test public void selectAll() throws Exception&#123; InputStream is = Resources.getResourceAsStream(&quot;MyBatisConfig.xml&quot;); SqlSessionFactory ssf = new SqlSessionFactoryBuilder().build(is); SqlSession sqlSession = ssf.openSession(true); OneToOneMapper mapper = sqlSession.getMapper(OneToOneMapper.class); // è°ƒç”¨å®ç°ç±»çš„æ–¹æ³•ï¼Œæ¥æ”¶ç»“æœ List&lt;Card&gt; list = mapper.selectAll(); // ä¸èƒ½éå†ï¼Œéå†å°±æ˜¯ç›¸å½“äºä½¿ç”¨äº†è¯¥æ•°æ®ï¼Œéœ€è¦åŠ è½½ï¼Œä¸éå†å°±æ˜¯æ²¡æœ‰ä½¿ç”¨ã€‚ // é‡Šæ”¾èµ„æº sqlSession.close(); is.close(); &#125;&#125; collectionåŒæ ·åœ¨ä¸€å¯¹å¤šå…³ç³»é…ç½®çš„ ç»“ç‚¹ä¸­é…ç½®å»¶è¿ŸåŠ è½½ç­–ç•¥ï¼Œ ç»“ç‚¹ä¸­ä¹Ÿæœ‰ select å±æ€§å’Œ column å±æ€§ æ˜ å°„é…ç½®æ–‡ä»¶ OneToManyMapper.xml ä¸€å¯¹å¤šæ˜ å°„ï¼š column æ˜¯ç”¨äºæŒ‡å®šä½¿ç”¨å“ªä¸ªå­—æ®µçš„å€¼ä½œä¸ºæ¡ä»¶æŸ¥è¯¢ select æ˜¯ç”¨äºæŒ‡å®šæŸ¥è¯¢è´¦æˆ·çš„å”¯ä¸€æ ‡è¯†ï¼ˆè´¦æˆ·çš„ dao å…¨é™å®šç±»ååŠ ä¸Šæ–¹æ³•åç§°ï¼‰ 123456789101112131415&lt;mapper namespace=&quot;OneToManyMapper&quot;&gt; &lt;resultMap id=&quot;oneToMany&quot; type=&quot;bean.Classes&quot;&gt; &lt;id column=&quot;id&quot; property=&quot;id&quot;/&gt; &lt;result column=&quot;name&quot; property=&quot;name&quot;/&gt; &lt;!--collectionï¼šé…ç½®è¢«åŒ…å«çš„é›†åˆå¯¹è±¡æ˜ å°„å…³ç³»--&gt; &lt;collection property=&quot;students&quot; ofType=&quot;bean.Student&quot; column=&quot;id&quot; select=&quot;one_to_one.StudentMapper.findStudentByCid&quot;&gt; &lt;/collection&gt; &lt;/resultMap&gt; &lt;select id=&quot;selectAll&quot; resultMap=&quot;oneToMany&quot;&gt; SELECT * FROM classes &lt;/select&gt;&lt;/mapper&gt; StudentMapper.xml 12345&lt;mapper namespace=&quot;one_to_one.StudentMapper&quot;&gt; &lt;select id=&quot;findPersonByCid&quot; parameterType=&quot;int&quot; resultType=&quot;student&quot;&gt; SELECT * FROM person WHERE cid=#&#123;id&#125; &lt;/select&gt;&lt;/mapper&gt; æ³¨è§£å¼€å‘å•è¡¨æ“ä½œæ³¨è§£å¯ä»¥ç®€åŒ–å¼€å‘æ“ä½œï¼Œçœç•¥æ˜ å°„é…ç½®æ–‡ä»¶çš„ç¼–å†™ å¸¸ç”¨æ³¨è§£ï¼š @Select(â€œæŸ¥è¯¢çš„ SQL è¯­å¥â€)ï¼šæ‰§è¡ŒæŸ¥è¯¢æ“ä½œæ³¨è§£ @Insert(â€œæ’å…¥çš„ SQL è¯­å¥â€)ï¼šæ‰§è¡Œæ–°å¢æ“ä½œæ³¨è§£ @Update(â€œä¿®æ”¹çš„ SQL è¯­å¥â€)ï¼šæ‰§è¡Œä¿®æ”¹æ“ä½œæ³¨è§£ @Delete(â€œåˆ é™¤çš„ SQL è¯­å¥â€)ï¼šæ‰§è¡Œåˆ é™¤æ“ä½œæ³¨è§£ å‚æ•°æ³¨è§£ï¼š @Paramï¼šå½“ SQL è¯­å¥éœ€è¦å¤šä¸ªï¼ˆå¤§äº1ï¼‰å‚æ•°æ—¶ï¼Œç”¨æ¥æŒ‡å®šå‚æ•°çš„å¯¹åº”è§„åˆ™ æ ¸å¿ƒé…ç½®æ–‡ä»¶é…ç½®æ˜ å°„å…³ç³»ï¼š 1234567&lt;mappers&gt; &lt;package name=&quot;ä½¿ç”¨äº†æ³¨è§£çš„Mapperæ¥å£æ‰€åœ¨åŒ…&quot;/&gt;&lt;/mappers&gt;&lt;!--æˆ–è€…--&gt;&lt;mappers&gt; &lt;mapper class=&quot;åŒ…å.Mapperå&quot;&gt;&lt;/mapper&gt;&lt;/mappers&gt; åŸºæœ¬å¢åˆ æ”¹æŸ¥ï¼š åˆ›å»º Mapper æ¥å£ 12345678910111213141516171819package mapper;public interface StudentMapper &#123; //æŸ¥è¯¢å…¨éƒ¨ @Select(&quot;SELECT * FROM student&quot;) public abstract List&lt;Student&gt; selectAll(); //æ–°å¢æ•°æ® @Insert(&quot;INSERT INTO student VALUES (#&#123;id&#125;,#&#123;name&#125;,#&#123;age&#125;)&quot;) public abstract Integer insert(Student student); //ä¿®æ”¹æ“ä½œ @Update(&quot;UPDATE student SET name=#&#123;name&#125;,age=#&#123;age&#125; WHERE id=#&#123;id&#125;&quot;) public abstract Integer update(Student student); //åˆ é™¤æ“ä½œ @Delete(&quot;DELETE FROM student WHERE id=#&#123;id&#125;&quot;) public abstract Integer delete(Integer id);&#125; ä¿®æ”¹ MyBatis çš„æ ¸å¿ƒé…ç½®æ–‡ä»¶ 123&lt;mappers&gt; &lt;package name=&quot;mapper&quot;/&gt;&lt;/mappers&gt; beanç±» 12345public class Student &#123; private Integer id; private String name; private Integer age;&#125; æµ‹è¯•ç±» 1234567891011121314151617181920212223242526@Testpublic void selectAll() throws Exception&#123; //1.åŠ è½½æ ¸å¿ƒé…ç½®æ–‡ä»¶ InputStream is = Resources.getResourceAsStream(&quot;MyBatisConfig.xml&quot;); //2.è·å–SqlSessionå·¥å‚å¯¹è±¡ SqlSessionFactory ssf = new SqlSessionFactoryBuilder().build(is); //3.é€šè¿‡å·¥å‚å¯¹è±¡è·å–SqlSessionå¯¹è±¡ SqlSession sqlSession = ssf.openSession(true); //4.è·å–StudentMapperæ¥å£çš„å®ç°ç±»å¯¹è±¡ StudentMapper mapper = sqlSession.getMapper(StudentMapper.class); //5.è°ƒç”¨å®ç°ç±»å¯¹è±¡ä¸­çš„æ–¹æ³•ï¼Œæ¥æ”¶ç»“æœ List&lt;Student&gt; list = mapper.selectAll(); //6.å¤„ç†ç»“æœ for (Student student : list) &#123; System.out.println(student); &#125; //7.é‡Šæ”¾èµ„æº sqlSession.close(); is.close();&#125; å¤šè¡¨æ“ä½œç›¸å…³æ³¨è§£å®ç°å¤æ‚å…³ç³»æ˜ å°„ä¹‹å‰æˆ‘ä»¬å¯ä»¥åœ¨æ˜ å°„æ–‡ä»¶ä¸­é€šè¿‡é…ç½® æ¥å®ç°ï¼Œä½¿ç”¨æ³¨è§£å¼€å‘åï¼Œå¯ä»¥ä½¿ç”¨ @Results æ³¨è§£ï¼Œ@Result æ³¨è§£ï¼Œ@One æ³¨è§£ï¼Œ@Many æ³¨è§£ç»„åˆå®Œæˆå¤æ‚å…³ç³»çš„é…ç½® æ³¨è§£ è¯´æ˜ @Results ä»£æ›¿ æ ‡ç­¾ï¼Œæ³¨è§£ä¸­ä½¿ç”¨å•ä¸ª @Result æ³¨è§£æˆ–è€… @Result é›†åˆä½¿ç”¨æ ¼å¼ï¼š@Results({ @Result(), @Result() })æˆ–@Results({ @Result() }) @Result ä»£æ›¿&lt; id&gt; å’Œ æ ‡ç­¾ï¼Œ@Result ä¸­å±æ€§ä»‹ç»ï¼šcolumnï¼šæ•°æ®åº“çš„åˆ—å propertyï¼šå°è£…ç±»çš„å˜é‡åoneï¼šéœ€è¦ä½¿ç”¨ @One æ³¨è§£ï¼ˆ@Result(one &#x3D; @One)ï¼‰Manyï¼šéœ€è¦ä½¿ç”¨ @Many æ³¨è§£ï¼ˆ@Result(many&#x3D; @Many)ï¼‰ @One(ä¸€å¯¹ä¸€) ä»£æ›¿ æ ‡ç­¾ï¼Œå¤šè¡¨æŸ¥è¯¢çš„å…³é”®ï¼Œç”¨æ¥æŒ‡å®šå­æŸ¥è¯¢è¿”å›å•ä¸€å¯¹è±¡selectï¼šæŒ‡å®šè°ƒç”¨ Mapper æ¥å£ä¸­çš„æŸä¸ªæ–¹æ³•ä½¿ç”¨æ ¼å¼ï¼š@Result(column&#x3D;â€â€, property&#x3D;â€â€, one&#x3D;@One(select&#x3D;â€â€)) @Many(å¤šå¯¹ä¸€) ä»£æ›¿ æ ‡ç­¾ï¼Œå¤šè¡¨æŸ¥è¯¢çš„å…³é”®ï¼Œç”¨æ¥æŒ‡å®šå­æŸ¥è¯¢è¿”å›å¯¹è±¡é›†åˆselectï¼šæŒ‡å®šè°ƒç”¨ Mapper æ¥å£ä¸­çš„æŸä¸ªæ–¹æ³•ä½¿ç”¨æ ¼å¼ï¼š@Result(column&#x3D;â€â€, property&#x3D;â€â€, many&#x3D;@Many(select&#x3D;â€â€)) ä¸€å¯¹ä¸€èº«ä»½è¯å¯¹äºº PersonMapper æ¥å£ 12345public interface PersonMapper &#123; //æ ¹æ®idæŸ¥è¯¢ @Select(&quot;SELECT * FROM person WHERE id=#&#123;id&#125;&quot;) public abstract Person selectById(Integer id);&#125; CardMapperæ¥å£ 12345678910111213141516171819public interface CardMapper &#123; //æŸ¥è¯¢å…¨éƒ¨ @Select(&quot;SELECT * FROM card&quot;) @Results(&#123; @Result(column = &quot;id&quot;,property = &quot;id&quot;), @Result(column = &quot;number&quot;,property = &quot;number&quot;), @Result( property = &quot;p&quot;, // è¢«åŒ…å«å¯¹è±¡çš„å˜é‡å javaType = Person.class, // è¢«åŒ…å«å¯¹è±¡çš„å®é™…æ•°æ®ç±»å‹ column = &quot;pid&quot;, // æ ¹æ®æŸ¥è¯¢å‡ºçš„cardè¡¨ä¸­çš„pidå­—æ®µæ¥æŸ¥è¯¢personè¡¨ /* oneã€@One ä¸€å¯¹ä¸€å›ºå®šå†™æ³• selectå±æ€§ï¼šæŒ‡å®šè°ƒç”¨å“ªä¸ªæ¥å£ä¸­çš„å“ªä¸ªæ–¹æ³• */ one = @One(select = &quot;one_to_one.PersonMapper.selectById&quot;) ) &#125;) public abstract List&lt;Card&gt; selectAll();&#125; æµ‹è¯•ç±»ï¼ˆè¯¦ç»†ä»£ç å‚è€ƒå•è¡¨æ“ä½œï¼‰ 12345678//1.åŠ è½½æ ¸å¿ƒé…ç½®æ–‡ä»¶//2.è·å–SqlSessionå·¥å‚å¯¹è±¡//3.é€šè¿‡å·¥å‚å¯¹è±¡è·å–SqlSessionå¯¹è±¡//4.è·å–StudentMapperæ¥å£çš„å®ç°ç±»å¯¹è±¡CardMapper mapper = sqlSession.getMapper(CardMapper.class);//5.è°ƒç”¨å®ç°ç±»å¯¹è±¡ä¸­çš„æ–¹æ³•ï¼Œæ¥æ”¶ç»“æœList&lt;Card&gt; list = mapper.selectAll(); ä¸€å¯¹å¤šç­çº§å’Œå­¦ç”Ÿ StudentMapperæ¥å£ 12345public interface StudentMapper &#123; //æ ¹æ®cidæŸ¥è¯¢studentè¡¨ cidæ˜¯å¤–é”®çº¦æŸåˆ— @Select(&quot;SELECT * FROM student WHERE cid=#&#123;cid&#125;&quot;) public abstract List&lt;Student&gt; selectByCid(Integer cid);&#125; ClassesMapperæ¥å£ 123456789101112131415public interface ClassesMapper &#123; //æŸ¥è¯¢å…¨éƒ¨ @Select(&quot;SELECT * FROM classes&quot;) @Results(&#123; @Result(column = &quot;id&quot;, property = &quot;id&quot;), @Result(column = &quot;name&quot;, property = &quot;name&quot;), @Result( property = &quot;students&quot;, //è¢«åŒ…å«å¯¹è±¡çš„å˜é‡å javaType = List.class, //è¢«åŒ…å«å¯¹è±¡çš„å®é™…æ•°æ®ç±»å‹ column = &quot;id&quot;, //æ ¹æ®idå­—æ®µæŸ¥è¯¢studentè¡¨ many = @Many(select = &quot;one_to_many.StudentMapper.selectByCid&quot;) ) &#125;) public abstract List&lt;Classes&gt; selectAll();&#125; æµ‹è¯•ç±» 1234//4.è·å–StudentMapperæ¥å£çš„å®ç°ç±»å¯¹è±¡ClassesMapper mapper = sqlSession.getMapper(ClassesMapper.class);//5.è°ƒç”¨å®ç°ç±»å¯¹è±¡ä¸­çš„æ–¹æ³•ï¼Œæ¥æ”¶ç»“æœList&lt;Classes&gt; classes = mapper.selectAll(); å¤šå¯¹å¤šå­¦ç”Ÿå’Œè¯¾ç¨‹ SQL æŸ¥è¯¢è¯­å¥ 12SELECT DISTINCT s.id,s.name,s.age FROM student s,stu_cr sc WHERE sc.sid=s.idSELECT c.id,c.name FROM stu_cr sc,course c WHERE sc.cid=c.id AND sc.sid=#&#123;id&#125; CourseMapper æ¥å£ 12345public interface CourseMapper &#123; //æ ¹æ®å­¦ç”ŸidæŸ¥è¯¢æ‰€é€‰è¯¾ç¨‹ @Select(&quot;SELECT c.id,c.name FROM stu_cr sc,course c WHERE sc.cid=c.id AND sc.sid=#&#123;id&#125;&quot;) public abstract List&lt;Course&gt; selectBySid(Integer id);&#125; StudentMapper æ¥å£ 1234567891011121314151617public interface StudentMapper &#123; //æŸ¥è¯¢å…¨éƒ¨ @Select(&quot;SELECT DISTINCT s.id,s.name,s.age FROM student s,stu_cr sc WHERE sc.sid=s.id&quot;) @Results(&#123; @Result(column = &quot;id&quot;,property = &quot;id&quot;), @Result(column = &quot;name&quot;,property = &quot;name&quot;), @Result(column = &quot;age&quot;,property = &quot;age&quot;), @Result( property = &quot;courses&quot;, //è¢«åŒ…å«å¯¹è±¡çš„å˜é‡å javaType = List.class, //è¢«åŒ…å«å¯¹è±¡çš„å®é™…æ•°æ®ç±»å‹ column = &quot;id&quot;, //æ ¹æ®æŸ¥è¯¢å‡ºçš„studentè¡¨ä¸­çš„idå­—æ®µæŸ¥è¯¢ä¸­é—´è¡¨å’Œè¯¾ç¨‹è¡¨ many = @Many(select = &quot;many_to_many.CourseMapper.selectBySid&quot;) ) &#125;) public abstract List&lt;Student&gt; selectAll();&#125; æµ‹è¯•ç±» 1234//4.è·å–StudentMapperæ¥å£çš„å®ç°ç±»å¯¹è±¡StudentMapper mapper = sqlSession.getMapper(StudentMapper.class);//5.è°ƒç”¨å®ç°ç±»å¯¹è±¡ä¸­çš„æ–¹æ³•ï¼Œæ¥æ”¶ç»“æœList&lt;Student&gt; students = mapper.selectAll(); ç¼“å­˜æœºåˆ¶ç¼“å­˜æ¦‚è¿°ç¼“å­˜ï¼šç¼“å­˜å°±æ˜¯ä¸€å—å†…å­˜ç©ºé—´ï¼Œä¿å­˜ä¸´æ—¶æ•°æ® ä½œç”¨ï¼šå°†æ•°æ®æºï¼ˆæ•°æ®åº“æˆ–è€…æ–‡ä»¶ï¼‰ä¸­çš„æ•°æ®è¯»å–å‡ºæ¥å­˜æ”¾åˆ°ç¼“å­˜ä¸­ï¼Œå†æ¬¡è·å–æ—¶ç›´æ¥ä»ç¼“å­˜ä¸­è·å–ï¼Œå¯ä»¥å‡å°‘å’Œæ•°æ®åº“äº¤äº’çš„æ¬¡æ•°ï¼Œæå‡ç¨‹åºçš„æ€§èƒ½ ç¼“å­˜é€‚ç”¨ï¼š é€‚ç”¨äºç¼“å­˜çš„ï¼šç»å¸¸æŸ¥è¯¢ä½†ä¸ç»å¸¸ä¿®æ”¹çš„ï¼Œæ•°æ®çš„æ­£ç¡®ä¸å¦å¯¹æœ€ç»ˆç»“æœå½±å“ä¸å¤§çš„ ä¸é€‚ç”¨ç¼“å­˜çš„ï¼šç»å¸¸æ”¹å˜çš„æ•°æ® , æ•æ„Ÿæ•°æ®ï¼ˆä¾‹å¦‚ï¼šè‚¡å¸‚çš„ç‰Œä»·ï¼Œé“¶è¡Œçš„æ±‡ç‡ï¼Œé“¶è¡Œå¡é‡Œé¢çš„é’±ï¼‰ç­‰ç­‰ ç¼“å­˜ç±»åˆ«ï¼š ä¸€çº§ç¼“å­˜ï¼šSqlSession çº§åˆ«çš„ç¼“å­˜ï¼Œåˆå«æœ¬åœ°ä¼šè¯ç¼“å­˜ï¼Œè‡ªå¸¦çš„ï¼ˆä¸éœ€è¦é…ç½®ï¼‰ï¼Œä¸€çº§ç¼“å­˜çš„ç”Ÿå‘½å‘¨æœŸä¸ SqlSession ä¸€è‡´ã€‚åœ¨æ“ä½œæ•°æ®åº“æ—¶éœ€è¦æ„é€  SqlSession å¯¹è±¡ï¼Œåœ¨å¯¹è±¡ä¸­æœ‰ä¸€ä¸ªæ•°æ®ç»“æ„ï¼ˆHashMapï¼‰ç”¨äºå­˜å‚¨ç¼“å­˜æ•°æ®ï¼Œä¸åŒçš„ SqlSession ä¹‹é—´çš„ç¼“å­˜æ•°æ®åŒºåŸŸæ˜¯äº’ç›¸ä¸å½±å“çš„ äºŒçº§ç¼“å­˜ï¼šmapperï¼ˆnamespaceï¼‰çº§åˆ«çš„ç¼“å­˜ï¼ŒäºŒçº§ç¼“å­˜çš„ä½¿ç”¨ï¼Œéœ€è¦æ‰‹åŠ¨å¼€å¯ï¼ˆéœ€è¦é…ç½®ï¼‰ã€‚å¤šä¸ª SqlSession å»æ“ä½œåŒä¸€ä¸ª Mapper çš„ SQL å¯ä»¥å…±ç”¨äºŒçº§ç¼“å­˜ï¼ŒäºŒçº§ç¼“å­˜æ˜¯è·¨ SqlSession çš„ å¼€å¯ç¼“å­˜ï¼šé…ç½®æ ¸å¿ƒé…ç½®æ–‡ä»¶ä¸­ æ ‡ç­¾ cacheEnabledï¼štrue è¡¨ç¤ºå…¨å±€æ€§åœ°å¼€å¯æ‰€æœ‰æ˜ å°„å™¨é…ç½®æ–‡ä»¶ä¸­å·²é…ç½®çš„ä»»ä½•ç¼“å­˜ï¼Œé»˜è®¤ true å‚è€ƒæ–‡ç« ï¼šhttps://www.cnblogs.com/ysocean/p/7342498.html ä¸€çº§ç¼“å­˜ä¸€çº§ç¼“å­˜æ˜¯ SqlSession çº§åˆ«çš„ç¼“å­˜ å·¥ä½œæµç¨‹ï¼šç¬¬ä¸€æ¬¡å‘èµ·æŸ¥è¯¢ç”¨æˆ· id ä¸º 1 çš„ç”¨æˆ·ä¿¡æ¯ï¼Œå…ˆå»æ‰¾ç¼“å­˜ä¸­æ˜¯å¦æœ‰ id ä¸º 1 çš„ç”¨æˆ·ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰ï¼Œä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œå¾—åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œå°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åˆ°ä¸€çº§ç¼“å­˜ä¸­ï¼›ç¬¬äºŒæ¬¡å‘èµ·æŸ¥è¯¢ç”¨æˆ· id ä¸º 1 çš„ç”¨æˆ·ä¿¡æ¯ï¼Œå…ˆå»æ‰¾ç¼“å­˜ä¸­æ˜¯å¦æœ‰ id ä¸º 1 çš„ç”¨æˆ·ä¿¡æ¯ï¼Œç¼“å­˜ä¸­æœ‰ï¼Œç›´æ¥ä»ç¼“å­˜ä¸­è·å–ç”¨æˆ·ä¿¡æ¯ã€‚ ä¸€çº§ç¼“å­˜çš„å¤±æ•ˆï¼š SqlSession ä¸åŒ SqlSession ç›¸åŒï¼ŒæŸ¥è¯¢æ¡ä»¶ä¸åŒæ—¶ï¼ˆè¿˜æœªç¼“å­˜è¯¥æ•°æ®ï¼‰ SqlSession ç›¸åŒï¼Œæ‰‹åŠ¨æ¸…é™¤äº†ä¸€çº§ç¼“å­˜ï¼Œè°ƒç”¨ sqlSession.clearCache() SqlSession ç›¸åŒï¼Œæ‰§è¡Œ commit æ“ä½œæˆ–è€…æ‰§è¡Œæ’å…¥ã€æ›´æ–°ã€åˆ é™¤ï¼Œæ¸…ç©º SqlSession ä¸­çš„ä¸€çº§ç¼“å­˜ï¼Œè¿™æ ·åšçš„ç›®çš„ä¸ºäº†è®©ç¼“å­˜ä¸­å­˜å‚¨çš„æ˜¯æœ€æ–°çš„ä¿¡æ¯ï¼Œé¿å…è„è¯» Spring æ•´åˆ MyBatis åï¼Œä¸€çº§ç¼“å­˜ä½œç”¨ï¼š æœªå¼€å¯äº‹åŠ¡çš„æƒ…å†µï¼Œæ¯æ¬¡æŸ¥è¯¢ Spring éƒ½ä¼šåˆ›å»ºæ–°çš„ SqlSessionï¼Œå› æ­¤ä¸€çº§ç¼“å­˜å¤±æ•ˆ å¼€å¯äº‹åŠ¡çš„æƒ…å†µï¼ŒSpring ä½¿ç”¨ ThreadLocal è·å–å½“å‰èµ„æºç»‘å®šåŒä¸€ä¸ª SqlSessionï¼Œå› æ­¤æ­¤æ—¶ä¸€çº§ç¼“å­˜æ˜¯æœ‰æ•ˆçš„ æµ‹è¯•ä¸€çº§ç¼“å­˜å­˜åœ¨ 123456789101112131415161718192021public void testFirstLevelCache()&#123; //1. è·å–sqlSessionå¯¹è±¡ SqlSession sqlSession = SqlSessionFactoryUtils.openSession(); //2. é€šè¿‡sqlSessionå¯¹è±¡è·å–UserDaoæ¥å£çš„ä»£ç†å¯¹è±¡ UserDao userDao1 = sqlSession.getMapper(UserDao.class); //3. è°ƒç”¨UserDaoæ¥å£çš„ä»£ç†å¯¹è±¡çš„findByIdæ–¹æ³•è·å–ä¿¡æ¯ User user1 = userDao1.findById(1); System.out.println(user1); //sqlSession.clearCache() æ¸…ç©ºç¼“å­˜ UserDao userDao2 = sqlSession.getMapper(UserDao.class); User user = userDao.findById(1); System.out.println(user2); //4.æµ‹è¯•ä¸¤æ¬¡ç»“æœæ˜¯å¦ä¸€æ · System.out.println(user1 == user2);//true //5. æäº¤äº‹åŠ¡å…³é—­èµ„æº SqlSessionFactoryUtils.commitAndClose(sqlSession);&#125; äºŒçº§ç¼“å­˜åŸºæœ¬ä»‹ç»äºŒçº§ç¼“å­˜æ˜¯ mapper çš„ç¼“å­˜ï¼Œåªè¦æ˜¯åŒä¸€ä¸ªå‘½åç©ºé—´ï¼ˆnamespaceï¼‰çš„ SqlSession å°±å…±äº«äºŒçº§ç¼“å­˜çš„å†…å®¹ï¼Œå¹¶ä¸”å¯ä»¥æ“ä½œäºŒçº§ç¼“å­˜ ä½œç”¨ï¼šä½œç”¨èŒƒå›´æ˜¯æ•´ä¸ªåº”ç”¨ï¼Œå¯ä»¥è·¨çº¿ç¨‹ä½¿ç”¨ï¼Œé€‚åˆç¼“å­˜ä¸€äº›ä¿®æ”¹è¾ƒå°‘çš„æ•°æ® å·¥ä½œæµç¨‹ï¼šä¸€ä¸ªä¼šè¯æŸ¥è¯¢æ•°æ®ï¼Œè¿™ä¸ªæ•°æ®å°±ä¼šè¢«æ”¾åœ¨å½“å‰ä¼šè¯çš„ä¸€çº§ç¼“å­˜ä¸­ï¼Œå¦‚æœä¼šè¯å…³é—­æˆ–æäº¤ä¸€çº§ç¼“å­˜ä¸­çš„æ•°æ®ä¼šä¿å­˜åˆ°äºŒçº§ç¼“å­˜ äºŒçº§ç¼“å­˜çš„åŸºæœ¬ä½¿ç”¨ï¼š åœ¨ MyBatisConfig.xml æ–‡ä»¶å¼€å¯äºŒçº§ç¼“å­˜ï¼ŒcacheEnabled é»˜è®¤å€¼ä¸º trueï¼Œæ‰€ä»¥è¿™ä¸€æ­¥å¯ä»¥çœç•¥ä¸é…ç½® 1234&lt;!--é…ç½®å¼€å¯äºŒçº§ç¼“å­˜--&gt;&lt;settings&gt; &lt;setting name=&quot;cacheEnabled&quot; value=&quot;true&quot;/&gt;&lt;/settings&gt; é…ç½® Mapper æ˜ å°„æ–‡ä»¶ &lt;cache&gt; æ ‡ç­¾è¡¨ç¤ºå½“å‰è¿™ä¸ª mapper æ˜ å°„å°†ä½¿ç”¨äºŒçº§ç¼“å­˜ï¼ŒåŒºåˆ†çš„æ ‡å‡†å°±çœ‹ mapper çš„ namespace å€¼ 12345&lt;mapper namespace=&quot;dao.UserDao&quot;&gt; &lt;!--å¼€å¯useræ”¯æŒäºŒçº§ç¼“å­˜--&gt; &lt;cache eviction=&quot;FIFO&quot; flushInterval=&quot;6000&quot; readOnly=&quot;&quot; size=&quot;1024&quot;/&gt; &lt;cache&gt;&lt;/cache&gt; &lt;!--åˆ™è¡¨ç¤ºæ‰€æœ‰å±æ€§ä½¿ç”¨é»˜è®¤å€¼--&gt;&lt;/mapper&gt; evictionï¼ˆæ¸…é™¤ç­–ç•¥ï¼‰ï¼š LRU â€“ æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼šç§»é™¤æœ€é•¿æ—¶é—´ä¸è¢«ä½¿ç”¨çš„å¯¹è±¡ï¼Œé»˜è®¤ FIFO â€“ å…ˆè¿›å…ˆå‡ºï¼šæŒ‰å¯¹è±¡è¿›å…¥ç¼“å­˜çš„é¡ºåºæ¥ç§»é™¤å®ƒä»¬ SOFT â€“ è½¯å¼•ç”¨ï¼šåŸºäºåƒåœ¾å›æ”¶å™¨çŠ¶æ€å’Œè½¯å¼•ç”¨è§„åˆ™ç§»é™¤å¯¹è±¡ WEAK â€“ å¼±å¼•ç”¨ï¼šæ›´ç§¯æåœ°åŸºäºåƒåœ¾æ”¶é›†å™¨çŠ¶æ€å’Œå¼±å¼•ç”¨è§„åˆ™ç§»é™¤å¯¹è±¡ flushIntervalï¼ˆåˆ·æ–°é—´éš”ï¼‰ï¼šå¯ä»¥è®¾ç½®ä¸ºä»»æ„çš„æ­£æ•´æ•°ï¼Œ é»˜è®¤æƒ…å†µæ˜¯ä¸è®¾ç½®ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰åˆ·æ–°é—´éš”ï¼Œç¼“å­˜ä»…ä»…ä¼šåœ¨è°ƒç”¨è¯­å¥æ—¶åˆ·æ–° sizeï¼ˆå¼•ç”¨æ•°ç›®ï¼‰ï¼šç¼“å­˜å­˜æ”¾å¤šå°‘å…ƒç´ ï¼Œé»˜è®¤å€¼æ˜¯ 1024 readOnlyï¼ˆåªè¯»ï¼‰ï¼šå¯ä»¥è¢«è®¾ç½®ä¸º true æˆ– false åªè¯»çš„ç¼“å­˜ä¼šç»™æ‰€æœ‰è°ƒç”¨è€…è¿”å›ç¼“å­˜å¯¹è±¡çš„ç›¸åŒå®ä¾‹ï¼Œå› æ­¤è¿™äº›å¯¹è±¡ä¸èƒ½è¢«ä¿®æ”¹ï¼Œä¿ƒè¿›äº†æ€§èƒ½æå‡ å¯è¯»å†™çš„ç¼“å­˜ä¼šï¼ˆé€šè¿‡åºåˆ—åŒ–ï¼‰è¿”å›ç¼“å­˜å¯¹è±¡çš„æ‹·è´ï¼Œ é€Ÿåº¦ä¸Šä¼šæ…¢ä¸€äº›ï¼Œä½†æ˜¯æ›´å®‰å…¨ï¼Œå› æ­¤é»˜è®¤å€¼æ˜¯ false typeï¼šæŒ‡å®šè‡ªå®šä¹‰ç¼“å­˜çš„å…¨ç±»åï¼Œå®ç° Cache æ¥å£å³å¯ è¦è¿›è¡ŒäºŒçº§ç¼“å­˜çš„ç±»å¿…é¡»å®ç° java.io.Serializable æ¥å£ï¼Œå¯ä»¥ä½¿ç”¨åºåˆ—åŒ–æ–¹å¼æ¥ä¿å­˜å¯¹è±¡ã€‚ 1public class User implements Serializable&#123;&#125; ç›¸å…³å±æ€§ select æ ‡ç­¾çš„ useCache å±æ€§ æ˜ å°„æ–‡ä»¶ä¸­çš„ &lt;select&gt; æ ‡ç­¾ä¸­è®¾ç½® useCache=&quot;true&quot; ä»£è¡¨å½“å‰ statement è¦ä½¿ç”¨äºŒçº§ç¼“å­˜ï¼ˆé»˜è®¤ï¼‰ æ³¨æ„ï¼šå¦‚æœæ¯æ¬¡æŸ¥è¯¢éƒ½éœ€è¦æœ€æ–°çš„æ•°æ® sqlï¼Œè¦è®¾ç½®æˆ useCache&#x3D;falseï¼Œç¦ç”¨äºŒçº§ç¼“å­˜ 123&lt;select id=&quot;findAll&quot; resultType=&quot;user&quot; useCache=&quot;true&quot;&gt; select * from user&lt;/select&gt; æ¯ä¸ªå¢åˆ æ”¹æ ‡ç­¾éƒ½æœ‰ flushCache å±æ€§ï¼Œé»˜è®¤ä¸º trueï¼Œä»£è¡¨åœ¨æ‰§è¡Œå¢åˆ æ”¹ä¹‹åå°±ä¼šæ¸…é™¤ä¸€ã€äºŒçº§ç¼“å­˜ï¼Œä¿è¯ç¼“å­˜çš„ä¸€è‡´æ€§ï¼›è€ŒæŸ¥è¯¢æ ‡ç­¾é»˜è®¤å€¼ä¸º falseï¼Œæ‰€ä»¥æŸ¥è¯¢ä¸ä¼šæ¸…ç©ºç¼“å­˜ localCacheScopeï¼šæœ¬åœ°ç¼“å­˜ä½œç”¨åŸŸï¼Œ ä¸­çš„é…ç½®é¡¹ï¼Œé»˜è®¤å€¼ä¸º SESSIONï¼Œå½“å‰ä¼šè¯çš„æ‰€æœ‰æ•°æ®ä¿å­˜åœ¨ä¼šè¯ç¼“å­˜ä¸­ï¼Œè®¾ç½®ä¸º STATEMENT ç¦ç”¨ä¸€çº§ç¼“å­˜ æºç è§£æäº‹åŠ¡æäº¤äºŒçº§ç¼“å­˜æ‰ç”Ÿæ•ˆï¼šDefaultSqlSession è°ƒç”¨ commit() æ—¶ä¼šå›è°ƒ executor.commit() CachingExecutor#query()ï¼šæ‰§è¡ŒæŸ¥è¯¢æ–¹æ³•ï¼ŒæŸ¥è¯¢å‡ºçš„æ•°æ®ä¼šå…ˆæ”¾å…¥ entriesToAddOnCommit é›†åˆæš‚å­˜ 12345678// ä»äºŒç¼“å­˜ä¸­è·å–æ•°æ®ï¼Œè·å–ä¸åˆ°å»ä¸€çº§ç¼“å­˜è·å–List&lt;E&gt; list = (List&lt;E&gt;) tcm.getObject(cache, key);if (list == null) &#123; // å›è°ƒ BaseExecutor#query list = delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql); // å°†æ•°æ®æ”¾å…¥ entriesToAddOnCommit é›†åˆæš‚å­˜ï¼Œæ­¤æ—¶è¿˜æ²¡æ”¾å…¥äºŒçº§ç¼“å­˜ tcm.putObject(cache, key, list);&#125; commit()ï¼šäº‹åŠ¡æäº¤ï¼Œæ¸…ç©ºä¸€çº§ç¼“å­˜ï¼Œæ”¾å…¥äºŒçº§ç¼“å­˜ï¼ŒäºŒçº§ç¼“å­˜ä½¿ç”¨ TransactionalCacheManagerï¼ˆtcmï¼‰ç®¡ç† 12345public void commit(boolean required) throws SQLException &#123; // é¦–å…ˆè°ƒç”¨ BaseExecutor#commit æ–¹æ³•ï¼Œã€æ¸…ç©ºä¸€çº§ç¼“å­˜ã€‘ delegate.commit(required); tcm.commit();&#125; TransactionalCacheManager#commitï¼šæŸ¥è¯¢å‡ºçš„æ•°æ®æ”¾å…¥äºŒçº§ç¼“å­˜ 123456public void commit() &#123; // è·å–æ‰€æœ‰çš„ç¼“å­˜äº‹åŠ¡ï¼ŒæŒ¨ç€è¿›è¡Œæäº¤ for (TransactionalCache txCache : transactionalCaches.values()) &#123; txCache.commit(); &#125;&#125; 123456789public void commit() &#123; if (clearOnCommit) &#123; delegate.clear(); &#125; // å°† entriesToAddOnCommit ä¸­çš„æ•°æ®æ”¾å…¥äºŒçº§ç¼“å­˜ flushPendingEntries(); // æ¸…ç©ºç›¸å…³é›†åˆ reset();&#125; 123456private void flushPendingEntries() &#123; for (Map.Entry&lt;Object, Object&gt; entry : entriesToAddOnCommit.entrySet()) &#123; // å°†æ•°æ®æ”¾å…¥äºŒçº§ç¼“å­˜ delegate.putObject(entry.getKey(), entry.getValue()); &#125;&#125; å¢åˆ æ”¹æ“ä½œä¼šæ¸…ç©ºç¼“å­˜ï¼š update()ï¼šCachingExecutor çš„æ›´æ–°æ“ä½œ 12345public int update(MappedStatement ms, Object parameterObject) throws SQLException &#123; flushCacheIfRequired(ms); // å›è°ƒ BaseExecutor#update æ–¹æ³•ï¼Œä¹Ÿä¼šæ¸…ç©ºä¸€çº§ç¼“å­˜ return delegate.update(ms, parameterObject);&#125; flushCacheIfRequired()ï¼šåˆ¤æ–­æ˜¯å¦éœ€è¦æ¸…ç©ºäºŒçº§ç¼“å­˜ 12345678private void flushCacheIfRequired(MappedStatement ms) &#123; Cache cache = ms.getCache(); // åˆ¤æ–­äºŒçº§ç¼“å­˜æ˜¯å¦å­˜åœ¨ï¼Œç„¶ååˆ¤æ–­æ ‡ç­¾çš„ flushCache çš„å€¼ï¼Œå¢åˆ æ”¹æ“ä½œçš„ flushCache å±æ€§é»˜è®¤ä¸º true if (cache != null &amp;&amp; ms.isFlushCacheRequired()) &#123; // æ¸…ç©ºäºŒçº§ç¼“å­˜ tcm.clear(cache); &#125;&#125; è‡ªå®šä¹‰è‡ªå®šä¹‰ç¼“å­˜ 1&lt;cache type=&quot;com.domain.something.MyCustomCache&quot;/&gt; type å±æ€§æŒ‡å®šçš„ç±»å¿…é¡»å®ç° org.apache.ibatis.cache.Cache æ¥å£ï¼Œä¸”æä¾›ä¸€ä¸ªæ¥å— String å‚æ•°ä½œä¸º id çš„æ„é€ å™¨ 123456789public interface Cache &#123; String getId(); int getSize(); void putObject(Object key, Object value); Object getObject(Object key); boolean hasKey(Object key); Object removeObject(Object key); void clear();&#125; ç¼“å­˜çš„é…ç½®ï¼Œåªéœ€è¦åœ¨ç¼“å­˜å®ç°ä¸­æ·»åŠ å…¬æœ‰çš„ JavaBean å±æ€§ï¼Œç„¶åé€šè¿‡ cache å…ƒç´ ä¼ é€’å±æ€§å€¼ï¼Œä¾‹å¦‚åœ¨ç¼“å­˜å®ç°ä¸Šè°ƒç”¨ä¸€ä¸ªåä¸º setCacheFile(String file) çš„æ–¹æ³•ï¼š 123&lt;cache type=&quot;com.domain.something.MyCustomCache&quot;&gt; &lt;property name=&quot;cacheFile&quot; value=&quot;/tmp/my-custom-cache.tmp&quot;/&gt;&lt;/cache&gt; å¯ä»¥ä½¿ç”¨æ‰€æœ‰ç®€å•ç±»å‹ä½œä¸º JavaBean å±æ€§çš„ç±»å‹ï¼ŒMyBatis ä¼šè¿›è¡Œè½¬æ¢ã€‚ å¯ä»¥ä½¿ç”¨å ä½ç¬¦ï¼ˆå¦‚ $&#123;cache.file&#125;ï¼‰ï¼Œä»¥ä¾¿æ›¿æ¢æˆåœ¨é…ç½®æ–‡ä»¶å±æ€§ä¸­å®šä¹‰çš„å€¼ MyBatis æ”¯æŒåœ¨æ‰€æœ‰å±æ€§è®¾ç½®å®Œæ¯•ä¹‹åï¼Œè°ƒç”¨ä¸€ä¸ªåˆå§‹åŒ–æ–¹æ³•ï¼Œ å¦‚æœæƒ³è¦ä½¿ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œå¯ä»¥åœ¨è‡ªå®šä¹‰ç¼“å­˜ç±»é‡Œå®ç° org.apache.ibatis.builder.InitializingObject æ¥å£ 123public interface InitializingObject &#123; void initialize() throws Exception;&#125; æ³¨æ„ï¼šå¯¹ç¼“å­˜çš„é…ç½®ï¼ˆå¦‚æ¸…é™¤ç­–ç•¥ã€å¯è¯»æˆ–å¯è¯»å†™ç­‰ï¼‰ï¼Œä¸èƒ½åº”ç”¨äºè‡ªå®šä¹‰ç¼“å­˜ å¯¹æŸä¸€å‘½åç©ºé—´çš„è¯­å¥ï¼Œåªä¼šä½¿ç”¨è¯¥å‘½åç©ºé—´çš„ç¼“å­˜è¿›è¡Œç¼“å­˜æˆ–åˆ·æ–°ï¼Œåœ¨å¤šä¸ªå‘½åç©ºé—´ä¸­å…±äº«ç›¸åŒçš„ç¼“å­˜é…ç½®å’Œå®ä¾‹ï¼Œå¯ä»¥ä½¿ç”¨ cache-ref å…ƒç´ æ¥å¼•ç”¨å¦ä¸€ä¸ªç¼“å­˜ 1&lt;cache-ref namespace=&quot;com.someone.application.data.SomeMapper&quot;/&gt; æ„é€ è¯­å¥åŠ¨æ€ SQLåŸºæœ¬ä»‹ç»åŠ¨æ€ SQL æ˜¯ MyBatis å¼ºå¤§ç‰¹æ€§ä¹‹ä¸€ï¼Œé€»è¾‘å¤æ‚æ—¶ï¼ŒMyBatis æ˜ å°„é…ç½®æ–‡ä»¶ä¸­ï¼ŒSQL æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œæ‰€ä»¥å¼•å…¥åŠ¨æ€ SQL ç®€åŒ–æ‹¼è£… SQL çš„æ“ä½œ DynamicSQL åŒ…å«çš„æ ‡ç­¾ï¼š if where set choose (whenã€otherwise) trim foreach å„ä¸ªæ ‡ç­¾éƒ½å¯ä»¥è¿›è¡Œçµæ´»åµŒå¥—å’Œç»„åˆ OGNLï¼šObject Graphic Navigation Languageï¼ˆå¯¹è±¡å›¾å¯¼èˆªè¯­è¨€ï¼‰ï¼Œç”¨äºå¯¹æ•°æ®è¿›è¡Œè®¿é—® å‚è€ƒæ–‡ç« ï¼šhttps://www.cnblogs.com/ysocean/p/7289529.html whereï¼šæ¡ä»¶æ ‡ç­¾ï¼Œæœ‰åŠ¨æ€æ¡ä»¶åˆ™ä½¿ç”¨è¯¥æ ‡ç­¾ä»£æ›¿ WHERE å…³é”®å­—ï¼Œå°è£…æŸ¥è¯¢æ¡ä»¶ ä½œç”¨ï¼šå¦‚æœæ ‡ç­¾è¿”å›çš„å†…å®¹æ˜¯ä»¥ AND æˆ– OR å¼€å¤´çš„ï¼Œæ ‡ç­¾å†…ä¼šå‰”é™¤æ‰ è¡¨ç»“æ„ï¼š ifåŸºæœ¬æ ¼å¼ï¼š 123&lt;if test=â€œæ¡ä»¶åˆ¤æ–­â€&gt; æŸ¥è¯¢æ¡ä»¶æ‹¼æ¥&lt;/if&gt; æˆ‘ä»¬æ ¹æ®å®ä½“ç±»çš„ä¸åŒå–å€¼ï¼Œä½¿ç”¨ä¸åŒçš„ SQL è¯­å¥æ¥è¿›è¡ŒæŸ¥è¯¢ã€‚æ¯”å¦‚åœ¨ id å¦‚æœä¸ä¸ºç©ºæ—¶å¯ä»¥æ ¹æ® id æŸ¥è¯¢ï¼Œå¦‚æœusername ä¸åŒç©ºæ—¶è¿˜è¦åŠ å…¥ç”¨æˆ·åä½œä¸ºæ¡ä»¶ï¼Œè¿™ç§æƒ…å†µåœ¨æˆ‘ä»¬çš„å¤šæ¡ä»¶ç»„åˆæŸ¥è¯¢ä¸­ç»å¸¸ä¼šç¢°åˆ°ã€‚ UserMapper.xml 12345678910111213141516171819202122&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;&lt;mapper namespace=&quot;mapper.UserMapper&quot;&gt; &lt;select id=&quot;selectCondition&quot; resultType=&quot;user&quot; parameterType=&quot;user&quot;&gt; SELECT * FROM user &lt;where&gt; &lt;if test=&quot;id != null &quot;&gt; id = #&#123;id&#125; &lt;/if&gt; &lt;if test=&quot;username != null &quot;&gt; AND username = #&#123;username&#125; &lt;/if&gt; &lt;if test=&quot;sex != null &quot;&gt; AND sex = #&#123;sex&#125; &lt;/if&gt; &lt;/where&gt; &lt;/select&gt; &lt;/mapper&gt; MyBatisConfig.xmlï¼Œå¼•å…¥æ˜ å°„é…ç½®æ–‡ä»¶ 1234&lt;mappers&gt; &lt;!--mapperå¼•å…¥æŒ‡å®šçš„æ˜ å°„é…ç½® resourceå±æ€§æ‰§è¡Œçš„æ˜ å°„é…ç½®æ–‡ä»¶çš„åç§°--&gt; &lt;mapper resource=&quot;UserMapper.xml&quot;/&gt;&lt;/mappers&gt; DAO å±‚ Mapper æ¥å£ 1234public interface UserMapper &#123; //å¤šæ¡ä»¶æŸ¥è¯¢ public abstract List&lt;User&gt; selectCondition(Student stu);&#125; å®ç°ç±» 123456789101112131415161718192021222324252627282930313233public class DynamicTest &#123; @Test public void selectCondition() throws Exception&#123; //1.åŠ è½½æ ¸å¿ƒé…ç½®æ–‡ä»¶ InputStream is = Resources.getResourceAsStream(&quot;MyBatisConfig.xml&quot;); //2.è·å–SqlSessionå·¥å‚å¯¹è±¡ SqlSessionFactory ssf = new SqlSessionFactoryBuilder().build(is); //3.é€šè¿‡å·¥å‚å¯¹è±¡è·å–SqlSessionå¯¹è±¡ SqlSession sqlSession = ssf.openSession(true); //4.è·å–StudentMapperæ¥å£çš„å®ç°ç±»å¯¹è±¡ UserMapper mapper = sqlSession.getMapper(UserMapper.class); User user = new User(); user.setId(2); user.setUsername(&quot;æå››&quot;); //user.setSex(ç”·); AND åä¼šè‡ªåŠ¨å‰”é™¤ //5.è°ƒç”¨å®ç°ç±»çš„æ–¹æ³•ï¼Œæ¥æ”¶ç»“æœ List&lt;Student&gt; list = mapper.selectCondition(user); //6.å¤„ç†ç»“æœ for (User user : list) &#123; System.out.println(user); &#125; //7.é‡Šæ”¾èµ„æº sqlSession.close(); is.close(); &#125;&#125; setï¼šè¿›è¡Œæ›´æ–°æ“ä½œçš„æ—¶å€™ï¼Œå«æœ‰ set å…³é”®è¯ï¼Œä½¿ç”¨è¯¥æ ‡ç­¾ 12345678910111213&lt;!-- æ ¹æ® id æ›´æ–° user è¡¨çš„æ•°æ® --&gt;&lt;update id=&quot;updateUserById&quot; parameterType=&quot;com.ys.po.User&quot;&gt; UPDATE user u &lt;set&gt; &lt;if test=&quot;username != null and username != &#x27;&#x27;&quot;&gt; u.username = #&#123;username&#125;, &lt;/if&gt; &lt;if test=&quot;sex != null and sex != &#x27;&#x27;&quot;&gt; u.sex = #&#123;sex&#125; &lt;/if&gt; &lt;/set&gt; WHERE id=#&#123;id&#125;&lt;/update&gt; å¦‚æœç¬¬ä¸€ä¸ªæ¡ä»¶ username ä¸ºç©ºï¼Œé‚£ä¹ˆ sql è¯­å¥ä¸ºï¼šupdate user u set u.sex&#x3D;? where id&#x3D;? å¦‚æœç¬¬ä¸€ä¸ªæ¡ä»¶ä¸ä¸ºç©ºï¼Œé‚£ä¹ˆ sql è¯­å¥ä¸ºï¼šupdate user u set u.username &#x3D; ? ,u.sex &#x3D; ? where id&#x3D;? chooseå‡å¦‚ä¸æƒ³ç”¨åˆ°æ‰€æœ‰çš„æŸ¥è¯¢æ¡ä»¶ï¼Œåªè¦æŸ¥è¯¢æ¡ä»¶æœ‰ä¸€ä¸ªæ»¡è¶³å³å¯ï¼Œä½¿ç”¨ choose æ ‡ç­¾å¯ä»¥è§£å†³æ­¤ç±»é—®é¢˜ï¼Œç±»ä¼¼äº Java çš„ switch è¯­å¥ æ ‡ç­¾ï¼šï¼Œ 12345678910111213141516&lt;select id=&quot;selectUserByChoose&quot; resultType=&quot;user&quot; parameterType=&quot;user&quot;&gt; SELECT * FROM user &lt;where&gt; &lt;choose&gt; &lt;when test=&quot;id !=&#x27;&#x27; and id != null&quot;&gt; id=#&#123;id&#125; &lt;/when&gt; &lt;when test=&quot;username !=&#x27;&#x27; and username != null&quot;&gt; AND username=#&#123;username&#125; &lt;/when&gt; &lt;otherwise&gt; AND sex=#&#123;sex&#125; &lt;/otherwise&gt; &lt;/choose&gt; &lt;/where&gt;&lt;/select&gt; æœ‰ä¸‰ä¸ªæ¡ä»¶ï¼Œidã€usernameã€sexï¼Œåªèƒ½é€‰æ‹©ä¸€ä¸ªä½œä¸ºæŸ¥è¯¢æ¡ä»¶ å¦‚æœ id ä¸ä¸ºç©ºï¼Œé‚£ä¹ˆæŸ¥è¯¢è¯­å¥ä¸ºï¼šselect * from user where id&#x3D;? å¦‚æœ id ä¸ºç©ºï¼Œé‚£ä¹ˆçœ‹ username æ˜¯å¦ä¸ºç©º å¦‚æœä¸ä¸ºç©ºï¼Œé‚£ä¹ˆè¯­å¥ä¸ºï¼šselect * from user where username&#x3D;? å¦‚æœ username ä¸ºç©ºï¼Œé‚£ä¹ˆæŸ¥è¯¢è¯­å¥ä¸º select * from user where sex&#x3D;? trimtrim æ ‡è®°æ˜¯ä¸€ä¸ªæ ¼å¼åŒ–çš„æ ‡è®°ï¼Œå¯ä»¥å®Œæˆ set æˆ–è€…æ˜¯ where æ ‡è®°çš„åŠŸèƒ½ï¼Œè‡ªå®šä¹‰å­—ç¬¦ä¸²æˆªå– prefixï¼šç»™æ‹¼ä¸²åçš„æ•´ä¸ªå­—ç¬¦ä¸²åŠ ä¸€ä¸ªå‰ç¼€ï¼Œtrim æ ‡ç­¾ä½“ä¸­æ˜¯æ•´ä¸ªå­—ç¬¦ä¸²æ‹¼ä¸²åçš„ç»“æœ prefixOverridesï¼šå»æ‰æ•´ä¸ªå­—ç¬¦ä¸²å‰é¢å¤šä½™çš„å­—ç¬¦ suffixï¼šç»™æ‹¼ä¸²åçš„æ•´ä¸ªå­—ç¬¦ä¸²åŠ ä¸€ä¸ªåç¼€ suffixOverridesï¼šå»æ‰æ•´ä¸ªå­—ç¬¦ä¸²åé¢å¤šä½™çš„å­—ç¬¦ æ”¹å†™ if + where è¯­å¥ï¼š 1234567891011&lt;select id=&quot;selectUserByUsernameAndSex&quot; resultType=&quot;user&quot; parameterType=&quot;com.ys.po.User&quot;&gt; SELECT * FROM user &lt;trim prefix=&quot;where&quot; prefixOverrides=&quot;and | or&quot;&gt; &lt;if test=&quot;username != null&quot;&gt; AND username=#&#123;username&#125; &lt;/if&gt; &lt;if test=&quot;sex != null&quot;&gt; AND sex=#&#123;sex&#125; &lt;/if&gt; &lt;/trim&gt;&lt;/select&gt; æ”¹å†™ if + set è¯­å¥ï¼š 12345678910111213&lt;!-- æ ¹æ® id æ›´æ–° user è¡¨çš„æ•°æ® --&gt;&lt;update id=&quot;updateUserById&quot; parameterType=&quot;com.ys.po.User&quot;&gt; UPDATE user u &lt;trim prefix=&quot;set&quot; suffixOverrides=&quot;,&quot;&gt; &lt;if test=&quot;username != null and username != &#x27;&#x27;&quot;&gt; u.username = #&#123;username&#125;, &lt;/if&gt; &lt;if test=&quot;sex != null and sex != &#x27;&#x27;&quot;&gt; u.sex = #&#123;sex&#125;, &lt;/if&gt; &lt;/trim&gt; WHERE id=#&#123;id&#125;&lt;/update&gt; foreachåŸºæœ¬æ ¼å¼ï¼š 1234&lt;foreach&gt;ï¼šå¾ªç¯éå†æ ‡ç­¾ã€‚é€‚ç”¨äºå¤šä¸ªå‚æ•°æˆ–è€…çš„å…³ç³»ã€‚ &lt;foreach collection=â€œâ€open=â€œâ€close=â€œâ€item=â€œâ€separator=â€œâ€&gt; è·å–å‚æ•°&lt;/foreach&gt; å±æ€§ï¼š collectionï¼šå‚æ•°å®¹å™¨ç±»å‹ï¼Œ (list-é›†åˆï¼Œ array-æ•°ç»„) openï¼šå¼€å§‹çš„ SQL è¯­å¥ closeï¼šç»“æŸçš„ SQL è¯­å¥ itemï¼šå‚æ•°å˜é‡å separatorï¼šåˆ†éš”ç¬¦ éœ€æ±‚ï¼šå¾ªç¯æ‰§è¡Œ sql çš„æ‹¼æ¥æ“ä½œï¼ŒSELECT * FROM user WHERE id IN (1,2,5) UserMapper.xmlç‰‡æ®µ 12345678&lt;select id=&quot;selectByIds&quot; resultType=&quot;user&quot; parameterType=&quot;list&quot;&gt; SELECT * FROM student &lt;where&gt; &lt;foreach collection=&quot;list&quot; open=&quot;id IN(&quot; close=&quot;)&quot; item=&quot;id&quot; separator=&quot;,&quot;&gt; #&#123;id&#125; &lt;/foreach&gt; &lt;/where&gt;&lt;/select&gt; æµ‹è¯•ä»£ç ç‰‡æ®µ 1234567891011//4.è·å–StudentMapperæ¥å£çš„å®ç°ç±»å¯¹è±¡UserMapper mapper = sqlSession.getMapper(UserMapper.class);List&lt;Integer&gt; ids = new ArrayList&lt;&gt;();Collections.addAll(list, 1, 2);//5.è°ƒç”¨å®ç°ç±»çš„æ–¹æ³•ï¼Œæ¥æ”¶ç»“æœList&lt;User&gt; list = mapper.selectByIds(ids);for (User user : list) &#123; System.out.println(user);&#125; SQLç‰‡æ®µå°†ä¸€äº›é‡å¤æ€§çš„ SQL è¯­å¥è¿›è¡ŒæŠ½å–ï¼Œä»¥è¾¾åˆ°å¤ç”¨çš„æ•ˆæœ æ ¼å¼ï¼š 12&lt;sql id=â€œç‰‡æ®µå”¯ä¸€æ ‡è¯†â€&gt;æŠ½å–çš„SQLè¯­å¥&lt;/sql&gt; &lt;!--æŠ½å–æ ‡ç­¾--&gt;&lt;include refid=â€œç‰‡æ®µå”¯ä¸€æ ‡è¯†â€/&gt; &lt;!--å¼•å…¥æ ‡ç­¾--&gt; ä½¿ç”¨ï¼š 12345678910&lt;sql id=&quot;select&quot;&gt;SELECT * FROM user&lt;/sql&gt;&lt;select id=&quot;selectByIds&quot; resultType=&quot;user&quot; parameterType=&quot;list&quot;&gt; &lt;include refid=&quot;select&quot;/&gt; &lt;where&gt; &lt;foreach collection=&quot;list&quot; open=&quot;id IN(&quot; close=&quot;)&quot; item=&quot;id&quot; separator=&quot;,&quot;&gt; #&#123;id&#125; &lt;/foreach&gt; &lt;/where&gt; &lt;/select&gt; é€†å‘å·¥ç¨‹MyBatis é€†å‘å·¥ç¨‹ï¼Œå¯ä»¥é’ˆå¯¹å•è¡¨è‡ªåŠ¨ç”Ÿæˆ MyBatis æ‰§è¡Œæ‰€éœ€è¦çš„ä»£ç ï¼ˆmapper.javaã€mapper.xmlã€pojoâ€¦ï¼‰ generatorConfig.xml 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;!DOCTYPE generatorConfiguration PUBLIC &quot;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd&quot;&gt; &lt;generatorConfiguration&gt; &lt;context id=&quot;testTables&quot; targetRuntime=&quot;MyBatis3&quot;&gt; &lt;commentGenerator&gt; &lt;!-- æ˜¯å¦å»é™¤è‡ªåŠ¨ç”Ÿæˆçš„æ³¨é‡Š trueï¼šæ˜¯ ï¼š false:å¦ --&gt; &lt;property name=&quot;suppressAllComments&quot; value=&quot;true&quot; /&gt; &lt;/commentGenerator&gt; &lt;!--æ•°æ®åº“è¿æ¥çš„ä¿¡æ¯ï¼šé©±åŠ¨ç±»ã€è¿æ¥åœ°å€ã€ç”¨æˆ·åã€å¯†ç  --&gt; &lt;jdbcConnection driverClass=&quot;com.mysql.jdbc.Driver&quot; connectionURL=&quot;jdbc:mysql://localhost:3306/mybatisrelation&quot; userId=&quot;root&quot; password=&quot;root&quot;&gt; &lt;/jdbcConnection&gt; &lt;!-- é»˜è®¤falseï¼ŒæŠŠJDBC DECIMAL å’Œ NUMERIC ç±»å‹è§£æä¸º Integerï¼Œä¸º trueæ—¶æŠŠJDBC DECIMALå’ŒNUMERICç±»å‹è§£æä¸ºjava.math.BigDecimal --&gt; &lt;javaTypeResolver&gt; &lt;property name=&quot;forceBigDecimals&quot; value=&quot;false&quot; /&gt; &lt;/javaTypeResolver&gt; &lt;!-- targetProject:ç”ŸæˆPOç±»çš„ä½ç½®ï¼ï¼ --&gt; &lt;javaModelGenerator targetPackage=&quot;com.ys.po&quot; targetProject=&quot;.\\src&quot;&gt; &lt;!-- enableSubPackages:æ˜¯å¦è®©schemaä½œä¸ºåŒ…çš„åç¼€ --&gt; &lt;property name=&quot;enableSubPackages&quot; value=&quot;false&quot; /&gt; &lt;!-- ä»æ•°æ®åº“è¿”å›çš„å€¼è¢«æ¸…ç†å‰åçš„ç©ºæ ¼ --&gt; &lt;property name=&quot;trimStrings&quot; value=&quot;true&quot; /&gt; &lt;/javaModelGenerator&gt; &lt;!-- targetProject:mapperæ˜ å°„æ–‡ä»¶ç”Ÿæˆçš„ä½ç½®ï¼ï¼ --&gt; &lt;sqlMapGenerator targetPackage=&quot;com.ys.mapper&quot; targetProject=&quot;.\\src&quot;&gt; &lt;property name=&quot;enableSubPackages&quot; value=&quot;false&quot; /&gt; &lt;/sqlMapGenerator&gt; &lt;!-- targetPackageï¼šmapperæ¥å£ç”Ÿæˆçš„ä½ç½®ï¼Œé‡è¦ï¼ï¼ --&gt; &lt;javaClientGenerator type=&quot;XMLMAPPER&quot; targetPackage=&quot;com.ys.mapper&quot; targetProject=&quot;.\\src&quot;&gt; &lt;property name=&quot;enableSubPackages&quot; value=&quot;false&quot; /&gt; &lt;/javaClientGenerator&gt; &lt;!-- æŒ‡å®šæ•°æ®åº“è¡¨ï¼Œè¦ç”Ÿæˆå“ªäº›è¡¨ï¼Œå°±å†™å“ªäº›è¡¨ï¼Œè¦å’Œæ•°æ®åº“ä¸­å¯¹åº”ï¼Œä¸èƒ½å†™é”™ï¼ --&gt; &lt;table tableName=&quot;items&quot;&gt;&lt;/table&gt; &lt;table tableName=&quot;orders&quot;&gt;&lt;/table&gt; &lt;table tableName=&quot;orderdetail&quot;&gt;&lt;/table&gt; &lt;table tableName=&quot;user&quot;&gt;&lt;/table&gt; &lt;/context&gt;&lt;/generatorConfiguration&gt; ç”Ÿæˆä»£ç ï¼š 1234567891011121314public void testGenerator() throws Exception&#123; List&lt;String&gt; warnings = new ArrayList&lt;String&gt;(); boolean overwrite = true; //æŒ‡å‘é€†å‘å·¥ç¨‹é…ç½®æ–‡ä»¶ File configFile = new File(GeneratorTest.class. getResource(&quot;/generatorConfig.xml&quot;).getFile()); ConfigurationParser cp = new ConfigurationParser(warnings); Configuration config = cp.parseConfiguration(configFile); DefaultShellCallback callback = new DefaultShellCallback(overwrite); MyBatisGenerator myBatisGenerator = new MyBatisGenerator(config, callback, warnings); myBatisGenerator.generate(null);&#125; å‚è€ƒæ–‡ç« ï¼šhttps://www.cnblogs.com/ysocean/p/7360409.html æ„å»º SQLåŸºç¡€è¯­æ³•MyBatis æä¾›äº† org.apache.ibatis.jdbc.SQL åŠŸèƒ½ç±»ï¼Œä¸“é—¨ç”¨äºæ„å»º SQL è¯­å¥ æ–¹æ³• è¯´æ˜ SELECT(Stringâ€¦ columns) æ ¹æ®å­—æ®µæ‹¼æ¥æŸ¥è¯¢è¯­å¥ FROM(Stringâ€¦ tables) æ ¹æ®è¡¨åæ‹¼æ¥è¯­å¥ WHERE(Stringâ€¦ conditions) æ ¹æ®æ¡ä»¶æ‹¼æ¥è¯­å¥ INSERT_INTO(String tableName) æ ¹æ®è¡¨åæ‹¼æ¥æ–°å¢è¯­å¥ INTO_VALUES(Stringâ€¦ values) æ ¹æ®å€¼æ‹¼æ¥æ–°å¢è¯­å¥ UPDATE(String table) æ ¹æ®è¡¨åæ‹¼æ¥ä¿®æ”¹è¯­å¥ DELETE_FROM(String table) æ ¹æ®è¡¨åæ‹¼æ¥åˆ é™¤è¯­å¥ å¢åˆ æ”¹æŸ¥æ³¨è§£ï¼š @SelectProviderï¼šç”ŸæˆæŸ¥è¯¢ç”¨çš„ SQL è¯­å¥ @InsertProviderï¼šç”Ÿæˆæ–°å¢ç”¨çš„ SQL è¯­å¥ @UpdateProviderï¼šç”Ÿæˆä¿®æ”¹ç”¨çš„ SQL è¯­å¥æ³¨è§£ @DeleteProviderï¼šç”Ÿæˆåˆ é™¤ç”¨çš„ SQL è¯­å¥æ³¨è§£ã€‚ type å±æ€§ï¼šç”Ÿæˆ SQL è¯­å¥åŠŸèƒ½ç±»å¯¹è±¡ method å±æ€§ï¼šæŒ‡å®šè°ƒç”¨æ–¹æ³• åŸºæœ¬æ“ä½œ MyBatisConfig.xml é…ç½® 1234 &lt;!-- mapperså¼•å…¥æ˜ å°„é…ç½®æ–‡ä»¶ --&gt;&lt;mappers&gt; &lt;package name=&quot;mapper&quot;/&gt;&lt;/mappers&gt; Mapper ç±» 123456789101112131415161718public interface StudentMapper &#123; //æŸ¥è¯¢å…¨éƒ¨ @SelectProvider(type = ReturnSql.class, method = &quot;getSelectAll&quot;) public abstract List&lt;Student&gt; selectAll(); //æ–°å¢æ•°æ® @InsertProvider(type = ReturnSql.class, method = &quot;getInsert&quot;) public abstract Integer insert(Student student); //ä¿®æ”¹æ“ä½œ @UpdateProvider(type = ReturnSql.class, method = &quot;getUpdate&quot;) public abstract Integer update(Student student); //åˆ é™¤æ“ä½œ @DeleteProvider(type = ReturnSql.class, method = &quot;getDelete&quot;) public abstract Integer delete(Integer id);&#125; ReturnSQL ç±» 123456789101112131415161718192021222324252627282930313233343536373839404142public class ReturnSql &#123; //å®šä¹‰æ–¹æ³•ï¼Œè¿”å›æŸ¥è¯¢çš„sqlè¯­å¥ public String getSelectAll() &#123; return new SQL() &#123; &#123; SELECT(&quot;*&quot;); FROM(&quot;student&quot;); &#125; &#125;.toString(); &#125; //å®šä¹‰æ–¹æ³•ï¼Œè¿”å›æ–°å¢çš„sqlè¯­å¥ public String getInsert(Student stu) &#123; return new SQL() &#123; &#123; INSERT_INTO(&quot;student&quot;); INTO_VALUES(&quot;#&#123;id&#125;,#&#123;name&#125;,#&#123;age&#125;&quot;); &#125; &#125;.toString(); &#125; //å®šä¹‰æ–¹æ³•ï¼Œè¿”å›ä¿®æ”¹çš„sqlè¯­å¥ public String getUpdate(Student stu) &#123; return new SQL() &#123; &#123; UPDATE(&quot;student&quot;); SET(&quot;name=#&#123;name&#125;&quot;,&quot;age=#&#123;age&#125;&quot;); WHERE(&quot;id=#&#123;id&#125;&quot;); &#125; &#125;.toString(); &#125; //å®šä¹‰æ–¹æ³•ï¼Œè¿”å›åˆ é™¤çš„sqlè¯­å¥ public String getDelete(Integer id) &#123; return new SQL() &#123; &#123; DELETE_FROM(&quot;student&quot;); WHERE(&quot;id=#&#123;id&#125;&quot;); &#125; &#125;.toString(); &#125;&#125; åŠŸèƒ½å®ç°ç±» 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950public class SqlTest &#123; @Test //æŸ¥è¯¢å…¨éƒ¨ public void selectAll() throws Exception&#123; //1.åŠ è½½æ ¸å¿ƒé…ç½®æ–‡ä»¶ InputStream is = Resources.getResourceAsStream(&quot;MyBatisConfig.xml&quot;); //2.è·å–SqlSessionå·¥å‚å¯¹è±¡ SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(is); //3.é€šè¿‡å·¥å‚å¯¹è±¡è·å–SqlSessionå¯¹è±¡ SqlSession sqlSession = sqlSessionFactory.openSession(true); //4.è·å–StudentMapperæ¥å£çš„å®ç°ç±»å¯¹è±¡ StudentMapper mapper = sqlSession.getMapper(StudentMapper.class); //5.è°ƒç”¨å®ç°ç±»å¯¹è±¡ä¸­çš„æ–¹æ³•ï¼Œæ¥æ”¶ç»“æœ List&lt;Student&gt; list = mapper.selectAll(); //6.å¤„ç†ç»“æœ for (Student student : list) &#123; System.out.println(student); &#125; //7.é‡Šæ”¾èµ„æº sqlSession.close(); is.close(); &#125; @Test //æ–°å¢ public void insert() throws Exception&#123; //1 2 3 4è·å–StudentMapperæ¥å£çš„å®ç°ç±»å¯¹è±¡ StudentMapper mapper = sqlSession.getMapper(StudentMapper.class); //5.è°ƒç”¨å®ç°ç±»å¯¹è±¡ä¸­çš„æ–¹æ³•ï¼Œæ¥æ”¶ç»“æœ -&gt;6 7 Student stu = new Student(4,&quot;èµµå…­&quot;,26); Integer result = mapper.insert(stu); &#125; @Test //ä¿®æ”¹ public void update() throws Exception&#123; //1 2 3 4 5è°ƒç”¨å®ç°ç±»å¯¹è±¡ä¸­çš„æ–¹æ³•ï¼Œæ¥æ”¶ç»“æœ -&gt;6 7 Student stu = new Student(4,&quot;èµµå…­wq&quot;,36); Integer result = mapper.update(stu); &#125; @Test //åˆ é™¤ public void delete() throws Exception&#123; //1 2 3 4 5 6 7 Integer result = mapper.delete(4); &#125;&#125; è¿è¡ŒåŸç†è¿è¡Œæœºåˆ¶ MyBatis è¿è¡Œè¿‡ç¨‹ï¼š åŠ è½½ MyBatis å…¨å±€é…ç½®æ–‡ä»¶ï¼Œé€šè¿‡ XPath æ–¹å¼è§£æ XML é…ç½®æ–‡ä»¶ï¼Œé¦–å…ˆè§£ææ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼Œ æ ‡ç­¾ä¸­é…ç½®å±æ€§é¡¹æœ‰ defaultExecutorTypeï¼Œç”¨æ¥é…ç½®æŒ‡å®š Executor ç±»å‹ï¼Œå°†é…ç½®æ–‡ä»¶çš„ä¿¡æ¯å¡«å……åˆ° Configurationå¯¹è±¡ã€‚æœ€åè§£ææ˜ å°„å™¨é…ç½®çš„æ˜ å°„æ–‡ä»¶ï¼Œå¹¶æ„å»º MappedStatement å¯¹è±¡å¡«å……è‡³ Configurationï¼Œå°†è§£æåçš„æ˜ å°„å™¨æ·»åŠ åˆ° mapperRegistry ä¸­ï¼Œç”¨äºè·å–ä»£ç† åˆ›å»ºä¸€ä¸ª DefaultSqlSession å¯¹è±¡ï¼Œæ ¹æ®å‚æ•°åˆ›å»ºæŒ‡å®šç±»å‹çš„ Executorï¼ŒäºŒçº§ç¼“å­˜é»˜è®¤å¼€å¯ï¼ŒæŠŠ Executor åŒ…è£…æˆç¼“å­˜æ‰§è¡Œå™¨ DefaulSqlSession è°ƒç”¨ getMapper()ï¼Œé€šè¿‡ JDK åŠ¨æ€ä»£ç†è·å– Mapper æ¥å£çš„ä»£ç†å¯¹è±¡ MapperProxy æ‰§è¡Œ SQL è¯­å¥ï¼š MapperProxy.invoke() æ‰§è¡Œä»£ç†æ–¹æ³•ï¼Œé€šè¿‡ MapperMethod#execute åˆ¤æ–­æ‰§è¡Œçš„æ˜¯å¢åˆ æ”¹æŸ¥ä¸­çš„å“ªä¸ªæ–¹æ³• æŸ¥è¯¢æ–¹æ³•è°ƒç”¨ sqlSession.selectOne()ï¼Œä» Configuration ä¸­è·å–æ‰§è¡Œè€…å¯¹è±¡ MappedStatementï¼Œç„¶å Executor è°ƒç”¨ executor.query å¼€å§‹æ‰§è¡ŒæŸ¥è¯¢æ–¹æ³• é¦–å…ˆé€šè¿‡ CachingExecutor å»äºŒçº§ç¼“å­˜æŸ¥è¯¢ï¼ŒæŸ¥è¯¢ä¸åˆ°å»ä¸€çº§ç¼“å­˜æŸ¥è¯¢ï¼Œæœ€åå»æ•°æ®åº“æŸ¥è¯¢å¹¶æ”¾å…¥ä¸€çº§ç¼“å­˜ Configuration å¯¹è±¡æ ¹æ® æ ‡ç­¾çš„ statementType å±æ€§åˆ›å»º StatementHandler å¯¹è±¡ï¼Œåœ¨ StatementHandler çš„æ„é€ æ–¹æ³•ä¸­ï¼Œåˆ›å»ºäº† ParameterHandler å’Œ ResultSetHandler å¯¹è±¡ æœ€åè·å– JDBC åŸç”Ÿçš„ Connection æ•°æ®åº“è¿æ¥å¯¹è±¡ï¼Œåˆ›å»º Statement æ‰§è¡Œè€…å¯¹è±¡ï¼Œç„¶åé€šè¿‡ ParameterHandler è®¾ç½®é¢„ç¼–è¯‘å‚æ•°ï¼Œåº•å±‚æ˜¯ TypeHandler#setParameter æ–¹æ³•ï¼Œç„¶åé€šè¿‡ StatementHandler å›è°ƒæ‰§è¡Œè€…å¯¹è±¡æ‰§è¡Œå¢åˆ æ”¹æŸ¥ï¼Œæœ€åè°ƒç”¨ ResultsetHandler å¤„ç†æŸ¥è¯¢ç»“æœ å››å¤§å¯¹è±¡ï¼š StatementHandlerï¼šæ‰§è¡Œ SQL è¯­å¥çš„å¯¹è±¡ ParameterHandlerï¼šè®¾ç½®é¢„ç¼–è¯‘å‚æ•°ç”¨çš„ ResultHandlerï¼šå¤„ç†ç»“æœé›† Executorï¼šæ‰§è¡Œå™¨ï¼ŒçœŸæ­£è¿›è¡Œ Java ä¸æ•°æ®åº“äº¤äº’çš„å¯¹è±¡ å‚è€ƒè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV1mW411M737?p=71 è·å–å·¥å‚SqlSessionFactoryBuilder.build(InputStream, String, Properties)ï¼šæ„å»ºå·¥å‚ XMLConfigBuilder.parse()ï¼šè§£ææ ¸å¿ƒé…ç½®æ–‡ä»¶æ¯ä¸ªæ ‡ç­¾çš„ä¿¡æ¯ï¼ˆXPathï¼‰ parseConfiguration(parser.evalNode(&quot;/configuration&quot;))ï¼šè¯»å–èŠ‚ç‚¹å†…æ•°æ®ï¼Œ æ˜¯ MyBatis é…ç½®æ–‡ä»¶ä¸­çš„é¡¶å±‚æ ‡ç­¾ settings = settingsAsProperties(root.evalNode(&quot;settings&quot;))ï¼šè¯»å–æ ¸å¿ƒé…ç½®æ–‡ä»¶ä¸­çš„ æ ‡ç­¾ settingsElement(settings)ï¼šè®¾ç½®æ¡†æ¶ç›¸å…³çš„å±æ€§ configuration.setCacheEnabled()ï¼šè®¾ç½®ç¼“å­˜å±æ€§ï¼Œé»˜è®¤æ˜¯ true configuration.setDefaultExecutorType()ï¼šè®¾ç½® Executor ç±»å‹åˆ° configurationï¼Œé»˜è®¤æ˜¯ SIMPLE mapperElement(root.evalNode(&quot;mappers&quot;))ï¼šè§£æ mappers ä¿¡æ¯ï¼Œåˆ†ä¸º package å’Œ å•ä¸ªæ³¨å†Œä¸¤ç§ if...else...ï¼šæ ¹æ®æ˜ å°„æ–¹æ³•é€‰æ‹©åˆé€‚çš„è¯»å–æ–¹å¼ XMLMapperBuilder.parse()ï¼šè§£æ mapper çš„æ ‡ç­¾çš„ä¿¡æ¯ configurationElement(parser.evalNode(&quot;/mapper&quot;))ï¼šè§£æ mapper æ–‡ä»¶ï¼Œé¡¶å±‚èŠ‚ç‚¹ buildStatementFromContext(context.evalNodes(&quot;select...&quot;))ï¼šè§£ææ¯ä¸ªæ“ä½œæ ‡ç­¾ XMLStatementBuilder.parseStatementNode()ï¼šè§£ææ“ä½œæ ‡ç­¾çš„æ‰€æœ‰çš„å±æ€§ builderAssistant.addMappedStatement(...)ï¼šå°è£…æˆ MappedStatement å¯¹è±¡åŠ å…¥ Configuration å¯¹è±¡ï¼Œä»£è¡¨ä¸€ä¸ªå¢åˆ æ”¹æŸ¥çš„æ ‡ç­¾ Class&lt;?&gt; mapperInterface = Resources.classForName(mapperClass)ï¼šåŠ è½½ Mapper æ¥å£ Configuration.addMappers()ï¼šå°†æ ¸å¿ƒé…ç½®æ–‡ä»¶é…ç½®çš„æ˜ å°„å™¨æ·»åŠ åˆ° mapperRegistry ä¸­ï¼Œç”¨æ¥è·å–ä»£ç†å¯¹è±¡ MapperAnnotationBuilder parser = new MapperAnnotationBuilder(config, type)ï¼šåˆ›å»ºæ³¨è§£è§£æå™¨ parser.parse()ï¼šè§£æ Mapper æ¥å£ SqlSource sqlSource = getSqlSourceFromAnnotations()ï¼šè·å– SQL çš„èµ„æºå¯¹è±¡ builderAssistant.addMappedStatement(...)ï¼šå°è£…æˆ MappedStatement å¯¹è±¡åŠ å…¥ Configuration å¯¹è±¡ return configurationï¼šè¿”å›é…ç½®å®Œæˆçš„ configuration å¯¹è±¡ return new DefaultSqlSessionFactory(config)ï¼šè¿”å›å·¥å‚å¯¹è±¡ï¼ŒåŒ…å« Configuration å¯¹è±¡ æ€»ç»“ï¼šè§£æ XML æ˜¯å¯¹ Configuration ä¸­çš„å±æ€§è¿›è¡Œå¡«å……ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨ä¸€ä¸ªç±»ä¸­åˆ›å»º Configuration å¯¹è±¡ï¼Œè‡ªå®šä¹‰å…¶ä¸­å±æ€§çš„å€¼æ¥è¾¾åˆ°é…ç½®çš„æ•ˆæœ è·å–ä¼šè¯DefaultSqlSessionFactory.openSession()ï¼šè·å– Session å¯¹è±¡ï¼Œå¹¶ä¸”åˆ›å»º Executor å¯¹è±¡ DefaultSqlSessionFactory.openSessionFromDataSource(â€¦)ï¼šExecutorType ä¸º Executor çš„ç±»å‹ï¼ŒTransactionIsolationLevel ä¸ºäº‹åŠ¡éš”ç¦»çº§åˆ«ï¼ŒautoCommit æ˜¯å¦å¼€å¯äº‹åŠ¡ transactionFactory.newTransaction(DataSource, IsolationLevel, booleanï¼šäº‹åŠ¡å¯¹è±¡ configuration.newExecutor(tx, execType)ï¼šæ ¹æ®å‚æ•°åˆ›å»ºæŒ‡å®šç±»å‹çš„ Executor æ‰¹é‡æ“ä½œç¬”è®°çš„éƒ¨åˆ†æœ‰è®²è§£åˆ° çš„å±æ€§ defaultExecutorTypeï¼Œæ ¹æ®é…ç½®åˆ›å»ºå¯¹è±¡ äºŒçº§ç¼“å­˜é»˜è®¤å¼€å¯ï¼Œä¼šåŒ…è£… Executor å¯¹è±¡ new CachingExecutor(executor) return new DefaultSqlSession(configuration, executor, autoCommit)ï¼šè¿”å› DefaultSqlSession å¯¹è±¡ è·å–ä»£ç†Configuration.getMapper(Class, SqlSession)ï¼šè·å–ä»£ç†çš„ mapper å¯¹è±¡ MapperRegistry.getMapper(Class, SqlSession)ï¼šMapperRegistry æ˜¯ Configuration å±æ€§ï¼Œåœ¨è·å–å·¥å‚å¯¹è±¡æ—¶åˆå§‹åŒ– (MapperProxyFactory&lt;T&gt;) knownMappers.get(type)ï¼šè·å–æ¥å£ä¿¡æ¯å°è£…ä¸º MapperProxyFactory å¯¹è±¡ mapperProxyFactory.newInstance(sqlSession)ï¼šåˆ›å»ºä»£ç†å¯¹è±¡ new MapperProxy&lt;&gt;(sqlSession, mapperInterface, methodCache)ï¼šåŒ…è£…å¯¹è±¡ methodCache æ˜¯å¹¶å‘å®‰å…¨çš„ ConcurrentHashMap é›†åˆï¼Œå­˜æ”¾è¦æ‰§è¡Œçš„æ–¹æ³• MapperProxy&lt;T&gt; implements InvocationHandler è¯´æ˜ MapperProxy é»˜è®¤æ˜¯ä¸€ä¸ª InvocationHandler å¯¹è±¡ Proxy.newProxyInstance()ï¼šJDK åŠ¨æ€ä»£ç†åˆ›å»º MapperProxy å¯¹è±¡ æ‰§è¡ŒSQLMapperProxy.invoke()ï¼šæ‰§è¡Œ SQL è¯­å¥ï¼ŒObject ç±»çš„æ–¹æ³•ç›´æ¥æ‰§è¡Œ 1234567891011121314151617public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; try &#123; // å½“å‰æ–¹æ³•æ˜¯å¦æ˜¯å±äº Object ç±»ä¸­çš„æ–¹æ³• if (Object.class.equals(method.getDeclaringClass())) &#123; return method.invoke(this, args); // å½“å‰æ–¹æ³•æ˜¯å¦æ˜¯é»˜è®¤æ–¹æ³• &#125; else if (isDefaultMethod(method)) &#123; return invokeDefaultMethod(proxy, method, args); &#125; &#125; catch (Throwable t) &#123; throw ExceptionUtil.unwrapThrowable(t); &#125; // åŒ…è£…æˆä¸€ä¸ª MapperMethod å¯¹è±¡å¹¶åˆå§‹åŒ–è¯¥å¯¹è±¡ final MapperMethod mapperMethod = cachedMapperMethod(method); // ã€æ ¹æ® switch-case åˆ¤æ–­ä½¿ç”¨çš„ä»€ä¹ˆç±»å‹çš„ SQL è¿›è¡Œé€»è¾‘å¤„ç†ã€‘ï¼Œæ­¤å¤„åˆ†ææŸ¥è¯¢è¯­å¥çš„æŸ¥è¯¢æ“ä½œ return mapperMethod.execute(sqlSession, args);&#125; sqlSession.selectOne(String, Object)ï¼šæŸ¥è¯¢æ•°æ® 12345678910111213public Object execute(SqlSession sqlSession, Object[] args) &#123; //..... // è§£æä¼ å…¥çš„å‚æ•° Object param = method.convertArgsToSqlCommandParam(args); result = sqlSession.selectOne(command.getName(), param);&#125;// DefaultSqlSession.selectList(String, Object)public &lt;E&gt; List&lt;E&gt; selectList(String statement, Object parameter, RowBounds rowBounds) &#123; // è·å–æ‰§è¡Œè€…å¯¹è±¡ MappedStatement ms = configuration.getMappedStatement(statement); // å¼€å§‹æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ï¼Œå‚æ•°é€šè¿‡ wrapCollection() åŒ…è£…æˆé›†åˆç±» return executor.query(ms, wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);&#125; Executor#query()ï¼š CachingExecutor.query()ï¼šå…ˆæ‰§è¡Œ CachingExecutor å»äºŒçº§ç¼“å­˜è·å–æ•°æ® 123public class CachingExecutor implements Executor &#123; private final Executor delegate; // åŒ…è£…äº† BaseExecutorï¼ŒäºŒçº§ç¼“å­˜ä¸å­˜åœ¨æ•°æ®è°ƒç”¨ BaseExecutor æŸ¥è¯¢&#125; MappedStatement.getBoundSql(parameterObject)ï¼šæŠŠ parameterObject å°è£…æˆ BoundSql æ„é€ å‡½æ•°ä¸­æœ‰ï¼šthis.parameterObject = parameterObject CachingExecutor.createCacheKey()ï¼šåˆ›å»ºç¼“å­˜å¯¹è±¡ ms.getCache()ï¼šè·å–äºŒçº§ç¼“å­˜ tcm.getObject(cache, key)ï¼šå°è¯•ä»äºŒçº§ç¼“å­˜ä¸­è·å–æ•°æ® BaseExecutor.query()ï¼šäºŒçº§ç¼“å­˜ä¸å­˜åœ¨è¯¥æ•°æ®ï¼Œè°ƒç”¨è¯¥æ–¹æ³• localCache.getObject(key) ï¼šå°è¯•ä»æœ¬åœ°ç¼“å­˜ï¼ˆä¸€çº§ç¼“å­˜ï¼‰è·å–æ•°æ® BaseExecutor.queryFromDatabase()ï¼šç¼“å­˜è·å–æ•°æ®å¤±è´¥ï¼Œå¼€å§‹ä»æ•°æ®åº“è·å–æ•°æ®ï¼Œå¹¶æ”¾å…¥æœ¬åœ°ç¼“å­˜ SimpleExecutor.doQuery()ï¼šæ‰§è¡Œ query configuration.newStatementHandler()ï¼šåˆ›å»º StatementHandler å¯¹è±¡ æ ¹æ® æ ‡ç­¾çš„ statementType å±æ€§ï¼Œæ ¹æ®å±æ€§é€‰æ‹©åˆ›å»ºå“ªç§å¯¹è±¡ åˆ¤æ–­ BoundSql æ˜¯å¦è¢«åˆ›å»ºï¼Œæ²¡æœ‰åˆ›å»ºä¼šé‡æ–°å°è£…å‚æ•°ä¿¡æ¯åˆ° BoundSql StatementHandler çš„æ„é€ æ–¹æ³•ä¸­ï¼Œåˆ›å»ºäº† ParameterHandler å’Œ ResultSetHandler å¯¹è±¡ interceptorChain.pluginAll(statementHandler)ï¼šæ‹¦æˆªå™¨é“¾ prepareStatement()ï¼šé€šè¿‡ StatementHandler åˆ›å»º JDBC åŸç”Ÿçš„ Statement å¯¹è±¡ getConnection()ï¼šè·å– JDBC çš„ Connection å¯¹è±¡ handler.prepare()ï¼šåˆå§‹åŒ– Statement å¯¹è±¡ instantiateStatement(Connection connection)ï¼šConnection ä¸­çš„æ–¹æ³•å®ä¾‹åŒ–å¯¹è±¡ è·å–æ™®é€šæ‰§è¡Œè€…å¯¹è±¡ï¼šConnection.createStatement() è·å–é¢„ç¼–è¯‘æ‰§è¡Œè€…å¯¹è±¡ï¼šConnection.prepareStatement() handler.parameterize()ï¼šè¿›è¡Œå‚æ•°çš„è®¾ç½® ParameterHandler.setParameters()ï¼šé€šè¿‡ ParameterHandler è®¾ç½®å‚æ•° typeHandler.setParameter()ï¼šåº•å±‚é€šè¿‡ TypeHandler å®ç°ï¼Œå›è°ƒ JDBC çš„æ¥å£è¿›è¡Œè®¾ç½® StatementHandler.query()ï¼šè°ƒç”¨ JDBC åŸç”Ÿçš„ PreparedStatement æ‰§è¡Œ SQL 1234567public &lt;E&gt; List&lt;E&gt; query(Statement statement, ResultHandler resultHandler) &#123; // è·å– SQL è¯­å¥ String sql = boundSql.getSql(); statement.execute(sql); // é€šè¿‡ ResultSetHandler å¯¹è±¡å°è£…ç»“æœé›†ï¼Œæ˜ å°„æˆ JavaBean return resultSetHandler.handleResultSets(statement); &#125; resultSetHandler.handleResultSets(statement)ï¼šå¤„ç†ç»“æœé›† handleResultSet(rsw, resultMap, multipleResults, null)ï¼šåº•å±‚å›è°ƒ handleRowValues()ï¼šé€è¡Œå¤„ç†æ•°æ®ï¼Œæ ¹æ®æ˜¯å¦é…ç½®äº† å±æ€§é€‰æ‹©æ˜¯å¦ä½¿ç”¨ç®€å•ç»“æœé›†æ˜ å°„ é¦–å…ˆåˆ¤æ–­æ•°æ®æ˜¯å¦è¢«é™åˆ¶è¡Œæ•°ï¼Œç„¶åè¿›è¡Œç»“æœé›†çš„æ˜ å°„ æœ€åå°†æ•°æ®å­˜å…¥ ResultHandler å¯¹è±¡ï¼Œåº•å±‚å°±æ˜¯ List é›†åˆ 123456public class DefaultResultHandler implements ResultHandler&lt;Object&gt; &#123; private final List&lt;Object&gt; list; public void handleResult(ResultContext&lt;?&gt; context) &#123; list.add(context.getResultObject()); &#125;&#125; return collapseSingleResultList(multipleResults)ï¼šå¯èƒ½å­˜åœ¨å¤šä¸ªç»“æœé›†çš„æƒ…å†µ localCache.putObject(key, list)ï¼šæ”¾å…¥ä¸€çº§ï¼ˆæœ¬åœ°ï¼‰ç¼“å­˜ return list.get(0)ï¼šè¿”å›ç»“æœé›†çš„ç¬¬ä¸€ä¸ªæ•°æ® æ’ä»¶ä½¿ç”¨æ’ä»¶åŸç†å®ç°åŸç†ï¼šæ’ä»¶æ˜¯æŒ‰ç…§æ’ä»¶é…ç½®é¡ºåºåˆ›å»ºå±‚å±‚åŒ…è£…å¯¹è±¡ï¼Œæ‰§è¡Œç›®æ ‡æ–¹æ³•çš„ä¹‹åï¼ŒæŒ‰ç…§é€†å‘é¡ºåºæ‰§è¡Œï¼ˆæ ˆï¼‰ åœ¨å››å¤§å¯¹è±¡åˆ›å»ºæ—¶ï¼š æ¯ä¸ªåˆ›å»ºå‡ºæ¥çš„å¯¹è±¡ä¸æ˜¯ç›´æ¥è¿”å›çš„ï¼Œè€Œæ˜¯ interceptorChain.pluginAll(parameterHandler) è·å–åˆ°æ‰€æœ‰ Interceptorï¼ˆæ’ä»¶éœ€è¦å®ç°çš„æ¥å£ï¼‰ï¼Œè°ƒç”¨ interceptor.plugin(target)è¿”å› target åŒ…è£…åçš„å¯¹è±¡ æ’ä»¶æœºåˆ¶å¯ä»¥ä½¿ç”¨æ’ä»¶ä¸ºç›®æ ‡å¯¹è±¡åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œä»£ç†å¯¹è±¡å¯ä»¥æ‹¦æˆªåˆ°å››å¤§å¯¹è±¡çš„æ¯ä¸€ä¸ªæ‰§è¡Œ 123456789101112131415161718192021222324252627282930313233343536373839404142@Intercepts( &#123; @Signature(type=StatementHandler.class,method=&quot;parameterize&quot;,args=java.sql.Statement.class) &#125;)public class MyFirstPlugin implements Interceptor&#123; //interceptï¼šæ‹¦æˆªç›®æ ‡å¯¹è±¡çš„ç›®æ ‡æ–¹æ³•çš„æ‰§è¡Œ @Override public Object intercept(Invocation invocation) throws Throwable &#123; System.out.println(&quot;MyFirstPlugin...intercept:&quot; + invocation.getMethod()); //åŠ¨æ€çš„æ”¹å˜ä¸€ä¸‹sqlè¿è¡Œçš„å‚æ•°ï¼šä»¥å‰1å·å‘˜å·¥ï¼Œå®é™…ä»æ•°æ®åº“æŸ¥è¯¢11å·å‘˜å·¥ Object target = invocation.getTarget(); System.out.println(&quot;å½“å‰æ‹¦æˆªåˆ°çš„å¯¹è±¡ï¼š&quot; + target); //æ‹¿åˆ°ï¼šStatementHandler==&gt;ParameterHandler===&gt;parameterObject //æ‹¿åˆ°targetçš„å…ƒæ•°æ® MetaObject metaObject = SystemMetaObject.forObject(target); Object value = metaObject.getValue(&quot;parameterHandler.parameterObject&quot;); System.out.println(&quot;sqlè¯­å¥ç”¨çš„å‚æ•°æ˜¯ï¼š&quot; + value); //ä¿®æ”¹å®Œsqlè¯­å¥è¦ç”¨çš„å‚æ•° metaObject.setValue(&quot;parameterHandler.parameterObject&quot;, 11); //æ‰§è¡Œç›®æ ‡æ–¹æ³• Object proceed = invocation.proceed(); //è¿”å›æ‰§è¡Œåçš„è¿”å›å€¼ return proceed; &#125; // pluginï¼šåŒ…è£…ç›®æ ‡å¯¹è±¡çš„ï¼Œä¸ºç›®æ ‡å¯¹è±¡åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡ @Override public Object plugin(Object target) &#123; //å¯ä»¥å€ŸåŠ© Plugin çš„ wrap æ–¹æ³•æ¥ä½¿ç”¨å½“å‰ Interceptor åŒ…è£…æˆ‘ä»¬ç›®æ ‡å¯¹è±¡ System.out.println(&quot;MyFirstPlugin...plugin:mybatiså°†è¦åŒ…è£…çš„å¯¹è±¡&quot; + target); Object wrap = Plugin.wrap(target, this); //è¿”å›ä¸ºå½“å‰targetåˆ›å»ºçš„åŠ¨æ€ä»£ç† return wrap; &#125; // setPropertiesï¼šå°†æ’ä»¶æ³¨å†Œæ—¶çš„propertyå±æ€§è®¾ç½®è¿›æ¥ @Override public void setProperties(Properties properties) &#123; System.out.println(&quot;æ’ä»¶é…ç½®çš„ä¿¡æ¯ï¼š&quot; + properties); &#125;&#125; æ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼š 1234567&lt;!--pluginsï¼šæ³¨å†Œæ’ä»¶ --&gt;&lt;plugins&gt; &lt;plugin interceptor=&quot;mybatis.dao.MyFirstPlugin&quot;&gt; &lt;property name=&quot;username&quot; value=&quot;root&quot;/&gt; &lt;property name=&quot;password&quot; value=&quot;123456&quot;/&gt; &lt;/plugin&gt;&lt;/plugins&gt; åˆ†é¡µæ’ä»¶ åˆ†é¡µå¯ä»¥å°†å¾ˆå¤šæ¡ç»“æœè¿›è¡Œåˆ†é¡µæ˜¾ç¤ºã€‚å¦‚æœå½“å‰åœ¨ç¬¬ä¸€é¡µï¼Œåˆ™æ²¡æœ‰ä¸Šä¸€é¡µã€‚å¦‚æœå½“å‰åœ¨æœ€åä¸€é¡µï¼Œåˆ™æ²¡æœ‰ä¸‹ä¸€é¡µï¼Œéœ€è¦æ˜ç¡®å½“å‰æ˜¯ç¬¬å‡ é¡µï¼Œè¿™ä¸€é¡µä¸­æ˜¾ç¤ºå¤šå°‘æ¡ç»“æœã€‚ MyBatis æ˜¯ä¸å¸¦åˆ†é¡µåŠŸèƒ½çš„ï¼Œå¦‚æœæƒ³å®ç°åˆ†é¡µåŠŸèƒ½ï¼Œéœ€è¦æ‰‹åŠ¨ç¼–å†™ LIMIT è¯­å¥ï¼Œä¸åŒçš„æ•°æ®åº“å®ç°åˆ†é¡µçš„ SQL è¯­å¥ä¹Ÿæ˜¯ä¸åŒï¼Œæ‰‹å†™åˆ†é¡µ æˆæœ¬è¾ƒé«˜ã€‚ PageHelperï¼šç¬¬ä¸‰æ–¹åˆ†é¡µåŠ©æ‰‹ï¼Œå°†å¤æ‚çš„åˆ†é¡µæ“ä½œè¿›è¡Œå°è£…ï¼Œä»è€Œè®©åˆ†é¡µåŠŸèƒ½å˜å¾—éå¸¸ç®€å• åˆ†é¡µæ“ä½œå¼€å‘æ­¥éª¤ï¼š å¯¼å…¥ PageHelper çš„ Maven åæ ‡ åœ¨ MyBatis æ ¸å¿ƒé…ç½®æ–‡ä»¶ä¸­é…ç½® PageHelper æ’ä»¶ æ³¨æ„ï¼šåˆ†é¡µåŠ©æ‰‹çš„æ’ä»¶é…ç½®åœ¨é€šç”¨ Mapper ä¹‹å‰ 1234567&lt;plugins&gt; &lt;plugin interceptor=&quot;com.github.pagehelper.PageInterceptor&quot;&gt; &lt;!-- æŒ‡å®šæ–¹è¨€ --&gt; &lt;property name=&quot;dialect&quot; value=&quot;mysql&quot;/&gt; &lt;/plugin&gt; &lt;/plugins&gt;&lt;mappers&gt;.........&lt;/mappers&gt; ä¸ MySQL åˆ†é¡µæŸ¥è¯¢é¡µæ•°è®¡ç®—å…¬å¼ä¸åŒ static &lt;E&gt; Page&lt;E&gt; startPage(int pageNum, int pageSize)ï¼špageNumç¬¬å‡ é¡µï¼ŒpageSizeé¡µé¢å¤§å° 123456789@Testpublic void selectAll() &#123; //ç¬¬ä¸€é¡µï¼šæ˜¾ç¤º2æ¡æ•°æ® PageHelper.startPage(1,2); List&lt;Student&gt; students = sqlSession.selectList(&quot;StudentMapper.selectAll&quot;); for (Student student : students) &#123; System.out.println(student); &#125;&#125; å‚æ•°è·å–PageInfoæ„é€ æ–¹æ³•ï¼š PageInfo&lt;Student&gt; info = new PageInfo&lt;&gt;(list) : list æ˜¯ SQL æ‰§è¡Œè¿”å›çš„ç»“æœé›†åˆï¼Œå‚è€ƒä¸Šä¸€èŠ‚ PageInfoç›¸å…³APIï¼š startPage()ï¼šè®¾ç½®åˆ†é¡µå‚æ•° PageInfoï¼šåˆ†é¡µç›¸å…³å‚æ•°åŠŸèƒ½ç±»ã€‚ getTotal()ï¼šè·å–æ€»æ¡æ•° getPages()ï¼šè·å–æ€»é¡µæ•° getPageNum()ï¼šè·å–å½“å‰é¡µ getPageSize()ï¼šè·å–æ¯é¡µæ˜¾ç¤ºæ¡æ•° getPrePage()ï¼šè·å–ä¸Šä¸€é¡µ getNextPage()ï¼šè·å–ä¸‹ä¸€é¡µ isIsFirstPage()ï¼šè·å–æ˜¯å¦æ˜¯ç¬¬ä¸€é¡µ isIsLastPage()ï¼šè·å–æ˜¯å¦æ˜¯æœ€åä¸€é¡µ Springæ¦‚è¿°Spring æ˜¯åˆ†å±‚çš„ JavaSE&#x2F;EE åº”ç”¨ full-stack è½»é‡çº§å¼€æºæ¡†æ¶ Spring ä¼˜ç‚¹ï¼š æ–¹ä¾¿è§£è€¦ï¼Œç®€åŒ–å¼€å‘ æ–¹ä¾¿é›†æˆå„ç§æ¡†æ¶ æ–¹ä¾¿ç¨‹åºæµ‹è¯• AOP ç¼–ç¨‹éš¾è¿‡çš„æ”¯æŒ å£°æ˜å¼äº‹åŠ¡çš„æ”¯æŒ é™ä½ JavaEE API çš„ä½¿ç”¨éš¾åº¦ ä½“ç³»ç»“æ„ï¼š å‚è€ƒè§†é¢‘ï¼šhttps://space.bilibili.com/37974444 IoCåŸºæœ¬æ¦‚è¿° IoCï¼ˆInversion Of Controlï¼‰æ§åˆ¶åè½¬ï¼ŒSpring åå‘æ§åˆ¶åº”ç”¨ç¨‹åºæ‰€éœ€è¦ä½¿ç”¨çš„å¤–éƒ¨èµ„æº Spring æ§åˆ¶çš„èµ„æºå…¨éƒ¨æ”¾ç½®åœ¨ Spring å®¹å™¨ä¸­ï¼Œè¯¥å®¹å™¨ç§°ä¸º IoC å®¹å™¨ï¼ˆå­˜æ”¾å®ä¾‹å¯¹è±¡ï¼‰ å®˜æ–¹ç½‘ç«™ï¼šhttps://spring.io/ â†’ Projects â†’ spring-framework â†’ LEARN â†’ Reference Doc è€¦åˆï¼ˆCouplingï¼‰ï¼šä»£ç ç¼–å†™è¿‡ç¨‹ä¸­æ‰€ä½¿ç”¨æŠ€æœ¯çš„ç»“åˆç´§å¯†åº¦ï¼Œç”¨äºè¡¡é‡è½¯ä»¶ä¸­å„ä¸ªæ¨¡å—ä¹‹é—´çš„äº’è”ç¨‹åº¦ å†…èšï¼ˆCohesionï¼‰ï¼šä»£ç ç¼–å†™è¿‡ç¨‹ä¸­å•ä¸ªæ¨¡å—å†…éƒ¨å„ç»„æˆéƒ¨åˆ†é—´çš„è”ç³»ï¼Œç”¨äºè¡¡é‡è½¯ä»¶ä¸­å„ä¸ªåŠŸèƒ½æ¨¡å—å†…éƒ¨çš„åŠŸèƒ½è”ç³» ä»£ç ç¼–å†™çš„ç›®æ ‡ï¼šé«˜å†…èšï¼Œä½è€¦åˆã€‚åŒä¸€ä¸ªæ¨¡å—å†…çš„å„ä¸ªå…ƒç´ ä¹‹é—´è¦é«˜åº¦ç´§å¯†ï¼Œå„ä¸ªæ¨¡å—ä¹‹é—´çš„ç›¸äº’ä¾å­˜åº¦ä¸ç´§å¯† å…¥é—¨é¡¹ç›®æ¨¡æ‹Ÿä¸‰å±‚æ¶æ„ä¸­è¡¨ç°å±‚è°ƒç”¨ä¸šåŠ¡å±‚åŠŸèƒ½ è¡¨ç°å±‚ï¼šUserApp æ¨¡æ‹Ÿ UserServletï¼ˆä½¿ç”¨ main æ–¹æ³•æ¨¡æ‹Ÿï¼‰ ä¸šåŠ¡å±‚ï¼šUserService æ­¥éª¤ï¼š å¯¼å…¥ spring åæ ‡ï¼ˆ5.1.9.releaseï¼‰ 12345&lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-context&lt;/artifactId&gt; &lt;version&gt;5.1.9.RELEASE&lt;/version&gt;&lt;/dependency&gt; ç¼–å†™ä¸šåŠ¡å±‚ä¸è¡¨ç°å±‚ï¼ˆæ¨¡æ‹Ÿï¼‰æ¥å£ä¸å®ç°ç±» service.UserServiceï¼Œservice.impl.UserServiceImpl 1234public interface UserService &#123; //ä¸šåŠ¡æ–¹æ³• void save();&#125; 12345public class UserServiceImpl implements UserService &#123; public void save() &#123; System.out.println(&quot;user service running...&quot;); &#125;&#125; å»ºç«‹ Spring é…ç½®æ–‡ä»¶ï¼šresources.applicationContext.xml (åå­—ä¸€èˆ¬ä½¿ç”¨è¯¥æ ¼å¼) é…ç½®æ‰€éœ€èµ„æºï¼ˆServiceï¼‰ä¸º Spring æ§åˆ¶çš„èµ„æº 12345678&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans https://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt; &lt;!-- 1.åˆ›å»ºspringæ§åˆ¶çš„èµ„æº--&gt; &lt;bean id=&quot;userService&quot; class=&quot;service.impl.UserServiceImpl&quot;/&gt;&lt;/beans&gt; è¡¨ç°å±‚ï¼ˆAppï¼‰é€šè¿‡ Spring è·å–èµ„æºï¼ˆService å®ä¾‹ï¼‰ 123456789public class UserApp &#123; public static void main(String[] args) &#123; //2.åŠ è½½é…ç½®æ–‡ä»¶ ApplicationContext ctx = new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;); //3.è·å–èµ„æº UserService userService = (UserService) ctx.getBean(&quot;userService&quot;); userService.save();//user service running... &#125;&#125; XMLå¼€å‘beanåŸºæœ¬å±æ€§æ ‡ç­¾ï¼š æ ‡ç­¾ï¼Œ çš„å­æ ‡ç­¾ ä½œç”¨ï¼šå®šä¹‰ Spring ä¸­çš„èµ„æºï¼Œå—æ­¤æ ‡ç­¾å®šä¹‰çš„èµ„æºå°†å—åˆ° Spring æ§åˆ¶ æ ¼å¼ï¼š 123&lt;beans&gt; &lt;bean /&gt;&lt;/beans&gt; åŸºæœ¬å±æ€§ idï¼šbean çš„åç§°ï¼Œé€šè¿‡ id å€¼è·å– bean (é¦–å­—æ¯å°å†™) classï¼šbean çš„ç±»å‹ï¼Œä½¿ç”¨å®Œå…¨é™å®šç±»å nameï¼šbean çš„åç§°ï¼Œå¯ä»¥é€šè¿‡ name å€¼è·å– beanï¼Œç”¨äºå¤šäººé…åˆæ—¶ç»™ bean èµ·åˆ«å 1&lt;bean id=&quot;beanId&quot; name=&quot;beanName1,beanName2&quot; class=&quot;ClassName&quot;&gt;&lt;/bean&gt; 1ctx.getBean(&quot;beanId&quot;) == ctx.getBean(&quot;beanName1&quot;) == ctx.getBean(&quot;beanName2&quot;) ä½œç”¨èŒƒå›´ä½œç”¨ï¼šå®šä¹‰ bean çš„ä½œç”¨èŒƒå›´ æ ¼å¼ï¼š 1&lt;bean scope=&quot;singleton&quot;&gt;&lt;/bean&gt; å–å€¼ï¼š singletonï¼šè®¾å®šåˆ›å»ºå‡ºçš„å¯¹è±¡ä¿å­˜åœ¨ Spring å®¹å™¨ä¸­ï¼Œæ˜¯ä¸€ä¸ªå•ä¾‹çš„å¯¹è±¡ prototypeï¼šè®¾å®šåˆ›å»ºå‡ºçš„å¯¹è±¡ä¿å­˜åœ¨ Spring å®¹å™¨ä¸­ï¼Œæ˜¯ä¸€ä¸ªéå•ä¾‹ï¼ˆåŸå‹ï¼‰çš„å¯¹è±¡ requestã€sessionã€applicationã€ websocket ï¼šè®¾å®šåˆ›å»ºå‡ºçš„å¯¹è±¡æ”¾ç½®åœ¨ web å®¹å™¨å¯¹åº”çš„ä½ç½® Spring å®¹å™¨ä¸­ Bean çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼š åŸå‹ Beanï¼Œæ¯æ¬¡åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œçº¿ç¨‹ä¹‹é—´å¹¶ä¸å­˜åœ¨ Bean å…±äº«ï¼Œæ‰€ä»¥ä¸ä¼šæœ‰çº¿ç¨‹å®‰å…¨çš„é—®é¢˜ å•ä¾‹ Beanï¼Œæ‰€æœ‰çº¿ç¨‹å…±äº«ä¸€ä¸ªå•ä¾‹å®ä¾‹ Beanï¼Œå› æ­¤æ˜¯å­˜åœ¨èµ„æºçš„ç«äº‰ï¼Œå¦‚æœå•ä¾‹ Beanæ˜¯ä¸€ä¸ªæ— çŠ¶æ€ Beanï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹ä¸­çš„æ“ä½œä¸ä¼šå¯¹ Bean çš„æˆå‘˜æ‰§è¡ŒæŸ¥è¯¢ä»¥å¤–çš„æ“ä½œï¼Œé‚£ä¹ˆè¿™ä¸ªå•ä¾‹ Bean æ˜¯çº¿ç¨‹å®‰å…¨çš„ è§£å†³æ–¹æ³•ï¼šå¼€å‘äººå‘˜æ¥è¿›è¡Œçº¿ç¨‹å®‰å…¨çš„ä¿è¯ï¼Œæœ€ç®€å•çš„åŠæ³•å°±æ˜¯æŠŠ Bean çš„ä½œç”¨åŸŸ singleton æ”¹ä¸º protopyte ç”Ÿå‘½å‘¨æœŸä½œç”¨ï¼šå®šä¹‰ bean å¯¹è±¡åœ¨åˆå§‹åŒ–æˆ–é”€æ¯æ—¶å®Œæˆçš„å·¥ä½œ æ ¼å¼ï¼š 1&lt;bean init-method=&quot;init&quot; destroy-method=&quot;destroy&gt;&lt;/bean&gt; å–å€¼ï¼šbean å¯¹åº”çš„ç±»ä¸­å¯¹åº”çš„å…·ä½“æ–¹æ³•å å®ç°æ¥å£çš„æ–¹å¼å®ç°åˆå§‹åŒ–ï¼Œæ— éœ€é…ç½®æ–‡ä»¶é…ç½® init-methodï¼š å®ç° InitializingBeanï¼Œå®šä¹‰åˆå§‹åŒ–é€»è¾‘ å®ç° DisposableBeanï¼Œå®šä¹‰é”€æ¯é€»è¾‘ æ³¨æ„äº‹é¡¹ï¼š å½“ scope&#x3D;â€œsingletonâ€ æ—¶ï¼ŒSpring å®¹å™¨ä¸­æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå¯¹è±¡ï¼Œinit æ–¹æ³•åœ¨åˆ›å»ºå®¹å™¨æ—¶ä»…æ‰§è¡Œä¸€æ¬¡ å½“ scope&#x3D;â€œprototypeâ€ æ—¶ï¼ŒSpring å®¹å™¨è¦åˆ›å»ºåŒä¸€ç±»å‹çš„å¤šä¸ªå¯¹è±¡ï¼Œinit æ–¹æ³•åœ¨æ¯ä¸ªå¯¹è±¡åˆ›å»ºæ—¶å‡æ‰§è¡Œä¸€æ¬¡ å½“ scope&#x3D;â€œsingletonâ€ æ—¶ï¼Œå…³é—­å®¹å™¨ï¼ˆ.close()ï¼‰ä¼šå¯¼è‡´ bean å®ä¾‹çš„é”€æ¯ï¼Œè°ƒç”¨ destroy æ–¹æ³•ä¸€æ¬¡ å½“ scope&#x3D;â€œprototypeâ€ æ—¶ï¼Œå¯¹è±¡çš„é”€æ¯ç”±åƒåœ¾å›æ”¶æœºåˆ¶ GC æ§åˆ¶ï¼Œdestroy æ–¹æ³•å°†ä¸ä¼šè¢«æ‰§è¡Œ bean é…ç½®ï¼š 12&lt;!--init-methodå’Œdestroy-methodç”¨äºæ§åˆ¶beançš„ç”Ÿå‘½å‘¨æœŸ--&gt;&lt;bean id=&quot;userService3&quot; scope=&quot;prototype&quot; init-method=&quot;init&quot; destroy-method=&quot;destroy&quot; class=&quot;service.impl.UserServiceImpl&quot;/&gt; ä¸šåŠ¡å±‚å®ç°ç±»ï¼š 1234567891011121314151617public class UserServiceImpl implements UserService&#123; public UserServiceImpl()&#123; System.out.println(&quot; constructor is running...&quot;); &#125; public void init()&#123; System.out.println(&quot;init....&quot;); &#125; public void destroy()&#123; System.out.println(&quot;destroy....&quot;); &#125; public void save() &#123; System.out.println(&quot;user service running...&quot;); &#125;&#125; æµ‹è¯•ç±»ï¼š 1UserService userService = (UserService)ctx.getBean(&quot;userService3&quot;); åˆ›å»ºæ–¹å¼ é™æ€å·¥å‚ ä½œç”¨ï¼šå®šä¹‰ bean å¯¹è±¡åˆ›å»ºæ–¹å¼ï¼Œä½¿ç”¨é™æ€å·¥å‚çš„å½¢å¼åˆ›å»º beanï¼Œå…¼å®¹æ—©æœŸé—ç•™ç³»ç»Ÿçš„å‡çº§å·¥ä½œ æ ¼å¼ï¼š 1&lt;bean class=&quot;FactoryClassName&quot; factory-method=&quot;factoryMethodName&quot;&gt;&lt;/bean&gt; å–å€¼ï¼šå·¥å‚ bean ä¸­ç”¨äºè·å–å¯¹è±¡çš„é™æ€æ–¹æ³•å æ³¨æ„äº‹é¡¹ï¼šclass å±æ€§å¿…é¡»é…ç½®æˆé™æ€å·¥å‚çš„ç±»å bean é…ç½®ï¼š 12&lt;!--é™æ€å·¥å‚åˆ›å»º bean--&gt;&lt;bean id=&quot;userService4&quot; class=&quot;service.UserServiceFactory&quot; factory-method=&quot;getService&quot;/&gt; å·¥å‚ç±»ï¼š 123456public class UserServiceFactory &#123; public static UserService getService()&#123; System.out.println(&quot;factory create object...&quot;); return new UserServiceImpl(); &#125;&#125; æµ‹è¯•ç±»ï¼š 1UserService userService = (UserService)ctx.getBean(&quot;userService4&quot;); å®ä¾‹å·¥å‚ ä½œç”¨ï¼šå®šä¹‰ bean å¯¹è±¡åˆ›å»ºæ–¹å¼ï¼Œä½¿ç”¨å®ä¾‹å·¥å‚çš„å½¢å¼åˆ›å»º beanï¼Œå…¼å®¹æ—©æœŸé—ç•™ç³»ç»Ÿçš„å‡çº§å·¥ä½œ æ ¼å¼ï¼š 1&lt;bean factory-bean=&quot;factoryBeanId&quot; factory-method=&quot;factoryMethodName&quot;&gt;&lt;/bean&gt; æ³¨æ„äº‹é¡¹ï¼š ä½¿ç”¨å®ä¾‹å·¥å‚åˆ›å»º bean é¦–å…ˆéœ€è¦å°†å®ä¾‹å·¥å‚é…ç½® beanï¼Œäº¤ç”± Spring è¿›è¡Œç®¡ç† factory-bean æ˜¯å®ä¾‹å·¥å‚çš„ Id bean é…ç½®ï¼š 123&lt;!--å®ä¾‹å·¥å‚åˆ›å»º beanï¼Œä¾èµ–å·¥å‚å¯¹è±¡å¯¹åº”çš„ bean--&gt;&lt;bean id=&quot;factoryBean&quot; class=&quot;service.UserServiceFactory2&quot;/&gt;&lt;bean id=&quot;userService5&quot; factory-bean=&quot;factoryBean&quot; factory-method=&quot;getService&quot;/&gt; å·¥å‚ç±»ï¼š 123456public class UserServiceFactory2 &#123; public UserService getService()&#123; System.out.println(&quot; instance factory create object...&quot;); return new UserServiceImpl(); &#125;&#125; è·å–BeanApplicationContext å­ç±»ç›¸å…³APIï¼š æ–¹æ³• è¯´æ˜ String[] getBeanDefinitionNames() è·å– Spring å®¹å™¨ä¸­å®šä¹‰çš„æ‰€æœ‰ JavaBean çš„åç§° BeanDefinition getBeanDefinition(String beanName) è¿”å›ç»™å®š bean åç§°çš„ BeanDefinition String[] getBeanNamesForType(Class&lt;?&gt; type) è·å– Spring å®¹å™¨ä¸­æŒ‡å®šç±»å‹çš„æ‰€æœ‰ JavaBean çš„åç§° Environment getEnvironment() è·å–ä¸æ­¤ç»„ä»¶å…³è”çš„ç¯å¢ƒ DIä¾èµ–æ³¨å…¥ IoCï¼ˆInversion Of Controlï¼‰æ§åˆ¶ç¿»è½¬ï¼ŒSpring åå‘æ§åˆ¶åº”ç”¨ç¨‹åºæ‰€éœ€è¦ä½¿ç”¨çš„å¤–éƒ¨èµ„æº DIï¼ˆDependency Injectionï¼‰ä¾èµ–æ³¨å…¥ï¼Œåº”ç”¨ç¨‹åºè¿è¡Œä¾èµ–çš„èµ„æºç”± Spring ä¸ºå…¶æä¾›ï¼Œèµ„æºè¿›å…¥åº”ç”¨ç¨‹åºçš„æ–¹å¼ç§°ä¸ºæ³¨å…¥ï¼Œç®€å•è¯´å°±æ˜¯åˆ©ç”¨åå°„æœºåˆ¶ä¸ºç±»çš„å±æ€§èµ‹å€¼çš„æ“ä½œ IoC å’Œ DI çš„å…³ç³»ï¼šIoC ä¸ DI æ˜¯åŒä¸€ä»¶äº‹ç«™åœ¨ä¸åŒè§’åº¦çœ‹å¾…é—®é¢˜ set æ³¨å…¥æ ‡ç­¾ï¼š æ ‡ç­¾ï¼Œ çš„å­æ ‡ç­¾ ä½œç”¨ï¼šä½¿ç”¨ set æ–¹æ³•çš„å½¢å¼ä¸º bean æä¾›èµ„æº æ ¼å¼ï¼š 12345&lt;bean&gt; &lt;property /&gt; &lt;property /&gt; .....&lt;/bean&gt; åŸºæœ¬å±æ€§ï¼š nameï¼šå¯¹åº” bean ä¸­çš„å±æ€§åï¼Œè¦æ³¨å…¥çš„å˜é‡åï¼Œè¦æ±‚è¯¥å±æ€§å¿…é¡»æä¾›å¯è®¿é—®çš„ set æ–¹æ³•ï¼ˆä¸¥æ ¼è§„èŒƒæ­¤åç§°æ˜¯ set æ–¹æ³•å¯¹åº”åç§°ï¼Œé¦–å­—æ¯å¿…é¡»å°å†™ï¼‰ valueï¼šè®¾å®šéå¼•ç”¨ç±»å‹å±æ€§å¯¹åº”çš„å€¼ï¼Œä¸èƒ½ä¸ ref åŒæ—¶ä½¿ç”¨ refï¼šè®¾å®šå¼•ç”¨ç±»å‹å±æ€§å¯¹åº” bean çš„ id ï¼Œä¸èƒ½ä¸ value åŒæ—¶ä½¿ç”¨ 1&lt;property name=&quot;propertyName&quot; value=&quot;propertyValue&quot; ref=&quot;beanId&quot;/&gt; ä»£ç å®ç°ï¼š DAO å±‚ï¼šè¦æ³¨å…¥çš„èµ„æº 123public interface UserDao &#123; public void save();&#125; 12345public class UserDaoImpl implements UserDao&#123; public void save()&#123; System.out.println(&quot;user dao running...&quot;); &#125;&#125; Service ä¸šåŠ¡å±‚ 123public interface UserService &#123; public void save();&#125; 12345678910111213141516171819public class UserServiceImpl implements UserService &#123; private UserDao userDao; private int num; //1.å¯¹éœ€è¦è¿›è¡Œæ³¨å…¥çš„å˜é‡æ·»åŠ setæ–¹æ³• public void setUserDao(UserDao userDao) &#123; this.userDao = userDao; &#125; public void setNum(int num) &#123; this.num = num; &#125; public void save() &#123; System.out.println(&quot;user service running...&quot; + num); userDao.save(); bookDao.save(); &#125;&#125; é…ç½® applicationContext.xml 12345678&lt;!--2.å°†è¦æ³¨å…¥çš„èµ„æºå£°æ˜ä¸ºbean--&gt;&lt;bean id=&quot;userDao&quot; class=&quot;dao.impl.UserDaoImpl&quot;/&gt;&lt;bean id=&quot;userService&quot; class=&quot;service.impl.UserServiceImpl&quot;&gt; &lt;!--3.å°†è¦æ³¨å…¥çš„å¼•ç”¨ç±»å‹çš„å˜é‡é€šè¿‡propertyå±æ€§è¿›è¡Œæ³¨å…¥ï¼Œ--&gt; &lt;property name=&quot;userDao&quot; ref=&quot;userDao&quot;/&gt; &lt;property name=&quot;num&quot; value=&quot;666&quot;/&gt;&lt;/bean&gt; æµ‹è¯•ç±» 1234567public class UserApp &#123; public static void main(String[] args) &#123; ApplicationContext ctx = new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;); UserService userService = (UserService) ctx.getBean(&quot;userService&quot;); userService.save(); &#125;&#125; æ„é€ æ³¨å…¥æ ‡ç­¾ï¼š æ ‡ç­¾ï¼Œ çš„å­æ ‡ç­¾ ä½œç”¨ï¼šä½¿ç”¨æ„é€ æ–¹æ³•çš„å½¢å¼ä¸º bean æä¾›èµ„æºï¼Œå…¼å®¹æ—©æœŸé—ç•™ç³»ç»Ÿçš„å‡çº§å·¥ä½œ æ ¼å¼ï¼š 1234&lt;bean&gt; &lt;constructor-arg /&gt; .....&lt;!--ä¸€ä¸ªbeanå¯ä»¥æœ‰å¤šä¸ªconstructor-argæ ‡ç­¾--&gt;&lt;/bean&gt; å±æ€§ï¼š nameï¼šå¯¹åº”beanä¸­çš„æ„é€ æ–¹æ³•æ‰€æºå¸¦çš„å‚æ•°å valueï¼šè®¾å®šéå¼•ç”¨ç±»å‹æ„é€ æ–¹æ³•å‚æ•°å¯¹åº”çš„å€¼ï¼Œä¸èƒ½ä¸ ref åŒæ—¶ä½¿ç”¨ refï¼šè®¾å®šå¼•ç”¨ç±»å‹æ„é€ æ–¹æ³•å‚æ•°å¯¹åº” bean çš„ id ï¼Œä¸èƒ½ä¸ value åŒæ—¶ä½¿ç”¨ typeï¼šè®¾å®šæ„é€ æ–¹æ³•å‚æ•°çš„ç±»å‹ï¼Œç”¨äºæŒ‰ç±»å‹åŒ¹é…å‚æ•°æˆ–è¿›è¡Œç±»å‹æ ¡éªŒ indexï¼šè®¾å®šæ„é€ æ–¹æ³•å‚æ•°çš„ä½ç½®ï¼Œç”¨äºæŒ‰ä½ç½®åŒ¹é…å‚æ•°ï¼Œå‚æ•° index å€¼ä» 0 å¼€å§‹è®¡æ•° 12&lt;constructor-arg name=&quot;argsName&quot; value=&quot;argsValue&quot; /&gt;&lt;constructor-arg index=&quot;arg-index&quot; type=&quot;arg-type&quot; ref=&quot;beanId&quot;/&gt; ä»£ç å®ç°ï¼š DAO å±‚ï¼šè¦æ³¨å…¥çš„èµ„æº 1234567891011121314public class UserDaoImpl implements UserDao&#123; private String username; private String pwd; private String driver; public UserDaoImpl(String driver,String username, String pwd) &#123; this.driver = driver; this.username = username; this.pwd = pwd; &#125; public void save()&#123; System.out.println(&quot;user dao running...&quot;+username+&quot; &quot;+pwd+&quot; &quot;+driver); &#125;&#125; Service ä¸šåŠ¡å±‚ï¼šå‚è€ƒ set æ³¨å…¥ é…ç½® applicationContext.xml 123456789101112&lt;bean id=&quot;userDao&quot; class=&quot;dao.impl.UserDaoImpl&quot;&gt; &lt;!--ä½¿ç”¨æ„é€ æ–¹æ³•è¿›è¡Œæ³¨å…¥ï¼Œéœ€è¦ä¿éšœæ³¨å…¥çš„å±æ€§ä¸beanä¸­å®šä¹‰çš„å±æ€§ä¸€è‡´--&gt; &lt;!--ä¸€è‡´æŒ‡é¡ºåºä¸€è‡´æˆ–ç±»å‹ä¸€è‡´æˆ–ä½¿ç”¨indexè§£å†³è¯¥é—®é¢˜--&gt; &lt;constructor-arg index=&quot;2&quot; value=&quot;123&quot;/&gt; &lt;constructor-arg index=&quot;1&quot; value=&quot;root&quot;/&gt; &lt;constructor-arg index=&quot;0&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt;&lt;/bean&gt;&lt;bean id=&quot;userService&quot; class=&quot;service.impl.UserServiceImpl&quot;&gt; &lt;property name=&quot;userDao&quot; ref=&quot;userDao&quot;/&gt; &lt;property name=&quot;num&quot; value=&quot;666&quot;/&gt;&lt;/bean&gt; æ–¹å¼äºŒï¼šä½¿ç”¨ UserServiceImpl çš„æ„é€ æ–¹æ³•æ³¨å…¥ 1234&lt;bean id=&quot;userService&quot; class=&quot;service.impl.UserServiceImpl&quot;&gt; &lt;constructor-arg name=&quot;userDao&quot; ref=&quot;userDao&quot;/&gt; &lt;constructor-arg name=&quot;num&quot; value=&quot;666666&quot;/&gt;&lt;/bean&gt; æµ‹è¯•ç±»ï¼šå‚è€ƒ set æ³¨å…¥ é›†åˆæ³¨å…¥æ ‡ç­¾ï¼š ï¼Œ æˆ– æ ‡ç­¾çš„å­æ ‡ç­¾ ä½œç”¨ï¼šæ³¨å…¥é›†åˆæ•°æ®ç±»å‹å±æ€§ æ ¼å¼ï¼š 123&lt;property&gt; &lt;list&gt;&lt;/list&gt;&lt;/property&gt; ä»£ç å®ç°ï¼š DAO å±‚ï¼šè¦æ³¨å…¥çš„èµ„æº 123public interface BookDao &#123; public void save();&#125; 1234567891011121314151617181920212223242526272829303132333435363738public class BookDaoImpl implements BookDao &#123; private ArrayList al; private Properties properties; private int[] arr; private HashSet hs; private HashMap hm ; public void setAl(ArrayList al) &#123; this.al = al; &#125; public void setProperties(Properties properties) &#123; this.properties = properties; &#125; public void setArr(int[] arr) &#123; this.arr = arr; &#125; public void setHs(HashSet hs) &#123; this.hs = hs; &#125; public void setHm(HashMap hm) &#123; this.hm = hm; &#125; public void save() &#123; System.out.println(&quot;book dao running...&quot;); System.out.println(&quot;ArrayList:&quot; + al); System.out.println(&quot;Properties:&quot; + properties); for (int i = 0; i &lt; arr.length; i++) &#123; System.out.println(arr[i]); &#125; System.out.println(&quot;HashSet:&quot; + hs); System.out.println(&quot;HashMap:&quot; + hm); &#125;&#125; Service ä¸šåŠ¡å±‚ 1234567891011121314public class UserServiceImpl implements UserService &#123; private BookDao bookDao; public UserServiceImpl() &#123;&#125; public void setBookDao(BookDao bookDao) &#123; this.bookDao = bookDao; &#125; public void save() &#123; System.out.println(&quot;user service running...&quot; + num); bookDao.save(); &#125;&#125; é…ç½® applicationContext.xml 123456789101112131415161718192021222324252627282930313233343536&lt;bean id=&quot;userService&quot; class=&quot;service.impl.UserServiceImpl&quot;&gt; &lt;property name=&quot;bookDao&quot; ref=&quot;bookDao&quot;/&gt;&lt;/bean&gt;&lt;bean id=&quot;bookDao&quot; class=&quot;dao.impl.BookDaoImpl&quot;&gt; &lt;property name=&quot;al&quot;&gt; &lt;list&gt; &lt;value&gt;seazean&lt;/value&gt; &lt;value&gt;66666&lt;/value&gt; &lt;/list&gt; &lt;/property&gt; &lt;property name=&quot;properties&quot;&gt; &lt;props&gt; &lt;prop key=&quot;name&quot;&gt;seazean666&lt;/prop&gt; &lt;prop key=&quot;value&quot;&gt;666666&lt;/prop&gt; &lt;/props&gt; &lt;/property&gt; &lt;property name=&quot;arr&quot;&gt; &lt;array&gt; &lt;value&gt;123456&lt;/value&gt; &lt;value&gt;66666&lt;/value&gt; &lt;/array&gt; &lt;/property&gt; &lt;property name=&quot;hs&quot;&gt; &lt;set&gt; &lt;value&gt;seazean&lt;/value&gt; &lt;value&gt;66666&lt;/value&gt; &lt;/set&gt; &lt;/property&gt; &lt;property name=&quot;hm&quot;&gt; &lt;map&gt; &lt;entry key=&quot;name&quot; value=&quot;seazean66666&quot;/&gt; &lt;entry key=&quot;value&quot; value=&quot;6666666666&quot;/&gt; &lt;/map&gt; &lt;/property&gt;&lt;/bean&gt; Pæ ‡ç­¾ï¼š&lt;p:propertyName&gt;ï¼Œ&lt;p:propertyName-ref&gt; ä½œç”¨ï¼šä¸º bean æ³¨å…¥å±æ€§å€¼ æ ¼å¼ï¼š 1&lt;bean p:propertyName=&quot;propertyValue&quot; p:propertyName-ref=&quot;beanId&quot;/&gt; å¼€å¯ p å‘½ä»¤ç©ºé—´ï¼šå¼€å¯ Spring å¯¹ p å‘½ä»¤ç©ºé—´çš„çš„æ”¯æŒï¼Œåœ¨ beans æ ‡ç­¾ä¸­æ·»åŠ å¯¹åº”ç©ºé—´æ”¯æŒ 1234567&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:p=&quot;http://www.springframework.org/schema/p&quot; xsi:schemaLocation=&quot; http://www.springframework.org/schema/beans https://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;&lt;/beans&gt; å®ä¾‹ï¼š 1234567&lt;bean id=&quot;userService&quot; class=&quot;service.impl.UserServiceImpl&quot; p:userDao-ref=&quot;userDao&quot; p:bookDao-ref=&quot;bookDao&quot; p:num=&quot;10&quot; /&gt; SpELSpring æä¾›äº†å¯¹ EL è¡¨è¾¾å¼çš„æ”¯æŒï¼Œç»Ÿä¸€å±æ€§æ³¨å…¥æ ¼å¼ ä½œç”¨ï¼šä¸º bean æ³¨å…¥å±æ€§å€¼ æ ¼å¼ï¼š 1&lt;property value=&quot;EL&quot;&gt; æ³¨æ„ï¼šæ‰€æœ‰å±æ€§å€¼ä¸åŒºåˆ†æ˜¯å¦å¼•ç”¨ç±»å‹ï¼Œç»Ÿä¸€ä½¿ç”¨valueèµ‹å€¼ æ‰€æœ‰æ ¼å¼ç»Ÿä¸€ä½¿ç”¨ value&#x3D;â€œ#{}â€ å¸¸é‡ #{10} #{3.14} #{2e5} #{â€˜itâ€™} å¼•ç”¨ bean #{beanId} å¼•ç”¨ bean å±æ€§ #{beanId.propertyName} å¼•ç”¨ bean æ–¹æ³• beanId.methodName().method2() å¼•ç”¨é™æ€æ–¹æ³• T(java.lang.Math).PI è¿ç®—ç¬¦æ”¯æŒ #{3 lt 4 &#x3D;&#x3D; 4 ge 3} æ­£åˆ™è¡¨è¾¾å¼æ”¯æŒ #{user.name matchesâ€˜[a-z]{6,}â€™} é›†åˆæ”¯æŒ #{likes[3]} å®ä¾‹ï¼š 12345&lt;bean id=&quot;userService&quot; class=&quot;service.impl.UserServiceImpl&quot;&gt; &lt;property name=&quot;userDao&quot; value=&quot;#&#123;userDao&#125;&quot;/&gt; &lt;property name=&quot;bookDao&quot; value=&quot;#&#123;bookDao&#125;&quot;/&gt; &lt;property name=&quot;num&quot; value=&quot;#&#123;666666666&#125;&quot;/&gt; &lt;/bean&gt; propSpring æä¾›äº†è¯»å–å¤–éƒ¨ properties æ–‡ä»¶çš„æœºåˆ¶ï¼Œä½¿ç”¨è¯»å–åˆ°çš„æ•°æ®ä¸º bean çš„å±æ€§èµ‹å€¼ æ“ä½œæ­¥éª¤ï¼š å‡†å¤‡å¤–éƒ¨ properties æ–‡ä»¶ å¼€å¯ context å‘½åç©ºé—´æ”¯æŒ 12345678910&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:context=&quot;http://www.springframework.org/schema/context&quot; xsi:schemaLocation=&quot; http://www.springframework.org/schema/beans https://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd &quot;&gt; åŠ è½½æŒ‡å®šçš„ properties æ–‡ä»¶ 1&lt;context:property-placeholder location=&quot;classpath:data.properties&quot; /&gt; ä½¿ç”¨åŠ è½½çš„æ•°æ® 1&lt;property name=&quot;propertyName&quot; value=&quot;$&#123;propertiesName&#125;&quot;/&gt; æ³¨æ„ï¼šå¦‚æœéœ€è¦åŠ è½½æ‰€æœ‰çš„ properties æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ *.properties è¡¨ç¤ºåŠ è½½æ‰€æœ‰çš„ properties æ–‡ä»¶ æ³¨æ„ï¼šè¯»å–æ•°æ®ä½¿ç”¨ ${propertiesName} æ ¼å¼è¿›è¡Œï¼Œå…¶ä¸­ propertiesName æŒ‡ properties æ–‡ä»¶ä¸­çš„å±æ€§å ä»£ç å®ç°ï¼š data.properties 12username=rootpwd=123456 DAO å±‚ï¼šæ³¨å…¥çš„èµ„æº 123public interface UserDao &#123; public void save();&#125; 123456789101112131415public class UserDaoImpl implements UserDao&#123; private String userName; private String password; public void setUserName(String userName) &#123; this.userName = userName; &#125; public void setPassword(String password) &#123; this.password = password; &#125; public void save()&#123; System.out.println(&quot;user dao running...&quot;+userName+&quot; &quot;+password); &#125;&#125; Service ä¸šåŠ¡å±‚ 12345678910public class UserServiceImpl implements UserService &#123; private UserDao userDao; public void setUserDao(UserDao userDao) &#123; this.userDao = userDao; &#125; public void save() &#123; System.out.println(&quot;user service running...&quot;); userDao.save(); &#125;&#125; applicationContext.xml 12345678910&lt;context:property-placeholder location=&quot;classpath:*.properties&quot;/&gt;&lt;bean id=&quot;userDao&quot; class=&quot;dao.impl.UserDaoImpl&quot;&gt; &lt;property name=&quot;userName&quot; value=&quot;$&#123;username&#125;&quot;/&gt; &lt;property name=&quot;password&quot; value=&quot;$&#123;pwd&#125;&quot;/&gt;&lt;/bean&gt;&lt;bean id=&quot;userService&quot; class=&quot;service.impl.UserServiceImpl&quot;&gt; &lt;property name=&quot;userDao&quot; ref=&quot;userDao&quot;/&gt;&lt;/bean&gt; æµ‹è¯•ç±» 1234567public class UserApp &#123; public static void main(String[] args) &#123; ApplicationContext ctx = new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;); UserService userService = (UserService) ctx.getBean(&quot;userService&quot;); userService.save(); &#125;&#125; importæ ‡ç­¾ï¼šï¼Œæ ‡ç­¾çš„å­æ ‡ç­¾ ä½œç”¨ï¼šåœ¨å½“å‰é…ç½®æ–‡ä»¶ä¸­å¯¼å…¥å…¶ä»–é…ç½®æ–‡ä»¶ä¸­çš„é¡¹ æ ¼å¼ï¼š 123&lt;beans&gt; &lt;import /&gt;&lt;/beans&gt; å±æ€§ï¼š resourceï¼šåŠ è½½çš„é…ç½®æ–‡ä»¶å 1&lt;import resource=â€œconfig2.xml&quot;/&gt; Spring å®¹å™¨åŠ è½½å¤šä¸ªé…ç½®æ–‡ä»¶ï¼š applicationContext-book.xml 123&lt;bean id=&quot;bookDao&quot; class=&quot;dao.impl.BookDaoImpl&quot;&gt; &lt;property name=&quot;num&quot; value=&quot;1&quot;/&gt;&lt;/bean&gt; applicationContext-user.xml 123456789&lt;bean id=&quot;userDao&quot; class=&quot;dao.impl.UserDaoImpl&quot;&gt; &lt;property name=&quot;userName&quot; value=&quot;$&#123;username&#125;&quot;/&gt; &lt;property name=&quot;password&quot; value=&quot;$&#123;pwd&#125;&quot;/&gt;&lt;/bean&gt;&lt;bean id=&quot;userService&quot; class=&quot;service.impl.UserServiceImpl&quot;&gt; &lt;property name=&quot;userDao&quot; ref=&quot;userDao&quot;/&gt; &lt;property name=&quot;bookDao&quot; ref=&quot;bookDao&quot;/&gt;&lt;/bean&gt; applicationContext.xml 123456&lt;import resource=&quot;applicationContext-user.xml&quot;/&gt;&lt;import resource=&quot;applicationContext-book.xml&quot;/&gt;&lt;bean id=&quot;bookDao&quot; class=&quot;com.seazean.dao.impl.BookDaoImpl&quot;&gt; &lt;property name=&quot;num&quot; value=&quot;2&quot;/&gt;&lt;/bean&gt; æµ‹è¯•ç±» 12new ClassPathXmlApplicationContext(&quot;applicationContext-user.xml&quot;,&quot;applicationContext-book.xml&quot;);new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;); Spring å®¹å™¨ä¸­çš„ bean å®šä¹‰å†²çªé—®é¢˜ åŒ id çš„ beanï¼Œåå®šä¹‰çš„è¦†ç›–å…ˆå®šä¹‰çš„ å¯¼å…¥é…ç½®æ–‡ä»¶å¯ä»¥ç†è§£ä¸ºå°†å¯¼å…¥çš„é…ç½®æ–‡ä»¶å¤åˆ¶ç²˜è´´åˆ°å¯¹åº”ä½ç½®ï¼Œç¨‹åºæ‰§è¡Œé€‰æ‹©æœ€ä¸‹é¢çš„é…ç½®ä½¿ç”¨ å¯¼å…¥é…ç½®æ–‡ä»¶çš„é¡ºåºä¸ä½ç½®ä¸åŒå¯èƒ½ä¼šå¯¼è‡´æœ€ç»ˆç¨‹åºè¿è¡Œç»“æœä¸åŒ ä¸‰æ–¹èµ„æºDruidç¬¬ä¸‰æ–¹èµ„æºé…ç½® pom.xml 12345&lt;dependency&gt; &lt;groupId&gt;com.alibaba&lt;/groupId&gt; &lt;artifactId&gt;druid&lt;/artifactId&gt; &lt;version&gt;1.1.16&lt;/version&gt;&lt;/dependency&gt; applicationContext.xml 1234567&lt;!--åŠ è½½druidèµ„æº--&gt;&lt;bean id=&quot;dataSource&quot; class=&quot;com.alibaba.druid.pool.DruidDataSource&quot;&gt; &lt;property name=&quot;driverClassName&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt; &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://192.168.2.185:3306/spring_db&quot;/&gt; &lt;property name=&quot;username&quot; value=&quot;root&quot;/&gt; &lt;property name=&quot;password&quot; value=&quot;123456&quot;/&gt;&lt;/bean&gt; App.java 123ApplicationContext ctx = new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;);DruidDataSource datasource = (DruidDataSource) ctx.getBean(&quot;datasource&quot;);System.out.println(datasource); MybatisMybatis æ ¸å¿ƒé…ç½®æ–‡ä»¶æ¶ˆå¤± ç¯å¢ƒ environment è½¬æ¢æˆæ•°æ®æºå¯¹è±¡ æ˜ å°„ Mapper æ‰«æå·¥ä½œäº¤ç”± Spring å¤„ç† ç±»å‹åˆ«åäº¤ç”± Spring å¤„ç† DAO æ¥å£ä¸éœ€è¦åˆ›å»ºå®ç°ç±»ï¼ŒMyBatis-Spring æä¾›äº†ä¸€ä¸ªåŠ¨æ€ä»£ç†çš„å®ç° MapperFactoryBeanï¼Œè¿™ä¸ªç±»å¯ä»¥è®©ç›´æ¥æ³¨å…¥æ•°æ®æ˜ å°„å™¨æ¥å£åˆ° service å±‚ bean ä¸­ï¼Œåº•å±‚å°†ä¼šåŠ¨æ€ä»£ç†åˆ›å»ºç±» æ•´åˆåŸç†ï¼šåˆ©ç”¨ Spring æ¡†æ¶çš„ SPI æœºåˆ¶ï¼Œåœ¨ META-INF ç›®å½•çš„ spring.handlers ä¸­ç»™ Spring å®¹å™¨ä¸­å¯¼å…¥ NamespaceHandler ç±» NamespaceHandler çš„ init æ–¹æ³•æ³¨å†Œ bean ä¿¡æ¯çš„è§£æå™¨ MapperScannerBeanDefinitionParser è§£æå™¨åœ¨ Spring å®¹å™¨åˆ›å»ºè¿‡ç¨‹ä¸­å»è§£æ mapperScanner æ ‡ç­¾ï¼Œè§£æå‡ºçš„å±æ€§å¡«å……åˆ° MapperScannerConfigurer ä¸­ MapperScannerConfigurer å®ç°äº† BeanDefinitionRegistryPostProcessor æ¥å£ï¼Œé‡å†™ postProcessBeanDefinitionRegistry() æ–¹æ³•ï¼Œå¯ä»¥æ‰«æåˆ° MyBatis çš„ Mapper æ³¨è§£å¼€å‘æ³¨è§£é©±åŠ¨XMLå¯åŠ¨æ³¨è§£æ‰«æï¼ŒåŠ è½½ç±»ä¸­é…ç½®çš„æ³¨è§£é¡¹ï¼š 1&lt;context:component-scan base-package=&quot;packageName1,packageName2&quot;/&gt; è¯´æ˜ï¼š åœ¨è¿›è¡ŒåŒ…æ‰«ææ—¶ï¼Œä¼šå¯¹é…ç½®çš„åŒ…åŠå…¶å­åŒ…ä¸­æ‰€æœ‰æ–‡ä»¶è¿›è¡Œæ‰«æï¼Œå¤šä¸ªåŒ…é‡‡ç”¨,éš”å¼€ æ‰«æè¿‡ç¨‹æ˜¯ä»¥æ–‡ä»¶å¤¹é€’å½’è¿­ä»£çš„å½¢å¼è¿›è¡Œçš„ æ‰«æè¿‡ç¨‹ä»…è¯»å–åˆæ³•çš„ Java æ–‡ä»¶ æ‰«ææ—¶ä»…è¯»å– Spring å¯è¯†åˆ«çš„æ³¨è§£ æ‰«æç»“æŸåä¼šå°†å¯è¯†åˆ«çš„æœ‰æ•ˆæ³¨è§£è½¬åŒ–ä¸º Spring å¯¹åº”çš„èµ„æºåŠ å…¥ IoC å®¹å™¨ ä»åŠ è½½æ•ˆç‡ä¸Šæ¥è¯´æ³¨è§£ä¼˜äº XML é…ç½®æ–‡ä»¶ æ³¨è§£ï¼šå¯åŠ¨æ—¶ä½¿ç”¨æ³¨è§£çš„å½¢å¼æ›¿ä»£ xml é…ç½®ï¼Œå°† Spring é…ç½®æ–‡ä»¶ä»å·¥ç¨‹ä¸­æ¶ˆé™¤ï¼Œç®€åŒ–ä¹¦å†™ ç¼ºç‚¹ï¼šä¸ºäº†è¾¾æˆæ³¨è§£é©±åŠ¨çš„ç›®çš„ï¼Œå¯èƒ½ä¼šå°†åŸå…ˆå¾ˆç®€å•çš„ä¹¦å†™ï¼Œå˜çš„æ›´åŠ å¤æ‚ã€‚XML ä¸­é…ç½®ç¬¬ä¸‰æ–¹å¼€å‘çš„èµ„æºæ˜¯å¾ˆæ–¹ä¾¿çš„ï¼Œä½†ä½¿ç”¨æ³¨è§£é©±åŠ¨æ— æ³•åœ¨ç¬¬ä¸‰æ–¹å¼€å‘çš„èµ„æºä¸­è¿›è¡Œç¼–è¾‘ï¼Œå› æ­¤ä¼šå¢å¤§å¼€å‘å·¥ä½œé‡ çº¯æ³¨è§£æ³¨è§£é…ç½®ç±» åç§°ï¼š@Configurationã€@ComponentScan ç±»å‹ï¼šç±»æ³¨è§£ ä½œç”¨ï¼šè®¾ç½®å½“å‰ç±»ä¸º Spring æ ¸å¿ƒé…ç½®åŠ è½½ç±» æ ¼å¼ï¼š 1234@Configuration@ComponentScan(&#123;&quot;scanPackageName1&quot;,&quot;scanPackageName2&quot;&#125;)public class SpringConfigClassName&#123;&#125; è¯´æ˜ï¼š æ ¸å¿ƒé…åˆç±»ç”¨äºæ›¿æ¢ Spring æ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼Œæ­¤ç±»å¯ä»¥è®¾ç½®ç©ºçš„ï¼Œä¸è®¾ç½®å˜é‡ä¸å±æ€§ bean æ‰«æå·¥ä½œä½¿ç”¨æ³¨è§£ @ComponentScan æ›¿ä»£ï¼Œå¤šä¸ªåŒ…ç”¨ &#123;&#125; å’Œ , éš”å¼€ åŠ è½½çº¯æ³¨è§£æ ¼å¼ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œéœ€è¦ä½¿ç”¨ AnnotationConfigApplicationContext 12345678910111213141516171819202122@Configurationpublic class SpringConfig &#123; @Bean public Person person() &#123; return new Person1(&quot;lisi&quot;, 20); &#125;&#125;public class MainTest &#123; public static void main(String[] args) &#123; ApplicationContext applicationContext = new AnnotationConfigApplicationContext(SpringConfig.class); //æ–¹å¼ä¸€ï¼šåç§°å¯¹åº”ç±»å Person bean = applicationContext.getBean(Person.class); System.out.println(bean); //æ–¹å¼äºŒï¼šåç§°å¯¹åº”æ–¹æ³•å Person bean1 = (Person) applicationContext.getBean(&quot;person1&quot;); //æ–¹æ³•ä¸‰ï¼šæŒ‡å®šåç§°@Bean(&quot;person2&quot;) &#125;&#125; æ‰«æå™¨ç»„ä»¶æ‰«æè¿‡æ»¤å™¨ å¼€å‘è¿‡ç¨‹ä¸­ï¼Œéœ€è¦æ ¹æ®éœ€æ±‚åŠ è½½å¿…è¦çš„ beanï¼Œæ’é™¤æŒ‡å®š bean åç§°ï¼š@ComponentScan ç±»å‹ï¼šç±»æ³¨è§£ ä½œç”¨ï¼šè®¾ç½® Spring é…ç½®åŠ è½½ç±»æ‰«æè§„åˆ™ æ ¼å¼ï¼š 12345678@ComponentScan( value = &#123;&quot;dao&quot;,&quot;service&quot;&#125;, //è®¾ç½®åŸºç¡€æ‰«æè·¯å¾„ excludeFilters = //è®¾ç½®è¿‡æ»¤è§„åˆ™ï¼Œå½“å‰ä¸ºæ’é™¤è¿‡æ»¤ @ComponentScan.Filter( //è®¾ç½®è¿‡æ»¤å™¨ type= FilterType.ANNOTATION, //è®¾ç½®è¿‡æ»¤æ–¹å¼ä¸ºæŒ‰ç…§æ³¨è§£è¿›è¡Œè¿‡æ»¤ classes = Service.class) //è®¾ç½®å…·ä½“çš„è¿‡æ»¤é¡¹ï¼Œè¿‡æ»¤æ‰€æœ‰@Serviceä¿®é¥°çš„bean )) å±æ€§ï¼š includeFiltersï¼šè®¾ç½®åŒ…å«æ€§è¿‡æ»¤å™¨ excludeFiltersï¼šè®¾ç½®æ’é™¤æ€§è¿‡æ»¤å™¨ typeï¼šè®¾ç½®è¿‡æ»¤å™¨ç±»å‹ åŸºæœ¬æ³¨è§£è®¾ç½® beanåç§°ï¼š@Componentã€@Controllerã€@Serviceã€@Repository ç±»å‹ï¼šç±»æ³¨è§£ï¼Œå†™åœ¨ç±»å®šä¹‰ä¸Šæ–¹ ä½œç”¨ï¼šè®¾ç½®è¯¥ç±»ä¸º Spring ç®¡ç†çš„ bean æ ¼å¼ï¼š 12@Componentpublic class ClassName&#123;&#125; è¯´æ˜ï¼š@Controllerã€@Service ã€@Repository æ˜¯ @Component çš„è¡ç”Ÿæ³¨è§£ï¼ŒåŠŸèƒ½åŒ @Component å±æ€§ï¼š valueï¼ˆé»˜è®¤ï¼‰ï¼šå®šä¹‰ bean çš„è®¿é—® id ä½œç”¨èŒƒå›´åç§°ï¼š@Scope ç±»å‹ï¼šç±»æ³¨è§£ï¼Œå†™åœ¨ç±»å®šä¹‰ä¸Šæ–¹ ä½œç”¨ï¼šè®¾ç½®è¯¥ç±»ä½œä¸º bean å¯¹åº”çš„ scope å±æ€§ æ ¼å¼ï¼š 12@Scopepublic class ClassName&#123;&#125; ç›¸å…³å±æ€§ valueï¼ˆé»˜è®¤ï¼‰ï¼šå®šä¹‰ bean çš„ä½œç”¨åŸŸï¼Œé»˜è®¤ä¸º singletonï¼Œéå•ä¾‹å–å€¼ prototype ç”Ÿå‘½å‘¨æœŸåç§°ï¼š@PostConstructã€@PreDestroy ç±»å‹ï¼šæ–¹æ³•æ³¨è§£ï¼Œå†™åœ¨æ–¹æ³•å®šä¹‰ä¸Šæ–¹ ä½œç”¨ï¼šè®¾ç½®è¯¥ç±»ä½œä¸º bean å¯¹åº”çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³• ç¤ºä¾‹ï¼š 12345678910111213141516//å®šä¹‰beanï¼Œåé¢æ·»åŠ beançš„id@Component(&quot;userService&quot;)//å®šä¹‰beançš„ä½œç”¨åŸŸ@Scope(&quot;singleton&quot;)public class UserServiceImpl implements UserService &#123; //åˆå§‹åŒ– @PostConstruct public void init()&#123; System.out.println(&quot;user service init...&quot;); &#125; //é”€æ¯ @PreDestroy public void destroy()&#123; System.out.println(&quot;user service destroy...&quot;); &#125;&#125; ä¸€ä¸ªå¯¹è±¡çš„æ‰§è¡Œé¡ºåºï¼šConstructor &gt;&gt; @Autowiredï¼ˆæ³¨å…¥å±æ€§ï¼‰ &gt;&gt; @PostConstructï¼ˆåˆå§‹åŒ–é€»è¾‘ï¼‰ åŠ è½½èµ„æºåç§°ï¼š@Bean ç±»å‹ï¼šæ–¹æ³•æ³¨è§£ ä½œç”¨ï¼šè®¾ç½®è¯¥æ–¹æ³•çš„è¿”å›å€¼ä½œä¸º Spring ç®¡ç†çš„ bean æ ¼å¼ï¼š 12@Bean(&quot;dataSource&quot;)public DruidDataSource createDataSource() &#123; return â€¦â€¦; &#125; è¯´æ˜ï¼š å› ä¸ºç¬¬ä¸‰æ–¹ bean æ— æ³•åœ¨å…¶æºç ä¸Šè¿›è¡Œä¿®æ”¹ï¼Œä½¿ç”¨ @Bean è§£å†³ç¬¬ä¸‰æ–¹ bean çš„å¼•å…¥é—®é¢˜ è¯¥æ³¨è§£ç”¨äºæ›¿ä»£ XML é…ç½®ä¸­çš„é™æ€å·¥å‚ä¸å®ä¾‹å·¥å‚åˆ›å»º beanï¼Œä¸åŒºåˆ†æ–¹æ³•æ˜¯å¦ä¸ºé™æ€æˆ–éé™æ€ @Bean æ‰€åœ¨çš„ç±»å¿…é¡»è¢« Spring æ‰«æåŠ è½½ï¼Œå¦åˆ™è¯¥æ³¨è§£æ— æ³•ç”Ÿæ•ˆ ç›¸å…³å±æ€§ valueï¼ˆé»˜è®¤ï¼‰ï¼šå®šä¹‰ bean çš„è®¿é—® id initMethodï¼šå£°æ˜åˆå§‹åŒ–æ–¹æ³• destroyMethodï¼šå£°æ˜é”€æ¯æ–¹æ³• å±æ€§æ³¨å…¥åŸºæœ¬ç±»å‹åç§°ï¼š@Value ç±»å‹ï¼šå±æ€§æ³¨è§£ã€æ–¹æ³•æ³¨è§£ ä½œç”¨ï¼šè®¾ç½®å¯¹åº”å±æ€§çš„å€¼æˆ–å¯¹æ–¹æ³•è¿›è¡Œä¼ å‚ æ ¼å¼ï¼š 123//@Value(&quot;$&#123;jdbc.username&#125;&quot;)@Value(&quot;root&quot;)private String username; è¯´æ˜ï¼š value å€¼ä»…æ”¯æŒéå¼•ç”¨ç±»å‹æ•°æ®ï¼Œèµ‹å€¼æ—¶å¯¹æ–¹æ³•çš„æ‰€æœ‰å‚æ•°å…¨éƒ¨èµ‹å€¼ value å€¼æ”¯æŒè¯»å– properties æ–‡ä»¶ä¸­çš„å±æ€§å€¼ï¼Œé€šè¿‡ç±»å±æ€§å°† properties ä¸­æ•°æ®ä¼ å…¥ç±»ä¸­ value å€¼æ”¯æŒ SpEL @value æ³¨è§£å¦‚æœæ·»åŠ åœ¨å±æ€§ä¸Šæ–¹ï¼Œå¯ä»¥çœç•¥ set æ–¹æ³•ï¼ˆset æ–¹æ³•çš„ç›®çš„æ˜¯ä¸ºå±æ€§èµ‹å€¼ï¼‰ ç›¸å…³å±æ€§ï¼š valueï¼ˆé»˜è®¤ï¼‰ï¼šå®šä¹‰å¯¹åº”çš„å±æ€§å€¼æˆ–å‚æ•°å€¼ è‡ªåŠ¨è£…é…å±æ€§æ³¨å…¥åç§°ï¼š@Autowiredã€@Qualifier ç±»å‹ï¼šå±æ€§æ³¨è§£ã€æ–¹æ³•æ³¨è§£ ä½œç”¨ï¼šè®¾ç½®å¯¹åº”å±æ€§çš„å¯¹è±¡ã€å¯¹æ–¹æ³•è¿›è¡Œå¼•ç”¨ç±»å‹ä¼ å‚ æ ¼å¼ï¼š 123@Autowired(required = false)@Qualifier(&quot;userDao&quot;)private UserDao userDao; è¯´æ˜ï¼š @Autowired é»˜è®¤æŒ‰ç±»å‹è£…é…ï¼ŒæŒ‡å®š @Qualifier åå¯ä»¥æŒ‡å®šè‡ªåŠ¨è£…é…çš„ bean çš„ id ç›¸å…³å±æ€§ï¼š requiredï¼šä¸º true ï¼ˆé»˜è®¤ï¼‰è¡¨ç¤ºæ³¨å…¥ bean æ—¶è¯¥ bean å¿…é¡»å­˜åœ¨ï¼Œä¸ç„¶å°±ä¼šæ³¨å…¥å¤±è´¥æŠ›å‡ºå¼‚å¸¸ï¼›ä¸º false è¡¨ç¤ºæ³¨å…¥æ—¶è¯¥ bean å­˜åœ¨å°±æ³¨å…¥ï¼Œä¸å­˜åœ¨å°±å¿½ç•¥è·³è¿‡ æ³¨æ„ï¼šåœ¨ä½¿ç”¨ @Autowired æ—¶ï¼Œé¦–å…ˆåœ¨å®¹å™¨ä¸­æŸ¥è¯¢å¯¹åº”ç±»å‹çš„ beanï¼Œå¦‚æœæŸ¥è¯¢ç»“æœåˆšå¥½ä¸ºä¸€ä¸ªï¼Œå°±å°†è¯¥ bean è£…é…ç»™ @Autowired æŒ‡å®šçš„æ•°æ®ï¼Œå¦‚æœæŸ¥è¯¢çš„ç»“æœä¸æ­¢ä¸€ä¸ªï¼Œé‚£ä¹ˆ @Autowired ä¼šæ ¹æ®åç§°æ¥æŸ¥æ‰¾ï¼Œå¦‚æœæŸ¥è¯¢çš„ç»“æœä¸ºç©ºï¼Œé‚£ä¹ˆä¼šæŠ›å‡ºå¼‚å¸¸ è§£å†³æ–¹æ³•ï¼šä½¿ç”¨ required &#x3D; false ä¼˜å…ˆæ³¨å…¥åç§°ï¼š@Primary ç±»å‹ï¼šç±»æ³¨è§£ ä½œç”¨ï¼šè®¾ç½®ç±»å¯¹åº”çš„ bean æŒ‰ç±»å‹è£…é…æ—¶ä¼˜å…ˆè£…é… èŒƒä¾‹ï¼š 12@Primarypublic class ClassName&#123;&#125; è¯´æ˜ï¼š @Autowired é»˜è®¤æŒ‰ç±»å‹è£…é…ï¼Œå½“å‡ºç°ç›¸åŒç±»å‹çš„ beanï¼Œä½¿ç”¨ @Primary æé«˜æŒ‰ç±»å‹è‡ªåŠ¨è£…é…çš„ä¼˜å…ˆçº§ï¼Œå¤šä¸ª @Primary ä¼šå¯¼è‡´ä¼˜å…ˆçº§è®¾ç½®æ— æ•ˆ æ³¨è§£å¯¹æ¯”åç§°ï¼š@Injectã€@Namedã€@Resource @Inject ä¸ @Named æ˜¯ JSR330 è§„èŒƒä¸­çš„æ³¨è§£ï¼ŒåŠŸèƒ½ä¸ @Autowired å’Œ @Qualifier å®Œå…¨ç›¸åŒï¼Œé€‚ç”¨äºä¸åŒæ¶æ„åœºæ™¯ @Resource æ˜¯ JSR250 è§„èŒƒä¸­çš„æ³¨è§£ï¼Œå¯ä»¥ç®€åŒ–ä¹¦å†™æ ¼å¼ @Resource ç›¸å…³å±æ€§ nameï¼šè®¾ç½®æ³¨å…¥çš„ bean çš„ id typeï¼šè®¾ç½®æ³¨å…¥çš„ bean çš„ç±»å‹ï¼Œæ¥æ”¶çš„å‚æ•°ä¸º Class ç±»å‹ @Autowired å’Œ @Resourceä¹‹é—´çš„åŒºåˆ«ï¼š @Autowired é»˜è®¤æ˜¯æŒ‰ç…§ç±»å‹è£…é…æ³¨å…¥ï¼Œé»˜è®¤æƒ…å†µä¸‹å®ƒè¦æ±‚ä¾èµ–å¯¹è±¡å¿…é¡»å­˜åœ¨ï¼ˆå¯ä»¥è®¾ç½® required å±æ€§ä¸º falseï¼‰ @Resource é»˜è®¤æŒ‰ç…§åç§°è£…é…æ³¨å…¥ï¼Œåªæœ‰å½“æ‰¾ä¸åˆ°ä¸åç§°åŒ¹é…çš„ bean æ‰ä¼šæŒ‰ç…§ç±»å‹æ¥è£…é…æ³¨å…¥ é™æ€æ³¨å…¥Spring å®¹å™¨ç®¡ç†çš„éƒ½æ˜¯å®ä¾‹å¯¹è±¡ï¼Œ**@Autowired ä¾èµ–æ³¨å…¥çš„éƒ½æ˜¯å®¹å™¨å†…çš„å¯¹è±¡å®ä¾‹**ï¼Œåœ¨ Java ä¸­ static ä¿®é¥°çš„é™æ€å±æ€§ï¼ˆå˜é‡å’Œæ–¹æ³•ï¼‰æ˜¯å±äºç±»çš„ï¼Œè€Œéå±äºå®ä¾‹å¯¹è±¡ å½“ç±»åŠ è½½å™¨åŠ è½½é™æ€å˜é‡æ—¶ï¼ŒSpring ä¸Šä¸‹æ–‡å°šæœªåŠ è½½ï¼Œæ‰€ä»¥ç±»åŠ è½½å™¨ä¸ä¼šåœ¨ Bean ä¸­æ­£ç¡®æ³¨å…¥é™æ€ç±» 1234567891011@Componentpublic class TestClass &#123; @Autowired private static Component component; // è°ƒç”¨é™æ€ç»„ä»¶çš„æ–¹æ³• public static void testMethod() &#123; component.callTestMethod()ï¼› &#125; &#125;// ç¼–è¯‘æ­£å¸¸ï¼Œä½†è¿è¡Œæ—¶æŠ¥java.lang.NullPointerExceptionï¼Œæ‰€ä»¥åœ¨è°ƒç”¨testMethod()æ–¹æ³•æ—¶ï¼Œcomponentå˜é‡è¿˜æ²¡è¢«åˆå§‹åŒ– è§£å†³æ–¹æ³•ï¼š @Autowired æ³¨è§£åˆ°ç±»çš„æ„é€ å‡½æ•°ä¸Šï¼ŒSpring æ‰«æåˆ° Component çš„ Beanï¼Œç„¶åèµ‹ç»™é™æ€å˜é‡ component 12345678910111213@Componentpublic class TestClass &#123; private static Component component; @Autowired public TestClass(Component component) &#123; TestClass.component = component; &#125; public static void testMethod() &#123; component.callTestMethod()ï¼› &#125;&#125; @Autowired æ³¨è§£åˆ°é™æ€å±æ€§çš„ setter æ–¹æ³•ä¸Š ä½¿ç”¨ @PostConstruct æ³¨è§£ä¸€ä¸ªæ–¹æ³•ï¼Œåœ¨æ–¹æ³•å†…ä¸º static é™æ€æˆå‘˜èµ‹å€¼ ä½¿ç”¨ Spring æ¡†æ¶å·¥å…·ç±»è·å– beanï¼Œå®šä¹‰æˆå±€éƒ¨å˜é‡ä½¿ç”¨ 1234567public class TestClass &#123; // è°ƒç”¨é™æ€ç»„ä»¶çš„æ–¹æ³• public static void testMethod() &#123; Component component = SpringApplicationContextUtil.getBean(&quot;component&quot;); component.callTestMethod(); &#125;&#125; å‚è€ƒæ–‡ç« ï¼šhttp://jessehzx.top/2018/03/18/spring-autowired-static-field/ æ–‡ä»¶è¯»å–åç§°ï¼š@PropertySource ç±»å‹ï¼šç±»æ³¨è§£ ä½œç”¨ï¼šåŠ è½½ properties æ–‡ä»¶ä¸­çš„å±æ€§å€¼ æ ¼å¼ï¼š 12345@PropertySource(value = &quot;classpath:filename.properties&quot;)public class ClassName &#123; @Value(&quot;$&#123;propertiesAttributeName&#125;&quot;) private String attributeName;&#125; è¯´æ˜ï¼š ä¸æ”¯æŒ * é€šé…ç¬¦ï¼ŒåŠ è½½åï¼Œæ‰€æœ‰ Spring æ§åˆ¶çš„ bean ä¸­å‡å¯ä½¿ç”¨å¯¹åº”å±æ€§å€¼ï¼ŒåŠ è½½å¤šä¸ªéœ€è¦ç”¨ &#123;&#125; å’Œ , éš”å¼€ ç›¸å…³å±æ€§ valueï¼ˆé»˜è®¤ï¼‰ï¼šè®¾ç½®åŠ è½½çš„ properties æ–‡ä»¶å ignoreResourceNotFoundï¼šå¦‚æœèµ„æºæœªæ‰¾åˆ°ï¼Œæ˜¯å¦å¿½ç•¥ï¼Œé»˜è®¤ä¸º false åŠ è½½æ§åˆ¶ä¾èµ–åŠ è½½@DependsOn åç§°ï¼š@DependsOn ç±»å‹ï¼šç±»æ³¨è§£ã€æ–¹æ³•æ³¨è§£ ä½œç”¨ï¼šæ§åˆ¶ bean çš„åŠ è½½é¡ºåºï¼Œä½¿å…¶åœ¨æŒ‡å®š bean åŠ è½½å®Œæ¯•åå†åŠ è½½ æ ¼å¼ï¼š 123@DependsOn(&quot;beanId&quot;)public class ClassName &#123;&#125; è¯´æ˜ï¼š é…ç½®åœ¨æ–¹æ³•ä¸Šï¼Œä½¿ @DependsOn æŒ‡å®šçš„ bean ä¼˜å…ˆäº @Bean é…ç½®çš„ bean è¿›è¡ŒåŠ è½½ é…ç½®åœ¨ç±»ä¸Šï¼Œä½¿ @DependsOn æŒ‡å®šçš„ bean ä¼˜å…ˆäºå½“å‰ç±»ä¸­æ‰€æœ‰ @Bean é…ç½®çš„ bean è¿›è¡ŒåŠ è½½ é…ç½®åœ¨ç±»ä¸Šï¼Œä½¿ @DependsOn æŒ‡å®šçš„ bean ä¼˜å…ˆäº @Component ç­‰é…ç½®çš„ bean è¿›è¡ŒåŠ è½½ ç›¸å…³å±æ€§ valueï¼ˆé»˜è®¤ï¼‰ï¼šè®¾ç½®å½“å‰ bean æ‰€ä¾èµ–çš„ bean çš„ id @Order åç§°ï¼š@Order ç±»å‹ï¼šé…ç½®ç±»æ³¨è§£ ä½œç”¨ï¼šæ§åˆ¶é…ç½®ç±»çš„åŠ è½½é¡ºåºï¼Œå€¼è¶Šå°è¶Šå…ˆåŠ è½½ æ ¼å¼ï¼š 123@Order(1)public class SpringConfigClassName &#123;&#125; @Lazy åç§°ï¼š@Lazy ç±»å‹ï¼šç±»æ³¨è§£ã€æ–¹æ³•æ³¨è§£ ä½œç”¨ï¼šæ§åˆ¶ bean çš„åŠ è½½æ—¶æœºï¼Œä½¿å…¶å»¶è¿ŸåŠ è½½ï¼Œè·å–çš„æ—¶å€™åŠ è½½ æ ¼å¼ï¼š 123@Lazypublic class ClassName &#123;&#125; åº”ç”¨åœºæ™¯@DependsOn å¾®ä¿¡è®¢é˜…å·ï¼Œå‘å¸ƒæ¶ˆæ¯å’Œè®¢é˜…æ¶ˆæ¯çš„ bean çš„åŠ è½½é¡ºåºæ§åˆ¶ï¼ˆå…ˆå¼€è®¢é˜…ï¼Œå†å‘å¸ƒï¼‰ åŒ 11 æ´»åŠ¨ï¼Œé›¶ç‚¹å‰æ˜¯ç»“ç®—ç­–ç•¥ Aï¼Œé›¶ç‚¹åæ˜¯ç»“ç®—ç­–ç•¥ Bï¼Œç­–ç•¥ B æ“ä½œçš„æ•°æ®ä¸ºä¿ƒé”€æ•°æ®ï¼Œç­–ç•¥ B åŠ è½½é¡ºåºä¸ä¿ƒé”€æ•°æ®çš„åŠ è½½é¡ºåº @Lazy ç¨‹åºç¾éš¾å‡ºç°åå¯¹åº”çš„åº”æ€¥é¢„æ¡ˆå¤„ç†æ˜¯å¯åŠ¨å®¹å™¨æ—¶åŠ è½½æ—¶æœº @Order å¤šä¸ªç§ç±»çš„é…ç½®å‡ºç°åï¼Œä¼˜å…ˆåŠ è½½ç³»ç»Ÿçº§çš„ï¼Œç„¶ååŠ è½½ä¸šåŠ¡çº§çš„ï¼Œé¿å…ç»†ç²’åº¦çš„åŠ è½½æ§åˆ¶ æ•´åˆèµ„æºå¯¼å…¥åç§°ï¼š@Import ç±»å‹ï¼šç±»æ³¨è§£ ä½œç”¨ï¼šå¯¼å…¥ç¬¬ä¸‰æ–¹ bean ä½œä¸º Spring æ§åˆ¶çš„èµ„æºï¼Œè¿™äº›ç±»éƒ½ä¼šè¢« Spring åˆ›å»ºå¹¶æ”¾å…¥ ioc å®¹å™¨ æ ¼å¼ï¼š 1234@Configuration@Import(OtherClassName.class)public class ClassName &#123;&#125; è¯´æ˜ï¼š @Import æ³¨è§£åœ¨åŒä¸€ä¸ªç±»ä¸Šï¼Œä»…å…è®¸æ·»åŠ ä¸€æ¬¡ï¼Œå¦‚æœéœ€è¦å¯¼å…¥å¤šä¸ªï¼Œä½¿ç”¨æ•°ç»„çš„å½¢å¼è¿›è¡Œè®¾å®š åœ¨è¢«å¯¼å…¥çš„ç±»ä¸­å¯ä»¥ç»§ç»­ä½¿ç”¨ @Import å¯¼å…¥å…¶ä»–èµ„æº @Bean æ‰€åœ¨çš„ç±»å¯ä»¥ä½¿ç”¨å¯¼å…¥çš„å½¢å¼è¿›å…¥ Spring å®¹å™¨ï¼Œæ— éœ€å£°æ˜ä¸º bean Druid åŠ è½½èµ„æº 123456789101112@Componentpublic class JDBCConfig &#123; @Bean(&quot;dataSource&quot;) public static DruidDataSource getDataSource() &#123; DruidDataSource ds = new DruidDataSource(); ds.setDriverClassName(&quot;com.mysql.jdbc.Driver&quot;); ds.setUrl(&quot;jdbc:mysql://192.168.2.185:3306/spring_db&quot;); ds.setUsername(&quot;root&quot;); ds.setPassword(&quot;123456&quot;); return ds; &#125;&#125; å¯¼å…¥èµ„æº 12345@Configuration@ComponentScan(value = &#123;&quot;service&quot;,&quot;dao&quot;&#125;)@Import(JDBCConfig.class)public class SpringConfig &#123;&#125; æµ‹è¯• 12DruidDataSource dataSource = (DruidDataSource) ctx.getBean(&quot;dataSource&quot;);System.out.println(dataSource); JunitSpring æ¥ç®¡ Junit çš„è¿è¡Œæƒï¼Œä½¿ç”¨ Spring ä¸“ç”¨çš„ Junit ç±»åŠ è½½å™¨ï¼Œä¸º Junit æµ‹è¯•ç”¨ä¾‹è®¾å®šå¯¹åº”çš„ Spring å®¹å™¨ æ³¨æ„ï¼š ä» Spring5.0 ä»¥åï¼Œè¦æ±‚ Junit çš„ç‰ˆæœ¬å¿…é¡»æ˜¯4.12åŠä»¥ä¸Š Junit ä»…ç”¨äºå•å…ƒæµ‹è¯•ï¼Œä¸èƒ½å°† Junit çš„æµ‹è¯•ç±»é…ç½®æˆ Spring çš„ beanï¼Œå¦åˆ™è¯¥é…ç½®å°†ä¼šè¢«æ‰“åŒ…è¿›å…¥å·¥ç¨‹ä¸­ test &#x2F; java &#x2F; service &#x2F; UserServiceTest 12345678910111213//è®¾å®šspringä¸“ç”¨çš„ç±»åŠ è½½å™¨@RunWith(SpringJUnit4ClassRunner.class)//è®¾å®šåŠ è½½çš„springä¸Šä¸‹æ–‡å¯¹åº”çš„é…ç½®@ContextConfiguration(classes = SpringConfig.class)public class UserServiceTest &#123; @Autowired private AccountService accountService; @Test public void testFindById() &#123; Account account = accountService.findById(1); Assert.assertEquals(&quot;Mike&quot;, account.getName()); &#125;&#125; pom.xml 12345678910&lt;dependency&gt; &lt;groupId&gt;junit&lt;/groupId&gt; &lt;artifactId&gt;junit&lt;/artifactId&gt; &lt;version&gt;4.12&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-test&lt;/artifactId&gt; &lt;version&gt;5.1.9.RELEASE&lt;/version&gt;&lt;/dependency&gt; IoCåŸç†æ ¸å¿ƒç±»BeanFactoryApplicationContextï¼š ApplicationContext æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæä¾›äº†è®¿é—® Spring å®¹å™¨çš„ API ClassPathXmlApplicationContext æ˜¯ä¸€ä¸ªç±»ï¼Œå®ç°äº†ä¸Šè¿°åŠŸèƒ½ ApplicationContext çš„é¡¶å±‚æ¥å£æ˜¯ BeanFactory BeanFactory å®šä¹‰äº† bean ç›¸å…³çš„æœ€åŸºæœ¬æ“ä½œ ApplicationContext åœ¨ BeanFactory åŸºç¡€ä¸Šè¿½åŠ äº†è‹¥å¹²æ–°åŠŸèƒ½ ApplicationContext å’Œ BeanFactoryå¯¹æ¯”ï¼š BeanFactory å’Œ ApplicationContext æ˜¯ Spring çš„ä¸¤å¤§æ ¸å¿ƒæ¥å£ï¼Œéƒ½å¯ä»¥å½“åš Spring çš„å®¹å™¨ BeanFactory æ˜¯ Spring é‡Œé¢æœ€åº•å±‚çš„æ¥å£ï¼Œæ˜¯ IoC çš„æ ¸å¿ƒï¼Œå®šä¹‰äº† IoC çš„åŸºæœ¬åŠŸèƒ½ï¼ŒåŒ…å«äº†å„ç§ Bean çš„å®šä¹‰ã€åŠ è½½ã€å®ä¾‹åŒ–ï¼Œä¾èµ–æ³¨å…¥å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚ApplicationContext æ¥å£ä½œä¸º BeanFactory çš„å­ç±»ï¼Œé™¤äº†æä¾› BeanFactory æ‰€å…·æœ‰çš„åŠŸèƒ½å¤–ï¼Œè¿˜æä¾›äº†æ›´å®Œæ•´çš„æ¡†æ¶åŠŸèƒ½ï¼š ç»§æ‰¿ MessageSourceï¼Œå› æ­¤æ”¯æŒå›½é™…åŒ– èµ„æºæ–‡ä»¶è®¿é—®ï¼Œå¦‚ URL å’Œæ–‡ä»¶ï¼ˆResourceLoaderï¼‰ã€‚ è½½å…¥å¤šä¸ªï¼ˆæœ‰ç»§æ‰¿å…³ç³»ï¼‰ä¸Šä¸‹æ–‡ï¼ˆå³åŠ è½½å¤šä¸ªé…ç½®æ–‡ä»¶ï¼‰ ï¼Œä½¿å¾—æ¯ä¸€ä¸ªä¸Šä¸‹æ–‡éƒ½ä¸“æ³¨äºä¸€ä¸ªç‰¹å®šçš„å±‚æ¬¡ï¼Œæ¯”å¦‚åº”ç”¨çš„ web å±‚ æä¾›åœ¨ç›‘å¬å™¨ä¸­æ³¨å†Œ bean çš„äº‹ä»¶ BeanFactory åˆ›å»ºçš„ bean é‡‡ç”¨å»¶è¿ŸåŠ è½½å½¢å¼ï¼Œåªæœ‰åœ¨ä½¿ç”¨åˆ°æŸä¸ª Bean æ—¶ï¼ˆè°ƒç”¨ getBeanï¼‰ï¼Œæ‰å¯¹è¯¥ Bean è¿›è¡ŒåŠ è½½å®ä¾‹åŒ–ï¼ˆSpring æ—©æœŸä½¿ç”¨è¯¥æ–¹æ³•è·å– beanï¼‰ï¼Œè¿™æ ·å°±ä¸èƒ½æå‰å‘ç°ä¸€äº›å­˜åœ¨çš„ Spring çš„é…ç½®é—®é¢˜ï¼›ApplicationContext æ˜¯åœ¨å®¹å™¨å¯åŠ¨æ—¶ï¼Œä¸€æ¬¡æ€§åˆ›å»ºäº†æ‰€æœ‰çš„ Beanï¼Œå®¹å™¨å¯åŠ¨æ—¶ï¼Œå°±å¯ä»¥å‘ç° Spring ä¸­å­˜åœ¨çš„é…ç½®é”™è¯¯ï¼Œè¿™æ ·æœ‰åˆ©äºæ£€æŸ¥æ‰€ä¾èµ–å±æ€§æ˜¯å¦æ³¨å…¥ ApplicationContext å¯åŠ¨åé¢„è½½å…¥æ‰€æœ‰çš„å•å®ä¾‹ Beanï¼Œæ‰€ä»¥ç¨‹åºå¯åŠ¨æ…¢ï¼Œè¿è¡Œæ—¶é€Ÿåº¦å¿« ä¸¤è€…éƒ½æ”¯æŒ BeanPostProcessorã€BeanFactoryPostProcessor çš„ä½¿ç”¨ï¼Œä½†ä¸¤è€…ä¹‹é—´çš„åŒºåˆ«æ˜¯ï¼šBeanFactory éœ€è¦æ‰‹åŠ¨æ³¨å†Œï¼Œè€Œ ApplicationContext åˆ™æ˜¯è‡ªåŠ¨æ³¨å†Œ FileSystemXmlApplicationContextï¼šåŠ è½½æ–‡ä»¶ç³»ç»Ÿä¸­ä»»æ„ä½ç½®çš„é…ç½®æ–‡ä»¶ï¼Œè€Œ ClassPathXmlAC åªèƒ½åŠ è½½ç±»è·¯å¾„ä¸‹çš„é…ç½®æ–‡ä»¶ BeanFactory çš„æˆå‘˜å±æ€§ï¼š 1String FACTORY_BEAN_PREFIX = &quot;&amp;&quot;; åŒºåˆ†æ˜¯ FactoryBean è¿˜æ˜¯åˆ›å»ºçš„ Beanï¼ŒåŠ ä¸Š &amp; ä»£è¡¨æ˜¯å·¥å‚ï¼ŒgetBean å°†ä¼šè¿”å›å·¥å‚ FactoryBeanï¼šå¦‚æœæŸä¸ª bean çš„é…ç½®éå¸¸å¤æ‚ï¼Œæˆ–è€…æƒ³è¦ä½¿ç”¨ç¼–ç çš„å½¢å¼å»æ„å»ºå®ƒï¼Œå¯ä»¥æä¾›ä¸€ä¸ªæ„å»ºè¯¥ bean å®ä¾‹çš„å·¥å‚ï¼Œè¿™ä¸ªå·¥å‚å°±æ˜¯ FactoryBean æ¥å£å®ç°ç±»ï¼ŒFactoryBean æ¥å£å®ç°ç±»ä¹Ÿæ˜¯éœ€è¦ Spring ç®¡ç† è¿™é‡Œäº§ç”Ÿä¸¤ç§å¯¹è±¡ï¼Œä¸€ç§æ˜¯ FactoryBean æ¥å£å®ç°ç±»ï¼ˆIOC ç®¡ç†ï¼‰ï¼Œå¦ä¸€ç§æ˜¯ FactoryBean æ¥å£å†…éƒ¨ç®¡ç†çš„å¯¹è±¡ è·å– FactoryBean æ¥å£å®ç°ç±»ï¼Œä½¿ç”¨ getBean æ—¶ä¼ çš„ beanName éœ€è¦å¸¦ &amp; å¼€å¤´ è·å– FactoryBean å†…éƒ¨ç®¡ç†çš„å¯¹è±¡ï¼Œä¸éœ€è¦å¸¦ &amp; å¼€å¤´ BeanFactory çš„åŸºæœ¬ä½¿ç”¨ï¼š 123Resource res = new ClassPathResource(&quot;applicationContext.xml&quot;);BeanFactory bf = new XmlBeanFactory(res);UserService userService = (UserService)bf.getBean(&quot;userService&quot;); FactoryBeanFactoryBeanï¼šå¯¹å•ä¸€çš„ bean çš„åˆå§‹åŒ–è¿‡ç¨‹è¿›è¡Œå°è£…ï¼Œè¾¾åˆ°ç®€åŒ–é…ç½®çš„ç›®çš„ FactoryBeanä¸ BeanFactory åŒºåˆ«ï¼š FactoryBeanï¼šå°è£…å•ä¸ª bean çš„åˆ›å»ºè¿‡ç¨‹ï¼Œå°±æ˜¯å·¥å‚çš„ Bean BeanFactoryï¼šSpring å®¹å™¨é¡¶å±‚æ¥å£ï¼Œå®šä¹‰äº† bean ç›¸å…³çš„è·å–æ“ä½œ ä»£ç å®ç°ï¼š FactoryBeanï¼Œå®ç°ç±»ä¸€èˆ¬æ˜¯ MapperFactoryBeanï¼Œåˆ›å»º DAO å±‚æ¥å£çš„å®ç°ç±» 12345678910111213141516public class EquipmentDaoImplFactoryBean implements FactoryBean &#123; @Override //è·å–Bean public Object getObject() throws Exception &#123; return new EquipmentDaoImpl(); &#125; @Override //è·å–beançš„ç±»å‹ public Class&lt;?&gt; getObjectType() &#123; return null; &#125; @Override //æ˜¯å¦å•ä¾‹ public boolean isSingleton() &#123; return false; &#125;&#125; MapperFactoryBean ç»§æ‰¿ SqlSessionDaoSupportï¼Œå¯ä»¥è·å– SqlSessionTemplateï¼Œå®Œæˆ MyBatis çš„æ•´åˆ 12345678910public abstract class SqlSessionDaoSupport extends DaoSupport &#123; private SqlSessionTemplate sqlSessionTemplate; // è·å– SqlSessionTemplate å¯¹è±¡ public void setSqlSessionFactory(SqlSessionFactory sqlSessionFactory) &#123; if (this.sqlSessionTemplate == null || sqlSessionFactory != this.sqlSessionTemplate.getSqlSessionFactory()) &#123; this.sqlSessionTemplate = createSqlSessionTemplate(sqlSessionFactory); &#125; &#125;&#125; è¿‡æ»¤å™¨æ•°æ®å‡†å¤‡ DAO å±‚ UserDaoã€AccountDaoã€BookDaoã€EquipmentDao 123public interface UserDao &#123; public void save();&#125; 1234567@Component(&quot;userDao&quot;)public class UserDaoImpl implements UserDao &#123; public void save() &#123; System.out.println(&quot;user dao running...&quot;); &#125;&#125; Service ä¸šåŠ¡å±‚ 123public interface UserService &#123; public void save();&#125; 12345678910@Service(&quot;userService&quot;)public class UserServiceImpl implements UserService &#123; @Autowired private UserDao userDao;//...........BookDaoç­‰ public void save() &#123; System.out.println(&quot;user service running...&quot;); userDao.save(); &#125;&#125; è¿‡æ»¤å™¨åç§°ï¼šTypeFilter ç±»å‹ï¼šæ¥å£ ä½œç”¨ï¼šè‡ªå®šä¹‰ç±»å‹è¿‡æ»¤å™¨ ç¤ºä¾‹ï¼š config &#x2F; filter &#x2F; MyTypeFilter 1234567891011121314151617181920212223242526public class MyTypeFilter implements TypeFilter &#123; @Override /** * metadataReader:è¯»å–åˆ°çš„å½“å‰æ­£åœ¨æ‰«æçš„ç±»çš„ä¿¡æ¯ * metadataReaderFactory:å¯ä»¥è·å–åˆ°ä»»ä½•å…¶ä»–ç±»çš„ä¿¡æ¯ */ //åŠ è½½çš„ç±»æ»¡è¶³è¦æ±‚ï¼ŒåŒ¹é…æˆåŠŸ public boolean match(MetadataReader metadataReader, MetadataReaderFactory metadataReaderFactory) throws IOException &#123; //è·å–å½“å‰ç±»æ³¨è§£çš„ä¿¡æ¯ AnnotationMetadata am = metadataReader.getAnnotationMetadata(); //è·å–å½“å‰æ­£åœ¨æ‰«æçš„ç±»çš„ç±»ä¿¡æ¯ ClassMetadata classMetadata = metadataReader.getClassMetadata(); //è·å–å½“å‰ç±»èµ„æºï¼ˆç±»çš„è·¯å¾„ï¼‰ Resource resource = metadataReader.getResource(); //é€šè¿‡ç±»çš„å…ƒæ•°æ®è·å–ç±»çš„åç§° String className = classMetadata.getClassName(); //å¦‚æœåŠ è½½çš„ç±»åæ»¡è¶³è¿‡æ»¤å™¨è¦æ±‚ï¼Œè¿”å›åŒ¹é…æˆåŠŸ if(className.equals(&quot;service.impl.UserServiceImpl&quot;))&#123; //è¿”å›trueè¡¨ç¤ºåŒ¹é…æˆåŠŸï¼Œè¿”å›falseè¡¨ç¤ºåŒ¹é…å¤±è´¥ã€‚æ­¤å¤„ä»…ç¡®è®¤åŒ¹é…ç»“æœï¼Œä¸ä¼šç¡®è®¤æ˜¯æ’é™¤è¿˜æ˜¯åŠ å…¥ï¼Œæ’é™¤/åŠ å…¥ç”±é…ç½®é¡¹å†³å®šï¼Œä¸æ­¤å¤„æ— å…³ return true; &#125; return false; &#125;&#125; SpringConfig 1234567891011@Configuration//è®¾ç½®æ’é™¤beanï¼Œæ’é™¤çš„è§„åˆ™æ˜¯è‡ªå®šä¹‰è§„åˆ™ï¼ˆFilterType.CUSTOMï¼‰ï¼Œå…·ä½“çš„è§„åˆ™å®šä¹‰ä¸ºMyTypeFilter@ComponentScan( value = &#123;&quot;dao&quot;,&quot;service&quot;&#125;, excludeFilters = @ComponentScan.Filter( type= FilterType.CUSTOM, classes = MyTypeFilter.class ))public class SpringConfig &#123;&#125; å¯¼å…¥å™¨bean åªæœ‰é€šè¿‡é…ç½®æ‰å¯ä»¥è¿›å…¥ Spring å®¹å™¨ï¼Œè¢« Spring åŠ è½½å¹¶æ§åˆ¶ é…ç½® bean çš„æ–¹å¼å¦‚ä¸‹ï¼š XML æ–‡ä»¶ä¸­ä½¿ç”¨ æ ‡ç­¾é…ç½® ä½¿ç”¨ @Component åŠè¡ç”Ÿæ³¨è§£é…ç½® å¯¼å…¥å™¨å¯ä»¥å¿«é€Ÿé«˜æ•ˆå¯¼å…¥å¤§é‡ beanï¼Œæ›¿ä»£ @Import({a.class,b.class})ï¼Œæ— éœ€åœ¨æ¯ä¸ªç±»ä¸Šæ·»åŠ  @Bean åç§°ï¼š ImportSelector ç±»å‹ï¼šæ¥å£ ä½œç”¨ï¼šè‡ªå®šä¹‰beanå¯¼å…¥å™¨ selector &#x2F; MyImportSelector 12345678910111213141516public class MyImportSelector implements ImportSelector&#123; @Override public String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;// 1.ç¼–ç¨‹å½¢å¼åŠ è½½ä¸€ä¸ªç±»// return new String[]&#123;&quot;dao.impl.BookDaoImpl&quot;&#125;;// 2.åŠ è½½import.propertiesæ–‡ä»¶ä¸­çš„å•ä¸ªç±»å// ResourceBundle bundle = ResourceBundle.getBundle(&quot;import&quot;);// String className = bundle.getString(&quot;className&quot;);// 3.åŠ è½½import.propertiesæ–‡ä»¶ä¸­çš„å¤šä¸ªç±»å ResourceBundle bundle = ResourceBundle.getBundle(&quot;import&quot;); String className = bundle.getString(&quot;className&quot;); return className.split(&quot;,&quot;); &#125;&#125; import.properties 12345678#2.åŠ è½½import.propertiesæ–‡ä»¶ä¸­çš„å•ä¸ªç±»å#className=dao.impl.BookDaoImpl#3.åŠ è½½import.propertiesæ–‡ä»¶ä¸­çš„å¤šä¸ªç±»å#className=dao.impl.BookDaoImpl,dao.impl.AccountDaoImpl#4.å¯¼å…¥åŒ…ä¸­çš„æ‰€æœ‰ç±»path=dao.impl.* SpringConfig 12345@Configuration@ComponentScan(&#123;&quot;dao&quot;,&quot;service&quot;&#125;)@Import(MyImportSelector.class)public class SpringConfig &#123;&#125; æ³¨å†Œå™¨å¯ä»¥å–ä»£ ComponentScan æ‰«æå™¨ åç§°ï¼šImportBeanDefinitionRegistrar ç±»å‹ï¼šæ¥å£ ä½œç”¨ï¼šè‡ªå®šä¹‰ bean å®šä¹‰æ³¨å†Œå™¨ registrar &#x2F; MyImportBeanDefinitionRegistrar 1234567891011121314151617181920212223public class MyImportBeanDefinitionRegistrar implements ImportBeanDefinitionRegistrar &#123;/** * AnnotationMetadata:å½“å‰ç±»çš„æ³¨è§£ä¿¡æ¯ * BeanDefinitionRegistry:BeanDefinitionæ³¨å†Œç±»ï¼ŒæŠŠæ‰€æœ‰éœ€è¦æ·»åŠ åˆ°å®¹å™¨ä¸­çš„beanè°ƒç”¨registerBeanDefinitionæ‰‹å·¥æ³¨å†Œè¿›æ¥ */ @Override public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) &#123; //è‡ªå®šä¹‰æ³¨å†Œå™¨ //1.å¼€å¯ç±»è·¯å¾„beanå®šä¹‰æ‰«æå™¨ï¼Œéœ€è¦å‚æ•°beanå®šä¹‰æ³¨å†Œå™¨BeanDefinitionRegistryï¼Œéœ€è¦åˆ¶å®šæ˜¯å¦ä½¿ç”¨é»˜è®¤ç±»å‹è¿‡æ»¤å™¨ ClassPathBeanDefinitionScanner scanner = new ClassPathBeanDefinitionScanner(registry,false); //2.æ·»åŠ åŒ…å«æ€§åŠ è½½ç±»å‹è¿‡æ»¤å™¨ï¼ˆå¯é€‰ï¼Œä¹Ÿå¯ä»¥è®¾ç½®ä¸ºæ’é™¤æ€§åŠ è½½ç±»å‹è¿‡æ»¤å™¨ï¼‰ scanner.addIncludeFilter(new TypeFilter() &#123; @Override public boolean match(MetadataReader metadataReader, MetadataReaderFactory metadataReaderFactory) throws IOException &#123; //æ‰€æœ‰åŒ¹é…å…¨éƒ¨æˆåŠŸï¼Œæ­¤å¤„åº”è¯¥æ·»åŠ å®é™…çš„ä¸šåŠ¡åˆ¤å®šæ¡ä»¶ return true; &#125; &#125;); //è®¾ç½®æ‰«æè·¯å¾„ scanner.addExcludeFilter(tf);//æ’é™¤ scanner.scan(&quot;dao&quot;,&quot;service&quot;); &#125;&#125; SpringConfig 1234@Configuration@Import(MyImportBeanDefinitionRegistrar.class)public class SpringConfig &#123;&#125; å¤„ç†å™¨é€šè¿‡åˆ›å»ºç±»ç»§æ‰¿ç›¸åº”çš„å¤„ç†å™¨çš„æ¥å£ï¼Œé‡å†™åç½®å¤„ç†çš„æ–¹æ³•ï¼Œæ¥å®ç°æ‹¦æˆª Bean çš„ç”Ÿå‘½å‘¨æœŸæ¥å®ç°è‡ªå·±è‡ªå®šä¹‰çš„é€»è¾‘ BeanPostProcessorï¼šbean åç½®å¤„ç†å™¨ï¼Œbean åˆ›å»ºå¯¹è±¡åˆå§‹åŒ–å‰åè¿›è¡Œæ‹¦æˆªå·¥ä½œçš„ BeanFactoryPostProcessorï¼šbeanFactory çš„åç½®å¤„ç†å™¨ åŠ è½½æ—¶æœºï¼šåœ¨ BeanFactory åˆå§‹åŒ–ä¹‹åè°ƒç”¨ï¼Œæ¥å®šåˆ¶å’Œä¿®æ”¹ BeanFactory çš„å†…å®¹ï¼›æ‰€æœ‰çš„ bean å®šä¹‰å·²ç»ä¿å­˜åŠ è½½åˆ° beanFactoryï¼Œä½†æ˜¯ bean çš„å®ä¾‹è¿˜æœªåˆ›å»º æ‰§è¡Œæµç¨‹ï¼š ioc å®¹å™¨åˆ›å»ºå¯¹è±¡ invokeBeanFactoryPostProcessors(beanFactory)ï¼šæ‰§è¡Œ BeanFactoryPostProcessor åœ¨ BeanFactory ä¸­æ‰¾åˆ°æ‰€æœ‰ç±»å‹æ˜¯ BeanFactoryPostProcessor çš„ç»„ä»¶ï¼Œå¹¶æ‰§è¡Œå®ƒä»¬çš„æ–¹æ³• åœ¨åˆå§‹åŒ–åˆ›å»ºå…¶ä»–ç»„ä»¶å‰é¢æ‰§è¡Œ BeanDefinitionRegistryPostProcessorï¼š åŠ è½½æ—¶æœºï¼šåœ¨æ‰€æœ‰ bean å®šä¹‰ä¿¡æ¯å°†è¦è¢«åŠ è½½ï¼Œä½†æ˜¯ bean å®ä¾‹è¿˜æœªåˆ›å»ºï¼Œä¼˜å…ˆäº BeanFactoryPostProcessor æ‰§è¡Œï¼›åˆ©ç”¨ BeanDefinitionRegistryPostProcessor ç»™å®¹å™¨ä¸­å†é¢å¤–æ·»åŠ ä¸€äº›ç»„ä»¶ æ‰§è¡Œæµç¨‹ï¼š ioc å®¹å™¨åˆ›å»ºå¯¹è±¡ refresh() â†’ invokeBeanFactoryPostProcessors(beanFactory) ä»å®¹å™¨ä¸­è·å–åˆ°æ‰€æœ‰çš„ BeanDefinitionRegistryPostProcessor ç»„ä»¶ ä¾æ¬¡è§¦å‘æ‰€æœ‰çš„ postProcessBeanDefinitionRegistry() æ–¹æ³• å†æ¥è§¦å‘ postProcessBeanFactory() æ–¹æ³• ç›‘å¬å™¨åŸºæœ¬æ¦‚è¿°ApplicationListenerï¼šç›‘å¬å®¹å™¨ä¸­å‘å¸ƒçš„äº‹ä»¶ï¼Œå®Œæˆäº‹ä»¶é©±åŠ¨æ¨¡å‹å¼€å‘ 1public interface ApplicationListener&lt;E extends ApplicationEvent&gt; æ‰€ä»¥ç›‘å¬ ApplicationEvent åŠå…¶ä¸‹é¢çš„å­äº‹ä»¶ åº”ç”¨ç›‘å¬å™¨æ­¥éª¤ï¼š å†™ä¸€ä¸ªç›‘å¬å™¨ï¼ˆApplicationListenerå®ç°ç±»ï¼‰æ¥ç›‘å¬æŸä¸ªäº‹ä»¶ï¼ˆApplicationEventåŠå…¶å­ç±»ï¼‰ æŠŠç›‘å¬å™¨åŠ å…¥åˆ°å®¹å™¨ @Component åªè¦å®¹å™¨ä¸­æœ‰ç›¸å…³äº‹ä»¶çš„å‘å¸ƒï¼Œå°±èƒ½ç›‘å¬åˆ°è¿™ä¸ªäº‹ä»¶ï¼› * ContextRefreshedEventï¼šå®¹å™¨åˆ·æ–°å®Œæˆï¼ˆæ‰€æœ‰ bean éƒ½å®Œå…¨åˆ›å»ºï¼‰ä¼šå‘å¸ƒè¿™ä¸ªäº‹ä»¶ * ContextClosedEventï¼šå…³é—­å®¹å™¨ä¼šå‘å¸ƒè¿™ä¸ªäº‹ä»¶ å‘å¸ƒä¸€ä¸ªäº‹ä»¶ï¼š`applicationContext.publishEvent()` 12345678@Componentpublic class MyApplicationListener implements ApplicationListener&lt;ApplicationEvent&gt; &#123; //å½“å®¹å™¨ä¸­å‘å¸ƒæ­¤äº‹ä»¶ä»¥åï¼Œæ–¹æ³•è§¦å‘ @Override public void onApplicationEvent(ApplicationEvent event) &#123; System.out.println(&quot;æ”¶åˆ°äº‹ä»¶ï¼š&quot; + event); &#125;&#125; å®ç°åŸç†ContextRefreshedEvent äº‹ä»¶ï¼š å®¹å™¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­æ‰§è¡Œ initApplicationEventMulticaster()ï¼šåˆå§‹åŒ–äº‹ä»¶å¤šæ’­å™¨ å…ˆå»å®¹å™¨ä¸­æŸ¥è¯¢ id = applicationEventMulticaster çš„ç»„ä»¶ï¼Œæœ‰ç›´æ¥è¿”å› æ²¡æœ‰å°±æ‰§è¡Œ this.applicationEventMulticaster = new SimpleApplicationEventMulticaster(beanFactory) å¹¶ä¸”åŠ å…¥åˆ°å®¹å™¨ä¸­ ä»¥ååœ¨å…¶ä»–ç»„ä»¶è¦æ´¾å‘äº‹ä»¶ï¼Œè‡ªåŠ¨æ³¨å…¥è¿™ä¸ª applicationEventMulticaster å®¹å™¨åˆå§‹åŒ–è¿‡ç¨‹æ‰§è¡Œ registerListeners() æ³¨å†Œç›‘å¬å™¨ ä»å®¹å™¨ä¸­è·å–æ‰€æœ‰ç›‘å¬å™¨ï¼šgetBeanNamesForType(ApplicationListener.class, true, false) å°† listener æ³¨å†Œåˆ° ApplicationEventMulticaster å®¹å™¨åˆ·æ–°å®Œæˆï¼šfinishRefresh() â†’ publishEvent(new ContextRefreshedEvent(this)) å‘å¸ƒ ContextRefreshedEvent äº‹ä»¶ï¼š è·å–äº‹ä»¶çš„å¤šæ’­å™¨ï¼ˆæ´¾å‘å™¨ï¼‰ï¼šgetApplicationEventMulticaster() multicastEvent æ´¾å‘äº‹ä»¶ è·å–åˆ°æ‰€æœ‰çš„ ApplicationListener éå† ApplicationListener å¦‚æœæœ‰ Executorï¼Œå¯ä»¥ä½¿ç”¨ Executor å¼‚æ­¥æ´¾å‘ Executor executor = getTaskExecutor() æ²¡æœ‰å°±åŒæ­¥æ‰§è¡Œ listener æ–¹æ³• invokeListener(listener, event)ï¼Œæ‹¿åˆ° listener å›è°ƒ onApplicationEvent å®¹å™¨å…³é—­ä¼šå‘å¸ƒ ContextClosedEvent æ³¨è§£å®ç°æ³¨è§£ï¼š@EventListener åŸºæœ¬ä½¿ç”¨ï¼š 1234567@Servicepublic class UserService&#123; @EventListener(classes=&#123;ApplicationEvent.class&#125;) public void listen(ApplicationEvent event)&#123; System.out.println(&quot;UserServiceã€‚ã€‚ç›‘å¬åˆ°çš„äº‹ä»¶ï¼š&quot; + event); &#125;&#125; åŸç†ï¼šä½¿ç”¨ EventListenerMethodProcessor å¤„ç†å™¨æ¥è§£ææ–¹æ³•ä¸Šçš„ @EventListenerï¼ŒSpring æ‰«æä½¿ç”¨æ³¨è§£çš„æ–¹æ³•ï¼Œå¹¶ä¸ºä¹‹åˆ›å»ºä¸€ä¸ªç›‘å¬å¯¹è±¡ SmartInitializingSingleton åŸç†ï¼šafterSingletonsInstantiated() IOC å®¹å™¨åˆ›å»ºå¯¹è±¡å¹¶ refresh() finishBeanFactoryInitialization(beanFactory)ï¼šåˆå§‹åŒ–å‰©ä¸‹çš„å•å®ä¾‹ bean * å…ˆåˆ›å»ºæ‰€æœ‰çš„å•å®ä¾‹ beanï¼šgetBean() * è·å–æ‰€æœ‰åˆ›å»ºå¥½çš„å•å®ä¾‹ beanï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯ SmartInitializingSingleton ç±»å‹çš„ï¼Œå¦‚æœæ˜¯å°±è°ƒç”¨ afterSingletonsInstantiated() AOPåŸºæœ¬æ¦‚è¿°AOPï¼ˆAspect Oriented Programingï¼‰ï¼šé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼ŒæŒ‡å¯¼å¼€å‘è€…å¦‚ä½•ç»„ç»‡ç¨‹åºç»“æ„ AOP å¼¥è¡¥äº† OOP çš„ä¸è¶³ï¼ŒåŸºäº OOP åŸºç¡€ä¹‹ä¸Šè¿›è¡Œæ¨ªå‘å¼€å‘ï¼š uOOP è§„å®šç¨‹åºå¼€å‘ä»¥ç±»ä¸ºä¸»ä½“æ¨¡å‹ï¼Œä¸€åˆ‡å›´ç»•å¯¹è±¡è¿›è¡Œï¼Œå®ŒæˆæŸä¸ªä»»åŠ¡å…ˆæ„å»ºæ¨¡å‹ uAOP ç¨‹åºå¼€å‘ä¸»è¦å…³æ³¨åŸºäº OOP å¼€å‘ä¸­çš„å…±æ€§åŠŸèƒ½ï¼Œä¸€åˆ‡å›´ç»•å…±æ€§åŠŸèƒ½è¿›è¡Œï¼Œå®ŒæˆæŸä¸ªä»»åŠ¡å…ˆæ„å»ºå¯èƒ½é‡åˆ°çš„æ‰€æœ‰å…±æ€§åŠŸèƒ½ï¼ˆå½“æ‰€æœ‰åŠŸèƒ½éƒ½å¼€å‘å‡ºæ¥ä¹Ÿå°±æ²¡æœ‰å…±æ€§ä¸éå…±æ€§ä¹‹åˆ†ï¼‰ï¼Œå°†è½¯ä»¶å¼€å‘ç”±æ‰‹å·¥åˆ¶ä½œèµ°å‘åŠè‡ªåŠ¨åŒ–&#x2F;å…¨è‡ªåŠ¨åŒ–é˜¶æ®µï¼Œå®ç°â€œæ’æ‹”å¼ç»„ä»¶ä½“ç³»ç»“æ„â€æ­å»º AOP ä½œç”¨ï¼š æé«˜ä»£ç çš„å¯é‡ç”¨æ€§ ä¸šåŠ¡ä»£ç ç¼–ç æ›´ç®€æ´ ä¸šåŠ¡ä»£ç ç»´æŠ¤æ›´é«˜æ•ˆ ä¸šåŠ¡åŠŸèƒ½æ‰©å±•æ›´ä¾¿æ· æ ¸å¿ƒæ¦‚å¿µæ¦‚å¿µè¯¦è§£ Joinpointï¼ˆè¿æ¥ç‚¹ï¼‰ï¼šå°±æ˜¯æ–¹æ³• Pointcutï¼ˆåˆ‡å…¥ç‚¹ï¼‰ï¼šå°±æ˜¯æŒ–æ‰å…±æ€§åŠŸèƒ½çš„æ–¹æ³• Adviceï¼ˆé€šçŸ¥ï¼‰ï¼šå°±æ˜¯å…±æ€§åŠŸèƒ½ï¼Œæœ€ç»ˆä»¥ä¸€ä¸ªæ–¹æ³•çš„å½¢å¼å‘ˆç° Aspectï¼ˆåˆ‡é¢ï¼‰ï¼šå°±æ˜¯å…±æ€§åŠŸèƒ½ä¸æŒ–çš„ä½ç½®çš„å¯¹åº”å…³ç³» Targetï¼ˆç›®æ ‡å¯¹è±¡ï¼‰ï¼šå°±æ˜¯æŒ–æ‰åŠŸèƒ½çš„æ–¹æ³•å¯¹åº”çš„ç±»äº§ç”Ÿçš„å¯¹è±¡ï¼Œè¿™ç§å¯¹è±¡æ˜¯æ— æ³•ç›´æ¥å®Œæˆæœ€ç»ˆå·¥ä½œçš„ Weavingï¼ˆç»‡å…¥ï¼‰ï¼šå°±æ˜¯å°†æŒ–æ‰çš„åŠŸèƒ½å›å¡«çš„åŠ¨æ€è¿‡ç¨‹ Proxyï¼ˆä»£ç†ï¼‰ï¼šç›®æ ‡å¯¹è±¡æ— æ³•ç›´æ¥å®Œæˆå·¥ä½œï¼Œéœ€è¦å¯¹å…¶è¿›è¡ŒåŠŸèƒ½å›å¡«ï¼Œé€šè¿‡åˆ›å»ºåŸå§‹å¯¹è±¡çš„ä»£ç†å¯¹è±¡å®ç° Introductionï¼ˆå¼•å…¥&#x2F;å¼•ä»‹ï¼‰ï¼šå°±æ˜¯å¯¹åŸå§‹å¯¹è±¡æ— ä¸­ç”Ÿæœ‰çš„æ·»åŠ æˆå‘˜å˜é‡æˆ–æˆå‘˜æ–¹æ³• å…¥é—¨é¡¹ç›®å¼€å‘æ­¥éª¤ï¼š å¼€å‘é˜¶æ®µ åˆ¶ä½œç¨‹åº å°†éå…±æ€§åŠŸèƒ½å¼€å‘åˆ°å¯¹åº”çš„ç›®æ ‡å¯¹è±¡ç±»ä¸­ï¼Œå¹¶åˆ¶ä½œæˆåˆ‡å…¥ç‚¹æ–¹æ³• å°†å…±æ€§åŠŸèƒ½ç‹¬ç«‹å¼€å‘å‡ºæ¥ï¼Œåˆ¶ä½œæˆé€šçŸ¥ åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œå£°æ˜åˆ‡å…¥ç‚¹ åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œå£°æ˜åˆ‡å…¥ç‚¹ä¸é€šçŸ¥é—´çš„å…³ç³»ï¼ˆå«é€šçŸ¥ç±»å‹ï¼‰ï¼Œå³åˆ‡é¢ è¿è¡Œé˜¶æ®µï¼ˆAOP å®Œæˆï¼‰ Spring å®¹å™¨åŠ è½½é…ç½®æ–‡ä»¶ï¼Œç›‘æ§æ‰€æœ‰é…ç½®çš„åˆ‡å…¥ç‚¹æ–¹æ³•çš„æ‰§è¡Œ å½“ç›‘æ§åˆ°åˆ‡å…¥ç‚¹æ–¹æ³•è¢«è¿è¡Œï¼Œä½¿ç”¨ä»£ç†æœºåˆ¶ï¼ŒåŠ¨æ€åˆ›å»ºç›®æ ‡å¯¹è±¡çš„ä»£ç†å¯¹è±¡ï¼Œæ ¹æ®é€šçŸ¥ç±»åˆ«ï¼Œåœ¨ä»£ç†å¯¹è±¡çš„å¯¹åº”ä½ç½®å°†é€šçŸ¥å¯¹åº”çš„åŠŸèƒ½ç»‡å…¥ï¼Œå®Œæˆå®Œæ•´çš„ä»£ç é€»è¾‘å¹¶è¿è¡Œ å¯¼å…¥åæ ‡ pom.xml 12345678910&lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-context&lt;/artifactId&gt; &lt;version&gt;5.1.9.RELEASE&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.aspectj&lt;/groupId&gt; &lt;artifactId&gt;aspectjweaver&lt;/artifactId&gt; &lt;version&gt;1.9.4&lt;/version&gt;&lt;/dependency&gt; ä¸šåŠ¡å±‚æŠ½å–é€šç”¨ä»£ç  service &#x2F; UserServiceImpl 123public interface UserService &#123; public void save();&#125; 1234567public class UserServiceImpl implements UserService &#123; @Override public void save() &#123; //System.out.println(&quot;å…±æ€§åŠŸèƒ½&quot;); System.out.println(&quot;user service running...&quot;); &#125;&#125; aop.AOPAdvice 1234567//1.åˆ¶ä½œé€šçŸ¥ç±»ï¼Œåœ¨ç±»ä¸­å®šä¹‰ä¸€ä¸ªæ–¹æ³•ç”¨äºå®Œæˆå…±æ€§åŠŸèƒ½public class AOPAdvice &#123; //å…±æ€§åŠŸèƒ½æŠ½å–åèŒç§°ç‹¬ç«‹çš„æ–¹æ³• public void function()&#123; System.out.println(&quot;å…±æ€§åŠŸèƒ½&quot;); &#125;&#125; æŠŠé€šçŸ¥åŠ å…¥springå®¹å™¨ç®¡ç†ï¼Œé…ç½®aop applicationContext.xml 1234567891011121314151617181920212223242526272829&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:context=&quot;http://www.springframework.org/schema/context&quot; xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot; xsi:schemaLocation=&quot; http://www.springframework.org/schema/beans https://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/aop https://www.springframework.org/schema/aop/spring-aop.xsd &quot;&gt; &lt;!--åŸå§‹Springæ§åˆ¶èµ„æº--&gt; &lt;bean id=&quot;userService&quot; class= &quot;service.impl.UserServiceImpl&quot;/&gt; &lt;!--2.é…ç½®å…±æ€§åŠŸèƒ½æˆåŠŸspringæ§åˆ¶çš„èµ„æº--&gt; &lt;bean id=&quot;myAdvice&quot; class=&quot;aop.AOPAdvice&quot;/&gt; &lt;!--3.å¼€å¯AOPå‘½åç©ºé—´: beansæ ‡ç­¾å†…--&gt; &lt;!--4.é…ç½®AOP--&gt; &lt;aop:config&gt; &lt;!--5.é…ç½®åˆ‡å…¥ç‚¹--&gt; &lt;aop:pointcut id=&quot;pt&quot; expression=&quot;execution(* *..*(..))&quot;/&gt; &lt;!--6.é…ç½®åˆ‡é¢ï¼ˆåˆ‡å…¥ç‚¹ä¸é€šçŸ¥çš„å…³ç³»ï¼‰--&gt; &lt;aop:aspect ref=&quot;myAdvice&quot;&gt; &lt;!--7.é…ç½®å…·ä½“çš„åˆ‡å…¥ç‚¹å¯¹åº”é€šçŸ¥ä¸­é‚£ä¸ªæ“ä½œæ–¹æ³•--&gt; &lt;aop:before method=&quot;function&quot; pointcut-ref=&quot;pt&quot;/&gt; &lt;/aop:aspect&gt; &lt;/aop:config&gt;&lt;/beans&gt; æµ‹è¯•ç±» 1234567public class App &#123; public static void main(String[] args) &#123; ApplicationContext ctx = new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;); UserService userService = (UserService) ctx.getBean(&quot;userService&quot;); userService.save();//å…ˆè¾“å‡ºå…±æ€§åŠŸèƒ½ï¼Œç„¶å user service running... &#125;&#125; XMLå¼€å‘AspectJAspectï¼ˆåˆ‡é¢ï¼‰ç”¨äºæè¿°åˆ‡å…¥ç‚¹ä¸é€šçŸ¥é—´çš„å…³ç³»ï¼Œæ˜¯ AOP ç¼–ç¨‹ä¸­çš„ä¸€ä¸ªæ¦‚å¿µ AspectJ æ˜¯åŸºäº java è¯­è¨€å¯¹ Aspect çš„å®ç° AOPconfigæ ‡ç­¾ï¼šaop:configï¼Œ çš„å­æ ‡ç­¾ ä½œç”¨ï¼šè®¾ç½® AOP æ ¼å¼ï¼š 12345&lt;beans&gt; &lt;aop:config&gt;â€¦â€¦&lt;/aop:config&gt; &lt;aop:config&gt;â€¦â€¦&lt;/aop:config&gt; &lt;!--ä¸€ä¸ªbeansæ ‡ç­¾ä¸­å¯ä»¥é…ç½®å¤šä¸ªaop:configæ ‡ç­¾--&gt;&lt;/beans&gt; pointcutæ ‡ç­¾ï¼šaop:pointcutï¼Œå½’å±äº aop:config æ ‡ç­¾å’Œ aop:aspect æ ‡ç­¾ ä½œç”¨ï¼šè®¾ç½®åˆ‡å…¥ç‚¹ æ ¼å¼ï¼š 123456&lt;aop:config&gt; &lt;aop:pointcut id=&quot;pointcutId&quot; expression=&quot;â€¦â€¦&quot;/&gt; &lt;aop:aspect&gt; &lt;aop:pointcut id=&quot;pointcutId&quot; expression=&quot;â€¦â€¦&quot;/&gt; &lt;/aop:aspect&gt;&lt;/aop:config&gt; è¯´æ˜ï¼š ä¸€ä¸ª aop:config æ ‡ç­¾ä¸­å¯ä»¥é…ç½®å¤šä¸ª aop:pointcut æ ‡ç­¾ï¼Œä¸”è¯¥æ ‡ç­¾å¯ä»¥é…ç½®åœ¨ aop:aspect æ ‡ç­¾å†… å±æ€§ï¼š id ï¼šè¯†åˆ«åˆ‡å…¥ç‚¹çš„åç§° expression ï¼šåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ aspectæ ‡ç­¾ï¼šaop:aspectï¼Œaop:config çš„å­æ ‡ç­¾ ä½œç”¨ï¼šè®¾ç½®å…·ä½“çš„ AOP é€šçŸ¥å¯¹åº”çš„åˆ‡å…¥ç‚¹ï¼ˆåˆ‡é¢ï¼‰ æ ¼å¼ï¼š 12345&lt;aop:config&gt; &lt;aop:aspect ref=&quot;beanId&quot;&gt;â€¦â€¦&lt;/aop:aspect&gt; &lt;aop:aspect ref=&quot;beanId&quot;&gt;â€¦â€¦&lt;/aop:aspect&gt; &lt;!--ä¸€ä¸ªaop:configæ ‡ç­¾ä¸­å¯ä»¥é…ç½®å¤šä¸ªaop:aspectæ ‡ç­¾--&gt;&lt;/aop:config&gt; å±æ€§ï¼š ref ï¼šé€šçŸ¥æ‰€åœ¨çš„ bean çš„ id Pointcutåˆ‡å…¥ç‚¹åˆ‡å…¥ç‚¹æè¿°çš„æ˜¯æŸä¸ªæ–¹æ³• åˆ‡å…¥ç‚¹è¡¨è¾¾å¼æ˜¯ä¸€ä¸ªå¿«é€ŸåŒ¹é…æ–¹æ³•æè¿°çš„é€šé…æ ¼å¼ï¼Œç±»ä¼¼äºæ­£åˆ™è¡¨è¾¾å¼ è¡¨è¾¾å¼æ ¼å¼ï¼š 1å…³é”®å­—(è®¿é—®ä¿®é¥°ç¬¦ è¿”å›å€¼ åŒ…å.ç±»å.æ–¹æ³•å(å‚æ•°)å¼‚å¸¸å) ç¤ºä¾‹ï¼š 12//åŒ¹é…UserServiceä¸­åªå«æœ‰ä¸€ä¸ªå‚æ•°çš„findByIdæ–¹æ³•execution(public User service.UserService.findById(int)) æ ¼å¼è§£æï¼š å…³é”®å­—ï¼šæè¿°è¡¨è¾¾å¼çš„åŒ¹é…æ¨¡å¼ï¼ˆå‚çœ‹å…³é”®å­—åˆ—è¡¨ï¼‰ è®¿é—®ä¿®é¥°ç¬¦ï¼šæ–¹æ³•çš„è®¿é—®æ§åˆ¶æƒé™ä¿®é¥°ç¬¦ ç±»åï¼šæ–¹æ³•æ‰€åœ¨çš„ç±»ï¼ˆæ­¤å¤„å¯ä»¥é…ç½®æ¥å£åç§°ï¼‰ å¼‚å¸¸ï¼šæ–¹æ³•å®šä¹‰ä¸­æŒ‡å®šæŠ›å‡ºçš„å¼‚å¸¸ å…³é”®å­—ï¼š execution ï¼šåŒ¹é…æ‰§è¡ŒæŒ‡å®šæ–¹æ³• args ï¼šåŒ¹é…å¸¦æœ‰æŒ‡å®šå‚æ•°ç±»å‹çš„æ–¹æ³• withinã€thisã€targetã€@withinã€@targetã€@argsã€@annotationã€beanã€reference pointcutç­‰ é€šé…ç¬¦ï¼š *ï¼šå•ä¸ªç‹¬ç«‹çš„ä»»æ„ç¬¦å·ï¼Œå¯ä»¥ç‹¬ç«‹å‡ºç°ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºå‰ç¼€æˆ–è€…åç¼€çš„åŒ¹é…ç¬¦å‡ºç° 12//åŒ¹é…com.seazeanåŒ…ä¸‹çš„ä»»æ„åŒ…ä¸­çš„UserServiceç±»æˆ–æ¥å£ä¸­æ‰€æœ‰findå¼€å¤´çš„å¸¦æœ‰ä¸€ä¸ªä»»æ„å‚æ•°çš„æ–¹æ³•execution(public * com.seazean.*.UserService.find*(*) .. ï¼šå¤šä¸ªè¿ç»­çš„ä»»æ„ç¬¦å·ï¼Œå¯ä»¥ç‹¬ç«‹å‡ºç°ï¼Œå¸¸ç”¨äºç®€åŒ–åŒ…åä¸å‚æ•° 12//åŒ¹é…comåŒ…ä¸‹çš„ä»»æ„åŒ…ä¸­çš„UserServiceç±»æˆ–æ¥å£ä¸­æ‰€æœ‰åç§°ä¸ºfindByIdå‚æ•°ä»»æ„æ•°é‡å’Œç±»å‹çš„æ–¹æ³•execution(public User com..UserService.findById(..)) +ï¼šä¸“ç”¨äºåŒ¹é…å­ç±»ç±»å‹ 12//åŒ¹é…ä»»æ„åŒ…ä¸‹çš„Serviceç»“å°¾çš„ç±»æˆ–è€…æ¥å£çš„å­ç±»æˆ–è€…å®ç°ç±»execution(* *..*Service+.*(..)) é€»è¾‘è¿ç®—ç¬¦ï¼š &amp;&amp;ï¼šè¿æ¥ä¸¤ä¸ªåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œè¡¨ç¤ºä¸¤ä¸ªåˆ‡å…¥ç‚¹è¡¨è¾¾å¼åŒæ—¶æˆç«‹çš„åŒ¹é… ||ï¼šè¿æ¥ä¸¤ä¸ªåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œè¡¨ç¤ºä¸¤ä¸ªåˆ‡å…¥ç‚¹è¡¨è¾¾å¼æˆç«‹ä»»æ„ä¸€ä¸ªçš„åŒ¹é… ! ï¼šè¿æ¥å•ä¸ªåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œè¡¨ç¤ºè¯¥åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ä¸æˆç«‹çš„åŒ¹é… ç¤ºä¾‹ï¼š 1234567891011121314151617181920execution(* *(..)) //å‰ä¸‰ä¸ªéƒ½æ˜¯åŒ¹é…å…¨éƒ¨execution(* *..*(..))execution(* *..*.*(..))execution(public * *..*.*(..))execution(public int *..*.*(..))execution(public void *..*.*(..))execution(public void com..*.*(..)) execution(public void com..service.*.*(..))execution(public void com.seazean.service.*.*(..))execution(public void com.seazean.service.User*.*(..))execution(public void com.seazean.service.*Service.*(..))execution(public void com.seazean.service.UserService.*(..))execution(public User com.seazean.service.UserService.find*(..)) //findå¼€å¤´execution(public User com.seazean.service.UserService.*Id(..)) //Iexecution(public User com.seazean.service.UserService.findById(..))execution(public User com.seazean.service.UserService.findById(int))execution(public User com.seazean.service.UserService.findById(int,int))execution(public User com.seazean.service.UserService.findById(int,*))execution(public User com.seazean.service.UserService.findById())execution(List com.seazean.service.*Service+.findAll(..)) é…ç½®æ–¹å¼XML é…ç½®è§„åˆ™ï¼š ä¼ä¸šå¼€å‘å‘½åè§„èŒƒä¸¥æ ¼éµå¾ªè§„èŒƒæ–‡æ¡£è¿›è¡Œ å…ˆä¸ºæ–¹æ³•é…ç½®å±€éƒ¨åˆ‡å…¥ç‚¹ï¼Œå†æŠ½å–ç±»ä¸­å…¬å…±åˆ‡å…¥ç‚¹ï¼Œæœ€åæŠ½å–å…¨å±€åˆ‡å…¥ç‚¹ ä»£ç èµ°æŸ¥è¿‡ç¨‹ä¸­æ£€æµ‹åˆ‡å…¥ç‚¹æ˜¯å¦å­˜åœ¨è¶Šç•Œæ€§åŒ…å« ä»£ç èµ°æŸ¥è¿‡ç¨‹ä¸­æ£€æµ‹åˆ‡å…¥ç‚¹æ˜¯å¦å­˜åœ¨éåŒ…å«æ€§è¿›é©» è®¾å®š AOP æ‰§è¡Œæ£€æµ‹ç¨‹åºï¼Œåœ¨å•å…ƒæµ‹è¯•ä¸­ç›‘æ§é€šçŸ¥è¢«æ‰§è¡Œæ¬¡æ•°ä¸é¢„è®¡æ¬¡æ•°æ˜¯å¦åŒ¹é…ï¼ˆä¸ç»å¯¹æ­£ç¡®ï¼šåŠ è¿›ä¸€ä¸ªä¸è¯¥åŠ çš„ï¼Œåˆ å»ä¸€ä¸ªä¸è¯¥åˆ çš„ç›¸å½“äºç»“æœä¸å˜ï¼‰ è®¾å®šå®Œæ¯•çš„åˆ‡å…¥ç‚¹å¦‚æœå‘ç”Ÿè°ƒæ•´åŠ¡å¿…è¿›è¡Œå›å½’æµ‹è¯• 1234567891011121314&lt;aop:config&gt; &lt;!--1.é…ç½®å…¬å…±åˆ‡å…¥ç‚¹--&gt; &lt;aop:pointcut id=&quot;pt1&quot; expression=&quot;execution(* *(..))&quot;/&gt; &lt;aop:aspect ref=&quot;myAdvice&quot;&gt; &lt;!--2.é…ç½®å±€éƒ¨åˆ‡å…¥ç‚¹--&gt; &lt;aop:pointcut id=&quot;pt2&quot; expression=&quot;execution(* *(..))&quot;/&gt; &lt;!--å¼•ç”¨å…¬å…±åˆ‡å…¥ç‚¹--&gt; &lt;aop:before method=&quot;logAdvice&quot; pointcut-ref=&quot;pt1&quot;/&gt; &lt;!--å¼•ç”¨å±€éƒ¨åˆ‡å…¥ç‚¹--&gt; &lt;aop:before method=&quot;logAdvice&quot; pointcut-ref=&quot;pt2&quot;/&gt; &lt;!--3.ç›´æ¥é…ç½®åˆ‡å…¥ç‚¹--&gt; &lt;aop:before method=&quot;logAdvice&quot; pointcut=&quot;execution(* *(..))&quot;/&gt; &lt;/aop:aspect&gt;&lt;/aop:config&gt; Adviceé€šçŸ¥ç±»å‹AOP çš„é€šçŸ¥ç±»å‹å…±5ç§ï¼šå‰ç½®é€šçŸ¥ï¼Œåç½®é€šçŸ¥ã€è¿”å›åé€šçŸ¥ã€æŠ›å‡ºå¼‚å¸¸åé€šçŸ¥ã€ç¯ç»•é€šçŸ¥ beforeæ ‡ç­¾ï¼šaop:beforeï¼Œaop:aspectçš„å­æ ‡ç­¾ ä½œç”¨ï¼šè®¾ç½®å‰ç½®é€šçŸ¥ å‰ç½®é€šçŸ¥ï¼šåŸå§‹æ–¹æ³•æ‰§è¡Œå‰æ‰§è¡Œï¼Œå¦‚æœé€šçŸ¥ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œé˜»æ­¢åŸå§‹æ–¹æ³•è¿è¡Œ åº”ç”¨ï¼šæ•°æ®æ ¡éªŒ æ ¼å¼ï¼š 1234&lt;aop:aspect ref=&quot;adviceId&quot;&gt; &lt;aop:before method=&quot;methodName&quot; pointcut=&quot;execution(* *(..))&quot;/&gt; &lt;!--ä¸€ä¸ªaop:aspectæ ‡ç­¾ä¸­å¯ä»¥é…ç½®å¤šä¸ªaop:beforeæ ‡ç­¾--&gt;&lt;/aop:aspect&gt; åŸºæœ¬å±æ€§ï¼š methodï¼šåœ¨é€šçŸ¥ç±»ä¸­è®¾ç½®å½“å‰é€šçŸ¥ç±»åˆ«å¯¹åº”çš„æ–¹æ³• pointcutï¼šè®¾ç½®å½“å‰é€šçŸ¥å¯¹åº”çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œä¸pointcut-refå±æ€§å†²çª pointcut-refï¼šè®¾ç½®å½“å‰é€šçŸ¥å¯¹åº”çš„åˆ‡å…¥ç‚¹idï¼Œä¸pointcutå±æ€§å†²çª afteræ ‡ç­¾ï¼šaop:afterï¼Œaop:aspectçš„å­æ ‡ç­¾ ä½œç”¨ï¼šè®¾ç½®åç½®é€šçŸ¥ åç½®é€šçŸ¥ï¼šåŸå§‹æ–¹æ³•æ‰§è¡Œåæ‰§è¡Œï¼Œæ— è®ºåŸå§‹æ–¹æ³•ä¸­æ˜¯å¦å‡ºç°å¼‚å¸¸ï¼Œéƒ½å°†æ‰§è¡Œé€šçŸ¥ åº”ç”¨ï¼šç°åœºæ¸…ç† æ ¼å¼ï¼š 1234&lt;aop:aspect ref=&quot;adviceId&quot;&gt; &lt;aop:after method=&quot;methodName&quot; pointcut=&quot;execution(* *(..))&quot;/&gt; &lt;!--ä¸€ä¸ªaop:aspectæ ‡ç­¾ä¸­å¯ä»¥é…ç½®å¤šä¸ªaop:afteræ ‡ç­¾--&gt;&lt;/aop:aspect&gt; åŸºæœ¬å±æ€§ï¼š methodï¼šåœ¨é€šçŸ¥ç±»ä¸­è®¾ç½®å½“å‰é€šçŸ¥ç±»åˆ«å¯¹åº”çš„æ–¹æ³• pointcutï¼šè®¾ç½®å½“å‰é€šçŸ¥å¯¹åº”çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œä¸pointcut-refå±æ€§å†²çª pointcut-refï¼šè®¾ç½®å½“å‰é€šçŸ¥å¯¹åº”çš„åˆ‡å…¥ç‚¹idï¼Œä¸pointcutå±æ€§å†²çª after-ræ ‡ç­¾ï¼šaop:after-returningï¼Œaop:aspectçš„å­æ ‡ç­¾ ä½œç”¨ï¼šè®¾ç½®è¿”å›åé€šçŸ¥ è¿”å›åé€šçŸ¥ï¼šåŸå§‹æ–¹æ³•æ­£å¸¸æ‰§è¡Œå®Œæ¯•å¹¶è¿”å›ç»“æœåæ‰§è¡Œï¼Œå¦‚æœåŸå§‹æ–¹æ³•ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œæ— æ³•æ‰§è¡Œ åº”ç”¨ï¼šè¿”å›å€¼ç›¸å…³æ•°æ®å¤„ç† æ ¼å¼ï¼š 1234&lt;aop:aspect ref=&quot;adviceId&quot;&gt; &lt;aop:after-returning method=&quot;methodName&quot; pointcut=&quot;execution(* *(..))&quot;/&gt; &lt;!--ä¸€ä¸ªaop:aspectæ ‡ç­¾ä¸­å¯ä»¥é…ç½®å¤šä¸ªaop:after-returningæ ‡ç­¾--&gt;&lt;/aop:aspect&gt; åŸºæœ¬å±æ€§ï¼š methodï¼šåœ¨é€šçŸ¥ç±»ä¸­è®¾ç½®å½“å‰é€šçŸ¥ç±»åˆ«å¯¹åº”çš„æ–¹æ³• pointcutï¼šè®¾ç½®å½“å‰é€šçŸ¥å¯¹åº”çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œä¸pointcut-refå±æ€§å†²çª pointcut-refï¼šè®¾ç½®å½“å‰é€šçŸ¥å¯¹åº”çš„åˆ‡å…¥ç‚¹idï¼Œä¸pointcutå±æ€§å†²çª returningï¼šè®¾ç½®æ¥å—è¿”å›å€¼çš„å‚æ•°ï¼Œä¸é€šçŸ¥ç±»ä¸­å¯¹åº”æ–¹æ³•çš„å‚æ•°ä¸€è‡´ after-tæ ‡ç­¾ï¼šaop:after-throwingï¼Œaop:aspectçš„å­æ ‡ç­¾ ä½œç”¨ï¼šè®¾ç½®æŠ›å‡ºå¼‚å¸¸åé€šçŸ¥ æŠ›å‡ºå¼‚å¸¸åé€šçŸ¥ï¼šåŸå§‹æ–¹æ³•æŠ›å‡ºå¼‚å¸¸åæ‰§è¡Œï¼Œå¦‚æœåŸå§‹æ–¹æ³•æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ï¼Œæ— æ³•æ‰§è¡Œ åº”ç”¨ï¼šå¯¹åŸå§‹æ–¹æ³•ä¸­å‡ºç°çš„å¼‚å¸¸ä¿¡æ¯è¿›è¡Œå¤„ç† æ ¼å¼ï¼š 1234&lt;aop:aspect ref=&quot;adviceId&quot;&gt; &lt;aop:after-throwing method=&quot;methodName&quot; pointcut=&quot;execution(* *(..))&quot;/&gt; &lt;!--ä¸€ä¸ªaop:aspectæ ‡ç­¾ä¸­å¯ä»¥é…ç½®å¤šä¸ªaop:after-throwingæ ‡ç­¾--&gt;&lt;/aop:aspect&gt; åŸºæœ¬å±æ€§ï¼š methodï¼šåœ¨é€šçŸ¥ç±»ä¸­è®¾ç½®å½“å‰é€šçŸ¥ç±»åˆ«å¯¹åº”çš„æ–¹æ³• pointcutï¼šè®¾ç½®å½“å‰é€šçŸ¥å¯¹åº”çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œä¸pointcut-refå±æ€§å†²çª pointcut-refï¼šè®¾ç½®å½“å‰é€šçŸ¥å¯¹åº”çš„åˆ‡å…¥ç‚¹idï¼Œä¸pointcutå±æ€§å†²çª throwingï¼šè®¾ç½®æ¥å—å¼‚å¸¸å¯¹è±¡çš„å‚æ•°ï¼Œä¸é€šçŸ¥ç±»ä¸­å¯¹åº”æ–¹æ³•çš„å‚æ•°ä¸€è‡´ aroundæ ‡ç­¾ï¼šaop:aroundï¼Œaop:aspectçš„å­æ ‡ç­¾ ä½œç”¨ï¼šè®¾ç½®ç¯ç»•é€šçŸ¥ ç¯ç»•é€šçŸ¥ï¼šåœ¨åŸå§‹æ–¹æ³•æ‰§è¡Œå‰åå‡æœ‰å¯¹åº”æ‰§è¡Œæ‰§è¡Œï¼Œè¿˜å¯ä»¥é˜»æ­¢åŸå§‹æ–¹æ³•çš„æ‰§è¡Œ åº”ç”¨ï¼šåŠŸèƒ½å¼ºå¤§ï¼Œå¯ä»¥åšä»»ä½•äº‹æƒ… æ ¼å¼ï¼š 1234&lt;aop:aspect ref=&quot;adviceId&quot;&gt; &lt;aop:around method=&quot;methodName&quot; pointcut=&quot;execution(* *(..))&quot;/&gt; &lt;!--ä¸€ä¸ªaop:aspectæ ‡ç­¾ä¸­å¯ä»¥é…ç½®å¤šä¸ªaop:aroundæ ‡ç­¾--&gt;&lt;/aop:aspect&gt; åŸºæœ¬å±æ€§ï¼š method ï¼šåœ¨é€šçŸ¥ç±»ä¸­è®¾ç½®å½“å‰é€šçŸ¥ç±»åˆ«å¯¹åº”çš„æ–¹æ³• pointcut ï¼šè®¾ç½®å½“å‰é€šçŸ¥å¯¹åº”çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œä¸pointcut-refå±æ€§å†²çª pointcut-ref ï¼šè®¾ç½®å½“å‰é€šçŸ¥å¯¹åº”çš„åˆ‡å…¥ç‚¹idï¼Œä¸pointcutå±æ€§å†²çª ç¯ç»•é€šçŸ¥çš„å¼€å‘æ–¹å¼ï¼ˆå‚è€ƒé€šçŸ¥é¡ºåºç« èŠ‚ï¼‰ï¼š ç¯ç»•é€šçŸ¥æ˜¯åœ¨åŸå§‹æ–¹æ³•çš„å‰åæ·»åŠ åŠŸèƒ½ï¼Œåœ¨ç¯ç»•é€šçŸ¥ä¸­ï¼Œå­˜åœ¨å¯¹åŸå§‹æ–¹æ³•çš„æ˜¾å¼è°ƒç”¨ 1234public Object around(ProceedingJoinPoint pjp) throws Throwable &#123; Object ret = pjp.proceed(); return ret;&#125; ç¯ç»•é€šçŸ¥æ–¹æ³•ç›¸å…³è¯´æ˜ï¼š æ–¹æ³•é¡»è®¾å®š Object ç±»å‹çš„è¿”å›å€¼ï¼Œå¦åˆ™ä¼šæ‹¦æˆªåŸå§‹æ–¹æ³•çš„è¿”å›ã€‚å¦‚æœåŸå§‹æ–¹æ³•è¿”å›å€¼ç±»å‹ä¸º voidï¼Œé€šçŸ¥æ–¹æ³•ä¹Ÿå¯ä»¥è®¾å®šè¿”å›å€¼ç±»å‹ä¸º voidï¼Œæœ€ç»ˆè¿”å› null æ–¹æ³•éœ€åœ¨ç¬¬ä¸€ä¸ªå‚æ•°ä½ç½®è®¾å®š ProceedingJoinPoint å¯¹è±¡ï¼Œé€šè¿‡è¯¥å¯¹è±¡è°ƒç”¨ proceed() æ–¹æ³•ï¼Œå®ç°å¯¹åŸå§‹æ–¹æ³•çš„è°ƒç”¨ã€‚å¦‚çœç•¥è¯¥å‚æ•°ï¼ŒåŸå§‹æ–¹æ³•å°†æ— æ³•æ‰§è¡Œ ä½¿ç”¨ proceed() æ–¹æ³•è°ƒç”¨åŸå§‹æ–¹æ³•æ—¶ï¼Œå› æ— æ³•é¢„çŸ¥åŸå§‹æ–¹æ³•è¿è¡Œè¿‡ç¨‹ä¸­æ˜¯å¦ä¼šå‡ºç°å¼‚å¸¸ï¼Œå¼ºåˆ¶æŠ›å‡º Throwable å¯¹è±¡ï¼Œå°è£…åŸå§‹æ–¹æ³•ä¸­å¯èƒ½å‡ºç°çš„å¼‚å¸¸ä¿¡æ¯ é€šçŸ¥é¡ºåºå½“åŒä¸€ä¸ªåˆ‡å…¥ç‚¹é…ç½®äº†å¤šä¸ªé€šçŸ¥æ—¶ï¼Œé€šçŸ¥ä¼šå­˜åœ¨è¿è¡Œçš„å…ˆåé¡ºåºï¼Œè¯¥é¡ºåºä»¥é€šçŸ¥é…ç½®çš„é¡ºåºä¸ºå‡†ã€‚ AOPAdvice 123456789101112131415161718192021public class AOPAdvice &#123; public void before()&#123; System.out.println(&quot;before...); &#125; public void after()&#123; System.out.println(&quot;after...&quot;); &#125; public void afterReturing()&#123; System.out.println(&quot;afterReturing...&quot;); &#125; public void afterThrowing()&#123; System.out.println(&quot;afterThrowing...&quot;); &#125; public Object around(ProceedingJoinPoint pjp) &#123; System.out.println(&quot;around before...&quot;); //å¯¹åŸå§‹æ–¹æ³•çš„è°ƒç”¨ Object ret = pjp.proceed(); System.out.println(&quot;around after...&quot;+ret); return ret; &#125;&#125; applicationContext.xml é¡ºåºæ‰§è¡Œ 12345678910&lt;aop:config&gt; &lt;aop:pointcut id=&quot;pt&quot; expression=&quot;execution(* *..*(..))&quot;/&gt; &lt;aop:aspect ref=&quot;myAdvice&quot;&gt; &lt;aop:before method=&quot;before&quot; pointcut-ref=&quot;pt&quot;/&gt; &lt;aop:after method=&quot;after&quot; pointcut-ref=&quot;pt&quot;/&gt; &lt;aop:after-returning method=&quot;afterReturing&quot; pointcut-ref=&quot;pt&quot;/&gt; &lt;aop:after-throwing method=&quot;afterThrowing&quot; pointcut-ref=&quot;pt&quot;/&gt; &lt;aop:around method=&quot;around&quot; pointcut-ref=&quot;pt&quot;/&gt; &lt;/aop:aspect&gt;&lt;/aop:config&gt; è·å–æ•°æ®å‚æ•°ç¬¬ä¸€ç§æ–¹å¼ï¼š è®¾å®šé€šçŸ¥æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°ä¸º JoinPointï¼Œé€šè¿‡è¯¥å¯¹è±¡è°ƒç”¨ getArgs() æ–¹æ³•ï¼Œè·å–åŸå§‹æ–¹æ³•è¿è¡Œçš„å‚æ•°æ•°ç»„ 123public void before(JoinPoint jp) throws Throwable &#123; Object[] args = jp.getArgs();&#125; æ‰€æœ‰çš„é€šçŸ¥å‡å¯ä»¥è·å–å‚æ•°ï¼Œç¯ç»•é€šçŸ¥ä½¿ç”¨ProceedingJoinPoint.getArgs()æ–¹æ³• ç¬¬äºŒç§æ–¹å¼ï¼š è®¾å®šåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ä¸ºé€šçŸ¥æ–¹æ³•ä¼ é€’å‚æ•°ï¼ˆé”å®šé€šçŸ¥å˜é‡åï¼‰ æµç¨‹å›¾ï¼š è§£é‡Šï¼š &amp;amp ä»£è¡¨å¹¶ä¸” &amp; è¾“å‡ºç»“æœï¼ša &#x3D; param1 b &#x3D; param2 ç¬¬ä¸‰ç§æ–¹å¼ï¼š è®¾å®šåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ä¸ºé€šçŸ¥æ–¹æ³•ä¼ é€’å‚æ•°ï¼ˆæ”¹å˜é€šçŸ¥å˜é‡åçš„å®šä¹‰é¡ºåºï¼‰ æµç¨‹å›¾ï¼š è§£é‡Šï¼šè¾“å‡ºç»“æœ a &#x3D; param2 b &#x3D; param1 è¿”å›å€¼ç¯ç»•é€šçŸ¥å’Œè¿”å›åé€šçŸ¥å¯ä»¥è·å–è¿”å›å€¼ï¼Œåç½®é€šçŸ¥ä¸ä¸€å®šï¼Œå…¶ä»–ç±»å‹è·å–ä¸åˆ° ç¬¬ä¸€ç§æ–¹å¼ï¼šé€‚ç”¨äºè¿”å›åé€šçŸ¥ï¼ˆafter-returningï¼‰ è®¾å®šè¿”å›å€¼å˜é‡å åŸå§‹æ–¹æ³•ï¼š 1234567public class UserServiceImpl implements UserService &#123; @Override public int save() &#123; System.out.println(&quot;user service running...&quot;); return 100; &#125;&#125; AOP é…ç½®ï¼š 1234&lt;aop:aspect ref=&quot;myAdvice&quot;&gt; &lt;aop:pointcut id=&quot;pt&quot; expression=&quot;execution(* *(..))&quot;/&gt; &lt;aop:after-returning method=&quot;afterReturning&quot; pointcut-ref=&quot;pt&quot; returning=&quot;ret&quot;/&gt;&lt;/aop:aspect&gt; é€šçŸ¥ç±»ï¼š 12345public class AOPAdvice &#123; public void afterReturning(Object ret) &#123; System.out.println(&quot;return:&quot; + ret); &#125;&#125; ç¬¬äºŒç§ï¼šé€‚ç”¨äºç¯ç»•é€šçŸ¥ï¼ˆaroundï¼‰ åœ¨é€šçŸ¥ç±»çš„æ–¹æ³•ä¸­è°ƒç”¨åŸå§‹æ–¹æ³•è·å–è¿”å›å€¼ åŸå§‹æ–¹æ³•ï¼š 1234567public class UserServiceImpl implements UserService &#123; @Override public int save() &#123; System.out.println(&quot;user service running...&quot;); return 100; &#125;&#125; AOP é…ç½®ï¼š 1234&lt;aop:aspect ref=&quot;myAdvice&quot;&gt; &lt;aop:pointcut id=&quot;pt&quot; expression=&quot;execution(* *(..)) &quot;/&gt; &lt;aop:around method=&quot;around&quot; pointcut-ref=&quot;pt&quot; /&gt;&lt;/aop:aspect&gt; é€šçŸ¥ç±»ï¼š 123456public class AOPAdvice &#123; public Object around(ProceedingJoinPoint pjp) throws Throwable &#123; Object ret = pjp.proceed(); return ret; &#125;&#125; æµ‹è¯•ç±»ï¼š 12345678public class App &#123; public static void main(String[] args) &#123; ApplicationContext ctx = new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;); UserService userService = (UserService) ctx.getBean(&quot;userService&quot;); int ret = userService.save(); System.out.println(&quot;app.....&quot; + ret); &#125;&#125; å¼‚å¸¸ç¯ç»•é€šçŸ¥å’ŒæŠ›å‡ºå¼‚å¸¸åé€šçŸ¥å¯ä»¥è·å–å¼‚å¸¸ï¼Œåç½®é€šçŸ¥ä¸ä¸€å®šï¼Œå…¶ä»–ç±»å‹è·å–ä¸åˆ° ç¬¬ä¸€ç§ï¼šé€‚ç”¨äºè¿”å›åé€šçŸ¥ï¼ˆafter-throwingï¼‰ è®¾å®šå¼‚å¸¸å¯¹è±¡å˜é‡å åŸå§‹æ–¹æ³• 1234567public class UserServiceImpl implements UserService &#123; @Override public void save() &#123; System.out.println(&quot;user service running...&quot;); int i = 1/0; &#125;&#125; AOP é…ç½® 1234&lt;aop:aspect ref=&quot;myAdvice&quot;&gt; &lt;aop:pointcut id=&quot;pt&quot; expression=&quot;execution(* *(..)) &quot;/&gt; &lt;aop:after-throwing method=&quot;afterThrowing&quot; pointcut-ref=&quot;pt&quot; throwing=&quot;t&quot;/&gt;&lt;/aop:aspect&gt; é€šçŸ¥ç±» 123public void afterThrowing(Throwable t)&#123; System.out.println(t.getMessage());&#125; ç¬¬äºŒç§ï¼šé€‚ç”¨äºç¯ç»•é€šçŸ¥ï¼ˆaroundï¼‰ åœ¨é€šçŸ¥ç±»çš„æ–¹æ³•ä¸­è°ƒç”¨åŸå§‹æ–¹æ³•æ•è·å¼‚å¸¸ åŸå§‹æ–¹æ³•ï¼š 1234567public class UserServiceImpl implements UserService &#123; @Override public void save() &#123; System.out.println(&quot;user service running...&quot;); int i = 1/0; &#125;&#125; AOP é…ç½®ï¼š 1234&lt;aop:aspect ref=&quot;myAdvice&quot;&gt; &lt;aop:pointcut id=&quot;pt&quot; expression=&quot;execution(* *(..)) &quot;/&gt; &lt;aop:around method=&quot;around&quot; pointcut-ref=&quot;pt&quot; /&gt;&lt;/aop:aspect&gt; é€šçŸ¥ç±»ï¼štryâ€¦â€¦catchâ€¦â€¦æ•è·å¼‚å¸¸åï¼Œretä¸ºnull 123456789public Object around(ProceedingJoinPoint pjp) throws Throwable &#123; Object ret = pjp.proceed(); //å¯¹æ­¤å¤„è°ƒç”¨è¿›è¡Œtryâ€¦â€¦catchâ€¦â€¦æ•è·å¼‚å¸¸ï¼Œæˆ–æŠ›å‡ºå¼‚å¸¸ /* try &#123; ret = pjp.proceed(); &#125; catch (Throwable throwable) &#123; System.out.println(&quot;around exception...&quot; + throwable.getMessage()); &#125;*/ return ret;&#125; æµ‹è¯•ç±» 1userService.delete(); è·å–å…¨éƒ¨ UserService 1234567public interface UserService &#123; public void save(int i, int m); public int update(); public void delete();&#125; 123456789101112131415161718public class UserServiceImpl implements UserService &#123; @Override public void save(int i, int m) &#123; System.out.println(&quot;user service running...&quot; + i + &quot;,&quot; + m); &#125; @Override public int update() &#123; System.out.println(&quot;user service update running...&quot;); return 100; &#125; @Override public void delete() &#123; System.out.println(&quot;user service delete running...&quot;); int i = 1 / 0; &#125;&#125; AOPAdvice 123456789101112131415161718192021222324252627282930313233public class AOPAdvice &#123; public void before(JoinPoint jp)&#123; //é€šè¿‡JoinPointå‚æ•°è·å–è°ƒç”¨åŸå§‹æ–¹æ³•æ‰€æºå¸¦çš„å‚æ•° Object[] args = jp.getArgs(); System.out.println(&quot;before...&quot;+args[0]); &#125; public void after(JoinPoint jp)&#123; Object[] args = jp.getArgs(); System.out.println(&quot;after...&quot;+args[0]); &#125; public void afterReturing(Object ret)&#123; System.out.println(&quot;afterReturing...&quot;+ret); &#125; public void afterThrowing(Throwable t)&#123; System.out.println(&quot;afterThrowing...&quot;+t.getMessage()); &#125; public Object around(ProceedingJoinPoint pjp) &#123; System.out.println(&quot;around before...&quot;); Object ret = null; try &#123; //å¯¹åŸå§‹æ–¹æ³•çš„è°ƒç”¨ ret = pjp.proceed(); &#125; catch (Throwable throwable) &#123; System.out.println(&quot;around...exception....&quot;+throwable.getMessage()); &#125; System.out.println(&quot;around after...&quot;+ret); return ret; &#125;&#125; applicationContext.xml 123456789101112131415161718192021222324252627&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:context=&quot;http://www.springframework.org/schema/context&quot; xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot; xsi:schemaLocation=&quot; http://www.springframework.org/schema/beans https://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/aop https://www.springframework.org/schema/aop/spring-aop.xsd &quot;&gt; &lt;bean id=&quot;userService&quot; class=&quot;service.impl.UserServiceImpl&quot;/&gt; &lt;bean id=&quot;myAdvice&quot; class=&quot;aop.AOPAdvice&quot;/&gt; &lt;aop:config&gt; &lt;aop:pointcut id=&quot;pt&quot; expression=&quot;execution(* *..*(..))&quot;/&gt; &lt;aop:aspect ref=&quot;myAdvice&quot;&gt; &lt;aop:before method=&quot;before&quot; pointcut=&quot;pt&quot;/&gt; &lt;aop:around method=&quot;around&quot; pointcut-ref=&quot;pt&quot;/&gt; &lt;aop:after method=&quot;after&quot; pointcut=&quot;pt&quot;/&gt; &lt;aop:after-returning method=&quot;afterReturning&quot; pointcut-ref=&quot;pt&quot; returning=&quot;ret&quot;/&gt; &lt;aop:after-throwing method=&quot;afterThrowing&quot; pointcut-ref=&quot;pt&quot; throwing=&quot;t&quot;/&gt; &lt;/aop:aspect&gt; &lt;/aop:config&gt;&lt;/beans&gt; æµ‹è¯•ç±» 12345678910public class App &#123; public static void main(String[] args) &#123; ApplicationContext ctx = new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;); UserService userService = (UserService) ctx.getBean(&quot;userService&quot;);// userService.save(666, 888);// int ret = userService.update();// System.out.println(&quot;app.....&quot; + ret); userService.delete(); &#125;&#125; æ³¨è§£å¼€å‘AOPæ³¨è§£AOP æ³¨è§£ç®€åŒ– XMLï¼š æ³¨æ„äº‹é¡¹ï¼š åˆ‡å…¥ç‚¹æœ€ç»ˆä½“ç°ä¸ºä¸€ä¸ªæ–¹æ³•ï¼Œæ— å‚æ— è¿”å›å€¼ï¼Œæ— å®é™…æ–¹æ³•ä½“å†…å®¹ï¼Œä½†ä¸èƒ½æ˜¯æŠ½è±¡æ–¹æ³• å¼•ç”¨åˆ‡å…¥ç‚¹æ—¶å¿…é¡»ä½¿ç”¨æ–¹æ³•è°ƒç”¨åç§°ï¼Œæ–¹æ³•åé¢çš„ () ä¸èƒ½çœç•¥ åˆ‡é¢ç±»ä¸­å®šä¹‰çš„åˆ‡å…¥ç‚¹åªèƒ½åœ¨å½“å‰ç±»ä¸­ä½¿ç”¨ï¼Œå¦‚æœæƒ³å¼•ç”¨å…¶ä»–ç±»ä¸­å®šä¹‰çš„åˆ‡å…¥ç‚¹ä½¿ç”¨â€œç±»å.æ–¹æ³•å()â€å¼•ç”¨ å¯ä»¥åœ¨é€šçŸ¥ç±»å‹æ³¨è§£åæ·»åŠ å‚æ•°ï¼Œå®ç° XML é…ç½®ä¸­çš„å±æ€§ï¼Œä¾‹å¦‚ after-returning åçš„ returning æ€§ å¯åŠ¨æ³¨è§£XMLå¼€å¯ AOP æ³¨è§£æ”¯æŒï¼š 12&lt;aop:aspectj-autoproxy/&gt;&lt;context:component-scan base-package=&quot;aop,config,service&quot;/&gt;&lt;!--å¯åŠ¨Springæ‰«æ--&gt; å¼€å‘æ­¥éª¤ï¼š å¯¼å…¥åæ ‡ï¼ˆä¼´éš spring-context åæ ‡å¯¼å…¥å·²ç»ä¾èµ–å¯¼å…¥å®Œæˆï¼‰ å¼€å¯ AOP æ³¨è§£æ”¯æŒ é…ç½®åˆ‡é¢ @Aspect å®šä¹‰ä¸“ç”¨çš„åˆ‡å…¥ç‚¹æ–¹æ³•ï¼Œå¹¶é…ç½®åˆ‡å…¥ç‚¹ @Pointcut ä¸ºé€šçŸ¥æ–¹æ³•é…ç½®é€šçŸ¥ç±»å‹åŠå¯¹åº”åˆ‡å…¥ç‚¹ @Before çº¯æ³¨è§£æ³¨è§£ï¼š@EnableAspectJAutoProxy ä½ç½®ï¼šSpring æ³¨è§£é…ç½®ç±»å®šä¹‰ä¸Šæ–¹ ä½œç”¨ï¼šè®¾ç½®å½“å‰ç±»å¼€å¯ AOP æ³¨è§£é©±åŠ¨çš„æ”¯æŒï¼ŒåŠ è½½ AOP æ³¨è§£ æ ¼å¼ï¼š 12345@Configuration@ComponentScan(&quot;com.seazean&quot;)@EnableAspectJAutoProxypublic class SpringConfig &#123;&#125; åŸºæœ¬æ³¨è§£Aspectæ³¨è§£ï¼š@Aspect ä½ç½®ï¼šç±»å®šä¹‰ä¸Šæ–¹ ä½œç”¨ï¼šè®¾ç½®å½“å‰ç±»ä¸ºåˆ‡é¢ç±» æ ¼å¼ï¼š 123@Aspectpublic class AopAdvice &#123;&#125; Pointcutæ³¨è§£ï¼š@Pointcut ä½ç½®ï¼šæ–¹æ³•å®šä¹‰ä¸Šæ–¹ ä½œç”¨ï¼šä½¿ç”¨å½“å‰æ–¹æ³•åä½œä¸ºåˆ‡å…¥ç‚¹å¼•ç”¨åç§° æ ¼å¼ï¼š 123@Pointcut(&quot;execution(* *(..))&quot;)public void pt() &#123;&#125; è¯´æ˜ï¼šè¢«ä¿®é¥°çš„æ–¹æ³•å¿½ç•¥å…¶ä¸šåŠ¡åŠŸèƒ½ï¼Œæ ¼å¼è®¾å®šä¸ºæ— å‚æ— è¿”å›å€¼çš„æ–¹æ³•ï¼Œæ–¹æ³•ä½“å†…ç©ºå®ç°ï¼ˆéæŠ½è±¡ï¼‰ Beforeæ³¨è§£ï¼š@Before ä½ç½®ï¼šæ–¹æ³•å®šä¹‰ä¸Šæ–¹ ä½œç”¨ï¼šæ ‡æ³¨å½“å‰æ–¹æ³•ä½œä¸ºå‰ç½®é€šçŸ¥ æ ¼å¼ï¼š 1234@Before(&quot;pt()&quot;)public void before(JoinPoint joinPoint)&#123; //joinPoint.getArgs();&#125; æ³¨æ„ï¼šå¤šä¸ªå‚æ•°æ—¶ï¼ŒJoinPointå‚æ•°ä¸€å®šè¦åœ¨ç¬¬ä¸€ä½ Afteræ³¨è§£ï¼š@After ä½ç½®ï¼šæ–¹æ³•å®šä¹‰ä¸Šæ–¹ ä½œç”¨ï¼šæ ‡æ³¨å½“å‰æ–¹æ³•ä½œä¸ºåç½®é€šçŸ¥ æ ¼å¼ï¼š 123@After(&quot;pt()&quot;)public void after()&#123;&#125; AfterRæ³¨è§£ï¼š@AfterReturning ä½ç½®ï¼šæ–¹æ³•å®šä¹‰ä¸Šæ–¹ ä½œç”¨ï¼šæ ‡æ³¨å½“å‰æ–¹æ³•ä½œä¸ºè¿”å›åé€šçŸ¥ æ ¼å¼ï¼š 123@AfterReturning(value=&quot;pt()&quot;, returning = &quot;result&quot;)public void afterReturning(Object result) &#123;&#125; ç‰¹æ®Šå‚æ•°ï¼š returning ï¼šè®¾å®šä½¿ç”¨é€šçŸ¥æ–¹æ³•å‚æ•°æ¥æ”¶è¿”å›å€¼çš„å˜é‡å AfterTæ³¨è§£ï¼š@AfterThrowing ä½ç½®ï¼šæ–¹æ³•å®šä¹‰ä¸Šæ–¹ ä½œç”¨ï¼šæ ‡æ³¨å½“å‰æ–¹æ³•ä½œä¸ºå¼‚å¸¸åé€šçŸ¥ æ ¼å¼ï¼š 123@AfterThrowing(value=&quot;pt()&quot;, throwing = &quot;t&quot;)public void afterThrowing(Throwable t)&#123;&#125; ç‰¹æ®Šå‚æ•°ï¼š throwing ï¼šè®¾å®šä½¿ç”¨é€šçŸ¥æ–¹æ³•å‚æ•°æ¥æ”¶åŸå§‹æ–¹æ³•ä¸­æŠ›å‡ºçš„å¼‚å¸¸å¯¹è±¡å Aroundæ³¨è§£ï¼š@Around ä½ç½®ï¼šæ–¹æ³•å®šä¹‰ä¸Šæ–¹ ä½œç”¨ï¼šæ ‡æ³¨å½“å‰æ–¹æ³•ä½œä¸ºç¯ç»•é€šçŸ¥ æ ¼å¼ï¼š 12345@Around(&quot;pt()&quot;)public Object around(ProceedingJoinPoint pjp) throws Throwable &#123; Object ret = pjp.proceed(); return ret;&#125; æ‰§è¡Œé¡ºåºAOP ä½¿ç”¨ XML é…ç½®æƒ…å†µä¸‹ï¼Œé€šçŸ¥çš„æ‰§è¡Œé¡ºåºç”±é…ç½®é¡ºåºå†³å®šï¼Œåœ¨æ³¨è§£æƒ…å†µä¸‹ç”±äºä¸å­˜åœ¨é…ç½®é¡ºåºçš„æ¦‚å¿µï¼Œå‚ç…§é€šçŸ¥æ‰€é…ç½®çš„æ–¹æ³•åå­—ç¬¦ä¸²å¯¹åº”çš„ç¼–ç å€¼é¡ºåºï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºå­—æ¯æ’åº åŒä¸€ä¸ªé€šçŸ¥ç±»ä¸­ï¼Œç›¸åŒé€šçŸ¥ç±»å‹ä»¥æ–¹æ³•åæ’åºä¸ºå‡† 12345@Before(&quot;aop.AOPPointcut.pt()&quot;)public void aop001Log()&#123;&#125;@Before(&quot;aop.AOPPointcut.pt()&quot;)public void aop002Exception()&#123;&#125; ä¸åŒé€šçŸ¥ç±»ä¸­ï¼Œä»¥ç±»åæ’åºä¸ºå‡† ä½¿ç”¨ @Order æ³¨è§£é€šè¿‡å˜æ›´ bean çš„åŠ è½½é¡ºåºæ”¹å˜é€šçŸ¥çš„åŠ è½½é¡ºåº 12345@Component@Aspect@Order(1) //å…ˆæ‰§è¡Œpublic class AOPAdvice2 &#123;&#125; 12345@Component@Aspect@Order(2) public class AOPAdvice1 &#123;//é»˜è®¤æ‰§è¡Œæ­¤é€šçŸ¥&#125; AOP åŸç†é™æ€ä»£ç†è£…é¥°è€…æ¨¡å¼ï¼ˆDecorator Patternï¼‰ï¼šåœ¨ä¸æƒŠåŠ¨åŸå§‹è®¾è®¡çš„åŸºç¡€ä¸Šï¼Œä¸ºå…¶æ·»åŠ åŠŸèƒ½ 1234567891011121314public class UserServiceDecorator implements UserService&#123; private UserService userService; public UserServiceDecorator(UserService userService) &#123; this.userService = userService; &#125; public void save() &#123; //åŸå§‹è°ƒç”¨ userService.save(); //å¢å¼ºåŠŸèƒ½ï¼ˆåç½®ï¼‰ System.out.println(&quot;åç½®å¢å¼ºåŠŸèƒ½&quot;); &#125;&#125; ProxyJDKProxy åŠ¨æ€ä»£ç†æ˜¯é’ˆå¯¹å¯¹è±¡åšä»£ç†ï¼Œè¦æ±‚åŸå§‹å¯¹è±¡å…·æœ‰æ¥å£å®ç°ï¼Œå¹¶å¯¹æ¥å£æ–¹æ³•è¿›è¡Œå¢å¼ºï¼Œå› ä¸ºä»£ç†ç±»ç»§æ‰¿Proxy é™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†çš„åŒºåˆ«ï¼š é™æ€ä»£ç†æ˜¯åœ¨ç¼–è¯‘æ—¶å°±å·²ç»å°†æ¥å£ã€ä»£ç†ç±»ã€è¢«ä»£ç†ç±»çš„å­—èŠ‚ç æ–‡ä»¶ç¡®å®šä¸‹æ¥ åŠ¨æ€ä»£ç†æ˜¯ç¨‹åºåœ¨è¿è¡Œåé€šè¿‡åå°„åˆ›å»ºå­—èŠ‚ç æ–‡ä»¶äº¤ç”± JVM åŠ è½½ 1234567891011121314151617181920public class UserServiceJDKProxy &#123; public static UserService createUserServiceJDKProxy(UserService userService) &#123; UserService service = (UserService) Proxy.newProxyInstance( userService.getClass().getClassLoader(),//è·å–è¢«ä»£ç†å¯¹è±¡çš„ç±»åŠ è½½å™¨ userService.getClass().getInterfaces(), //è·å–è¢«ä»£ç†å¯¹è±¡å®ç°çš„æ¥å£ new InvocationHandler() &#123; //å¯¹åŸå§‹æ–¹æ³•æ‰§è¡Œè¿›è¡Œæ‹¦æˆªå¹¶å¢å¼º @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; if (method.getName().equals(&quot;save&quot;)) &#123; System.out.println(&quot;å‰ç½®å¢å¼º&quot;); Object ret = method.invoke(userService, args); System.out.println(&quot;åç½®å¢å¼º&quot;); return ret; &#125; return null; &#125; &#125;); return service; &#125;&#125; CGLIBCGLIBï¼ˆCode Generation Libraryï¼‰ï¼šCode ç”Ÿæˆç±»åº“ CGLIB ç‰¹ç‚¹ï¼š CGLIB åŠ¨æ€ä»£ç†ä¸é™å®šæ˜¯å¦å…·æœ‰æ¥å£ï¼Œå¯ä»¥å¯¹ä»»æ„æ“ä½œè¿›è¡Œå¢å¼º CGLIB åŠ¨æ€ä»£ç†æ— éœ€è¦åŸå§‹è¢«ä»£ç†å¯¹è±¡ï¼ŒåŠ¨æ€åˆ›å»ºå‡ºæ–°çš„ä»£ç†å¯¹è±¡ CGLIB ç»§æ‰¿è¢«ä»£ç†ç±»ï¼Œå¦‚æœä»£ç†ç±»æ˜¯ final åˆ™ä¸èƒ½å®ç° CGLIB ç±» JDKProxy ä»…å¯¹æ¥å£æ–¹æ³•åšå¢å¼ºï¼ŒCGLIB å¯¹æ‰€æœ‰æ–¹æ³•åšå¢å¼ºï¼ŒåŒ…æ‹¬ Object ç±»ä¸­çš„æ–¹æ³•ï¼ˆtoStringã€hashCodeï¼‰ è¿”å›å€¼ç±»å‹é‡‡ç”¨å¤šæ€å‘ä¸‹è½¬å‹ï¼Œæ‰€ä»¥éœ€è¦è®¾ç½®çˆ¶ç±»ç±»å‹ éœ€è¦å¯¹æ–¹æ³•è¿›è¡Œåˆ¤æ–­æ˜¯å¦æ˜¯ saveï¼Œæ¥é€‰æ‹©æ€§å¢å¼º 1234567891011121314151617181920212223242526public class UserServiceImplCglibProxy &#123; public static UserService createUserServiceCglibProxy(Class cls)&#123; //1.åˆ›å»ºEnhancerå¯¹è±¡ï¼ˆå¯ä»¥ç†è§£ä¸ºå†…å­˜ä¸­åŠ¨æ€åˆ›å»ºäº†ä¸€ä¸ªç±»çš„å­—èŠ‚ç ï¼‰ Enhancer enhancer = new Enhancer(); //2.è®¾ç½®Enhancerå¯¹è±¡çš„çˆ¶ç±»æ˜¯æŒ‡å®šç±»å‹UserServerImpl enhancer.setSuperclass(cls); //3.è®¾ç½®å›è°ƒæ–¹æ³• enhancer.setCallback(new MethodInterceptor() &#123; @Override public Object intercept(Object o, Method m, Object[] args, MethodProxy mp) throws Throwable &#123; //oæ˜¯è¢«ä»£ç†å‡ºçš„ç±»åˆ›å»ºçš„å¯¹è±¡ï¼Œæ‰€ä»¥ä½¿ç”¨MethodProxyè°ƒç”¨ï¼Œå¹¶ä¸”æ˜¯è°ƒç”¨çˆ¶ç±» //é€šè¿‡è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•å®ç°å¯¹åŸå§‹æ–¹æ³•çš„è°ƒç”¨ Object ret = methodProxy.invokeSuper(o, args); //åç½®å¢å¼ºå†…å®¹,éœ€è¦åˆ¤æ–­æ˜¯éƒ½æ˜¯saveæ–¹æ³• if (method.getName().equals(&quot;save&quot;)) &#123; System.out.println(&quot;I love Java&quot;); &#125; return ret; &#125; &#125;); //ä½¿ç”¨Enhancerå¯¹è±¡åˆ›å»ºå¯¹åº”çš„å¯¹è±¡ return (UserService)enhancer.create(); &#125;&#125; Testç±» 123456public class App &#123; public static void main(String[] args) &#123; UserService userService = UserServiceCglibProxy.createUserServiceCglibProxy(UserServiceImpl.class); userService.save(); &#125;&#125; ä»£ç†é€‰æ‹©Spirng å¯ä»¥é€šè¿‡é…ç½®çš„å½¢å¼æ§åˆ¶ä½¿ç”¨çš„ä»£ç†å½¢å¼ï¼ŒSpring ä¼šå…ˆåˆ¤æ–­æ˜¯å¦å®ç°äº†æ¥å£ï¼Œå¦‚æœå®ç°äº†æ¥å£å°±ä½¿ç”¨ JDK åŠ¨æ€ä»£ç†ï¼Œå¦‚æœæ²¡æœ‰å®ç°æ¥å£åˆ™ä½¿ç”¨ CGLIB åŠ¨æ€ä»£ç†ï¼Œé€šè¿‡é…ç½®å¯ä»¥ä¿®æ”¹ä¸ºä½¿ç”¨ CGLIB XML é…ç½® 12&lt;!--XMLé…ç½®AOP--&gt;&lt;aop:config proxy-target-class=&quot;false&quot;&gt;&lt;/aop:config&gt; XML æ³¨è§£æ”¯æŒ 12&lt;!--æ³¨è§£é…ç½®AOP--&gt;&lt;aop:aspectj-autoproxy proxy-target-class=&quot;false&quot;/&gt; æ³¨è§£é©±åŠ¨ 12//ä¿®æ”¹ä¸ºä½¿ç”¨ cglib åˆ›å»ºä»£ç†å¯¹è±¡@EnableAspectJAutoProxy(proxyTargetClass = true) JDK åŠ¨æ€ä»£ç†å’Œ CGLIB åŠ¨æ€ä»£ç†çš„åŒºåˆ«ï¼š JDK åŠ¨æ€ä»£ç†åªèƒ½å¯¹å®ç°äº†æ¥å£çš„ç±»ç”Ÿæˆä»£ç†ï¼Œæ²¡æœ‰å®ç°æ¥å£çš„ç±»ä¸èƒ½ä½¿ç”¨ã€‚ CGLIB åŠ¨æ€ä»£ç†å³ä½¿è¢«ä»£ç†çš„ç±»æ²¡æœ‰å®ç°æ¥å£ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œå› ä¸º CGLIB åŠ¨æ€ä»£ç†æ˜¯ä½¿ç”¨ç»§æ‰¿è¢«ä»£ç†ç±»çš„æ–¹å¼è¿›è¡Œæ‰©å±• CGLIB åŠ¨æ€ä»£ç†æ˜¯é€šè¿‡ç»§æ‰¿çš„æ–¹å¼ï¼Œè¦†ç›–è¢«ä»£ç†ç±»çš„æ–¹æ³•æ¥è¿›è¡Œä»£ç†ï¼Œæ‰€ä»¥å¦‚æœæ–¹æ³•æ˜¯è¢« final ä¿®é¥°çš„è¯ï¼Œå°±ä¸èƒ½è¿›è¡Œä»£ç† ç»‡å…¥æ—¶æœº äº‹åŠ¡äº‹åŠ¡æœºåˆ¶äº‹åŠ¡ä»‹ç»äº‹åŠ¡ï¼šæ•°æ®åº“ä¸­å¤šä¸ªæ“ä½œåˆå¹¶åœ¨ä¸€èµ·å½¢æˆçš„æ“ä½œåºåˆ—ï¼Œäº‹åŠ¡ç‰¹å¾ï¼ˆACIDï¼‰ ä½œç”¨ï¼š å½“æ•°æ®åº“æ“ä½œåºåˆ—ä¸­ä¸ªåˆ«æ“ä½œå¤±è´¥æ—¶ï¼Œæä¾›ä¸€ç§æ–¹å¼ä½¿æ•°æ®åº“çŠ¶æ€æ¢å¤åˆ°æ­£å¸¸çŠ¶æ€ï¼ˆAï¼‰ï¼Œä¿éšœæ•°æ®åº“å³ä½¿åœ¨å¼‚å¸¸çŠ¶æ€ä¸‹ä»èƒ½ä¿æŒæ•°æ®ä¸€è‡´æ€§ï¼ˆCï¼‰ï¼ˆè¦ä¹ˆæ“ä½œå‰çŠ¶æ€ï¼Œè¦ä¹ˆæ“ä½œåçŠ¶æ€ï¼‰ å½“å‡ºç°å¹¶å‘è®¿é—®æ•°æ®åº“æ—¶ï¼Œåœ¨å¤šä¸ªè®¿é—®é—´è¿›è¡Œç›¸äº’éš”ç¦»ï¼Œé˜²æ­¢å¹¶å‘è®¿é—®æ“ä½œç»“æœäº’ç›¸å¹²æ‰°ï¼ˆIï¼‰ Spring äº‹åŠ¡ä¸€èˆ¬åŠ åˆ°ä¸šåŠ¡å±‚ï¼Œå¯¹åº”ç€ä¸šåŠ¡çš„æ“ä½œï¼ŒSpring äº‹åŠ¡çš„æœ¬è´¨å…¶å®å°±æ˜¯æ•°æ®åº“å¯¹äº‹åŠ¡çš„æ”¯æŒï¼Œæ²¡æœ‰æ•°æ®åº“çš„äº‹åŠ¡æ”¯æŒï¼ŒSpring æ˜¯æ— æ³•æä¾›äº‹åŠ¡åŠŸèƒ½çš„ï¼ŒSpring åªæä¾›ç»Ÿä¸€äº‹åŠ¡ç®¡ç†æ¥å£ Spring åœ¨äº‹åŠ¡å¼€å§‹æ—¶ï¼Œæ ¹æ®å½“å‰ç¯å¢ƒä¸­è®¾ç½®çš„éš”ç¦»çº§åˆ«ï¼Œè°ƒæ•´æ•°æ®åº“éš”ç¦»çº§åˆ«ï¼Œç”±æ­¤ä¿æŒä¸€è‡´ã€‚ç¨‹åºæ˜¯å¦æ”¯æŒäº‹åŠ¡é¦–å…ˆå–å†³äºæ•°æ®åº“ ï¼Œæ¯”å¦‚ MySQL ï¼Œå¦‚æœæ˜¯ Innodb å¼•æ“ï¼Œæ˜¯æ”¯æŒäº‹åŠ¡çš„ï¼›å¦‚æœ MySQL ä½¿ç”¨ MyISAM å¼•æ“ï¼Œé‚£ä»æ ¹ä¸Šå°±æ˜¯ä¸æ”¯æŒäº‹åŠ¡çš„ ä¿è¯åŸå­æ€§ï¼š è¦ä¿è¯äº‹åŠ¡çš„åŸå­æ€§ï¼Œå°±éœ€è¦åœ¨å¼‚å¸¸å‘ç”Ÿæ—¶ï¼Œå¯¹å·²ç»æ‰§è¡Œçš„æ“ä½œè¿›è¡Œå›æ»š åœ¨ MySQL ä¸­ï¼Œæ¢å¤æœºåˆ¶æ˜¯é€šè¿‡å›æ»šæ—¥å¿—ï¼ˆundo logï¼‰ å®ç°ï¼Œæ‰€æœ‰äº‹åŠ¡è¿›è¡Œçš„ä¿®æ”¹éƒ½ä¼šå…ˆå…ˆè®°å½•åˆ°è¿™ä¸ªå›æ»šæ—¥å¿—ä¸­ï¼Œç„¶åå†æ‰§è¡Œç›¸å…³çš„æ“ä½œã€‚å¦‚æœæ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°å¼‚å¸¸çš„è¯ï¼Œç›´æ¥åˆ©ç”¨å›æ»šæ—¥å¿—ä¸­çš„ä¿¡æ¯å°†æ•°æ®å›æ»šåˆ°ä¿®æ”¹ä¹‹å‰çš„æ ·å­å³å¯ å›æ»šæ—¥å¿—ä¼šå…ˆäºæ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šï¼Œè¿™æ ·ä¿è¯äº†å³ä½¿é‡åˆ°æ•°æ®åº“çªç„¶å®•æœºç­‰æƒ…å†µï¼Œå½“ç”¨æˆ·å†æ¬¡å¯åŠ¨æ•°æ®åº“çš„æ—¶å€™ï¼Œæ•°æ®åº“è¿˜èƒ½å¤Ÿé€šè¿‡æŸ¥è¯¢å›æ»šæ—¥å¿—æ¥å›æ»šå°†ä¹‹å‰æœªå®Œæˆçš„äº‹åŠ¡ éš”ç¦»çº§åˆ«TransactionDefinition æ¥å£ä¸­å®šä¹‰äº†äº”ä¸ªè¡¨ç¤ºéš”ç¦»çº§åˆ«çš„å¸¸é‡ï¼š TransactionDefinition.ISOLATION_DEFAULTï¼šä½¿ç”¨åç«¯æ•°æ®åº“é»˜è®¤çš„éš”ç¦»çº§åˆ«ï¼ŒMySQL é»˜è®¤é‡‡ç”¨çš„ REPEATABLE_READ éš”ç¦»çº§åˆ«ï¼ŒOracle é»˜è®¤é‡‡ç”¨çš„ READ_COMMITTEDéš”ç¦»çº§åˆ«. TransactionDefinition.ISOLATION_READ_UNCOMMITTEDï¼šæœ€ä½çš„éš”ç¦»çº§åˆ«ï¼Œå…è®¸è¯»å–å°šæœªæäº¤çš„æ•°æ®å˜æ›´ï¼Œå¯èƒ½ä¼šå¯¼è‡´è„è¯»ã€å¹»è¯»æˆ–ä¸å¯é‡å¤è¯» TransactionDefinition.ISOLATION_READ_COMMITTEDï¼šå…è®¸è¯»å–å¹¶å‘äº‹åŠ¡å·²ç»æäº¤çš„æ•°æ®ï¼Œå¯ä»¥é˜»æ­¢è„è¯»ï¼Œä½†æ˜¯å¹»è¯»æˆ–ä¸å¯é‡å¤è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿ TransactionDefinition.ISOLATION_REPEATABLE_READï¼šå¯¹åŒä¸€å­—æ®µçš„å¤šæ¬¡è¯»å–ç»“æœéƒ½æ˜¯ä¸€è‡´çš„ï¼Œé™¤éæ•°æ®æ˜¯è¢«æœ¬èº«äº‹åŠ¡è‡ªå·±æ‰€ä¿®æ”¹ï¼Œå¯ä»¥é˜»æ­¢è„è¯»å’Œä¸å¯é‡å¤è¯»ï¼Œä½†å¹»è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿã€‚ TransactionDefinition.ISOLATION_SERIALIZABLEï¼šæœ€é«˜çš„éš”ç¦»çº§åˆ«ï¼Œå®Œå…¨æœä» ACID çš„éš”ç¦»çº§åˆ«ã€‚æ‰€æœ‰çš„äº‹åŠ¡ä¾æ¬¡é€ä¸ªæ‰§è¡Œï¼Œè¿™æ ·äº‹åŠ¡ä¹‹é—´å°±å®Œå…¨ä¸å¯èƒ½äº§ç”Ÿå¹²æ‰°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥çº§åˆ«å¯ä»¥é˜²æ­¢è„è¯»ã€ä¸å¯é‡å¤è¯»ä»¥åŠå¹»è¯»ã€‚ä½†æ˜¯è¿™å°†ä¸¥é‡å½±å“ç¨‹åºçš„æ€§èƒ½ã€‚é€šå¸¸æƒ…å†µä¸‹ä¹Ÿä¸ä¼šç”¨åˆ°è¯¥çº§åˆ« MySQL InnoDB å­˜å‚¨å¼•æ“çš„é»˜è®¤æ”¯æŒçš„éš”ç¦»çº§åˆ«æ˜¯ REPEATABLE-READï¼ˆå¯é‡è¯»ï¼‰ åˆ†å¸ƒå¼äº‹åŠ¡ï¼šå…è®¸å¤šä¸ªç‹¬ç«‹çš„äº‹åŠ¡èµ„æºï¼ˆtransactional resourcesï¼‰å‚ä¸åˆ°ä¸€ä¸ªå…¨å±€çš„äº‹åŠ¡ä¸­ã€‚äº‹åŠ¡èµ„æºé€šå¸¸æ˜¯å…³ç³»å‹æ•°æ®åº“ç³»ç»Ÿï¼Œä½†ä¹Ÿå¯ä»¥æ˜¯å…¶ä»–ç±»å‹çš„èµ„æºï¼Œå…¨å±€äº‹åŠ¡è¦æ±‚åœ¨å…¶ä¸­çš„æ‰€æœ‰å‚ä¸çš„äº‹åŠ¡è¦ä¹ˆéƒ½æäº¤ï¼Œè¦ä¹ˆéƒ½å›æ»šï¼Œè¿™å¯¹äºäº‹åŠ¡åŸæœ‰çš„ ACID è¦æ±‚åˆæœ‰äº†æé«˜ åœ¨ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡æ—¶ï¼ŒInnoDB å­˜å‚¨å¼•æ“çš„äº‹åŠ¡éš”ç¦»çº§åˆ«å¿…é¡»è®¾ç½®ä¸º SERIALIZABLE ä¼ æ’­è¡Œä¸ºäº‹åŠ¡ä¼ æ’­è¡Œä¸ºæ˜¯ä¸ºäº†è§£å†³ä¸šåŠ¡å±‚æ–¹æ³•ä¹‹é—´äº’ç›¸è°ƒç”¨çš„äº‹åŠ¡é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯æ–¹æ³•åµŒå¥—ï¼š å½“äº‹åŠ¡æ–¹æ³•è¢«å¦ä¸€ä¸ªäº‹åŠ¡æ–¹æ³•è°ƒç”¨æ—¶ï¼Œå¿…é¡»æŒ‡å®šäº‹åŠ¡åº”è¯¥å¦‚ä½•ä¼ æ’­ã€‚ ä¾‹å¦‚ï¼šæ–¹æ³•å¯èƒ½ç»§ç»­åœ¨ç°æœ‰äº‹åŠ¡ä¸­è¿è¡Œï¼Œä¹Ÿå¯èƒ½å¼€å¯ä¸€ä¸ªæ–°äº‹åŠ¡ï¼Œå¹¶åœ¨è‡ªå·±çš„äº‹åŠ¡ä¸­è¿è¡Œ 123456789101112//å¤–å±‚äº‹åŠ¡ Service A çš„ aMethod è°ƒç”¨å†…å±‚ Service B çš„ bMethodclass A &#123; @Transactional(propagation=propagation.xxx) public void aMethod &#123; B b = new B(); b.bMethod(); &#125;&#125;class B &#123; @Transactional(propagation=propagation.xxx) public void bMethod &#123;&#125;&#125; æ”¯æŒå½“å‰äº‹åŠ¡çš„æƒ…å†µï¼š TransactionDefinition.PROPAGATION_REQUIREDï¼š å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡åˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ å†…å¤–å±‚æ˜¯ç›¸åŒçš„äº‹åŠ¡ï¼Œåœ¨ aMethod æˆ–è€…åœ¨ bMethod å†…çš„ä»»ä½•åœ°æ–¹å‡ºç°å¼‚å¸¸ï¼Œäº‹åŠ¡éƒ½ä¼šè¢«å›æ»š å·¥ä½œæµç¨‹ï¼š çº¿ç¨‹æ‰§è¡Œåˆ° serviceA.aMethod() æ—¶ï¼Œå…¶å®æ˜¯æ‰§è¡Œçš„ä»£ç† serviceA å¯¹è±¡çš„ aMethod é¦–å…ˆæ‰§è¡Œäº‹åŠ¡å¢å¼ºå™¨é€»è¾‘ï¼ˆç¯ç»•å¢å¼ºï¼‰ï¼Œæå–äº‹åŠ¡æ ‡ç­¾å±æ€§ï¼Œæ£€æŸ¥å½“å‰çº¿ç¨‹æ˜¯å¦ç»‘å®š connection æ•°æ®åº“è¿æ¥èµ„æºï¼Œæ²¡æœ‰å°±è°ƒç”¨ datasource.getConnection()ï¼Œè®¾ç½®äº‹åŠ¡æäº¤ä¸ºæ‰‹åŠ¨æäº¤ autocommit(false) æ‰§è¡Œå…¶ä»–å¢å¼ºå™¨çš„é€»è¾‘ï¼Œç„¶åè°ƒç”¨ target çš„ç›®æ ‡æ–¹æ³• aMethod() æ–¹æ³•ï¼Œè¿›å…¥ serviceB çš„é€»è¾‘ serviceB ä¹Ÿæ˜¯å…ˆæ‰§è¡Œäº‹åŠ¡å¢å¼ºå™¨çš„é€»è¾‘ï¼Œæå–äº‹åŠ¡æ ‡ç­¾å±æ€§ï¼Œä½†æ­¤æ—¶ä¼šæ£€æŸ¥åˆ°çº¿ç¨‹ç»‘å®šäº† connectionï¼Œæ£€æŸ¥æ³¨è§£çš„ä¼ æ’­å±æ€§ï¼Œæ‰€ä»¥è°ƒç”¨ DataSourceUtils.getConnection(datasource) å…±äº«è¯¥è¿æ¥èµ„æºï¼Œæ‰§è¡Œå®Œç›¸å…³çš„å¢å¼ºå’Œ SQL åï¼Œå‘ç°äº‹åŠ¡å¹¶ä¸æ˜¯å½“å‰æ–¹æ³•å¼€å¯çš„ï¼Œå¯ä»¥ç›´æ¥è¿”å›ä¸Šå±‚ serviceA.aMethod() ç»§ç»­æ‰§è¡Œï¼Œæ‰§è¡Œå®Œå¢å¼ºåè¿›è¡Œæäº¤äº‹åŠ¡æˆ–å›æ»šäº‹åŠ¡ TransactionDefinition.PROPAGATION_SUPPORTSï¼š å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™ä»¥éäº‹åŠ¡çš„æ–¹å¼ç»§ç»­è¿è¡Œ TransactionDefinition.PROPAGATION_MANDATORYï¼š å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ ä¸æ”¯æŒå½“å‰äº‹åŠ¡çš„æƒ…å†µï¼š TransactionDefinition.PROPAGATION_REQUIRES_NEWï¼š åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ· å†…å¤–å±‚æ˜¯ä¸åŒçš„äº‹åŠ¡ï¼Œå¦‚æœ bMethod å·²ç»æäº¤ï¼Œå¦‚æœ aMethod å¤±è´¥å›æ»š ï¼ŒbMethod ä¸ä¼šå›æ»š å¦‚æœ bMethod å¤±è´¥å›æ»šï¼ŒServiceB æŠ›å‡ºçš„å¼‚å¸¸è¢« ServiceA æ•è·ï¼Œå¦‚æœ B æŠ›å‡ºçš„å¼‚å¸¸æ˜¯ A ä¼šå›æ»šçš„å¼‚å¸¸ï¼ŒaMethod äº‹åŠ¡éœ€è¦å›æ»šï¼Œå¦åˆ™ä»ç„¶å¯ä»¥æäº¤ TransactionDefinition.PROPAGATION_NOT_SUPPORTEDï¼š ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ· TransactionDefinition.PROPAGATION_NEVERï¼š ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ å…¶ä»–æƒ…å†µï¼š TransactionDefinition.PROPAGATION_NESTEDï¼š å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªäº‹åŠ¡ä½œä¸ºå½“å‰äº‹åŠ¡çš„åµŒå¥—äº‹åŠ¡ï¼ˆä¸¤ä¸ªäº‹åŠ¡æ²¡æœ‰å…³ç³»ï¼‰æ¥è¿è¡Œ å¦‚æœ ServiceB å¼‚å¸¸å›æ»šï¼Œå¯ä»¥é€šè¿‡ try-catch æœºåˆ¶æ‰§è¡Œ ServiceC å¦‚æœ ServiceB æäº¤ï¼Œ ServiceA å¯ä»¥æ ¹æ®å…·ä½“çš„é…ç½®å†³å®šæ˜¯ commit è¿˜æ˜¯ rollback åº”ç”¨åœºæ™¯ï¼šåœ¨æŸ¥è¯¢æ•°æ®çš„æ—¶å€™è¦å‘æ•°æ®åº“ä¸­å­˜å‚¨ä¸€äº›æ—¥å¿—ï¼Œç³»ç»Ÿä¸å¸Œæœ›å­˜æ—¥å¿—çš„è¡Œä¸ºå½±å“åˆ°ä¸»é€»è¾‘ï¼Œå¯ä»¥ä½¿ç”¨è¯¥ä¼ æ’­ requiedï¼šå¿…é¡»çš„ã€supportsï¼šæ”¯æŒçš„ã€mandatoryï¼šå¼ºåˆ¶çš„ã€nestedï¼šåµŒå¥—çš„ è¶…æ—¶å±æ€§äº‹åŠ¡è¶…æ—¶ï¼ŒæŒ‡ä¸€ä¸ªäº‹åŠ¡æ‰€å…è®¸æ‰§è¡Œçš„æœ€é•¿æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡è¯¥æ—¶é—´é™åˆ¶äº‹åŠ¡è¿˜æ²¡æœ‰å®Œæˆï¼Œåˆ™è‡ªåŠ¨å›æ»šäº‹åŠ¡ã€‚åœ¨ TransactionDefinition ä¸­ä»¥ int çš„å€¼æ¥è¡¨ç¤ºè¶…æ—¶æ—¶é—´ï¼Œå…¶å•ä½æ˜¯ç§’ï¼Œé»˜è®¤å€¼ä¸º -1 åªè¯»å±æ€§å¯¹äºåªæœ‰è¯»å–æ•°æ®æŸ¥è¯¢çš„äº‹åŠ¡ï¼Œå¯ä»¥æŒ‡å®šäº‹åŠ¡ç±»å‹ä¸º readonlyï¼Œå³åªè¯»äº‹åŠ¡ï¼›åªè¯»äº‹åŠ¡ä¸æ¶‰åŠæ•°æ®çš„ä¿®æ”¹ï¼Œæ•°æ®åº“ä¼šæä¾›ä¸€äº›ä¼˜åŒ–æ‰‹æ®µï¼Œé€‚åˆç”¨åœ¨æœ‰å¤šæ¡æ•°æ®åº“æŸ¥è¯¢æ“ä½œçš„æ–¹æ³•ä¸­ è¯»æ“ä½œä¸ºä»€ä¹ˆéœ€è¦å¯ç”¨äº‹åŠ¡æ”¯æŒï¼š MySQL é»˜è®¤å¯¹æ¯ä¸€ä¸ªæ–°å»ºç«‹çš„è¿æ¥éƒ½å¯ç”¨äº† autocommit æ¨¡å¼ï¼Œåœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œæ¯ä¸€ä¸ªå‘é€åˆ° MySQL æœåŠ¡å™¨çš„ SQL è¯­å¥éƒ½ä¼šåœ¨ä¸€ä¸ªå•ç‹¬çš„äº‹åŠ¡ä¸­è¿›è¡Œå¤„ç†ï¼Œæ‰§è¡Œç»“æŸåä¼šè‡ªåŠ¨æäº¤äº‹åŠ¡ï¼Œå¹¶å¼€å¯ä¸€ä¸ªæ–°çš„äº‹åŠ¡ æ‰§è¡Œå¤šæ¡æŸ¥è¯¢è¯­å¥ï¼Œå¦‚æœæ–¹æ³•åŠ ä¸Šäº† @Transactional æ³¨è§£ï¼Œè¿™ä¸ªæ–¹æ³•æ‰§è¡Œçš„æ‰€æœ‰ SQL ä¼šè¢«æ”¾åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå¦‚æœå£°æ˜äº†åªè¯»äº‹åŠ¡çš„è¯ï¼Œæ•°æ®åº“å°±ä¼šå»ä¼˜åŒ–å®ƒçš„æ‰§è¡Œï¼Œå¹¶ä¸ä¼šå¸¦æ¥å…¶ä»–çš„æ”¶ç›Šã€‚å¦‚æœä¸åŠ  @Transactionalï¼Œæ¯æ¡ SQL ä¼šå¼€å¯ä¸€ä¸ªå•ç‹¬çš„äº‹åŠ¡ï¼Œä¸­é—´è¢«å…¶å®ƒäº‹åŠ¡ä¿®æ”¹äº†æ•°æ®ï¼Œæ¯”å¦‚åœ¨å‰æ¡ SQL æŸ¥è¯¢ä¹‹åï¼Œåæ¡ SQL æŸ¥è¯¢ä¹‹å‰ï¼Œæ•°æ®è¢«å…¶ä»–ç”¨æˆ·æ”¹å˜ï¼Œåˆ™è¿™æ¬¡æ•´ä½“çš„ç»Ÿè®¡æŸ¥è¯¢å°†ä¼šå‡ºç°è¯»æ•°æ®ä¸ä¸€è‡´çš„çŠ¶æ€ æ ¸å¿ƒå¯¹è±¡äº‹åŠ¡å¯¹è±¡J2EE å¼€å‘ä½¿ç”¨åˆ†å±‚è®¾è®¡çš„æ€æƒ³è¿›è¡Œï¼Œå¯¹äºç®€å•çš„ä¸šåŠ¡å±‚è½¬è°ƒæ•°æ®å±‚çš„å•ä¸€æ“ä½œï¼Œäº‹åŠ¡å¼€å¯åœ¨ä¸šåŠ¡å±‚æˆ–è€…æ•°æ®å±‚å¹¶æ— å¤ªå¤§å·®åˆ«ï¼Œå½“ä¸šåŠ¡ä¸­åŒ…å«å¤šä¸ªæ•°æ®å±‚çš„è°ƒç”¨æ—¶ï¼Œéœ€è¦åœ¨ä¸šåŠ¡å±‚å¼€å¯äº‹åŠ¡ï¼Œå¯¹æ•°æ®å±‚ä¸­å¤šä¸ªæ“ä½œè¿›è¡Œç»„åˆå¹¶å½’å±äºåŒä¸€ä¸ªäº‹åŠ¡è¿›è¡Œå¤„ç† Spring ä¸ºä¸šåŠ¡å±‚æä¾›äº†æ•´å¥—çš„äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼š PlatformTransactionManager TransactionDefinition TransactionStatus PTMPlatformTransactionManagerï¼Œå¹³å°äº‹åŠ¡ç®¡ç†å™¨å®ç°ç±»ï¼š DataSourceTransactionManager é€‚ç”¨äº Spring JDBC æˆ– MyBatis HibernateTransactionManager é€‚ç”¨äº Hibernate3.0 åŠä»¥ä¸Šç‰ˆæœ¬ JpaTransactionManager é€‚ç”¨äº JPA JdoTransactionManager é€‚ç”¨äº JDO JtaTransactionManager é€‚ç”¨äº JTA ç®¡ç†å™¨ï¼š JPAï¼ˆJava Persistence APIï¼‰Java EE æ ‡å‡†ä¹‹ä¸€ï¼Œä¸º POJO æä¾›æŒä¹…åŒ–æ ‡å‡†è§„èŒƒï¼Œå¹¶è§„èŒƒäº†æŒä¹…åŒ–å¼€å‘çš„ç»Ÿä¸€ APIï¼Œç¬¦åˆ JPA è§„èŒƒçš„å¼€å‘å¯ä»¥åœ¨ä¸åŒçš„ JPA æ¡†æ¶ä¸‹è¿è¡Œ éæŒä¹…åŒ–ä¸€ä¸ªå­—æ®µï¼š 12345static String transient1; // not persistent because of staticfinal String transient2 = â€œSatishâ€; // not persistent because of finaltransient String transient3; // not persistent because of transient@TransientString transient4; // not persistent because of @Transient JDOï¼ˆJava Data Objectï¼‰æ˜¯ Java å¯¹è±¡æŒä¹…åŒ–è§„èŒƒï¼Œç”¨äºå­˜å–æŸç§æ•°æ®åº“ä¸­çš„å¯¹è±¡ï¼Œå¹¶æä¾›æ ‡å‡†åŒ– APIã€‚JDBC ä»…é’ˆå¯¹å…³ç³»æ•°æ®åº“è¿›è¡Œæ“ä½œï¼ŒJDO å¯ä»¥æ‰©å±•åˆ°å…³ç³»æ•°æ®åº“ã€XMLã€å¯¹è±¡æ•°æ®åº“ç­‰ï¼Œå¯ç§»æ¤æ€§æ›´å¼º JTAï¼ˆJava Transaction APIï¼‰Java EE æ ‡å‡†ä¹‹ä¸€ï¼Œå…è®¸åº”ç”¨ç¨‹åºæ‰§è¡Œåˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†ã€‚ä¸ JDBC ç›¸æ¯”ï¼ŒJDBC äº‹åŠ¡åˆ™è¢«é™å®šåœ¨ä¸€ä¸ªå•ä¸€çš„æ•°æ®åº“è¿æ¥ï¼Œè€Œä¸€ä¸ª JTA äº‹åŠ¡å¯ä»¥æœ‰å¤šä¸ªå‚ä¸è€…ï¼Œæ¯”å¦‚ JDBC è¿æ¥ã€JDO éƒ½å¯ä»¥å‚ä¸åˆ°ä¸€ä¸ª JTA äº‹åŠ¡ä¸­ æ­¤æ¥å£å®šä¹‰äº†äº‹åŠ¡çš„åŸºæœ¬æ“ä½œï¼š æ–¹æ³• è¯´æ˜ TransactionStatus getTransaction(TransactionDefinition definition) è·å–äº‹åŠ¡ void commit(TransactionStatus status) æäº¤äº‹åŠ¡ void rollback(TransactionStatus status) å›æ»šäº‹åŠ¡ DefinitionTransactionDefinition æ­¤æ¥å£å®šä¹‰äº†äº‹åŠ¡çš„åŸºæœ¬ä¿¡æ¯ï¼š æ–¹æ³• è¯´æ˜ String getName() è·å–äº‹åŠ¡å®šä¹‰åç§° boolean isReadOnly() è·å–äº‹åŠ¡çš„è¯»å†™å±æ€§ int getIsolationLevel() è·å–äº‹åŠ¡éš”ç¦»çº§åˆ« int getTimeout() è·å–äº‹åŠ¡è¶…æ—¶æ—¶é—´ int getPropagationBehavior() è·å–äº‹åŠ¡ä¼ æ’­è¡Œä¸ºç‰¹å¾ StatusTransactionStatus æ­¤æ¥å£å®šä¹‰äº†äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æŸä¸ªæ—¶é—´ç‚¹ä¸Šçš„çŠ¶æ€ä¿¡æ¯åŠå¯¹åº”çš„çŠ¶æ€æ“ä½œï¼š æ–¹æ³• è¯´æ˜ boolean isNewTransaction() è·å–äº‹åŠ¡æ˜¯å¦å¤„äºæ–°å¼€å§‹äº‹åŠ¡çŠ¶æ€ voin flush() åˆ·æ–°äº‹åŠ¡çŠ¶æ€ boolean isCompleted() è·å–äº‹åŠ¡æ˜¯å¦å¤„äºå·²å®ŒæˆçŠ¶æ€ boolean hasSavepoint() è·å–äº‹åŠ¡æ˜¯å¦å…·æœ‰å›æ»šå‚¨å­˜ç‚¹ boolean isRollbackOnly() è·å–äº‹åŠ¡æ˜¯å¦å¤„äºå›æ»šçŠ¶æ€ void setRollbackOnly() è®¾ç½®äº‹åŠ¡å¤„äºå›æ»šçŠ¶æ€ ç¼–ç¨‹å¼æ§åˆ¶æ–¹å¼ç¼–ç¨‹å¼ã€å£°æ˜å¼ï¼ˆXMLï¼‰ã€å£°æ˜å¼ï¼ˆæ³¨è§£ï¼‰ ç¯å¢ƒå‡†å¤‡é“¶è¡Œè½¬è´¦ä¸šåŠ¡ åŒ…è£…ç±» 123456public class Account implements Serializable &#123; private Integer id; private String name; private Double money; .....&#125; DAOå±‚æ¥å£ï¼šAccountDao 1234567public interface AccountDao &#123; //å…¥è´¦æ“ä½œ name:å…¥è´¦ç”¨æˆ·å money:å…¥è´¦é‡‘é¢ void inMoney(@Param(&quot;name&quot;) String name, @Param(&quot;money&quot;) Double money); //å‡ºè´¦æ“ä½œ name:å‡ºè´¦ç”¨æˆ·å money:å‡ºè´¦é‡‘é¢ void outMoney(@Param(&quot;name&quot;) String name, @Param(&quot;money&quot;) Double money);&#125; ä¸šåŠ¡å±‚æ¥å£æä¾›è½¬è´¦æ“ä½œï¼šAccountService 1234public interface AccountService &#123; //è½¬è´¦æ“ä½œ outName:å‡ºè´¦ç”¨æˆ·å inName:å…¥è´¦ç”¨æˆ·å money:è½¬è´¦é‡‘é¢ public void transfer(String outName,String inName,Double money);&#125; ä¸šåŠ¡å±‚å®ç°æä¾›è½¬è´¦æ“ä½œï¼šAccountServiceImpl 1234567891011public class AccountServiceImpl implements AccountService &#123; private AccountDao accountDao; public void setAccountDao(AccountDao accountDao) &#123; this.accountDao = accountDao; &#125; @Override public void transfer(String outName,String inName,Double money)&#123; accountDao.inMoney(outName,money); accountDao.outMoney(inName,money); &#125;&#125; æ˜ å°„é…ç½®æ–‡ä»¶ï¼šdao &#x2F; AccountDao.xml 123456789&lt;mapper namespace=&quot;dao.AccountDao&quot;&gt; &lt;update id=&quot;inMoney&quot;&gt; UPDATE account SET money = money + #&#123;money&#125; WHERE name = #&#123;name&#125; &lt;/update&gt; &lt;update id=&quot;outMoney&quot;&gt; UPDATE account SET money = money - #&#123;money&#125; WHERE name = #&#123;name&#125; &lt;/update&gt;&lt;/mapper&gt; jdbc.properties 1234jdbc.driver=com.mysql.jdbc.Driverjdbc.url=jdbc:mysql://192.168.2.185:3306/spring_dbjdbc.username=rootjdbc.password=1234 æ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼šapplicationContext.xml 123456789101112131415161718192021&lt;context:property-placeholder location=&quot;classpath:*.properties&quot;/&gt;&lt;bean id=&quot;dataSource&quot; class=&quot;com.alibaba.druid.pool.DruidDataSource&quot;&gt; &lt;property name=&quot;driverClassName&quot; value=&quot;$&#123;jdbc.driver&#125;&quot;/&gt; &lt;property name=&quot;url&quot; value=&quot;$&#123;jdbc.url&#125;&quot;/&gt; &lt;property name=&quot;username&quot; value=&quot;$&#123;jdbc.username&#125;&quot;/&gt; &lt;property name=&quot;password&quot; value=&quot;$&#123;jdbc.password&#125;&quot;/&gt;&lt;/bean&gt;&lt;bean id=&quot;accountService&quot; class=&quot;service.impl.AccountServiceImpl&quot;&gt; &lt;property name=&quot;accountDao&quot; ref=&quot;accountDao&quot;/&gt;&lt;/bean&gt;&lt;bean class=&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;&gt; &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;/&gt; &lt;property name=&quot;typeAliasesPackage&quot; value=&quot;domain&quot;/&gt;&lt;/bean&gt;&lt;!--æ‰«ææ˜ å°„é…ç½®å’ŒDao--&gt;&lt;bean class=&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;&gt; &lt;property name=&quot;basePackage&quot; value=&quot;dao&quot;/&gt;&lt;/bean&gt; æµ‹è¯•ç±» 123ApplicationContext ctx = new ClassPathXmlApplicationContext(&quot;ap...xml&quot;);AccountService accountService = (AccountService) ctx.getBean(&quot;accountService&quot;);accountService.transfer(&quot;Jock1&quot;, &quot;Jock2&quot;, 100d); ç¼–ç¨‹å¼ç¼–ç¨‹å¼äº‹åŠ¡å°±æ˜¯ä»£ç æ˜¾å¼çš„ç»™å‡ºäº‹åŠ¡çš„å¼€å¯å’Œæäº¤ ä¿®æ”¹ä¸šåŠ¡å±‚å®ç°æä¾›è½¬è´¦æ“ä½œï¼šAccountServiceImpl 123456789101112131415public void transfer(String outName,String inName,Double money)&#123; //1.åˆ›å»ºäº‹åŠ¡ç®¡ç†å™¨ï¼Œ DataSourceTransactionManager dstm = new DataSourceTransactionManager(); //2.ä¸ºäº‹åŠ¡ç®¡ç†å™¨è®¾ç½®ä¸æ•°æ®å±‚ç›¸åŒçš„æ•°æ®æº dstm.setDataSource(dataSource); //3.åˆ›å»ºäº‹åŠ¡å®šä¹‰å¯¹è±¡ TransactionDefinition td = new DefaultTransactionDefinition(); //4.åˆ›å»ºäº‹åŠ¡çŠ¶æ€å¯¹è±¡ï¼Œç”¨äºæ§åˆ¶äº‹åŠ¡æ‰§è¡Œï¼Œã€å¼€å¯äº‹åŠ¡ã€‘ TransactionStatus ts = dstm.getTransaction(td); accountDao.inMoney(inName,money); int i = 1/0; //æ¨¡æ‹Ÿä¸šåŠ¡å±‚äº‹åŠ¡è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ accountDao.outMoney(outName,money); //5.æäº¤äº‹åŠ¡ dstm.commit(ts);&#125; é…ç½® applicationContext.xml 12345&lt;!--æ·»åŠ å±æ€§æ³¨å…¥--&gt;&lt;bean id=&quot;accountService&quot; class=&quot;service.impl.AccountServiceImpl&quot;&gt; &lt;property name=&quot;accountDao&quot; ref=&quot;accountDao&quot;/&gt; &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;/&gt;&lt;/bean&gt; AOPæ”¹é€  å°†ä¸šåŠ¡å±‚çš„äº‹åŠ¡å¤„ç†åŠŸèƒ½æŠ½å–å‡ºæ¥åˆ¶ä½œæˆ AOP é€šçŸ¥ï¼Œåˆ©ç”¨ç¯ç»•é€šçŸ¥è¿è¡ŒæœŸåŠ¨æ€ç»‡å…¥ 12345678910111213141516171819202122public class TxAdvice &#123; private DataSource dataSource; public void setDataSource(DataSource dataSource) &#123; this.dataSource = dataSource; &#125; public Object tx(ProceedingJoinPoint pjp) throws Throwable &#123; //å¼€å¯äº‹åŠ¡ PlatformTransactionManager ptm = new DataSourceTransactionManager(dataSource); //äº‹åŠ¡å®šä¹‰ TransactionDefinition td = new DefaultTransactionDefinition(); //äº‹åŠ¡çŠ¶æ€ TransactionStatus ts = ptm.getTransaction(td); //pjp.getArgs()æ ‡å‡†å†™æ³•ï¼Œä¹Ÿå¯ä»¥ä¸åŠ ï¼ŒåŒæ ·å¯ä»¥ä¼ é€’å‚æ•° Object ret = pjp.proceed(pjp.getArgs()); //æäº¤äº‹åŠ¡ ptm.commit(ts); return ret; &#125;&#125; é…ç½® applicationContext.xmlï¼Œè¦å¼€å¯ AOP ç©ºé—´ 1234567891011121314151617&lt;!--ä¿®æ”¹beançš„å±æ€§æ³¨å…¥--&gt;&lt;bean id=&quot;accountService&quot; class=&quot;service.impl.AccountServiceImpl&quot;&gt; &lt;property name=&quot;accountDao&quot; ref=&quot;accountDao&quot;/&gt;&lt;/bean&gt;&lt;!--é…ç½®AOPé€šçŸ¥ç±»ï¼Œå¹¶æ³¨å…¥dataSource--&gt;&lt;bean id=&quot;txAdvice&quot; class=&quot;aop.TxAdvice&quot;&gt; &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;/&gt;&lt;/bean&gt;&lt;!--ä½¿ç”¨ç¯ç»•é€šçŸ¥å°†é€šçŸ¥ç±»ç»‡å…¥åˆ°åŸå§‹ä¸šåŠ¡å¯¹è±¡æ‰§è¡Œè¿‡ç¨‹ä¸­--&gt;&lt;aop:config&gt; &lt;aop:pointcut id=&quot;pt&quot; expression=&quot;execution(* *..transfer(..))&quot;/&gt; &lt;aop:aspect ref=&quot;txAdvice&quot;&gt; &lt;aop:around method=&quot;tx&quot; pointcut-ref=&quot;pt&quot;/&gt; &lt;/aop:aspect&gt;&lt;/aop:config&gt; ä¿®æ”¹ä¸šåŠ¡å±‚å®ç°æä¾›è½¬è´¦æ“ä½œï¼šAccountServiceImpl 123456789101112public class AccountServiceImpl implements AccountService &#123; private AccountDao accountDao; public void setAccountDao(AccountDao accountDao) &#123; this.accountDao = accountDao; &#125; @Override public void transfer(String outName,String inName,Double money)&#123; accountDao.inMoney(outName,money); //int i = 1 / 0; accountDao.outMoney(inName,money); &#125;&#125; å£°æ˜å¼XMLtxä½¿ç”¨åˆ é™¤ TxAdvice é€šçŸ¥ç±»ï¼Œå¼€å¯ tx å‘½åç©ºé—´ï¼Œé…ç½® applicationContext.xml 123456789101112131415161718&lt;!--é…ç½®å¹³å°äº‹åŠ¡ç®¡ç†å™¨--&gt;&lt;bean id=&quot;txManager&quot; class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt; &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;/&gt;&lt;/bean&gt;&lt;!--å®šä¹‰äº‹åŠ¡ç®¡ç†çš„é€šçŸ¥ç±»--&gt;&lt;tx:advice id=&quot;txAdvice&quot; transaction-manager=&quot;txManager&quot;&gt; &lt;!--å®šä¹‰æ§åˆ¶çš„äº‹åŠ¡--&gt; &lt;tx:attributes&gt; &lt;tx:method name=&quot;transfer&quot; read-only=&quot;false&quot;/&gt; &lt;/tx:attributes&gt;&lt;/tx:advice&gt;&lt;!--ä½¿ç”¨aop:advisoråœ¨AOPé…ç½®ä¸­å¼•ç”¨äº‹åŠ¡ä¸“å±é€šçŸ¥ç±»ï¼Œåº•å±‚invokeè°ƒç”¨--&gt;&lt;aop:config&gt; &lt;aop:pointcut id=&quot;pt&quot; expression=&quot;execution(* service.*Service.*(..))&quot;/&gt; &lt;aop:advisor advice-ref=&quot;txAdvice&quot; pointcut-ref=&quot;pt&quot;/&gt;&lt;/aop:config&gt; aop:advice ä¸ aop:advisor åŒºåˆ« aop:advice é…ç½®çš„é€šçŸ¥ç±»å¯ä»¥æ˜¯æ™®é€š Java å¯¹è±¡ï¼Œä¸å®ç°æ¥å£ï¼Œä¹Ÿä¸ä½¿ç”¨ç»§æ‰¿å…³ç³» aop:advisor é…ç½®çš„é€šçŸ¥ç±»å¿…é¡»å®ç°é€šçŸ¥æ¥å£ï¼Œåº•å±‚ invoke è°ƒç”¨ MethodBeforeAdvice AfterReturningAdvice ThrowsAdvice pom.xml æ–‡ä»¶å¼•å…¥ä¾èµ–ï¼š 12345&lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-tx&lt;/artifactId&gt; &lt;version&gt;5.1.9.RELEASE&lt;/version&gt;&lt;/dependency&gt; txé…ç½®adviceæ ‡ç­¾ï¼štx:adviceï¼Œbeans çš„å­æ ‡ç­¾ ä½œç”¨ï¼šä¸“ç”¨äºå£°æ˜äº‹åŠ¡é€šçŸ¥ æ ¼å¼ï¼š 1234&lt;beans&gt; &lt;tx:advice id=&quot;txAdvice&quot; transaction-manager=&quot;txManager&quot;&gt; &lt;/tx:advice&gt;&lt;/beans&gt; åŸºæœ¬å±æ€§ï¼š idï¼šç”¨äºé…ç½® aop æ—¶æŒ‡å®šé€šçŸ¥å™¨çš„ id transaction-managerï¼šæŒ‡å®šäº‹åŠ¡ç®¡ç†å™¨ bean attributesç±»å‹ï¼štx:attributesï¼Œtx:advice çš„å­æ ‡ç­¾ ä½œç”¨ï¼šå®šä¹‰é€šçŸ¥å±æ€§ æ ¼å¼ï¼š 1234&lt;tx:advice id=&quot;txAdvice&quot; transaction-manager=&quot;txManager&quot;&gt; &lt;tx:attributes&gt; &lt;/tx:attributes&gt;&lt;/tx:advice&gt; methodæ ‡ç­¾ï¼štx:methodï¼Œtx:attribute çš„å­æ ‡ç­¾ ä½œç”¨ï¼šè®¾ç½®å…·ä½“çš„äº‹åŠ¡å±æ€§ æ ¼å¼ï¼š 1234567&lt;tx:attributes&gt; &lt;!--æ ‡å‡†æ ¼å¼--&gt; &lt;tx:method name=&quot;*&quot; read-only=&quot;false&quot;/&gt; &lt;tx:method name=&quot;get*&quot; read-only=&quot;true&quot;/&gt; &lt;tx:method name=&quot;find*&quot; read-only=&quot;true&quot;/&gt;&lt;/tx:attributes&gt;&lt;aop:pointcut id=&quot;pt&quot; expression=&quot;execution(* service.*Service.*(..))&quot;/&gt;&lt;!--æ ‡å‡†--&gt; è¯´æ˜ï¼šé€šå¸¸äº‹åŠ¡å±æ€§ä¼šé…ç½®å¤šä¸ªï¼ŒåŒ…å« 1 ä¸ªè¯»å†™çš„å…¨äº‹åŠ¡å±æ€§ï¼Œ1 ä¸ªåªè¯»çš„æŸ¥è¯¢ç±»äº‹åŠ¡å±æ€§ å±æ€§ï¼š nameï¼šå¾…æ·»åŠ äº‹åŠ¡çš„æ–¹æ³•åè¡¨è¾¾å¼ï¼ˆæ”¯æŒ * é€šé…ç¬¦ï¼‰ read-onlyï¼šè®¾ç½®äº‹åŠ¡çš„è¯»å†™å±æ€§ï¼Œtrue ä¸ºåªè¯»ï¼Œfalse ä¸ºè¯»å†™ timeoutï¼šè®¾ç½®äº‹åŠ¡çš„è¶…æ—¶æ—¶é•¿ï¼Œå•ä½ç§’ï¼Œ-1 ä¸ºæ— é™é•¿ isolationï¼šè®¾ç½®äº‹åŠ¡çš„éš”ç¦»ç•Œåˆ«ï¼Œè¯¥éš”ç¦»çº§è®¾å®šæ˜¯åŸºäº Spring çš„è®¾å®šï¼Œéæ•°æ®åº“ç«¯ no-rollback-forï¼šè®¾ç½®äº‹åŠ¡ä¸­ä¸å›æ»šçš„å¼‚å¸¸ï¼Œå¤šä¸ªå¼‚å¸¸ä½¿ç”¨ , åˆ†éš” rollback-forï¼šè®¾ç½®äº‹åŠ¡ä¸­å¿…å›æ»šçš„å¼‚å¸¸ï¼Œå¤šä¸ªå¼‚å¸¸ä½¿ç”¨ , åˆ†éš” propagationï¼šè®¾ç½®äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸º æ³¨è§£å¼€å¯æ³¨è§£XMLæ ‡ç­¾ï¼štx:annotation-driven å½’å±ï¼šbeans æ ‡ç­¾ ä½œç”¨ï¼šå¼€å¯äº‹åŠ¡æ³¨è§£é©±åŠ¨ï¼Œå¹¶æŒ‡å®šå¯¹åº”çš„äº‹åŠ¡ç®¡ç†å™¨ èŒƒä¾‹ï¼š 1&lt;tx:annotation-driven transaction-manager=&quot;txManager&quot;/&gt; çº¯æ³¨è§£åç§°ï¼š@EnableTransactionManagement ç±»å‹ï¼šç±»æ³¨è§£ï¼ŒSpring æ³¨è§£é…ç½®ç±»ä¸Šæ–¹ ä½œç”¨ï¼šå¼€å¯æ³¨è§£é©±åŠ¨ï¼Œç­‰åŒ XML æ ¼å¼ä¸­çš„æ³¨è§£é©±åŠ¨ èŒƒä¾‹ï¼š 1234567@Configuration@ComponentScan(&quot;com.seazean&quot;)@PropertySource(&quot;classpath:jdbc.properties&quot;)@Import(&#123;JDBCConfig.class,MyBatisConfig.class,TransactionManagerConfig.class&#125;)@EnableTransactionManagementpublic class SpringConfig &#123;&#125; 123456public class TransactionManagerConfig &#123; @Bean //è‡ªåŠ¨è£…é… public PlatformTransactionManager getTransactionManager(@Autowired DataSource dataSource)&#123; return new DataSourceTransactionManager(dataSource); &#125;&#125; é…ç½®æ³¨è§£åç§°ï¼š@Transactional ç±»å‹ï¼šæ–¹æ³•æ³¨è§£ï¼Œç±»æ³¨è§£ï¼Œæ¥å£æ³¨è§£ ä½œç”¨ï¼šè®¾ç½®å½“å‰ç±»&#x2F;æ¥å£ä¸­æ‰€æœ‰æ–¹æ³•æˆ–å…·ä½“æ–¹æ³•å¼€å¯äº‹åŠ¡ï¼Œå¹¶æŒ‡å®šç›¸å…³äº‹åŠ¡å±æ€§ èŒƒä¾‹ï¼š 123456789@Transactional( readOnly = false, timeout = -1, isolation = Isolation.DEFAULT, rollbackFor = &#123;ArithmeticException.class, IOException.class&#125;, noRollbackFor = &#123;&#125;, propagation = Propagation.REQUIRES_NEW)public void addAccount&#123;&#125; è¯´æ˜ï¼š @Transactional æ³¨è§£åªæœ‰ä½œç”¨åˆ° public æ–¹æ³•ä¸Šäº‹åŠ¡æ‰ç”Ÿæ•ˆ ä¸æ¨èåœ¨æ¥å£ä¸Šä½¿ç”¨ @Transactional æ³¨è§£ åŸå› ï¼šåœ¨æ¥å£ä¸Šä½¿ç”¨æ³¨è§£ï¼Œåªæœ‰åœ¨ä½¿ç”¨åŸºäºæ¥å£çš„ä»£ç†ï¼ˆJDKï¼‰æ—¶æ‰ä¼šç”Ÿæ•ˆï¼Œå› ä¸ºæ³¨è§£æ˜¯ä¸èƒ½ç»§æ‰¿çš„ï¼Œè¿™å°±æ„å‘³ç€å¦‚æœæ­£åœ¨ä½¿ç”¨åŸºäºç±»çš„ä»£ç†ï¼ˆCGLIBï¼‰æ—¶ï¼Œé‚£ä¹ˆäº‹åŠ¡çš„è®¾ç½®å°†ä¸èƒ½è¢«åŸºäºç±»çš„ä»£ç†æ‰€è¯†åˆ« æ­£ç¡®çš„è®¾ç½® @Transactional çš„ rollbackFor å’Œ propagation å±æ€§ï¼Œå¦åˆ™äº‹åŠ¡å¯èƒ½ä¼šå›æ»šå¤±è´¥ é»˜è®¤æƒ…å†µä¸‹ï¼Œäº‹åŠ¡åªæœ‰é‡åˆ°è¿è¡ŒæœŸå¼‚å¸¸ å’Œ Error ä¼šå¯¼è‡´äº‹åŠ¡å›æ»šï¼Œä½†æ˜¯åœ¨é‡åˆ°æ£€æŸ¥å‹ï¼ˆCheckedï¼‰å¼‚å¸¸æ—¶ä¸ä¼šå›æ»š ç»§æ‰¿è‡ª RuntimeException æˆ– error çš„æ˜¯éæ£€æŸ¥å‹å¼‚å¸¸ï¼Œæ¯”å¦‚ç©ºæŒ‡é’ˆå’Œç´¢å¼•è¶Šç•Œï¼Œè€Œç»§æ‰¿è‡ª Exception çš„åˆ™æ˜¯æ£€æŸ¥å‹å¼‚å¸¸ï¼Œæ¯”å¦‚ IOExceptionã€ClassNotFoundExceptionï¼ŒRuntimeException æœ¬èº«ç»§æ‰¿ Exception éæ£€æŸ¥å‹ç±»å¼‚å¸¸å¯ä»¥ä¸ç”¨æ•è·ï¼Œè€Œæ£€æŸ¥å‹å¼‚å¸¸åˆ™å¿…é¡»ç”¨ try è¯­å¥å—æŠŠå¼‚å¸¸äº¤ç»™ä¸Šçº§æ–¹æ³•ï¼Œè¿™æ ·äº‹åŠ¡æ‰èƒ½æœ‰æ•ˆ äº‹åŠ¡ä¸ç”Ÿæ•ˆçš„é—®é¢˜ æƒ…å†µ 1ï¼šç¡®è®¤åˆ›å»ºçš„ MySQL æ•°æ®åº“è¡¨å¼•æ“æ˜¯ InnoDBï¼ŒMyISAM ä¸æ”¯æŒäº‹åŠ¡ æƒ…å†µ 2ï¼šæ³¨è§£åˆ° protectedï¼Œprivate æ–¹æ³•ä¸Šäº‹åŠ¡ä¸ç”Ÿæ•ˆï¼Œä½†ä¸ä¼šæŠ¥é”™ åŸå› ï¼šç†è®ºä¸Šè€Œè¨€ï¼Œä¸ç”¨ public ä¿®é¥°ï¼Œä¹Ÿå¯ä»¥ç”¨ aop å®ç°äº‹åŠ¡çš„åŠŸèƒ½ï¼Œä½†æ˜¯æ–¹æ³•ç§æœ‰åŒ–è®©å…¶ä»–ä¸šåŠ¡æ— æ³•è°ƒç”¨ AopUtils.canApplyï¼šmethodMatcher.matches(method, targetClass) --true--&gt; return trueTransactionAttributeSourcePointcut.matches() ï¼ŒAbstractFallbackTransactionAttributeSource ä¸­ getTransactionAttribute æ–¹æ³•è°ƒç”¨äº†å…¶æœ¬èº«çš„ computeTransactionAttribute æ–¹æ³•ï¼Œå½“åŠ äº†äº‹åŠ¡æ³¨è§£çš„æ–¹æ³•ä¸æ˜¯ public æ—¶ï¼Œè¯¥æ–¹æ³•ç›´æ¥è¿”å› nullï¼Œæ‰€ä»¥é€ æˆå¢å¼ºä¸åŒ¹é… 123456private TransactionAttribute computeTransactionAttribute(Method method, Class&lt;?&gt; targetClass) &#123; // Don&#x27;t allow no-public methods as required. if (allowPublicMethodsOnly() &amp;&amp; !Modifier.isPublic(method.getModifiers())) &#123; return null; &#125;&#125; æƒ…å†µ 3ï¼šæ³¨è§£æ‰€åœ¨çš„ç±»æ²¡æœ‰è¢«åŠ è½½æˆ Bean æƒ…å†µ 4ï¼šåœ¨ä¸šåŠ¡å±‚æ•æ‰å¼‚å¸¸åæœªå‘ä¸ŠæŠ›å‡ºï¼Œäº‹åŠ¡ä¸ç”Ÿæ•ˆ åŸå› ï¼šåœ¨ä¸šåŠ¡å±‚æ•æ‰å¹¶å¤„ç†äº†å¼‚å¸¸ï¼ˆtry..catchï¼‰ç­‰äºæŠŠå¼‚å¸¸å¤„ç†æ‰äº†ï¼ŒSpring å°±ä¸çŸ¥é“è¿™é‡Œæœ‰é”™ï¼Œä¹Ÿä¸ä¼šä¸»åŠ¨å»å›æ»šæ•°æ®ï¼Œæ¨èåšæ³•æ˜¯åœ¨ä¸šåŠ¡å±‚ç»Ÿä¸€æŠ›å‡ºå¼‚å¸¸ï¼Œç„¶ååœ¨æ§åˆ¶å±‚ç»Ÿä¸€å¤„ç† æƒ…å†µ 5ï¼šé‡åˆ°æ£€æµ‹å¼‚å¸¸æ—¶ï¼Œä¹Ÿæ— æ³•å›æ»š åŸå› ï¼šSpring çš„é»˜è®¤çš„äº‹åŠ¡è§„åˆ™æ˜¯é‡åˆ°è¿è¡Œå¼‚å¸¸ï¼ˆRuntimeExceptionï¼‰å’Œç¨‹åºé”™è¯¯ï¼ˆErrorï¼‰æ‰ä¼šå›æ»šã€‚æƒ³é’ˆå¯¹æ£€æµ‹å¼‚å¸¸è¿›è¡Œäº‹åŠ¡å›æ»šï¼Œå¯ä»¥åœ¨ @Transactional æ³¨è§£é‡Œä½¿ç”¨ rollbackFor å±æ€§æ˜ç¡®æŒ‡å®šå¼‚å¸¸ æƒ…å†µ 6ï¼šSpring çš„äº‹åŠ¡ä¼ æ’­ç­–ç•¥åœ¨å†…éƒ¨æ–¹æ³•è°ƒç”¨æ—¶å°†ä¸èµ·ä½œç”¨ï¼Œåœ¨ä¸€ä¸ª Service å†…éƒ¨ï¼Œäº‹åŠ¡æ–¹æ³•ä¹‹é—´çš„åµŒå¥—è°ƒç”¨ï¼Œæ™®é€šæ–¹æ³•å’Œäº‹åŠ¡æ–¹æ³•ä¹‹é—´çš„åµŒå¥—è°ƒç”¨ï¼Œéƒ½ä¸ä¼šå¼€å¯æ–°çš„äº‹åŠ¡ï¼Œäº‹åŠ¡æ³¨è§£è¦åŠ åˆ°è°ƒç”¨æ–¹æ³•ä¸Šæ‰ç”Ÿæ•ˆ åŸå› ï¼šSpring çš„äº‹åŠ¡éƒ½æ˜¯ä½¿ç”¨ AOP ä»£ç†çš„æ¨¡å¼ï¼ŒåŠ¨æ€ä»£ç† invoke åä¼šè°ƒç”¨åŸå§‹å¯¹è±¡ï¼Œè€ŒåŸå§‹å¯¹è±¡åœ¨å»è°ƒç”¨æ–¹æ³•æ—¶æ˜¯ä¸ä¼šè§¦å‘æ‹¦æˆªå™¨ï¼Œå°±æ˜¯ä¸€ä¸ªæ–¹æ³•è°ƒç”¨æœ¬å¯¹è±¡çš„å¦ä¸€ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥äº‹åŠ¡ä¹Ÿå°±æ— æ³•ç”Ÿæ•ˆ 123456@Transactionalpublic int add()&#123; update();&#125;//æ³¨è§£æ·»åŠ åœ¨updateæ–¹æ³•ä¸Šæ— æ•ˆï¼Œéœ€è¦æ·»åŠ åˆ°add()æ–¹æ³•ä¸Špublic int update()&#123;&#125; æƒ…å†µ 7ï¼šæ³¨è§£åœ¨æ¥å£ä¸Šï¼Œä»£ç†å¯¹è±¡æ˜¯ CGLIB ä½¿ç”¨æ³¨è§£ Dao å±‚ 1234567public interface AccountDao &#123; @Update(&quot;update account set money = money + #&#123;money&#125; where name = #&#123;name&#125;&quot;) void inMoney(@Param(&quot;name&quot;) String name, @Param(&quot;money&quot;) Double money); @Update(&quot;update account set money = money - #&#123;money&#125; where name = #&#123;name&#125;&quot;) void outMoney(@Param(&quot;name&quot;) String name, @Param(&quot;money&quot;) Double money);&#125; ä¸šåŠ¡å±‚ 123456789101112public interface AccountService &#123; //å¯¹å½“å‰æ–¹æ³•æ·»åŠ äº‹åŠ¡ï¼Œè¯¥é…ç½®å°†æ›¿æ¢æ¥å£çš„é…ç½® @Transactional( readOnly = false, timeout = -1, isolation = Isolation.DEFAULT, rollbackFor = &#123;&#125;,//java.lang.ArithmeticException.class, IOException.class noRollbackFor = &#123;&#125;, propagation = Propagation.REQUIRED ) public void transfer(String outName, String inName, Double money);&#125; 123456789public class AccountServiceImpl implements AccountService &#123; @Autowired private AccountDao accountDao; public void transfer(String outName, String inName, Double money) &#123; accountDao.inMoney(outName,money); //int i = 1/0; accountDao.outMoney(inName,money); &#125;&#125; æ·»åŠ æ–‡ä»¶ Spring.configã€Mybatis.configã€JDBCConfig (å‚è€ƒioc_Mybatis)ã€TransactionManagerConfig 1234567@Configuration@ComponentScan(&#123;&quot;&quot;,&quot;&quot;,&quot;&quot;&#125;)@PropertySource(&quot;classpath:jdbc.properties&quot;)@Import(&#123;JDBCConfig.class,MyBatisConfig.class&#125;)@EnableTransactionManagementpublic class SpringConfig &#123;&#125; æ¨¡æ¿å¯¹è±¡Spring æ¨¡æ¿å¯¹è±¡ï¼šTransactionTemplateã€JdbcTemplateã€RedisTemplateã€RabbitTemplateã€JmsTemplateã€HibernateTemplateã€RestTemplate JdbcTemplateï¼šæä¾›æ ‡å‡†çš„ sql è¯­å¥æ“ä½œAPI NamedParameterJdbcTemplateï¼šæä¾›æ ‡å‡†çš„å…·å sql è¯­å¥æ“ä½œAPI RedisTemplateï¼š 1234567public void changeMoney(Integer id, Double money) &#123; redisTemplate.opsForValue().set(&quot;account:id:&quot;+id,money);&#125;public Double findMondyById(Integer id) &#123; Object money = redisTemplate.opsForValue().get(&quot;account:id:&quot; + id); return new Double(money.toString());&#125; åŸç†XMLä¸‰å¤§å¯¹è±¡ï¼š BeanDefinitionï¼šæ˜¯ Spring ä¸­æå…¶é‡è¦çš„ä¸€ä¸ªæ¦‚å¿µï¼Œå­˜å‚¨äº† bean å¯¹è±¡çš„æ‰€æœ‰ç‰¹å¾ä¿¡æ¯ï¼Œå¦‚æ˜¯å¦å•ä¾‹ã€æ˜¯å¦æ‡’åŠ è½½ã€factoryBeanName ç­‰ï¼Œå’Œ bean çš„å…³ç³»å°±æ˜¯ç±»ä¸å¯¹è±¡çš„å…³ç³»ï¼Œä¸€ä¸ªä¸åŒçš„ bean å¯¹åº”ä¸€ä¸ª BeanDefinition BeanDefinationRegistryï¼šå­˜æ”¾ BeanDefination çš„å®¹å™¨ï¼Œæ˜¯ä¸€ç§é”®å€¼å¯¹çš„å½¢å¼ï¼Œé€šè¿‡ç‰¹å®šçš„ Bean å®šä¹‰çš„ idï¼Œæ˜ å°„åˆ°ç›¸åº”çš„ BeanDefinationï¼ŒBeanFactory çš„å®ç°ç±»åŒæ ·ç»§æ‰¿ BeanDefinationRegistry æ¥å£ï¼Œæ‹¥æœ‰ä¿å­˜ BD çš„èƒ½åŠ› BeanDefinitionReaderï¼šè¯»å–é…ç½®æ–‡ä»¶ï¼ŒXML ç”¨ Dom4j è§£æï¼Œæ³¨è§£ç”¨ IO æµåŠ è½½è§£æ ç¨‹åºï¼š 12BeanFactory bf = new XmlBeanFactory(new ClassPathResource(&quot;applicationContext.xml&quot;));UserService userService1 = (UserService)bf.getBean(&quot;userService&quot;); æºç è§£æï¼š 123456789public XmlBeanFactory(Resource resource, BeanFactory parentBeanFactory) &#123; super(parentBeanFactory); this.reader.loadBeanDefinitions(resource);&#125;public int loadBeanDefinitions(Resource resource) &#123; //å°† resource åŒ…è£…æˆå¸¦ç¼–ç æ ¼å¼çš„ EncodedResource //EncodedResource ä¸­ getReader()æ–¹æ³•ï¼Œè°ƒç”¨java.ioåŒ…ä¸‹çš„ è½¬æ¢æµ åˆ›å»ºæŒ‡å®šç¼–ç çš„è¾“å…¥æµå¯¹è±¡ return loadBeanDefinitions(new EncodedResource(resource));&#125; XmlBeanDefinitionReader.loadBeanDefinitions()ï¼šæŠŠ Resource è§£ææˆ BeanDefinition å¯¹è±¡ currentResources = this.resourcesCurrentlyBeingLoaded.get()ï¼šæ‹¿åˆ°å½“å‰çº¿ç¨‹å·²ç»åŠ è½½è¿‡çš„æ‰€æœ‰ EncodedResoure èµ„æºï¼Œç”¨ ThreadLocal ä¿è¯çº¿ç¨‹å®‰å…¨ if (currentResources == null)ï¼šåˆ¤æ–­ currentResources æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºåˆ™è¿›è¡Œåˆå§‹åŒ– if (!currentResources.add(encodedResource))ï¼šå¦‚æœå·²ç»åŠ è½½è¿‡è¯¥èµ„æºä¼šæŠ¥é”™ï¼Œé˜²æ­¢é‡å¤åŠ è½½ inputSource = new InputSource(inputStream)ï¼šèµ„æºå¯¹è±¡åŒ…è£…æˆ InputSourceï¼ŒInputSource æ˜¯ SAX ä¸­çš„èµ„æºå¯¹è±¡ï¼Œç”¨æ¥è¿›è¡Œ XML æ–‡ä»¶çš„è§£æ return doLoadBeanDefinitions()ï¼šåŠ è½½è¿”å› currentResources.remove(encodedResource)ï¼šåŠ è½½å®Œæˆç§»é™¤å½“å‰ encodedResource resourcesCurrentlyBeingLoaded.remove()ï¼šThreadLocal ä¸ºç©ºæ—¶ç§»é™¤å…ƒç´ ï¼Œé˜²æ­¢å†…å­˜æ³„éœ² XmlBeanDefinitionReader.doLoadBeanDefinitions(inputSource, resource)ï¼šçœŸæ­£çš„åŠ è½½å‡½æ•° Document doc = doLoadDocument(inputSource, resource)ï¼šè½¬æ¢æˆæœ‰å±‚æ¬¡ç»“æ„çš„ Document å¯¹è±¡ getEntityResolver()ï¼šè·å–ç”¨æ¥è§£æ DTDã€XSD çº¦æŸçš„è§£æå™¨ getValidationModeForResource(resource)ï¼šè·å–éªŒè¯æ¨¡å¼ int count = registerBeanDefinitions(doc, resource)ï¼šå°† Document è§£ææˆ BD å¯¹è±¡ï¼Œæ³¨å†Œï¼ˆæ·»åŠ ï¼‰åˆ° BeanDefinationRegistry ä¸­ï¼Œè¿”å›æ–°æ³¨å†Œçš„æ•°é‡ createBeanDefinitionDocumentReader()ï¼šåˆ›å»º DefaultBeanDefinitionDocumentReader å¯¹è±¡ getRegistry().getBeanDefinitionCount()ï¼šè·å–è§£æå‰ BeanDefinationRegistry ä¸­çš„ bd æ•°é‡ registerBeanDefinitions(doc, readerContext)ï¼šæ³¨å†Œ BD this.readerContext = readerContextï¼šä¿å­˜ä¸Šä¸‹æ–‡å¯¹è±¡ doRegisterBeanDefinitions(doc.getDocumentElement())ï¼šçœŸæ­£çš„æ³¨å†Œ BD å‡½æ•° doc.getDocumentElement()ï¼šæ‹¿å‡ºé¡¶å±‚æ ‡ç­¾ return getRegistry().getBeanDefinitionCount() - countBeforeï¼šè¿”å›æ–°åŠ å…¥çš„æ•°é‡ DefaultBeanDefinitionDocumentReader.doRegisterBeanDefinitions()ï¼šæ³¨å†Œ BD åˆ° BR createDelegate(getReaderContext(), root, parent)ï¼šbeans æ˜¯æ ‡ç­¾çš„è§£æå™¨å¯¹è±¡ delegate.isDefaultNamespace(root)ï¼šåˆ¤æ–­ beans æ ‡ç­¾æ˜¯å¦æ˜¯é»˜è®¤çš„å±æ€§ root.getAttribute(PROFILE_ATTRIBUTE)ï¼šè§£æ profile å±æ€§ preProcessXml(root)ï¼šè§£æå‰ç½®å¤„ç†ï¼Œè‡ªå®šä¹‰å®ç° parseBeanDefinitions(root, this.delegate)ï¼šè§£æ beans æ ‡ç­¾ä¸­çš„å­æ ‡ç­¾ parseDefaultElement(ele, delegate)ï¼šå¦‚æœæ˜¯é»˜è®¤çš„æ ‡ç­¾ï¼Œç”¨è¯¥æ–¹æ³•è§£æå­æ ‡ç­¾ åˆ¤æ–­æ ‡ç­¾åç§°ï¼Œè¿›è¡Œç›¸åº”çš„è§£æ processBeanDefinition(ele, delegate)ï¼š delegate.parseCustomElement(ele)ï¼šè§£æè‡ªå®šä¹‰çš„æ ‡ç­¾ postProcessXml(root)ï¼šè§£æåç½®å¤„ç† DefaultBeanDefinitionDocumentReader.processBeanDefinition()ï¼šè§£æ bean æ ‡ç­¾å¹¶æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ delegate.parseBeanDefinitionElement(ele)ï¼šè§£æ bean æ ‡ç­¾å°è£…ä¸º BeanDefinitionHolder if (!StringUtils.hasText(beanName) &amp;&amp; !aliases.isEmpty())ï¼šæ¡ä»¶ä¸€æˆç«‹è¯´æ˜ name æ²¡æœ‰å€¼ï¼Œæ¡ä»¶äºŒæˆç«‹è¯´æ˜åˆ«åæœ‰å€¼ beanName = aliases.remove(0)ï¼šæ‹¿åˆ«ååˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ å½“ä½œ beanName parseBeanDefinitionElement(ele, beanName, containingBean)ï¼šè§£æ bean æ ‡ç­¾ parseState.push(new BeanEntry(beanName))ï¼šå½“å‰è§£æå™¨çš„çŠ¶æ€è®¾ç½®ä¸º BeanEntry class å’Œ parent å±æ€§å­˜åœ¨ä¸€ä¸ªï¼Œparent æ˜¯ä½œä¸ºçˆ¶æ ‡ç­¾ä¸ºäº†è¢«ç»§æ‰¿ createBeanDefinition(className, parent)ï¼šè®¾ç½®äº†class çš„ GenericBeanDefinitionå¯¹è±¡ parseBeanDefinitionAttributes()ï¼šè§£æ bean æ ‡ç­¾çš„å±æ€§ æ¥ä¸‹æ¥è§£æå­æ ‡ç­¾ beanName = this.readerContext.generateBeanName(beanDefinition)ï¼šç”Ÿæˆ className + # + åºå·çš„åç§°èµ‹å€¼ç»™ beanName return new BeanDefinitionHolder(beanDefinition, beanName, aliases)ï¼šåŒ…è£…æˆ BeanDefinitionHolder registerBeanDefinition(bdHolder, getReaderContext().getRegistry())ï¼šæ³¨å†Œåˆ°å®¹å™¨ beanName = definitionHolder.getBeanName()ï¼šè·å–beanName this.beanDefinitionMap.put(beanName, beanDefinition)ï¼šæ·»åŠ åˆ°æ³¨å†Œä¸­å¿ƒ getReaderContext().fireComponentRegistered()ï¼šå‘é€æ³¨å†Œå®Œæˆäº‹ä»¶ è¯´æ˜ï¼šæºç éƒ¨åˆ†çš„ç¬”è®°ä¸ä¸€å®šé€‚åˆæ‰€æœ‰äººé˜…è¯»ï¼Œä½œè€…é‡‡ç”¨æµæ°´çº¿å¼å»è§£æé‡è¦çš„ä»£ç ï¼Œè§£æçš„ç»“æ„ç±»ä¼¼äºæ ‘çŠ¶ï¼Œå¦‚æœè§†è§‰ç–²åŠ³å¯ä»¥å»ç½‘ä¸Šå‚è€ƒä¸€äº›åšå®¢å’Œæµç¨‹å›¾å­¦ä¹ æºç ã€‚ IOCå®¹å™¨å¯åŠ¨Spring IOC å®¹å™¨æ˜¯ ApplicationContext æˆ–è€… BeanFactoryï¼Œä½¿ç”¨å¤šä¸ª Map é›†åˆä¿å­˜å•å®ä¾‹ Beanï¼Œç¯å¢ƒä¿¡æ¯ç­‰èµ„æºï¼Œä¸åŒå±‚çº§æœ‰ä¸åŒçš„å®¹å™¨ï¼Œæ¯”å¦‚æ•´åˆ SpringMVC çš„çˆ¶å­å®¹å™¨ï¼ˆå…ˆçœ‹ Bean éƒ¨åˆ†çš„æºç è§£æå†å›çœ‹å®¹å™¨ï¼‰ ClassPathXmlApplicationContext ä¸ AnnotationConfigApplicationContext å·®ä¸å¤šï¼š 12345public AnnotationConfigApplicationContext(Class&lt;?&gt;... annotatedClasses) &#123; this(); register(annotatedClasses);// è§£æé…ç½®ç±»ï¼Œå°è£…æˆä¸€ä¸ª BeanDefinitionHolderï¼Œå¹¶æ³¨å†Œåˆ°å®¹å™¨ refresh();// åŠ è½½åˆ·æ–°å®¹å™¨ä¸­çš„ Bean&#125; 123456public AnnotationConfigApplicationContext() &#123; // æ³¨å†Œ Spring çš„æ³¨è§£è§£æå™¨åˆ°å®¹å™¨ this.reader = new AnnotatedBeanDefinitionReader(this); // å®ä¾‹åŒ–è·¯å¾„æ‰«æå™¨ï¼Œç”¨äºå¯¹æŒ‡å®šçš„åŒ…ç›®å½•è¿›è¡Œæ‰«ææŸ¥æ‰¾ bean å¯¹è±¡ this.scanner = new ClassPathBeanDefinitionScanner(this);&#125; AbstractApplicationContext.refresh()ï¼š prepareRefresh()ï¼šåˆ·æ–°å‰çš„é¢„å¤„ç† this.startupDate = System.currentTimeMillis()ï¼šè®¾ç½®å®¹å™¨çš„å¯åŠ¨æ—¶é—´ initPropertySources()ï¼šåˆå§‹åŒ–ä¸€äº›å±æ€§è®¾ç½®ï¼Œå¯ä»¥è‡ªå®šä¹‰ä¸ªæ€§åŒ–çš„å±æ€§è®¾ç½®æ–¹æ³• getEnvironment().validateRequiredProperties()ï¼šæ£€æŸ¥ç¯å¢ƒå˜é‡ earlyApplicationEvents= new LinkedHashSet&lt;ApplicationEvent&gt;()ï¼šä¿å­˜å®¹å™¨ä¸­æ—©æœŸçš„äº‹ä»¶ obtainFreshBeanFactory()ï¼šè·å–ä¸€ä¸ªå…¨æ–°çš„ BeanFactory æ¥å£å®ä¾‹ï¼Œå¦‚æœå®¹å™¨ä¸­å­˜åœ¨å·¥å‚å®ä¾‹ç›´æ¥é”€æ¯ refreshBeanFactory()ï¼šåˆ›å»º BeanFactoryï¼Œè®¾ç½®åºåˆ—åŒ– IDã€è¯»å– BeanDefinition å¹¶åŠ è½½åˆ°å·¥å‚ if (hasBeanFactory())ï¼šapplicationContext å†…éƒ¨æ‹¥æœ‰ä¸€ä¸ª beanFactory å®ä¾‹ï¼Œéœ€è¦å°†è¯¥å®ä¾‹å®Œå…¨é‡Šæ”¾é”€æ¯ destroyBeans()ï¼šé”€æ¯åŸ beanFactory å®ä¾‹ï¼Œå°† beanFactory å†…éƒ¨ç»´æŠ¤çš„å•å®ä¾‹ bean å…¨éƒ¨æ¸…æ‰ï¼Œå¦‚æœå“ªä¸ª bean å®ç°äº† Disposablejieæ¥å£ï¼Œè¿˜ä¼šè¿›è¡Œ bean distroy æ–¹æ³•çš„è°ƒç”¨å¤„ç† this.singletonsCurrentlyInDestruction = trueï¼šè®¾ç½®å½“å‰ beanFactory çŠ¶æ€ä¸ºé”€æ¯çŠ¶æ€ String[] disposableBeanNamesï¼šè·å–é”€æ¯é›†åˆä¸­çš„ beanï¼Œå¦‚æœå½“å‰ bean æœ‰ææ„å‡½æ•°å°±ä¼šåœ¨é”€æ¯é›†åˆ destroySingleton(disposableBeanNames[i])ï¼šéå†æ‰€æœ‰çš„ disposableBeansï¼Œæ‰§è¡Œé”€æ¯æ–¹æ³• removeSingleton(beanName)ï¼šæ¸…é™¤ä¸‰çº§ç¼“å­˜å’Œ registeredSingletons ä¸­çš„å½“å‰ beanName çš„æ•°æ® this.disposableBeans.remove(beanName)ï¼šä»é”€æ¯é›†åˆä¸­æ¸…é™¤ï¼Œæ¯ä¸ª bean åªèƒ½ destroy ä¸€æ¬¡ destroyBean(beanName, disposableBean)ï¼šé”€æ¯ bean dependentBeanMap è®°å½•äº†ä¾èµ–å½“å‰ bean çš„å…¶ä»– bean ä¿¡æ¯ï¼Œå› ä¸ºä¾èµ–çš„å¯¹è±¡è¦è¢«å›æ”¶äº†ï¼Œæ‰€ä»¥ä¾èµ–å½“å‰ bean çš„å…¶ä»–å¯¹è±¡éƒ½è¦æ‰§è¡Œ destroySingletonï¼Œéå† dependentBeanMap æ‰§è¡Œé”€æ¯ bean.destroy()ï¼šè§£å†³å®Œæˆä¾èµ–åï¼Œæ‰§è¡Œ DisposableBean çš„ destroy æ–¹æ³• this.dependenciesForBeanMap.remove(beanName)ï¼šä¿å­˜å½“å‰ bean ä¾èµ–äº†è°ï¼Œç›´æ¥æ¸…é™¤ è¿›è¡Œä¸€äº›é›†åˆå’Œç¼“å­˜çš„æ¸…ç†å·¥ä½œ closeBeanFactory()ï¼šå°†å®¹å™¨å†…éƒ¨çš„ beanFactory è®¾ç½®ä¸ºç©ºï¼Œé‡æ–°åˆ›å»º beanFactory = createBeanFactory()ï¼šåˆ›å»ºæ–°çš„ DefaultListableBeanFactory å¯¹è±¡ beanFactory.setSerializationId(getId())ï¼šè¿›è¡Œ ID çš„è®¾ç½®ï¼Œå¯ä»¥æ ¹æ® ID è·å– BeanFactory å¯¹è±¡ customizeBeanFactory(beanFactory)ï¼šè®¾ç½®æ˜¯å¦å…è®¸è¦†ç›–å’Œå¾ªç¯å¼•ç”¨ loadBeanDefinitions(beanFactory)ï¼šåŠ è½½ BeanDefinition ä¿¡æ¯ï¼Œæ³¨å†Œ BDæ³¨å†Œåˆ° BeanFactory ä¸­ this.beanFactory = beanFactoryï¼šæŠŠ beanFactory å¡«å……è‡³å®¹å™¨ä¸­ getBeanFactory()ï¼šè¿”å›åˆ›å»ºçš„ DefaultListableBeanFactory å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç»§æ‰¿ BeanDefinitionRegistry prepareBeanFactory(beanFactory)ï¼šBeanFactory çš„é¢„å‡†å¤‡å·¥ä½œï¼Œå‘å®¹å™¨ä¸­æ·»åŠ ä¸€äº›ç»„ä»¶ setBeanClassLoader(getClassLoader())ï¼šç»™å½“å‰ bf è®¾ç½®ä¸€ä¸ªç±»åŠ è½½å™¨ï¼ŒåŠ è½½ bd çš„ class ä¿¡æ¯ setBeanExpressionResolver()ï¼šè®¾ç½® EL è¡¨è¾¾å¼è§£æå™¨ addPropertyEditorRegistrarï¼šæ·»åŠ ä¸€ä¸ªå±æ€§ç¼–è¾‘å™¨ï¼Œè§£å†³å±æ€§æ³¨å…¥æ—¶çš„æ ¼å¼è½¬æ¢ addBeanPostProcessor()ï¼šæ·»åŠ åå¤„ç†å™¨ï¼Œä¸»è¦ç”¨äºå‘ bean å†…éƒ¨æ³¨å…¥ä¸€äº›æ¡†æ¶çº§åˆ«çš„å®ä¾‹ ignoreDependencyInterface()ï¼šè®¾ç½®å¿½ç•¥è‡ªåŠ¨è£…é…çš„æ¥å£ï¼Œbean å†…éƒ¨çš„è¿™äº›ç±»å‹çš„å­—æ®µ ä¸å‚ä¸ä¾èµ–æ³¨å…¥ registerResolvableDependency()ï¼šæ³¨å†Œä¸€äº›ç±»å‹ä¾èµ–å…³ç³» addBeanPostProcessor()ï¼šå°†é…ç½®çš„ç›‘å¬è€…æ³¨å†Œåˆ°å®¹å™¨ä¸­ï¼Œå½“å‰ bean å®ç° ApplicationListener æ¥å£å°±æ˜¯ç›‘å¬å™¨äº‹ä»¶ beanFactory.registerSingleton()ï¼šæ·»åŠ ä¸€äº›ç³»ç»Ÿä¿¡æ¯ postProcessBeanFactory(beanFactory)ï¼šBeanFactory å‡†å¤‡å·¥ä½œå®Œæˆåè¿›è¡Œçš„åç½®å¤„ç†å·¥ä½œï¼Œæ‰©å±•æ–¹æ³• invokeBeanFactoryPostProcessors(beanFactory)ï¼šæ‰§è¡Œ BeanFactoryPostProcessor çš„æ–¹æ³• processedBeans = new HashSet&lt;&gt;()ï¼šå­˜å‚¨å·²ç»æ‰§è¡Œè¿‡çš„ BeanFactoryPostProcessor çš„ beanName if (beanFactory instanceof BeanDefinitionRegistry)ï¼šå½“å‰ BeanFactory æ˜¯ bd çš„æ³¨å†Œä¸­å¿ƒï¼Œbd å…¨éƒ¨æ³¨å†Œåˆ° bf for (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors)ï¼šéå†æ‰€æœ‰çš„ bf åç½®å¤„ç†å™¨ if (postProcessor instanceof BeanDefinitionRegistryPostProcessor)ï¼šæ˜¯ Registry ç±»çš„åç½®å¤„ç†å™¨ registryProcessor.postProcessBeanDefinitionRegistry(registry)ï¼šå‘ bf ä¸­æ³¨å†Œä¸€äº› bd registryProcessors.add(registryProcessor)ï¼šæ·»åŠ åˆ° BeanDefinitionRegistryPostProcessor é›†åˆ regularPostProcessors.add(postProcessor)ï¼šæ·»åŠ åˆ° BeanFactoryPostProcessor é›†åˆ é€»è¾‘åˆ°è¿™é‡Œå·²ç»è·å–åˆ°æ‰€æœ‰ BeanDefinitionRegistryPostProcessor å’Œ BeanFactoryPostProcessor æ¥å£ç±»å‹çš„åç½®å¤„ç†å™¨ é¦–å…ˆå›è°ƒ BeanDefinitionRegistryPostProcessor ç±»çš„åç½®å¤„ç†æ–¹æ³• postProcessBeanDefinitionRegistry() è·å–å®ç°äº† PriorityOrderedï¼ˆä¸»æ’åºæ¥å£ï¼‰æ¥å£çš„ bdrppï¼Œè¿›è¡Œ sort æ’åºï¼Œç„¶åå…¨éƒ¨æ‰§è¡Œå¹¶æ”¾å…¥å·²ç»å¤„ç†è¿‡çš„é›†åˆ å†æ‰§è¡Œå®ç°äº† Orderedï¼ˆæ¬¡æ’åºæ¥å£ï¼‰æ¥å£çš„ bdrpp æœ€åæ‰§è¡Œæ²¡æœ‰å®ç°ä»»ä½•ä¼˜å…ˆçº§æˆ–è€…æ˜¯é¡ºåºæ¥å£ bdrppï¼Œboolean reiterate = true æ§åˆ¶ while æ˜¯å¦éœ€è¦å†æ¬¡å¾ªç¯ï¼Œå¾ªç¯å†…æ˜¯æŸ¥æ‰¾å¹¶æ‰§è¡Œ bdrpp åå¤„ç†å™¨çš„ registry ç›¸å…³çš„æ¥å£æ–¹æ³•ï¼Œæ¥å£æ–¹æ³•æ‰§è¡Œä»¥åä¼šå‘ bf å†…æ³¨å†Œ bdï¼Œæ³¨å†Œçš„ bd ä¹Ÿæœ‰å¯èƒ½æ˜¯ bdrpp ç±»å‹ï¼Œæ‰€ä»¥éœ€è¦è¯¥å˜é‡æ§åˆ¶å¾ªç¯ processedBeans.add(ppName)ï¼šå·²ç»æ‰§è¡Œè¿‡çš„åç½®å¤„ç†å™¨å­˜å‚¨åˆ°è¯¥é›†åˆä¸­ï¼Œé˜²æ­¢é‡å¤æ‰§è¡Œ invokeBeanFactoryPostProcessors()ï¼šbdrpp ç»§æ‰¿äº† BeanFactoryPostProcessorï¼Œæœ‰ postProcessBeanFactory æ–¹æ³• æ‰§è¡Œæ™®é€š BeanFactoryPostProcessor çš„ç›¸å…³ postProcessBeanFactory æ–¹æ³•ï¼ŒæŒ‰ç…§ä¸»æ¬¡æ— æ¬¡åºæ‰§è¡Œ if (processedBeans.contains(ppName))ï¼šä¼šè¿‡æ»¤æ‰å·²ç»æ‰§è¡Œè¿‡çš„åç½®å¤„ç†å™¨ beanFactory.clearMetadataCache()ï¼šæ¸…é™¤ç¼“å­˜ä¸­åˆå¹¶çš„ Bean å®šä¹‰ï¼Œå› ä¸ºåç½®å¤„ç†å™¨å¯èƒ½æ›´æ”¹äº†å…ƒæ•°æ® ä»¥ä¸Šæ˜¯ BeanFactory çš„åˆ›å»ºåŠé¢„å‡†å¤‡å·¥ä½œï¼Œæ¥ä¸‹æ¥è¿›å…¥ Bean çš„æµç¨‹ registerBeanPostProcessors(beanFactory)ï¼šæ³¨å†Œ Bean çš„åç½®å¤„ç†å™¨ï¼Œä¸ºäº†å¹²é¢„ Spring åˆå§‹åŒ– bean çš„æµç¨‹ï¼Œè¿™é‡Œä»…ä»…æ˜¯å‘å®¹å™¨ä¸­æ³¨å…¥è€Œéä½¿ç”¨ beanFactory.getBeanNamesForType(BeanPostProcessor.class)ï¼šè·å–é…ç½®ä¸­å®ç°äº† BeanPostProcessor æ¥å£ç±»å‹ int beanProcessorTargetCountï¼šåç½®å¤„ç†å™¨çš„æ•°é‡ï¼Œå·²ç»æ³¨å†Œçš„ + æœªæ³¨å†Œçš„ + å³å°†è¦æ·»åŠ çš„ä¸€ä¸ª beanFactory.addBeanPostProcessor(new BeanPostProcessorChecker())ï¼šæ·»åŠ ä¸€ä¸ªæ£€æŸ¥å™¨ BeanPostProcessorChecker.postProcessAfterInitialization()ï¼šåˆå§‹åŒ–åçš„åå¤„ç†å™¨æ–¹æ³• !(bean instanceof BeanPostProcessor) ï¼šå½“å‰ bean ç±»å‹æ˜¯æ™®é€š beanï¼Œä¸æ˜¯åç½®å¤„ç†å™¨ !isInfrastructureBean(beanName)ï¼šæˆç«‹è¯´æ˜å½“å‰ beanName æ˜¯ç”¨æˆ·çº§åˆ«çš„ bean ä¸æ˜¯ Spring æ¡†æ¶çš„ this.beanFactory.getBeanPostProcessorCount() &lt; this.beanPostProcessorTargetCountï¼šBeanFactory ä¸Šé¢æ³¨å†Œåå¤„ç†å™¨æ•°é‡ &lt; åå¤„ç†å™¨æ•°é‡ï¼Œè¯´æ˜åå¤„ç†æ¡†æ¶å°šæœªåˆå§‹åŒ–å®Œæˆ for (String ppName : postProcessorNames)ï¼šéå† PostProcessor é›†åˆï¼Œæ ¹æ®å®ç°ä¸åŒçš„é¡ºåºæ¥å£æ·»åŠ åˆ°ä¸åŒé›†åˆ sortPostProcessors(priorityOrderedPostProcessors, beanFactory)ï¼šå®ç° PriorityOrdered æ¥å£çš„åå¤„ç†å™¨æ’åº registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors)ï¼šæ³¨å†Œåˆ° beanFactory ä¸­ æ¥ç€æ’åºæ³¨å†Œå®ç° Ordered æ¥å£çš„åç½®å¤„ç†å™¨ï¼Œç„¶åæ³¨å†Œæ™®é€šçš„ï¼ˆ æ²¡æœ‰å®ç°ä»»ä½•ä¼˜å…ˆçº§æ¥å£ï¼‰åç½®å¤„ç†å™¨ æœ€åæ’åº MergedBeanDefinitionPostProcessor ç±»å‹çš„å¤„ç†å™¨ï¼Œæ ¹æ®å®ç°çš„æ’åºæ¥å£ï¼Œæ’åºå®Œæ³¨å†Œåˆ° beanFactory ä¸­ beanFactory.addBeanPostProcessor(new ApplicationListenerDetector(applicationContext))ï¼šé‡æ–°æ³¨å†Œ ApplicationListenerDetector åå¤„ç†å™¨ï¼Œç”¨äºåœ¨ Bean åˆ›å»ºå®Œæˆåæ£€æŸ¥æ˜¯å¦å±äº ApplicationListener ç±»å‹ï¼Œå¦‚æœæ˜¯å°±æŠŠ Bean æ”¾åˆ°ç›‘å¬å™¨å®¹å™¨ä¸­ä¿å­˜èµ·æ¥ initMessageSource()ï¼šåˆå§‹åŒ– MessageSource ç»„ä»¶ï¼Œä¸»è¦ç”¨äºåšå›½é™…åŒ–åŠŸèƒ½ï¼Œæ¶ˆæ¯ç»‘å®šä¸æ¶ˆæ¯è§£æ if (beanFactory.containsLocalBean(MESSAGE_SOURCE_BEAN_NAME))ï¼šå®¹å™¨æ˜¯å¦å«æœ‰åç§°ä¸º messageSource çš„ bean beanFactory.getBean(MESSAGE_SOURCE_BEAN_NAME, MessageSource.class)ï¼šå¦‚æœæœ‰è¯æ˜ç”¨æˆ·è‡ªå®šä¹‰äº†è¯¥ç±»å‹çš„ beanï¼Œè·å–åç›´æ¥èµ‹å€¼ç»™ this.messageSource dms = new DelegatingMessageSource()ï¼šå®¹å™¨ä¸­æ²¡æœ‰å°±æ–°å»ºä¸€ä¸ªèµ‹å€¼ initApplicationEventMulticaster()ï¼šåˆå§‹åŒ–äº‹ä»¶ä¼ æ’­å™¨ï¼Œåœ¨æ³¨å†Œç›‘å¬å™¨æ—¶ä¼šç”¨åˆ° if (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME))ï¼šæ¡ä»¶æˆç«‹è¯´æ˜ç”¨æˆ·è‡ªå®šä¹‰äº†äº‹ä»¶ä¼ æ’­å™¨ï¼Œå¯ä»¥å®ç° ApplicationEventMulticaster æ¥å£ç¼–å†™è‡ªå·±çš„äº‹ä»¶ä¼ æ’­å™¨ï¼Œé€šè¿‡ bean çš„æ–¹å¼æä¾›ç»™ Spring å¦‚æœæœ‰å°±ç›´æ¥ä»å®¹å™¨ä¸­è·å–ï¼›å¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºä¸€ä¸ª SimpleApplicationEventMulticaster æ³¨å†Œ onRefresh()ï¼šç•™ç»™ç”¨æˆ·å»å®ç°ï¼Œå¯ä»¥ç¡¬ç¼–ç æä¾›ä¸€äº›ç»„ä»¶ï¼Œæ¯”å¦‚æä¾›ä¸€äº›ç›‘å¬å™¨ registerListeners()ï¼šæ³¨å†Œé€šè¿‡é…ç½®æä¾›çš„ Listenerï¼Œè¿™äº›ç›‘å¬å™¨æœ€ç»ˆæ³¨å†Œåˆ° ApplicationEventMulticaster å†… for (ApplicationListener&lt;?&gt; listener : getApplicationListeners()) ï¼šæ³¨å†Œç¼–ç å®ç°çš„ç›‘å¬å™¨ getBeanNamesForType(ApplicationListener.class, true, false)ï¼šæ³¨å†Œé€šè¿‡é…ç½®æä¾›çš„ Listener multicastEvent(earlyEvent)ï¼šå‘å¸ƒå‰é¢æ­¥éª¤äº§ç”Ÿçš„äº‹ä»¶ applicationEvents Executor executor = getTaskExecutor()ï¼šè·å–çº¿ç¨‹æ± ï¼Œæœ‰çº¿ç¨‹æ± å°±å¼‚æ­¥æ‰§è¡Œï¼Œæ²¡æœ‰å°±åŒæ­¥æ‰§è¡Œ finishBeanFactoryInitialization()ï¼šå®ä¾‹åŒ–éæ‡’åŠ è½½çŠ¶æ€çš„å•å®ä¾‹ beanFactory.freezeConfiguration()ï¼šå†»ç»“é…ç½®ä¿¡æ¯ï¼Œå°±æ˜¯å†»ç»“ BD ä¿¡æ¯ï¼Œå†»ç»“åæ— æ³•å†å‘ bf å†…æ³¨å†Œ bd beanFactory.preInstantiateSingletons()ï¼šå®ä¾‹åŒ– non-lazy-init singletons for (String beanName : beanNames)ï¼šéå†å®¹å™¨å†…æ‰€æœ‰çš„ beanDefinitionNames getMergedLocalBeanDefinition(beanName)ï¼šè·å–ä¸çˆ¶ç±»åˆå¹¶åçš„å¯¹è±¡ï¼ˆBean â†’ è·å–æµç¨‹éƒ¨åˆ†è¯¦è§£æ­¤å‡½æ•°ï¼‰ if (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit())ï¼šBD å¯¹åº”çš„ Class æ»¡è¶³éæŠ½è±¡ã€å•å®ä¾‹ï¼Œéæ‡’åŠ è½½ï¼Œéœ€è¦é¢„å…ˆå®ä¾‹åŒ– if (isFactoryBean(beanName))ï¼šBD å¯¹åº”çš„ Class æ˜¯ factoryBean å¯¹è±¡ getBean(FACTORY_BEAN_PREFIX + beanName)ï¼šè·å–å·¥å‚ FactoryBean å®ä¾‹æœ¬èº« isEagerInitï¼šæ§åˆ¶ FactoryBean å†…éƒ¨ç®¡ç†çš„ Bean æ˜¯å¦ä¹Ÿåˆå§‹åŒ– getBean(beanName)ï¼šåˆå§‹åŒ– Beanï¼Œè·å– Bean è¯¦è§£æ­¤å‡½æ•° getBean(beanName)ï¼šä¸æ˜¯å·¥å‚ bean ç›´æ¥è·å– for (String beanName : beanNames)ï¼šæ£€æŸ¥æ‰€æœ‰çš„ Bean æ˜¯å¦å®ç° SmartInitializingSingleton æ¥å£ï¼Œå®ç°äº†å°±æ‰§è¡Œ afterSingletonsInstantiated()ï¼Œè¿›è¡Œä¸€äº›åˆ›å»ºåçš„æ“ä½œ finishRefresh()ï¼šå®Œæˆåˆ·æ–°ååšçš„ä¸€äº›äº‹æƒ…ï¼Œä¸»è¦æ˜¯å¯åŠ¨ç”Ÿå‘½å‘¨æœŸ clearResourceCaches()ï¼šæ¸…ç©ºä¸Šä¸‹æ–‡ç¼“å­˜ initLifecycleProcessor()ï¼šåˆå§‹åŒ–å’Œç”Ÿå‘½å‘¨æœŸæœ‰å…³çš„åç½®å¤„ç†å™¨ï¼Œå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸ if (beanFactory.containsLocalBean(LIFECYCLE_PROCESSOR_BEAN_NAME))ï¼šæˆç«‹è¯´æ˜è‡ªå®šä¹‰äº†ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨ defaultProcessor = new DefaultLifecycleProcessor()ï¼šSpring é»˜è®¤æä¾›çš„ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨ beanFactory.registerSingleton()ï¼šå°†ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨æ³¨å†Œåˆ° bf çš„ä¸€çº§ç¼“å­˜å’Œæ³¨å†Œå•ä¾‹é›†åˆä¸­ getLifecycleProcessor().onRefresh()ï¼šè·å–è¯¥**ç”Ÿå‘½å‘¨æœŸåç½®å¤„ç†å™¨å›è°ƒ onRefresh()**ï¼Œè°ƒç”¨ startBeans(true) lifecycleBeans = getLifecycleBeans()ï¼šè·å–åˆ°æ‰€æœ‰å®ç°äº† Lifecycle æ¥å£çš„å¯¹è±¡åŒ…è£…åˆ° Map å†…ï¼Œkey æ˜¯beanNameï¼Œ value æ˜¯ Lifecycle å¯¹è±¡ int phase = getPhase(bean)ï¼šè·å–å½“å‰ Lifecycle çš„ phase å€¼ï¼Œå½“å‰ç”Ÿå‘½å‘¨æœŸå¯¹è±¡å¯èƒ½ä¾èµ–å…¶ä»–ç”Ÿå‘½å‘¨æœŸå¯¹è±¡çš„æ‰§è¡Œç»“æœï¼Œæ‰€ä»¥éœ€è¦ phase å†³å®šæ‰§è¡Œé¡ºåºï¼Œæ•°å€¼è¶Šä½çš„ä¼˜å…ˆæ‰§è¡Œ LifecycleGroup group = phases.get(phase)ï¼šæŠŠ phsae ç›¸åŒçš„ Lifecycle å­˜å…¥ LifecycleGroup if (group == null)ï¼šgroup ä¸ºç©ºåˆ™åˆ›å»ºï¼Œåˆå§‹æƒ…å†µä¸‹æ˜¯ç©ºçš„ group.add(beanName, bean)ï¼šå°†å½“å‰ Lifecycle æ·»åŠ åˆ°å½“å‰ phase å€¼ä¸€æ ·çš„ group å†… Collections.sort(keys)ï¼šä»å°åˆ°å¤§æ’åºï¼ŒæŒ‰ä¼˜å…ˆçº§å¯åŠ¨ phases.get(key).start()ï¼šéå†æ‰€æœ‰çš„ Lifecycle å¯¹è±¡å¼€å§‹å¯åŠ¨ doStart(this.lifecycleBeans, member.name, this.autoStartupOnly)ï¼šåº•å±‚è°ƒç”¨è¯¥æ–¹æ³•å¯åŠ¨ bean = lifecycleBeans.remove(beanName)ï¼š ç¡®ä¿ Lifecycle åªè¢«å¯åŠ¨ä¸€æ¬¡ï¼Œåœ¨ä¸€ä¸ªåˆ†ç»„å†…è¢«å¯åŠ¨äº†åœ¨å…¶ä»–åˆ†ç»„å†…å°±çœ‹ä¸åˆ° Lifecycle äº† dependenciesForBean = getBeanFactory().getDependenciesForBean(beanName)ï¼šè·å–å½“å‰å³å°†è¢«å¯åŠ¨çš„ Lifecycle æ‰€ä¾èµ–çš„å…¶ä»– beanNameï¼Œéœ€è¦å…ˆå¯åŠ¨æ‰€ä¾èµ–çš„ beanï¼Œæ‰èƒ½å¯åŠ¨è‡ªèº« if ()ï¼šä¼ å…¥çš„å‚æ•° autoStartupOnly ä¸º true è¡¨ç¤ºå¯åŠ¨ isAutoStartUp ä¸º true çš„ SmartLifecycle å¯¹è±¡ï¼Œä¸ä¼šå¯åŠ¨æ™®é€šçš„ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡ï¼›false ä»£è¡¨å…¨éƒ¨å¯åŠ¨ bean.start()ï¼šè°ƒç”¨å¯åŠ¨æ–¹æ³• publishEvent(new ContextRefreshedEvent(this))ï¼šå‘å¸ƒå®¹å™¨åˆ·æ–°å®Œæˆäº‹ä»¶ liveBeansView.registerApplicationContext(this)ï¼šæš´éœ² Mbean è¡¥å……ç”Ÿå‘½å‘¨æœŸ stop() æ–¹æ³•çš„è°ƒç”¨ DefaultLifecycleProcessor.stop()ï¼šè°ƒç”¨ DefaultLifecycleProcessor.stopBeans() è·å–åˆ°æ‰€æœ‰å®ç°äº† Lifecycle æ¥å£çš„å¯¹è±¡å¹¶æŒ‰ phase æ•°å€¼åˆ†ç»„çš„ keys.sort(Collections.reverseOrder())ï¼šæŒ‰ phase é™åºæ’åº Lifecycle æ¥å£ï¼Œæœ€å…ˆå¯åŠ¨çš„æœ€æ™šå…³é—­ï¼ˆè´£ä»»é“¾ï¼Ÿï¼‰ phases.get(key).stop()ï¼šéå†æ‰€æœ‰çš„ Lifecycle å¯¹è±¡å¼€å§‹åœæ­¢ latch = new CountDownLatch(this.smartMemberCount)ï¼šåˆ›å»º CountDownLatchï¼Œè®¾ç½® latch å†…éƒ¨çš„å€¼ä¸ºå½“å‰åˆ†ç»„å†…çš„ smartMemberCount çš„æ•°é‡ countDownBeanNames = Collections.synchronizedSet(new LinkedHashSet&lt;&gt;())ï¼šä¿å­˜å½“å‰æ­£åœ¨å¤„ç†å…³é—­çš„smartLifecycle çš„ BeanName for (LifecycleGroupMember member : this.members)ï¼šå¤„ç†æœ¬åˆ†ç»„å†…éœ€è¦å…³é—­çš„ Lifecycle doStop(this.lifecycleBeans, member.name, latch, countDownBeanNames)ï¼šçœŸæ­£çš„åœæ­¢æ–¹æ³• getBeanFactory().getDependentBeans(beanName)ï¼šè·å–ä¾èµ–å½“å‰ Lifecycle çš„å…¶ä»–å¯¹è±¡çš„ beanNameï¼Œå› ä¸ºå½“å‰çš„ Lifecycle å³å°†è¦å…³é—­äº†ï¼Œæ‰€æœ‰çš„ä¾èµ–äº†å½“å‰ Lifecycle çš„ bean ä¹Ÿè¦å…³é—­ countDownBeanNames.add(beanName)ï¼šå°†å½“å‰ SmartLifecycle beanName æ·»åŠ åˆ° countDownBeanNames é›†åˆå†…ï¼Œè¯¥é›†åˆè¡¨ç¤ºæ­£åœ¨å…³é—­çš„ SmartLifecycle bean.stop()ï¼šè°ƒç”¨åœæ­¢çš„æ–¹æ³• è·å–Beanå•å®ä¾‹ï¼šåœ¨å®¹å™¨å¯åŠ¨æ—¶åˆ›å»ºå¯¹è±¡ å¤šå®ä¾‹ï¼šåœ¨æ¯æ¬¡è·å–çš„æ—¶å€™åˆ›å»ºå¯¹è±¡ è·å–æµç¨‹ï¼šè·å– Bean æ—¶å…ˆä»å•ä¾‹æ± è·å–ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿›è¡Œç¬¬äºŒæ¬¡è·å–ï¼Œå¹¶å¸¦ä¸Šå·¥å‚ç±»å»åˆ›å»ºå¹¶æ·»åŠ è‡³å•ä¾‹æ±  Java å¯åŠ¨ Spring ä»£ç ï¼š 12ApplicationContext ctx = new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;);UserService userService = (UserService) context.getBean(&quot;userService&quot;); AbstractBeanFactory.doGetBean()ï¼šè·å– Beanï¼Œcontext.getBean() è¿½è¸ªåˆ°æ­¤ beanName = transformedBeanName(name)ï¼šname å¯èƒ½æ˜¯ä¸€ä¸ªåˆ«åï¼Œé‡å®šå‘å‡ºæ¥çœŸå® beanNameï¼›ä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ª &amp; å¼€å¤´çš„ nameï¼Œè¯´æ˜è¦è·å–çš„ bean å®ä¾‹å¯¹è±¡ï¼Œæ˜¯ä¸€ä¸ª FactoryBean å¯¹è±¡ï¼ˆIOC åŸç† â†’ æ ¸å¿ƒç±»ï¼‰ BeanFactoryUtils.transformedBeanName(name)ï¼šåˆ¤æ–­æ˜¯å“ªç§ nameï¼Œè¿”å›æˆªå– &amp; ä»¥åçš„ name å¹¶æ”¾å…¥ç¼“å­˜ transformedBeanNameCache.computeIfAbsentï¼šç¼“å­˜æ˜¯å¹¶å‘å®‰å…¨é›†åˆï¼Œkey &#x3D;&#x3D; null || value &#x3D;&#x3D; null æ—¶ put æˆåŠŸ do while å¾ªç¯ä¸€ç›´å»é™¤ &amp; ç›´åˆ°ä¸å†å«æœ‰ &amp; canonicalName(name)ï¼šaliasMap ä¿å­˜åˆ«åä¿¡æ¯ï¼Œå…¶ä¸­çš„ do while é€»è¾‘æ˜¯è¿­ä»£æŸ¥æ‰¾ï¼Œæ¯”å¦‚ A åˆ«åå«åš Bï¼Œä½†æ˜¯ B åˆæœ‰åˆ«åå« Cï¼Œ aliasMap ä¸º {â€œCâ€:â€Bâ€, â€œBâ€:â€Aâ€}ï¼Œget(C) æœ€åè¿”å›çš„æ˜¯ A DefaultSingletonBeanRegistry.getSingleton()ï¼šç¬¬ä¸€æ¬¡è·å–ä»ç¼“å­˜æ± è·å–ï¼ˆå¾ªç¯ä¾èµ–è¯¦è§£æ­¤ä»£ç ï¼‰ ç¼“å­˜ä¸­æœ‰æ•°æ®è¿›è¡Œ getObjectForBeanInstance() è·å–å¯ä½¿ç”¨çš„ Beanï¼ˆæœ¬èŠ‚ç»“æŸéƒ¨åˆ†è¯¦è§£æ­¤å‡½æ•°ï¼‰ ç¼“å­˜ä¸­æ²¡æœ‰æ•°æ®è¿›è¡Œä¸‹é¢çš„é€»è¾‘è¿›è¡Œåˆ›å»º if(isPrototypeCurrentlyInCreation(beanName))ï¼šæ£€æŸ¥ bean æ˜¯å¦åœ¨åŸå‹ï¼ˆPrototypeï¼‰æ­£åœ¨è¢«åˆ›å»ºçš„é›†åˆä¸­ï¼Œå¦‚æœæ˜¯å°±æŠ¥é”™ï¼Œè¯´æ˜äº§ç”Ÿäº†å¾ªç¯ä¾èµ–ï¼ŒåŸå‹æ¨¡å¼è§£å†³ä¸äº†å¾ªç¯ä¾èµ– åŸå› ï¼šå…ˆåŠ è½½ Aï¼ŒæŠŠ A åŠ å…¥é›†åˆï¼ŒA ä¾èµ– B å»åŠ è½½ Bï¼ŒB åˆä¾èµ– Aï¼Œå»åŠ è½½ Aï¼Œå‘ç° A åœ¨æ­£åœ¨åˆ›å»ºé›†åˆä¸­ï¼Œäº§ç”Ÿå¾ªç¯ä¾èµ– markBeanAsCreated(beanName)ï¼šæŠŠ bean æ ‡è®°ä¸ºå·²ç»åˆ›å»ºï¼Œé˜²æ­¢å…¶ä»–çº¿ç¨‹é‡æ–°åˆ›å»º Bean mbd = getMergedLocalBeanDefinition(beanName)ï¼šè·å–åˆå¹¶çˆ¶ BD åçš„ BD å¯¹è±¡ï¼ŒBD æ˜¯ç›´æ¥ç»§æ‰¿çš„ï¼Œåˆå¹¶åçš„ BD ä¿¡æ¯æ˜¯åŒ…å«çˆ¶ç±»çš„ BD ä¿¡æ¯ this.mergedBeanDefinitions.get(beanName)ï¼šä»ç¼“å­˜ä¸­è·å– if(bd.getParentName()==null)ï¼šbeanName å¯¹åº” BD æ²¡æœ‰çˆ¶ BD å°±ä¸ç”¨å¤„ç†ç»§æ‰¿ï¼Œå°è£…ä¸º RootBeanDefinition è¿”å› parentBeanName = transformedBeanName(bd.getParentName())ï¼šå¤„ç†çˆ¶ BD çš„ name ä¿¡æ¯ if(!beanName.equals(parentBeanName))ï¼šä¸€èˆ¬æƒ…å†µçˆ¶å­ BD çš„åç§°ä¸åŒ pbd = getMergedBeanDefinition(parentBeanName)ï¼šé€’å½’è°ƒç”¨ï¼Œæœ€ç»ˆè¿”å›çˆ¶ BD çš„çˆ¶ BD ä¿¡æ¯ mbd = new RootBeanDefinition(pbd)ï¼šæŒ‰ç…§çˆ¶ BD ä¿¡æ¯åˆ›å»º RootBeanDefinition å¯¹è±¡ mbd.overrideFrom(bd)ï¼šå­ BD ä¿¡æ¯è¦†ç›– mbdï¼Œå› ä¸ºæ˜¯è¦ä»¥å­ BD ä¸ºåŸºå‡†ï¼Œä¸å­˜åœ¨çš„æ‰å»çˆ¶ BD å¯»æ‰¾ï¼ˆç±»ä¼¼ Java ç»§æ‰¿ï¼‰ this.mergedBeanDefinitions.put(beanName, mbd)ï¼šæ”¾å…¥ç¼“å­˜ checkMergedBeanDefinition()ï¼šåˆ¤æ–­å½“å‰ BD æ˜¯å¦ä¸ºæŠ½è±¡ BDï¼ŒæŠ½è±¡ BD ä¸èƒ½åˆ›å»ºå®ä¾‹ï¼Œåªèƒ½ä½œä¸ºçˆ¶ BD è¢«ç»§æ‰¿ mbd.getDependsOn()ï¼šè·å– bean æ ‡ç­¾ depends-on if(dependsOn != null)ï¼šéå†æ‰€æœ‰çš„ä¾èµ–åŠ è½½ï¼Œè§£å†³ä¸äº†å¾ªç¯ä¾èµ– isDependent(beanName, dep)ï¼šåˆ¤æ–­å¾ªç¯ä¾èµ–ï¼Œå‡ºç°å¾ªç¯ä¾èµ–é—®é¢˜æŠ¥é”™ ä¸¤ä¸ª Mapï¼š&lt;bean name=&quot;A&quot; depends-on=&quot;B&quot; ...&gt; dependentBeanMapï¼šè®°å½•ä¾èµ–äº†å½“å‰ beanName çš„å…¶ä»– beanNameï¼ˆè°ä¾èµ–æˆ‘ï¼Œæˆ‘è®°å½•è°ï¼‰ dependenciesForBeanMapï¼šè®°å½•å½“å‰ beanName ä¾èµ–çš„å…¶å®ƒ beanName ä»¥ B ä¸ºè§†è§’ dependentBeanMap {â€œBâ€ï¼š{â€œAâ€}}ï¼Œä»¥ A ä¸ºè§†è§’ dependenciesForBeanMap {â€œAâ€ :{â€œBâ€}} canonicalName(beanName)ï¼šå¤„ç† bean çš„ name dependentBeans = this.dependentBeanMap.get(canonicalName)ï¼šè·å–ä¾èµ–äº†å½“å‰ bean çš„ name if (dependentBeans.contains(dependentBeanName))ï¼šä¾èµ–äº†å½“å‰ bean çš„é›†åˆä¸­æ˜¯å¦æœ‰è¯¥ nameï¼Œæœ‰å°±äº§ç”Ÿå¾ªç¯ä¾èµ– è¿›è¡Œé€’å½’å¤„ç†æ‰€æœ‰çš„å¼•ç”¨ï¼šå‡å¦‚ &lt;bean name=&quot;A&quot; dp=&quot;B&quot;&gt; &lt;bean name=&quot;B&quot; dp=&quot;C&quot;&gt; &lt;bean name=&quot;C&quot; dp=&quot;A&quot;&gt; 123dependentBeanMap=&#123;A:&#123;C&#125;, B:&#123;A&#125;, C:&#123;B&#125;&#125; // C ä¾èµ– A åˆ¤æ–­è°ä¾èµ–äº†C é€’å½’åˆ¤æ–­ è°ä¾èµ–äº†BisDependent(C, A) â†’ C#dependentBeans=&#123;B&#125; â†’ isDependent(B, A); â†’ B#dependentBeans=&#123;A&#125; //è¿”å›true registerDependentBean(dep, beanName)ï¼šæŠŠ bean å’Œä¾èµ–æ³¨å†Œåˆ°ä¸¤ä¸ª Map ä¸­ï¼Œæ³¨æ„å‚æ•°çš„ä½ç½®ï¼Œè¢«ä¾èµ–çš„åœ¨å‰ getBean(dep)ï¼šå…ˆåŠ è½½ä¾èµ–çš„ Beanï¼Œåˆè¿›å…¥ doGetBean() çš„é€»è¾‘ if (mbd.isSingleton())ï¼šåˆ¤æ–­ bean æ˜¯å¦æ˜¯å•ä¾‹çš„ bean getSingleton(String, ObjectFactory&lt;?&gt;)ï¼šç¬¬äºŒæ¬¡è·å–ï¼Œä¼ å…¥ä¸€ä¸ªå·¥å‚å¯¹è±¡ï¼Œè¿™ä¸ªæ–¹æ³•æ›´å€¾å‘äºåˆ›å»ºå®ä¾‹å¹¶è¿”å› 1234sharedInstance = getSingleton(beanName, () -&gt; &#123; return createBean(beanName, mbd, args);//åˆ›å»ºï¼Œè·³è½¬ç”Ÿå‘½å‘¨æœŸ //lambdaè¡¨è¾¾å¼ï¼Œè°ƒç”¨äº†ObjectFactoryçš„getObject()æ–¹æ³•ï¼Œå®é™…å›è°ƒæ¥å£å®ç°çš„æ˜¯ createBean()æ–¹æ³•è¿›è¡Œåˆ›å»ºå¯¹è±¡&#125;); singletonObjects.get(beanName)ï¼šä»ä¸€çº§ç¼“å­˜æ£€æŸ¥æ˜¯å¦å·²ç»è¢«åŠ è½½ï¼Œå•ä¾‹æ¨¡å¼å¤ç”¨å·²ç»åˆ›å»ºçš„ bean this.singletonsCurrentlyInDestructionï¼šå®¹å™¨é”€æ¯æ—¶ä¼šè®¾ç½®è¿™ä¸ªå±æ€§ä¸º trueï¼Œè¿™æ—¶å°±ä¸èƒ½å†åˆ›å»º bean å®ä¾‹äº† beforeSingletonCreation(beanName)ï¼šæ£€æŸ¥æ„é€ æ³¨å…¥çš„ä¾èµ–ï¼Œæ„é€ å‚æ•°æ³¨å…¥äº§ç”Ÿçš„å¾ªç¯ä¾èµ–æ— æ³•è§£å†³ !this.singletonsCurrentlyInCreation.add(beanName)ï¼šå°†å½“å‰ beanName æ”¾å…¥åˆ°æ­£åœ¨åˆ›å»ºä¸­å•å®ä¾‹é›†åˆï¼Œæ”¾å…¥æˆåŠŸè¯´æ˜æ²¡æœ‰äº§ç”Ÿå¾ªç¯ä¾èµ–ï¼Œå¤±è´¥åˆ™äº§ç”Ÿå¾ªç¯ä¾èµ–ï¼Œè¿›å…¥åˆ¤æ–­æ¡ä»¶å†…çš„é€»è¾‘æŠ›å‡ºå¼‚å¸¸ åŸå› ï¼šåŠ è½½ Aï¼Œå‘æ­£åœ¨åˆ›å»ºé›†åˆä¸­æ·»åŠ äº† {A}ï¼Œæ ¹æ® A çš„æ„é€ æ–¹æ³•å®ä¾‹åŒ– A å¯¹è±¡ï¼Œå‘ç° A çš„æ„é€ æ–¹æ³•ä¾èµ– Bï¼Œç„¶ååŠ è½½ Bï¼ŒB æ„é€ æ–¹æ³•çš„å‚æ•°ä¾èµ–äº Aï¼Œåˆå»åŠ è½½ A æ—¶æ¥åˆ°å½“å‰æ–¹æ³•ï¼Œå› ä¸ºåˆ›å»ºä¸­é›†åˆå·²ç»å­˜åœ¨ Aï¼Œæ‰€ä»¥æ·»åŠ å¤±è´¥ singletonObject = singletonFactory.getObject()ï¼šåˆ›å»º beanï¼ˆç”Ÿå‘½å‘¨æœŸéƒ¨åˆ†è¯¦è§£ï¼‰ åˆ›å»ºå®Œæˆä»¥åï¼ŒBean å·²ç»åˆå§‹åŒ–å¥½ï¼Œæ˜¯ä¸€ä¸ªå®Œæ•´çš„å¯ä½¿ç”¨çš„ Bean afterSingletonCreation(beanName)ï¼šä»æ­£åœ¨åˆ›å»ºä¸­çš„é›†åˆä¸­ç§»å‡º addSingleton(beanName, singletonObject)ï¼šæ·»åŠ ä¸€çº§ç¼“å­˜å•ä¾‹æ± ä¸­ï¼Œä»äºŒçº§ä¸‰çº§ç¼“å­˜ç§»é™¤ bean = getObjectForBeanInstanceï¼šå•å®ä¾‹å¯èƒ½æ˜¯æ™®é€šå•å®ä¾‹æˆ–è€… FactoryBeanï¼Œå¦‚æœæ˜¯ FactoryBean å®ä¾‹ï¼Œéœ€è¦åˆ¤æ–­ name æ˜¯å¸¦ &amp; è¿˜æ˜¯ä¸å¸¦ &amp;ï¼Œå¸¦ &amp; è¯´æ˜ getBean è·å– FactoryBean å¯¹è±¡ï¼Œå¦åˆ™æ˜¯è·å– FactoryBean å†…éƒ¨ç®¡ç†çš„å®ä¾‹ å‚æ•° name æ˜¯æœªå¤„ç† &amp; çš„ nameï¼ŒbeanName æ˜¯å¤„ç†è¿‡ &amp; å’Œåˆ«ååçš„ name if(BeanFactoryUtils.isFactoryDereference(name))ï¼šåˆ¤æ–­ doGetBean ä¸­å‚æ•° name å‰æ˜¯å¦å¸¦ &amp;ï¼Œä¸æ˜¯å¤„ç†åçš„ if(!(beanInstance instanceof FactoryBean) || BeanFactoryUtils.isFactoryDereference(name))ï¼šBean æ˜¯æ™®é€šå•å®ä¾‹æˆ–è€…æ˜¯ FactoryBean å°±å¯ä»¥ç›´æ¥è¿”å›ï¼Œå¦åˆ™è¿›å…¥ä¸‹é¢çš„è·å– FactoryBean å†…éƒ¨ç®¡ç†çš„å®ä¾‹çš„é€»è¾‘ getCachedObjectForFactoryBean(beanName)ï¼šå°è¯•åˆ°ç¼“å­˜è·å–ï¼Œè·å–åˆ°ç›´æ¥è¿”å›ï¼Œè·å–ä¸åˆ°è¿›è¡Œä¸‹é¢é€»è¾‘ if (mbd == null &amp;&amp; containsBeanDefinition(beanName))ï¼šSpring ä¸­æœ‰å½“å‰ beanName çš„ BeanDefinition ä¿¡æ¯ mbd = getMergedLocalBeanDefinition(beanName)ï¼šè·å–åˆå¹¶åçš„ BeanDefinition mbd.isSynthetic()ï¼šé»˜è®¤å€¼æ˜¯ false è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªç”¨æˆ·å¯¹è±¡ï¼Œå¦‚æœæ˜¯ true è¡¨ç¤ºæ˜¯ç³»ç»Ÿå¯¹è±¡ object = getObjectFromFactoryBean(factory, beanName, !synthetic)ï¼šä»å·¥å‚å†…è·å–å®ä¾‹ factory.isSingleton() &amp;&amp; containsSingleton(beanName)ï¼šå·¥å‚å†…éƒ¨ç»´æŠ¤çš„å¯¹è±¡æ˜¯å•å®ä¾‹å¹¶ä¸”ä¸€çº§ç¼“å­˜å­˜åœ¨è¯¥ bean é¦–å…ˆå»ç¼“å­˜ä¸­è·å–ï¼Œè·å–ä¸åˆ°å°±ä½¿ç”¨å·¥å‚è·å–ç„¶åæ”¾å…¥ç¼“å­˜ï¼Œè¿›è¡Œå¾ªç¯ä¾èµ–åˆ¤æ–­ else if (mbd.isPrototype())ï¼šbean æ˜¯åŸå‹çš„ bean beforePrototypeCreation(beanName)ï¼šå½“å‰çº¿ç¨‹æ­£åœ¨åˆ›å»ºçš„åŸå‹å¯¹è±¡ beanName å­˜å…¥ prototypesCurrentlyInCreation curVal = this.prototypesCurrentlyInCreation.get()ï¼šè·å–å½“å‰çº¿ç¨‹çš„æ­£åœ¨åˆ›å»ºçš„åŸå‹ç±»é›†åˆ this.prototypesCurrentlyInCreation.set(beanName)ï¼šé›†åˆä¸ºç©ºå°±æŠŠå½“å‰ beanName åŠ å…¥ if (curVal instanceof String)ï¼šå·²ç»æœ‰çº¿ç¨‹ç›¸å…³åŸå‹ç±»åˆ›å»ºäº†ï¼ŒæŠŠå½“å‰çš„åˆ›å»ºçš„åŠ è¿›å» createBean(beanName, mbd, args)ï¼šåˆ›å»ºåŸå‹ç±»å¯¹è±¡ï¼Œä¸éœ€è¦ä¸‰çº§ç¼“å­˜ afterPrototypeCreation(beanName)ï¼šä»æ­£åœ¨åˆ›å»ºä¸­çš„é›†åˆä¸­ç§»é™¤è¯¥ beanNameï¼Œ ä¸ beforePrototypeCreationé€»è¾‘ç›¸å convertIfNecessary()ï¼šä¾èµ–æ£€æŸ¥ï¼Œæ£€æŸ¥æ‰€éœ€çš„ç±»å‹æ˜¯å¦ä¸å®é™… bean å®ä¾‹çš„ç±»å‹åŒ¹é… return (T) beanï¼šè¿”å›åˆ›å»ºå®Œæˆçš„ bean ç”Ÿå‘½å‘¨æœŸå››ä¸ªé˜¶æ®µBean çš„ç”Ÿå‘½å‘¨æœŸï¼šå®ä¾‹åŒ– instantiationï¼Œå¡«å……å±æ€§ populateï¼Œåˆå§‹åŒ– initializationï¼Œé”€æ¯ destruction AbstractAutowireCapableBeanFactory.createBean()ï¼šè¿›å…¥ Bean ç”Ÿå‘½å‘¨æœŸçš„æµç¨‹ resolvedClass = resolveBeanClass(mbd, beanName)ï¼šåˆ¤æ–­ mdb ä¸­çš„ class æ˜¯å¦å·²ç»åŠ è½½åˆ° JVMï¼Œå¦‚æœæœªåŠ è½½åˆ™ä½¿ç”¨ç±»åŠ è½½å™¨å°† beanName åŠ è½½åˆ° JVMä¸­å¹¶è¿”å› class å¯¹è±¡ if (resolvedClass != null &amp;&amp; !mbd.hasBeanClass() &amp;&amp; mbd.getBeanClassName() != null)ï¼šæ¡ä»¶æˆç«‹å°è£… mbd å¹¶æŠŠ resolveBeanClass è®¾ç½®åˆ° bd ä¸­ æ¡ä»¶äºŒï¼šmbd åœ¨ resolveBeanClass ä¹‹å‰æ˜¯å¦æœ‰ class æ¡ä»¶ä¸‰ï¼šmbd æœ‰ className bean = resolveBeforeInstantiation(beanName, mbdToUse)ï¼šå®ä¾‹åŒ–å‰çš„åç½®å¤„ç†å™¨è¿”å›ä¸€ä¸ªä»£ç†å®ä¾‹å¯¹è±¡ï¼ˆä¸æ˜¯ AOPï¼‰ è‡ªå®šä¹‰ç±»ç»§æ‰¿ InstantiationAwareBeanPostProcessorï¼Œé‡å†™ postProcessBeforeInstantiation æ–¹æ³•ï¼Œæ–¹æ³•é€»è¾‘ä¸ºåˆ›å»ºå¯¹è±¡ å¹¶é…ç½®æ–‡ä»¶ &lt;bean class=&quot;intefacePackage.MyInstantiationAwareBeanPostProcessor&quot;&gt; å¯¼å…¥ä¸º bean æ¡ä»¶æˆç«‹ï¼ŒçŸ­è·¯æ“ä½œï¼Œç›´æ¥ return bean Object beanInstance = doCreateBean(beanName, mbdToUse, args)ï¼šDo it AbstractAutowireCapableBeanFactory.doCreateBean(beanName, RootBeanDefinition, Object[] args)ï¼šåˆ›å»º Bean BeanWrapper instanceWrapper = nullï¼šSpring ç»™æ‰€æœ‰åˆ›å»ºçš„ Bean å®ä¾‹åŒ…è£…æˆ BeanWrapperï¼Œå†…éƒ¨æœ€æ ¸å¿ƒçš„æ–¹æ³•æ˜¯è·å–å®ä¾‹ï¼Œæä¾›äº†ä¸€äº›é¢å¤–çš„æ¥å£æ–¹æ³•ï¼Œæ¯”å¦‚å±æ€§è®¿é—®å™¨ instanceWrapper = this.factoryBeanInstanceCache.remove(beanName)ï¼šå•ä¾‹å¯¹è±¡å°è¯•ä»ç¼“å­˜ä¸­è·å–ï¼Œä¼šç§»é™¤ç¼“å­˜ createBeanInstance()ï¼šç¼“å­˜ä¸­æ²¡æœ‰å®ä¾‹å°±è¿›è¡Œåˆ›å»ºå®ä¾‹ï¼ˆé€»è¾‘å¤æ‚ï¼Œä¸‹ä¸€å°èŠ‚è¯¦è§£ï¼‰ if (!mbd.postProcessed)ï¼šæ¯ä¸ª bean åªè¿›è¡Œä¸€æ¬¡è¯¥é€»è¾‘ applyMergedBeanDefinitionPostProcessors()ï¼šåç½®å¤„ç†å™¨ï¼Œåˆå¹¶ bd ä¿¡æ¯ï¼Œæ¥ä¸‹æ¥è¦å±æ€§å¡«å……äº† AutowiredAnnotationBeanPostProcessor.postProcessMergedBeanDefinition()ï¼šåç½®å¤„ç†é€»è¾‘ï¼ˆ@Autowiredï¼‰ metadata = findAutowiringMetadata(beanName, beanType, null)ï¼šæå–å½“å‰ bean æ•´ä¸ªç»§æ‰¿ä½“ç³»å†…çš„ @Autowiredã€@Valueã€@Inject ä¿¡æ¯ï¼Œå­˜å…¥ä¸€ä¸ª InjectionMetadata å¯¹è±¡ï¼Œä¿å­˜ç€å½“å‰ bean ä¿¡æ¯å’Œè¦è‡ªåŠ¨æ³¨å…¥çš„å­—æ®µä¿¡æ¯ 12private final Class&lt;?&gt; targetClass; //å½“å‰ bean private final Collection&lt;InjectedElement&gt; injectedElements; //è¦æ³¨å…¥çš„ä¿¡æ¯é›†åˆ metadata = buildAutowiringMetadata(clazz)ï¼šæŸ¥è¯¢å½“å‰ clazz æ„Ÿå…´è¶£çš„æ³¨è§£ä¿¡æ¯ ReflectionUtils.doWithLocalFields()ï¼šæå–å­—æ®µçš„æ³¨è§£çš„ä¿¡æ¯ findAutowiredAnnotation(field)ï¼šä»£è¡¨æ„Ÿå…´è¶£çš„æ³¨è§£å°±æ˜¯é‚£ä¸‰ç§æ³¨è§£ï¼Œè·å–è¿™ä¸‰ç§æ³¨è§£çš„å…ƒæ•°æ® ReflectionUtils.doWithLocalMethods()ï¼šæå–æ–¹æ³•çš„æ³¨è§£çš„ä¿¡æ¯ do&#123;&#125; while (targetClass != null &amp;&amp; targetClass != Object.class)ï¼šå¾ªç¯ä»çˆ¶ç±»ä¸­è§£æï¼Œç›´åˆ° Object ç±» this.injectionMetadataCache.put(cacheKey, metadata)ï¼šå­˜å…¥ç¼“å­˜ mbd.postProcessed = trueï¼šè®¾ç½®ä¸º trueï¼Œä¸‹æ¬¡è®¿é—®è¯¥é€»è¾‘ä¸ä¼šå†è¿›å…¥ earlySingletonExposure = (mbd.isSingleton() &amp;&amp; this.allowCircularReferences &amp;&amp; isSingletonCurrentlyInCreation(beanName)ï¼šå•ä¾‹ã€è§£å†³å¾ªç¯å¼•ç”¨ã€æ˜¯å¦åœ¨å•ä¾‹æ­£åœ¨åˆ›å»ºé›†åˆä¸­ 12345if (earlySingletonExposure) &#123; // ã€æ”¾å…¥ä¸‰çº§ç¼“å­˜ä¸€ä¸ªå·¥å‚å¯¹è±¡ï¼Œç”¨æ¥è·å–æå‰å¼•ç”¨ã€‘ addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean)); // lamda è¡¨è¾¾å¼ï¼Œç”¨æ¥è·å–æå‰å¼•ç”¨ï¼Œå¾ªç¯ä¾èµ–éƒ¨åˆ†è¯¦è§£è¯¥é€»è¾‘&#125; populateBean(beanName, mbd, instanceWrapper)ï¼š**å±æ€§å¡«å……ï¼Œä¾èµ–æ³¨å…¥ï¼Œæ•´ä½“é€»è¾‘æ˜¯å…ˆå¤„ç†æ ‡ç­¾å†å¤„ç†æ³¨è§£ï¼Œå¡«å……è‡³ pvs ä¸­ï¼Œæœ€åé€šè¿‡ apply æ–¹æ³•æœ€åå®Œæˆå±æ€§ä¾èµ–æ³¨å…¥åˆ° BeanWrapper ** if (!ibp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName))ï¼šå®ä¾‹åŒ–åçš„åç½®å¤„ç†å™¨ï¼Œé»˜è®¤è¿”å› trueï¼Œå¯ä»¥è‡ªå®šä¹‰ç±»ç»§æ‰¿ InstantiationAwareBeanPostProcessor ä¿®æ”¹åç½®å¤„ç†æ–¹æ³•çš„è¿”å›å€¼ä¸º falseï¼Œä½¿ continueWithPropertyPopulation ä¸º falseï¼Œä¼šå¯¼è‡´ç›´æ¥è¿”å›ï¼Œä¸è¿›è¡Œå±æ€§çš„æ³¨å…¥ if (!continueWithPropertyPopulation)ï¼šè‡ªå®šä¹‰æ–¹æ³•è¿”å›å€¼ä¼šé€ æˆè¯¥æ¡ä»¶æˆç«‹ï¼Œé€»è¾‘ä¸ºç›´æ¥è¿”å›ï¼Œä¸è¿›è¡Œä¾èµ–æ³¨å…¥ PropertyValues pvs = (mbd.hasPropertyValues() ? mbd.getPropertyValues() : null)ï¼šå¤„ç†ä¾èµ–æ³¨å…¥é€»è¾‘å¼€å§‹ mbd.getResolvedAutowireMode() == ?ï¼šæ ¹æ® bean æ ‡ç­¾é…ç½®çš„ autowire åˆ¤æ–­æ˜¯ BY_NAME æˆ–è€… BY_TYPE autowireByName(beanName, mbd, bw, newPvs)ï¼šæ ¹æ®å­—æ®µåç§°å»è·å–ä¾èµ–çš„ beanï¼Œè¿˜æ²¡æ³¨å…¥ï¼Œåªæ˜¯æ·»åŠ åˆ° pvs propertyNames = unsatisfiedNonSimpleProperties(mbd, bw)ï¼šbean å®ä¾‹ä¸­æœ‰è¯¥å­—æ®µå’Œè¯¥å­—æ®µçš„ setter æ–¹æ³•ï¼Œä½†æ˜¯åœ¨ bd ä¸­æ²¡æœ‰ property å±æ€§ æ‹¿åˆ°é…ç½®çš„ property ä¿¡æ¯å’Œ bean çš„æ‰€æœ‰å­—æ®µä¿¡æ¯ pd.getWriteMethod() != nullï¼šå½“å‰å­—æ®µæ˜¯å¦æœ‰ set æ–¹æ³•ï¼Œé…ç½®ç±»æ³¨å…¥çš„æ–¹å¼éœ€è¦ set æ–¹æ³• !isExcludedFromDependencyCheck(pd)ï¼šå½“å‰å­—æ®µç±»å‹æ˜¯å¦åœ¨å¿½ç•¥è‡ªåŠ¨æ³¨å…¥çš„åˆ—è¡¨ä¸­ !pvs.contains(pd.getName()ï¼šå½“å‰å­—æ®µä¸åœ¨ xml æˆ–è€…å…¶ä»–æ–¹å¼çš„é…ç½®ä¸­ï¼Œä¹Ÿå°±æ˜¯ bd ä¸­ä¸å­˜åœ¨å¯¹åº”çš„ property !BeanUtils.isSimpleProperty(pd.getPropertyType()ï¼šæ˜¯å¦æ˜¯åŸºæœ¬æ•°æ®ç±»å‹å’Œå†…ç½®çš„å‡ ç§æ•°æ®ç±»å‹ï¼ŒåŸºæœ¬æ•°æ®ç±»å‹ä¸å…è®¸è‡ªåŠ¨æ³¨å…¥ if (containsBean(propertyName))ï¼šBeanFactory ä¸­å­˜åœ¨å½“å‰ property çš„ bean å®ä¾‹ï¼Œè¯´æ˜æ‰¾åˆ°å¯¹åº”çš„ä¾èµ–æ•°æ® getBean(propertyName)ï¼šæ‹¿åˆ° propertyName å¯¹åº”çš„ bean å®ä¾‹ pvs.add(propertyName, bean)ï¼šå¡«å……åˆ° pvs ä¸­ registerDependentBean(propertyName, beanName))ï¼šæ·»åŠ åˆ°ä¸¤ä¸ªä¾èµ– Mapï¼ˆdependsOnï¼‰ä¸­ autowireByType(beanName, mbd, bw, newPvs)ï¼šæ ¹æ®å­—æ®µç±»å‹å»æŸ¥æ‰¾ä¾èµ–çš„ bean desc = new AutowireByTypeDependencyDescriptor(methodParam, eager)ï¼šä¾èµ–æè¿°ä¿¡æ¯ resolveDependency(desc, beanName, autowiredBeanNames, converter)ï¼šæ ¹æ®æè¿°ä¿¡æ¯ï¼ŒæŸ¥æ‰¾ä¾èµ–å¯¹è±¡ï¼Œå®¹å™¨ä¸­æ²¡æœ‰å¯¹åº”çš„å®ä¾‹ä½†æ˜¯æœ‰å¯¹åº”çš„ BDï¼Œä¼šè°ƒç”¨ getBean(Type) è·å–å¯¹è±¡ pvs = newPvsï¼šnewPvs æ˜¯å¤„ç†äº†ä¾èµ–æ•°æ®åçš„ pvsï¼Œæ‰€ä»¥èµ‹å€¼ç»™ pvs hasInstAwareBppsï¼šè¡¨ç¤ºå½“å‰æ˜¯å¦æœ‰ InstantiationAwareBeanPostProcessors çš„åç½®å¤„ç†å™¨ï¼ˆAutowiredï¼‰ pvsToUse = ibp.postProcessProperties(pvs, bw.getWrappedInstance(), beanName)ï¼š**@Autowired æ³¨è§£çš„æ³¨å…¥**ï¼Œè¿™ä¸ªä¼ å…¥çš„ pvs å¯¹è±¡ï¼Œæœ€ååŸå°ä¸åŠ¨çš„è¿”å›ï¼Œä¸ä¼šæ·»åŠ ä¸œè¥¿ findAutowiringMetadata()ï¼šåŒ…è£…ç€å½“å‰ bd éœ€è¦æ³¨å…¥çš„æ³¨è§£ä¿¡æ¯é›†åˆï¼Œä¸‰ç§æ³¨è§£çš„å…ƒæ•°æ®ï¼Œç›´æ¥ç¼“å­˜è·å– InjectionMetadata.InjectedElement.inject()ï¼šéå†æ³¨è§£ä¿¡æ¯è§£æåæ³¨å…¥åˆ° Beanï¼Œæ–¹æ³•å’Œå­—æ®µçš„æ³¨å…¥å®ç°ä¸åŒ ä»¥å­—æ®µæ³¨å…¥ä¸ºä¾‹ï¼š value = resolveFieldValue(field, bean, beanName)ï¼šå¤„ç†å­—æ®µå±æ€§å€¼ value = beanFactory.resolveDependency()ï¼šè§£å†³ä¾èµ– result = doResolveDependency()ï¼šçœŸæ­£å¤„ç†è‡ªåŠ¨æ³¨å…¥ä¾èµ–çš„é€»è¾‘ Object shortcut = descriptor.resolveShortcut(this)ï¼šé»˜è®¤è¿”å› null Object value = getAutowireCandidateResolver().getSuggestedValue(descriptor)ï¼šè·å– @Value çš„å€¼ converter.convertIfNecessary(value, type, descriptor.getTypeDescriptor())ï¼šå¦‚æœ value ä¸æ˜¯ nullï¼Œå°±ç›´æ¥è¿›è¡Œç±»å‹è½¬æ¢è¿”å›æ•°æ® matchingBeans = findAutowireCandidates(beanName, type, descriptor)ï¼šå¦‚æœ value æ˜¯ç©ºè¯´æ˜å­—æ®µæ˜¯å¼•ç”¨ç±»å‹ï¼Œè·å– @Autowired çš„ Bean 12345// addCandidateEntry() â†’ Object beanInstance = descriptor.resolveCandidate()public Object resolveCandidate(String beanName, Class&lt;?&gt; requiredType, BeanFactory beanFactory) throws BeansException &#123; // è·å– bean return beanFactory.getBean(beanName);&#125; ReflectionUtils.makeAccessible(field)ï¼šä¿®æ”¹è®¿é—®æƒé™ field.set(bean, value)ï¼šè·å–å±æ€§è®¿é—®å™¨ä¸ºæ­¤ field å¯¹è±¡èµ‹å€¼ applyPropertyValues()ï¼šå°†æ‰€æœ‰è§£æçš„ PropertyValues çš„æ³¨å…¥è‡³ BeanWrapper å®ä¾‹ä¸­ï¼ˆæ·±æ‹·è´ï¼‰ if (pvs.isEmpty())ï¼šæ³¨è§£ @Autowired å’Œ @Value æ ‡æ³¨çš„ä¿¡æ¯åœ¨åç½®å¤„ç†çš„é€»è¾‘æ³¨å…¥å®Œæˆï¼Œæ­¤å¤„ä¸ºç©ºç›´æ¥è¿”å› ä¸‹é¢çš„é€»è¾‘è¿›è¡Œ XML é…ç½®çš„å±æ€§çš„æ³¨å…¥ï¼Œé¦–å…ˆè·å–è½¬æ¢å™¨è¿›è¡Œæ•°æ®è½¬æ¢ï¼Œç„¶åè·å– WriteMethod (set) æ–¹æ³•è¿›è¡Œåå°„è°ƒç”¨ï¼Œå®Œæˆå±æ€§çš„æ³¨å…¥ initializeBean(String,Object,RootBeanDefinition)ï¼šåˆå§‹åŒ–ï¼Œåˆ†ä¸ºé…ç½®æ–‡ä»¶å’Œå®ç°æ¥å£ä¸¤ç§æ–¹å¼ invokeAwareMethods(beanName, bean)ï¼šæ ¹æ® bean æ˜¯å¦å®ç° Aware æ¥å£æ‰§è¡Œåˆå§‹åŒ–çš„æ–¹æ³• wrappedBean = applyBeanPostProcessorsBeforeInitializationï¼šåˆå§‹åŒ–å‰çš„åç½®å¤„ç†å™¨ï¼Œå¯ä»¥ç»§æ‰¿æ¥å£é‡å†™æ–¹æ³• processor.postProcessBeforeInitialization()ï¼šæ‰§è¡Œåç½®å¤„ç†çš„æ–¹æ³•ï¼Œé»˜è®¤è¿”å› bean æœ¬èº« if (current == null) return resultï¼šé‡å†™æ–¹æ³•è¿”å› nullï¼Œä¼šé€ æˆåç½®å¤„ç†çš„çŸ­è·¯ï¼Œç›´æ¥è¿”å› invokeInitMethods(beanName, wrappedBean, mbd)ï¼šåå°„æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³• isInitializingBean = (bean instanceof InitializingBean)ï¼šåˆå§‹åŒ–æ–¹æ³•çš„å®šä¹‰æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯è‡ªå®šä¹‰ç±»å®ç° InitializingBean æ¥å£ï¼Œå¦ä¸€ç§æ˜¯é…ç½®æ–‡ä»¶é…ç½® &lt;bean id&#x3D;â€â€¦â€ class&#x3D;â€â€¦â€ init-method&#x3D;â€initâ€&#x2F; &gt; isInitializingBean &amp;&amp; (mbd == null || !mbd.isExternallyManagedInitMethod(&quot;afterPropertiesSet&quot;))ï¼š æ¡ä»¶ä¸€ï¼šå½“å‰ bean æ˜¯ä¸æ˜¯å®ç°äº† InitializingBean æ¡ä»¶äºŒï¼šInitializingBean æ¥å£ä¸­çš„æ–¹æ³• afterPropertiesSetï¼Œåˆ¤æ–­è¯¥æ–¹æ³•æ˜¯å¦æ˜¯å®¹å™¨å¤–ç®¡ç†çš„æ–¹æ³• if (mbd != null &amp;&amp; bean.getClass() != NullBean.class)ï¼šæˆç«‹è¯´æ˜æ˜¯é…ç½®æ–‡ä»¶çš„æ–¹å¼ if(!(æ¥å£æ¡ä»¶))è¡¨ç¤ºå¦‚æœé€šè¿‡æ¥å£å®ç°äº†åˆå§‹åŒ–æ–¹æ³•çš„è¯ï¼Œå°±ä¸ä¼šåœ¨è°ƒç”¨é…ç½®ç±»ä¸­ init-method å®šä¹‰çš„æ–¹æ³• ((InitializingBean) bean).afterPropertiesSet()ï¼šè°ƒç”¨æ–¹æ³• invokeCustomInitMethodï¼šæ‰§è¡Œè‡ªå®šä¹‰çš„æ–¹æ³• initMethodName = mbd.getInitMethodName()ï¼šè·å–æ–¹æ³•å Method initMethod = ()ï¼šæ ¹æ®æ–¹æ³•åè·å–åˆ° init-method æ–¹æ³• methodToInvoke = ClassUtils.getInterfaceMethodIfPossible(initMethod)ï¼šå°†æ–¹æ³•è½¬æˆä»æ¥å£å±‚é¢è·å– ReflectionUtils.makeAccessible(methodToInvoke)ï¼šè®¿é—®æƒé™è®¾ç½®æˆå¯è®¿é—® methodToInvoke.invoke(bean)ï¼šåå°„è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•ï¼Œä»¥å½“å‰ bean ä¸ºè§’åº¦å»è°ƒç”¨ wrappedBean = applyBeanPostProcessorsAfterInitializationï¼šåˆå§‹åŒ–åçš„åç½®å¤„ç†å™¨ AbstractAutoProxyCreator.postProcessAfterInitialization()ï¼šå¦‚æœ Bean è¢«å­ç±»æ ‡è¯†ä¸ºè¦ä»£ç†çš„ beanï¼Œåˆ™ä½¿ç”¨é…ç½®çš„æ‹¦æˆªå™¨åˆ›å»ºä»£ç†å¯¹è±¡ï¼ŒAOP éƒ¨åˆ†è¯¦è§£ å¦‚æœä¸å­˜åœ¨å¾ªç¯ä¾èµ–ï¼Œåˆ›å»ºåŠ¨æ€ä»£ç† bean åœ¨æ­¤å¤„å®Œæˆï¼›å¦åˆ™çœŸæ­£çš„åˆ›å»ºé˜¶æ®µæ˜¯åœ¨å±æ€§å¡«å……æ—¶è·å–æå‰å¼•ç”¨çš„é˜¶æ®µï¼Œå¾ªç¯ä¾èµ–è¯¦è§£ï¼Œæºç åˆ†æï¼š 123456789101112131415// è¯¥é›†åˆç”¨æ¥é¿å…é‡å¤å°†æŸä¸ª bean ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œprivate final Map&lt;Object, Object&gt; earlyProxyReferences = new ConcurrentHashMap&lt;&gt;(16);public Object postProcessAfterInitialization(@Nullable Object bean,String bN)&#123; if (bean != null) &#123; // cacheKey æ˜¯ beanName æˆ–è€…åŠ ä¸Š &amp; Object cacheKey = getCacheKey(bean.getClass(), beanName);y if (this.earlyProxyReferences.remove(cacheKey) != bean) &#123; // å»æå‰ä»£ç†å¼•ç”¨æ± ä¸­å¯»æ‰¾è¯¥keyï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºä»£ç† // å¦‚æœå­˜åœ¨åˆ™è¯æ˜è¢«ä»£ç†è¿‡ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰çš„ beanï¼Œä¸æ˜¯åˆ™åˆ›å»ºä»£ç† return wrapIfNecessary(bean, bN, cacheKey); &#125; &#125; return bean;&#125; if (earlySingletonExposure)ï¼šæ˜¯å¦å…è®¸æå‰å¼•ç”¨ earlySingletonReference = getSingleton(beanName, false)ï¼šä»äºŒçº§ç¼“å­˜è·å–å®ä¾‹ï¼Œæ”¾å…¥ä¸€çº§ç¼“å­˜æ˜¯åœ¨ doGetBean ä¸­çš„sharedInstance &#x3D; getSingleton() é€»è¾‘ä¸­ï¼Œæ­¤æ—¶åœ¨ createBean çš„é€»è¾‘è¿˜æ²¡æœ‰è¿”å›ï¼Œæ‰€ä»¥ä¸€çº§ç¼“å­˜æ²¡æœ‰ if (earlySingletonReference != null)ï¼šå½“å‰ bean å®ä¾‹ä»äºŒçº§ç¼“å­˜ä¸­è·å–åˆ°äº†ï¼Œè¯´æ˜äº§ç”Ÿäº†å¾ªç¯ä¾èµ–ï¼Œåœ¨å±æ€§å¡«å……é˜¶æ®µä¼šæå‰è°ƒç”¨ä¸‰çº§ç¼“å­˜ä¸­çš„å·¥å‚ç”Ÿæˆ Bean çš„ä»£ç†å¯¹è±¡ï¼ˆæˆ–åŸå§‹å®ä¾‹ï¼‰ï¼Œæ”¾å…¥äºŒçº§ç¼“å­˜ä¸­ï¼Œç„¶åä½¿ç”¨åŸå§‹ bean ç»§ç»­æ‰§è¡Œåˆå§‹åŒ– if (exposedObject == bean)ï¼šåˆå§‹åŒ–åçš„ bean &#x3D;&#x3D; åˆ›å»ºçš„åŸå§‹å®ä¾‹ï¼Œæ¡ä»¶æˆç«‹çš„ä¸¤ç§æƒ…å†µï¼šå½“å‰çš„çœŸå®å®ä¾‹ä¸éœ€è¦è¢«ä»£ç†ï¼›å½“å‰å®ä¾‹å­˜åœ¨å¾ªç¯ä¾èµ–å·²ç»è¢«æå‰ä»£ç†è¿‡äº†ï¼Œåˆå§‹åŒ–æ—¶çš„åç½®å¤„ç†å™¨ç›´æ¥è¿”å› bean åŸå®ä¾‹ exposedObject = earlySingletonReferenceï¼šæŠŠä»£ç†åçš„ Bean ä¼ ç»™ exposedObject ç”¨æ¥è¿”å›ï¼Œå› ä¸ºåªæœ‰ä»£ç†å¯¹è±¡æ‰å°è£…äº†æ‹¦æˆªå™¨é“¾ï¼Œmain æ–¹æ³•ä¸­ç”¨ä»£ç†å¯¹è±¡è°ƒç”¨æ–¹æ³•æ—¶ä¼šè¿›è¡Œå¢å¼ºï¼Œä»£ç†æ˜¯å¯¹åŸå§‹å¯¹è±¡çš„åŒ…è£…ï¼Œæ‰€ä»¥è¿™é‡Œè¿”å›çš„ä»£ç†å¯¹è±¡ä¸­å«æœ‰å®Œæ•´çš„åŸå®ä¾‹ï¼ˆå±æ€§å¡«å……å’Œåˆå§‹åŒ–åçš„ï¼‰ï¼Œæ˜¯ä¸€ä¸ªå®Œæ•´çš„ä»£ç†å¯¹è±¡ï¼Œè¿”å›åå¤–å±‚æ–¹æ³•ä¼šå°†å½“å‰ Bean æ”¾å…¥ä¸€çº§ç¼“å­˜ else if (!this.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName))ï¼šæ˜¯å¦æœ‰å…¶ä»– bean ä¾èµ–å½“å‰ beanï¼Œæ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜æ˜¯ä¸å­˜åœ¨å¾ªç¯ä¾èµ–ã€å­˜åœ¨å¢å¼ºä»£ç†çš„é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯æ­£å¸¸çš„é€»è¾‘ dependentBeans = getDependentBeans(beanName)ï¼šå–åˆ°ä¾èµ–å½“å‰ bean çš„å…¶ä»– beanName if (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean))ï¼šåˆ¤æ–­ dependentBean æ˜¯å¦åˆ›å»ºå®Œæˆ if (!this.alreadyCreated.contains(beanName))ï¼šæˆç«‹å½“å‰ bean å°šæœªåˆ›å»ºå®Œæˆï¼Œå½“å‰ bean æ˜¯ä¾èµ–exposedObject çš„ beanï¼Œè¿”å› true return falseï¼šåˆ›å»ºå®Œæˆè¿”å› false actualDependentBeans.add(dependentBean)ï¼šåˆ›å»ºå®Œæˆçš„ dependentBean åŠ å…¥è¯¥é›†åˆ if (!actualDependentBeans.isEmpty())ï¼šæ¡ä»¶æˆç«‹è¯´æ˜æœ‰ä¾èµ–äºå½“å‰ bean çš„ bean å®ä¾‹åˆ›å»ºå®Œæˆï¼Œä½†æ˜¯å½“å‰çš„ bean è¿˜æ²¡åˆ›å»ºå®Œæˆè¿”å›ï¼Œä¾èµ–å½“å‰ bean çš„å¤–éƒ¨ bean æŒæœ‰çš„æ˜¯ä¸å®Œæ•´çš„ beanï¼Œæ‰€ä»¥éœ€è¦æŠ¥é”™ registerDisposableBeanIfNecessaryï¼šåˆ¤æ–­å½“å‰ bean æ˜¯å¦éœ€è¦æ³¨å†Œææ„å‡½æ•°å›è°ƒï¼Œå½“å®¹å™¨é”€æ¯æ—¶è¿›è¡Œå›è°ƒ if (!mbd.isPrototype() &amp;&amp; requiresDestruction(bean, mbd)) å¦‚æœæ˜¯åŸå‹ prototype ä¸ä¼šæ³¨å†Œææ„å›è°ƒï¼Œä¸ä¼šå›è°ƒè¯¥å‡½æ•°ï¼Œå¯¹è±¡çš„å›æ”¶ç”± JVM çš„ GC æœºåˆ¶å®Œæˆ requiresDestruction()ï¼š DisposableBeanAdapter.hasDestroyMethod(bean, mbd)ï¼šbd ä¸­å®šä¹‰äº† DestroyMethod è¿”å› true hasDestructionAwareBeanPostProcessors()ï¼šåå¤„ç†å™¨æ¡†æ¶å†³å®šæ˜¯å¦è¿›è¡Œææ„å›è°ƒ registerDisposableBean()ï¼šæ¡ä»¶æˆç«‹è¿›å…¥è¯¥æ–¹æ³•ï¼Œç»™å½“å‰å•å®ä¾‹æ³¨å†Œå›è°ƒé€‚é…å™¨ï¼Œé€‚é…å™¨å†…æ ¹æ®å½“å‰ bean å®ä¾‹æ˜¯ç»§æ‰¿æ¥å£ï¼ˆDisposableBeanï¼‰è¿˜æ˜¯è‡ªå®šä¹‰æ ‡ç­¾æ¥åˆ¤å®šå…·ä½“è°ƒç”¨å“ªä¸ªæ–¹æ³•å®ç° this.disposableBeans.put(beanName, bean)ï¼šå‘é”€æ¯é›†åˆæ·»åŠ å®ä¾‹ åˆ›å»ºå®ä¾‹AbstractAutowireCapableBeanFactory.createBeanInstance(beanName, RootBeanDefinition, Object[] args) resolveBeanClass(mbd, beanName)ï¼šç¡®ä¿ Bean çš„ Class çœŸæ­£çš„è¢«åŠ è½½ åˆ¤æ–­ç±»çš„è®¿é—®æƒé™æ˜¯ä¸æ˜¯ publicï¼Œä¸æ˜¯è¿›å…¥ä¸‹ä¸€ä¸ªåˆ¤æ–­ï¼Œæ˜¯å¦å…è®¸è®¿é—®ç±»çš„ non-public çš„æ„é€ æ–¹æ³•ï¼Œä¸å…è®¸åˆ™æŠ¥é”™ Supplier&lt;?&gt; instanceSupplier = mbd.getInstanceSupplier()ï¼šè·å–åˆ›å»ºå®ä¾‹çš„å‡½æ•°ï¼Œå¯ä»¥è‡ªå®šä¹‰ï¼Œæ²¡æœ‰è¿›å…¥ä¸‹é¢çš„é€»è¾‘ if (mbd.getFactoryMethodName() != null)ï¼šåˆ¤æ–­ bean æ˜¯å¦è®¾ç½®äº† factory-method å±æ€§ï¼Œä¼˜å…ˆä½¿ç”¨ ï¼Œè®¾ç½®äº†è¯¥å±æ€§è¿›å…¥ factory-method æ–¹æ³•åˆ›å»ºå®ä¾‹ resolved = falseï¼šä»£è¡¨ bd å¯¹åº”çš„æ„é€ ä¿¡æ¯æ˜¯å¦å·²ç»è§£ææˆå¯ä»¥åå°„è°ƒç”¨çš„æ„é€ æ–¹æ³• autowireNecessary = falseï¼šæ˜¯å¦è‡ªåŠ¨åŒ¹é…æ„é€ æ–¹æ³• if(mbd.resolvedConstructorOrFactoryMethod != null)ï¼šè·å– bd çš„æ„é€ ä¿¡æ¯è½¬åŒ–æˆåå°„è°ƒç”¨çš„ method ä¿¡æ¯ method ä¸º null åˆ™ resolved å’Œ autowireNecessary éƒ½ä¸ºé»˜è®¤å€¼ false autowireNecessary = mbd.constructorArgumentsResolvedï¼šæ„é€ æ–¹æ³•æœ‰å‚æ•°ï¼Œè®¾ç½®ä¸º true bd å¯¹åº”çš„æ„é€ ä¿¡æ¯è§£æå®Œæˆï¼Œå¯ä»¥ç›´æ¥åå°„è°ƒç”¨æ„é€ æ–¹æ³•äº†ï¼š return autowireConstructor(beanName, mbd, null, null)ï¼šæœ‰å‚æ„é€ ï¼Œæ ¹æ®å‚æ•°åŒ¹é…æœ€ä¼˜çš„æ„é€ å™¨åˆ›å»ºå®ä¾‹ return instantiateBean(beanName, mbd)ï¼šæ— å‚æ„é€ æ–¹æ³•é€šè¿‡åå°„åˆ›å»ºå®ä¾‹ SimpleInstantiationStrategy.instantiate()ï¼šçœŸæ­£ç”¨æ¥å®ä¾‹åŒ–çš„å‡½æ•°ï¼ˆæ— è®ºå¦‚ä½•éƒ½ä¼šèµ°åˆ°è¿™ä¸€æ­¥ï¼‰ if (!bd.hasMethodOverrides())ï¼šæ²¡æœ‰æ–¹æ³•é‡å†™è¦†ç›– BeanUtils.instantiateClass(constructorToUse)ï¼šè°ƒç”¨ Constructor.newInstance() å®ä¾‹åŒ– instantiateWithMethodInjection(bd, beanName, owner)ï¼šæœ‰æ–¹æ³•é‡å†™é‡‡ç”¨ CGLIB å®ä¾‹åŒ– BeanWrapper bw = new BeanWrapperImpl(beanInstance)ï¼šåŒ…è£…æˆ BeanWrapper ç±»å‹çš„å¯¹è±¡ return bwï¼šè¿”å›å®ä¾‹ ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName)ï¼š**@Autowired æ³¨è§£**ï¼Œå¯¹åº”çš„åç½®å¤„ç†å™¨ AutowiredAnnotationBeanPostProcessor é€»è¾‘ é…ç½®äº† lookup çš„ç›¸å…³é€»è¾‘ this.candidateConstructorsCache.get(beanClass)ï¼šä»ç¼“å­˜ä¸­è·å–æ„é€ æ–¹æ³•ï¼Œç¬¬ä¸€æ¬¡è·å–ä¸º nullï¼Œè¿›å…¥ä¸‹é¢é€»è¾‘ rawCandidates = beanClass.getDeclaredConstructors()ï¼šè·å–æ‰€æœ‰çš„æ„é€ å™¨ Constructor&lt;?&gt; requiredConstructor = nullï¼šå”¯ä¸€çš„é€‰é¡¹æ„é€ å™¨ï¼Œ**@Autowired(required &#x3D; â€œtrueâ€)** æ—¶æœ‰å€¼ for (Constructor&lt;?&gt; candidate : rawCandidates)ï¼šéå†æ‰€æœ‰çš„æ„é€ å™¨ï¼š ann = findAutowiredAnnotation(candidate)ï¼šæœ‰ä¸‰ç§æ³¨è§£ä¸­çš„ä¸€ä¸ªä¼šè¿”å›æ³¨è§£çš„å±æ€§ éå† this.autowiredAnnotationTypes ä¸­çš„ä¸‰ç§æ³¨è§£ï¼š 123this.autowiredAnnotationTypes.add(Autowired.class);//ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼this.autowiredAnnotationTypes.add(Value.class);this.autowiredAnnotationTypes.add(...ClassUtils.forName(&quot;javax.inject.Inject&quot;)); AnnotatedElementUtils.getMergedAnnotationAttributes(ao, type)ï¼šè·å–æ³¨è§£çš„å±æ€§ if (attributes != null) return attributesï¼šä»»æ„ä¸€ä¸ªæ³¨è§£å±æ€§ä¸ä¸ºç©ºå°±æ³¨è§£è¿”å› if (ann == null)ï¼šæ³¨è§£å±æ€§ä¸ºç©º userClass = ClassUtils.getUserClass(beanClass)ï¼šå¦‚æœå½“å‰ beanClass æ˜¯ä»£ç†å¯¹è±¡ï¼Œæ–¹æ³•ä¸Šå°±å·²ç»æ²¡æœ‰æ³¨è§£äº†ï¼Œæ‰€ä»¥è·å–åŸå§‹çš„ç”¨æˆ·ç±»å‹é‡æ–°è·å–è¯¥æ„é€ å™¨ä¸Šçš„æ³¨è§£å±æ€§ï¼ˆäº‹åŠ¡æ³¨è§£å¤±æ•ˆä¹Ÿæ˜¯è¿™ä¸ªåŸç†ï¼‰ if (ann != null)ï¼šæ³¨è§£å±æ€§ä¸ä¸ºç©ºäº† required = determineRequiredStatus(ann)ï¼šè·å– required å±æ€§çš„å€¼ !ann.containsKey(this.requiredParameterName) || ï¼šåˆ¤æ–­å±æ€§æ˜¯å¦åŒ…å« requiredï¼Œä¸åŒ…å«è¿›å…¥åé¢é€»è¾‘ this.requiredParameterValue == ann.getBoolean(this.requiredParameterName)ï¼šè·å–å±æ€§å€¼è¿”å› if (required)ï¼šä»£è¡¨æ³¨è§£ @Autowired(required &#x3D; true) if (!candidates.isEmpty())ï¼štrue ä»£è¡¨åªèƒ½æœ‰ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼Œæ„é€ é›†åˆä¸æ˜¯ç©ºä»£è¡¨å¯é€‰çš„æ„é€ å™¨ä¸å”¯ä¸€ï¼ŒæŠ¥é”™ requiredConstructor = candidateï¼šæŠŠæ„é€ å™¨èµ‹å€¼ç»™ requiredConstructor candidates.add(candidate)ï¼šæŠŠå½“å‰æ„é€ æ–¹æ³•æ·»åŠ è‡³ candidates é›†åˆ if(candidate.getParameterCount() == 0)ï¼šå½“å‰éå†çš„æ„é€ å™¨çš„å‚æ•°ä¸º 0 ä»£è¡¨æ²¡æœ‰å‚æ•°ï¼Œæ˜¯é»˜è®¤æ„é€ å™¨ï¼Œèµ‹å€¼ç»™ defaultConstructor candidateConstructors = candidates.toArray(new Constructor&lt;?&gt;[0])ï¼šå°†æ„é€ å™¨è½¬æˆæ•°ç»„è¿”å› if(ctors != null)ï¼šæ¡ä»¶æˆç«‹ä»£è¡¨æŒ‡å®šäº†æ„é€ æ–¹æ³•æ•°ç»„ mbd.getResolvedAutowireMode() == AUTOWIRE_CONSTRUCTORï¼š æ ‡ç­¾å†… autowiremode çš„å±æ€§å€¼ï¼Œé»˜è®¤æ˜¯ noï¼ŒAUTOWIRE_CONSTRUCTOR ä»£è¡¨é€‰æ‹©æœ€ä¼˜çš„æ„é€ æ–¹æ³• mbd.hasConstructorArgumentValues()ï¼šbean ä¿¡æ¯ä¸­æ˜¯å¦é…ç½®äº†æ„é€ å‚æ•°çš„å€¼ !ObjectUtils.isEmpty(args)ï¼šgetBean æ—¶ï¼ŒæŒ‡å®šäº†å‚æ•° arg return autowireConstructor(beanName, mbd, ctors, args)ï¼šé€‰æ‹©æœ€ä¼˜çš„æ„é€ å™¨è¿›è¡Œåˆ›å»ºå®ä¾‹ï¼ˆå¤æ‚ï¼Œä¸å»ºè®®ç ”ç©¶ï¼‰ beanFactory.initBeanWrapper(bw)ï¼šå‘ BeanWrapper ä¸­æ³¨å†Œè½¬æ¢å™¨ï¼Œå‘å·¥å‚ä¸­æ³¨å†Œå±æ€§ç¼–è¾‘å™¨ Constructor&lt;?&gt; constructorToUse = nullï¼šå®ä¾‹åŒ–åå°„æ„é€ å™¨ ArgumentsHolder argsHolderToUseï¼šå®ä¾‹åŒ–æ—¶çœŸæ­£å»ç”¨çš„å‚æ•°ï¼Œå¹¶æŒæœ‰å¯¹è±¡ rawArguments æ˜¯è½¬æ¢å‰çš„å‚æ•°ï¼Œarguments æ˜¯ç±»å‹è½¬æ¢å®Œæˆçš„å‚æ•° Object[] argsToUseï¼šå‚æ•°å®ä¾‹åŒ–æ—¶ä½¿ç”¨çš„å‚æ•° Object[] argsToResolveï¼šè¡¨ç¤ºæ„é€ å™¨å‚æ•°åšè½¬æ¢åçš„å‚æ•°å¼•ç”¨ if (constructorToUse != null &amp;&amp; mbd.constructorArgumentsResolved)ï¼š æ¡ä»¶ä¸€æˆç«‹è¯´æ˜å½“å‰ bd ç”Ÿæˆçš„å®ä¾‹ä¸æ˜¯ç¬¬ä¸€æ¬¡ï¼Œç¼“å­˜ä¸­æœ‰è§£æå¥½çš„æ„é€ å™¨æ–¹æ³•å¯ä»¥ç›´æ¥æ‹¿æ¥åå°„è°ƒç”¨ æ¡ä»¶äºŒæˆç«‹è¯´æ˜æ„é€ å™¨å‚æ•°å·²ç»è§£æè¿‡äº† argsToUse = resolvePreparedArguments()ï¼šargsToResolve ä¸æ˜¯å®Œå…¨è§£æå¥½çš„ï¼Œè¿˜éœ€è¦ç»§ç»­è§£æ if (constructorToUse == null || argsToUse == null)ï¼šæ¡ä»¶æˆç«‹è¯´æ˜ç¼“å­˜æœºåˆ¶å¤±è´¥ï¼Œè¿›å…¥æ„é€ å™¨åŒ¹é…é€»è¾‘ Constructor&lt;?&gt;[] candidates = chosenCtorsï¼šchosenCtors åªæœ‰åœ¨æ„é€ æ–¹æ³•ä¸Šæœ‰ autowaire ä¸‰ç§æ³¨è§£æ—¶æ‰æœ‰æ•°æ® if (candidates == null)ï¼šcandidates ä¸ºç©ºå°±æ ¹æ® beanClass æ˜¯å¦å…è®¸è®¿é—®éå…¬å¼€çš„æ–¹æ³•æ¥è·å–æ„é€ æ–¹æ³• if (candidates.length == 1 &amp;&amp; explicitArgs == null &amp;&amp; !mbd.hasConstructorArgumentValues())ï¼šé»˜è®¤æ— å‚ bw.setBeanInstance(instantiate())ï¼šä½¿ç”¨æ— å‚æ„é€ å™¨åå°„è°ƒç”¨ï¼Œåˆ›å»ºå‡ºå®ä¾‹å¯¹è±¡ï¼Œè®¾ç½®åˆ° BeanWrapper ä¸­å» boolean autowiringï¼šéœ€è¦é€‰æ‹©æœ€ä¼˜çš„æ„é€ å™¨ cargs = mbd.getConstructorArgumentValues()ï¼šè·å–å‚æ•°å€¼ resolvedValues = new ConstructorArgumentValues()ï¼šè·å–å·²ç»è§£æåçš„æ„é€ å™¨å‚æ•°å€¼ final Map&lt;Integer, ValueHolder&gt; indexedArgumentValuesï¼škey æ˜¯ indexï¼Œ value æ˜¯å€¼ final List&lt;ValueHolder&gt; genericArgumentValuesï¼šæ²¡æœ‰ index çš„å€¼ minNrOfArgs = resolveConstructorArguments(..,resolvedValues)ï¼šä» bd ä¸­è§£æå¹¶è·å–æ„é€ å™¨å‚æ•°çš„ä¸ªæ•° valueResolver.resolveValueIfNecessary()ï¼šå°†å¼•ç”¨è½¬æ¢æˆçœŸå®çš„å¯¹è±¡ resolvedValueHolder.setSource(valueHolder)ï¼šå°†å¯¹è±¡å¡«å……è‡³ ValueHolder ä¸­ resolvedValues.addIndexedArgumentValue()ï¼šå°†å‚æ•°å€¼å°è£…è‡³ resolvedValues ä¸­ AutowireUtils.sortConstructors(candidates)ï¼šæ’åºè§„åˆ™ public &gt; éå…¬å¼€çš„ &gt; å‚æ•°å¤šçš„ &gt; å‚æ•°å°‘çš„ int minTypeDiffWeight = Integer.MAX_VALUEï¼šå€¼è¶Šä½è¯´æ˜æ„é€ å™¨å‚æ•°åˆ—è¡¨ç±»å‹å’Œæ„é€ å‚æ•°çš„åŒ¹é…åº¦è¶Šé«˜ Set&lt;Constructor&lt;?&gt;&gt; ambiguousConstructorsï¼šæ¨¡æ£±ä¸¤å¯çš„æ„é€ å™¨ï¼Œä¸¤ä¸ªæ„é€ å™¨åŒ¹é…åº¦ç›¸ç­‰æ—¶æ”¾å…¥ for (Constructor&lt;?&gt; candidate : candidates)ï¼šéå†ç­›é€‰å‡º minTypeDiffWeight æœ€ä½çš„æ„é€ å™¨ Class&lt;?&gt;[] paramTypes = candidate.getParameterTypes()ï¼šè·å–å½“å‰å¤„ç†çš„æ„é€ å™¨çš„å‚æ•°ç±»å‹ if()ï¼šcandidates æ˜¯æ’è¿‡åºçš„ï¼Œå½“å‰ç­›é€‰å‡ºæ¥çš„æ„é€ å™¨çš„ä¼˜å…ˆçº§ä¸€å®šæ˜¯ä¼˜å…ˆäºåé¢çš„ constructor if (paramTypes.length &lt; minNrOfArgs)ï¼šéœ€æ±‚çš„å°äºç»™çš„ï¼Œä¸åŒ¹é… int typeDiffWeightï¼šè·å–åŒ¹é…åº¦ mbd.isLenientConstructorResolution()ï¼štrue è¡¨ç¤º ambiguousConstructors å…è®¸æœ‰æ•°æ®ï¼Œfalse ä»£è¡¨ä¸å…è®¸æœ‰æ•°æ®ï¼Œæœ‰æ•°æ®å°±æŠ¥é”™ï¼ˆLenientConstructorResolutionï¼šå®½æ¾çš„æ„é€ å‡½æ•°è§£æï¼‰ argsHolder.getTypeDifferenceWeight(paramTypes)ï¼šé€‰æ‹©å‚æ•°è½¬æ¢å‰å’Œè½¬æ¢ååŒ¹é…åº¦æœ€ä½çš„ï¼Œå¾ªç¯å‘çˆ¶ç±»ä¸­å¯»æ‰¾è¯¥æ–¹æ³•ï¼Œç›´åˆ°å¯»æ‰¾åˆ° Obejct ç±» if (typeDiffWeight &lt; minTypeDiffWeight)ï¼šæ¡ä»¶æˆç«‹è¯´æ˜å½“å‰å¾ªç¯å¤„ç†çš„æ„é€ å™¨æ›´ä¼˜ else if (constructorToUse != null &amp;&amp; typeDiffWeight == minTypeDiffWeight)ï¼šå½“å‰å¤„ç†çš„æ„é€ å™¨çš„è®¡ç®—å‡ºæ¥çš„ DiffWeight ä¸ä¸Šä¸€æ¬¡ç­›é€‰å‡ºæ¥çš„æœ€ä¼˜æ„é€ å™¨çš„å€¼ä¸€è‡´ï¼Œè¯´æ˜æœ‰æ¨¡æ£±ä¸¤å¯çš„æƒ…å†µ if (constructorToUse == null)ï¼šæœªæ‰¾åˆ°å¯ä»¥ä½¿ç”¨çš„æ„é€ å™¨ï¼ŒæŠ¥é”™ else if (ambiguousConstructors != null &amp;&amp; !mbd.isLenientConstructorResolution())ï¼šæ¨¡æ£±ä¸¤å¯æœ‰æ•°æ®ï¼ŒLenientConstructorResolution &#x3D;&#x3D; falseï¼Œæ‰€ä»¥æŠ¥é”™ argsHolderToUse.storeCache(mbd, constructorToUse)ï¼šåŒ¹é…æˆåŠŸï¼Œè¿›è¡Œç¼“å­˜ï¼Œæ–¹ä¾¿åæ¥è€…ä½¿ç”¨è¯¥ bd å®ä¾‹åŒ– bw.setBeanInstance(instantiate(beanName, mbd, constructorToUse, argsToUse))ï¼šåŒ¹é…æˆåŠŸè°ƒç”¨ instantiate åˆ›å»ºå‡ºå®ä¾‹å¯¹è±¡ï¼Œè®¾ç½®åˆ° BeanWrapper ä¸­å» return instantiateBean(beanName, mbd)ï¼šé»˜è®¤èµ°åˆ°è¿™é‡Œ å¾ªç¯ä¾èµ–å¾ªç¯å¼•ç”¨å¾ªç¯ä¾èµ–ï¼šæ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªå¯¹è±¡å®ä¾‹ä¹‹é—´å­˜åœ¨ç›´æ¥æˆ–é—´æ¥çš„ä¾èµ–å…³ç³»ï¼Œè¿™ç§ä¾èµ–å…³ç³»æ„æˆä¸€ä¸ªç¯å½¢è°ƒç”¨ Spring å¾ªç¯ä¾èµ–æœ‰å››ç§ï¼š DependsOn ä¾èµ–åŠ è½½ã€æ— æ³•è§£å†³ã€‘ï¼ˆä¸¤ç§ Mapï¼‰ åŸå‹æ¨¡å¼ Prototype å¾ªç¯ä¾èµ–ã€æ— æ³•è§£å†³ã€‘ï¼ˆæ­£åœ¨åˆ›å»ºé›†åˆï¼‰ å•ä¾‹ Bean å¾ªç¯ä¾èµ–ï¼šæ„é€ å‚æ•°äº§ç”Ÿä¾èµ–ã€æ— æ³•è§£å†³ã€‘ï¼ˆæ­£åœ¨åˆ›å»ºé›†åˆï¼ŒgetSingleton() é€»è¾‘ä¸­ï¼‰ å•ä¾‹ Bean å¾ªç¯ä¾èµ–ï¼šsetter äº§ç”Ÿä¾èµ–ã€å¯ä»¥è§£å†³ã€‘ è§£å†³å¾ªç¯ä¾èµ–ï¼šæå‰å¼•ç”¨ï¼Œæå‰æš´éœ²åˆ›å»ºä¸­çš„ Bean Spring å…ˆå®ä¾‹åŒ– Aï¼Œæ‹¿åˆ° A çš„æ„é€ æ–¹æ³•åå°„åˆ›å»ºå‡ºæ¥ A çš„æ—©æœŸå®ä¾‹å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡è¢«åŒ…è£…æˆ ObjectFactory å¯¹è±¡ï¼Œæ”¾å…¥ä¸‰çº§ç¼“å­˜ å¤„ç† A çš„ä¾èµ–æ•°æ®ï¼Œæ£€æŸ¥å‘ç° A ä¾èµ– B å¯¹è±¡ï¼Œæ‰€ä»¥ Spring å°±ä¼šå»æ ¹æ® B ç±»å‹åˆ°å®¹å™¨ä¸­å» getBean(B)ï¼Œè¿™é‡Œäº§ç”Ÿé€’å½’ æ‹¿åˆ° B çš„æ„é€ æ–¹æ³•ï¼Œè¿›è¡Œåå°„åˆ›å»ºå‡ºæ¥ B çš„æ—©æœŸå®ä¾‹å¯¹è±¡ï¼Œä¹Ÿä¼šæŠŠ B åŒ…è£…æˆ ObjectFactory å¯¹è±¡ï¼Œæ”¾åˆ°ä¸‰çº§ç¼“å­˜ï¼Œå¤„ç† B çš„ä¾èµ–æ•°æ®ï¼Œæ£€æŸ¥å‘ç° B ä¾èµ–äº† A å¯¹è±¡ï¼Œç„¶å Spring å°±ä¼šå»æ ¹æ® A ç±»å‹åˆ°å®¹å™¨ä¸­å» getBean(A.class) è¿™æ—¶ä»ä¸‰çº§ç¼“å­˜ä¸­è·å–åˆ° A çš„æ—©æœŸå¯¹è±¡è¿›å…¥å±æ€§å¡«å…… å¾ªç¯ä¾èµ–çš„ä¸‰çº§ç¼“å­˜ï¼š 12345678//ä¸€çº§ç¼“å­˜ï¼šå­˜æ”¾æ‰€æœ‰åˆå§‹åŒ–å®Œæˆå•å®ä¾‹ beanï¼Œå•ä¾‹æ± ï¼Œkeyæ˜¯beanNameï¼Œvalueæ˜¯å¯¹åº”çš„å•å®ä¾‹å¯¹è±¡å¼•ç”¨private final Map&lt;String, Object&gt; singletonObjects = new ConcurrentHashMap&lt;&gt;(256);//äºŒçº§ç¼“å­˜ï¼šå­˜æ”¾å®ä¾‹åŒ–æœªè¿›è¡Œåˆå§‹åŒ–çš„ Beanï¼Œæå‰å¼•ç”¨æ± private final Map&lt;String, Object&gt; earlySingletonObjects = new HashMap&lt;&gt;(16);/** Cache of singleton factories: bean name to ObjectFactory. 3*/private final Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = new HashMap&lt;&gt;(16); ä¸ºä»€ä¹ˆéœ€è¦ä¸‰çº§ç¼“å­˜ï¼Ÿ å¾ªç¯ä¾èµ–è§£å†³éœ€è¦æå‰å¼•ç”¨åŠ¨æ€ä»£ç†å¯¹è±¡ï¼ŒAOP åŠ¨æ€ä»£ç†æ˜¯åœ¨ Bean åˆå§‹åŒ–åçš„åç½®å¤„ç†ä¸­è¿›è¡Œï¼Œè¿™æ—¶çš„ bean å·²ç»æ˜¯æˆå“å¯¹è±¡ã€‚å› ä¸ºéœ€è¦æå‰è¿›è¡ŒåŠ¨æ€ä»£ç†ï¼Œä¸‰çº§ç¼“å­˜çš„ ObjectFactory æå‰äº§ç”Ÿéœ€è¦ä»£ç†çš„å¯¹è±¡ï¼ŒæŠŠæå‰å¼•ç”¨æ”¾å…¥äºŒçº§ç¼“å­˜ å¦‚æœåªæœ‰äºŒçº§ç¼“å­˜ï¼Œæå‰å¼•ç”¨å°±ç›´æ¥æ”¾å…¥äº†ä¸€çº§ç¼“å­˜ï¼Œç„¶å Bean åˆå§‹åŒ–å®Œæˆååˆä¼šæ”¾å…¥ä¸€çº§ç¼“å­˜ï¼Œäº§ç”Ÿæ•°æ®è¦†ç›–ï¼Œå¯¼è‡´æå‰å¼•ç”¨çš„å¯¹è±¡å’Œä¸€çº§ç¼“å­˜ä¸­çš„å¹¶ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ ä¸€çº§ç¼“å­˜åªèƒ½å­˜æ”¾å®Œæ•´çš„å•å®ä¾‹ï¼Œä¸ºäº†ä¿è¯ Bean çš„ç”Ÿå‘½å‘¨æœŸä¸è¢«ç ´åï¼Œä¸èƒ½å°†æœªåˆå§‹åŒ–çš„ Bean æš´éœ²åˆ°ä¸€çº§ç¼“å­˜ è‹¥å­˜åœ¨å¾ªç¯ä¾èµ–ï¼Œåç½®å¤„ç†ä¸åˆ›å»ºä»£ç†å¯¹è±¡ï¼ŒçœŸæ­£åˆ›å»ºä»£ç†å¯¹è±¡çš„è¿‡ç¨‹æ˜¯åœ¨ getBean(B) çš„é˜¶æ®µä¸­ ä¸‰çº§ç¼“å­˜ä¸€å®šä¼šåˆ›å»ºæå‰å¼•ç”¨å—ï¼Ÿ å‡ºç°å¾ªç¯ä¾èµ–å°±ä¼šå»ä¸‰çº§ç¼“å­˜è·å–æå‰å¼•ç”¨ï¼Œä¸å‡ºç°å°±ä¸ä¼šï¼Œèµ°æ­£å¸¸çš„é€»è¾‘ï¼Œåˆ›å»ºå®Œæˆç›´æ¥æ”¾å…¥ä¸€çº§ç¼“å­˜ å­˜åœ¨å¾ªç¯ä¾èµ–ï¼Œå°±åˆ›å»ºä»£ç†å¯¹è±¡æ”¾å…¥äºŒçº§ç¼“å­˜ï¼Œå¦‚æœæ²¡æœ‰å¢å¼ºæ–¹æ³•å°±è¿”å› createBeanInstance åˆ›å»ºçš„å®ä¾‹ï¼Œå› ä¸º addSingletonFactory å‚æ•°ä¸­ä¼ å…¥äº†å®ä¾‹åŒ–çš„ Beanï¼Œåœ¨ singletonFactory.getObject() ä¸­è¿”å›ç»™ singletonObjectï¼Œæ‰€ä»¥å­˜åœ¨å¾ªç¯ä¾èµ–å°±ä¸€å®šä¼šä½¿ç”¨å·¥å‚ï¼Œä½†æ˜¯ä¸ä¸€å®šåˆ›å»ºçš„æ˜¯ä»£ç†å¯¹è±¡ï¼Œä¸éœ€è¦å¢å¼ºå°±æ˜¯åŸå§‹å¯¹è±¡ wrapIfNecessary ä¸€å®šåˆ›å»ºä»£ç†å¯¹è±¡å—ï¼Ÿï¼ˆAOP åŠ¨æ€ä»£ç†éƒ¨åˆ†æœ‰æºç è§£æï¼‰ å­˜åœ¨å¢å¼ºå™¨ä¼šåˆ›å»ºåŠ¨æ€ä»£ç†ï¼Œä¸éœ€è¦å¢å¼ºå°±ä¸éœ€è¦åˆ›å»ºåŠ¨æ€ä»£ç†å¯¹è±¡ å­˜åœ¨å¾ªç¯ä¾èµ–ä¼šæå‰å¢å¼ºï¼Œåˆå§‹åŒ–åä¸éœ€è¦å¢å¼º ä»€ä¹ˆæ—¶å€™å°† Bean çš„å¼•ç”¨æå‰æš´éœ²ç»™ç¬¬ä¸‰çº§ç¼“å­˜çš„ ObjectFactory æŒæœ‰ï¼Ÿ å®ä¾‹åŒ–ä¹‹åï¼Œä¾èµ–æ³¨å…¥ä¹‹å‰ 1createBeanInstance -&gt; addSingletonFactory -&gt; populateBean æºç è§£æå‡å¦‚ A ä¾èµ– Bï¼ŒB ä¾èµ– A å½“ A åˆ›å»ºå®ä¾‹åå¡«å……å±æ€§å‰ï¼Œæ‰§è¡Œï¼š 1addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean)) 1234567891011121314// æ·»åŠ ç»™å®šçš„å•ä¾‹å·¥å‚ä»¥æ„å»ºæŒ‡å®šçš„å•ä¾‹protected void addSingletonFactory(String beanName, ObjectFactory&lt;?&gt; singletonFactory) &#123; Assert.notNull(singletonFactory, &quot;Singleton factory must not be null&quot;); synchronized (this.singletonObjects) &#123; // å•ä¾‹æ± åŒ…å«è¯¥Beanè¯´æ˜å·²ç»åˆ›å»ºå®Œæˆï¼Œä¸éœ€è¦å¾ªç¯ä¾èµ– if (!this.singletonObjects.containsKey(beanName)) &#123; //åŠ å…¥ä¸‰çº§ç¼“å­˜ this.singletonFactories.put(beanName,singletonFactory); this.earlySingletonObjects.remove(beanName); // ä»äºŒçº§ç¼“å­˜ç§»é™¤ï¼Œå› ä¸ºä¸‰ä¸ªMapä¸­éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä¸èƒ½åŒæ—¶å­˜åœ¨ï¼ this.registeredSingletons.add(beanName); &#125; &#125;&#125; å¡«å……å±æ€§æ—¶ A ä¾èµ– Bï¼Œè¿™æ—¶éœ€è¦ getBean(B)ï¼Œä¹Ÿä¼šæŠŠ B çš„å·¥å‚æ”¾å…¥ä¸‰çº§ç¼“å­˜ï¼Œæ¥ç€ B å¡«å……å±æ€§æ—¶å‘ç°ä¾èµ– Aï¼Œå»è¿›è¡Œ**ç¬¬ä¸€æ¬¡ ** getSingleton(A) 123456789101112131415161718192021222324252627public Object getSingleton(String beanName) &#123; return getSingleton(beanName, true);//ä¸ºtrueä»£è¡¨å…è®¸æ‹¿åˆ°æ—©æœŸå¼•ç”¨ã€‚&#125;protected Object getSingleton(String beanName, boolean allowEarlyReference) &#123; // åœ¨ä¸€çº§ç¼“å­˜ä¸­è·å– beanName å¯¹åº”çš„å•å®ä¾‹å¯¹è±¡ã€‚ Object singletonObject = this.singletonObjects.get(beanName); // å•å®ä¾‹ç¡®å®å°šæœªåˆ›å»ºï¼›å•å®ä¾‹æ­£åœ¨åˆ›å»ºï¼Œå‘ç”Ÿäº†å¾ªç¯ä¾èµ– if (singletonObject == null &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123; synchronized (this.singletonObjects) &#123; // ä»äºŒçº§ç¼“å­˜è·å– singletonObject = this.earlySingletonObjects.get(beanName); // äºŒçº§ç¼“å­˜ä¸å­˜åœ¨ï¼Œå¹¶ä¸”å…è®¸è·å–æ—©æœŸå®ä¾‹å¯¹è±¡ï¼Œå»ä¸‰çº§ç¼“å­˜æŸ¥çœ‹ if (singletonObject == null &amp;&amp; allowEarlyReference) &#123; ObjectFactory&lt;?&gt; singletonFactory = this.singletonFactories.get(beanName); if (singletonFactory != null) &#123; // ä»ä¸‰çº§ç¼“å­˜è·å–å·¥å‚å¯¹è±¡ï¼Œå¹¶å¾—åˆ° bean çš„æå‰å¼•ç”¨ singletonObject = singletonFactory.getObject(); // ã€ç¼“å­˜å‡çº§ã€‘ï¼Œæ”¾å…¥äºŒçº§ç¼“å­˜ï¼Œæå‰å¼•ç”¨æ±  this.earlySingletonObjects.put(beanName, singletonObject); // ä»ä¸‰çº§ç¼“å­˜ç§»é™¤è¯¥å¯¹è±¡ this.singletonFactories.remove(beanName); &#125; &#125; &#125; &#125; return singletonObject;&#125; ä»ä¸‰çº§ç¼“å­˜è·å– A çš„ Beanï¼šsingletonFactory.getObject()ï¼Œè°ƒç”¨äº† lambda è¡¨è¾¾å¼çš„ getEarlyBeanReference æ–¹æ³•ï¼š 1234567public Object getEarlyBeanReference(Object bean, String beanName) &#123; Object cacheKey = getCacheKey(bean.getClass(), beanName); // ã€å‘æå‰å¼•ç”¨ä»£ç†æ±  earlyProxyReferences ä¸­æ·»åŠ è¯¥ Beanï¼Œé˜²æ­¢å¯¹è±¡è¢«é‡æ–°ä»£ç†ã€‘ this.earlyProxyReferences.put(cacheKey, bean); // åˆ›å»ºä»£ç†å¯¹è±¡ï¼ŒcreateProxy return wrapIfNecessary(bean, beanName, cacheKey);&#125; B å¡«å……äº† A çš„æå‰å¼•ç”¨åä¼šç»§ç»­åˆå§‹åŒ–ç›´åˆ°å®Œæˆï¼Œè¿”å›åŸå§‹ A çš„é€»è¾‘ç»§ç»­æ‰§è¡Œ AOPæ³¨è§£åŸç†@EnableAspectJAutoProxyï¼šAOP æ³¨è§£é©±åŠ¨ï¼Œç»™å®¹å™¨ä¸­å¯¼å…¥ AspectJAutoProxyRegistrar 12345678910@Import(AspectJAutoProxyRegistrar.class)public @interface EnableAspectJAutoProxy &#123; // æ˜¯å¦å¼ºåˆ¶ä½¿ç”¨ CGLIB åˆ›å»ºä»£ç†å¯¹è±¡ // é…ç½®æ–‡ä»¶æ–¹å¼ï¼š&lt;aop:aspectj-autoproxy proxy-target-class=&quot;true&quot;/&gt; boolean proxyTargetClass() default false; // å°†å½“å‰ä»£ç†å¯¹è±¡æš´éœ²åˆ°ä¸Šä¸‹æ–‡å†…ï¼Œæ–¹ä¾¿ä»£ç†å¯¹è±¡å†…éƒ¨çš„çœŸå®å¯¹è±¡æ‹¿åˆ°ä»£ç†å¯¹è±¡ // é…ç½®æ–‡ä»¶æ–¹å¼ï¼š&lt;aop:aspectj-autoproxy expose-proxy=&quot;true&quot;/&gt; boolean exposeProxy() default false;&#125; AspectJAutoProxyRegistrar åœ¨ç”¨æ¥å‘å®¹å™¨ä¸­æ³¨å†Œ AnnotationAwareAspectJAutoProxyCreatorï¼Œä»¥ BeanDefiantion å½¢å¼å­˜åœ¨ï¼Œåœ¨å®¹å™¨åˆå§‹åŒ–æ—¶åŠ è½½ã€‚AnnotationAwareAspectJAutoProxyCreator é—´æ¥å®ç°äº† InstantiationAwareBeanPostProcessorï¼ŒOrder æ¥å£ï¼Œè¯¥ç±»ä¼šåœ¨ Bean çš„å®ä¾‹åŒ–å’Œåˆå§‹åŒ–çš„å‰åèµ·ä½œç”¨ å·¥ä½œæµç¨‹ï¼šåˆ›å»º IOC å®¹å™¨ï¼Œè°ƒç”¨ refresh() åˆ·æ–°å®¹å™¨ï¼ŒregisterBeanPostProcessors(beanFactory) é˜¶æ®µï¼Œé€šè¿‡ getBean() åˆ›å»º AnnotationAwareAspectJAutoProxyCreator å¯¹è±¡ï¼Œåœ¨ç”Ÿå‘½å‘¨æœŸçš„åˆå§‹åŒ–æ–¹æ³•ä¸­æ‰§è¡Œå›è°ƒ initBeanFactory() æ–¹æ³•åˆå§‹åŒ–æ³¨å†Œä¸‰ä¸ªå·¥å…·ç±»ï¼šBeanFactoryAdvisorRetrievalHelperAdapterã€ReflectiveAspectJAdvisorFactoryã€BeanFactoryAspectJAdvisorsBuilderAdapter åç½®å¤„ç†Bean åˆå§‹åŒ–å®Œæˆçš„æ‰§è¡Œåç½®å¤„ç†å™¨çš„æ–¹æ³•ï¼š 123456789101112public Object postProcessAfterInitialization(@Nullable Object bean,String bN)&#123; if (bean != null) &#123; // cacheKey æ˜¯ ã€beanName æˆ–è€…åŠ ä¸Š &amp; çš„ beanNameã€‘ Object cacheKey = getCacheKey(bean.getClass(), beanName); if (this.earlyProxyReferences.remove(cacheKey) != bean) &#123; // å»æå‰ä»£ç†å¼•ç”¨æ± ä¸­å¯»æ‰¾è¯¥ keyï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºä»£ç† // å¦‚æœå­˜åœ¨åˆ™è¯æ˜è¢«ä»£ç†è¿‡ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰çš„ beanï¼Œä¸æ˜¯åˆ™åˆ›å»ºä»£ç† return wrapIfNecessary(bean, bN, cacheKey); &#125; &#125; return bean;&#125; AbstractAutoProxyCreator.wrapIfNecessary()ï¼šæ ¹æ®é€šçŸ¥åˆ›å»ºåŠ¨æ€ä»£ç†ï¼Œæ²¡æœ‰é€šçŸ¥ç›´æ¥è¿”å›åŸå®ä¾‹ 1234567891011121314151617181920212223242526272829303132333435363738protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) &#123; // æ¡ä»¶ä¸€èˆ¬ä¸æˆç«‹ï¼Œå¾ˆå°‘ä½¿ç”¨ TargetSourceCreator å»åˆ›å»ºå¯¹è±¡ BeforeInstantiation é˜¶æ®µï¼ŒdoCreateBean ä¹‹å‰çš„é˜¶æ®µ if (StringUtils.hasLength(beanName) &amp;&amp; this.targetSourcedBeans.contains(beanName)) &#123; return bean; &#125; // advisedBeans é›†åˆä¿å­˜çš„æ˜¯ bean æ˜¯å¦è¢«å¢å¼ºè¿‡äº† // æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰ beanName å¯¹åº”çš„å®ä¾‹ä¸éœ€è¦è¢«å¢å¼ºå¤„ç†ï¼Œåˆ¤æ–­æ˜¯åœ¨ BeforeInstantiation é˜¶æ®µåšçš„ if (Boolean.FALSE.equals(this.advisedBeans.get(cacheKey))) &#123; return bean; &#125; // æ¡ä»¶ä¸€ï¼šåˆ¤æ–­å½“å‰ bean ç±»å‹æ˜¯å¦æ˜¯åŸºç¡€æ¡†æ¶ç±»å‹ï¼Œè¿™ä¸ªç±»çš„å®ä¾‹ä¸èƒ½è¢«å¢å¼º // æ¡ä»¶äºŒï¼šshouldSkip åˆ¤æ–­å½“å‰ beanName æ˜¯å¦æ˜¯ .ORIGINAL ç»“å°¾ï¼Œå¦‚æœæ˜¯å°±è·³è¿‡å¢å¼ºé€»è¾‘ï¼Œç›´æ¥è¿”å› if (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) &#123; this.advisedBeans.put(cacheKey, Boolean.FALSE); return bean; &#125; // ã€æŸ¥æ‰¾é€‚åˆå½“å‰ bean å®ä¾‹çš„å¢å¼ºæ–¹æ³•ã€‘ï¼ˆä¸‹ä¸€èŠ‚è¯¦è§£ï¼‰ Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null); // æ¡ä»¶æˆç«‹è¯´æ˜ä¸Šé¢æ–¹æ³•æŸ¥è¯¢åˆ°é€‚åˆå½“å‰classçš„é€šçŸ¥ if (specificInterceptors != DO_NOT_PROXY) &#123; this.advisedBeans.put(cacheKey, Boolean.TRUE); // æ ¹æ®æŸ¥è¯¢åˆ°çš„å¢å¼ºåˆ›å»ºä»£ç†å¯¹è±¡ï¼ˆä¸‹ä¸€èŠ‚è¯¦è§£ï¼‰ // å‚æ•°ä¸€ï¼šç›®æ ‡å¯¹è±¡ // å‚æ•°äºŒï¼šbeanName // å‚æ•°ä¸‰ï¼šåŒ¹é…å½“å‰ç›®æ ‡å¯¹è±¡ clazz çš„ Advisor æ•°æ® Object proxy = createProxy( bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean)); // ä¿å­˜ä»£ç†å¯¹è±¡ç±»å‹ this.proxyTypes.put(cacheKey, proxy.getClass()); // è¿”å›ä»£ç†å¯¹è±¡ return proxy; &#125; // æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜æ²¡æœ‰æŸ¥åˆ°é€šçŸ¥ï¼Œå½“å‰ bean ä¸éœ€è¦å¢å¼º this.advisedBeans.put(cacheKey, Boolean.FALSE); // ã€è¿”å›åŸå§‹çš„ bean å®ä¾‹ã€‘ return bean;&#125; è·å–é€šçŸ¥AbstractAdvisorAutoProxyCreator.getAdvicesAndAdvisorsForBean()ï¼šæŸ¥æ‰¾é€‚åˆå½“å‰ç±»å®ä¾‹çš„å¢å¼ºï¼Œå¹¶è¿›è¡Œæ’åº 12345678910protected Object[] getAdvicesAndAdvisorsForBean(Class&lt;?&gt; beanClass, String beanName, @Nullable TargetSource targetSource) &#123; // æŸ¥è¯¢é€‚åˆå½“å‰ç±»å‹çš„å¢å¼ºé€šçŸ¥ List&lt;Advisor&gt; advisors = findEligibleAdvisors(beanClass, beanName); if (advisors.isEmpty()) &#123; // å¢å¼ºä¸ºç©ºç›´æ¥è¿”å› nullï¼Œä¸éœ€è¦åˆ›å»ºä»£ç† return DO_NOT_PROXY; &#125; // ä¸æ˜¯ç©ºï¼Œè½¬æˆæ•°ç»„è¿”å› return advisors.toArray();&#125; AbstractAdvisorAutoProxyCreator.findEligibleAdvisors()ï¼š candidateAdvisors = findCandidateAdvisors()ï¼šè·å–å½“å‰å®¹å™¨å†…å¯ä»¥ä½¿ç”¨ï¼ˆæ‰€æœ‰ï¼‰çš„ advisorï¼Œè°ƒç”¨çš„æ˜¯ AnnotationAwareAspectJAutoProxyCreator ç±»çš„æ–¹æ³•ï¼Œæ¯ä¸ªæ–¹æ³•å¯¹åº”ä¸€ä¸ª Advisor advisors = super.findCandidateAdvisors()ï¼šæŸ¥è¯¢å‡º XML é…ç½®çš„æ‰€æœ‰ Advisor ç±»å‹ advisorNames = BeanFactoryUtils.beanNamesForTypeIncludingAncestors()ï¼šé€šè¿‡ BF æŸ¥è¯¢å‡ºæ¥ BD é…ç½®çš„ class ä¸­ æ˜¯ Advisor å­ç±»çš„ BeanName advisors.add()ï¼šä½¿ç”¨ Spring å®¹å™¨è·å–å½“å‰è¿™ä¸ª Advisor ç±»å‹çš„å®ä¾‹ advisors.addAll(....buildAspectJAdvisors())ï¼šè·å–æ‰€æœ‰æ·»åŠ  @Aspect æ³¨è§£ç±»ä¸­çš„ Advisor buildAspectJAdvisors()ï¼šæ„å»ºçš„æ–¹æ³•ï¼ŒæŠŠ Advice å°è£…æˆ Advisor beanNames = BeanFactoryUtils.beanNamesForTypeIncludingAncestors(this.beanFactory, Object.class, true, false)ï¼šè·å–å‡ºå®¹å™¨å†… Object æ‰€æœ‰çš„ beanNameï¼Œå°±æ˜¯å…¨éƒ¨çš„ for (String beanName : beanNames)ï¼šéå†æ‰€æœ‰çš„ beanNameï¼Œåˆ¤æ–­æ¯ä¸ª beanName å¯¹åº”çš„ Class æ˜¯å¦æ˜¯ Aspect ç±»å‹ï¼Œå°±æ˜¯åŠ äº† @Aspect æ³¨è§£çš„ç±» factory = new BeanFactoryAspectInstanceFactory(this.beanFactory, beanName)ï¼šä½¿ç”¨å·¥å‚æ¨¡å¼ç®¡ç† Aspect çš„å…ƒæ•°æ®ï¼Œå…³è”çš„çœŸå® @Aspect æ³¨è§£çš„å®ä¾‹å¯¹è±¡ classAdvisors = this.advisorFactory.getAdvisors(factory)ï¼šæ·»åŠ äº† @Aspect æ³¨è§£çš„ç±»çš„é€šçŸ¥ä¿¡æ¯ aspectClassï¼š@Aspect æ ‡ç­¾çš„ç±»çš„ class for (Method method : getAdvisorMethods(aspectClass))ï¼šéå†ä¸åŒ…æ‹¬ @Pointcut æ³¨è§£çš„æ–¹æ³• Advisor advisor = getAdvisor(method, lazySingletonAspectInstanceFactory, advisors.size(), aspectName)ï¼šå°†å½“å‰ method åŒ…è£…æˆ Advisor æ•°æ® AspectJExpressionPointcut expressionPointcut = getPointcut()ï¼šè·å–åˆ‡ç‚¹è¡¨è¾¾å¼ return new InstantiationModelAwarePointcutAdvisorImpl()ï¼šæŠŠ method ä¸­ Advice åŒ…è£…æˆ Advisorï¼ŒSpring ä¸­æ¯ä¸ª Advisor å†…éƒ¨ä¸€å®šæ˜¯æŒæœ‰ä¸€ä¸ª Advice çš„ï¼ŒAdvice å†…éƒ¨æœ€é‡è¦çš„æ•°æ®æ˜¯å½“å‰ method å’ŒaspectInstanceFactoryï¼Œå·¥å‚ç”¨æ¥è·å–å®ä¾‹ this.instantiatedAdvice = instantiateAdvice(this.declaredPointcut)ï¼šå®ä¾‹åŒ– Advice å¯¹è±¡ï¼Œé€»è¾‘æ˜¯è·å–æ³¨è§£ä¿¡æ¯ï¼Œæ ¹æ®æ³¨è§£çš„ä¸åŒç”Ÿæˆå¯¹åº”çš„ Advice å¯¹è±¡ advisors.addAll(classAdvisors)ï¼šä¿å­˜é€šè¿‡ @Aspect æ³¨è§£å®šä¹‰çš„ Advisor æ•°æ® this.aspectBeanNames = aspectNamesï¼šå°†æ‰€æœ‰ @Aspect æ³¨è§£ beanName ç¼“å­˜èµ·æ¥ï¼Œè¡¨ç¤ºæå– Advisor å·¥ä½œå®Œæˆ return advisorsï¼šè¿”å› Advisor åˆ—è¡¨ eligibleAdvisors = findAdvisorsThatCanApply(candidateAdvisors, ...)ï¼šé€‰å‡ºåŒ¹é…å½“å‰ç±»çš„å¢å¼º if (candidateAdvisors.isEmpty())ï¼šæ¡ä»¶æˆç«‹è¯´æ˜å½“å‰ Spring æ²¡æœ‰å¯ä»¥æ“ä½œçš„ Advisor List&lt;Advisor&gt; eligibleAdvisors = new ArrayList&lt;&gt;()ï¼šå­˜æ”¾åŒ¹é…å½“å‰ beanClass çš„ Advisors ä¿¡æ¯ for (Advisor candidate : candidateAdvisors)ï¼šéå†æ‰€æœ‰çš„ Advisor if (canApply(candidate, clazz, hasIntroductions))ï¼šåˆ¤æ–­éå†çš„ advisor æ˜¯å¦åŒ¹é…å½“å‰çš„ classï¼ŒåŒ¹é…å°±åŠ å…¥é›†åˆ if (advisor instanceof PointcutAdvisor)ï¼šåˆ›å»ºçš„ advisor æ˜¯ InstantiationModelAwarePointcutAdvisorImpl ç±»å‹ PointcutAdvisor pca = (PointcutAdvisor) advisorï¼šå°è£…å½“å‰ Advisor return canApply(pca.getPointcut(), targetClass, hasIntroductions)ï¼šé‡è½½è¯¥æ–¹æ³• if (!pc.getClassFilter().matches(targetClass))ï¼šç±»ä¸åŒ¹é… Pointcut è¡¨è¾¾å¼ï¼Œç›´æ¥è¿”å› false methodMatcher = pc.getMethodMatcher()ï¼šè·å– Pointcut æ–¹æ³•åŒ¹é…å™¨ï¼Œç±»åŒ¹é…è¿›è¡Œç±»ä¸­æ–¹æ³•çš„åŒ¹é… Set&lt;Class&lt;?&gt;&gt; classesï¼šä¿å­˜ç›®æ ‡å¯¹è±¡ class å’Œç›®æ ‡å¯¹è±¡çˆ¶ç±»è¶…ç±»çš„æ¥å£å’Œè‡ªèº«å®ç°çš„æ¥å£ if (!Proxy.isProxyClass(targetClass))ï¼šåˆ¤æ–­å½“å‰å®ä¾‹æ˜¯ä¸æ˜¯ä»£ç†ç±»ï¼Œç¡®ä¿ class å†…å­˜å‚¨çš„æ•°æ®åŒ…æ‹¬ç›®æ ‡å¯¹è±¡çš„class è€Œä¸æ˜¯ä»£ç†ç±»çš„ class for (Class&lt;?&gt; clazz : classes)ï¼šæ£€æŸ¥ç›®æ ‡ class å’Œä¸Šçº§æ¥å£çš„æ‰€æœ‰æ–¹æ³•ï¼ŒæŸ¥çœ‹æ˜¯å¦ä¼šè¢«æ–¹æ³•åŒ¹é…å™¨åŒ¹é…ï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ–¹æ³•åŒ¹é…æˆåŠŸï¼Œå°±è¯´æ˜ç›®æ ‡å¯¹è±¡ AOP ä»£ç†éœ€è¦å¢å¼º specificMethod = AopUtils.getMostSpecificMethod(method, targetClass)ï¼šæ–¹æ³•å¯èƒ½æ˜¯æ¥å£çš„ï¼Œåˆ¤æ–­å½“å‰ç±»æœ‰æ²¡æœ‰è¯¥æ–¹æ³• return (specificMethod != method &amp;&amp; matchesMethod(specificMethod))ï¼šç±»å’Œæ–¹æ³•çš„åŒ¹é…ï¼Œä¸åŒ…æ‹¬å‚æ•° extendAdvisors(eligibleAdvisors)ï¼šåœ¨ eligibleAdvisors åˆ—è¡¨çš„ç´¢å¼• 0 çš„ä½ç½®æ·»åŠ  DefaultPointcutAdvisorï¼Œå°è£…äº† ExposeInvocationInterceptor æ‹¦æˆªå™¨ eligibleAdvisors = sortAdvisors(eligibleAdvisors)ï¼šå¯¹æ‹¦æˆªå™¨è¿›è¡Œæ’åºï¼Œæ•°å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼Œé«˜çš„æ’åœ¨å‰é¢ å®ç° Ordered æˆ– PriorityOrdered æ¥å£ï¼ŒPriorityOrdered çš„çº§åˆ«è¦ä¼˜å…ˆäº Orderedï¼Œä½¿ç”¨ OrderComparator æ¯”è¾ƒå™¨ ä½¿ç”¨ @Orderï¼ˆSpring è§„èŒƒï¼‰æˆ– @Priorityï¼ˆJDK è§„èŒƒï¼‰æ³¨è§£ï¼Œä½¿ç”¨ AnnotationAwareOrderComparator æ¯”è¾ƒå™¨ ExposeInvocationInterceptor å®ç°äº† PriorityOrdered ï¼Œæ‰€ä»¥æ€»æ˜¯æ’åœ¨ç¬¬ä¸€ä½ï¼ŒMethodBeforeAdviceInterceptor æ²¡å®ç°ä»»ä½•æ¥å£ï¼Œæ‰€ä»¥ä¼˜å…ˆçº§æœ€ä½ï¼Œæ’åœ¨æœ€å return eligibleAdvisorsï¼šè¿”å›æ‹¦æˆªå™¨é“¾ åˆ›å»ºä»£ç†AbstractAutoProxyCreator.createProxy()ï¼šæ ¹æ®å¢å¼ºæ–¹æ³•åˆ›å»ºä»£ç†å¯¹è±¡ ProxyFactory proxyFactory = new ProxyFactory()ï¼šæ— å‚æ„é€  ProxyFactoryï¼Œæ­¤å¤„è®²è§£ä¸€ä¸‹ä¸¤ç§æœ‰å‚æ„é€ æ–¹æ³•ï¼š public ProxyFactory(Object target)ï¼š 123456public ProxyFactory(Object target) &#123; // å°†ç›®æ ‡å¯¹è±¡å°è£…æˆ SingletonTargetSource ä¿å­˜åˆ°çˆ¶ç±»çš„å­—æ®µä¸­ setTarget(target); // è·å–ç›®æ ‡å¯¹è±¡ class æ‰€æœ‰æ¥å£ä¿å­˜åˆ° AdvisedSupport ä¸­çš„ interfaces é›†åˆä¸­ setInterfaces(ClassUtils.getAllInterfaces(target));&#125; ClassUtils.getAllInterfaces(target) åº•å±‚è°ƒç”¨ getAllInterfacesForClassAsSet(java.lang.Class&lt;?&gt;, java.lang.ClassLoader)ï¼š if (clazz.isInterface() &amp;&amp; isVisible(clazz, classLoader))ï¼š æ¡ä»¶ä¸€ï¼šåˆ¤æ–­å½“å‰ç›®æ ‡å¯¹è±¡æ˜¯æ¥å£ æ¡ä»¶äºŒï¼šæ£€æŸ¥ç»™å®šçš„ç±»åœ¨ç»™å®šçš„ ClassLoader ä¸­æ˜¯å¦å¯è§ Class&lt;?&gt;[] ifcs = current.getInterfaces()ï¼šæ‹¿åˆ°è‡ªå·±å®ç°çš„æ¥å£ï¼Œæ‹¿ä¸åˆ°æ¥å£å®ç°çš„æ¥å£ current = current.getSuperclass()ï¼šé€’å½’å¯»æ‰¾çˆ¶ç±»çš„æ¥å£ï¼Œå»è·å–çˆ¶ç±»å®ç°çš„æ¥å£ public ProxyFactory(Class&lt;?&gt; proxyInterface, Interceptor interceptor)ï¼š 123456public ProxyFactory(Class&lt;?&gt; proxyInterface, Interceptor interceptor) &#123; // æ·»åŠ ä¸€ä¸ªä»£ç†çš„æ¥å£ addInterface(proxyInterface); // æ·»åŠ é€šçŸ¥ï¼Œåº•å±‚è°ƒç”¨ addAdvisor addAdvice(interceptor);&#125; addAdvisor(pos, new DefaultPointcutAdvisor(advice))ï¼šSpring ä¸­ Advice å¯¹åº”çš„æ¥å£å°±æ˜¯ Advisorï¼ŒSpring ä½¿ç”¨ Advisor åŒ…è£… Advice å®ä¾‹ proxyFactory.copyFrom(this)ï¼šå¡«å……ä¸€äº›ä¿¡æ¯åˆ° proxyFactory if (!proxyFactory.isProxyTargetClass())ï¼šæ¡ä»¶æˆç«‹è¯´æ˜ proxyTargetClass ä¸º falseï¼ˆé»˜è®¤ï¼‰ï¼Œä¸¤ç§é…ç½®æ–¹æ³•ï¼š &lt;aop:aspectj-autoproxy proxy-target-class=&quot;true&quot;/&gt; ï¼šå¼ºåˆ¶ä½¿ç”¨ CGLIB @EnableAspectJAutoProxy(proxyTargetClass = true) if (shouldProxyTargetClass(beanClass, beanName))ï¼šå¦‚æœ bd å†…æœ‰ preserveTargetClass &#x3D; true ï¼Œé‚£ä¹ˆè¿™ä¸ª bd å¯¹åº”çš„ class åˆ›å»ºä»£ç†æ—¶å¿…é¡»ä½¿ç”¨ CGLIBï¼Œæ¡ä»¶æˆç«‹è®¾ç½® proxyTargetClass ä¸º true evaluateProxyInterfaces(beanClass, proxyFactory)ï¼šæ ¹æ®ç›®æ ‡ç±»åˆ¤å®šæ˜¯å¦å¯ä»¥ä½¿ç”¨ JDK åŠ¨æ€ä»£ç† targetInterfaces = ClassUtils.getAllInterfacesForClass()ï¼šè·å–å½“å‰ç›®æ ‡å¯¹è±¡ class å’Œçˆ¶ç±»çš„å…¨éƒ¨å®ç°æ¥å£ boolean hasReasonableProxyInterface = falseï¼šå®ç°çš„æ¥å£ä¸­æ˜¯å¦æœ‰ä¸€ä¸ªåˆç†çš„æ¥å£ if (!isConfigurationCallbackInterface(ifc) &amp;&amp; !isInternalLanguageInterface(ifc) &amp;&amp; ifc.getMethods().length &gt; 0)ï¼šéå†æ‰€æœ‰çš„æ¥å£ï¼Œå¦‚æœæœ‰ä»»æ„ä¸€ä¸ªæ¥å£æ»¡è¶³æ¡ä»¶ï¼Œè®¾ç½® hRPI å˜é‡ä¸º true æ¡ä»¶ä¸€ï¼šåˆ¤æ–­å½“å‰æ¥å£æ˜¯å¦æ˜¯ Spring ç”Ÿå‘½å‘¨æœŸå†…ä¼šå›è°ƒçš„æ¥å£ æ¡ä»¶äºŒï¼šæ¥å£ä¸èƒ½æ˜¯ GroovyObjectã€Factoryã€MockAccess ç±»å‹çš„ æ¡ä»¶ä¸‰ï¼šæ‰¾åˆ°ä¸€ä¸ªå¯ä»¥ä½¿ç”¨çš„è¢«ä»£ç†çš„æ¥å£ if (hasReasonableProxyInterface)ï¼šæœ‰åˆç†çš„æ¥å£ï¼Œå°†è¿™äº›æ¥å£è®¾ç½®åˆ° proxyFactory å†… proxyFactory.setProxyTargetClass(true)ï¼šæ²¡æœ‰åˆç†çš„ä»£ç†æ¥å£ï¼Œå¼ºåˆ¶ä½¿ç”¨ CGLIB åˆ›å»ºå¯¹è±¡ advisors = buildAdvisors(beanName, specificInterceptors)ï¼šåŒ¹é…ç›®æ ‡å¯¹è±¡ clazz çš„ Advisorsï¼Œå¡«å……è‡³ ProxyFactory proxyFactory.setPreFiltered(true)ï¼šè®¾ç½®ä¸º true è¡¨ç¤ºä¼ é€’ç»™ proxyFactory çš„ Advisors ä¿¡æ¯åšè¿‡åŸºç¡€ç±»å’Œæ–¹æ³•çš„åŒ¹é… return proxyFactory.getProxy(getProxyClassLoader())ï¼šåˆ›å»ºä»£ç†å¯¹è±¡ 123public Object getProxy() &#123; return createAopProxy().getProxy();&#125; DefaultAopProxyFactory.createAopProxy(AdvisedSupport config)ï¼šå‚æ•°æ˜¯ä¸€ä¸ªé…ç½®å¯¹è±¡ï¼Œä¿å­˜ç€åˆ›å»ºä»£ç†éœ€è¦çš„ç”Ÿäº§èµ„æ–™ï¼Œä¼šåŠ é”åˆ›å»ºï¼Œä¿è¯çº¿ç¨‹å®‰å…¨ 12345678910111213141516171819public AopProxy createAopProxy(AdvisedSupport config) throws AopConfigException &#123; // æ¡ä»¶äºŒä¸º true ä»£è¡¨å¼ºåˆ¶ä½¿ç”¨ CGLIB åŠ¨æ€ä»£ç† if (config.isOptimize() || config.isProxyTargetClass() || // æ¡ä»¶ä¸‰ï¼šè¢«ä»£ç†å¯¹è±¡æ²¡æœ‰å®ç°ä»»ä½•æ¥å£æˆ–è€…åªå®ç°äº† SpringProxy æ¥å£ï¼Œåªèƒ½ä½¿ç”¨ CGLIB åŠ¨æ€ä»£ç† hasNoUserSuppliedProxyInterfaces(config)) &#123; Class&lt;?&gt; targetClass = config.getTargetClass(); if (targetClass == null) &#123; throw new AopConfigException(&quot;&quot;); &#125; // æ¡ä»¶æˆç«‹è¯´æ˜ target ã€æ˜¯æ¥å£æˆ–è€…æ˜¯å·²ç»è¢«ä»£ç†è¿‡çš„ç±»å‹ã€‘ï¼Œåªèƒ½ä½¿ç”¨ JDK åŠ¨æ€ä»£ç† if (targetClass.isInterface() || Proxy.isProxyClass(targetClass)) &#123; return new JdkDynamicAopProxy(config); // ä½¿ç”¨ JDK åŠ¨æ€ä»£ç† &#125; return new ObjenesisCglibAopProxy(config); // ä½¿ç”¨ CGLIB åŠ¨æ€ä»£ç† &#125; else &#123; return new JdkDynamicAopProxy(config); // ã€æœ‰æ¥å£çš„æƒ…å†µä¸‹åªèƒ½ä½¿ç”¨ JDK åŠ¨æ€ä»£ç†ã€‘ &#125;&#125; JdkDynamicAopProxy.getProxy(java.lang.ClassLoader)ï¼šè·å– JDK çš„ä»£ç†å¯¹è±¡ 12345678910111213141516public JdkDynamicAopProxy(AdvisedSupport config) throws AopConfigException &#123; // é…ç½®ç±»å°è£…åˆ° JdkDynamicAopProxy.advised å±æ€§ä¸­ this.advised = config;&#125;public Object getProxy(@Nullable ClassLoader classLoader) &#123; // è·å–éœ€è¦ä»£ç†çš„æ¥å£æ•°ç»„ Class&lt;?&gt;[] proxiedInterfaces = AopProxyUtils.completeProxiedInterfaces(this.advised, true); // æŸ¥æ‰¾å½“å‰æ‰€æœ‰çš„éœ€è¦ä»£ç†çš„æ¥å£ï¼Œçœ‹æ˜¯å¦æœ‰ equals æ–¹æ³•å’Œ hashcode æ–¹æ³•ï¼Œå¦‚æœæœ‰å°±åšä¸€ä¸ªæ ‡è®° findDefinedEqualsAndHashCodeMethods(proxiedInterfaces); // è¯¥æ–¹æ³•æœ€ç»ˆè¿”å›ä¸€ä¸ªä»£ç†ç±»å¯¹è±¡ return Proxy.newProxyInstance(classLoader, proxiedInterfaces, this); // classLoaderï¼šç±»åŠ è½½å™¨ proxiedInterfacesï¼šç”Ÿæˆçš„ä»£ç†ç±»ï¼Œéœ€è¦å®ç°çš„æ¥å£é›†åˆ // this JdkDynamicAopProxy å®ç°äº† InvocationHandler&#125; AopProxyUtils.completeProxiedInterfaces(this.advised, true)ï¼šè·å–ä»£ç†çš„æ¥å£æ•°ç»„ï¼Œå¹¶æ·»åŠ  SpringProxy æ¥å£ specifiedInterfaces = advised.getProxiedInterfaces()ï¼šä» ProxyFactory ä¸­æ‹¿åˆ°æ‰€æœ‰çš„ target æå–å‡ºæ¥çš„æ¥å£ if (specifiedInterfaces.length == 0)ï¼šå¦‚æœæ²¡æœ‰å®ç°æ¥å£ï¼Œæ£€æŸ¥å½“å‰ target æ˜¯ä¸æ˜¯æ¥å£æˆ–è€…å·²ç»æ˜¯ä»£ç†ç±»ï¼Œå°è£…åˆ° ProxyFactory çš„ interfaces é›†åˆä¸­ addSpringProxy = !advised.isInterfaceProxied(SpringProxy.class)ï¼šåˆ¤æ–­ç›®æ ‡å¯¹è±¡æ‰€æœ‰æ¥å£ä¸­æ˜¯å¦æœ‰ SpringProxy æ¥å£ï¼Œæ²¡æœ‰çš„è¯éœ€è¦æ·»åŠ ï¼Œè¿™ä¸ªæ¥å£æ ‡è¯†è¿™ä¸ªä»£ç†ç±»å‹æ˜¯ Spring ç®¡ç†çš„ addAdvised = !advised.isOpaque() &amp;&amp; !advised.isInterfaceProxied(Advised.class)ï¼šåˆ¤æ–­ç›®æ ‡å¯¹è±¡çš„æ‰€æœ‰æ¥å£ï¼Œæ˜¯å¦å·²ç»æœ‰ Advised æ¥å£ addDecoratingProxy = (decoratingProxy &amp;&amp; !advised.isInterfaceProxied(DecoratingProxy.class))ï¼šåˆ¤æ–­ç›®æ ‡å¯¹è±¡çš„æ‰€æœ‰æ¥å£ï¼Œæ˜¯å¦å·²ç»æœ‰ DecoratingProxy æ¥å£ int nonUserIfcCount = 0ï¼šéç”¨æˆ·è‡ªå®šä¹‰çš„æ¥å£æ•°é‡ï¼Œæ¥ä¸‹æ¥è¦æ·»åŠ ä¸Šé¢çš„ä¸‰ä¸ªæ¥å£äº† proxiedInterfaces = new Class&lt;?&gt;[specifiedInterfaces.length + nonUserIfcCount]ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ class æ•°ç»„ï¼Œé•¿åº¦æ˜¯åŸç›®æ ‡å¯¹è±¡æå–å‡ºæ¥çš„æ¥å£æ•°é‡å’Œ Spring è¿½åŠ çš„æ•°é‡ï¼Œç„¶åè¿›è¡Œ System.arraycopy æ‹·è´åˆ°æ–°æ•°ç»„ä¸­ int index = specifiedInterfaces.lengthï¼šè·å–åŸç›®æ ‡å¯¹è±¡æå–å‡ºæ¥çš„æ¥å£æ•°é‡ï¼Œå½“ä½œ index if(addSpringProxy)ï¼šæ ¹æ®ä¸Šé¢ä¸‰ä¸ªå¸ƒå°”å€¼æŠŠæ¥å£æ·»åŠ åˆ°æ–°æ•°ç»„ä¸­ return proxiedInterfacesï¼šè¿”å›è¿½åŠ åçš„æ¥å£é›†åˆ JdkDynamicAopProxy.findDefinedEqualsAndHashCodeMethods()ï¼šæŸ¥æ‰¾åœ¨ä»»ä½•å®šä¹‰åœ¨æ¥å£ä¸­çš„ equals å’Œ hashCode æ–¹æ³• for (Class&lt;?&gt; proxiedInterface : proxiedInterfaces)ï¼šéå†æ‰€æœ‰çš„æ¥å£ Method[] methods = proxiedInterface.getDeclaredMethods()ï¼šè·å–æ¥å£ä¸­çš„æ‰€æœ‰æ–¹æ³• for (Method method : methods)ï¼šéå†æ‰€æœ‰çš„æ–¹æ³• if (AopUtils.isEqualsMethod(method))ï¼šå½“å‰æ–¹æ³•æ˜¯ equals æ–¹æ³•ï¼ŒæŠŠ equalsDefined ç½®ä¸º true if (AopUtils.isHashCodeMethod(method))ï¼šå½“å‰æ–¹æ³•æ˜¯ hashCode æ–¹æ³•ï¼ŒæŠŠ hashCodeDefined ç½®ä¸º true if (this.equalsDefined &amp;&amp; this.hashCodeDefined)ï¼šå¦‚æœæœ‰ä¸€ä¸ªæ¥å£ä¸­æœ‰è¿™ä¸¤ç§æ–¹æ³•ï¼Œç›´æ¥è¿”å› æ–¹æ³•å¢å¼ºmain() å‡½æ•°ä¸­è°ƒç”¨ç”¨æˆ·æ–¹æ³•ï¼Œä¼šè¿›å…¥ä»£ç†å¯¹è±¡çš„ invoke æ–¹æ³• JdkDynamicAopProxy ç±»ä¸­çš„ invoke æ–¹æ³•æ˜¯çœŸæ­£æ‰§è¡Œä»£ç†æ–¹æ³• 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566// proxyï¼šä»£ç†å¯¹è±¡ï¼Œmethodï¼šç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ï¼Œargsï¼šç›®æ ‡å¯¹è±¡æ–¹æ³•å¯¹åº”çš„å‚æ•°public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; Object oldProxy = null; boolean setProxyContext = false; // advised å°±æ˜¯åˆå§‹åŒ– JdkDynamicAopProxy å¯¹è±¡æ—¶ä¼ å…¥çš„å˜é‡ TargetSource targetSource = this.advised.targetSource; Object target = null; try &#123; // æ¡ä»¶æˆç«‹è¯´æ˜ä»£ç†ç±»å®ç°çš„æ¥å£æ²¡æœ‰å®šä¹‰ equals æ–¹æ³•ï¼Œå¹¶ä¸”å½“å‰ method è°ƒç”¨ equals æ–¹æ³•ï¼Œ // å°±è°ƒç”¨ JdkDynamicAopProxy æä¾›çš„ equals æ–¹æ³• if (!this.equalsDefined &amp;&amp; AopUtils.isEqualsMethod(method)) &#123; return equals(args[0]); &#125; //..... Object retVal; // éœ€ä¸éœ€è¦æš´éœ²å½“å‰ä»£ç†å¯¹è±¡åˆ° AOP ä¸Šä¸‹æ–‡å†… if (this.advised.exposeProxy) &#123; // ã€æŠŠä»£ç†å¯¹è±¡è®¾ç½®åˆ°ä¸Šä¸‹æ–‡ç¯å¢ƒã€‘ oldProxy = AopContext.setCurrentProxy(proxy); setProxyContext = true; &#125; // æ ¹æ® targetSource è·å–çœŸæ­£çš„ä»£ç†å¯¹è±¡ target = targetSource.getTarget(); Class&lt;?&gt; targetClass = (target != null ? target.getClass() : null); // æŸ¥æ‰¾ã€é€‚åˆè¯¥æ–¹æ³•çš„å¢å¼ºã€‘ï¼Œé¦–å…ˆä»ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼ŒæŸ¥æ‰¾ä¸åˆ°è¿›å…¥ä¸»æ–¹æ³•ã€ä¸‹æ–‡è¯¦è§£ã€‘ List&lt;Object&gt; chain = this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass); // æ‹¦æˆªå™¨é“¾æ˜¯ç©ºï¼Œè¯´æ˜å½“å‰ method ä¸éœ€è¦è¢«å¢å¼º if (chain.isEmpty()) &#123; Object[] argsToUse = AopProxyUtils.adaptArgumentsIfNecessary(method, args); retVal = AopUtils.invokeJoinpointUsingReflection(target, method, argsToUse); &#125; else &#123; // æœ‰åŒ¹é…å½“å‰ method çš„æ–¹æ³•æ‹¦æˆªå™¨ï¼Œè¦åšå¢å¼ºå¤„ç†ï¼ŒæŠŠæ–¹æ³•ä¿¡æ¯å°è£…åˆ°æ–¹æ³•è°ƒç”¨å™¨é‡Œ MethodInvocation invocation = new ReflectiveMethodInvocation(proxy, target, method, args, targetClass, chain); // ã€æ‹¦æˆªå™¨é“¾é©±åŠ¨æ–¹æ³•ï¼Œæ ¸å¿ƒã€‘ retVal = invocation.proceed(); &#125; Class&lt;?&gt; returnType = method.getReturnType(); if (retVal != null &amp;&amp; retVal == target &amp;&amp; returnType != Object.class &amp;&amp; returnType.isInstance(proxy) &amp;&amp; !RawTargetAccess.class.isAssignableFrom(method.getDeclaringClass())) &#123; // å¦‚æœç›®æ ‡æ–¹æ³•è¿”å›ç›®æ ‡å¯¹è±¡ï¼Œè¿™é‡Œåšä¸ªæ™®é€šæ›¿æ¢è¿”å›ä»£ç†å¯¹è±¡ retVal = proxy; &#125; // è¿”å›æ‰§è¡Œçš„ç»“æœ return retVal; &#125; finally &#123; if (target != null &amp;&amp; !targetSource.isStatic()) &#123; targetSource.releaseTarget(target); &#125; // å¦‚æœå…è®¸äº†æå‰æš´éœ²ï¼Œè¿™é‡Œéœ€è¦è®¾ç½®ä¸ºåˆå§‹çŠ¶æ€ if (setProxyContext) &#123; // å½“å‰ä»£ç†å¯¹è±¡å·²ç»å®Œæˆå·¥ä½œï¼Œã€æŠŠåŸå§‹å¯¹è±¡è®¾ç½®å›ä¸Šä¸‹æ–‡ã€‘ AopContext.setCurrentProxy(oldProxy); &#125; &#125;&#125; this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass)ï¼šæŸ¥æ‰¾é€‚åˆè¯¥æ–¹æ³•çš„å¢å¼ºï¼Œé¦–å…ˆä»ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œè·å–é€šçŸ¥æ—¶æ˜¯ä»å…¨éƒ¨å¢å¼ºä¸­è·å–é€‚åˆå½“å‰ç±»çš„ï¼Œè¿™é‡Œæ˜¯ä»å½“å‰ç±»çš„ä¸­è·å–é€‚åˆå½“å‰æ–¹æ³•çš„å¢å¼º AdvisorAdapterRegistry registry = GlobalAdvisorAdapterRegistry.getInstance()ï¼šå‘å®¹å™¨æ³¨å†Œé€‚é…å™¨ï¼Œå¯ä»¥å°†é Advisor ç±»å‹çš„å¢å¼ºï¼ŒåŒ…è£…æˆä¸º Advisorï¼Œå°† Advisor ç±»å‹çš„å¢å¼ºæå–å‡ºæ¥å¯¹åº”çš„ MethodInterceptor instance = new DefaultAdvisorAdapterRegistry()ï¼šè¯¥å¯¹è±¡å‘å®¹å™¨ä¸­æ³¨å†Œäº† MethodBeforeAdviceAdapterã€AfterReturningAdviceAdapterã€ThrowsAdviceAdapter ä¸‰ä¸ªé€‚é…å™¨ Advisor ä¸­æŒæœ‰ Advice å¯¹è±¡ 123public interface Advisor &#123; Advice getAdvice();&#125; advisors = config.getAdvisors()ï¼šè·å– ProxyFactory å†…éƒ¨æŒæœ‰çš„å¢å¼ºä¿¡æ¯ interceptorList = new ArrayList&lt;&gt;(advisors.length)ï¼šæ‹¦æˆªå™¨åˆ—è¡¨æœ‰ 5 ä¸ªï¼Œ1 ä¸ª ExposeInvocationå’Œ 4 ä¸ªå¢å¼ºå™¨ actualClass = (targetClass != null ? targetClass : method.getDeclaringClass())ï¼šçœŸå®çš„ç›®æ ‡å¯¹è±¡ç±»å‹ Boolean hasIntroductions = nullï¼šå¼•ä»‹å¢å¼ºï¼Œä¸å…³å¿ƒ for (Advisor advisor : advisors)ï¼šéå†æ‰€æœ‰çš„ advisor å¢å¼º if (advisor instanceof PointcutAdvisor)ï¼šæ¡ä»¶æˆç«‹è¯´æ˜å½“å‰ Advisor æ˜¯åŒ…å«åˆ‡ç‚¹ä¿¡æ¯çš„ï¼Œè¿›å…¥åŒ¹é…é€»è¾‘ pointcutAdvisor = (PointcutAdvisor) advisorï¼šè½¬æˆå¯ä»¥è·å–åˆ°åˆ‡ç‚¹ä¿¡æ¯çš„æ¥å£ if(config.isPreFiltered() || pointcutAdvisor.getPointcut().getClassFilter().matches(actualClass))ï¼šå½“å‰ä»£ç†è¢«é¢„å¤„ç†ï¼Œæˆ–è€…å½“å‰è¢«ä»£ç†çš„ class å¯¹è±¡åŒ¹é…å½“å‰ Advisor æˆåŠŸï¼Œåªæ˜¯ class åŒ¹é…æˆåŠŸ mm = pointcutAdvisor.getPointcut().getMethodMatcher()ï¼šè·å–åˆ‡ç‚¹çš„æ–¹æ³•åŒ¹é…å™¨ï¼Œä¸è€ƒè™‘å¼•ä»‹å¢å¼º match = mm.matches(method, actualClass)ï¼šé™æ€åŒ¹é…æˆåŠŸè¿”å› trueï¼Œåªå…³æ³¨äºå¤„ç†ç±»åŠå…¶æ–¹æ³•ï¼Œä¸è€ƒè™‘å‚æ•° if (match)ï¼šå¦‚æœé™æ€åˆ‡ç‚¹æ£€æŸ¥æ˜¯åŒ¹é…çš„ï¼Œåœ¨è¿è¡Œçš„æ—¶å€™æ‰è¿›è¡ŒåŠ¨æ€åˆ‡ç‚¹æ£€æŸ¥ï¼Œä¼šè€ƒè™‘å‚æ•°åŒ¹é…ï¼ˆä»£è¡¨ä¼ å…¥äº†å‚æ•°ï¼‰ã€‚å¦‚æœé™æ€åŒ¹é…å¤±è´¥ï¼Œç›´æ¥ä¸éœ€è¦è¿›è¡Œå‚æ•°åŒ¹é…ï¼Œæé«˜äº†å·¥ä½œæ•ˆç‡ interceptors = registry.getInterceptors(advisor)ï¼šæå–å‡ºå½“å‰ advisor å†…æŒæœ‰çš„ advice ä¿¡æ¯ Advice advice = advisor.getAdvice()ï¼šè·å–å¢å¼ºæ–¹æ³• if (advice instanceof MethodInterceptor)ï¼šå½“å‰ advice æ˜¯ MethodInterceptor ç›´æ¥åŠ å…¥é›†åˆ for (AdvisorAdapter adapter : this.adapters)ï¼šéå†ä¸‰ä¸ªé€‚é…å™¨è¿›è¡ŒåŒ¹é…ï¼ˆåˆå§‹åŒ–æ—¶åˆ›å»ºçš„ï¼‰ï¼ŒåŒ¹é…æˆåŠŸåˆ›å»ºå¯¹åº”çš„æ‹¦æˆªå™¨è¿”å›ï¼Œä»¥ MethodBeforeAdviceAdapter ä¸ºä¾‹ if (adapter.supportsAdvice(advice))ï¼šåˆ¤æ–­å½“å‰ advice æ˜¯å¦æ˜¯å¯¹åº”çš„ MethodBeforeAdvice interceptors.add(adapter.getInterceptor(advisor))ï¼šæ¡ä»¶æˆç«‹å°±å¾€æ‹¦æˆªå™¨é“¾ä¸­æ·»åŠ  advisor advice = (MethodBeforeAdvice) advisor.getAdvice()ï¼šè·å–å¢å¼ºæ–¹æ³• return new MethodBeforeAdviceInterceptor(advice)ï¼šå°è£…æˆ MethodBeforeAdviceInterceptor è¿”å› interceptorList.add(new InterceptorAndDynamicMethodMatcher(interceptor, mm))ï¼šå‘æ‹¦æˆªå™¨é“¾æ·»åŠ åŠ¨æ€åŒ¹é…å™¨ interceptorList.addAll(Arrays.asList(interceptors))ï¼šå°†å½“å‰ advisor å†…éƒ¨çš„æ–¹æ³•æ‹¦æˆªå™¨è¿½åŠ åˆ° interceptorList interceptors = registry.getInterceptors(advisor)ï¼šè¿›å…¥ else çš„é€»è¾‘ï¼Œè¯´æ˜å½“å‰ Advisor åŒ¹é…å…¨éƒ¨ class çš„å…¨éƒ¨ methodï¼Œå…¨éƒ¨åŠ å…¥åˆ° interceptorList return interceptorListï¼šè¿”å› method æ–¹æ³•çš„æ‹¦æˆªå™¨é“¾ retVal &#x3D; invocation.proceed()ï¼šæ‹¦æˆªå™¨é“¾é©±åŠ¨æ–¹æ³• if (this.currentInterceptorIndex == this.interceptorsAndDynamicMethodMatchers.size() - 1)ï¼šæ¡ä»¶æˆç«‹è¯´æ˜æ–¹æ³•æ‹¦æˆªå™¨å…¨éƒ¨éƒ½å·²ç»è°ƒç”¨è¿‡äº†ï¼ˆindex ä» - 1 å¼€å§‹ç´¯åŠ ï¼‰ï¼Œæ¥ä¸‹æ¥éœ€è¦æ‰§è¡Œç›®æ ‡å¯¹è±¡çš„ç›®æ ‡æ–¹æ³• return invokeJoinpoint()ï¼šè°ƒç”¨è¿æ¥ç‚¹ï¼ˆç›®æ ‡ï¼‰æ–¹æ³• this.interceptorsAndDynamicMethodMatchers.get(++this.currentInterceptorIndex)ï¼šè·å–ä¸‹ä¸€ä¸ªæ–¹æ³•æ‹¦æˆªå™¨ if (interceptorOrInterceptionAdvice instanceof InterceptorAndDynamicMethodMatcher)ï¼šéœ€è¦è¿è¡Œæ—¶åŒ¹é… if (dm.methodMatcher.matches(this.method, targetClass, this.arguments))ï¼šåˆ¤æ–­æ˜¯å¦åŒ¹é…æˆåŠŸ return dm.interceptor.invoke(this)ï¼šåŒ¹é…æˆåŠŸï¼Œæ‰§è¡Œæ–¹æ³• return proceed()ï¼šåŒ¹é…å¤±è´¥è·³è¿‡å½“å‰æ‹¦æˆªå™¨ return ((MethodInterceptor) interceptorOrInterceptionAdvice).invoke(this)ï¼šä¸€èˆ¬æ–¹æ³•æ‹¦æˆªå™¨éƒ½ä¼šæ‰§è¡Œåˆ°è¯¥æ–¹æ³•ï¼Œæ­¤æ–¹æ³•å†…ç»§ç»­æ‰§è¡Œ proceed() å®Œæˆè´£ä»»é“¾çš„é©±åŠ¨ï¼Œç›´åˆ°æœ€åä¸€ä¸ª MethodBeforeAdviceInterceptor è°ƒç”¨å‰ç½®é€šçŸ¥ï¼Œç„¶åè°ƒç”¨ mi.proceed()ï¼Œå‘ç°æ˜¯æœ€åä¸€ä¸ªæ‹¦æˆªå™¨å°±ç›´æ¥æ‰§è¡Œè¿æ¥ç‚¹ï¼ˆç›®æ ‡æ–¹æ³•ï¼‰ï¼Œreturn åˆ°ä¸Šä¸€ä¸ªæ‹¦æˆªå™¨çš„ mi.proceed() å¤„ï¼Œä¾æ¬¡è¿”å›åˆ°è´£ä»»é“¾çš„ä¸Šä¸€ä¸ªæ‹¦æˆªå™¨æ‰§è¡Œé€šçŸ¥æ–¹æ³• å›¾ç¤ºå…ˆä»ä¸Šå¾€ä¸‹å»ºç«‹é“¾ï¼Œç„¶åä»ä¸‹å¾€ä¸Šä¾æ¬¡æ‰§è¡Œï¼Œè´£ä»»é“¾æ¨¡å¼ æ­£å¸¸æ‰§è¡Œï¼šï¼ˆç¯ç»•é€šçŸ¥ï¼‰â†’ å‰ç½®é€šçŸ¥ â†’ ç›®æ ‡æ–¹æ³• â†’ åç½®é€šçŸ¥ â†’ è¿”å›é€šçŸ¥ å‡ºç°å¼‚å¸¸ï¼šï¼ˆç¯ç»•é€šçŸ¥ï¼‰â†’ å‰ç½®é€šçŸ¥ â†’ ç›®æ ‡æ–¹æ³• â†’ åç½®é€šçŸ¥ â†’ å¼‚å¸¸é€šçŸ¥ MethodBeforeAdviceInterceptor æºç ï¼š 123456public Object invoke(MethodInvocation mi) throws Throwable &#123; // å…ˆæ‰§è¡Œé€šçŸ¥æ–¹æ³•ï¼Œå†é©±åŠ¨è´£ä»»é“¾ this.advice.before(mi.getMethod(), mi.getArguments(), mi.getThis()); // å¼€å§‹é©±åŠ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œï¼Œæ‰§è¡Œå®Œåè¿”å›åˆ°è¿™ï¼Œç„¶åç»§ç»­å‘ä¸Šå±‚è¿”å› return mi.proceed();&#125; AfterReturningAdviceInterceptor æºç ï¼šæ²¡æœ‰ä»»ä½•å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œç›´æ¥æŠ›ç»™ä¸Šå±‚ 123456public Object invoke(MethodInvocation mi) throws Throwable &#123; // å…ˆé©±åŠ¨è´£ä»»é“¾ï¼Œå†æ‰§è¡Œé€šçŸ¥æ–¹æ³• Object retVal = mi.proceed(); this.advice.afterReturning(retVal, mi.getMethod(), mi.getArguments(), mi.getThis()); return retVal;&#125; AspectJAfterThrowingAdvice æ‰§è¡Œå¼‚å¸¸å¤„ç†ï¼š 12345678910111213public Object invoke(MethodInvocation mi) throws Throwable &#123; try &#123; // é»˜è®¤ç›´æ¥é©±åŠ¨è´£ä»»é“¾ return mi.proceed(); &#125; catch (Throwable ex) &#123; // å‡ºç°é”™è¯¯æ‰æ‰§è¡Œè¯¥æ–¹æ³• if (shouldInvokeOnThrowing(ex)) &#123; invokeAdviceMethod(getJoinPointMatch(), null, ex); &#125; throw ex; &#125;&#125; å‚è€ƒè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV1gW411W7wy äº‹åŠ¡è§£ææ–¹æ³•æ ‡ç­¾è§£æ1&lt;tx:annotation-driven transaction-manager=&quot;txManager&quot;/&gt; å®¹å™¨å¯åŠ¨æ—¶ä¼šæ ¹æ®æ³¨è§£æ³¨å†Œå¯¹åº”çš„è§£æå™¨ï¼š 1234567891011public class TxNamespaceHandler extends NamespaceHandlerSupport &#123; public void init() &#123; registerBeanDefinitionParser(&quot;advice&quot;, new TxAdviceBeanDefinitionParser()); // æ³¨å†Œè§£æå™¨ registerBeanDefinitionParser(&quot;annotation-driven&quot;, new AnnotationDrivenBeanDefinitionParser()); registerBeanDefinitionParser(&quot;jta-transaction-manager&quot;, new JtaTransactionManagerBeanDefinitionParser()); &#125;&#125;protected final void registerBeanDefinitionParser(String elementName, BeanDefinitionParser parser) &#123; this.parsers.put(elementName, parser);&#125; è·å–å¯¹åº”çš„è§£æå™¨ NamespaceHandlerSupport#findParserForElementï¼š 1234567private BeanDefinitionParser findParserForElement(Element element, ParserContext parserContext) &#123; String localName = parserContext.getDelegate().getLocalName(element); // è·å–å¯¹åº”çš„è§£æå™¨ BeanDefinitionParser parser = this.parsers.get(localName); // ... return parser;&#125; è°ƒç”¨è§£æå™¨çš„æ–¹æ³•å¯¹ XML æ–‡ä»¶è¿›è¡Œè§£æï¼š 123456789101112131415161718public BeanDefinition parse(Element element, ParserContext parserContext) &#123; // å‘Springå®¹å™¨æ³¨å†Œäº†ä¸€ä¸ª BD -&gt; TransactionalEventListenerFactory.class registerTransactionalEventListenerFactory(parserContext); String mode = element.getAttribute(&quot;mode&quot;); if (&quot;aspectj&quot;.equals(mode)) &#123; // mode=&quot;aspectj&quot; registerTransactionAspect(element, parserContext); if (ClassUtils.isPresent(&quot;javax.transaction.Transactional&quot;, getClass().getClassLoader())) &#123; registerJtaTransactionAspect(element, parserContext); &#125; &#125; else &#123; // mode=&quot;proxy&quot;ï¼Œé»˜è®¤é€»è¾‘ï¼Œä¸é…ç½® mode æ—¶ // ç”¨æ¥å‘å®¹å™¨ä¸­æ³¨å…¥ä¸€äº› BeanDefinitionï¼ŒåŒ…æ‹¬äº‹åŠ¡å¢å¼ºå™¨ã€äº‹åŠ¡æ‹¦æˆªå™¨ã€æ³¨è§£è§£æå™¨ AopAutoProxyConfigurer.configureAutoProxyCreator(element, parserContext); &#125; return null;&#125; æ³¨è§£è§£æ@EnableTransactionManagement å¯¼å…¥ TransactionManagementConfigurationSelectorï¼Œè¯¥ç±»ç»™ Spring å®¹å™¨ä¸­ä¸¤ä¸ªç»„ä»¶ï¼š 12345678910111213protected String[] selectImports(AdviceMode adviceMode) &#123; switch (adviceMode) &#123; // å¯¼å…¥ AutoProxyRegistrar å’Œ ProxyTransactionManagementConfigurationï¼ˆé»˜è®¤ï¼‰ case PROXY: return new String[] &#123;AutoProxyRegistrar.class.getName(), ProxyTransactionManagementConfiguration.class.getName()&#125;; // å¯¼å…¥ AspectJTransactionManagementConfigurationï¼ˆä¸å£°æ˜å¼äº‹åŠ¡æ— å…³ï¼‰ case ASPECTJ: return new String[] &#123;determineTransactionAspectClass()&#125;; default: return null; &#125;&#125; AutoProxyRegistrarï¼šç»™å®¹å™¨ä¸­æ³¨å†Œ InfrastructureAdvisorAutoProxyCreatorï¼Œåˆ©ç”¨åç½®å¤„ç†å™¨æœºåˆ¶æ‹¦æˆª bean ä»¥ååŒ…è£…å¹¶è¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œä»£ç†å¯¹è±¡ä¸­ä¿å­˜æ‰€æœ‰çš„æ‹¦æˆªå™¨ï¼Œåˆ©ç”¨æ‹¦æˆªå™¨çš„é“¾å¼æœºåˆ¶ä¾æ¬¡è¿›å…¥æ¯ä¸€ä¸ªæ‹¦æˆªå™¨ä¸­è¿›è¡Œæ‹¦æˆªæ‰§è¡Œï¼ˆå°±æ˜¯ AOP åŸç†ï¼‰ ProxyTransactionManagementConfigurationï¼šæ˜¯ä¸€ä¸ª Spring çš„äº‹åŠ¡é…ç½®ç±»ï¼Œæ³¨å†Œäº†ä¸‰ä¸ª Beanï¼š BeanFactoryTransactionAttributeSourceAdvisorï¼šäº‹åŠ¡é©±åŠ¨ï¼Œåˆ©ç”¨æ³¨è§£ @Bean æŠŠè¯¥ç±»æ³¨å…¥åˆ°å®¹å™¨ä¸­ï¼Œè¯¥å¢å¼ºå™¨æœ‰ä¸¤ä¸ªå­—æ®µï¼š TransactionAttributeSourceï¼šè§£æäº‹åŠ¡æ³¨è§£çš„ç›¸å…³ä¿¡æ¯ï¼ŒçœŸå®ç±»å‹æ˜¯ AnnotationTransactionAttributeSourceï¼Œæ„é€ æ–¹æ³•ä¸­æ³¨å†Œäº†ä¸‰ä¸ªæ³¨è§£è§£æå™¨ï¼Œè§£æ Springã€JTAã€Ejb3 ä¸‰ç§ç±»å‹çš„äº‹åŠ¡æ³¨è§£ TransactionInterceptorï¼šäº‹åŠ¡æ‹¦æˆªå™¨ï¼Œä»£ç†å¯¹è±¡æ‰§è¡Œæ‹¦æˆªå™¨æ–¹æ³•æ—¶ï¼Œè°ƒç”¨ TransactionInterceptor çš„ invoke æ–¹æ³•ï¼Œåº•å±‚è°ƒç”¨TransactionAspectSupport.invokeWithinTransaction()ï¼Œé€šè¿‡ PlatformTransactionManager æ§åˆ¶ç€äº‹åŠ¡çš„æäº¤å’Œå›æ»šï¼Œæ‰€ä»¥äº‹åŠ¡çš„åº•å±‚åŸç†å°±æ˜¯é€šè¿‡ AOP åŠ¨æ€ç»‡å…¥ï¼Œè¿›è¡Œäº‹åŠ¡å¼€å¯å’Œæäº¤ æ³¨è§£è§£æå™¨ SpringTransactionAnnotationParser è§£æ @Transactional æ³¨è§£ï¼š 1234567891011121314151617181920212223242526272829303132333435protected TransactionAttribute parseTransactionAnnotation(AnnotationAttributes attributes) &#123; RuleBasedTransactionAttribute rbta = new RuleBasedTransactionAttribute(); // ä»æ³¨è§£ä¿¡æ¯ä¸­è·å–ä¼ æ’­è¡Œä¸º Propagation propagation = attributes.getEnum(&quot;propagation&quot;); rbta.setPropagationBehavior(propagation.value()); // è·å–éš”ç¦»ç•Œåˆ« Isolation isolation = attributes.getEnum(&quot;isolation&quot;); rbta.setIsolationLevel(isolation.value()); rbta.setTimeout(attributes.getNumber(&quot;timeout&quot;).intValue()); // ä»æ³¨è§£ä¿¡æ¯ä¸­è·å– readOnly å‚æ•° rbta.setReadOnly(attributes.getBoolean(&quot;readOnly&quot;)); // ä»æ³¨è§£ä¿¡æ¯ä¸­è·å– value ä¿¡æ¯å¹¶ä¸”è®¾ç½® qualifierï¼Œè¡¨ç¤ºå½“å‰äº‹åŠ¡æŒ‡å®šä½¿ç”¨çš„ã€äº‹åŠ¡ç®¡ç†å™¨ã€‘ rbta.setQualifier(attributes.getString(&quot;value&quot;)); // ã€å­˜æ”¾çš„æ˜¯ rollback æ¡ä»¶ã€‘ï¼Œå›æ»šè§„åˆ™æ”¾åœ¨è¿™ä¸ªé›†åˆ List&lt;RollbackRuleAttribute&gt; rollbackRules = new ArrayList&lt;&gt;(); // è¡¨ç¤ºäº‹åŠ¡ç¢°åˆ°å“ªäº›æŒ‡å®šçš„å¼‚å¸¸æ‰è¿›è¡Œå›æ»šï¼Œä¸æŒ‡å®šçš„è¯é»˜è®¤æ˜¯ RuntimeException/Error éæ£€æŸ¥å‹å¼‚å¸¸èœå›æ»š for (Class&lt;?&gt; rbRule : attributes.getClassArray(&quot;rollbackFor&quot;)) &#123; rollbackRules.add(new RollbackRuleAttribute(rbRule)); &#125; // ä¸ rollbackFor åŠŸèƒ½ç›¸åŒ for (String rbRule : attributes.getStringArray(&quot;rollbackForClassName&quot;)) &#123; rollbackRules.add(new RollbackRuleAttribute(rbRule)); &#125; // è¡¨ç¤ºäº‹åŠ¡ç¢°åˆ°æŒ‡å®šçš„ exception å®ç°å¯¹è±¡ä¸è¿›è¡Œå›æ»šï¼Œå¦åˆ™ç¢°åˆ°å…¶ä»–çš„classå°±è¿›è¡Œå›æ»š for (Class&lt;?&gt; rbRule : attributes.getClassArray(&quot;noRollbackFor&quot;)) &#123; rollbackRules.add(new NoRollbackRuleAttribute(rbRule)); &#125; for (String rbRule : attributes.getStringArray(&quot;noRollbackForClassName&quot;)) &#123; rollbackRules.add(new NoRollbackRuleAttribute(rbRule)); &#125; // è®¾ç½®å›æ»šè§„åˆ™ rbta.setRollbackRules(rollbackRules); return rbta;&#125; é©±åŠ¨æ–¹æ³•TransactionInterceptor äº‹åŠ¡æ‹¦æˆªå™¨çš„æ ¸å¿ƒé©±åŠ¨æ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748public Object invoke(MethodInvocation invocation) throws Throwable &#123; // targetClass æ˜¯éœ€è¦è¢«äº‹åŠ¡å¢å¼ºå™¨å¢å¼ºçš„ç›®æ ‡ç±»ï¼Œinvocation.getThis() â†’ ç›®æ ‡å¯¹è±¡ â†’ ç›®æ ‡ç±» Class&lt;?&gt; targetClass = (invocation.getThis() != null ? AopUtils.getTargetClass(invocation.getThis()) : null); // å‚æ•°ä¸€æ˜¯ç›®æ ‡æ–¹æ³•ï¼Œå‚æ•°äºŒæ˜¯ç›®æ ‡ç±»ï¼Œå‚æ•°ä¸‰æ˜¯æ–¹æ³•å¼•ç”¨ï¼Œç”¨æ¥è§¦å‘é©±åŠ¨æ–¹æ³• return invokeWithinTransaction(invocation.getMethod(), targetClass, invocation::proceed);&#125;protected Object invokeWithinTransaction(Method method, @Nullable Class&lt;?&gt; targetClass, final InvocationCallback invocation) throws Throwable &#123; // äº‹åŠ¡å±æ€§æºä¿¡æ¯ TransactionAttributeSource tas = getTransactionAttributeSource(); // æå– @Transactional æ³¨è§£ä¿¡æ¯ï¼ŒtxAttr æ˜¯æ³¨è§£ä¿¡æ¯çš„æ‰¿è½½å¯¹è±¡ final TransactionAttribute txAttr = (tas != null ? tas.getTransactionAttribute(method, targetClass) : null); // è·å– Spring é…ç½®çš„äº‹åŠ¡ç®¡ç†å™¨ // é¦–å…ˆä¼šæ£€æŸ¥æ˜¯å¦é€šè¿‡XMLæˆ–æ³¨è§£é…ç½® qualifierï¼Œæ²¡æœ‰å°±å°è¯•å»å®¹å™¨è·å–ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸º DatasourceTransactionManager final PlatformTransactionManager tm = determineTransactionManager(txAttr); // æƒé™å®šç±»å.æ–¹æ³•åï¼Œè¯¥å€¼ç”¨æ¥å½“åšäº‹åŠ¡åç§°ä½¿ç”¨ final String joinpointIdentification = methodIdentification(method, targetClass, txAttr); // æ¡ä»¶æˆç«‹è¯´æ˜æ˜¯ã€å£°æ˜å¼äº‹åŠ¡ã€‘ if (txAttr == null || !(tm instanceof CallbackPreferringPlatformTransactionManager)) &#123; // ç”¨æ¥ã€å¼€å¯äº‹åŠ¡ã€‘ TransactionInfo txInfo = createTransactionIfNecessary(tm, txAttr, joinpointIdentification); Object retVal; try &#123; // This is an ã€around adviceã€‘: Invoke the next interceptor in the chain. // ç¯ç»•é€šçŸ¥ï¼Œæ‰§è¡Œç›®æ ‡æ–¹æ³•ï¼ˆæ–¹æ³•å¼•ç”¨æ–¹å¼ï¼Œinvocation::proceedï¼Œè¿˜æ˜¯è°ƒç”¨ proceedï¼‰ retVal = invocation.proceedWithInvocation(); &#125; catch (Throwable ex) &#123; // æ‰§è¡Œä¸šåŠ¡ä»£ç æ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œæ‰§è¡Œå›æ»šé€»è¾‘ completeTransactionAfterThrowing(txInfo, ex); throw ex; &#125; finally &#123; // æ¸…ç†äº‹åŠ¡çš„ä¿¡æ¯ cleanupTransactionInfo(txInfo); &#125; // æäº¤äº‹åŠ¡çš„å…¥å£ commitTransactionAfterReturning(txInfo); return retVal; &#125; else &#123; // ç¼–ç¨‹å¼äº‹åŠ¡ï¼Œçœç•¥ &#125;&#125; å¼€å¯äº‹åŠ¡äº‹åŠ¡ç»‘å®šåˆ›å»ºäº‹åŠ¡çš„æ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132protected TransactionInfo createTransactionIfNecessary(@Nullable PlatformTransactionManager tm, @Nullable TransactionAttribute txAttr, final String joinpointIdentification) &#123; // If no name specified, apply method identification as transaction name. if (txAttr != null &amp;&amp; txAttr.getName() == null) &#123; // äº‹åŠ¡çš„åç§°ï¼š ç±»çš„æƒé™å®šå.æ–¹æ³•å txAttr = new DelegatingTransactionAttribute(txAttr) &#123; @Override public String getName() &#123; return joinpointIdentification; &#125; &#125;; &#125; TransactionStatus status = null; if (txAttr != null) &#123; if (tm != null) &#123; // é€šè¿‡äº‹åŠ¡ç®¡ç†å™¨æ ¹æ®äº‹åŠ¡å±æ€§åˆ›å»ºäº‹åŠ¡çŠ¶æ€å¯¹è±¡ï¼Œäº‹åŠ¡çŠ¶æ€å¯¹è±¡ä¸€èˆ¬æƒ…å†µä¸‹åŒ…è£…ç€ äº‹åŠ¡å¯¹è±¡ï¼Œå½“ç„¶ä¹Ÿæœ‰å¯èƒ½æ˜¯null // æ–¹æ³•ä¸Šçš„æ³¨è§£ä¸º @Transactional(propagation = NOT_SUPPORTED || propagation = NEVER) æ—¶ // ã€ä¸‹ä¸€å°èŠ‚è¯¦è§£ã€‘ status = tm.getTransaction(txAttr); &#125; else &#123; if (logger.isDebugEnabled()) &#123; logger.debug(&quot;Skipping transactional joinpoint [&quot; + joinpointIdentification + &quot;] because no transaction manager has been configured&quot;); &#125; &#125; &#125; // åŒ…è£…æˆä¸€ä¸ªä¸Šå±‚çš„äº‹åŠ¡ä¸Šä¸‹æ–‡å¯¹è±¡ return prepareTransactionInfo(tm, txAttr, joinpointIdentification, status);&#125; TransactionAspectSupport#prepareTransactionInfoï¼šä¸ºäº‹åŠ¡çš„å±æ€§å’ŒçŠ¶æ€å‡†å¤‡ä¸€ä¸ªäº‹åŠ¡ä¿¡æ¯å¯¹è±¡ TransactionInfo txInfo = new TransactionInfo(tm, txAttr, joinpointIdentification)ï¼šåˆ›å»ºäº‹åŠ¡ä¿¡æ¯å¯¹è±¡ txInfo.newTransactionStatus(status)ï¼šå¡«å……äº‹åŠ¡çš„çŠ¶æ€ä¿¡æ¯ txInfo.bindToThread()ï¼šåˆ©ç”¨ ThreadLocal æŠŠå½“å‰äº‹åŠ¡ä¿¡æ¯ç»‘å®šåˆ°å½“å‰çº¿ç¨‹ï¼Œä¸åŒçš„äº‹åŠ¡ä¿¡æ¯ä¼šå½¢æˆä¸€ä¸ªæ ˆçš„ç»“æ„ this.oldTransactionInfo = transactionInfoHolder.get()ï¼šè·å–å…¶ä»–äº‹åŠ¡çš„ä¿¡æ¯å­˜å…¥ oldTransactionInfo transactionInfoHolder.set(this)ï¼šå°†å½“å‰çš„äº‹åŠ¡ä¿¡æ¯è®¾ç½®åˆ° ThreadLocalMap ä¸­ äº‹åŠ¡åˆ›å»º1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859public final TransactionStatus getTransaction(@Nullable TransactionDefinition definition) throws TransactionException &#123; // è·å–äº‹åŠ¡çš„å¯¹è±¡ Object transaction = doGetTransaction(); boolean debugEnabled = logger.isDebugEnabled(); if (definition == null) &#123; // Use defaults if no transaction definition given. definition = new DefaultTransactionDefinition(); &#125; // æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰æ˜¯äº‹åŠ¡é‡å…¥çš„æƒ…å†µï¼Œäº‹åŠ¡ä¸­æœ‰ ConnectionHolder å¯¹è±¡ if (isExistingTransaction(transaction)) &#123; // aæ–¹æ³•å¼€å¯äº‹åŠ¡ï¼Œaæ–¹æ³•å†…è°ƒç”¨bæ–¹æ³•ï¼Œbæ–¹æ³•ä»ç„¶åŠ äº† @Transactional æ³¨è§£ï¼Œéœ€è¦æ£€æŸ¥ä¼ æ’­è¡Œä¸º return handleExistingTransaction(definition, transaction, debugEnabled); &#125; // é€»è¾‘åˆ°è¿™è¯´æ˜å½“å‰çº¿ç¨‹æ²¡æœ‰è¿æ¥èµ„æºï¼Œä¸€ä¸ªè¿æ¥å¯¹åº”ä¸€ä¸ªäº‹åŠ¡ï¼Œæ²¡æœ‰è¿æ¥å°±ç›¸å½“äºæ²¡æœ‰å¼€å¯äº‹åŠ¡ // æ£€æŸ¥äº‹åŠ¡çš„å»¶è¿Ÿå±æ€§ if (definition.getTimeout() &lt; TransactionDefinition.TIMEOUT_DEFAULT) &#123; throw new InvalidTimeoutException(&quot;Invalid transaction timeout&quot;, definition.getTimeout()); &#125; // ä¼ æ’­è¡Œä¸ºæ˜¯ MANDATORYï¼Œæ²¡æœ‰äº‹åŠ¡å°±æŠ›å‡ºå¼‚å¸¸ if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_MANDATORY) &#123; throw new IllegalTransactionStateException(); &#125; // éœ€è¦å¼€å¯äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸º else if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRED || definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW || definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) &#123; // ä»€ä¹ˆä¹Ÿæ²¡æŒ‚èµ·ï¼Œå› ä¸ºçº¿ç¨‹å¹¶æ²¡æœ‰ç»‘å®šäº‹åŠ¡ SuspendedResourcesHolder suspendedResources = suspend(null); try &#123; // æ˜¯å¦æ”¯æŒåŒæ­¥çº¿ç¨‹äº‹åŠ¡ï¼Œä¸€èˆ¬æ˜¯ true boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER); // æ–°å»ºä¸€ä¸ªäº‹åŠ¡çŠ¶æ€ä¿¡æ¯ DefaultTransactionStatus status = newTransactionStatus( definition, transaction, true, newSynchronization, debugEnabled, suspendedResources); // ã€å¯åŠ¨äº‹åŠ¡ã€‘ doBegin(transaction, definition); // è®¾ç½®çº¿ç¨‹ä¸Šä¸‹æ–‡å˜é‡ï¼Œæ–¹ä¾¿ç¨‹åºè¿è¡ŒæœŸé—´è·å–å½“å‰äº‹åŠ¡çš„ä¸€äº›æ ¸å¿ƒçš„å±æ€§ï¼ŒinitSynchronization() å¯åŠ¨åŒæ­¥ prepareSynchronization(status, definition); return status; &#125; catch (RuntimeException | Error ex) &#123; // æ¢å¤ç°åœº resume(null, suspendedResources); throw ex; &#125; &#125; // ä¸æ”¯æŒäº‹åŠ¡çš„ä¼ æ’­è¡Œä¸º else &#123; // Create &quot;empty&quot; transaction: no actual transaction, but potentially synchronization. boolean newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS); // åˆ›å»ºäº‹åŠ¡çŠ¶æ€å¯¹è±¡ // å‚æ•°2 transaction æ˜¯ null è¯´æ˜å½“å‰äº‹åŠ¡çŠ¶æ€æ˜¯æœªæ‰‹åŠ¨å¼€å¯äº‹ï¼Œçº¿ç¨‹ä¸Šæœªç»‘å®šä»»ä½•çš„è¿æ¥èµ„æºï¼Œä¸šåŠ¡ç¨‹åºæ‰§è¡Œæ—¶éœ€è¦å…ˆå» datasource è·å–çš„ connï¼Œæ˜¯è‡ªåŠ¨æäº¤äº‹åŠ¡çš„ï¼Œä¸éœ€è¦ Spring å†æäº¤äº‹åŠ¡ // å‚æ•°6 suspendedResources æ˜¯ null è¯´æ˜å½“å‰äº‹åŠ¡çŠ¶æ€æœªæŒ‚èµ·ä»»ä½•äº‹åŠ¡ï¼Œå½“å‰äº‹åŠ¡æ‰§è¡Œåˆ°åç½®å¤„ç†æ—¶ä¸éœ€è¦æ¢å¤ç°åœº return prepareTransactionStatus(definition, null, true, newSynchronization, debugEnabled, null); &#125;&#125; DataSourceTransactionManager#doGetTransactionï¼šçœŸæ­£è·å–äº‹åŠ¡çš„æ–¹æ³• DataSourceTransactionObject txObject = new DataSourceTransactionObject()ï¼šåˆ›å»ºäº‹åŠ¡å¯¹è±¡ txObject.setSavepointAllowed(isNestedAllowed())ï¼šè®¾ç½®äº‹åŠ¡å¯¹è±¡æ˜¯å¦æ”¯æŒä¿å­˜ç‚¹ï¼Œç”±äº‹åŠ¡ç®¡ç†å™¨æ§åˆ¶ï¼ˆé»˜è®¤ä¸æ”¯æŒï¼‰ ConnectionHolder conHolder = TransactionSynchronizationManager.getResource(obtainDataSource())ï¼š ä» ThreadLocal ä¸­è·å– conHolder èµ„æºï¼Œå¯èƒ½æ‹¿åˆ° null æˆ–è€…ä¸æ˜¯ null æ˜¯ nullï¼šä¸¾ä¾‹ 12@Transactionpublic void a() &#123;...b.b()....&#125; ä¸æ˜¯ nullï¼šæ‰§è¡Œ b æ–¹æ³•äº‹åŠ¡å¢å¼ºçš„å‰ç½®é€»è¾‘æ—¶ï¼Œå¯ä»¥æ‹¿åˆ° a æ”¾è¿›å»çš„ conHolder èµ„æº 12@Transactionpublic void b() &#123;....&#125; txObject.setConnectionHolder(conHolder, false)ï¼šå°† ConnectionHolder ä¿å­˜åˆ°äº‹åŠ¡å¯¹è±¡å†…ï¼Œå‚æ•°äºŒæ˜¯ false ä»£è¡¨è¿æ¥èµ„æºæ˜¯ä¸Šå±‚äº‹åŠ¡å…±äº«çš„ï¼Œä¸æ˜¯æ–°å»ºçš„è¿æ¥èµ„æº return txObjectï¼šè¿”å›äº‹åŠ¡çš„å¯¹è±¡ DataSourceTransactionManager#doBeginï¼šäº‹åŠ¡å¼€å¯çš„é€»è¾‘ txObject = (DataSourceTransactionObject) transactionï¼šå¼ºè½¬ä¸ºäº‹åŠ¡å¯¹è±¡ äº‹åŠ¡ä¸­æ²¡æœ‰æ•°æ®åº“è¿æ¥èµ„æºå°±è¦åˆ†é…ï¼š Connection newCon = obtainDataSource().getConnection()ï¼šè·å– JDBC åŸç”Ÿçš„æ•°æ®åº“è¿æ¥å¯¹è±¡ txObject.setConnectionHolder(new ConnectionHolder(newCon), true)ï¼šä»£è¡¨æ˜¯æ–°å¼€å¯çš„äº‹åŠ¡ï¼Œæ–°å»ºçš„è¿æ¥å¯¹è±¡ previousIsolationLevel = DataSourceUtils.prepareConnectionForTransaction(con, definition)ï¼šä¿®æ”¹è¿æ¥å±æ€§ if (definition != null &amp;&amp; definition.isReadOnly())ï¼šæ³¨è§£ï¼ˆæˆ– XMLï¼‰é…ç½®äº†åªè¯»å±æ€§ï¼Œéœ€è¦è®¾ç½® if (..definition.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT)ï¼šæ³¨è§£é…ç½®äº†éš”ç¦»çº§åˆ« int currentIsolation = con.getTransactionIsolation()ï¼šè·å–è¿æ¥çš„éš”ç¦»ç•Œåˆ« previousIsolationLevel = currentIsolationï¼šä¿å­˜ä¹‹å‰çš„éš”ç¦»ç•Œåˆ«ï¼Œè¿”å›è¯¥å€¼ con.setTransactionIsolation(definition.getIsolationLevel())ï¼šå°†å½“å‰è¿æ¥è®¾ç½®ä¸ºé…ç½®çš„éš”ç¦»ç•Œåˆ« txObject.setPreviousIsolationLevel(previousIsolationLevel)ï¼šå°† Conn åŸæ¥çš„éš”ç¦»çº§åˆ«ä¿å­˜åˆ°äº‹åŠ¡å¯¹è±¡ï¼Œä¸ºäº†é‡Šæ”¾ Conn æ—¶é‡ç½®å›åŸçŠ¶æ€ if (con.getAutoCommit())ï¼šé»˜è®¤ä¼šæˆç«‹ï¼Œè¯´æ˜è¿˜æ²¡å¼€å¯äº‹åŠ¡ txObject.setMustRestoreAutoCommit(true)ï¼šä¿å­˜ Conn åŸæ¥çš„äº‹åŠ¡çŠ¶æ€ con.setAutoCommit(false)ï¼šå¼€å¯äº‹åŠ¡ï¼ŒJDBC åŸç”Ÿçš„æ–¹å¼ txObject.getConnectionHolder().setTransactionActive(true)ï¼šè¡¨ç¤º Holder æŒæœ‰çš„ Conn å·²ç»æ‰‹åŠ¨å¼€å¯äº‹åŠ¡äº† TransactionSynchronizationManager.bindResource(obtainDataSource(), txObject.getConnectionHolder())ï¼šå°† ConnectionHolder å¯¹è±¡ç»‘å®šåˆ° ThreadLocal å†…ï¼Œæ•°æ®æºä¸º keyï¼Œä¸ºäº†æ–¹ä¾¿è·å–æ‰‹åŠ¨å¼€å¯äº‹åŠ¡çš„è¿æ¥å¯¹è±¡å»æ‰§è¡Œ SQL äº‹åŠ¡é‡å…¥äº‹åŠ¡é‡å…¥çš„æ ¸å¿ƒå¤„ç†é€»è¾‘ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546private TransactionStatus handleExistingTransaction( TransactionDefinition definition, Object transaction, boolean debugEnabled)&#123; // ä¼ æ’­è¡Œä¸ºæ˜¯ PROPAGATION_NEVERï¼Œéœ€è¦ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œæ“ä½œï¼Œå¦‚æœå½“å‰äº‹åŠ¡å­˜åœ¨åˆ™ã€æŠ›å‡ºå¼‚å¸¸ã€‘ if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NEVER) &#123; throw new IllegalTransactionStateException(); &#125; // ä¼ æ’­è¡Œä¸ºæ˜¯ PROPAGATION_NOT_SUPPORTEDï¼Œä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™ã€æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‘ if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NOT_SUPPORTED) &#123; // æŒ‚èµ·äº‹åŠ¡ Object suspendedResources = suspend(transaction); boolean newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS); // åˆ›å»ºä¸€ä¸ªéäº‹åŠ¡çš„äº‹åŠ¡çŠ¶æ€å¯¹è±¡è¿”å› return prepareTransactionStatus(definition, null, false, newSynchronization, debugEnabled, suspendedResources); &#125; // å¼€å¯æ–°äº‹ç‰©çš„é€»è¾‘ if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW) &#123; // ã€æŒ‚èµ·å½“å‰äº‹åŠ¡ã€‘ SuspendedResourcesHolder suspendedResources = suspend(transaction); // ã€å¼€å¯æ–°äº‹ç‰©ã€‘ &#125; // ä¼ æ’­è¡Œä¸ºæ˜¯ PROPAGATION_NESTEDï¼ŒåµŒå¥—äº‹åŠ¡ if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) &#123; // Spring é»˜è®¤ä¸æ”¯æŒå†…åµŒäº‹åŠ¡ // ã€å¼€å¯æ–¹å¼ã€‘ï¼š&lt;property name=&quot;nestedTransactionAllowed&quot; value=&quot;true&quot;&gt; if (!isNestedTransactionAllowed()) &#123; throw new NestedTransactionNotSupportedException(); &#125; if (useSavepointForNestedTransaction()) &#123; // ä¸ºå½“å‰æ–¹æ³•åˆ›å»ºä¸€ä¸ª TransactionStatus å¯¹è±¡ï¼Œ DefaultTransactionStatus status = prepareTransactionStatus(definition, transaction, false, false, debugEnabled, null); // åˆ›å»ºä¸€ä¸ª JDBC çš„ä¿å­˜ç‚¹ status.createAndHoldSavepoint(); // ä¸éœ€è¦ä½¿ç”¨åŒæ­¥ï¼Œç›´æ¥è¿”å› return status; &#125; else &#123; // Usually only for JTA transactionï¼Œå¼€å¯ä¸€ä¸ªæ–°äº‹åŠ¡ &#125; &#125; // Assumably PROPAGATION_SUPPORTS or PROPAGATION_REQUIREDï¼Œã€ä½¿ç”¨å½“å‰çš„äº‹åŠ¡ã€‘ boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER); return prepareTransactionStatus(definition, transaction, false, newSynchronization, debugEnabled, null);&#125; æŒ‚èµ·æ¢å¤AbstractPlatformTransactionManager#suspendï¼šæŒ‚èµ·äº‹åŠ¡ï¼Œå¹¶è·å¾—ä¸€ä¸ªä¸Šä¸‹æ–‡ä¿¡æ¯å¯¹è±¡ 12345678910111213141516171819202122232425protected final SuspendedResourcesHolder suspend(@Nullable Object transaction) &#123; // äº‹åŠ¡æ˜¯åŒæ­¥çŠ¶æ€çš„ if (TransactionSynchronizationManager.isSynchronizationActive()) &#123; List&lt;TransactionSynchronization&gt; suspendedSynchronizations = doSuspendSynchronization(); try &#123; Object suspendedResources = null; if (transaction != null) &#123; // do it suspendedResources = doSuspend(transaction); &#125; //å°†ä¸Šå±‚äº‹åŠ¡ç»‘å®šåœ¨çº¿ç¨‹ä¸Šä¸‹æ–‡çš„å˜é‡å…¨éƒ¨å–å‡ºæ¥ //... // é€šè¿‡è¢«æŒ‚èµ·çš„èµ„æºå’Œä¸Šå±‚äº‹åŠ¡çš„ä¸Šä¸‹æ–‡å˜é‡ï¼Œåˆ›å»ºä¸€ä¸ªã€SuspendedResourcesHolderã€‘è¿”å› return new SuspendedResourcesHolder(suspendedResources, suspendedSynchronizations, name, readOnly, isolationLevel, wasActive); &#125; //...&#125;protected Object doSuspend(Object transaction) &#123; DataSourceTransactionObject txObject = (DataSourceTransactionObject) transaction; // å°†å½“å‰æ–¹æ³•çš„äº‹åŠ¡å¯¹è±¡ connectionHolder å±æ€§ç½®ä¸º nullï¼Œä¸å’Œä¸Šå±‚å…±äº«èµ„æº // å½“å‰æ–¹æ³•æœ‰å¯èƒ½æ˜¯ä¸å¼€å¯äº‹åŠ¡æˆ–è€…è¦å¼€å¯ä¸€ä¸ªç‹¬ç«‹çš„äº‹åŠ¡ txObject.setConnectionHolder(null); // ã€è§£ç»‘åœ¨çº¿ç¨‹ä¸Šçš„äº‹åŠ¡ã€‘ return TransactionSynchronizationManager.unbindResource(obtainDataSource());&#125; AbstractPlatformTransactionManager#resumeï¼šæ¢å¤ç°åœºï¼Œæ ¹æ®æŒ‚èµ·èµ„æºå»æ¢å¤çº¿ç¨‹ä¸Šä¸‹æ–‡ä¿¡æ¯ 1234567891011121314151617181920protected final void resume(Object transaction, SuspendedResourcesHolder resourcesHolder) &#123; if (resourcesHolder != null) &#123; // è·å–è¢«æŒ‚èµ·çš„äº‹åŠ¡èµ„æº Object suspendedResources = resourcesHolder.suspendedResources; if (suspendedResources != null) &#123; //ç»‘å®šä¸Šä¸€ä¸ªäº‹åŠ¡çš„ ConnectionHolder åˆ°çº¿ç¨‹ä¸Šä¸‹æ–‡ doResume(transaction, suspendedResources); &#125; List&lt;TransactionSynchronization&gt; suspendedSynchronizations = resourcesHolder.suspendedSynchronizations; if (suspendedSynchronizations != null) &#123; //.... // å°†çº¿ç¨‹ä¸Šä¸‹æ–‡å˜é‡æ¢å¤ä¸ºä¸Šä¸€ä¸ªäº‹åŠ¡çš„æŒ‚èµ·ç°åœº doResumeSynchronization(suspendedSynchronizations); &#125; &#125;&#125;protected void doResume(@Nullable Object transaction, Object suspendedResources) &#123; // doSuspend çš„é€†åŠ¨ä½œï¼Œã€ç»‘å®šèµ„æºã€‘ TransactionSynchronizationManager.bindResource(obtainDataSource(), suspendedResources);&#125; æäº¤å›æ»šå›æ»šæ–¹å¼1234567891011121314151617181920212223242526protected void completeTransactionAfterThrowing(@Nullable TransactionInfo txInfo, Throwable ex) &#123; // äº‹åŠ¡çŠ¶æ€ä¿¡æ¯ä¸ä¸ºç©ºè¿›å…¥é€»è¾‘ if (txInfo != null &amp;&amp; txInfo.getTransactionStatus() != null) &#123; // æ¡ä»¶äºŒæˆç«‹ è¯´æ˜ç›®æ ‡æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸éœ€è¦å›æ»šäº‹åŠ¡ if (txInfo.transactionAttribute != null &amp;&amp; txInfo.transactionAttribute.rollbackOn(ex)) &#123; try &#123; // äº‹åŠ¡ç®¡ç†å™¨çš„å›æ»šæ–¹æ³• txInfo.getTransactionManager().rollback(txInfo.getTransactionStatus()); &#125; catch (TransactionSystemException ex2) &#123;&#125; &#125; else &#123; // æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜å½“å‰äº‹åŠ¡è™½ç„¶æŠ›å‡ºäº†å¼‚å¸¸ï¼Œä½†æ˜¯è¯¥å¼‚å¸¸å¹¶ä¸ä¼šå¯¼è‡´æ•´ä¸ªäº‹åŠ¡å›æ»š try &#123; // æäº¤äº‹åŠ¡ txInfo.getTransactionManager().commit(txInfo.getTransactionStatus()); &#125; catch (TransactionSystemException ex2) &#123;&#125; &#125; &#125;&#125;public boolean rollbackOn(Throwable ex) &#123; // ç»§æ‰¿è‡ª RuntimeException æˆ– error çš„æ˜¯ã€éæ£€æŸ¥å‹å¼‚å¸¸ã€‘ï¼Œæ‰ä¼šå½’æ»šäº‹åŠ¡ // å¦‚æœé…ç½®äº†å…¶ä»–å›æ»šé”™è¯¯ï¼Œä¼šè·å–åˆ°å›æ»šè§„åˆ™ rollbackRules è¿›è¡Œåˆ¤æ–­ return (ex instanceof RuntimeException || ex instanceof Error);&#125; 123456789public final void rollback(TransactionStatus status) throws TransactionException &#123; // äº‹åŠ¡å·²ç»å®Œæˆä¸éœ€è¦å›æ»š if (status.isCompleted()) &#123; throw new IllegalTransactionStateException(); &#125; DefaultTransactionStatus defStatus = (DefaultTransactionStatus) status; // å¼€å§‹å›æ»šäº‹åŠ¡ processRollback(defStatus, false);&#125; AbstractPlatformTransactionManager#processRollbackï¼šäº‹åŠ¡å›æ»š triggerBeforeCompletion(status)ï¼šç”¨æ¥åšæ‰©å±•é€»è¾‘ï¼Œå›æ»šå‰çš„å‰ç½®å¤„ç† if (status.hasSavepoint())ï¼šæ¡ä»¶æˆç«‹è¯´æ˜å½“å‰äº‹åŠ¡æ˜¯ä¸€ä¸ªå†…åµŒäº‹åŠ¡ï¼Œå½“å‰æ–¹æ³•åªæ˜¯å¤ç”¨äº†ä¸Šå±‚äº‹åŠ¡çš„ä¸€ä¸ªå†…åµŒäº‹åŠ¡ status.rollbackToHeldSavepoint()ï¼šå†…åµŒäº‹åŠ¡åŠ å…¥äº‹åŠ¡æ—¶ä¼šåˆ›å»ºä¸€ä¸ªä¿å­˜ç‚¹ï¼Œæ­¤æ—¶æ¢å¤è‡³ä¿å­˜ç‚¹ if (status.isNewTransaction())ï¼šè¯´æ˜äº‹åŠ¡æ˜¯å½“å‰è¿æ¥å¼€å¯çš„ï¼Œéœ€è¦å»å›æ»šäº‹åŠ¡ doRollback(status)ï¼šçœŸæ­£çš„çš„å›æ»šå‡½æ•° DataSourceTransactionObject txObject = status.getTransaction()ï¼šè·å–äº‹åŠ¡å¯¹è±¡ Connection con = txObject.getConnectionHolder().getConnection()ï¼šè·å–è¿æ¥å¯¹è±¡ con.rollback()ï¼šJDBC çš„æ–¹å¼å›æ»šäº‹åŠ¡ elseï¼šå½“å‰æ–¹æ³•æ˜¯å…±äº«çš„ä¸Šå±‚çš„äº‹åŠ¡ï¼Œå’Œä¸Šå±‚ä½¿ç”¨åŒä¸€ä¸ª Conn èµ„æºï¼Œå…±äº«çš„äº‹åŠ¡ä¸èƒ½ç›´æ¥å›æ»šï¼Œåº”è¯¥äº¤ç»™ä¸Šå±‚å¤„ç† doSetRollbackOnly(status)ï¼šè®¾ç½® con.rollbackOnly &#x3D; trueï¼Œçº¿ç¨‹å›åˆ°ä¸Šå±‚äº‹åŠ¡ commit æ—¶ä¼šæ£€æŸ¥è¯¥å­—æ®µï¼Œç„¶åæ‰§è¡Œå›æ»šæ“ä½œ triggerAfterCompletion(status, TransactionSynchronization.STATUS_ROLLED_BACK)ï¼šå›æ»šçš„åç½®å¤„ç† cleanupAfterCompletion(status)ï¼šæ¸…ç†å’Œæ¢å¤ç°åœº æäº¤æ–¹å¼123456protected void commitTransactionAfterReturning(@Nullable TransactionInfo txInfo) &#123; if (txInfo != null &amp;&amp; txInfo.getTransactionStatus() != null) &#123; // äº‹åŠ¡ç®¡ç†å™¨çš„æäº¤æ–¹æ³• txInfo.getTransactionManager().commit(txInfo.getTransactionStatus()); &#125;&#125; 123456789101112131415161718192021public final void commit(TransactionStatus status) throws TransactionException &#123; // å·²ç»å®Œæˆçš„äº‹åŠ¡ä¸éœ€è¦æäº¤äº† if (status.isCompleted()) &#123; throw new IllegalTransactionStateException(); &#125; DefaultTransactionStatus defStatus = (DefaultTransactionStatus) status; // æ¡ä»¶æˆç«‹è¯´æ˜æ˜¯å½“å‰çš„ä¸šåŠ¡å¼ºåˆ¶å›æ»š if (defStatus.isLocalRollbackOnly()) &#123; // å›æ»šé€»è¾‘ï¼Œ processRollback(defStatus, false); return; &#125; // æˆç«‹è¯´æ˜å…±äº«å½“å‰äº‹åŠ¡çš„ã€ä¸‹å±‚äº‹åŠ¡é€»è¾‘å‡ºé”™ï¼Œéœ€è¦å›æ»šã€‘ if (!shouldCommitOnGlobalRollbackOnly() &amp;&amp; defStatus.isGlobalRollbackOnly()) &#123; // å¦‚æœå½“å‰äº‹åŠ¡è¿˜æ˜¯äº‹åŠ¡é‡å…¥ï¼Œä¼šç»§ç»­æŠ›ç»™ä¸Šå±‚ï¼Œæœ€ä¸Šå±‚äº‹åŠ¡ä¼šè¿›è¡ŒçœŸå®çš„äº‹åŠ¡å›æ»šæ“ä½œ processRollback(defStatus, true); return; &#125; // æ‰§è¡Œæäº¤ processCommit(defStatus);&#125; AbstractPlatformTransactionManager#processCommitï¼šäº‹åŠ¡æäº¤ prepareForCommit(status)ï¼šå‰ç½®å¤„ç† if (status.hasSavepoint())ï¼šæ¡ä»¶æˆç«‹è¯´æ˜å½“å‰äº‹åŠ¡æ˜¯ä¸€ä¸ªå†…åµŒäº‹åŠ¡ï¼Œåªæ˜¯å¤ç”¨äº†ä¸Šå±‚äº‹åŠ¡ status.releaseHeldSavepoint()ï¼šæ¸…ç†ä¿å­˜ç‚¹ï¼Œå› ä¸ºæ²¡æœ‰å‘ç”Ÿä»»ä½•å¼‚å¸¸ï¼Œæ‰€ä»¥ä¿å­˜ç‚¹æ²¡æœ‰å­˜åœ¨çš„æ„ä¹‰äº† if (status.isNewTransaction())ï¼šè¯´æ˜äº‹åŠ¡æ˜¯å½’å±äºå½“å‰è¿æ¥çš„ï¼Œéœ€è¦å»æäº¤äº‹åŠ¡ doCommit(status)ï¼šçœŸæ­£çš„æäº¤å‡½æ•° Connection con = txObject.getConnectionHolder().getConnection()ï¼šè·å–è¿æ¥å¯¹è±¡ con.commit()ï¼šJDBC çš„æ–¹å¼æäº¤äº‹åŠ¡ doRollbackOnCommitException(status, ex)ï¼šæäº¤äº‹åŠ¡å‡ºé”™åè¿›è¡Œå›æ»š cleanupAfterCompletion(status)ï¼šæ¸…ç†å’Œæ¢å¤ç°åœº æ¸…ç†ç°åœºæ¢å¤ä¸Šå±‚äº‹åŠ¡ï¼š 12345678910protected void cleanupTransactionInfo(@Nullable TransactionInfo txInfo) &#123; if (txInfo != null) &#123; // ä»å½“å‰çº¿ç¨‹çš„ ThreadLocal è·å–ä¸Šå±‚çš„äº‹åŠ¡ä¿¡æ¯ï¼Œå°†å½“å‰äº‹åŠ¡å‡ºæ ˆï¼Œç»§ç»­æ‰§è¡Œä¸Šå±‚äº‹åŠ¡ txInfo.restoreThreadLocalStatus(); &#125;&#125;private void restoreThreadLocalStatus() &#123; // Use stack to restore old transaction TransactionInfo. transactionInfoHolder.set(this.oldTransactionInfo);&#125; å½“å‰å±‚çº§äº‹åŠ¡ç»“æŸæ—¶çš„æ¸…ç†ï¼š 12345678910111213141516171819private void cleanupAfterCompletion(DefaultTransactionStatus status) &#123; // è®¾ç½®å½“å‰æ–¹æ³•çš„äº‹åŠ¡çŠ¶æ€ä¸ºå®ŒæˆçŠ¶æ€ status.setCompleted(); if (status.isNewSynchronization()) &#123; // æ¸…ç†çº¿ç¨‹ä¸Šä¸‹æ–‡å˜é‡ä»¥åŠæ‰©å±•ç‚¹æ³¨å†Œçš„ sync TransactionSynchronizationManager.clear(); &#125; // äº‹åŠ¡æ˜¯å½“å‰çº¿ç¨‹å¼€å¯çš„ if (status.isNewTransaction()) &#123; // è§£ç»‘èµ„æº doCleanupAfterCompletion(status.getTransaction()); &#125; // æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰äº‹åŠ¡æ‰§è¡Œçš„æ—¶å€™ï¼Œã€æŒ‚èµ·äº†ä¸€ä¸ªä¸Šå±‚çš„äº‹åŠ¡ã€‘ if (status.getSuspendedResources() != null) &#123; Object transaction = (status.hasTransaction() ? status.getTransaction() : null); // æ¢å¤ä¸Šå±‚äº‹åŠ¡ç°åœº resume(transaction, (SuspendedResourcesHolder) status.getSuspendedResources()); &#125;&#125; DataSourceTransactionManager#doCleanupAfterCompletionï¼šæ¸…ç†å·¥ä½œ TransactionSynchronizationManager.unbindResource(obtainDataSource())ï¼šè§£ç»‘æ•°æ®åº“èµ„æº if (txObject.isMustRestoreAutoCommit())ï¼šæ˜¯å¦æ¢å¤è¿æ¥ï¼ŒConn å½’è¿˜åˆ° DataSourceï¼Œå½’è¿˜å‰éœ€è¦æ¢å¤åˆ°ç”³è¯·æ—¶çš„çŠ¶æ€ con.setAutoCommit(true)ï¼šæ¢å¤è¿æ¥ä¸ºè‡ªåŠ¨æäº¤ DataSourceUtils.resetConnectionAfterTransaction(con, txObject.getPreviousIsolationLevel())ï¼šæ¢å¤éš”ç¦»çº§åˆ« DataSourceUtils.releaseConnection(con, this.dataSource)ï¼šå°†è¿æ¥å½’è¿˜ç»™æ•°æ®åº“è¿æ¥æ±  txObject.getConnectionHolder().clear()ï¼šæ¸…ç† ConnectionHolder èµ„æº æ³¨è§£Component@Component è§£ææµç¨‹ï¼š æ³¨è§£ç±»å¯åŠ¨å®¹å™¨çš„æ—¶ï¼Œæ³¨å†Œ ClassPathBeanDefinitionScanner åˆ°å®¹å™¨ï¼Œç”¨æ¥æ‰«æ Bean çš„ç›¸å…³ä¿¡æ¯ 123456789101112protected Set&lt;BeanDefinitionHolder&gt; doScan(String... basePackages) &#123; Set&lt;BeanDefinitionHolder&gt; beanDefinitions = new LinkedHashSet&lt;&gt;(); // éå†æŒ‡å®šçš„æ‰€æœ‰çš„åŒ…ï¼Œã€è¿™å°±ç›¸å½“äºæ‰«æäº†ã€‘ for (String basePackage : basePackages) &#123; // è¯»å–å½“å‰åŒ…ä¸‹çš„èµ„æºè£…æ¢ä¸º BeanDefinitionï¼Œå­—èŠ‚æµçš„æ–¹å¼ Set&lt;BeanDefinition&gt; candidates = findCandidateComponents(basePackage); for (BeanDefinition candidate : candidates) &#123; // éå†ï¼Œå°è£…ï¼Œç±»ä¼¼äº XML çš„è§£ææ–¹å¼ï¼Œæ³¨å†Œåˆ°å®¹å™¨ä¸­ registerBeanDefinition(definitionHolder, this.registry) &#125; return beanDefinitions;&#125; ClassPathScanningCandidateComponentProvider.findCandidateComponents() 12345678public Set&lt;BeanDefinition&gt; findCandidateComponents(String basePackage) &#123; if (this.componentsIndex != null &amp;&amp; indexSupportsIncludeFilters()) &#123; return addCandidateComponentsFromIndex(this.componentsIndex, basePackage); &#125; else &#123; return scanCandidateComponents(basePackage); &#125;&#125; 1private Set&lt;BeanDefinition&gt; scanCandidateComponents(String basePackage) &#123;&#125; String packageSearchPath = ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX resolveBasePackage(basePackage) + &#39;/&#39; + this.resourcePattern ï¼šå°† package è½¬åŒ–ä¸º ClassLoader ç±»èµ„æºæœç´¢è·¯å¾„ packageSearchPathï¼Œä¾‹å¦‚ï¼šcom.sea.spring.boot è½¬åŒ–ä¸º classpath*:com/sea/spring/boot/**/*.class resources = getResourcePatternResolver().getResources(packageSearchPath)ï¼šåŠ è½½è·¯å¾„ä¸‹çš„èµ„æº for (Resource resource : resources) ï¼šéå†æ‰€æœ‰çš„èµ„æº metadataReader = getMetadataReaderFactory().getMetadataReader(resource)ï¼šè·å–å…ƒæ•°æ®é˜…è¯»å™¨ if (isCandidateComponent(metadataReader))ï¼šå½“å‰ç±»ä¸åŒ¹é…ä»»ä½•æ’é™¤è¿‡æ»¤å™¨ï¼Œå¹¶ä¸”åŒ¹é…ä¸€ä¸ªåŒ…å«è¿‡æ»¤å™¨ï¼Œè¿”å› true includeFilters ç”± registerDefaultFilters() è®¾ç½®åˆå§‹å€¼ï¼Œæ–¹æ³•æœ‰ @Componentï¼Œæ²¡æœ‰ @Serviceï¼Œå› ä¸º @Component æ˜¯ @Service çš„å…ƒæ³¨è§£ï¼ŒSpring åœ¨è¯»å– @Service æ—¶ä¹Ÿè¯»å–äº†å…ƒæ³¨è§£ï¼Œå¹¶å°† @Service ä½œä¸º @Component å¤„ç† 1this.includeFilters.add(new AnnotationTypeFilter(Component.class)) 12345@Target(&#123;ElementType.TYPE&#125;)@Retention(RetentionPolicy.RUNTIME)@Documented@Component // æ‹¥æœ‰äº† Component åŠŸèƒ½public @interface Service &#123;&#125; candidates.add(sbd)ï¼šæ·»åŠ åˆ°è¿”å›ç»“æœçš„ list å‚è€ƒæ–‡ç« ï¼šhttps://my.oschina.net/floor/blog/4325651 Autowiredæ‰“å¼€ @Autowired æºç ï¼Œæ³¨é‡Šä¸Šå†™ Please consult the javadoc for the AutowiredAnnotationBeanPostProcessor AutowiredAnnotationBeanPostProcessor é—´æ¥å®ç° InstantiationAwareBeanPostProcessorï¼Œå°±å…·å¤‡äº†å®ä¾‹åŒ–å‰åï¼ˆè€Œä¸æ˜¯åˆå§‹åŒ–å‰åï¼‰ç®¡ç†å¯¹è±¡çš„èƒ½åŠ›ï¼Œå®ç°äº† BeanPostProcessorï¼Œå…·æœ‰åˆå§‹åŒ–å‰åç®¡ç†å¯¹è±¡çš„èƒ½åŠ›ï¼Œå®ç° BeanFactoryAwareï¼Œå…·å¤‡éšæ—¶æ‹¿åˆ° BeanFactory çš„èƒ½åŠ›ï¼Œæ‰€ä»¥è¿™ä¸ªç±»å…·å¤‡ä¸€åˆ‡åç½®å¤„ç†å™¨çš„èƒ½åŠ› åœ¨å®¹å™¨å¯åŠ¨ï¼Œä¸ºå¯¹è±¡èµ‹å€¼çš„æ—¶å€™ï¼Œé‡åˆ° @Autowired æ³¨è§£ï¼Œä¼šç”¨åç½®å¤„ç†å™¨æœºåˆ¶ï¼Œæ¥åˆ›å»ºå±æ€§çš„å®ä¾‹ï¼Œç„¶åå†åˆ©ç”¨åå°„æœºåˆ¶ï¼Œå°†å®ä¾‹åŒ–å¥½çš„å±æ€§ï¼Œèµ‹å€¼ç»™å¯¹è±¡ä¸Šï¼Œè¿™å°±æ˜¯ Autowired çš„åŸç† ä½œç”¨æ—¶æœºï¼š Spring åœ¨æ¯ä¸ª Bean å®ä¾‹åŒ–ä¹‹åï¼Œè°ƒç”¨ AutowiredAnnotationBeanPostProcessor çš„ postProcessMergedBeanDefinition() æ–¹æ³•ï¼ŒæŸ¥æ‰¾è¯¥ Bean æ˜¯å¦æœ‰ @Autowired æ³¨è§£ï¼Œè¿›è¡Œç›¸å…³å…ƒæ•°æ®çš„è·å– Spring åœ¨æ¯ä¸ª Bean è°ƒç”¨ populateBean() è¿›è¡Œå±æ€§æ³¨å…¥çš„æ—¶å€™ï¼Œå³è°ƒç”¨ postProcessProperties() æ–¹æ³•ï¼ŒæŸ¥æ‰¾è¯¥ Bean å±æ€§æ˜¯å¦æœ‰ @Autowired æ³¨è§£ï¼Œè¿›è¡Œç›¸å…³æ•°æ®çš„å¡«å…… MVCåŸºæœ¬ä»‹ç»SpringMVCï¼šæ˜¯ä¸€ç§åŸºäº Java å®ç° MVC æ¨¡å‹çš„è½»é‡çº§ Web æ¡†æ¶ SpringMVC ä¼˜ç‚¹ï¼š ä½¿ç”¨ç®€å• æ€§èƒ½çªå‡ºï¼ˆå¯¹æ¯”ç°æœ‰çš„æ¡†æ¶æŠ€æœ¯ï¼‰ çµæ´»æ€§å¼º è½¯ä»¶å¼€å‘ä¸‰å±‚æ¶æ„ï¼š è¡¨ç°å±‚ï¼šè´Ÿè´£æ•°æ®å±•ç¤º ä¸šåŠ¡å±‚ï¼šè´Ÿè´£ä¸šåŠ¡å¤„ç† æ•°æ®å±‚ï¼šè´Ÿè´£æ•°æ®æ“ä½œ MVCï¼ˆModel View Controllerï¼‰ï¼Œä¸€ç§ç”¨äºè®¾è®¡åˆ›å»ºWebåº”ç”¨ç¨‹åºè¡¨ç°å±‚çš„æ¨¡å¼ Modelï¼ˆæ¨¡å‹ï¼‰ï¼šæ•°æ®æ¨¡å‹ï¼Œç”¨äºå°è£…æ•°æ® Viewï¼ˆè§†å›¾ï¼‰ï¼šé¡µé¢è§†å›¾ï¼Œç”¨äºå±•ç¤ºæ•°æ® jsp html Controllerï¼ˆæ§åˆ¶å™¨ï¼‰ï¼šå¤„ç†ç”¨æˆ·äº¤äº’çš„è°ƒåº¦å™¨ï¼Œç”¨äºæ ¹æ®ç”¨æˆ·éœ€æ±‚å¤„ç†ç¨‹åºé€»è¾‘ Servlet SpringMVC å‚è€ƒè§†é¢‘ï¼šhttps://space.bilibili.com/37974444/ åŸºæœ¬é…ç½®å…¥é—¨é¡¹ç›®æµç¨‹åˆ†æï¼š æœåŠ¡å™¨å¯åŠ¨ åŠ è½½ web.xml ä¸­ DispatcherServlet è¯»å– spring-mvc.xml ä¸­çš„é…ç½®ï¼ŒåŠ è½½æ‰€æœ‰ controller åŒ…ä¸­æ‰€æœ‰æ ‡è®°ä¸º bean çš„ç±» è¯»å– bean ä¸­æ–¹æ³•ä¸Šæ–¹æ ‡æ³¨ @RequestMapping çš„å†…å®¹ å¤„ç†è¯·æ±‚ DispatcherServlet é…ç½®æ‹¦æˆªæ‰€æœ‰è¯·æ±‚ &#x2F; ä½¿ç”¨è¯·æ±‚è·¯å¾„ä¸æ‰€æœ‰åŠ è½½çš„ @RequestMapping çš„å†…å®¹è¿›è¡Œæ¯”å¯¹ æ‰§è¡Œå¯¹åº”çš„æ–¹æ³• æ ¹æ®æ–¹æ³•çš„è¿”å›å€¼åœ¨ webapp ç›®å½•ä¸­æŸ¥æ‰¾å¯¹åº”çš„é¡µé¢å¹¶å±•ç¤º ä»£ç å®ç°ï¼š pom.xml å¯¼å…¥åæ ‡ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;&lt;groupId&gt;demo&lt;/groupId&gt;&lt;artifactId&gt;spring_base_config&lt;/artifactId&gt;&lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;&lt;packaging&gt;war&lt;/packaging&gt;&lt;properties&gt; &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt; &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt; &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;&lt;/properties&gt;&lt;dependencies&gt; &lt;!-- servlet3.0è§„èŒƒçš„åæ ‡ --&gt; &lt;dependency&gt; &lt;groupId&gt;javax.servlet&lt;/groupId&gt; &lt;artifactId&gt;javax.servlet-api&lt;/artifactId&gt; &lt;version&gt;3.1.0&lt;/version&gt; &lt;scope&gt;provided&lt;/scope&gt; &lt;/dependency&gt; &lt;!--jspåæ ‡--&gt; &lt;dependency&gt; &lt;groupId&gt;javax.servlet.jsp&lt;/groupId&gt; &lt;artifactId&gt;jsp-api&lt;/artifactId&gt; &lt;version&gt;2.1&lt;/version&gt; &lt;scope&gt;provided&lt;/scope&gt; &lt;/dependency&gt; &lt;!--springçš„åæ ‡--&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-context&lt;/artifactId&gt; &lt;version&gt;5.1.9.RELEASE&lt;/version&gt; &lt;/dependency&gt; &lt;!--springmvcçš„åæ ‡--&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-webmvc&lt;/artifactId&gt; &lt;version&gt;5.1.9.RELEASE&lt;/version&gt; &lt;/dependency&gt;&lt;/dependencies&gt;&lt;!--æ„å»º--&gt;&lt;build&gt; &lt;!--è®¾ç½®æ’ä»¶--&gt; &lt;plugins&gt; &lt;!--å…·ä½“çš„æ’ä»¶é…ç½®--&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.tomcat.maven&lt;/groupId&gt; &lt;artifactId&gt;tomcat7-maven-plugin&lt;/artifactId&gt; &lt;version&gt;2.1&lt;/version&gt; &lt;configuration&gt; &lt;port&gt;80&lt;/port&gt; &lt;path&gt;/&lt;/path&gt; &lt;/configuration&gt; &lt;/plugin&gt; &lt;/plugins&gt;&lt;/build&gt; è®¾å®šå…·ä½“ Controllerï¼Œæ§åˆ¶å±‚ java &#x2F; controller &#x2F; UserController 1234567891011@Controller //@Componentè¡ç”Ÿæ³¨è§£public class UserController &#123; //è®¾å®šå½“å‰æ–¹æ³•çš„è®¿é—®æ˜ å°„åœ°å€ï¼Œç­‰åŒäºServletåœ¨web.xmlä¸­çš„é…ç½® @RequestMapping(&quot;/save&quot;) //è®¾ç½®å½“å‰æ–¹æ³•è¿”å›å€¼ç±»å‹ä¸ºStringï¼Œç”¨äºæŒ‡å®šè¯·æ±‚å®Œæˆåè·³è½¬çš„é¡µé¢ public String save()&#123; System.out.println(&quot;user mvc controller is running ...&quot;); //è®¾å®šå…·ä½“è·³è½¬çš„é¡µé¢ return &quot;success.jsp&quot;; &#125;&#125; webapp &#x2F; WEB-INF &#x2F; web.xmlï¼Œé…ç½®SpringMVCæ ¸å¿ƒæ§åˆ¶å™¨ï¼Œè¯·æ±‚è½¬å‘åˆ°å¯¹åº”çš„å…·ä½“ä¸šåŠ¡å¤„ç†å™¨Controllerä¸­ï¼ˆç­‰åŒäºServleté…ç½®ï¼‰ 1234567891011121314151617181920&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;web-app xmlns=&quot;http://xmlns.jcp.org/xml/ns/javaee&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd&quot; version=&quot;3.1&quot;&gt; &lt;!--é…ç½®Servlet--&gt; &lt;servlet&gt; &lt;servlet-name&gt;DispatcherServlet&lt;/servlet-name&gt; &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt; &lt;!--åŠ è½½Springæ§åˆ¶æ–‡ä»¶--&gt; &lt;init-param&gt; &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt; &lt;param-value&gt;classpath*:spring-mvc.xml&lt;/param-value&gt; &lt;/init-param&gt; &lt;/servlet&gt; &lt;servlet-mapping&gt; &lt;servlet-name&gt;DispatcherServlet&lt;/servlet-name&gt; &lt;url-pattern&gt;/&lt;/url-pattern&gt; &lt;/servlet-mapping&gt;&lt;/web-app&gt; resouces &#x2F; spring-mvc.xml 1234567891011121314&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:context=&quot;http://www.springframework.org/schema/context&quot; xmlns:mvc=&quot;http://www.springframework.org/schema/mvc&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd&quot;&gt; &lt;!--æ‰«æåŠ è½½æ‰€æœ‰çš„æ§åˆ¶ç±»--&gt; &lt;context:component-scan base-package=&quot;controller&quot;/&gt;&lt;/beans&gt; åŠ è½½æ§åˆ¶Controller åŠ è½½æ§åˆ¶ï¼šSpringMVC çš„å¤„ç†å™¨å¯¹åº”çš„ bean å¿…é¡»æŒ‰ç…§è§„èŒƒæ ¼å¼å¼€å‘ï¼Œæœªé¿å…åŠ å…¥æ— æ•ˆçš„ bean å¯é€šè¿‡ bean åŠ è½½è¿‡æ»¤å™¨è¿›è¡ŒåŒ…å«è®¾å®šæˆ–æ’é™¤è®¾å®šï¼Œè¡¨ç°å±‚ bean æ ‡æ³¨é€šå¸¸è®¾å®šä¸º @Controller resources &#x2F; spring-mvc.xml é…ç½® 12345&lt;context:component-scan base-package=&quot;com.seazean&quot;&gt; &lt;context:include-filter type=&quot;annotation&quot; expression=&quot;org.springframework.stereotype.Controller&quot;/&gt;&lt;/context:component-scan&gt; é™æ€èµ„æºåŠ è½½ï¼ˆwebapp ç›®å½•ä¸‹çš„ç›¸å…³èµ„æºï¼‰ï¼Œspring-mvc.xml é…ç½®ï¼Œå¼€å¯ mvc å‘½åç©ºé—´ 1234567&lt;!--æ”¾è¡ŒæŒ‡å®šç±»å‹é™æ€èµ„æºé…ç½®æ–¹å¼--&gt;&lt;mvc:resources mapping=&quot;/img/**&quot; location=&quot;/img/&quot;/&gt; &lt;!--webapp/img/èµ„æº--&gt;&lt;mvc:resources mapping=&quot;/js/**&quot; location=&quot;/js/&quot;/&gt;&lt;mvc:resources mapping=&quot;/css/**&quot; location=&quot;/css/&quot;/&gt;&lt;!--SpringMVC æä¾›çš„é€šç”¨èµ„æºæ”¾è¡Œæ–¹å¼ï¼Œå»ºè®®é€‰æ‹©--&gt;&lt;mvc:default-servlet-handler/&gt; ä¸­æ–‡ä¹±ç å¤„ç† SpringMVC æä¾›ä¸“ç”¨çš„ä¸­æ–‡å­—ç¬¦è¿‡æ»¤å™¨ï¼Œç”¨äºå¤„ç†ä¹±ç é—®é¢˜ã€‚é…ç½®åœ¨ web.xml é‡Œé¢ 12345678910111213&lt;!--ä¹±ç å¤„ç†è¿‡æ»¤å™¨ï¼Œä¸Servletä¸­ä½¿ç”¨çš„å®Œå…¨ç›¸åŒï¼Œå·®å¼‚ä¹‹å¤„åœ¨äºå¤„ç†å™¨çš„ç±»ç”±Springæä¾›--&gt;&lt;filter&gt; &lt;filter-name&gt;CharacterEncodingFilter&lt;/filter-name&gt; &lt;filter-class&gt;org.springframework.web.filter.CharacterEncodingFilter&lt;/filter-class&gt; &lt;init-param&gt; &lt;param-name&gt;encoding&lt;/param-name&gt; &lt;param-value&gt;UTF-8&lt;/param-value&gt; &lt;/init-param&gt;&lt;/filter&gt;&lt;filter-mapping&gt; &lt;filter-name&gt;CharacterEncodingFilter&lt;/filter-name&gt; &lt;url-pattern&gt;/*&lt;/url-pattern&gt;&lt;/filter-mapping&gt; æ³¨è§£é©±åŠ¨WebApplicationContextï¼Œç”Ÿæˆ Spring æ ¸å¿ƒå®¹å™¨ï¼ˆä¸»å®¹å™¨&#x2F;çˆ¶å®¹å™¨&#x2F;æ ¹å®¹å™¨ï¼‰ çˆ¶å®¹å™¨ï¼šSpring ç¯å¢ƒåŠ è½½åå½¢æˆçš„å®¹å™¨ï¼ŒåŒ…å« Spring ç¯å¢ƒä¸‹çš„æ‰€æœ‰çš„ bean å­å®¹å™¨ï¼šå½“å‰ mvc ç¯å¢ƒåŠ è½½åå½¢æˆçš„å®¹å™¨ï¼Œä¸åŒ…å« Spring ç¯å¢ƒä¸‹çš„ bean å­å®¹å™¨å¯ä»¥è®¿é—®çˆ¶å®¹å™¨ä¸­çš„èµ„æºï¼Œçˆ¶å®¹å™¨ä¸å¯ä»¥è®¿é—®å­å®¹å™¨çš„èµ„æº EnableWebMvc æ³¨è§£ä½œç”¨ï¼š æ”¯æŒ ConversionService çš„é…ç½®ï¼Œå¯ä»¥æ–¹ä¾¿é…ç½®è‡ªå®šä¹‰ç±»å‹è½¬æ¢å™¨ æ”¯æŒ @NumberFormat æ³¨è§£æ ¼å¼åŒ–æ•°å­—ç±»å‹ æ”¯æŒ @DateTimeFormat æ³¨è§£æ ¼å¼åŒ–æ—¥æœŸæ•°æ®ï¼Œæ—¥æœŸåŒ…æ‹¬ Dateã€Calendar æ”¯æŒ @Valid çš„å‚æ•°æ ¡éªŒï¼ˆéœ€è¦å¯¼å…¥ JSR-303 è§„èŒƒï¼‰ é…åˆç¬¬ä¸‰æ–¹ jar åŒ…å’Œ SpringMVC æä¾›çš„æ³¨è§£è¯»å†™ XML å’Œ JSON æ ¼å¼æ•°æ® çº¯æ³¨è§£å¼€å‘ï¼š ä½¿ç”¨æ³¨è§£å½¢å¼è½¬åŒ– SpringMVC æ ¸å¿ƒé…ç½®æ–‡ä»¶ä¸ºé…ç½®ç±» java &#x2F; config &#x2F; SpringMVCConfiguration.java 1234567891011121314@Configuration@ComponentScan(value = &quot;com.seazean&quot;, includeFilters = @ComponentScan.Filter( type=FilterType.ANNOTATION, classes = &#123;Controller.class&#125; ) )//ç­‰åŒäº&lt;mvc:annotation-driven/&gt;ï¼Œè¿˜ä¸å®Œå…¨ç›¸åŒ@EnableWebMvcpublic class SpringMVCConfiguration implements WebMvcConfigurer&#123; //æ³¨è§£é…ç½®é€šç”¨æ”¾è¡Œèµ„æºçš„æ ¼å¼ å»ºè®®ä½¿ç”¨ @Override public void configureDefaultServletHandling(DefaultServletHandlerConfigurer configurer) &#123; configurer.enable(); &#125;&#125; åŸºäº servlet3.0 è§„èŒƒï¼Œè‡ªå®šä¹‰ Servlet å®¹å™¨åˆå§‹åŒ–é…ç½®ç±»ï¼ŒåŠ è½½ SpringMVC æ ¸å¿ƒé…ç½®ç±» 1234567891011121314151617181920212223242526272829303132333435public class ServletContainersInitConfig extends AbstractDispatcherServletInitializer &#123; //åˆ›å»ºServletå®¹å™¨æ—¶ï¼Œä½¿ç”¨æ³¨è§£æ–¹å¼åŠ è½½SPRINGMVCé…ç½®ç±»ä¸­çš„ä¿¡æ¯ï¼Œ //å¹¶åŠ è½½æˆWEBä¸“ç”¨çš„ApplicationContextå¯¹è±¡è¯¥å¯¹è±¡æ”¾å…¥äº†ServletContextèŒƒå›´ï¼Œ //åœ¨æ•´ä¸ªWEBå®¹å™¨ä¸­å¯ä»¥éšæ—¶è·å–è°ƒç”¨ @Override protected WebApplicationContext createServletApplicationContext() &#123; A.C.W.A ctx = new AnnotationConfigWebApplicationContext(); ctx.register(SpringMVCConfiguration.class); return ctx; &#125; //æ³¨è§£é…ç½®æ˜ å°„åœ°å€æ–¹å¼ï¼ŒæœåŠ¡äºSpringMVCçš„æ ¸å¿ƒæ§åˆ¶å™¨DispatcherServlet @Override protected String[] getServletMappings() &#123; return new String[]&#123;&quot;/&quot;&#125;; &#125; @Override protected WebApplicationContext createRootApplicationContext() &#123; return null; &#125; //ä¹±ç å¤„ç†ä½œä¸ºè¿‡æ»¤å™¨ï¼Œåœ¨servletå®¹å™¨å¯åŠ¨æ—¶è¿›è¡Œé…ç½® @Override public void onStartup(ServletContext servletContext) throws ServletException &#123; super.onStartup(servletContext); CharacterEncodingFilter cef = new CharacterEncodingFilter(); cef.setEncoding(&quot;UTF-8&quot;); FilterRegistration.Dynamic registration = servletContext.addFilter(&quot;characterEncodingFilter&quot;, cef); registration.addMappingForUrlPatterns(EnumSet.of( DispatcherType.REQUEST, DispatcherType.FORWARD, DispatcherType.INCLUDE), false,&quot;/*&quot;); &#125;&#125; è¯·æ±‚æ˜ å°„åç§°ï¼š@RequestMapping ç±»å‹ï¼šæ–¹æ³•æ³¨è§£ã€ç±»æ³¨è§£ ä½ç½®ï¼šå¤„ç†å™¨ç±»ä¸­çš„æ–¹æ³•å®šä¹‰ä¸Šæ–¹ã€å¤„ç†å™¨ç±»å®šä¹‰ä¸Šæ–¹ æ–¹æ³•æ³¨è§£ ä½œç”¨ï¼šç»‘å®šè¯·æ±‚åœ°å€ä¸å¯¹åº”å¤„ç†æ–¹æ³•é—´çš„å…³ç³» æ— ç±»æ˜ å°„åœ°å€è®¿é—®æ ¼å¼ï¼š http://localhost/requestURL2 1234567@Controllerpublic class UserController &#123; @RequestMapping(&quot;/requestURL2&quot;) public String requestURL2() &#123; return &quot;page.jsp&quot;; &#125;&#125; ç±»æ³¨è§£ ä½œç”¨ï¼šä¸ºå½“å‰å¤„ç†å™¨ä¸­æ‰€æœ‰æ–¹æ³•è®¾å®šå…¬å…±çš„è®¿é—®è·¯å¾„å‰ç¼€ å¸¦æœ‰ç±»æ˜ å°„åœ°å€è®¿é—®æ ¼å¼ï¼Œå°†ç±»æ˜ å°„åœ°å€ä½œä¸ºå‰ç¼€æ·»åŠ åœ¨å®é™…æ˜ å°„åœ°å€å‰é¢ï¼š**&#x2F;user&#x2F;requestURL1** æœ€ç»ˆè¿”å›çš„é¡µé¢å¦‚æœæœªè®¾å®šç»å¯¹è®¿é—®è·¯å¾„ï¼Œå°†ä»ç±»æ˜ å°„åœ°å€æ‰€åœ¨ç›®å½•ä¸­æŸ¥æ‰¾ webapp&#x2F;user&#x2F;page.jsp 12345678@Controller@RequestMapping(&quot;/user&quot;)public class UserController &#123; @RequestMapping(&quot;/requestURL2&quot;) public String requestURL2() &#123; return &quot;page.jsp&quot;; &#125;&#125; å¸¸ç”¨å±æ€§ 1234567891011@RequestMapping( value=&quot;/requestURL3&quot;, //è®¾å®šè¯·æ±‚è·¯å¾„ï¼Œä¸pathå±æ€§ã€ valueå±æ€§ç›¸åŒ method = RequestMethod.GET, //è®¾å®šè¯·æ±‚æ–¹å¼ params = &quot;name&quot;, //è®¾å®šè¯·æ±‚å‚æ•°æ¡ä»¶ headers = &quot;content-type=text/*&quot;, //è®¾å®šè¯·æ±‚æ¶ˆæ¯å¤´æ¡ä»¶ consumes = &quot;text/*&quot;, //ç”¨äºæŒ‡å®šå¯ä»¥æ¥æ”¶çš„è¯·æ±‚æ­£æ–‡ç±»å‹ï¼ˆMIMEç±»å‹ï¼‰ produces = &quot;text/*&quot; //ç”¨äºæŒ‡å®šå¯ä»¥ç”Ÿæˆçš„å“åº”æ­£æ–‡ç±»å‹ï¼ˆMIMEç±»å‹ï¼‰)public String requestURL3() &#123; return &quot;/page.jsp&quot;;&#125; åŸºæœ¬æ“ä½œè¯·æ±‚å¤„ç†æ™®é€šç±»å‹SpringMVC å°†ä¼ é€’çš„å‚æ•°å°è£…åˆ°å¤„ç†å™¨æ–¹æ³•çš„å½¢å‚ä¸­ï¼Œè¾¾åˆ°å¿«é€Ÿè®¿é—®å‚æ•°çš„ç›®çš„ è®¿é—® URLï¼šhttp://localhost/requestParam1?name=seazean&amp;age=14 12345678@Controllerpublic class UserController &#123; @RequestMapping(&quot;/requestParam1&quot;) public String requestParam1(String name ,int age)&#123; System.out.println(&quot;name=&quot; + name + &quot;,age=&quot; + age); return &quot;page.jsp&quot;; &#125;&#125; 123456&lt;%@page pageEncoding=&quot;UTF-8&quot; language=&quot;java&quot; contentType=&quot;text/html;UTF-8&quot; %&gt;&lt;html&gt;&lt;body&gt; &lt;h1&gt;è¯·æ±‚å‚æ•°æµ‹è¯•é¡µé¢&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt; @RequestParam çš„ä½¿ç”¨ï¼š ç±»å‹ï¼šå½¢å‚æ³¨è§£ ä½ç½®ï¼šå¤„ç†å™¨ç±»ä¸­çš„æ–¹æ³•å½¢å‚å‰æ–¹ ä½œç”¨ï¼šç»‘å®šè¯·æ±‚å‚æ•°ä¸å¯¹åº”å¤„ç†æ–¹æ³•å½¢å‚é—´çš„å…³ç³» è®¿é—® URLï¼šhttp://localhost/requestParam2?userName=Jock 12345678@RequestMapping(&quot;/requestParam2&quot;)public String requestParam2(@RequestParam( name = &quot;userName&quot;, required = true, //ä¸ºtrueä»£è¡¨å¿…é¡»æœ‰å‚æ•° defaultValue = &quot;s&quot;) String name)&#123; System.out.println(&quot;name=&quot; + name); return &quot;page.jsp&quot;;&#125; POJOç±»å‹ç®€å•ç±»å‹å½“ POJO ä¸­ä½¿ç”¨ç®€å•ç±»å‹å±æ€§æ—¶ï¼Œ å‚æ•°åç§°ä¸ POJO ç±»å±æ€§åä¿æŒä¸€è‡´ è®¿é—® URLï¼š http://localhost/requestParam3?name=seazean&amp;age=14 12345@RequestMapping(&quot;/requestParam3&quot;)public String requestParam3(User user)&#123; System.out.println(&quot;name=&quot; + user.getName()); return &quot;page.jsp&quot;;&#125; 12345public class User &#123; private String name; private Integer age; //......&#125; å‚æ•°å†²çªå½“ POJO ç±»å‹å±æ€§ä¸å…¶ä»–å½¢å‚å‡ºç°åŒåé—®é¢˜æ—¶ï¼Œå°†è¢«åŒæ—¶èµ‹å€¼ï¼Œå»ºè®®ä½¿ç”¨ @RequestParam æ³¨è§£è¿›è¡ŒåŒºåˆ† è®¿é—® URLï¼š http://localhost/requestParam4?name=seazean&amp;age=14 12345@RequestMapping(&quot;/requestParam4&quot;)public String requestParam4(User user, String age)&#123; System.out.println(&quot;user.age=&quot; + user.getAge() + &quot;,age=&quot; + age);//14 14 return &quot;page.jsp&quot;;&#125; å¤æ‚ç±»å‹å½“ POJO ä¸­å‡ºç°å¯¹è±¡å±æ€§æ—¶ï¼Œå‚æ•°åç§°ä¸å¯¹è±¡å±‚æ¬¡ç»“æ„åç§°ä¿æŒä¸€è‡´ è®¿é—® URLï¼š http://localhost/requestParam5?address.province=beijing 12345@RequestMapping(&quot;/requestParam5&quot;)public String requestParam5(User user)&#123; System.out.println(&quot;user.address=&quot; + user.getAddress().getProvince()); return &quot;page.jsp&quot;;&#125; 12345public class User &#123; private String name; private Integer age; private Address address; //....&#125; 12345public class Address &#123; private String province; private String city; private String address;&#125; å®¹å™¨ç±»å‹POJO ä¸­å‡ºç°é›†åˆç±»å‹çš„å¤„ç†æ–¹å¼ é€šè¿‡ URL åœ°å€ä¸­åŒåå‚æ•°ï¼Œå¯ä»¥ä¸º POJO ä¸­çš„é›†åˆå±æ€§è¿›è¡Œèµ‹å€¼ï¼Œé›†åˆå±æ€§è¦æ±‚ä¿å­˜ç®€å•æ•°æ® è®¿é—® URLï¼šhttp://localhost/requestParam6?nick=Jock1&amp;nick=Jockme&amp;nick=zahc 123456@RequestMapping(&quot;/requestParam6&quot;)public String requestParam6(User user)&#123; System.out.println(&quot;user=&quot; + user); //user = User&#123;name=&#x27;null&#x27;,age=null,nick=&#123;Jock1,Jockme,zahc&#125;&#125; return &quot;page.jsp&quot;;&#125; 12345public class User &#123; private String name; private Integer age; private List&lt;String&gt; nick;&#125; POJO ä¸­å‡ºç° List ä¿å­˜å¯¹è±¡æ•°æ®ï¼Œå‚æ•°åç§°ä¸å¯¹è±¡å±‚æ¬¡ç»“æ„åç§°ä¿æŒä¸€è‡´ï¼Œä½¿ç”¨æ•°ç»„æ ¼å¼æè¿°é›†åˆä¸­å¯¹è±¡çš„ä½ç½®è®¿é—® URLï¼šhttp://localhost/requestParam7?addresses[0].province=bj&amp;addresses[1].province=tj 123456@RequestMapping(&quot;/requestParam7&quot;)public String requestParam7(User user)&#123; System.out.println(&quot;user.addresses=&quot; + user.getAddress()); //&#123;Address&#123;provice=bj,city=&#x27;null&#x27;,address=&#x27;null&#x27;&#125;&#125;,&#123;Address&#123;....&#125;&#125; return &quot;page.jsp&quot;;&#125; 12345public class User &#123; private String name; private Integer age; private List&lt;Address&gt; addresses;&#125; POJO ä¸­å‡ºç° Map ä¿å­˜å¯¹è±¡æ•°æ®ï¼Œå‚æ•°åç§°ä¸å¯¹è±¡å±‚æ¬¡ç»“æ„åç§°ä¿æŒä¸€è‡´ï¼Œä½¿ç”¨æ˜ å°„æ ¼å¼æè¿°é›†åˆä¸­å¯¹è±¡ä½ç½® URL: http://localhost/requestParam8?addressMap[â€™homeâ€™].province=bj&amp;addressMap[â€™jobâ€™].province=tj 123456@RequestMapping(&quot;/requestParam8&quot;)public String requestParam8(User user)&#123; System.out.println(&quot;user.addressMap=&quot; + user.getAddressMap()); //user.addressMap=&#123;home=Address&#123;p=,c=,a=&#125;,job=Address&#123;....&#125;&#125; return &quot;page.jsp&quot;;&#125; 1234public class User &#123; private Map&lt;String,Address&gt; addressMap; //....&#125; æ•°ç»„é›†åˆæ•°ç»„ç±»å‹è¯·æ±‚å‚æ•°åä¸å¤„ç†å™¨æ–¹æ³•å½¢å‚åä¿æŒä¸€è‡´ï¼Œä¸”è¯·æ±‚å‚æ•°æ•°é‡ï¼ 1ä¸ª è®¿é—® URLï¼š http://localhost/requestParam9?nick=Jockme&amp;nick=zahc 12345@RequestMapping(&quot;/requestParam9&quot;)public String requestParam9(String[] nick)&#123; System.out.println(nick[0] + &quot;,&quot; + nick[1]); return &quot;page.jsp&quot;;&#125; é›†åˆç±»å‹ä¿å­˜ç®€å•ç±»å‹æ•°æ®ï¼Œè¯·æ±‚å‚æ•°åä¸å¤„ç†å™¨æ–¹æ³•å½¢å‚åä¿æŒä¸€è‡´ï¼Œä¸”è¯·æ±‚å‚æ•°æ•°é‡ï¼ 1ä¸ª è®¿é—® URLï¼š http://localhost/requestParam10?nick=Jockme&amp;nick=zahc 12345@RequestMapping(&quot;/requestParam10&quot;)public String requestParam10(@RequestParam(&quot;nick&quot;) List&lt;String&gt; nick)&#123; System.out.println(nick); return &quot;page.jsp&quot;;&#125; æ³¨æ„ï¼š SpringMVC é»˜è®¤å°† List ä½œä¸ºå¯¹è±¡å¤„ç†ï¼Œèµ‹å€¼å‰å…ˆåˆ›å»ºå¯¹è±¡ï¼Œç„¶åå°† nick ä½œä¸ºå¯¹è±¡çš„å±æ€§è¿›è¡Œå¤„ç†ã€‚List æ˜¯æ¥å£æ— æ³•åˆ›å»ºå¯¹è±¡ï¼ŒæŠ¥æ— æ³•æ‰¾åˆ°æ„é€ æ–¹æ³•å¼‚å¸¸ï¼›ä¿®å¤ç±»å‹ä¸ºå¯åˆ›å»ºå¯¹è±¡çš„ ArrayList ç±»å‹åï¼Œå¯¹è±¡å¯ä»¥åˆ›å»ºä½†æ²¡æœ‰ nick å±æ€§ï¼Œå› æ­¤æ•°æ®ä¸ºç©ºè§£å†³æ–¹æ³•ï¼šéœ€è¦å‘ŠçŸ¥ SpringMVC çš„å¤„ç†å™¨ nick æ˜¯ä¸€ç»„æ•°æ®ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå•ä¸€å±æ€§ã€‚é€šè¿‡ @RequestParam æ³¨è§£ï¼Œå°†æ•°é‡å¤§äº 1 ä¸ª names å‚æ•°æ‰“åŒ…æˆå‚æ•°æ•°ç»„åï¼Œ SpringMVC æ‰èƒ½è¯†åˆ«è¯¥æ•°æ®æ ¼å¼ï¼Œå¹¶åˆ¤å®šå½¢å‚ç±»å‹æ˜¯å¦ä¸ºæ•°ç»„æˆ–é›†åˆï¼Œå¹¶æŒ‰æ•°ç»„æˆ–é›†åˆå¯¹è±¡çš„å½¢å¼æ“ä½œæ•°æ® è½¬æ¢å™¨ç±»å‹å¼€å¯è½¬æ¢é…ç½®ï¼š&lt;mvc:annotation-driven /&gt; ä½œç”¨ï¼šæä¾› Controller è¯·æ±‚è½¬å‘ï¼ŒJson è‡ªåŠ¨è½¬æ¢ç­‰åŠŸèƒ½ å¦‚æœè®¿é—® URLï¼šhttp://localhost/requestParam1?name=seazean&amp;age=seazeanï¼Œä¼šå‡ºç°æŠ¥é”™ï¼Œç±»å‹è½¬åŒ–å¼‚å¸¸ 12345@RequestMapping(&quot;/requestParam1&quot;)public String requestParam1(String name ,int age)&#123; System.out.println(&quot;name=&quot; + name + &quot;,age=&quot; + age); return &quot;page.jsp&quot;;&#125; SpringMVC å¯¹æ¥æ”¶çš„æ•°æ®è¿›è¡Œè‡ªåŠ¨ç±»å‹è½¬æ¢ï¼Œè¯¥å·¥ä½œé€šè¿‡ Converter æ¥å£å®ç°ï¼š æ ‡é‡è½¬æ¢å™¨ é›†åˆã€æ•°ç»„ç›¸å…³è½¬æ¢å™¨ é»˜è®¤è½¬æ¢å™¨ æ—¥æœŸ å¦‚æœè®¿é—® URLï¼šhttp://localhost/requestParam11?date=1999-09-09 ä¼šæŠ¥é”™ï¼Œæ‰€ä»¥éœ€è¦æ—¥æœŸç±»å‹è½¬æ¢ å£°æ˜è‡ªå®šä¹‰çš„è½¬æ¢æ ¼å¼å¹¶è¦†ç›–ç³»ç»Ÿè½¬æ¢æ ¼å¼ï¼Œé…ç½® resources &#x2F; spring-mvc.xml 12345678910111213141516&lt;!--5.å¯ç”¨è‡ªå®šä¹‰Converter--&gt;&lt;mvc:annotation-driven conversion-service=&quot;conversionService&quot;/&gt;&lt;!--1.è®¾å®šæ ¼å¼ç±»å‹Converterï¼Œæ³¨å†Œä¸ºBeanï¼Œå—SpringMVCç®¡ç†--&gt;&lt;bean id=&quot;conversionService&quot; class=&quot;org.springframework.format.support.FormattingConversionServiceFactoryBean&quot;&gt; &lt;!--2.è‡ªå®šä¹‰Converteræ ¼å¼ç±»å‹è®¾å®šï¼Œè¯¥è®¾å®šä½¿ç”¨çš„æ˜¯åŒç±»å‹è¦†ç›–çš„æ€æƒ³--&gt; &lt;property name=&quot;formatters&quot;&gt; &lt;!--3.ä½¿ç”¨setä¿éšœç›¸åŒç±»å‹çš„è½¬æ¢å™¨ä»…ä¿ç•™ä¸€ä¸ªï¼Œé¿å…å†²çª--&gt; &lt;set&gt; &lt;!--4.è®¾ç½®å…·ä½“çš„æ ¼å¼ç±»å‹--&gt; &lt;bean class=&quot;org.springframework.format.datetime.DateFormatter&quot;&gt; &lt;!--5.ç±»å‹è§„åˆ™--&gt; &lt;property name=&quot;pattern&quot; value=&quot;yyyy-MM-dd&quot;/&gt; &lt;/bean&gt; &lt;/set&gt; &lt;/property&gt;&lt;/bean&gt; @DateTimeFormatç±»å‹ï¼šå½¢å‚æ³¨è§£ã€æˆå‘˜å˜é‡æ³¨è§£ä½ç½®ï¼šå½¢å‚å‰é¢ æˆ– æˆå‘˜å˜é‡ä¸Šæ–¹ä½œç”¨ï¼šä¸ºå½“å‰å‚æ•°æˆ–å˜é‡æŒ‡å®šç±»å‹è½¬æ¢è§„åˆ™ 1234public String requestParam12(@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;) Date date)&#123; System.out.println(&quot;date=&quot; + date); return &quot;page.jsp&quot;;&#125; 12@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)private Date date; ä¾èµ–æ³¨è§£é©±åŠ¨æ”¯æŒï¼Œxml å¼€å¯é…ç½®ï¼š 1&lt;mvc:annotation-driven /&gt; è‡ªå®šä¹‰è‡ªå®šä¹‰ç±»å‹è½¬æ¢å™¨ï¼Œå®ç° Converter æ¥å£æˆ–è€…ç›´æ¥å®¹å™¨ä¸­æ³¨å…¥ï¼š æ–¹å¼ä¸€ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344 public class WebConfig implements WebMvcConfigurer &#123; @Bean public WebMvcConfigurer webMvcConfigurer() &#123; return new WebMvcConfigurer() &#123; @Override public void addFormatters(FormatterRegistry registry) &#123; registry.addConverter(new Converter&lt;String, Date&gt;() &#123; @Override public Pet convert(String source) &#123; DateFormat df = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;); Date date = null; //ç±»å‹è½¬æ¢å™¨æ— æ³•é¢„è®¡ä½¿ç”¨è¿‡ç¨‹ä¸­å‡ºç°çš„å¼‚å¸¸ï¼Œå› æ­¤å¿…é¡»åœ¨ç±»å‹è½¬æ¢å™¨å†…éƒ¨æ•è·ï¼Œ //ä¸å…è®¸æŠ›å‡ºï¼Œæ¡†æ¶æ— æ³•é¢„è®¡æ­¤ç±»å¼‚å¸¸å¦‚ä½•å¤„ç† try &#123; date = df.parse(source); &#125; catch (ParseException e) &#123; e.printStackTrace(); &#125; return date; &#125; &#125;); &#125; &#125; &#125;* æ–¹å¼äºŒï¼š ```java //æœ¬ä¾‹ä¸­çš„æ³›å‹å¡«å†™çš„æ˜¯Stringï¼ŒDateï¼Œæœ€ç»ˆå‡ºç°å­—ç¬¦ä¸²è½¬æ—¥æœŸæ—¶ï¼Œè¯¥ç±»å‹è½¬æ¢å™¨ç”Ÿæ•ˆ public class MyDateConverter implements Converter&lt;String, Date&gt; &#123; //é‡å†™æ¥å£çš„æŠ½è±¡æ–¹æ³•ï¼Œå‚æ•°ç”±æ³›å‹å†³å®š public Date convert(String source) &#123; DateFormat df = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;); Date date = null; //ç±»å‹è½¬æ¢å™¨æ— æ³•é¢„è®¡ä½¿ç”¨è¿‡ç¨‹ä¸­å‡ºç°çš„å¼‚å¸¸ï¼Œå› æ­¤å¿…é¡»åœ¨ç±»å‹è½¬æ¢å™¨å†…éƒ¨æ•è·ï¼Œ //ä¸å…è®¸æŠ›å‡ºï¼Œæ¡†æ¶æ— æ³•é¢„è®¡æ­¤ç±»å¼‚å¸¸å¦‚ä½•å¤„ç† try &#123; date = df.parse(source); &#125; catch (ParseException e) &#123; e.printStackTrace(); &#125; return date; &#125; &#125; é…ç½® resources &#x2F; spring-mvc.xmlï¼Œæ³¨å†Œè‡ªå®šä¹‰è½¬æ¢å™¨ï¼Œå°†åŠŸèƒ½åŠ å…¥åˆ° SpringMVC è½¬æ¢æœåŠ¡ ConverterService ä¸­ 1234567891011121314151617&lt;!--1.å°†è‡ªå®šä¹‰Converteræ³¨å†Œä¸ºBeanï¼Œå—SpringMVCç®¡ç†--&gt;&lt;bean id=&quot;myDateConverter&quot; class=&quot;converter.MyDateConverter&quot;/&gt;&lt;!--2.è®¾å®šè‡ªå®šä¹‰ConverteræœåŠ¡bean--&gt;&lt;bean id=&quot;conversionService&quot; class=&quot;org.springframework.context.support.ConversionServiceFactoryBean&quot;&gt; &lt;!--3.æ³¨å…¥æ‰€æœ‰çš„è‡ªå®šä¹‰Converterï¼Œè¯¥è®¾å®šä½¿ç”¨çš„æ˜¯åŒç±»å‹è¦†ç›–çš„æ€æƒ³--&gt; &lt;property name=&quot;converters&quot;&gt; &lt;!--4.setä¿éšœåŒç±»å‹è½¬æ¢å™¨ä»…ä¿ç•™ä¸€ä¸ªï¼Œå»é‡è§„åˆ™ä»¥Converter&lt;S,T&gt;çš„æ³›å‹ä¸ºå‡†--&gt; &lt;set&gt; &lt;!--5.å…·ä½“çš„ç±»å‹è½¬æ¢å™¨--&gt; &lt;ref bean=&quot;myDateConverter&quot;/&gt; &lt;/set&gt; &lt;/property&gt;&lt;/bean&gt;&lt;!--å¼€å¯æ³¨è§£é©±åŠ¨ï¼ŒåŠ è½½è‡ªå®šä¹‰æ ¼å¼åŒ–è½¬æ¢å™¨å¯¹åº”çš„ç±»å‹è½¬æ¢æœåŠ¡--&gt;&lt;mvc:annotation-driven conversion-service=&quot;conversionService&quot;/&gt; ä½¿ç”¨è½¬æ¢å™¨ 12345@RequestMapping(&quot;/requestParam12&quot;)public String requestParam12(Date date)&#123; System.out.println(date); return &quot;page.jsp&quot;;&#125; å“åº”å¤„ç†é¡µé¢è·³è½¬è¯·æ±‚è½¬å‘å’Œé‡å®šå‘ï¼š è¯·æ±‚è½¬å‘ï¼š 12345678@Controllerpublic class UserController &#123; @RequestMapping(&quot;/showPage1&quot;) public String showPage1() &#123; System.out.println(&quot;user mvc controller is running ...&quot;); return &quot;forward:/WEB-INF/page/page.jsp; &#125;&#125; è¯·æ±‚é‡å®šå‘ï¼š 12345@RequestMapping(&quot;/showPage2&quot;)public String showPage2() &#123; System.out.println(&quot;user mvc controller is running ...&quot;); return &quot;redirect:/WEB-INF/page/page.jsp&quot;;//ä¸èƒ½è®¿é—®WEB-INFä¸‹çš„èµ„æº&#125; é¡µé¢è®¿é—®å¿«æ·è®¾å®šï¼ˆInternalResourceViewResolverï¼‰ï¼š å±•ç¤ºé¡µé¢çš„ä¿å­˜ä½ç½®é€šå¸¸å›ºå®šä¸”ç»“æ„ç›¸ä¼¼ï¼Œå¯ä»¥è®¾å®šé€šç”¨çš„è®¿é—®è·¯å¾„ç®€åŒ–é¡µé¢é…ç½®ï¼Œé…ç½® spring-mvc.xmlï¼š 1234&lt;bean class=&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;&gt; &lt;property name=&quot;prefix&quot; value=&quot;/WEB-INF/pages/&quot;/&gt; &lt;property name=&quot;suffix&quot; value=&quot;.jsp&quot;/&gt;&lt;/bean&gt; ç®€åŒ– 12345678910111213141516@RequestMapping(&quot;/showPage3&quot;)public String showPage3() &#123; System.out.println(&quot;user mvc controller is running...&quot;); return &quot;page&quot;;&#125;@RequestMapping(&quot;/showPage4&quot;)public String showPage4() &#123; System.out.println(&quot;user mvc controller is running...&quot;); return &quot;forward:page&quot;;&#125;@RequestMapping(&quot;/showPage5&quot;)public String showPage5() &#123; System.out.println(&quot;user mvc controller is running...&quot;); return &quot;redirect:page&quot;;&#125; å¦‚æœæœªè®¾å®šäº†è¿”å›å€¼ï¼Œä½¿ç”¨ void ç±»å‹ï¼Œåˆ™é»˜è®¤ä½¿ç”¨è®¿é—®è·¯å¾„ä½œé¡µé¢åœ°å€çš„å‰ç¼€åç¼€ 12345//æœ€ç®€é¡µé¢é…ç½®æ–¹å¼ï¼Œä½¿ç”¨è®¿é—®è·¯å¾„ä½œä¸ºé¡µé¢åç§°ï¼Œçœç•¥è¿”å›å€¼@RequestMapping(&quot;/showPage6&quot;)public void showPage6() &#123; System.out.println(&quot;user mvc controller is running ...&quot;);&#125; æ•°æ®è·³è½¬ModelAndView æ˜¯ SpringMVC æä¾›çš„ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯ä»¥ç”¨ä½œæ§åˆ¶å™¨æ–¹æ³•çš„è¿”å›å€¼ï¼ˆModel åŒï¼‰ï¼Œå®ç°æºå¸¦æ•°æ®è·³è½¬ ä½œç”¨ï¼š è®¾ç½®æ•°æ®ï¼Œå‘è¯·æ±‚åŸŸå¯¹è±¡ä¸­å­˜å‚¨æ•°æ® è®¾ç½®è§†å›¾ï¼Œé€»è¾‘è§†å›¾ ä»£ç å®ç°ï¼š ä½¿ç”¨ HttpServletRequest ç±»å‹å½¢å‚è¿›è¡Œæ•°æ®ä¼ é€’ 12345678@Controllerpublic class BookController &#123; @RequestMapping(&quot;/showPageAndData1&quot;) public String showPageAndData1(HttpServletRequest request) &#123; request.setAttribute(&quot;name&quot;,&quot;seazean&quot;); return &quot;page&quot;; &#125;&#125; ä½¿ç”¨ Model ç±»å‹å½¢å‚è¿›è¡Œæ•°æ®ä¼ é€’ 12345678910@RequestMapping(&quot;/showPageAndData2&quot;)public String showPageAndData2(Model model) &#123; model.addAttribute(&quot;name&quot;,&quot;seazean&quot;); Book book = new Book(); book.setName(&quot;SpringMVCå…¥é—¨å®æˆ˜&quot;); book.setPrice(66.6d); //æ·»åŠ æ•°æ®çš„æ–¹å¼ï¼Œkeyå¯¹value model.addAttribute(&quot;book&quot;,book); return &quot;page&quot;;&#125; 1234public class Book &#123; private String name; private Double price;&#125; ä½¿ç”¨ ModelAndView ç±»å‹å½¢å‚è¿›è¡Œæ•°æ®ä¼ é€’ï¼Œå°†è¯¥å¯¹è±¡ä½œä¸ºè¿”å›å€¼ä¼ é€’ç»™è°ƒç”¨è€… 123456789101112131415@RequestMapping(&quot;/showPageAndData3&quot;)public ModelAndView showPageAndData3(ModelAndView modelAndView) &#123; //ModelAndView mav = new ModelAndView(); æ›¿æ¢å½¢å‚ä¸­çš„å‚æ•° Book book = new Book(); book.setName(&quot;SpringMVCå…¥é—¨æ¡ˆä¾‹&quot;); book.setPrice(66.66d); //æ·»åŠ æ•°æ®çš„æ–¹å¼ï¼Œkeyå¯¹value modelAndView.addObject(&quot;book&quot;,book); modelAndView.addObject(&quot;name&quot;,&quot;Jockme&quot;); //è®¾ç½®é¡µé¢çš„æ–¹å¼ï¼Œè¯¥æ–¹æ³•æœ€åä¸€æ¬¡æ‰§è¡Œçš„ç»“æœç”Ÿæ•ˆ modelAndView.setViewName(&quot;page&quot;); //è¿”å›å€¼è®¾å®šæˆModelAndViewå¯¹è±¡ return modelAndView;&#125; ModelAndView æ‰©å±• 12345678910111213//ModelAndViewå¯¹è±¡æ”¯æŒè½¬å‘çš„æ‰‹å·¥è®¾å®šï¼Œè¯¥è®¾å®šä¸ä¼šå¯ç”¨å‰ç¼€åç¼€çš„é¡µé¢æ‹¼æ¥æ ¼å¼@RequestMapping(&quot;/showPageAndData4&quot;)public ModelAndView showPageAndData4(ModelAndView modelAndView) &#123; modelAndView.setViewName(&quot;forward:/WEB-INF/page/page.jsp&quot;); return modelAndView;&#125;//ModelAndViewå¯¹è±¡æ”¯æŒé‡å®šå‘çš„æ‰‹å·¥è®¾å®šï¼Œè¯¥è®¾å®šä¸ä¼šå¯ç”¨å‰ç¼€åç¼€çš„é¡µé¢æ‹¼æ¥æ ¼å¼@RequestMapping(&quot;/showPageAndData5&quot;)public ModelAndView showPageAndData6(ModelAndView modelAndView) &#123; modelAndView.setViewName(&quot;redirect:page.jsp&quot;); return modelAndView;&#125; JSONæ³¨è§£ï¼š@ResponseBody ä½œç”¨ï¼šå°† Controller çš„æ–¹æ³•è¿”å›çš„å¯¹è±¡é€šè¿‡é€‚å½“çš„è½¬æ¢å™¨è½¬æ¢ä¸ºæŒ‡å®šçš„æ ¼å¼ä¹‹åï¼Œå†™å…¥åˆ° Response çš„ body åŒºã€‚å¦‚æœè¿”å›å€¼æ˜¯å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆç›´æ¥å°†å­—ç¬¦ä¸²è¿”å›å®¢æˆ·ç«¯ï¼›å¦‚æœæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä¼šå°†å¯¹è±¡è½¬åŒ–ä¸º JSONï¼Œè¿”å›å®¢æˆ·ç«¯ æ³¨æ„ï¼šå½“æ–¹æ³•ä¸Šé¢æ²¡æœ‰å†™ ResponseBodyï¼Œåº•å±‚ä¼šå°†æ–¹æ³•çš„è¿”å›å€¼å°è£…ä¸º ModelAndView å¯¹è±¡ ä½¿ç”¨ HttpServletResponse å¯¹è±¡å“åº”æ•°æ® 1234567@Controllerpublic class AccountController &#123; @RequestMapping(&quot;/showData1&quot;) public void showData1(HttpServletResponse response) throws IOException &#123; response.getWriter().write(&quot;message&quot;); &#125;&#125; ä½¿ç”¨ @ResponseBody å°†è¿”å›çš„ç»“æœä½œä¸ºå“åº”å†…å®¹ï¼ˆé¡µé¢æ˜¾ç¤ºï¼‰ï¼Œè€Œéå“åº”çš„é¡µé¢åç§° 12345@RequestMapping(&quot;/showData2&quot;)@ResponseBodypublic String showData2()&#123; return &quot;&#123;&#x27;name&#x27;:&#x27;Jock&#x27;&#125;&quot;;&#125; ä½¿ç”¨ jackson è¿›è¡Œ json æ•°æ®æ ¼å¼è½¬åŒ– å¯¼å…¥åæ ‡ï¼š 123456789101112131415161718&lt;!--jsonç›¸å…³åæ ‡3ä¸ª--&gt;&lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-core&lt;/artifactId&gt; &lt;version&gt;2.9.0&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt; &lt;version&gt;2.9.0&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-annotations&lt;/artifactId&gt; &lt;version&gt;2.9.0&lt;/version&gt;&lt;/dependency&gt; 12345678910@RequestMapping(&quot;/showData3&quot;)@ResponseBodypublic String showData3() throws JsonProcessingException &#123; Book book = new Book(); book.setName(&quot;SpringMVCå…¥é—¨æ¡ˆä¾‹&quot;); book.setPrice(66.66d); ObjectMapper om = new ObjectMapper(); return om.writeValueAsString(book);&#125; ä½¿ç”¨ SpringMVC æä¾›çš„æ¶ˆæ¯ç±»å‹è½¬æ¢å™¨å°†å¯¹è±¡ä¸é›†åˆæ•°æ®è‡ªåŠ¨è½¬æ¢ä¸º JSON æ•°æ® 123456789//ä½¿ç”¨SpringMVCæ³¨è§£é©±åŠ¨ï¼Œå¯¹æ ‡æ³¨@ResponseBodyæ³¨è§£çš„æ§åˆ¶å™¨æ–¹æ³•è¿›è¡Œç»“æœè½¬æ¢ï¼Œç”±äºè¿”å›å€¼ä¸ºå¼•ç”¨ç±»å‹ï¼Œè‡ªåŠ¨è°ƒç”¨jacksonæä¾›çš„ç±»å‹è½¬æ¢å™¨è¿›è¡Œæ ¼å¼è½¬æ¢@RequestMapping(&quot;/showData4&quot;)@ResponseBodypublic Book showData4() &#123; Book book = new Book(); book.setName(&quot;SpringMVCå…¥é—¨æ¡ˆä¾‹&quot;); book.setPrice(66.66d); return book;&#125; æ‰‹å·¥æ·»åŠ ä¿¡æ¯ç±»å‹è½¬æ¢å™¨ 123456789&lt;bean class=&quot;org.springframework.web.servlet.mvc.method. annotation.RequestMappingHandlerAdapter&quot;&gt; &lt;property name=&quot;messageConverters&quot;&gt; &lt;list&gt; &lt;bean class=&quot;org.springframework.http.converter. json.MappingJackson2HttpMessageConverter&quot;/&gt; &lt;/list&gt; &lt;/property&gt;&lt;/bean ä½¿ç”¨ SpringMVC æ³¨è§£é©±åŠ¨ï¼š 12&lt;!--å¼€å¯springmvcæ³¨è§£é©±åŠ¨ï¼Œå¯¹@ResponseBodyçš„æ³¨è§£è¿›è¡Œæ ¼å¼å¢å¼ºï¼Œè¿½åŠ å…¶ç±»å‹è½¬æ¢çš„åŠŸèƒ½ï¼Œå…·ä½“å®ç°ç”±MappingJackson2HttpMessageConverterè¿›è¡Œ--&gt;&lt;mvc:annotation-driven/&gt; è½¬æ¢é›†åˆç±»å‹æ•°æ® 12345678910111213141516@RequestMapping(&quot;/showData5&quot;)@ResponseBodypublic List showData5() &#123; Book book1 = new Book(); book1.setName(&quot;SpringMVCå…¥é—¨æ¡ˆä¾‹&quot;); book1.setPrice(66.66d); Book book2 = new Book(); book2.setName(&quot;SpringMVCå…¥é—¨æ¡ˆä¾‹&quot;); book2.setPrice(66.66d); ArrayList al = new ArrayList(); al.add(book1); al.add(book2); return al;&#125; RestfulåŸºæœ¬ä»‹ç»Restï¼ˆREpresentational State Transferï¼‰ï¼šè¡¨ç°å±‚çŠ¶æ€è½¬åŒ–ï¼Œå®šä¹‰äº†èµ„æºåœ¨ç½‘ç»œä¼ è¾“ä¸­ä»¥æŸç§è¡¨ç°å½¢å¼è¿›è¡ŒçŠ¶æ€è½¬ç§»ï¼Œå³ç½‘ç»œèµ„æºçš„è®¿é—®æ–¹å¼ èµ„æºï¼šæŠŠçœŸå®çš„å¯¹è±¡æ•°æ®ç§°ä¸ºèµ„æºï¼Œä¸€ä¸ªèµ„æºæ—¢å¯ä»¥æ˜¯ä¸€ä¸ªé›†åˆï¼Œä¹Ÿå¯ä»¥æ˜¯å•ä¸ªä¸ªä½“ï¼›æ¯ä¸€ç§èµ„æºéƒ½æœ‰ç‰¹å®šçš„ URIï¼ˆç»Ÿä¸€èµ„æºæ ‡è¯†ç¬¦ï¼‰ä¸ä¹‹å¯¹åº”ï¼Œå¦‚æœè·å–è¿™ä¸ªèµ„æºï¼Œè®¿é—®è¿™ä¸ª URI å°±å¯ä»¥ï¼Œæ¯”å¦‚è·å–ç‰¹å®šçš„ç­çº§ /class/12ï¼›èµ„æºä¹Ÿå¯ä»¥åŒ…å«å­èµ„æºï¼Œæ¯”å¦‚ /classes/classId/teachers æŸä¸ªæŒ‡å®šç­çº§çš„æ‰€æœ‰è€å¸ˆ è¡¨ç°å½¢å¼ï¼šèµ„æºæ˜¯ä¸€ç§ä¿¡æ¯å®ä½“ï¼Œå®ƒå¯ä»¥æœ‰å¤šç§å¤–åœ¨è¡¨ç°å½¢å¼ï¼ŒæŠŠèµ„æºå…·ä½“å‘ˆç°å‡ºæ¥çš„å½¢å¼æ¯”å¦‚ jsonã€xmlã€imageã€txt ç­‰ç­‰å«åšå®ƒçš„â€è¡¨ç°å±‚&#x2F;è¡¨ç°å½¢å¼â€ çŠ¶æ€è½¬ç§»ï¼šæè¿°çš„æœåŠ¡å™¨ç«¯èµ„æºçš„çŠ¶æ€ï¼Œæ¯”å¦‚å¢åˆ æ”¹æŸ¥ï¼ˆé€šè¿‡ HTTP åŠ¨è¯å®ç°ï¼‰å¼•èµ·èµ„æºçŠ¶æ€çš„æ”¹å˜ï¼Œäº’è”ç½‘é€šä¿¡åè®® HTTP åè®®ï¼Œæ˜¯ä¸€ä¸ªæ— çŠ¶æ€åè®®ï¼Œæ‰€æœ‰çš„èµ„æºçŠ¶æ€éƒ½ä¿å­˜åœ¨æœåŠ¡å™¨ç«¯ è®¿é—®æ–¹å¼Restful æ˜¯æŒ‰ç…§ Rest é£æ ¼è®¿é—®ç½‘ç»œèµ„æº ä¼ ç»Ÿé£æ ¼è®¿é—®è·¯å¾„ï¼šhttp://localhost/user/get?id=1 Rest é£æ ¼è®¿é—®è·¯å¾„ï¼šhttp://localhost/user/1 ä¼˜ç‚¹ï¼šéšè—èµ„æºçš„è®¿é—®è¡Œä¸ºï¼Œé€šè¿‡åœ°å€æ— æ³•å¾—çŸ¥åšçš„æ˜¯ä½•ç§æ“ä½œï¼Œä¹¦å†™ç®€åŒ– Restful è¯·æ±‚è·¯å¾„ç®€åŒ–é…ç½®æ–¹å¼ï¼š@RestController = @Controller + @ResponseBody ç›¸å…³æ³¨è§£ï¼š@GetMapping æ³¨è§£æ˜¯ @RequestMapping æ³¨è§£çš„è¡ç”Ÿï¼Œæ‰€ä»¥æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œå»ºè®®ä½¿ç”¨ @GetMapping @GetMapping(&quot;/poll&quot;) &#x3D; @RequestMapping(value = &quot;/poll&quot;,method = RequestMethod.GET) 12345@RequestMapping(method = RequestMethod.GET) // @GetMapping å°±æ‹¥æœ‰äº† @RequestMapping çš„åŠŸèƒ½public @interface GetMapping &#123; @AliasFor(annotation = RequestMapping.class) // ä¸ RequestMapping ç›¸é€š String name() default &quot;&quot;;&#125; @PostMapping(&quot;/push&quot;) &#x3D; @RequestMapping(value = &quot;/push&quot;,method = RequestMethod.POST) è¿‡æ»¤å™¨ï¼šHiddenHttpMethodFilter æ˜¯ SpringMVC å¯¹ Restful é£æ ¼çš„è®¿é—®æ”¯æŒçš„è¿‡æ»¤å™¨ ä»£ç å®ç°ï¼š restful.jspï¼š é¡µé¢è¡¨å•ä½¿ç”¨éšè—åŸŸæäº¤è¯·æ±‚ç±»å‹ï¼Œå‚æ•°åç§°å›ºå®šä¸º _methodï¼Œå¿…é¡»é…åˆæäº¤ç±»å‹ method&#x3D;post ä½¿ç”¨ GET è¯·æ±‚é€šè¿‡åœ°å€æ å¯ä»¥å‘é€ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½® form çš„è¯·æ±‚æ–¹å¼æäº¤ POST è¯·æ±‚å¿…é¡»é€šè¿‡ form çš„è¯·æ±‚æ–¹å¼æäº¤ 1234567&lt;h1&gt;restfulé£æ ¼è¯·æ±‚è¡¨å•&lt;/h1&gt;&lt;!--åˆ‡æ¢è¯·æ±‚è·¯å¾„ä¸ºrestfulé£æ ¼--&gt;&lt;form action=&quot;/user&quot; method=&quot;post&quot;&gt; &lt;!--ä¸€éšè—åŸŸï¼Œåˆ‡æ¢ä¸ºPUTè¯·æ±‚æˆ–DELETEè¯·æ±‚ï¼Œä½†æ˜¯formè¡¨å•çš„æäº¤æ–¹å¼methodå±æ€§å¿…é¡»å¡«å†™post--&gt; &lt;input name=&quot;_method&quot; type=&quot;hidden&quot; value=&quot;PUT&quot;/&gt; &lt;input value=&quot;REST-PUT æäº¤&quot; type=&quot;submit&quot;/&gt;&lt;/form&gt; java &#x2F; controller &#x2F; UserController 123456789101112131415161718192021222324252627@RestController //è®¾ç½®resté£æ ¼çš„æ§åˆ¶å™¨@RequestMapping(&quot;/user/&quot;) //è®¾ç½®å…¬å…±è®¿é—®è·¯å¾„ï¼Œé…åˆä¸‹æ–¹è®¿é—®è·¯å¾„ä½¿ç”¨public class UserController &#123; @GetMapping(&quot;/user&quot;) //@RequestMapping(value = &quot;/user&quot;,method = RequestMethod.GET) public String getUser()&#123; return &quot;GET-å¼ ä¸‰&quot;; &#125; @PostMapping(&quot;/user&quot;) //@RequestMapping(value = &quot;/user&quot;,method = RequestMethod.POST) public String saveUser()&#123; return &quot;POST-å¼ ä¸‰&quot;; &#125; @PutMapping(&quot;/user&quot;) //@RequestMapping(value = &quot;/user&quot;,method = RequestMethod.PUT) public String putUser()&#123; return &quot;PUT-å¼ ä¸‰&quot;; &#125; @DeleteMapping(&quot;/user&quot;) //@RequestMapping(value = &quot;/user&quot;,method = RequestMethod.DELETE) public String deleteUser()&#123; return &quot;DELETE-å¼ ä¸‰&quot;; &#125;&#125; é…ç½®æ‹¦æˆªå™¨ web.xml 123456789&lt;!--é…ç½®æ‹¦æˆªå™¨ï¼Œè§£æè¯·æ±‚ä¸­çš„å‚æ•°_methodï¼Œå¦åˆ™æ— æ³•å‘èµ·PUTè¯·æ±‚ä¸DELETEè¯·æ±‚ï¼Œé…åˆé¡µé¢è¡¨å•ä½¿ç”¨--&gt;&lt;filter&gt; &lt;filter-name&gt;HiddenHttpMethodFilter&lt;/filter-name&gt; &lt;filter-class&gt;org.springframework.web.filter.HiddenHttpMethodFilter&lt;/filter-class&gt;&lt;/filter&gt;&lt;filter-mapping&gt; &lt;filter-name&gt;HiddenHttpMethodFilter&lt;/filter-name&gt; &lt;servlet-name&gt;DispatcherServlet&lt;/servlet-name&gt;&lt;/filter-mapping&gt; å‚æ•°æ³¨è§£Restful å¼€å‘ä¸­çš„å‚æ•°æ³¨è§£ 123@GetMapping(&quot;&#123;id&#125;&quot;)public String getMessage(@PathVariable(&quot;id&quot;) Integer id)&#123;&#125; ä½¿ç”¨ @PathVariable æ³¨è§£è·å–è·¯å¾„ä¸Šé…ç½®çš„å…·åå˜é‡ï¼Œä¸€èˆ¬åœ¨æœ‰å¤šä¸ªå‚æ•°çš„æ—¶å€™æ·»åŠ  å…¶ä»–æ³¨è§£ï¼š @RequestHeaderï¼šè·å–è¯·æ±‚å¤´ @RequestParamï¼šè·å–è¯·æ±‚å‚æ•°ï¼ˆæŒ‡é—®å·åçš„å‚æ•°ï¼Œurl?a&#x3D;1&amp;b&#x3D;2ï¼‰ @CookieValueï¼šè·å– Cookie å€¼ @RequestAttributeï¼šè·å– request åŸŸå±æ€§ @RequestBodyï¼šè·å–è¯·æ±‚ä½“ [POST] @MatrixVariableï¼šçŸ©é˜µå˜é‡ @ModelAttributeï¼šè‡ªå®šä¹‰ç±»å‹å˜é‡ 1234567891011121314151617181920212223242526272829303132333435@RestController @RequestMapping(&quot;/user/&quot;)public class UserController &#123; //resté£æ ¼è®¿é—®è·¯å¾„ç®€åŒ–ä¹¦å†™æ–¹å¼ï¼Œé…åˆç±»æ³¨è§£@RequestMappingä½¿ç”¨ @RequestMapping(&quot;&#123;id&#125;&quot;) public String restLocation2(@PathVariable Integer id)&#123; System.out.println(&quot;restful is running ....get:&quot; + id); return &quot;success.jsp&quot;; &#125; //@RequestMapping(value = &quot;&#123;id&#125;&quot;,method = RequestMethod.GET) @GetMapping(&quot;&#123;id&#125;&quot;) public String get(@PathVariable Integer id)&#123; System.out.println(&quot;restful is running ....get:&quot; + id); return &quot;success.jsp&quot;; &#125; @PostMapping(&quot;&#123;id&#125;&quot;) public String post(@PathVariable Integer id)&#123; System.out.println(&quot;restful is running ....post:&quot; + id); return &quot;success.jsp&quot;; &#125; @PutMapping(&quot;&#123;id&#125;&quot;) public String put(@PathVariable Integer id)&#123; System.out.println(&quot;restful is running ....put:&quot; + id); return &quot;success.jsp&quot;; &#125; @DeleteMapping(&quot;&#123;id&#125;&quot;) public String delete(@PathVariable Integer id)&#123; System.out.println(&quot;restful is running ....delete:&quot; + id); return &quot;success.jsp&quot;; &#125;&#125; è¯†åˆ«åŸç†è¡¨å•æäº¤è¦ä½¿ç”¨ REST æ—¶ï¼Œä¼šå¸¦ä¸Š _method=PUTï¼Œè¯·æ±‚è¿‡æ¥è¢« HiddenHttpMethodFilter æ‹¦æˆªï¼Œè¿›è¡Œè¿‡æ»¤æ“ä½œ org.springframework.web.filter.HiddenHttpMethodFilter.doFilterInternal()ï¼š 1234567891011121314151617181920212223242526272829303132public class HiddenHttpMethodFilter extends OncePerRequestFilter &#123; // å…¼å®¹çš„è¯·æ±‚ PUTã€DELETEã€PATCH private static final List&lt;String&gt; ALLOWED_METHODS = Collections.unmodifiableList(Arrays.asList(HttpMethod.PUT.name(), HttpMethod.DELETE.name(), HttpMethod.PATCH.name())); // éšè—åŸŸçš„åå­— public static final String DEFAULT_METHOD_PARAM = &quot;_method&quot;; private String methodParam = DEFAULT_METHOD_PARAM; @Override protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException &#123; HttpServletRequest requestToUse = request; // è¯·æ±‚å¿…é¡»æ˜¯ POSTï¼Œ if (&quot;POST&quot;.equals(request.getMethod()) &amp;&amp; request.getAttribute(WebUtils.ERROR_EXCEPTION_ATTRIBUTE) == null) &#123; // è·å–æ ‡ç­¾ä¸­ name=&quot;_method&quot; çš„ value å€¼ String paramValue = request.getParameter(this.methodParam); if (StringUtils.hasLength(paramValue)) &#123; // è½¬æˆå¤§å†™ String method = paramValue.toUpperCase(Locale.ENGLISH); // å…¼å®¹çš„è¯·æ±‚æ–¹å¼ if (ALLOWED_METHODS.contains(method)) &#123; // åŒ…è£…è¯·æ±‚ requestToUse = new HttpMethodRequestWrapper(request, method); &#125; &#125; &#125; // è¿‡æ»¤å™¨é“¾æ”¾è¡Œçš„æ—¶å€™ç”¨wrapperã€‚ä»¥åçš„æ–¹æ³•è°ƒç”¨getMethodæ˜¯è°ƒç”¨requesWrapperçš„ filterChain.doFilter(requestToUse, response); &#125;&#125; Rest ä½¿ç”¨å®¢æˆ·ç«¯å·¥å…·ï¼Œå¦‚ Postman å¯ç›´æ¥å‘é€ putã€delete ç­‰æ–¹å¼è¯·æ±‚ä¸è¢«è¿‡æ»¤ æ”¹å˜é»˜è®¤çš„ _method çš„æ–¹å¼ï¼š 1234567891011@Configuration(proxyBeanMethods = false)public class WebConfig&#123; //è‡ªå®šä¹‰filter @Bean public HiddenHttpMethodFilter hiddenHttpMethodFilter()&#123; HiddenHttpMethodFilter methodFilter = new HiddenHttpMethodFilter(); //é€šè¿‡set æ–¹æ³•è‡ªå®šä¹‰ methodFilter.setMethodParam(&quot;_m&quot;); return methodFilter; &#125; &#125; ServletSpringMVC æä¾›è®¿é—®åŸå§‹ Servlet æ¥å£çš„åŠŸèƒ½ SpringMVC æä¾›è®¿é—®åŸå§‹ Servlet æ¥å£ API çš„åŠŸèƒ½ï¼Œé€šè¿‡å½¢å‚å£°æ˜å³å¯ 12345678910@RequestMapping(&quot;/servletApi&quot;)public String servletApi(HttpServletRequest request, HttpServletResponse response, HttpSession session)&#123; System.out.println(request); System.out.println(response); System.out.println(session); request.setAttribute(&quot;name&quot;,&quot;seazean&quot;); System.out.println(request.getAttribute(&quot;name&quot;)); return &quot;page.jsp&quot;;&#125; Head æ•°æ®è·å–å¿«æ·æ“ä½œæ–¹å¼åç§°ï¼š@RequestHeaderç±»å‹ï¼šå½¢å‚æ³¨è§£ä½ç½®ï¼šå¤„ç†å™¨ç±»ä¸­çš„æ–¹æ³•å½¢å‚å‰æ–¹ä½œç”¨ï¼šç»‘å®šè¯·æ±‚å¤´æ•°æ®ä¸å¯¹åº”å¤„ç†æ–¹æ³•å½¢å‚é—´çš„å…³ç³»èŒƒä¾‹ï¼š 12345å¿«æ·æ“ä½œæ–¹å¼@RequestMapping(&quot;/headApi&quot;)public String headApi(@RequestHeader(&quot;Accept-Language&quot;) String headMsg)&#123; System.out.println(headMsg); return &quot;page&quot;;&#125; Cookie æ•°æ®è·å–å¿«æ·æ“ä½œæ–¹å¼åç§°ï¼š@CookieValueç±»å‹ï¼šå½¢å‚æ³¨è§£ä½ç½®ï¼šå¤„ç†å™¨ç±»ä¸­çš„æ–¹æ³•å½¢å‚å‰æ–¹ä½œç”¨ï¼šç»‘å®šè¯·æ±‚ Cookie æ•°æ®ä¸å¯¹åº”å¤„ç†æ–¹æ³•å½¢å‚é—´çš„å…³ç³»èŒƒä¾‹ï¼š 12345@RequestMapping(&quot;/cookieApi&quot;)public String cookieApi(@CookieValue(&quot;JSESSIONID&quot;) String jsessionid)&#123; System.out.println(jsessionid); return &quot;page&quot;;&#125; Session æ•°æ®è·å–åç§°ï¼š@SessionAttributeç±»å‹ï¼šå½¢å‚æ³¨è§£ä½ç½®ï¼šå¤„ç†å™¨ç±»ä¸­çš„æ–¹æ³•å½¢å‚å‰æ–¹ä½œç”¨ï¼šç»‘å®šè¯·æ±‚Sessionæ•°æ®ä¸å¯¹åº”å¤„ç†æ–¹æ³•å½¢å‚é—´çš„å…³ç³»èŒƒä¾‹ï¼š 1234567891011@RequestMapping(&quot;/sessionApi&quot;)public String sessionApi(@SessionAttribute(&quot;name&quot;) String name)&#123; System.out.println(name); return &quot;page.jsp&quot;;&#125;//ç”¨äºåœ¨sessionä¸­æ”¾å…¥æ•°æ®@RequestMapping(&quot;/setSessionData&quot;)public String setSessionData(HttpSession session)&#123; session.setAttribute(&quot;name&quot;,&quot;seazean&quot;); return &quot;page&quot;;&#125; Session æ•°æ®è®¾ç½®åç§°ï¼š@SessionAttributesç±»å‹ï¼šç±»æ³¨è§£ä½ç½®ï¼šå¤„ç†å™¨ç±»ä¸Šæ–¹ä½œç”¨ï¼šå£°æ˜æ”¾å…¥sessionèŒƒå›´çš„å˜é‡åç§°ï¼Œé€‚ç”¨äºModelç±»å‹æ•°æ®ä¼ å‚èŒƒä¾‹ï¼š 1234567891011121314151617181920@Controller//è®¾å®šå½“å‰ç±»ä¸­åç§°ä¸ºageå’Œgenderçš„å˜é‡æ”¾å…¥sessionèŒƒå›´ï¼Œä¸å¸¸ç”¨@SessionAttributes(names = &#123;&quot;age&quot;,&quot;gender&quot;&#125;)public class ServletController &#123; //å°†æ•°æ®æ”¾å…¥sessionå­˜å‚¨èŒƒå›´ï¼ŒModelå¯¹è±¡å®ç°æ•°æ®setï¼Œ@SessionAttributesæ³¨è§£å®ç°èŒƒå›´è®¾å®š @RequestMapping(&quot;/setSessionData2&quot;) public String setSessionDate2(Model model) &#123; model.addAttribute(&quot;age&quot;,39); model.addAttribute(&quot;gender&quot;,&quot;ç”·&quot;); return &quot;page&quot;; &#125; @RequestMapping(&quot;/sessionApi&quot;) public String sessionApi(@SessionAttribute(&quot;age&quot;) int age, @SessionAttribute(&quot;gender&quot;) String gender)&#123; System.out.println(name); System.out.println(age); return &quot;page&quot;; &#125;&#125; spring-mvc.xml é…ç½® 12345678910111213141516&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:context=&quot;http://www.springframework.org/schema/context&quot; xmlns:mvc=&quot;http://www.springframework.org/schema/mvc&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;&gt; &lt;context:component-scan base-package=&quot;com.seazean&quot;/&gt; &lt;bean class=&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;&gt; &lt;property name=&quot;prefix&quot; value=&quot;/WEB-INF/page/&quot;/&gt; &lt;property name=&quot;suffix&quot; value=&quot;.jsp&quot;/&gt; &lt;/bean&gt; &lt;mvc:annotation-driven/&gt;&lt;/beans&gt; è¿è¡ŒåŸç†æŠ€æœ¯æ¶æ„ç»„ä»¶ä»‹ç»æ ¸å¿ƒç»„ä»¶ï¼š DispatcherServletï¼šæ ¸å¿ƒæ§åˆ¶å™¨ï¼Œ æ˜¯ SpringMVC çš„æ ¸å¿ƒï¼Œæ•´ä½“æµç¨‹æ§åˆ¶çš„ä¸­å¿ƒï¼Œæ‰€æœ‰çš„è¯·æ±‚ç¬¬ä¸€æ­¥éƒ½å…ˆåˆ°è¾¾è¿™é‡Œï¼Œç”±å…¶è°ƒç”¨å…¶å®ƒç»„ä»¶å¤„ç†ç”¨æˆ·çš„è¯·æ±‚ï¼Œå®ƒå°±æ˜¯åœ¨ web.xml é…ç½®çš„æ ¸å¿ƒ Servletï¼Œæœ‰æ•ˆçš„é™ä½äº†ç»„ä»¶é—´çš„è€¦åˆæ€§ HandlerMappingï¼šå¤„ç†å™¨æ˜ å°„å™¨ï¼Œ è´Ÿè´£æ ¹æ®è¯·æ±‚æ‰¾åˆ°å¯¹åº”å…·ä½“çš„ Handler å¤„ç†å™¨ï¼ŒSpringMVC ä¸­é’ˆå¯¹é…ç½®æ–‡ä»¶æ–¹å¼ã€æ³¨è§£æ–¹å¼ç­‰æä¾›äº†ä¸åŒçš„æ˜ å°„å™¨æ¥å¤„ç† Handlerï¼šå¤„ç†å™¨ï¼Œå…¶å®å°±æ˜¯ Controllerï¼Œä¸šåŠ¡å¤„ç†çš„æ ¸å¿ƒç±»ï¼Œé€šå¸¸ç”±å¼€å‘è€…ç¼–å†™ï¼Œå¹¶ä¸”å¿…é¡»éµå®ˆ Controller å¼€å‘çš„è§„åˆ™ï¼Œè¿™æ ·é€‚é…å™¨æ‰èƒ½æ­£ç¡®çš„æ‰§è¡Œã€‚ä¾‹å¦‚å®ç° Controller æ¥å£ï¼Œå°† Controller æ³¨å†Œåˆ° IOC å®¹å™¨ä¸­ç­‰ HandlAdapterï¼šå¤„ç†å™¨é€‚é…å™¨ï¼Œæ ¹æ®æ˜ å°„å™¨ä¸­æ‰¾åˆ°çš„ Handlerï¼Œé€šè¿‡ HandlerAdapter å»æ‰§è¡Œ Handlerï¼Œè¿™æ˜¯é€‚é…å™¨æ¨¡å¼çš„åº”ç”¨ View Resolverï¼šè§†å›¾è§£æå™¨ï¼Œ å°† Handler ä¸­è¿”å›çš„é€»è¾‘è§†å›¾ï¼ˆModelAndViewï¼‰è§£æä¸ºä¸€ä¸ªå…·ä½“çš„è§†å›¾ï¼ˆViewï¼‰å¯¹è±¡ Viewï¼šè§†å›¾ï¼Œ View æœ€åå¯¹é¡µé¢è¿›è¡Œæ¸²æŸ“å°†ç»“æœè¿”å›ç»™ç”¨æˆ·ï¼ŒSpringMVC æ¡†æ¶æä¾›äº†å¾ˆå¤šçš„ View è§†å›¾ç±»å‹ï¼ŒåŒ…æ‹¬ï¼šjstlViewã€freemarkerViewã€pdfView ç­‰ ä¼˜ç‚¹ï¼š ä¸ Spring é›†æˆï¼Œæ›´å¥½çš„ç®¡ç†èµ„æº æœ‰å¾ˆå¤šå‚æ•°è§£æå™¨å’Œè§†å›¾è§£æå™¨ï¼Œæ”¯æŒçš„æ•°æ®ç±»å‹ä¸°å¯Œ å°†æ˜ å°„å™¨ã€å¤„ç†å™¨ã€è§†å›¾è§£æå™¨è¿›è¡Œè§£è€¦ï¼Œåˆ†å·¥æ˜ç¡® å·¥ä½œåŸç†åœ¨ Spring å®¹å™¨åˆå§‹åŒ–æ—¶ä¼šå»ºç«‹æ‰€æœ‰çš„ URL å’Œ Controller çš„å¯¹åº”å…³ç³»ï¼Œä¿å­˜åˆ° Map&lt;URL, Controller&gt; ä¸­ï¼Œè¿™æ · request å°±èƒ½å¿«é€Ÿæ ¹æ® URL å®šä½åˆ° Controllerï¼š åœ¨ Spring IOC å®¹å™¨åˆå§‹åŒ–å®Œæ‰€æœ‰å•ä¾‹ bean å SpringMVC ä¼šéå†æ‰€æœ‰çš„ beanï¼Œè·å– Controller ä¸­å¯¹åº”çš„ URLï¼ˆè¿™é‡Œè·å– URL çš„å®ç°ç±»æœ‰å¤šä¸ªï¼Œç”¨äºå¤„ç†ä¸åŒå½¢å¼é…ç½®çš„ Controllerï¼‰ å°†æ¯ä¸€ä¸ª URL å¯¹åº”ä¸€ä¸ª Controller å­˜å…¥ Map&lt;URL, Controller&gt; ä¸­ æ³¨æ„ï¼šå°† @Controller æ³¨è§£æ¢æˆ @Componentï¼Œå¯åŠ¨æ—¶ä¸ä¼šæŠ¥é”™ï¼Œä½†æ˜¯åœ¨æµè§ˆå™¨ä¸­è¾“å…¥è·¯å¾„æ—¶ä¼šå‡ºç° 404ï¼Œè¯´æ˜ Spring æ²¡æœ‰å¯¹æ‰€æœ‰çš„ bean è¿›è¡Œ URL æ˜ å°„ ä¸€ä¸ª Request æ¥äº†ï¼š ç›‘å¬ç«¯å£ï¼Œè·å¾—è¯·æ±‚ï¼šTomcat ç›‘å¬ 8080 ç«¯å£çš„è¯·æ±‚å¤„ç†ï¼Œæ ¹æ®è·¯å¾„è°ƒç”¨äº† web.xml ä¸­é…ç½®çš„æ ¸å¿ƒæ§åˆ¶å™¨ DispatcherServletï¼ŒDispatcherServlet#doDispatch æ˜¯æ ¸å¿ƒè°ƒåº¦æ–¹æ³• é¦–å…ˆæ ¹æ® URI è·å– HandlerMapping å¤„ç†å™¨æ˜ å°„å™¨ï¼ŒRequestMappingHandlerMapping ç”¨æ¥å¤„ç† @RequestMapping æ³¨è§£çš„æ˜ å°„è§„åˆ™ï¼Œå…¶ä¸­ä¿å­˜äº†æ‰€æœ‰ handler çš„æ˜ å°„è§„åˆ™ï¼Œæœ€ååŒ…è£…æˆä¸€ä¸ªæ‹¦æˆªå™¨é“¾è¿”å›ï¼Œæ‹¦æˆªå™¨é“¾å¯¹è±¡æŒæœ‰ HandlerMappingã€‚å¦‚æœæ²¡æœ‰åˆé€‚çš„å¤„ç†è¯·æ±‚çš„ HandlerMappingï¼Œè¯´æ˜è¯·æ±‚å¤„ç†å¤±è´¥ï¼Œè®¾ç½®å“åº”ç  404 è¿”å› æ ¹æ®æ˜ å°„å™¨è·å–å½“å‰ handlerï¼Œå¤„ç†å™¨é€‚é…å™¨æ‰§è¡Œå¤„ç†æ–¹æ³•ï¼Œé€‚é…å™¨æ ¹æ®è¯·æ±‚çš„ URL å» handler ä¸­å¯»æ‰¾å¯¹åº”çš„å¤„ç†æ–¹æ³•ï¼š åˆ›å»º ModelAndViewContainer (mav) å¯¹è±¡ï¼Œç”¨æ¥å¡«å……æ•°æ®ï¼Œç„¶åé€šè¿‡ä¸åŒçš„å‚æ•°è§£æå™¨å»è§£æ URL ä¸­çš„å‚æ•°ï¼Œå®Œæˆæ•°æ®è§£æç»‘å®šï¼Œç„¶åæ‰§è¡ŒçœŸæ­£çš„ Controller æ–¹æ³•ï¼Œå®Œæˆ handle å¤„ç† æ–¹æ³•æ‰§è¡Œå®Œå¯¹è¿”å›å€¼è¿›è¡Œå¤„ç†ï¼Œæ²¡æ·»åŠ  @ResponseBody æ³¨è§£çš„è¿”å›å€¼ä½¿ç”¨è§†å›¾å¤„ç†å™¨å¤„ç†ï¼ŒæŠŠè§†å›¾åç§°è®¾ç½®è¿›å…¥ mav ä¸­ å¯¹æ·»åŠ äº† @ResponseBody æ³¨è§£çš„ Controller çš„æŒ‰ç…§æ™®é€šçš„è¿”å›å€¼è¿›è¡Œå¤„ç†ï¼Œé¦–å…ˆè¿›è¡Œå†…å®¹åå•†ï¼Œæ‰¾åˆ°ä¸€ç§æµè§ˆå™¨å¯ä»¥æ¥å—ï¼ˆè¯·æ±‚å¤´ Acceptï¼‰çš„å¹¶ä¸”æœåŠ¡å™¨å¯ä»¥ç”Ÿæˆçš„æ•°æ®ç±»å‹ï¼Œé€‰æ‹©åˆé€‚æ•°æ®è½¬æ¢å™¨ï¼Œè®¾ç½®å“åº”å¤´ä¸­çš„æ•°æ®ç±»å‹ï¼Œç„¶åå†™å‡ºæ•°æ® æœ€åæŠŠ ModelAndViewContainer å’Œ ModelMap ä¸­çš„æ•°æ®å°è£…åˆ° ModelAndView å¯¹è±¡è¿”å› è§†å›¾è§£æï¼Œæ ¹æ®è¿”å›å€¼åˆ›å»ºè§†å›¾ï¼Œè¯·æ±‚è½¬å‘ View å®ä¾‹ä¸º InternalResourceViewï¼Œé‡å®šå‘ View å®ä¾‹ä¸º RedirectViewã€‚æœ€åè°ƒç”¨ view.render è¿›è¡Œé¡µé¢æ¸²æŸ“ï¼Œç»“æœæ´¾å‘ è¯·æ±‚è½¬å‘æ—¶è¯·æ±‚åŸŸä¸­çš„æ•°æ®ä¸ä¸¢å¤±ï¼Œä¼šæŠŠ ModelAndView çš„æ•°æ®è®¾ç½®åˆ°è¯·æ±‚åŸŸä¸­ï¼Œè·å– Servlet åŸç”Ÿçš„ RequestDispatcherï¼Œè°ƒç”¨ RequestDispatcher#forward å®ç°è½¬å‘ é‡å®šå‘ä¼šé€ æˆè¯·æ±‚åŸŸä¸­çš„æ•°æ®ä¸¢å¤±ï¼Œä½¿ç”¨ Servlet åŸç”Ÿæ–¹å¼å®ç°é‡å®šå‘ HttpServletResponse#sendRedirect è°ƒåº¦å‡½æ•°è¯·æ±‚è¿›å…¥åŸç”Ÿçš„ HttpServlet çš„ doGet() æ–¹æ³•å¤„ç†ï¼Œè°ƒç”¨å­ç±» FrameworkServlet çš„ doGet() æ–¹æ³•ï¼Œæœ€ç»ˆè°ƒç”¨ DispatcherServlet çš„ doService() æ–¹æ³•ï¼Œä¸ºè¯·æ±‚è®¾ç½®ç›¸å…³å±æ€§åè°ƒç”¨ doDispatch()ï¼Œè¯·æ±‚å’Œå“åº”çš„ä»¥å‚æ•°çš„å½¢å¼ä¼ å…¥ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061// request å’Œ response ä¸º Java åŸç”Ÿçš„ç±»protected void doDispatch(HttpServletRequest request, HttpServletResponse response) throws Exception &#123; HttpServletRequest processedRequest = request; HandlerExecutionChain mappedHandler = null; // æ–‡ä»¶ä¸Šä¼ è¯·æ±‚ boolean multipartRequestParsed = false; // å¼‚æ­¥ç®¡ç†å™¨ WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request); try &#123; ModelAndView mv = null; Exception dispatchException = null; try &#123; // æ–‡ä»¶ä¸Šä¼ ç›¸å…³è¯·æ±‚ processedRequest = checkMultipart(request); multipartRequestParsed = (processedRequest != request); // æ‰¾åˆ°å½“å‰è¯·æ±‚ä½¿ç”¨å“ªä¸ª HandlerMapping ï¼ˆController çš„æ–¹æ³•ï¼‰å¤„ç†ï¼Œè¿”å›æ‰§è¡Œé“¾ mappedHandler = getHandler(processedRequest); // æ²¡æœ‰åˆé€‚çš„å¤„ç†è¯·æ±‚çš„æ–¹å¼ HandlerMappingï¼Œè¯·æ±‚å¤±è´¥ï¼Œç›´æ¥è¿”å› 404 if (mappedHandler == null) &#123; noHandlerFound(processedRequest, response); return; &#125; // æ ¹æ®æ˜ å°„å™¨è·å–å½“å‰ handler å¤„ç†å™¨é€‚é…å™¨ï¼Œç”¨æ¥ã€å¤„ç†å½“å‰çš„è¯·æ±‚ã€‘ HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler()); // è·å–å‘å‡ºæ­¤æ¬¡è¯·æ±‚çš„æ–¹å¼ String method = request.getMethod(); // åˆ¤æ–­è¯·æ±‚æ˜¯ä¸æ˜¯ GET æ–¹æ³• boolean isGet = HttpMethod.GET.matches(method); if (isGet || HttpMethod.HEAD.matches(method)) &#123; long lastModified = ha.getLastModified(request, mappedHandler.getHandler()); if (new ServletWebRequest(request, response).checkNotModified(lastModified) &amp;&amp; isGet) &#123; return; &#125; &#125; // æ‹¦æˆªå™¨é“¾çš„å‰ç½®å¤„ç† if (!mappedHandler.applyPreHandle(processedRequest, response)) &#123; return; &#125; // æ‰§è¡Œå¤„ç†æ–¹æ³•ï¼Œè¿”å›çš„æ˜¯ ModelAndView å¯¹è±¡ï¼Œå°è£…äº†æ‰€æœ‰çš„è¿”å›å€¼æ•°æ® mv = ha.handle(processedRequest, response, mappedHandler.getHandler()); if (asyncManager.isConcurrentHandlingStarted()) &#123; return; &#125; // è®¾ç½®è§†å›¾åå­— applyDefaultViewName(processedRequest, mv); // æ‰§è¡Œæ‹¦æˆªå™¨é“¾ä¸­çš„åç½®å¤„ç†æ–¹æ³• mappedHandler.applyPostHandle(processedRequest, response, mv); &#125; catch (Exception ex) &#123; dispatchException = ex; &#125; // å¤„ç†ç¨‹åºè°ƒç”¨çš„ç»“æœï¼Œè¿›è¡Œç»“æœæ´¾å‘ processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException); &#125; //....&#125; ç¬”è®°å‚è€ƒè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV19K4y1L7MT è¯·æ±‚æ˜ å°„æ˜ å°„å™¨doDispatch() ä¸­è°ƒç”¨ getHandler æ–¹æ³•è·å–æ‰€æœ‰çš„æ˜ å°„å™¨ æ€»ä½“æµç¨‹ï¼š æ‰€æœ‰çš„è¯·æ±‚æ˜ å°„éƒ½åœ¨ HandlerMapping ä¸­ï¼ŒRequestMappingHandlerMapping å¤„ç† @RequestMapping æ³¨è§£çš„æ˜ å°„è§„åˆ™ éå†æ‰€æœ‰çš„ HandlerMapping çœ‹æ˜¯å¦å¯ä»¥åŒ¹é…å½“å‰è¯·æ±‚ï¼ŒåŒ¹é…æˆåŠŸåè¿”å›ï¼ŒåŒ¹é…å¤±è´¥è®¾ç½® HTTP 404 å“åº”ç  ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰çš„æ˜ å°„å¤„ç†ï¼Œä¹Ÿå¯ä»¥ç»™å®¹å™¨ä¸­æ”¾å…¥è‡ªå®šä¹‰ HandlerMapping è®¿é—® URLï¼šhttp://localhost:8080/user 123456789@GetMapping(&quot;/user&quot;)public String getUser()&#123; return &quot;GET&quot;;&#125;@PostMapping(&quot;/user&quot;)public String postUser()&#123; return &quot;POST&quot;;&#125;//ã€‚ã€‚ã€‚ã€‚ã€‚ HandlerMapping å¤„ç†å™¨æ˜ å°„å™¨ï¼Œä¿å­˜äº†æ‰€æœ‰ @RequestMapping å’Œ handler çš„æ˜ å°„è§„åˆ™ 12345678910111213protected HandlerExecutionChain getHandler(HttpServletRequest request) throws Exception &#123; if (this.handlerMappings != null) &#123; // éå†æ‰€æœ‰çš„ HandlerMapping for (HandlerMapping mapping : this.handlerMappings) &#123; // å°è¯•å»æ¯ä¸ª HandlerMapping ä¸­åŒ¹é…å½“å‰è¯·æ±‚çš„å¤„ç† HandlerExecutionChain handler = mapping.getHandler(request); if (handler != null) &#123; return handler; &#125; &#125; &#125; return null;&#125; mapping.getHandler(request)ï¼šè°ƒç”¨ AbstractHandlerMapping#getHandler Object handler = getHandlerInternal(request)ï¼šè·å–æ˜ å°„å™¨ï¼Œåº•å±‚è°ƒç”¨ RequestMappingInfoHandlerMapping ç±»çš„æ–¹æ³•ï¼Œåˆè°ƒç”¨ AbstractHandlerMethodMapping#getHandlerInternal String lookupPath = initLookupPath(request)ï¼šåœ°å€æ çš„ URIï¼Œè¿™é‡Œçš„ lookupPath ä¸º &#x2F;user this.mappingRegistry.acquireReadLock()ï¼šåŠ è¯»é”é˜²æ­¢å…¶ä»–çº¿ç¨‹å¹¶å‘ä¿®æ”¹ handlerMethod = lookupHandlerMethod(lookupPath, request)ï¼šè·å–å½“å‰ HandlerMapping ä¸­çš„æ˜ å°„è§„åˆ™ directPathMatches = this.mappingRegistry.getMappingsByDirectPath(lookupPath)ï¼šè·å–å½“å‰çš„æ˜ å°„å™¨ä¸å½“å‰è¯·æ±‚çš„ URI æœ‰å…³çš„æ‰€æœ‰æ˜ å°„è§„åˆ™ addMatchingMappings(directPathMatches, matches, request)ï¼šåŒ¹é…æŸä¸ªæ˜ å°„è§„åˆ™ for (T mapping : mappings)ï¼šéå†æ‰€æœ‰çš„æ˜ å°„è§„åˆ™ match = getMatchingMapping(mapping, request)ï¼šå»åŒ¹é…æ¯ä¸€ä¸ªæ˜ å°„è§„åˆ™ï¼ŒåŒ¹é…å¤±è´¥è¿”å› null matches.add(new Match())ï¼šåŒ¹é…æˆåŠŸåå°è£…æˆåŒ¹é…å™¨æ·»åŠ åˆ°åŒ¹é…é›†åˆä¸­ matches.sort(comparator)ï¼šåŒ¹é…é›†åˆæ’åº Match bestMatch = matches.get(0)ï¼šåŒ¹é…å®Œæˆåªå‰©ä¸€ä¸ªï¼Œç›´æ¥è·å–è¿”å›å¯¹åº”çš„å¤„ç†æ–¹æ³• if (matches.size() &gt; 1)ï¼šå½“æœ‰å¤šä¸ªæ˜ å°„è§„åˆ™ç¬¦åˆè¯·æ±‚æ—¶ï¼ŒæŠ¥é”™ return bestMatch.getHandlerMethod()ï¼šè¿”å›åŒ¹é…å™¨ä¸­çš„å¤„ç†æ–¹æ³• executionChain = getHandlerExecutionChain(handler, request)ï¼šä¸ºå½“å‰è¯·æ±‚å’Œæ˜ å°„å™¨çš„æ„å»ºä¸€ä¸ªæ‹¦æˆªå™¨é“¾ for (HandlerInterceptor interceptor : this.adaptedInterceptors)ï¼šéå†æ‰€æœ‰çš„æ‹¦æˆªå™¨ chain.addInterceptor(interceptor)ï¼šæŠŠæ‰€æœ‰çš„æ‹¦æˆªå™¨æ·»åŠ åˆ° HandlerExecutionChain ä¸­ï¼Œå½¢æˆæ‹¦æˆªå™¨é“¾ return executionChainï¼šè¿”å›æ‹¦æˆªå™¨é“¾ï¼ŒHandlerMapping æ˜¯é“¾çš„ handler æˆå‘˜å±æ€§ é€‚é…å™¨doDispatch() ä¸­è°ƒç”¨ HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler()) 1234567891011121314protected HandlerAdapter getHandlerAdapter(Object handler) throws ServletException &#123; if (this.handlerAdapters != null) &#123; // éå†æ‰€æœ‰çš„ HandlerAdapter for (HandlerAdapter adapter : this.handlerAdapters) &#123; // åˆ¤æ–­å½“å‰é€‚é…å™¨æ˜¯å¦æ”¯æŒå½“å‰ handle if (adapter.supports(handler)) &#123; // è¿”å›çš„æ˜¯ ã€RequestMappingHandlerAdapterã€‘ // AbstractHandlerMethodAdapter#supports -&gt; RequestMappingHandlerAdapter return adapter; &#125; &#125; &#125; throw new ServletException();&#125; æ–¹æ³•æ‰§è¡Œå®ä¾‹ä»£ç ï¼š 1234567@GetMapping(&quot;/params&quot;)public String param(Map&lt;String, Object&gt; map, Model model, HttpServletRequest request) &#123; map.put(&quot;k1&quot;, &quot;v1&quot;); // éƒ½å¯ä»¥å‘è¯·æ±‚åŸŸä¸­æ·»åŠ æ•°æ® model.addAttribute(&quot;k2&quot;, &quot;v2&quot;); // å®ƒä»¬ä¸¤ä¸ªéƒ½åœ¨æ•°æ®å°è£…åœ¨ ã€BindingAwareModelMapã€‘ï¼Œç»§æ‰¿è‡ª LinkedHashMap request.setAttribute(&quot;m&quot;, &quot;HelloWorld&quot;); return &quot;forward:/success&quot;;&#125; doDispatch() ä¸­è°ƒç”¨ mv = ha.handle(processedRequest, response, mappedHandler.getHandler()) ä½¿ç”¨é€‚é…å™¨æ‰§è¡Œæ–¹æ³• AbstractHandlerMethodAdapter#handle â†’ RequestMappingHandlerAdapter#handleInternal â†’ invokeHandlerMethodï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344protected ModelAndView invokeHandlerMethod(HttpServletRequest request, HttpServletResponse response, HandlerMethod handlerMethod) throws Exception &#123; // å°è£…æˆ SpringMVC çš„æ¥å£ï¼Œç”¨äºé€šç”¨ Web è¯·æ±‚æ‹¦æˆªå™¨ï¼Œä½¿èƒ½å¤Ÿè®¿é—®é€šç”¨è¯·æ±‚å…ƒæ•°æ®ï¼Œè€Œä¸æ˜¯ç”¨äºå®é™…å¤„ç†è¯·æ±‚ ServletWebRequest webRequest = new ServletWebRequest(request, response); try &#123; // WebDataBinder ç”¨äºã€ä» Web è¯·æ±‚å‚æ•°åˆ° JavaBean å¯¹è±¡çš„æ•°æ®ç»‘å®šã€‘ï¼Œè·å–åˆ›å»ºè¯¥å®ä¾‹çš„å·¥å‚ WebDataBinderFactory binderFactory = getDataBinderFactory(handlerMethod); // åˆ›å»º Model å®ä¾‹ï¼Œç”¨äºå‘æ¨¡å‹æ·»åŠ å±æ€§ ModelFactory modelFactory = getModelFactory(handlerMethod, binderFactory); // æ–¹æ³•æ‰§è¡Œå™¨ ServletInvocableHandlerMethod invocableMethod = createInvocableHandlerMethod(handlerMethod); // å‚æ•°è§£æå™¨ï¼Œæœ‰å¾ˆå¤š if (this.argumentResolvers != null) &#123; invocableMethod.setHandlerMethodArgumentResolvers(this.argumentResolvers); &#125; // è¿”å›å€¼å¤„ç†å™¨ï¼Œä¹Ÿæœ‰å¾ˆå¤š if (this.returnValueHandlers != null) &#123; invocableMethod.setHandlerMethodReturnValueHandlers(this.returnValueHandlers); &#125; // è®¾ç½®æ•°æ®ç»‘å®šå™¨ invocableMethod.setDataBinderFactory(binderFactory); // è®¾ç½®å‚æ•°æ£€æŸ¥å™¨ invocableMethod.setParameterNameDiscoverer(this.parameterNameDiscoverer); // æ–°å»ºä¸€ä¸ª ModelAndViewContainer å¹¶è¿›è¡Œåˆå§‹åŒ–å’Œä¸€äº›å±æ€§çš„å¡«å…… ModelAndViewContainer mavContainer = new ModelAndViewContainer(); // è®¾ç½®ä¸€äº›å±æ€§ // ã€æ‰§è¡Œç›®æ ‡æ–¹æ³•ã€‘ invocableMethod.invokeAndHandle(webRequest, mavContainer); // å¼‚æ­¥è¯·æ±‚ if (asyncManager.isConcurrentHandlingStarted()) &#123; return null; &#125; // ã€è·å– ModelAndView å¯¹è±¡ï¼Œå°è£…äº† ModelAndViewContainerã€‘ return getModelAndView(mavContainer, modelFactory, webRequest); &#125; finally &#123; webRequest.requestCompleted(); &#125;&#125; ServletInvocableHandlerMethod#invokeAndHandleï¼šæ‰§è¡Œç›®æ ‡æ–¹æ³• returnValue = invokeForRequest(webRequest, mavContainer, providedArgs)ï¼šæ‰§è¡Œè‡ªå·±å†™çš„ controller æ–¹æ³•ï¼Œè¿”å›çš„å°±æ˜¯è‡ªå®šä¹‰æ–¹æ³•ä¸­ return çš„å€¼ Object[] args = getMethodArgumentValues(request, mavContainer, providedArgs)ï¼šå‚æ•°å¤„ç†çš„é€»è¾‘ï¼Œéå†æ‰€æœ‰çš„å‚æ•°è§£æå™¨è§£æå‚æ•°æˆ–è€…å°† URI ä¸­çš„å‚æ•°è¿›è¡Œç»‘å®šï¼Œç»‘å®šå®Œæˆåå¼€å§‹æ‰§è¡Œç›®æ ‡æ–¹æ³• parameters = getMethodParameters()ï¼šè·å–æ­¤å¤„ç†ç¨‹åºæ–¹æ³•çš„æ–¹æ³•å‚æ•°çš„è¯¦ç»†ä¿¡æ¯ Object[] args = new Object[parameters.length]ï¼šå­˜æ”¾æ‰€æœ‰çš„å‚æ•° for (int i = 0; i &lt; parameters.length; i++)ï¼šéå†æ‰€æœ‰çš„å‚æ•° args[i] = findProvidedArgument(parameter, providedArgs)ï¼šè·å–è°ƒç”¨æ–¹æ³•æ—¶æä¾›çš„å‚æ•°ï¼Œä¸€èˆ¬æ˜¯ç©º if (!this.resolvers.supportsParameter(parameter))ï¼šè·å–å¯ä»¥è§£æå½“å‰å‚æ•°çš„å‚æ•°è§£æå™¨ return getArgumentResolver(parameter) != nullï¼šè·å–å‚æ•°çš„è§£ææ˜¯å¦ä¸ºç©º for (HandlerMethodArgumentResolver resolver : this.argumentResolvers)ï¼šéå†å®¹å™¨å†…æ‰€æœ‰çš„è§£æå™¨ if (resolver.supportsParameter(parameter))ï¼šæ˜¯å¦æ”¯æŒå½“å‰å‚æ•° PathVariableMethodArgumentResolver#supportsParameterï¼šè§£ææ ‡æ³¨ @PathVariable æ³¨è§£çš„å‚æ•° ModelMethodProcessor#supportsParameterï¼šè§£æ Map å’Œ Model ç±»å‹çš„å‚æ•°ï¼ŒModel å’Œ Map çš„ä½œç”¨ä¸€æ · ExpressionValueMethodArgumentResolver#supportsParameterï¼šè§£ææ ‡æ³¨ @Value æ³¨è§£çš„å‚æ•° RequestParamMapMethodArgumentResolver#supportsParameterï¼šè§£ææ ‡æ³¨ @RequestParam æ³¨è§£ RequestPartMethodArgumentResolver#supportsParameterï¼šè§£ææ–‡ä»¶ä¸Šä¼ çš„ä¿¡æ¯ ModelAttributeMethodProcessor#supportsParameterï¼šè§£ææ ‡æ³¨ @ModelAttribute æ³¨è§£æˆ–è€…ä¸æ˜¯ç®€å•ç±»å‹ å­ç±» ServletModelAttributeMethodProcessor æ˜¯è§£æè‡ªå®šä¹‰ç±»å‹ JavaBean çš„è§£æå™¨ ç®€å•ç±»å‹æœ‰ Voidã€Enumã€Numberã€CharSequenceã€Dateã€URIã€URLã€Localeã€Class args[i] = this.resolvers.resolveArgument()ï¼šå¼€å§‹è§£æå‚æ•°ï¼Œæ¯ä¸ªå‚æ•°ä½¿ç”¨çš„è§£æå™¨ä¸åŒ resolver = getArgumentResolver(parameter)ï¼šè·å–å‚æ•°è§£æå™¨ return resolver.resolveArgument()ï¼šå¼€å§‹è§£æ PathVariableMapMethodArgumentResolver#resolveArgumentï¼š@PathVariableï¼ŒåŒ…è£… URI ä¸­çš„å‚æ•°ä¸º Map MapMethodProcessor#resolveArgumentï¼šè°ƒç”¨ mavContainer.getModel() è¿”å›é»˜è®¤ BindingAwareModelMap å¯¹è±¡ ModelAttributeMethodProcessor#resolveArgumentï¼šè‡ªå®šä¹‰çš„ JavaBean çš„ç»‘å®šå°è£…ï¼Œä¸‹ä¸€å°èŠ‚è¯¦è§£ return doInvoke(args)ï¼šçœŸæ­£çš„æ‰§è¡Œ Controller æ–¹æ³• Method method = getBridgedMethod()ï¼šä» HandlerMethod è·å–è¦åå°„æ‰§è¡Œçš„æ–¹æ³• ReflectionUtils.makeAccessible(method)ï¼šç ´è§£æƒé™ method.invoke(getBean(), args)ï¼šæ‰§è¡Œæ–¹æ³•ï¼ŒgetBean è·å–çš„æ˜¯æ ‡è®° @Controller çš„ Bean ç±»ï¼Œå…¶ä¸­åŒ…å«æ‰§è¡Œæ–¹æ³• è¿›è¡Œè¿”å›å€¼çš„å¤„ç†ï¼Œå“åº”éƒ¨åˆ†è¯¦è§£ï¼Œå¤„ç†å®Œæˆè¿›å…¥ä¸‹é¢çš„é€»è¾‘ RequestMappingHandlerAdapter#getModelAndViewï¼šè·å– ModelAndView å¯¹è±¡ modelFactory.updateModel(webRequest, mavContainer)ï¼šModel æ•°æ®å‡çº§åˆ°ä¼šè¯åŸŸï¼ˆè¯·æ±‚åŸŸä¸­çš„æ•°æ®åœ¨é‡å®šå‘æ—¶ä¸¢å¤±ï¼‰ updateBindingResult(request, defaultModel)ï¼šæŠŠç»‘å®šçš„æ•°æ®æ·»åŠ åˆ° BindingAwareModelMap ä¸­ if (mavContainer.isRequestHandled())ï¼šåˆ¤æ–­è¯·æ±‚æ˜¯å¦å·²ç»å¤„ç†å®Œæˆäº† ModelMap model = mavContainer.getModel()ï¼šè·å–åŒ…å« Controller æ–¹æ³•å‚æ•°çš„ BindingAwareModelMapï¼ˆæœ¬èŠ‚å¼€å¤´ï¼‰ mav = new ModelAndView()ï¼šæŠŠ ModelAndViewContainer å’Œ ModelMap ä¸­çš„æ•°æ®å°è£…åˆ° ModelAndView if (!mavContainer.isViewReference())ï¼šæ˜¯å¦æ˜¯é€šè¿‡åç§°æŒ‡å®šè§†å›¾å¼•ç”¨ if (model instanceof RedirectAttributes)ï¼šåˆ¤æ–­ model æ˜¯å¦æ˜¯é‡å®šå‘æ•°æ®ï¼Œå¦‚æœæ˜¯è¿›è¡Œé‡å®šå‘é€»è¾‘ return mavï¼šä»»ä½•æ–¹æ³•æ‰§è¡Œéƒ½ä¼šè¿”å› ModelAndView å¯¹è±¡ å‚æ•°è§£æè§£æè‡ªå®šä¹‰çš„ JavaBean ä¸ºä¾‹ï¼Œè°ƒç”¨ ModelAttributeMethodProcessor#resolveArgument å¤„ç†å‚æ•°çš„æ–¹æ³•ï¼Œé€šè¿‡åˆé€‚çš„ç±»å‹è½¬æ¢å™¨æŠŠ URL ä¸­çš„å‚æ•°è½¬æ¢ä»¥åï¼Œåˆ©ç”¨åå°„è·å– set æ–¹æ³•ï¼Œæ³¨å…¥åˆ° JavaBean Person.javaï¼š 1234567@Data@Component //åŠ å…¥åˆ°å®¹å™¨ä¸­public class Person &#123; private String userName; private Integer age; private Date birth;&#125; Controllerï¼š 12345678@RestController //è¿”å›çš„æ•°æ®ä¸æ˜¯é¡µé¢public class ParameterController &#123; // æ•°æ®ç»‘å®šï¼šé¡µé¢æäº¤çš„è¯·æ±‚æ•°æ®ï¼ˆGETã€POSTï¼‰éƒ½å¯ä»¥å’Œå¯¹è±¡å±æ€§è¿›è¡Œç»‘å®š @GetMapping(&quot;/saveuser&quot;) public Person saveuser(Person person)&#123; return person; &#125;&#125; è®¿é—® URLï¼šhttp://localhost:8080/saveuser?userName=zhangsan&amp;age=20 è¿›å…¥æºç ï¼šModelAttributeMethodProcessor#resolveArgument name = ModelFactory.getNameForParameter(parameter)ï¼šè·å–åå­—ï¼Œæ­¤ä¾‹å°±æ˜¯ person ann = parameter.getParameterAnnotation(ModelAttribute.class)ï¼šæ˜¯å¦æœ‰ ModelAttribute æ³¨è§£ if (mavContainer.containsAttribute(name))ï¼šModelAndViewContainer ä¸­æ˜¯å¦åŒ…å« person å¯¹è±¡ attribute = createAttribute()ï¼šåˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œç©ºçš„ Person å¯¹è±¡ binder = binderFactory.createBinder(webRequest, attribute, name)ï¼šWeb æ•°æ®ç»‘å®šå™¨ï¼Œå¯ä»¥åˆ©ç”¨ Converters å°†è¯·æ±‚æ•°æ®è½¬æˆæŒ‡å®šçš„æ•°æ®ç±»å‹ï¼Œç»‘å®šåˆ° JavaBean ä¸­ bindRequestParameters(binder, webRequest)ï¼šåˆ©ç”¨åå°„å‘ç›®æ ‡å¯¹è±¡å¡«å……æ•°æ® servletBinder = (ServletRequestDataBinder) binderï¼šç±»å‹å¼ºè½¬ servletBinder.bind(servletRequest)ï¼šç»‘å®šæ•°æ® mpvs = new MutablePropertyValues(request.getParameterMap())ï¼šè·å–è¯·æ±‚ URI å‚æ•°ä¸­çš„ k-v é”®å€¼å¯¹ addBindValues(mpvs, request)ï¼šå­ç±»å¯ä»¥ç”¨æ¥ä¸ºè¯·æ±‚æ·»åŠ é¢å¤–ç»‘å®šå€¼ doBind(mpvs)ï¼šçœŸæ­£çš„ç»‘å®šçš„æ–¹æ³•ï¼Œè°ƒç”¨ applyPropertyValues åº”ç”¨å‚æ•°å€¼ï¼Œç„¶åè°ƒç”¨ setPropertyValues æ–¹æ³• AbstractPropertyAccessor#setPropertyValues()ï¼š List&lt;PropertyValue&gt; propertyValuesï¼šè·å–åˆ°æ‰€æœ‰çš„å‚æ•°çš„å€¼ï¼Œå°±æ˜¯ URI ä¸Šçš„æ‰€æœ‰çš„å‚æ•°å€¼ for (PropertyValue pv : propertyValues)ï¼šéå†æ‰€æœ‰çš„å‚æ•°å€¼ setPropertyValue(pv)ï¼šå¡«å……åˆ°ç©ºçš„ Person å®ä¾‹ä¸­ nestedPa = getPropertyAccessorForPropertyPath(propertyName)ï¼šè·å–å±æ€§è®¿é—®å™¨ tokens = getPropertyNameTokens()ï¼šè·å–å…ƒæ•°æ®çš„ä¿¡æ¯ nestedPa.setPropertyValue(tokens, pv)ï¼šå¡«å……æ•°æ® processLocalProperty(tokens, pv)ï¼šå¤„ç†å±æ€§ if (!Boolean.FALSE.equals(pv.conversionNecessary))ï¼šæ•°æ®æ˜¯å¦éœ€è¦è½¬æ¢äº† if (pv.isConverted())ï¼šæ•°æ®å·²ç»è½¬æ¢è¿‡äº†ï¼Œè½¬æ¢äº†ç›´æ¥èµ‹å€¼ï¼Œæ²¡è½¬æ¢è¿›è¡Œè½¬æ¢ oldValue = ph.getValue()ï¼šè·å–æœªè½¬æ¢çš„æ•°æ® valueToApply = convertForProperty()ï¼šè¿›è¡Œæ•°æ®è½¬æ¢ TypeConverterDelegate#convertIfNecessaryï¼šè¿›å…¥è¯¥æ–¹æ³•çš„é€»è¾‘ if (conversionService.canConvert(sourceTypeDesc, typeDescriptor))ï¼šåˆ¤æ–­èƒ½ä¸èƒ½è½¬æ¢ GenericConverter converter = getConverter(sourceType, targetType)ï¼šè·å–ç±»å‹è½¬æ¢å™¨ converter = this.converters.find(sourceType, targetType)ï¼šå¯»æ‰¾åˆé€‚çš„è½¬æ¢å™¨ sourceCandidates = getClassHierarchy(sourceType.getType())ï¼šåŸæ•°æ®ç±»å‹ targetCandidates = getClassHierarchy(targetType.getType())ï¼šç›®æ ‡æ•°æ®ç±»å‹ 123for (Class&lt;?&gt; sourceCandidate : sourceCandidates) &#123; //åŒé‡å¾ªç¯éå†ï¼Œå¯»æ‰¾åˆé€‚çš„è½¬æ¢å™¨ for (Class&lt;?&gt; targetCandidate : targetCandidates) &#123; GenericConverter converter = getRegisteredConverter(..)ï¼šåŒ¹é…ç±»å‹è½¬æ¢å™¨ return converterï¼šè¿”å›è½¬æ¢å™¨ conversionService.convert(newValue, sourceTypeDesc, typeDescriptor)ï¼šå¼€å§‹è½¬æ¢ converter = getConverter(sourceType, targetType)ï¼šè·å–å¯ç”¨çš„è½¬æ¢å™¨ result = ConversionUtils.invokeConverter()ï¼šæ‰§è¡Œè½¬æ¢æ–¹æ³• converter.convert()ï¼šè°ƒç”¨è½¬æ¢å™¨çš„è½¬æ¢æ–¹æ³•ï¼ˆGenericConverter#convertï¼‰ return handleResult(sourceType, targetType, result)ï¼šè¿”å›ç»“æœ ph.setValue(valueToApply)ï¼šè®¾ç½® JavaBean å±æ€§ï¼ˆBeanWrapperImpl.BeanPropertyHandlerï¼‰ Method writeMethodï¼šè·å–å†™æ•°æ®æ–¹æ³• Class&lt;?&gt; cls = getClass0()ï¼šè·å– Class å¯¹è±¡ writeMethodName = Introspector.SET_PREFIX + getBaseName()ï¼šset å‰ç¼€ + å±æ€§å writeMethod = Introspector.findMethod(cls, writeMethodName, 1, args)ï¼šè·å–åªåŒ…å«ä¸€ä¸ªå‚æ•°çš„ set æ–¹æ³• setWriteMethod(writeMethod)ï¼šåŠ å…¥ç¼“å­˜ ReflectionUtils.makeAccessible(writeMethod)ï¼šè®¾ç½®è®¿é—®æƒé™ writeMethod.invoke(getWrappedInstance(), value)ï¼šæ‰§è¡Œæ–¹æ³• bindingResult = binder.getBindingResult()ï¼šè·å–ç»‘å®šçš„ç»“æœ mavContainer.addAllAttributes(bindingResultModel)ï¼šæŠŠæ‰€æœ‰å¡«å……çš„å‚æ•°æ”¾å…¥ ModelAndViewContainer return attributeï¼šè¿”å›å¡«å……åçš„ Person å¯¹è±¡ å“åº”å¤„ç†å“åº”æ•°æ®ä»¥ Person ä¸ºä¾‹ï¼š 123456789@ResponseBody // åˆ©ç”¨è¿”å›å€¼å¤„ç†å™¨é‡Œé¢çš„æ¶ˆæ¯è½¬æ¢å™¨è¿›è¡Œå¤„ç†ï¼Œè€Œä¸æ˜¯è§†å›¾@GetMapping(value = &quot;/person&quot;)public Person getPerson()&#123; Person person = new Person(); person.setAge(28); person.setBirth(new Date()); person.setUserName(&quot;zhangsan&quot;); return person;&#125; ç›´æ¥è¿›å…¥æ–¹æ³•æ‰§è¡Œå®Œåçš„é€»è¾‘ ServletInvocableHandlerMethod#invokeAndHandleï¼š 1234567891011121314151617181920212223242526272829public void invokeAndHandle(ServletWebRequest webRequest, ModelAndViewContainer mavContainer, Object... providedArgs) throws Exception &#123; // ã€æ‰§è¡Œç›®æ ‡æ–¹æ³•ã€‘ï¼Œreturn person å¯¹è±¡ Object returnValue = invokeForRequest(webRequest, mavContainer, providedArgs); // è®¾ç½®çŠ¶æ€ç  setResponseStatus(webRequest); // åˆ¤æ–­æ–¹æ³•æ˜¯å¦æœ‰è¿”å›å€¼ if (returnValue == null) &#123; if (isRequestNotModified(webRequest) || getResponseStatus() != null || mavContainer.isRequestHandled()) &#123; disableContentCachingIfNecessary(webRequest); mavContainer.setRequestHandled(true); return; &#125; &#125; // è¿”å›å€¼æ˜¯å­—ç¬¦ä¸² else if (StringUtils.hasText(getResponseStatusReason())) &#123; // è®¾ç½®è¯·æ±‚å¤„ç†å®Œæˆ mavContainer.setRequestHandled(true); return; // è®¾ç½®è¯·æ±‚æ²¡æœ‰å¤„ç†å®Œæˆï¼Œè¿˜éœ€è¦è¿›è¡Œè¿”å›å€¼çš„é€»è¾‘ mavContainer.setRequestHandled(false); Assert.state(this.returnValueHandlers != null, &quot;No return value handlers&quot;); try &#123; // ã€è¿”å›å€¼çš„å¤„ç†ã€‘ this.returnValueHandlers.handleReturnValue( returnValue, getReturnValueType(returnValue), mavContainer, webRequest); &#125; catch (Exception ex) &#123;&#125;&#125; æ²¡æœ‰åŠ  @ResponseBody æ³¨è§£çš„è¿”å›æ•°æ®æŒ‰ç…§è§†å›¾å¤„ç†çš„é€»è¾‘ï¼ŒViewNameMethodReturnValueHandlerï¼ˆè§†å›¾è¯¦è§£ï¼‰ æ­¤ä¾‹æ˜¯åŠ äº†æ³¨è§£çš„ï¼Œè¿”å›çš„æ•°æ®ä¸æ˜¯è§†å›¾ï¼ŒHandlerMethodReturnValueHandlerComposite#handleReturnValueï¼š 12345678910public void handleReturnValue(@Nullable Object returnValue, MethodParameter returnType, ModelAndViewContainer mavContainer, NativeWebRequest webRequest) &#123; // è·å–åˆé€‚çš„è¿”å›å€¼å¤„ç†å™¨ HandlerMethodReturnValueHandler handler = selectHandler(returnValue, returnType); if (handler == null) &#123; throw new IllegalArgumentException(); &#125; // ä½¿ç”¨å¤„ç†å™¨å¤„ç†è¿”å›å€¼ï¼ˆè¯¦è§£æºç ä¸­çš„è¿™ä¸¤ä¸ªå‡½æ•°ï¼‰ handler.handleReturnValue(returnValue, returnType, mavContainer, webRequest);&#125; HandlerMethodReturnValueHandlerComposite#selectHandlerï¼šè·å–åˆé€‚çš„è¿”å›å€¼å¤„ç†å™¨ boolean isAsyncValue = isAsyncReturnValue(value, returnType)ï¼šæ˜¯å¦æ˜¯å¼‚æ­¥è¯·æ±‚ for (HandlerMethodReturnValueHandler handler : this.returnValueHandlers)ï¼šéå†æ‰€æœ‰çš„è¿”å›å€¼å¤„ç†å™¨ RequestResponseBodyMethodProcessor#supportsReturnTypeï¼šå¤„ç†æ ‡æ³¨ @ResponseBody æ³¨è§£çš„è¿”å›å€¼ ModelAndViewMethodReturnValueHandler#supportsReturnTypeï¼šå¤„ç†è¿”å›å€¼ç±»å‹æ˜¯ ModelAndView çš„å¤„ç†å™¨ ModelAndViewResolverMethodReturnValueHandler#supportsReturnTypeï¼šç›´æ¥è¿”å› trueï¼Œå¤„ç†æ‰€æœ‰æ•°æ® RequestResponseBodyMethodProcessor#handleReturnValueï¼šå¤„ç†è¿”å›å€¼ï¼Œè¦è¿›è¡Œå†…å®¹åå•† mavContainer.setRequestHandled(true)ï¼šè®¾ç½®è¯·æ±‚å¤„ç†å®Œæˆ inputMessage = createInputMessage(webRequest)ï¼šè·å–è¾“å…¥çš„æ•°æ® outputMessage = createOutputMessage(webRequest)ï¼šè·å–è¾“å‡ºçš„æ•°æ® writeWithMessageConverters(returnValue, returnType, inputMessage, outputMessage)ï¼šä½¿ç”¨æ¶ˆæ¯è½¬æ¢å™¨è¿›è¡Œå†™å‡º if (value instanceof CharSequence)ï¼šåˆ¤æ–­è¿”å›çš„æ•°æ®æ˜¯ä¸æ˜¯å­—ç¬¦ç±»å‹ body = valueï¼šæŠŠ value èµ‹å€¼ç»™ bodyï¼Œæ­¤æ—¶ body ä¸­å°±æ˜¯è‡ªå®šä¹‰æ–¹æ³•æ‰§è¡Œå®Œåçš„ Person å¯¹è±¡ if (isResourceType(value, returnType))ï¼šå½“å‰æ•°æ®æ˜¯ä¸æ˜¯æµæ•°æ® MediaType selectedMediaTypeï¼šå†…å®¹åå•†åé€‰æ‹©ä½¿ç”¨çš„ç±»å‹ï¼Œæµè§ˆå™¨å’ŒæœåŠ¡å™¨éƒ½æ”¯æŒçš„åª’ä½“ï¼ˆæ•°æ®ï¼‰ç±»å‹ MediaType contentType = outputMessage.getHeaders().getContentType()ï¼šè·å–å“åº”å¤´çš„æ•°æ® if (contentType != null &amp;&amp; contentType.isConcrete())ï¼šåˆ¤æ–­å½“å‰å“åº”å¤´ä¸­æ˜¯å¦å·²ç»æœ‰ç¡®å®šçš„åª’ä½“ç±»å‹ selectedMediaType = contentTypeï¼šå‰ç½®å¤„ç†å·²ç»ä½¿ç”¨äº†åª’ä½“ç±»å‹ï¼Œç›´æ¥ç»§ç»­ä½¿ç”¨è¯¥ç±»å‹ acceptableTypes = getAcceptableMediaTypes(request)ï¼šè·å–æµè§ˆå™¨æ”¯æŒçš„åª’ä½“ç±»å‹ï¼Œè¯·æ±‚å¤´å­—æ®µ this.contentNegotiationManager.resolveMediaTypes()ï¼šè°ƒç”¨è¯¥æ–¹æ³• for(ContentNegotiationStrategy strategy:this.strategies)ï¼šé»˜è®¤ç­–ç•¥æ˜¯æå–è¯·æ±‚å¤´çš„å­—æ®µçš„å†…å®¹ï¼Œç­–ç•¥ç±»ä¸ºHeaderContentNegotiationStrategyï¼Œå¯ä»¥é…ç½®æ·»åŠ å…¶ä»–ç±»å‹çš„ç­–ç•¥ List&lt;MediaType&gt; mediaTypes = strategy.resolveMediaTypes(request)ï¼šè§£æ Accept å­—æ®µå­˜å‚¨ä¸º List headerValueArray = request.getHeaderValues(HttpHeaders.ACCEPT)ï¼šè·å–è¯·æ±‚å¤´ä¸­ Accept å­—æ®µ List&lt;MediaType&gt; mediaTypes = MediaType.parseMediaTypes(headerValues)ï¼šè§£ææˆ List é›†åˆ MediaType.sortBySpecificityAndQuality(mediaTypes)ï¼šæŒ‰ç…§ç›¸å¯¹å“è´¨å› æ•° q é™åºæ’åº producibleTypes = getProducibleMediaTypes(request, valueType, targetType)ï¼šæœåŠ¡å™¨èƒ½ç”Ÿæˆçš„åª’ä½“ç±»å‹ request.getAttribute(HandlerMapping.PRODUCIBLE_MEDIA_TYPES_ATTRIBUTE)ï¼šä»è¯·æ±‚åŸŸè·å–é»˜è®¤çš„åª’ä½“ç±»å‹ for (HttpMessageConverter&lt;?&gt; converter : this.messageConverters)ï¼šéå†æ‰€æœ‰çš„æ¶ˆæ¯è½¬æ¢å™¨ converter.canWrite(valueClass, null)ï¼šæ˜¯å¦æ”¯æŒå½“å‰çš„ç±»å‹ result.addAll(converter.getSupportedMediaTypes())ï¼šæŠŠå½“å‰ MessageConverter æ”¯æŒçš„æ‰€æœ‰ç±»å‹æ”¾å…¥ result List&lt;MediaType&gt; mediaTypesToUse = new ArrayList&lt;&gt;()ï¼šå­˜å‚¨æœ€ä½³åŒ¹é…çš„é›†åˆ å†…å®¹åå•†ï¼š 12345678for (MediaType requestedType : acceptableTypes) &#123; // éå†æ‰€æœ‰æµè§ˆå™¨èƒ½æ¥å—çš„åª’ä½“ç±»å‹ for (MediaType producibleType : producibleTypes) &#123; // éå†æ‰€æœ‰æœåŠ¡å™¨èƒ½äº§å‡ºçš„ if (requestedType.isCompatibleWith(producibleType)) &#123; // åˆ¤æ–­ç±»å‹æ˜¯å¦åŒ¹é…ï¼Œæœ€ä½³åŒ¹é… // æ•°æ®åå•†åŒ¹é…æˆåŠŸï¼Œä¸€èˆ¬æœ‰å¤šç§ mediaTypesToUse.add(getMostSpecificMediaType(requestedType, producibleType)); &#125; &#125;&#125; MediaType.sortBySpecificityAndQuality(mediaTypesToUse)ï¼šæŒ‰ç…§ç›¸å¯¹å“è´¨å› æ•° q æ’åºï¼Œé™åºæ’åºï¼Œè¶Šå¤§çš„è¶Šå¥½ for (MediaType mediaType : mediaTypesToUse)ï¼šéå†æ‰€æœ‰çš„æœ€ä½³åŒ¹é…ï¼Œé€‰æ‹©ä¸€ç§èµ‹å€¼ç»™é€‰æ‹©çš„ç±»å‹ selectedMediaType = selectedMediaType.removeQualityValue()ï¼šåª’ä½“ç±»å‹å»é™¤ç›¸å¯¹å“è´¨å› æ•° for (HttpMessageConverter&lt;?&gt; converter : this.messageConverters)ï¼šéå†æ‰€æœ‰çš„ HTTP æ•°æ®è½¬æ¢å™¨ GenericHttpMessageConverter genericConverterï¼šMappingJackson2HttpMessageConverter å¯ä»¥å°†å¯¹è±¡å†™ä¸º JSON ((GenericHttpMessageConverter) converter).canWrite()ï¼šåˆ¤æ–­è½¬æ¢å™¨æ˜¯å¦å¯ä»¥å†™å‡ºç»™å®šçš„ç±»å‹ AbstractJackson2HttpMessageConverter#canWrit if (!canWrite(mediaType))ï¼šæ˜¯å¦å¯ä»¥å†™å‡ºæŒ‡å®šç±»å‹ MediaType.ALL.equalsTypeAndSubtype(mediaType)ï¼šæ˜¯ä¸æ˜¯ */* ç±»å‹ getSupportedMediaTypes()ï¼šæ”¯æŒ application/json å’Œ application/*+json ä¸¤ç§ç±»å‹ return trueï¼šè¿”å› true objectMapper = selectObjectMapper(clazz, mediaType)ï¼šé€‰æ‹©å¯ä»¥ä½¿ç”¨çš„ objectMapper causeRef = new AtomicReference&lt;&gt;()ï¼šè·å–å¹¶å‘å®‰å…¨çš„å¼•ç”¨ if (objectMapper.canSerialize(clazz, causeRef))ï¼šobjectMapper å¯ä»¥åºåˆ—åŒ–å½“å‰ç±» return trueï¼šè¿”å› true body = getAdvice().beforeBodyWrite()ï¼šè·å–è¦å“åº”çš„æ‰€æœ‰æ•°æ®ï¼Œå°±æ˜¯ Person å¯¹è±¡ addContentDispositionHeader(inputMessage, outputMessage)ï¼šæ£€æŸ¥è·¯å¾„ genericConverter.write(body, targetType, selectedMediaType, outputMessage)ï¼šè°ƒç”¨æ¶ˆæ¯è½¬æ¢å™¨çš„ write æ–¹æ³• AbstractGenericHttpMessageConverter#writeï¼šè¯¥ç±»çš„æ–¹æ³• addDefaultHeaders(headers, t, contentType)ï¼šè®¾ç½®å“åº”å¤´ä¸­çš„æ•°æ®ç±»å‹ writeInternal(t, type, outputMessage)ï¼šæ•°æ®å†™å‡ºä¸º JSON æ ¼å¼ Object value = objectï¼švalue å¼•ç”¨ Person å¯¹è±¡ ObjectWriter objectWriter = objectMapper.writer()ï¼šè·å– ObjectWriter å¯¹è±¡ objectWriter.writeValue(generator, value)ï¼šä½¿ç”¨ ObjectWriter å†™å‡ºæ•°æ®ä¸º JSON åå•†ç­–ç•¥å¼€å¯åŸºäºè¯·æ±‚å‚æ•°çš„å†…å®¹åå•†æ¨¡å¼ï¼šï¼ˆSpringBoot æ–¹å¼ï¼‰ 1spring.mvc.contentnegotiation:favor-parameter: true # å¼€å¯è¯·æ±‚å‚æ•°å†…å®¹åå•†æ¨¡å¼ å‘è¯·æ±‚ï¼š http://localhost:8080/person?format=jsonï¼Œè§£æ format ç­–ç•¥ç±»ä¸º ParameterContentNegotiationStrategyï¼Œè¿è¡Œæµç¨‹å¦‚ä¸‹ï¼š acceptableTypes = getAcceptableMediaTypes(request)ï¼šè·å–æµè§ˆå™¨æ”¯æŒçš„åª’ä½“ç±»å‹ mediaTypes = strategy.resolveMediaTypes(request)ï¼šè§£æè¯·æ±‚ URL å‚æ•°ä¸­çš„æ•°æ® return resolveMediaTypeKey(webRequest, getMediaTypeKey(webRequest))ï¼š getMediaTypeKey(webRequest)ï¼š request.getParameter(getParameterName())ï¼šè·å– URL ä¸­æŒ‡å®šçš„éœ€æ±‚çš„æ•°æ®ç±»å‹ getParameterName()ï¼šè·å–å‚æ•°çš„å±æ€§å format getParameter()ï¼šè·å– URL ä¸­ format å¯¹åº”çš„æ•°æ® resolveMediaTypeKey()ï¼šè§£æåª’ä½“ç±»å‹ï¼Œå°è£…æˆé›†åˆ è‡ªå®šä¹‰å†…å®¹åå•†ç­–ç•¥ï¼š 123456789101112131415161718192021222324252627public class WebConfig implements WebMvcConfigurer &#123; @Bean public WebMvcConfigurer webMvcConfigurer() &#123; return new WebMvcConfigurer() &#123; @Override //è‡ªå®šä¹‰å†…å®¹åå•†ç­–ç•¥ public void configureContentNegotiation(ContentNegotiationConfigurer configurer) &#123; Map&lt;String, MediaType&gt; mediaTypes = new HashMap&lt;&gt;(); mediaTypes.put(&quot;json&quot;, MediaType.APPLICATION_JSON); mediaTypes.put(&quot;xml&quot;,MediaType.APPLICATION_XML); mediaTypes.put(&quot;person&quot;,MediaType.parseMediaType(&quot;application/x-person&quot;)); // æŒ‡å®šæ”¯æŒè§£æå“ªäº›å‚æ•°å¯¹åº”çš„å“ªäº›åª’ä½“ç±»å‹ ParameterContentNegotiationStrategy parameterStrategy = new ParameterContentNegotiationStrategy(mediaTypes); // è¯·æ±‚å¤´è§£æ HeaderContentNegotiationStrategy headStrategy = new HeaderContentNegotiationStrategy(); // æ·»åŠ åˆ°å®¹å™¨ä¸­ï¼Œå³å¯ä»¥è§£æè¯·æ±‚å¤´ åˆå¯ä»¥è§£æè¯·æ±‚å‚æ•° configurer.strategies(Arrays.asList(parameterStrategy,headStrategy)); &#125; @Override // è‡ªå®šä¹‰æ¶ˆæ¯è½¬æ¢å™¨ public void extendMessageConverters(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters) &#123; converters.add(new GuiguMessageConverter()); &#125; &#125; &#125;&#125; ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ HttpMessageConverterï¼Œå®ç° HttpMessageConverter æ¥å£é‡å†™æ–¹æ³•å³å¯ è§†å›¾è§£æè¿”å›è§£æè¯·æ±‚å¤„ç†ï¼š 12345@GetMapping(&quot;/params&quot;)public String param()&#123; return &quot;forward:/success&quot;; //return &quot;redirect:/success&quot;;&#125; è¿›å…¥æ‰§è¡Œæ–¹æ³•é€»è¾‘ ServletInvocableHandlerMethod#invokeAndHandleï¼Œè¿›å…¥ this.returnValueHandlers.handleReturnValueï¼š 12345678910public void handleReturnValue(@Nullable Object returnValue, MethodParameter returnType, ModelAndViewContainer mavContainer, NativeWebRequest webRequest) &#123; // è·å–åˆé€‚çš„è¿”å›å€¼å¤„ç†å™¨ï¼šè°ƒç”¨ if (handler.supportsReturnType(returnType))åˆ¤æ–­æ˜¯å¦æ”¯æŒ HandlerMethodReturnValueHandler handler = selectHandler(returnValue, returnType); if (handler == null) &#123; throw new IllegalArgumentException(); &#125; // ä½¿ç”¨å¤„ç†å™¨å¤„ç†è¿”å›å€¼ handler.handleReturnValue(returnValue, returnType, mavContainer, webRequest);&#125; ViewNameMethodReturnValueHandler#supportsReturnTypeï¼š 12345public boolean supportsReturnType(MethodParameter returnType) &#123; Class&lt;?&gt; paramType = returnType.getParameterType(); // è¿”å›å€¼æ˜¯å¦æ˜¯ void æˆ–è€…æ˜¯ CharSequence å­—ç¬¦åºåˆ—ï¼Œè¿™é‡Œæ˜¯å­—ç¬¦åºåˆ— return (void.class == paramType || CharSequence.class.isAssignableFrom(paramType));&#125; ViewNameMethodReturnValueHandler#handleReturnValueï¼š 12345678910111213141516171819public void handleReturnValue(@Nullable Object returnValue, MethodParameter returnType, ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception &#123; // è¿”å›å€¼æ˜¯å­—ç¬¦ä¸²ï¼Œæ˜¯ return &quot;forward:/success&quot; if (returnValue instanceof CharSequence) &#123; String viewName = returnValue.toString(); // ã€æŠŠè§†å›¾åç§°è®¾ç½®è¿›å…¥ ModelAndViewContainer ä¸­ã€‘ mavContainer.setViewName(viewName); // åˆ¤æ–­æ˜¯å¦æ˜¯é‡å®šå‘æ•°æ® `viewName.startsWith(&quot;redirect:&quot;)` if (isRedirectViewName(viewName)) &#123; // å¦‚æœæ˜¯é‡å®šå‘ï¼Œè®¾ç½®æ˜¯é‡å®šå‘æŒ‡ä»¤ mavContainer.setRedirectModelScenario(true); &#125; &#125; else if (returnValue != null) &#123; // should not happen throw new UnsupportedOperationException(); &#125;&#125; ç»“æœæ´¾å‘doDispatch() ä¸­çš„ processDispatchResultï¼šå¤„ç†æ´¾å‘ç»“æœ 1234567891011121314151617private void processDispatchResult(HttpServletRequest request, HttpServletResponse response, @Nullable HandlerExecutionChain mappedHandler, @Nullable ModelAndView mv, @Nullable Exception exception) throws Exception &#123; boolean errorView = false; if (exception != null) &#123; &#125; // mv æ˜¯ ModelAndValue if (mv != null &amp;&amp; !mv.wasCleared()) &#123; // æ¸²æŸ“è§†å›¾ render(mv, request, response); if (errorView) &#123; WebUtils.clearErrorRequestAttributes(request); &#125; &#125; else &#123;&#125; &#125; DispatcherServlet#renderï¼š Locale locale = this.localeResolver.resolveLocale(request)ï¼šå›½é™…åŒ–ç›¸å…³ String viewName = mv.getViewName()ï¼šè§†å›¾åå­—ï¼Œæ˜¯è¯·æ±‚è½¬å‘ forward:&#x2F;successï¼ˆå“åº”æ•°æ®è§£æå¹¶å­˜å…¥ ModelAndViewï¼‰ view = resolveViewName(viewName, mv.getModelInternal(), locale, request)ï¼šè§£æè§†å›¾ for (ViewResolver viewResolver : this.viewResolvers)ï¼šéå†æ‰€æœ‰çš„è§†å›¾è§£æå™¨ view = viewResolver.resolveViewName(viewName, locale)ï¼šæ ¹æ®è§†å›¾åå­—è§£æè§†å›¾ï¼Œè°ƒç”¨å†…å®¹åå•†è§†å›¾å¤„ç†å™¨ ContentNegotiatingViewResolver çš„æ–¹æ³• attrs = RequestContextHolder.getRequestAttributes()ï¼šè·å–è¯·æ±‚çš„ç›¸å…³å±æ€§ä¿¡æ¯ requestedMediaTypes = getMediaTypes(((ServletRequestAttributes) attrs).getRequest())ï¼šè·å–æœ€ä½³åŒ¹é…çš„åª’ä½“ç±»å‹ï¼Œå‡½æ•°å†…è¿›è¡Œäº†åŒ¹é…çš„é€»è¾‘ candidateViews = getCandidateViews(viewName, locale, requestedMediaTypes)ï¼šè·å–å€™é€‰çš„è§†å›¾å¯¹è±¡ for (ViewResolver viewResolver : this.viewResolvers)ï¼šéå†æ‰€æœ‰çš„è§†å›¾è§£æå™¨ View view = viewResolver.resolveViewName(viewName, locale)ï¼šè§£æè§†å›¾ AbstractCachingViewResolver#resolveViewNameï¼š returnview = createView(viewName, locale)ï¼šUrlBasedViewResolver#createView è¯·æ±‚è½¬å‘ï¼šå®ä¾‹ä¸º InternalResourceView if (viewName.startsWith(FORWARD_URL_PREFIX))ï¼šè§†å›¾åå­—æ˜¯å¦æ˜¯ forward: çš„å‰ç¼€ forwardUrl = viewName.substring(FORWARD_URL_PREFIX.length())ï¼šåå­—æˆªå–å‰ç¼€ view = new InternalResourceView(forwardUrl)ï¼šæ–°å»º InternalResourceView å¯¹è±¡å¹¶è¿”å› return applyLifecycleMethods(FORWARD_URL_PREFIX, view)ï¼šSpring ä¸­çš„åˆå§‹åŒ–æ“ä½œ é‡å®šå‘ï¼šå®ä¾‹ä¸º RedirectView if (viewName.startsWith(REDIRECT_URL_PREFIX))ï¼šè§†å›¾åå­—æ˜¯å¦æ˜¯ redirect: çš„å‰ç¼€ redirectUrl = viewName.substring(REDIRECT_URL_PREFIX.length())ï¼šåå­—æˆªå–å‰ç¼€ RedirectView view = new RedirectView()ï¼šæ–°å»º RedirectView å¯¹è±¡å¹¶è¿”å› bestView = getBestView(candidateViews, requestedMediaTypes, attrs)ï¼šé€‰å‡ºæœ€ä½³åŒ¹é…çš„è§†å›¾å¯¹è±¡ view.render(mv.getModelInternal(), request, response)ï¼šé¡µé¢æ¸²æŸ“ mergedModel = createMergedOutputModel(model, request, response)ï¼šæŠŠè¯·æ±‚åŸŸä¸­çš„æ•°æ®å°è£…åˆ° model prepareResponse(request, response)ï¼šå“åº”å‰çš„å‡†å¤‡å·¥ä½œï¼Œè®¾ç½®ä¸€äº›å“åº”å¤´ renderMergedOutputModel(mergedModel, getRequestToExpose(request), response)ï¼šæ¸²æŸ“è¾“å‡ºçš„æ•°æ® getRequestToExpose(request)ï¼šè·å– Servlet åŸç”Ÿçš„æ–¹å¼ è¯·æ±‚è½¬å‘ InternalResourceView çš„é€»è¾‘ï¼šè¯·æ±‚åŸŸä¸­çš„æ•°æ®ä¸ä¸¢å¤± exposeModelAsRequestAttributes(model, request)ï¼šæš´éœ² model ä½œä¸ºè¯·æ±‚åŸŸçš„å±æ€§ model.forEach()ï¼šéå† Model ä¸­çš„æ•°æ® request.setAttribute(name, value)ï¼šè®¾ç½®åˆ°è¯·æ±‚åŸŸä¸­ exposeHelpers(request)ï¼šè‡ªå®šä¹‰æ¥å£ dispatcherPath = prepareForRendering(request, response)ï¼šç¡®å®šè°ƒåº¦åˆ†æ´¾çš„è·¯å¾„ï¼Œæ­¤ä¾‹æ˜¯ &#x2F;success rd = getRequestDispatcher(request, dispatcherPath)ï¼šè·å– Servlet åŸç”Ÿçš„ RequestDispatcher å®ç°è½¬å‘ rd.forward(request, response)ï¼šå®ç°è¯·æ±‚è½¬å‘ é‡å®šå‘ RedirectView çš„é€»è¾‘ï¼šè¯·æ±‚åŸŸä¸­çš„æ•°æ®ä¼šä¸¢å¤± targetUrl = createTargetUrl(model, request)ï¼šè·å–ç›®æ ‡ URL enc = request.getCharacterEncoding()ï¼šè®¾ç½®ç¼–ç  UTF-8 appendQueryProperties(targetUrl, model, enc)ï¼šæ·»åŠ ä¸€äº›å±æ€§ï¼Œæ¯”å¦‚ url + ?name=123&amp;&amp;age=324 sendRedirect(request, response, targetUrl, this.http10Compatible)ï¼šé‡å®šå‘ response.sendRedirect(encodedURL)ï¼šä½¿ç”¨ Servlet åŸç”Ÿæ–¹æ³•å®ç°é‡å®šå‘ å¼‚æ­¥è°ƒç”¨è¯·æ±‚å‚æ•°åç§°ï¼š@RequestBody ç±»å‹ï¼šå½¢å‚æ³¨è§£ ä½ç½®ï¼šå¤„ç†å™¨ç±»ä¸­çš„æ–¹æ³•å½¢å‚å‰æ–¹ ä½œç”¨ï¼šå°†å¼‚æ­¥æäº¤æ•°æ®è½¬æ¢æˆæ ‡å‡†è¯·æ±‚å‚æ•°æ ¼å¼ï¼Œå¹¶èµ‹å€¼ç»™å½¢å‚èŒƒä¾‹ï¼š 12345678@Controller //æ§åˆ¶å±‚public class AjaxController &#123; @RequestMapping(&quot;/ajaxController&quot;) public String ajaxController(@RequestBody String message)&#123; System.out.println(message); return &quot;page.jsp&quot;; &#125; &#125; æ³¨è§£æ·»åŠ åˆ° POJO å‚æ•°å‰æ–¹æ—¶ï¼Œå°è£…çš„å¼‚æ­¥æäº¤æ•°æ®æŒ‰ç…§ POJO çš„å±æ€§æ ¼å¼è¿›è¡Œå…³ç³»æ˜ å°„ POJO ä¸­çš„å±æ€§å¦‚æœè¯·æ±‚æ•°æ®ä¸­æ²¡æœ‰ï¼Œå±æ€§å€¼ä¸º null POJO ä¸­æ²¡æœ‰çš„å±æ€§å¦‚æœè¯·æ±‚æ•°æ®ä¸­æœ‰ï¼Œä¸è¿›è¡Œæ˜ å°„ æ³¨è§£æ·»åŠ åˆ°é›†åˆå‚æ•°å‰æ–¹æ—¶ï¼Œå°è£…çš„å¼‚æ­¥æäº¤æ•°æ®æŒ‰ç…§é›†åˆçš„å­˜å‚¨ç»“æ„è¿›è¡Œå…³ç³»æ˜ å°„ 12345678910111213@RequestMapping(&quot;/ajaxPojoToController&quot;)//å¦‚æœå¤„ç†å‚æ•°æ˜¯POJOï¼Œä¸”é¡µé¢å‘é€çš„è¯·æ±‚æ•°æ®æ ¼å¼ä¸POJOä¸­çš„å±æ€§å¯¹åº”ï¼Œ@RequestBodyæ³¨è§£å¯ä»¥è‡ªåŠ¨æ˜ å°„å¯¹åº”è¯·æ±‚æ•°æ®åˆ°POJOä¸­public String ajaxPojoToController(@RequestBody User user)&#123; System.out.println(&quot;controller pojo :&quot;+user); return &quot;page.jsp&quot;;&#125;@RequestMapping(&quot;/ajaxListToController&quot;)//å¦‚æœå¤„ç†å‚æ•°æ˜¯Listé›†åˆä¸”å°è£…äº†POJOï¼Œä¸”é¡µé¢å‘é€çš„æ•°æ®æ˜¯JSONæ ¼å¼ï¼Œæ•°æ®å°†è‡ªåŠ¨æ˜ å°„åˆ°é›†åˆå‚æ•°public String ajaxListToController(@RequestBody List&lt;User&gt; userList)&#123; System.out.println(&quot;controller list :&quot;+userList); return &quot;page.jsp&quot;;&#125; ajax.jsp 12345678910111213141516171819202122232425262728293031323334353637383940414243&lt;%@page pageEncoding=&quot;UTF-8&quot; language=&quot;java&quot; contentType=&quot;text/html;UTF-8&quot; %&gt;&lt;a href=&quot;javascript:void(0);&quot; id=&quot;testAjax&quot;&gt;è®¿é—®springmvcåå°controller&lt;/a&gt;&lt;br/&gt;&lt;a href=&quot;javascript:void(0);&quot; id=&quot;testAjaxPojo&quot;&gt;ä¼ é€’Jsonæ ¼å¼POJO&lt;/a&gt;&lt;br/&gt;&lt;a href=&quot;javascript:void(0);&quot; id=&quot;testAjaxList&quot;&gt;ä¼ é€’Jsonæ ¼å¼List&lt;/a&gt;&lt;br/&gt; &lt;script type=&quot;text/javascript&quot; src=&quot;$&#123;pageContext.request.contextPath&#125;/js/jquery-3.3.1.min.js&quot;&gt;&lt;/script&gt;&lt;script type=&quot;text/javascript&quot;&gt; $(function () &#123; //ä¸ºid=&quot;testAjax&quot;çš„ç»„ä»¶ç»‘å®šç‚¹å‡»äº‹ä»¶ $(&quot;#testAjax&quot;).click(function()&#123; //å‘é€å¼‚æ­¥è°ƒç”¨ $.ajax(&#123; //è¯·æ±‚æ–¹å¼ï¼šPOSTè¯·æ±‚ type:&quot;POST&quot;, //è¯·æ±‚çš„åœ°å€ url:&quot;ajaxController&quot;, //è¯·æ±‚å‚æ•°ï¼ˆä¹Ÿå°±æ˜¯è¯·æ±‚å†…å®¹ï¼‰ data:&#x27;ajax message&#x27;, //å“åº”æ­£æ–‡ç±»å‹ dataType:&quot;text&quot;, //è¯·æ±‚æ­£æ–‡çš„MIMEç±»å‹ contentType:&quot;application/text&quot;, &#125;); &#125;); //ä¸ºid=&quot;testAjaxPojo&quot;çš„ç»„ä»¶ç»‘å®šç‚¹å‡»äº‹ä»¶ $(&quot;#testAjaxPojo&quot;).click(function()&#123; $.ajax(&#123; type:&quot;POST&quot;, url:&quot;ajaxPojoToController&quot;, data:&#x27;&#123;&quot;name&quot;:&quot;Jock&quot;,&quot;age&quot;:39&#125;&#x27;, dataType:&quot;text&quot;, contentType:&quot;application/json&quot;, &#125;); &#125;); //ä¸ºid=&quot;testAjaxList&quot;çš„ç»„ä»¶ç»‘å®šç‚¹å‡»äº‹ä»¶ $(&quot;#testAjaxList&quot;).click(function()&#123; $.ajax(&#123;//..... data:&#x27;[&#123;&quot;name&quot;:&quot;Jock&quot;,&quot;age&quot;:39&#125;,&#123;&quot;name&quot;:&quot;Jockme&quot;,&quot;age&quot;:40&#125;]&#x27;&#125;)&#125; &#125;&lt;/script&gt; web.xmlé…ç½®ï¼šè¯·æ±‚å“åº”ç« èŠ‚è¯·æ±‚ä¸­çš„web.xmlé…ç½® 1CharacterEncodingFilter + DispatcherServlet spring-mvc.xmlï¼š 123&lt;context:component-scan base-package=&quot;controller,domain&quot;/&gt;&lt;mvc:resources mapping=&quot;/js/**&quot; location=&quot;/js/&quot;/&gt;&lt;mvc:annotation-driven/&gt; å“åº”æ•°æ®æ³¨è§£ï¼š@ResponseBody ä½œç”¨ï¼šå°† Java å¯¹è±¡è½¬ä¸º json æ ¼å¼çš„æ•°æ® æ–¹æ³•è¿”å›å€¼ä¸º POJO æ—¶ï¼Œè‡ªåŠ¨å°è£…æ•°æ®æˆ Json å¯¹è±¡æ•°æ®ï¼š 1234567@RequestMapping(&quot;/ajaxReturnJson&quot;)@ResponseBodypublic User ajaxReturnJson()&#123; System.out.println(&quot;controller return json pojo...&quot;); User user = new User(&quot;Jockme&quot;,40); return user;&#125; æ–¹æ³•è¿”å›å€¼ä¸º List æ—¶ï¼Œè‡ªåŠ¨å°è£…æ•°æ®æˆ json å¯¹è±¡æ•°ç»„æ•°æ®ï¼š 12345678910111213@RequestMapping(&quot;/ajaxReturnJsonList&quot;)@ResponseBody//åŸºäºjackonæŠ€æœ¯ï¼Œä½¿ç”¨@ResponseBodyæ³¨è§£å¯ä»¥å°†è¿”å›çš„ä¿å­˜POJOå¯¹è±¡çš„é›†åˆè½¬æˆjsonæ•°ç»„æ ¼å¼æ•°æ®public List ajaxReturnJsonList()&#123; System.out.println(&quot;controller return json list...&quot;); User user1 = new User(&quot;Tom&quot;,3); User user2 = new User(&quot;Jerry&quot;,5); ArrayList al = new ArrayList(); al.add(user1); al.add(user2); return al;&#125; AJAX æ–‡ä»¶ï¼š 12345678910111213141516171819202122232425262728293031323334353637//ä¸ºid=&quot;testAjaxReturnString&quot;çš„ç»„ä»¶ç»‘å®šç‚¹å‡»äº‹ä»¶$(&quot;#testAjaxReturnString&quot;).click(function()&#123; //å‘é€å¼‚æ­¥è°ƒç”¨ $.ajax(&#123; type:&quot;POST&quot;, url:&quot;ajaxReturnString&quot;, //å›è°ƒå‡½æ•° success:function(data)&#123; //æ‰“å°è¿”å›ç»“æœ alert(data); &#125; &#125;);&#125;);//ä¸ºid=&quot;testAjaxReturnJson&quot;çš„ç»„ä»¶ç»‘å®šç‚¹å‡»äº‹ä»¶$(&quot;#testAjaxReturnJson&quot;).click(function()&#123; $.ajax(&#123; type:&quot;POST&quot;, url:&quot;ajaxReturnJson&quot;, success:function(data)&#123; alert(data[&#x27;name&#x27;]+&quot; , &quot;+data[&#x27;age&#x27;]); &#125; &#125;);&#125;);//ä¸ºid=&quot;testAjaxReturnJsonList&quot;çš„ç»„ä»¶ç»‘å®šç‚¹å‡»äº‹ä»¶$(&quot;#testAjaxReturnJsonList&quot;).click(function()&#123; $.ajax(&#123; type:&quot;POST&quot;, url:&quot;ajaxReturnJsonList&quot;, success:function(data)&#123; alert(data); alert(data[0][&quot;name&quot;]); alert(data[1][&quot;age&quot;]); &#125; &#125;);&#125;); è·¨åŸŸè®¿é—®è·¨åŸŸè®¿é—®ï¼šå½“é€šè¿‡åŸŸå A ä¸‹çš„æ“ä½œè®¿é—®åŸŸå B ä¸‹çš„èµ„æºæ—¶ï¼Œç§°ä¸ºè·¨åŸŸè®¿é—®ï¼Œè·¨åŸŸè®¿é—®æ—¶ï¼Œä¼šå‡ºç°æ— æ³•è®¿é—®çš„ç°è±¡ ç¯å¢ƒæ­å»ºï¼š ä¸ºå½“å‰ä¸»æœºæ·»åŠ å¤‡ç”¨åŸŸå ä¿®æ”¹ windows å®‰è£…ç›®å½•ä¸­çš„ host æ–‡ä»¶ æ ¼å¼ï¼š ip åŸŸå åŠ¨æ€åˆ·æ–° DNS å‘½ä»¤ï¼š ipconfig &#x2F;displaydns å‘½ä»¤ï¼š ipconfig &#x2F;flushdns è·¨åŸŸè®¿é—®æ”¯æŒï¼š åç§°ï¼š@CrossOrigin ç±»å‹ï¼šæ–¹æ³•æ³¨è§£ ã€ ç±»æ³¨è§£ ä½ç½®ï¼šå¤„ç†å™¨ç±»ä¸­çš„æ–¹æ³•ä¸Šæ–¹æˆ–ç±»ä¸Šæ–¹ ä½œç”¨ï¼šè®¾ç½®å½“å‰å¤„ç†å™¨æ–¹æ³• &#x2F; å¤„ç†å™¨ç±»ä¸­æ‰€æœ‰æ–¹æ³•æ”¯æŒè·¨åŸŸè®¿é—® èŒƒä¾‹ï¼š 1234567891011@RequestMapping(&quot;/cross&quot;)@ResponseBody//ä½¿ç”¨@CrossOriginå¼€å¯è·¨åŸŸè®¿é—®//æ ‡æ³¨åœ¨å¤„ç†å™¨æ–¹æ³•ä¸Šæ–¹è¡¨ç¤ºè¯¥æ–¹æ³•æ”¯æŒè·¨åŸŸè®¿é—®//æ ‡æ³¨åœ¨å¤„ç†å™¨ç±»ä¸Šæ–¹è¡¨ç¤ºè¯¥å¤„ç†å™¨ç±»ä¸­çš„æ‰€æœ‰å¤„ç†å™¨æ–¹æ³•å‡æ”¯æŒè·¨åŸŸè®¿é—®@CrossOriginpublic User cross(HttpServletRequest request)&#123; System.out.println(&quot;controller cross...&quot; + request.getRequestURL()); User user = new User(&quot;Jockme&quot;,36); return user;&#125; jsp æ–‡ä»¶ 123456789101112131415161718&lt;a href=&quot;javascript:void(0);&quot; id=&quot;testCross&quot;&gt;è·¨åŸŸè®¿é—®&lt;/a&gt;&lt;br/&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;$&#123;pageContext.request.contextPath&#125;/js/jquery-3.3.1.min.js&quot;&gt;&lt;/script&gt;&lt;script type=&quot;text/javascript&quot;&gt; $(function () &#123; //ä¸ºid=&quot;testCross&quot;çš„ç»„ä»¶ç»‘å®šç‚¹å‡»äº‹ä»¶ $(&quot;#testCross&quot;).click(function()&#123; //å‘é€å¼‚æ­¥è°ƒç”¨ $.ajax(&#123; type:&quot;POST&quot;, url:&quot;http://127.0.0.1/cross&quot;, //å›è°ƒå‡½æ•° success:function(data)&#123; alert(&quot;è·¨åŸŸè°ƒç”¨ä¿¡æ¯åé¦ˆ:&quot; + data[&#x27;name&#x27;] + &quot;,&quot; + data[&#x27;age&#x27;]); &#125; &#125;); &#125;); &#125;);&lt;/script&gt; æ‹¦æˆªå™¨åŸºæœ¬ä»‹ç»æ‹¦æˆªå™¨ï¼ˆInterceptorï¼‰æ˜¯ä¸€ç§åŠ¨æ€æ‹¦æˆªæ–¹æ³•è°ƒç”¨çš„æœºåˆ¶ ä½œç”¨ï¼š åœ¨æŒ‡å®šçš„æ–¹æ³•è°ƒç”¨å‰åæ‰§è¡Œé¢„å…ˆè®¾å®šåçš„çš„ä»£ç  é˜»æ­¢åŸå§‹æ–¹æ³•çš„æ‰§è¡Œ æ ¸å¿ƒåŸç†ï¼šAOP æ€æƒ³ æ‹¦æˆªå™¨é“¾ï¼šå¤šä¸ªæ‹¦æˆªå™¨æŒ‰ç…§ä¸€å®šçš„é¡ºåºï¼Œå¯¹åŸå§‹è¢«è°ƒç”¨åŠŸèƒ½è¿›è¡Œå¢å¼º æ‹¦æˆªå™¨å’Œè¿‡æ»¤å™¨å¯¹æ¯”ï¼š å½’å±ä¸åŒï¼š Filter å±äº Servlet æŠ€æœ¯ï¼Œ Interceptor å±äº SpringMVC æŠ€æœ¯ æ‹¦æˆªå†…å®¹ä¸åŒï¼š Filter å¯¹æ‰€æœ‰è®¿é—®è¿›è¡Œå¢å¼ºï¼Œ Interceptor ä»…é’ˆå¯¹ SpringMVC çš„è®¿é—®è¿›è¡Œå¢å¼º å¤„ç†æ–¹æ³•å‰ç½®å¤„ç†åŸå§‹æ–¹æ³•ä¹‹å‰è¿è¡Œï¼š 123456public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123; System.out.println(&quot;preHandle&quot;); return true;&#125; å‚æ•°ï¼š requestï¼šè¯·æ±‚å¯¹è±¡ responseï¼šå“åº”å¯¹è±¡ handlerï¼šè¢«è°ƒç”¨çš„å¤„ç†å™¨å¯¹è±¡ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ–¹æ³•å¯¹è±¡ï¼Œå¯¹åå°„ä¸­çš„Methodå¯¹è±¡è¿›è¡Œäº†å†åŒ…è£… handlerï¼špublic String controller.InterceptorController.handleRun handler.getClass()ï¼šorg.springframework.web.method.HandlerMethod è¿”å›å€¼ï¼š è¿”å›å€¼ä¸º falseï¼Œè¢«æ‹¦æˆªçš„å¤„ç†å™¨å°†ä¸æ‰§è¡Œ åç½®å¤„ç†åŸå§‹æ–¹æ³•è¿è¡Œåè¿è¡Œï¼Œå¦‚æœåŸå§‹æ–¹æ³•è¢«æ‹¦æˆªï¼Œåˆ™ä¸æ‰§è¡Œï¼š 123456public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception &#123; System.out.println(&quot;postHandle&quot;);&#125; å‚æ•°ï¼š modelAndViewï¼šå¦‚æœå¤„ç†å™¨æ‰§è¡Œå®Œæˆå…·æœ‰è¿”å›ç»“æœï¼Œå¯ä»¥è¯»å–åˆ°å¯¹åº”æ•°æ®ä¸é¡µé¢ä¿¡æ¯ï¼Œå¹¶è¿›è¡Œè°ƒæ•´ å¼‚å¸¸å¤„ç†æ‹¦æˆªå™¨æœ€åæ‰§è¡Œçš„æ–¹æ³•ï¼Œæ— è®ºåŸå§‹æ–¹æ³•æ˜¯å¦æ‰§è¡Œï¼š 123456public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception &#123; System.out.println(&quot;afterCompletion&quot;);&#125; å‚æ•°ï¼š exï¼šå¦‚æœå¤„ç†å™¨æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸å¯¹è±¡ï¼Œå¯ä»¥é’ˆå¯¹å¼‚å¸¸æƒ…å†µè¿›è¡Œå•ç‹¬å¤„ç† æ‹¦æˆªé…ç½®æ‹¦æˆªè·¯å¾„ï¼š /**ï¼šè¡¨ç¤ºæ‹¦æˆªæ‰€æœ‰æ˜ å°„ /* ï¼šè¡¨ç¤ºæ‹¦æˆªæ‰€æœ‰&#x2F;å¼€å¤´çš„æ˜ å°„ /user/*ï¼šè¡¨ç¤ºæ‹¦æˆªæ‰€æœ‰ &#x2F;user&#x2F; å¼€å¤´çš„æ˜ å°„ /user/add*ï¼šè¡¨ç¤ºæ‹¦æˆªæ‰€æœ‰ &#x2F;user&#x2F; å¼€å¤´ï¼Œä¸”å…·ä½“æ˜ å°„åç§°ä»¥ add å¼€å¤´çš„æ˜ å°„ /user/*Allï¼šè¡¨ç¤ºæ‹¦æˆªæ‰€æœ‰ &#x2F;user&#x2F; å¼€å¤´ï¼Œä¸”å…·ä½“æ˜ å°„åç§°ä»¥ All ç»“å°¾çš„æ˜ å°„ 1234567891011&lt;mvc:interceptors&gt; &lt;!--å¼€å¯å…·ä½“çš„æ‹¦æˆªå™¨çš„ä½¿ç”¨ï¼Œå¯ä»¥é…ç½®å¤šä¸ª--&gt; &lt;mvc:interceptor&gt; &lt;!--è®¾ç½®æ‹¦æˆªå™¨çš„æ‹¦æˆªè·¯å¾„ï¼Œæ”¯æŒ*é€šé…--&gt; &lt;mvc:mapping path=&quot;/handleRun*&quot;/&gt; &lt;!--è®¾ç½®æ‹¦æˆªæ’é™¤çš„è·¯å¾„ï¼Œé…ç½®/**æˆ–/*ï¼Œè¾¾åˆ°å¿«é€Ÿé…ç½®çš„ç›®çš„--&gt; &lt;mvc:exclude-mapping path=&quot;/b*&quot;/&gt; &lt;!--æŒ‡å®šå…·ä½“çš„æ‹¦æˆªå™¨ç±»--&gt; &lt;bean class=&quot;MyInterceptor&quot;/&gt; &lt;/mvc:interceptor&gt;&lt;/mvc:interceptors&gt; æ‹¦æˆªå™¨é“¾è´£ä»»é“¾æ¨¡å¼ï¼šè´£ä»»é“¾æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºæ¨¡å¼ ç‰¹ç‚¹ï¼šæ²¿ç€ä¸€æ¡é¢„å…ˆè®¾å®šçš„ä»»åŠ¡é“¾é¡ºåºæ‰§è¡Œï¼Œæ¯ä¸ªèŠ‚ç‚¹å…·æœ‰ç‹¬ç«‹çš„å·¥ä½œä»»åŠ¡ä¼˜åŠ¿ï¼š ç‹¬ç«‹æ€§ï¼šåªå…³æ³¨å½“å‰èŠ‚ç‚¹çš„ä»»åŠ¡ï¼Œå¯¹å…¶ä»–ä»»åŠ¡ç›´æ¥æ”¾è¡Œåˆ°ä¸‹ä¸€èŠ‚ç‚¹ éš”ç¦»æ€§ï¼šå…·å¤‡é“¾å¼ä¼ é€’ç‰¹å¾ï¼Œæ— éœ€çŸ¥æ™“æ•´ä½“é“¾è·¯ç»“æ„ï¼Œåªéœ€ç­‰å¾…è¯·æ±‚åˆ°è¾¾åè¿›è¡Œå¤„ç†å³å¯ çµæ´»æ€§ï¼šå¯ä»¥ä»»æ„ä¿®æ”¹é“¾è·¯ç»“æ„åŠ¨æ€æ–°å¢æˆ–åˆ å‡æ•´ä½“é“¾è·¯è´£ä»» è§£è€¦ï¼šå°†åŠ¨æ€ä»»åŠ¡ä¸åŸå§‹ä»»åŠ¡è§£è€¦ ç¼ºç‚¹ï¼š é“¾è·¯è¿‡é•¿æ—¶ï¼Œå¤„ç†æ•ˆç‡ä½ä¸‹ å¯èƒ½å­˜åœ¨èŠ‚ç‚¹ä¸Šçš„å¾ªç¯å¼•ç”¨ç°è±¡ï¼Œé€ æˆæ­»å¾ªç¯ï¼Œå¯¼è‡´ç³»ç»Ÿå´©æºƒ æºç è§£æDispatcherServlet#doDispatch æ–¹æ³•ä¸­ï¼š 123456789101112131415161718protected void doDispatch(HttpServletRequest request, HttpServletResponse response) throws Exception &#123; try &#123; // è·å–æ˜ å°„å™¨ä»¥åŠæ˜ å°„å™¨çš„æ‰€æœ‰æ‹¦æˆªå™¨ï¼ˆè¿è¡ŒåŸç†éƒ¨åˆ†è¯¦è§£äº†æºç ï¼‰ mappedHandler = getHandler(processedRequest); // å‰ç½®å¤„ç†ï¼Œè¿”å› false ä»£è¡¨æ¡ä»¶æˆç«‹ if (!mappedHandler.applyPreHandle(processedRequest, response)) &#123; //è¯·æ±‚ä»è¿™é‡Œç›´æ¥ç»“æŸ return; &#125; //æ‰€æœ‰æ‹¦æˆªå™¨éƒ½è¿”å› trueï¼Œæ‰§è¡Œç›®æ ‡æ–¹æ³• mv = ha.handle(processedRequest, response, mappedHandler.getHandler()) // å€’åºæ‰§è¡Œæ‰€æœ‰æ‹¦æˆªå™¨çš„åç½®å¤„ç†æ–¹æ³• mappedHandler.applyPostHandle(processedRequest, response, mv); &#125; catch (Exception ex) &#123; //å¼‚å¸¸å¤„ç†æœºåˆ¶ triggerAfterCompletion(processedRequest, response, mappedHandler, ex); &#125;&#125; HandlerExecutionChain#applyPreHandleï¼šå‰ç½®å¤„ç† 12345678910111213boolean applyPreHandle(HttpServletRequest request, HttpServletResponse response) throws Exception &#123; //éå†æ‰€æœ‰çš„æ‹¦æˆªå™¨ for (int i = 0; i &lt; this.interceptorList.size(); i++) &#123; HandlerInterceptor interceptor = this.interceptorList.get(i); //æ‰§è¡Œå‰ç½®å¤„ç†ï¼Œå¦‚æœæ‹¦æˆªå™¨è¿”å› falseï¼Œåˆ™æ¡ä»¶æˆç«‹ï¼Œä¸åœ¨æ‰§è¡Œå…¶ä»–çš„æ‹¦æˆªå™¨ï¼Œç›´æ¥è¿”å› falseï¼Œè¯·æ±‚ç›´æ¥ç»“æŸ if (!interceptor.preHandle(request, response, this.handler)) &#123; triggerAfterCompletion(request, response, null); return false; &#125; this.interceptorIndex = i; &#125; return true;&#125; HandlerExecutionChain#applyPostHandleï¼šåç½®å¤„ç† 12345678void applyPostHandle(HttpServletRequest request, HttpServletResponse response, @Nullable ModelAndView mv) throws Exception &#123; //å€’åºéå† for (int i = this.interceptorList.size() - 1; i &gt;= 0; i--) &#123; HandlerInterceptor interceptor = this.interceptorList.get(i); interceptor.postHandle(request, response, this.handler, mv); &#125;&#125; DispatcherServlet#triggerAfterCompletion åº•å±‚è°ƒç”¨ HandlerExecutionChain#triggerAfterCompletionï¼š å‰é¢çš„æ­¥éª¤æœ‰ä»»ä½•å¼‚å¸¸éƒ½ä¼šç›´æ¥å€’åºè§¦å‘ afterCompletion é¡µé¢æˆåŠŸæ¸²æŸ“æœ‰å¼‚å¸¸ï¼Œä¹Ÿä¼šå€’åºè§¦å‘ afterCompletion 12345678910111213void triggerAfterCompletion(HttpServletRequest request, HttpServletResponse response, @Nullable Exception ex) &#123; //å€’åºéå† for (int i = this.interceptorIndex; i &gt;= 0; i--) &#123; HandlerInterceptor interceptor = this.interceptorList.get(i); try &#123; //æ‰§è¡Œå¼‚å¸¸å¤„ç†çš„æ–¹æ³• interceptor.afterCompletion(request, response, this.handler, ex); &#125; catch (Throwable ex2) &#123; logger.error(&quot;HandlerInterceptor.afterCompletion threw exception&quot;, ex2); &#125; &#125;&#125; æ‹¦æˆªå™¨çš„æ‰§è¡Œæµç¨‹ï¼š å‚è€ƒæ–‡ç« ï¼šhttps://www.yuque.com/atguigu/springboot/vgzmgh#wtPLU è‡ªå®šä¹‰ Contollerå±‚ 12345678@Controllerpublic class InterceptorController &#123; @RequestMapping(&quot;/handleRun&quot;) public String handleRun() &#123; System.out.println(&quot;ä¸šåŠ¡å¤„ç†å™¨è¿è¡Œ------------main&quot;); return &quot;page.jsp&quot;; &#125;&#125; è‡ªå®šä¹‰æ‹¦æˆªå™¨éœ€è¦å®ç° HandleInterceptor æ¥å£ 12345678910111213141516171819202122232425262728293031//è‡ªå®šä¹‰æ‹¦æˆªå™¨éœ€è¦å®ç°HandleInterceptoræ¥å£public class MyInterceptor implements HandlerInterceptor &#123; //å¤„ç†å™¨è¿è¡Œä¹‹å‰æ‰§è¡Œ @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123; System.out.println(&quot;å‰ç½®è¿è¡Œ----a1&quot;); //è¿”å›å€¼ä¸ºfalseå°†æ‹¦æˆªåŸå§‹å¤„ç†å™¨çš„è¿è¡Œ //å¦‚æœé…ç½®å¤šæ‹¦æˆªå™¨ï¼Œè¿”å›å€¼ä¸ºfalseå°†ç»ˆæ­¢å½“å‰æ‹¦æˆªå™¨åé¢é…ç½®çš„æ‹¦æˆªå™¨çš„è¿è¡Œ return true; &#125; //å¤„ç†å™¨è¿è¡Œä¹‹åæ‰§è¡Œ @Override public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception &#123; System.out.println(&quot;åç½®è¿è¡Œ----b1&quot;); &#125; //æ‰€æœ‰æ‹¦æˆªå™¨çš„åç½®æ‰§è¡Œå…¨éƒ¨ç»“æŸåï¼Œæ‰§è¡Œè¯¥æ“ä½œ @Override public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception &#123; System.out.println(&quot;å®Œæˆè¿è¡Œ----c1&quot;); &#125;&#125; è¯´æ˜ï¼šä¸‰ä¸ªæ–¹æ³•çš„è¿è¡Œé¡ºåºä¸º preHandle â†’ postHandle â†’ afterCompletionï¼Œå¦‚æœ preHandle è¿”å›å€¼ä¸º falseï¼Œä¸‰ä¸ªæ–¹æ³•ä»…è¿è¡ŒpreHandle web.xmlï¼š 1CharacterEncodingFilter + DispatcherServlet é…ç½®æ‹¦æˆªå™¨ï¼šspring-mvc.xml 12345678&lt;mvc:annotation-driven/&gt;&lt;context:component-scan base-package=&quot;interceptor,controller&quot;/&gt;&lt;mvc:interceptors&gt; &lt;mvc:interceptor&gt; &lt;mvc:mapping path=&quot;/handleRun&quot;/&gt; &lt;bean class=&quot;interceptor.MyInterceptor&quot;/&gt; &lt;/mvc:interceptor&gt;&lt;/mvc:interceptors&gt; æ³¨æ„ï¼šé…ç½®é¡ºåºä¸ºå…ˆé…ç½®æ‰§è¡Œä½ç½®ï¼Œåé…ç½®æ‰§è¡Œç±» å¼‚å¸¸å¤„ç†å¤„ç†å™¨å¼‚å¸¸å¤„ç†å™¨ï¼š HandlerExceptionResolver æ¥å£ ç±»ç»§æ‰¿è¯¥æ¥å£çš„ä»¥åï¼Œå½“å¼€å‘å‡ºç°å¼‚å¸¸åä¼šæ‰§è¡ŒæŒ‡å®šçš„åŠŸèƒ½ 12345678910111213141516@Componentpublic class ExceptionResolver implements HandlerExceptionResolver &#123; @Override public ModelAndView resolveException(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) &#123; System.out.println(&quot;å¼‚å¸¸å¤„ç†å™¨æ­£åœ¨æ‰§è¡Œä¸­&quot;); ModelAndView modelAndView = new ModelAndView(); //å®šä¹‰å¼‚å¸¸ç°è±¡å‡ºç°åï¼Œåé¦ˆç»™ç”¨æˆ·æŸ¥çœ‹çš„ä¿¡æ¯ modelAndView.addObject(&quot;msg&quot;,&quot;å‡ºé”™å•¦ï¼ &quot;); //å®šä¹‰å¼‚å¸¸ç°è±¡å‡ºç°åï¼Œåé¦ˆç»™ç”¨æˆ·æŸ¥çœ‹çš„é¡µé¢ modelAndView.setViewName(&quot;error.jsp&quot;); return modelAndView; &#125;&#125; æ ¹æ®å¼‚å¸¸çš„ç§ç±»ä¸åŒï¼Œè¿›è¡Œåˆ†é—¨åˆ«ç±»çš„ç®¡ç†ï¼Œè¿”å›ä¸åŒçš„ä¿¡æ¯ï¼š 12345678910111213141516171819public class ExceptionResolver implements HandlerExceptionResolver &#123; @Override public ModelAndView resolveException(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) &#123; System.out.println(&quot;my exception is running ....&quot; + ex); ModelAndView modelAndView = new ModelAndView(); if( ex instanceof NullPointerException)&#123; modelAndView.addObject(&quot;msg&quot;,&quot;ç©ºæŒ‡é’ˆå¼‚å¸¸&quot;); &#125;else if ( ex instanceof ArithmeticException)&#123; modelAndView.addObject(&quot;msg&quot;,&quot;ç®—æ•°è¿ç®—å¼‚å¸¸&quot;); &#125;else&#123; modelAndView.addObject(&quot;msg&quot;,&quot;æœªçŸ¥çš„å¼‚å¸¸&quot;); &#125; modelAndView.setViewName(&quot;error.jsp&quot;); return modelAndView; &#125;&#125; æ¨¡æ‹Ÿé”™è¯¯ï¼š 123456789101112@Controllerpublic class UserController &#123; @RequestMapping(&quot;/save&quot;) @ResponseBody public String save(@RequestBody String name) &#123; //æ¨¡æ‹Ÿä¸šåŠ¡å±‚å‘èµ·è°ƒç”¨äº§ç”Ÿäº†å¼‚å¸¸// int i = 1/0;// String str = null;// str.length(); return &quot;error.jsp&quot;; &#125; æ³¨è§£å¼€å‘ä½¿ç”¨æ³¨è§£å®ç°å¼‚å¸¸åˆ†ç±»ç®¡ç†ï¼Œå¼€å‘å¼‚å¸¸å¤„ç†å™¨ @ControllerAdvice æ³¨è§£ï¼š ç±»å‹ï¼šç±»æ³¨è§£ ä½ç½®ï¼šå¼‚å¸¸å¤„ç†å™¨ç±»ä¸Šæ–¹ ä½œç”¨ï¼šè®¾ç½®å½“å‰ç±»ä¸ºå¼‚å¸¸å¤„ç†å™¨ç±» æ ¼å¼ï¼š 12345@Component//å£°æ˜è¯¥ç±»æ˜¯ä¸€ä¸ªControllerçš„é€šçŸ¥ç±»ï¼Œå£°æ˜åè¯¥ç±»å°±ä¼šè¢«åŠ è½½æˆå¼‚å¸¸å¤„ç†å™¨@ControllerAdvicepublic class ExceptionAdvice &#123;&#125; @ExceptionHandler æ³¨è§£ï¼š ç±»å‹ï¼šæ–¹æ³•æ³¨è§£ ä½ç½®ï¼šå¼‚å¸¸å¤„ç†å™¨ç±»ä¸­é’ˆå¯¹æŒ‡å®šå¼‚å¸¸è¿›è¡Œå¤„ç†çš„æ–¹æ³•ä¸Šæ–¹ ä½œç”¨ï¼šè®¾ç½®æŒ‡å®šå¼‚å¸¸çš„å¤„ç†æ–¹å¼ è¯´æ˜ï¼šå¤„ç†å™¨æ–¹æ³•å¯ä»¥è®¾å®šå¤šä¸ª æ ¼å¼ï¼š 12345678910111213141516@Component@ControllerAdvicepublic class ExceptionAdvice &#123; //ç±»ä¸­å®šä¹‰çš„æ–¹æ³•æºå¸¦@ExceptionHandleræ³¨è§£çš„ä¼šè¢«ä½œä¸ºå¼‚å¸¸å¤„ç†å™¨ï¼Œåé¢æ·»åŠ å®é™…å¤„ç†çš„å¼‚å¸¸ç±»å‹ @ExceptionHandler(NullPointerException.class) @ResponseBody public String doNullException(Exception ex)&#123; return &quot;ç©ºæŒ‡é’ˆå¼‚å¸¸&quot;; &#125; @ExceptionHandler(Exception.class) @ResponseBody public String doException(Exception ex)&#123; return &quot;all Exception&quot;; &#125;&#125; @ResponseStatus æ³¨è§£ï¼š ç±»å‹ï¼šç±»æ³¨è§£ã€æ–¹æ³•æ³¨è§£ ä½ç½®ï¼šå¼‚å¸¸å¤„ç†å™¨ç±»ã€æ–¹æ³•ä¸Šæ–¹ å‚æ•°ï¼š valueï¼šå‡ºç°é”™è¯¯æŒ‡å®šè¿”å›çŠ¶æ€ç  reasonï¼šå‡ºç°é”™è¯¯è¿”å›çš„é”™è¯¯ä¿¡æ¯ è§£å†³æ–¹æ¡ˆ web.xml 1DispatcherServlet + CharacterEncodingFilter ajax.jsp 123456789101112131415161718192021222324252627&lt;%@page pageEncoding=&quot;UTF-8&quot; language=&quot;java&quot; contentType=&quot;text/html;UTF-8&quot; %&gt;&lt;a href=&quot;javascript:void(0);&quot; id=&quot;testException&quot;&gt;ç‚¹å‡»&lt;/a&gt;&lt;br/&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;$&#123;pageContext.request.contextPath&#125;/js/jquery-3.3.1.min.js&quot;&gt;&lt;/script&gt;&lt;script type=&quot;text/javascript&quot;&gt; $(function () &#123; $(&quot;#testException&quot;).click(function()&#123; $.ajax(&#123; contentType:&quot;application/json&quot;, type:&quot;POST&quot;, url:&quot;save&quot;, /*é€šè¿‡ä¿®æ”¹å‚æ•°ï¼Œæ¿€æ´»è‡ªå®šä¹‰å¼‚å¸¸çš„å‡ºç°*/ // nameé•¿åº¦ä½äº8ä½å‡ºç°ä¸šåŠ¡å¼‚å¸¸ // ageå°äº0å‡ºç°ä¸šåŠ¡å¼‚å¸¸ // ageå¤§äº100å‡ºç°ç³»ç»Ÿå¼‚å¸¸ // ageç±»å‹å¦‚æœæ— æ³•åŒ¹é…å°†è½¬å…¥å…¶ä»–ç±»åˆ«å¼‚å¸¸ data:&#x27;&#123;&quot;name&quot;:&quot;JockSuperMan&quot;,&quot;age&quot;:&quot;-1&quot;&#125;&#x27;, dataType:&quot;text&quot;, //å›è°ƒå‡½æ•° success:function(data)&#123; alert(data); &#125; &#125;); &#125;); &#125;);&lt;/script&gt; spring-mvc.xml 123&lt;mvc:annotation-driven/&gt;&lt;context:component-scan base-package=&quot;com.seazean&quot;/&gt;&lt;mvc:resources mapping=&quot;/js/**&quot; location=&quot;/js/&quot;/&gt; java &#x2F; controller &#x2F; UserController 123456789101112131415161718192021222324@Controllerpublic class UserController &#123; @RequestMapping(&quot;/save&quot;) @ResponseBody public List&lt;User&gt; save(@RequestBody User user) &#123; System.out.println(&quot;user controller save is running ...&quot;); //å¯¹ç”¨æˆ·çš„éæ³•æ“ä½œè¿›è¡Œåˆ¤å®šï¼Œå¹¶åŒ…è£…æˆå¼‚å¸¸å¯¹è±¡è¿›è¡Œå¤„ç†ï¼Œä¾¿äºç»Ÿä¸€ç®¡ç† if(user.getName().trim().length() &lt; 8)&#123; throw new BusinessException(&quot;å¯¹ä¸èµ·ï¼Œç”¨æˆ·åé•¿åº¦ä¸æ»¡è¶³è¦æ±‚ï¼Œè¯·é‡æ–°è¾“å…¥ï¼&quot;); &#125; if(user.getAge() &lt; 0)&#123; throw new BusinessException(&quot;å¯¹ä¸èµ·ï¼Œå¹´é¾„å¿…é¡»æ˜¯0åˆ°100ä¹‹é—´çš„æ•°å­—ï¼&quot;); &#125; if(user.getAge() &gt; 100)&#123; throw new SystemException(&quot;æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼Œè¯·å°½å¿«æ£€æŸ¥å¤„ç†ï¼&quot;); &#125; User u1 = new User(&quot;Tom&quot;,3); User u2 = new User(&quot;Jerry&quot;,5); ArrayList&lt;User&gt; al = new ArrayList&lt;User&gt;(); al.add(u1);al.add(u2); return al; &#125;&#125; è‡ªå®šä¹‰å¼‚å¸¸ 12//è‡ªå®šä¹‰å¼‚å¸¸ç»§æ‰¿RuntimeExceptionï¼Œè¦†ç›–çˆ¶ç±»æ‰€æœ‰çš„æ„é€ æ–¹æ³•public class BusinessException extends RuntimeException &#123;è¦†ç›–çˆ¶ç±»æ‰€æœ‰çš„æ„é€ æ–¹æ³•&#125; 1public class SystemException extends RuntimeException &#123;&#125; é€šè¿‡è‡ªå®šä¹‰å¼‚å¸¸å°†æ‰€æœ‰çš„å¼‚å¸¸ç°è±¡è¿›è¡Œåˆ†ç±»ç®¡ç†ï¼Œä»¥ç»Ÿä¸€çš„æ ¼å¼å¯¹å¤–å‘ˆç°å¼‚å¸¸æ¶ˆæ¯ 1234567891011121314151617181920212223242526@Component@ControllerAdvicepublic class ProjectExceptionAdvice &#123; @ExceptionHandler(BusinessException.class) public String doBusinessException(Exception ex, Model m)&#123; //ä½¿ç”¨å‚æ•°Modelå°†è¦ä¿å­˜çš„æ•°æ®ä¼ é€’åˆ°é¡µé¢ä¸Šï¼ŒåŠŸèƒ½ç­‰åŒäºModelAndView //ä¸šåŠ¡å¼‚å¸¸å‡ºç°çš„æ¶ˆæ¯è¦å‘é€ç»™ç”¨æˆ·æŸ¥çœ‹ m.addAttribute(&quot;msg&quot;,ex.getMessage()); return &quot;error.jsp&quot;; &#125; @ExceptionHandler(SystemException.class) public String doSystemException(Exception ex, Model m)&#123; //ç³»ç»Ÿå¼‚å¸¸å‡ºç°çš„æ¶ˆæ¯ä¸è¦å‘é€ç»™ç”¨æˆ·æŸ¥çœ‹ï¼Œå‘é€ç»Ÿä¸€çš„ä¿¡æ¯ç»™ç”¨æˆ·çœ‹ m.addAttribute(&quot;msg&quot;,&quot;æœåŠ¡å™¨å‡ºç°é—®é¢˜ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ï¼&quot;); return &quot;error.jsp&quot;; &#125; @ExceptionHandler(Exception.class) public String doException(Exception ex, Model m)&#123; m.addAttribute(&quot;msg&quot;,ex.getMessage()); //å°†exå¯¹è±¡ä¿å­˜èµ·æ¥ return &quot;error.jsp&quot;; &#125;&#125; æ–‡ä»¶ä¼ è¾“ä¸Šä¼ ä¸‹è½½ä¸Šä¼ æ–‡ä»¶è¿‡ç¨‹ï¼š MultipartResolveræ¥å£ï¼š MultipartResolver æ¥å£å®šä¹‰äº†æ–‡ä»¶ä¸Šä¼ è¿‡ç¨‹ä¸­çš„ç›¸å…³æ“ä½œï¼Œå¹¶å¯¹é€šç”¨æ€§æ“ä½œè¿›è¡Œäº†å°è£… MultipartResolver æ¥å£åº•å±‚å®ç°ç±» CommonsMultipartResovler CommonsMultipartResovler å¹¶æœªè‡ªä¸»å®ç°æ–‡ä»¶ä¸Šä¼ ä¸‹è½½å¯¹åº”çš„åŠŸèƒ½ï¼Œè€Œæ˜¯è°ƒç”¨äº† apache æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ç»„ä»¶ æ–‡ä»¶ä¸Šä¼ ä¸‹è½½å®ç°ï¼š å¯¼å…¥åæ ‡ 12345&lt;dependency&gt; &lt;groupId&gt;commons-fileupload&lt;/groupId&gt; &lt;artifactId&gt;commons-fileupload&lt;/artifactId&gt; &lt;version&gt;1.4&lt;/version&gt;&lt;/dependency&gt; é¡µé¢è¡¨å• fileupload.jsp 1234&lt;form method=&quot;post&quot; action=&quot;/upload&quot; enctype=&quot;multipart/form-data&quot;&gt; &lt;input type=&quot;file&quot; name=&quot;file&quot;&gt;&lt;br&gt; &lt;input type=&quot;submit&quot; value=&quot;æäº¤&quot;&gt;&lt;/form&gt; web.xml 1DispatcherServlet + CharacterEncodingFilter æ§åˆ¶å™¨ 123456789101112@PostMapping(&quot;/upload&quot;)public String upload(@RequestParam(&quot;email&quot;) String email, @RequestParam(&quot;username&quot;) String username, @RequestPart(&quot;headerImg&quot;) MultipartFile headerImg) throws IOException &#123; if(!headerImg.isEmpty())&#123; //ä¿å­˜åˆ°æ–‡ä»¶æœåŠ¡å™¨ï¼ŒOSSæœåŠ¡å™¨ String originalFilename = headerImg.getOriginalFilename(); headerImg.transferTo(new File(&quot;H:\\\\cache\\\\&quot; + originalFilename)); &#125; return &quot;main&quot;;&#125; åç§°é—®é¢˜MultipartFile å‚æ•°ä¸­å°è£…äº†ä¸Šä¼ çš„æ–‡ä»¶çš„ç›¸å…³ä¿¡æ¯ã€‚ æ–‡ä»¶å‘½åé—®é¢˜ï¼Œ è·å–ä¸Šä¼ æ–‡ä»¶åï¼Œå¹¶è§£ææ–‡ä»¶åä¸æ‰©å±•å 1file.getOriginalFilename(); æ–‡ä»¶åè¿‡é•¿é—®é¢˜ æ–‡ä»¶ä¿å­˜è·¯å¾„ 1234ServletContext context = request.getServletContext();String realPath = context.getRealPath(&quot;/uploads&quot;);File file = new File(realPath + &quot;/&quot;);if(!file.exists()) file.mkdirs(); é‡åé—®é¢˜ 1String uuid = UUID.randomUUID.toString().replace(&quot;-&quot;, &quot;&quot;).toUpperCase(); 1234567891011121314151617181920212223242526272829303132333435363738@Controllerpublic class FileUploadController &#123; @RequestMapping(value = &quot;/fileupload&quot;) //å‚æ•°ä¸­å®šä¹‰MultipartFileå‚æ•°ï¼Œç”¨äºæ¥æ”¶é¡µé¢æäº¤çš„type=fileç±»å‹çš„è¡¨å•ï¼Œè¡¨å•åç§°ä¸å‚æ•°åç›¸åŒ public String fileupload(MultipartFile file,MultipartFile file1,MultipartFile file2, HttpServletRequest request) throws IOException &#123; System.out.println(&quot;file upload is running ...&quot;+file);// MultipartFileå‚æ•°ä¸­å°è£…äº†ä¸Šä¼ çš„æ–‡ä»¶çš„ç›¸å…³ä¿¡æ¯// System.out.println(file.getSize());// System.out.println(file.getBytes().length);// System.out.println(file.getContentType());// System.out.println(file.getName());// System.out.println(file.getOriginalFilename());// System.out.println(file.isEmpty()); //é¦–å…ˆåˆ¤æ–­æ˜¯å¦æ˜¯ç©ºæ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯å­˜å‚¨ç©ºé—´å ç”¨ä¸º0çš„æ–‡ä»¶ if(!file.isEmpty())&#123; //å¦‚æœå¤§å°åœ¨èŒƒå›´è¦æ±‚å†…æ­£å¸¸å¤„ç†ï¼Œå¦åˆ™æŠ›å‡ºè‡ªå®šä¹‰å¼‚å¸¸å‘ŠçŸ¥ç”¨æˆ·ï¼ˆæœªå®ç°ï¼‰ //è·å–åŸå§‹ä¸Šä¼ çš„æ–‡ä»¶åï¼Œå¯ä»¥ä½œä¸ºå½“å‰æ–‡ä»¶çš„çœŸå®åç§°ä¿å­˜åˆ°æ•°æ®åº“ä¸­å¤‡ç”¨ String fileName = file.getOriginalFilename(); //è®¾ç½®ä¿å­˜çš„è·¯å¾„ String realPath = request.getServletContext().getRealPath(&quot;/images&quot;); //ä¿å­˜æ–‡ä»¶çš„æ–¹æ³•ï¼Œé€šå¸¸æ–‡ä»¶åä½¿ç”¨éšæœºç”Ÿæˆç­–ç•¥äº§ç”Ÿï¼Œé¿å…æ–‡ä»¶åå†²çªé—®é¢˜ file.transferTo(new File(realPath,file.getOriginalFilename())); &#125; //æµ‹è¯•ä¸€æ¬¡æ€§ä¸Šä¼ å¤šä¸ªæ–‡ä»¶ if(!file1.isEmpty())&#123; String fileName = file1.getOriginalFilename(); //å¯ä»¥æ ¹æ®éœ€è¦ï¼Œå¯¹ä¸åŒç§ç±»çš„æ–‡ä»¶åšä¸åŒçš„å­˜å‚¨è·¯å¾„çš„åŒºåˆ†ï¼Œä¿®æ”¹å¯¹åº”çš„ä¿å­˜ä½ç½®å³å¯ String realPath = request.getServletContext().getRealPath(&quot;/images&quot;); file1.transferTo(new File(realPath,file1.getOriginalFilename())); &#125; if(!file2.isEmpty())&#123; String fileName = file2.getOriginalFilename(); String realPath = request.getServletContext().getRealPath(&quot;/images&quot;); file2.transferTo(new File(realPath,file2.getOriginalFilename())); &#125; return &quot;page.jsp&quot;; &#125;&#125; æºç è§£æStandardServletMultipartResolver æ˜¯æ–‡ä»¶ä¸Šä¼ è§£æå™¨ DispatcherServlet#doDispatchï¼š 123456protected void doDispatch(HttpServletRequest request, HttpServletResponse response) throws Exception &#123; // åˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯ä¸æ˜¯æ–‡ä»¶ä¸Šä¼ è¯·æ±‚ processedRequest = checkMultipart(request); // æ–‡ä»¶ä¸Šä¼ è¯·æ±‚ä¼šå¯¹ request è¿›è¡ŒåŒ…è£…ï¼Œå¯¼è‡´ä¸¤è€…ä¸ç›¸ç­‰ï¼Œæ­¤å¤„èµ‹å€¼ä¸º trueï¼Œä»£è¡¨å·²ç»è¢«è§£æ multipartRequestParsed = (processedRequest != request);&#125; DispatcherServlet#checkMultipartï¼š if (this.multipartResolver != null &amp;&amp; this.multipartResolver.isMultipart(request))ï¼šåˆ¤æ–­æ˜¯å¦æ˜¯æ–‡ä»¶è¯·æ±‚ StandardServletMultipartResolver#isMultipartï¼šæ ¹æ®å¼€å¤´æ˜¯å¦ç¬¦åˆ multipart&#x2F;form-data æˆ–è€… multipart&#x2F; return this.multipartResolver.resolveMultipart(request)ï¼šæŠŠè¯·æ±‚å°è£…æˆ StandardMultipartHttpServletRequest å¯¹è±¡ å¼€å§‹æ‰§è¡Œ ha.handle() ç›®æ ‡æ–¹æ³•è¿›è¡Œæ•°æ®çš„è§£æ RequestPartMethodArgumentResolver#supportsParameterï¼šæ”¯æŒè§£ææ–‡ä»¶ä¸Šä¼ æ•°æ® 123456public boolean supportsParameter(MethodParameter parameter) &#123; // å‚æ•°ä¸Šæœ‰ @RequestPart æ³¨è§£ if (parameter.hasParameterAnnotation(RequestPart.class)) &#123; return true; &#125;&#125; RequestPartMethodArgumentResolver#resolveArgumentï¼šè§£æå‚æ•°æ•°æ®ï¼Œå°è£…æˆ MultipartFile å¯¹è±¡ RequestPart requestPart = parameter.getParameterAnnotation(RequestPart.class)ï¼šè·å–æ³¨è§£çš„ç›¸å…³ä¿¡æ¯ String name = getPartName(parameter, requestPart)ï¼šè·å–ä¸Šä¼ æ–‡ä»¶çš„åå­— Object mpArg = MultipartResolutionDelegate.resolveMultipartArgument()ï¼šè§£æå‚æ•° List&lt;MultipartFile&gt; files = multipartRequest.getFiles(name)ï¼šè·å–æ–‡ä»¶çš„æ‰€æœ‰æ•°æ® return doInvoke(args)ï¼šè§£æå®Œæˆæ‰§è¡Œè‡ªå®šä¹‰çš„æ–¹æ³•ï¼Œå®Œæˆä¸Šä¼ åŠŸèƒ½ å®ç”¨æŠ€æœ¯æ ¡éªŒæ¡†æ¶æ ¡éªŒæ¦‚è¿°è¡¨å•æ ¡éªŒä¿éšœäº†æ•°æ®æœ‰æ•ˆæ€§ã€å®‰å…¨æ€§ æ ¡éªŒåˆ†ç±»ï¼šå®¢æˆ·ç«¯æ ¡éªŒå’ŒæœåŠ¡ç«¯æ ¡éªŒ æ ¼å¼æ ¡éªŒ å®¢æˆ·ç«¯ï¼šä½¿ç”¨ js æŠ€æœ¯ï¼Œåˆ©ç”¨æ­£åˆ™è¡¨è¾¾å¼æ ¡éªŒ æœåŠ¡ç«¯ï¼šä½¿ç”¨æ ¡éªŒæ¡†æ¶ é€»è¾‘æ ¡éªŒ å®¢æˆ·ç«¯ï¼šä½¿ç”¨ajaxå‘é€è¦æ ¡éªŒçš„æ•°æ®ï¼Œåœ¨æœåŠ¡ç«¯å®Œæˆé€»è¾‘æ ¡éªŒï¼Œè¿”å›æ ¡éªŒç»“æœ æœåŠ¡ç«¯ï¼šæ¥æ”¶åˆ°å®Œæ•´çš„è¯·æ±‚åï¼Œåœ¨æ‰§è¡Œä¸šåŠ¡æ“ä½œå‰ï¼Œå®Œæˆé€»è¾‘æ ¡éªŒ è¡¨å•æ ¡éªŒæ¡†æ¶ï¼š JSRï¼ˆJava Specification Requestsï¼‰ï¼šJava è§„èŒƒææ¡ˆ 303ï¼šæä¾›beanå±æ€§ç›¸å…³æ ¡éªŒè§„åˆ™ JCPï¼ˆJava Community Processï¼‰ï¼šJavaç¤¾åŒº Hibernateæ¡†æ¶ä¸­åŒ…å«ä¸€å¥—ç‹¬ç«‹çš„æ ¡éªŒæ¡†æ¶hibernate-validator å¯¼å…¥åæ ‡ï¼š 123456789101112&lt;!--å¯¼å…¥æ ¡éªŒçš„jsr303è§„èŒƒ--&gt;&lt;dependency&gt; &lt;groupId&gt;javax.validation&lt;/groupId&gt; &lt;artifactId&gt;validation-api&lt;/artifactId&gt; &lt;version&gt;2.0.1.Final&lt;/version&gt;&lt;/dependency&gt;&lt;!--å¯¼å…¥æ ¡éªŒæ¡†æ¶å®ç°æŠ€æœ¯--&gt;&lt;dependency&gt; &lt;groupId&gt;org.hibernate&lt;/groupId&gt; &lt;artifactId&gt;hibernate-validator&lt;/artifactId&gt; &lt;version&gt;6.1.0.Final&lt;/version&gt;&lt;/dependency&gt; æ³¨æ„ï¼š tomcat7ï¼šæ­é… hibernate-validator ç‰ˆæœ¬ 5...Final tomcat8.5ï¼šæ­é… hibernate-validator ç‰ˆæœ¬ 6...Final åŸºæœ¬ä½¿ç”¨å¼€å¯æ ¡éªŒåç§°ï¼š@Validã€@Validated ç±»å‹ï¼šå½¢å‚æ³¨è§£ ä½ç½®ï¼šå¤„ç†å™¨ç±»ä¸­çš„å®ä½“ç±»ç±»å‹çš„æ–¹æ³•å½¢å‚å‰æ–¹ ä½œç”¨ï¼šè®¾å®šå¯¹å½“å‰å®ä½“ç±»ç±»å‹å‚æ•°è¿›è¡Œæ ¡éªŒ èŒƒä¾‹ï¼š 1234@RequestMapping(value = &quot;/addemployee&quot;)public String addEmployee(@Valid Employee employee) &#123; System.out.println(employee);&#125; æ ¡éªŒè§„åˆ™åç§°ï¼š@NotNull ç±»å‹ï¼šå±æ€§æ³¨è§£ç­‰ ä½ç½®ï¼šå®ä½“ç±»å±æ€§ä¸Šæ–¹ ä½œç”¨ï¼šè®¾å®šå½“å‰å±æ€§æ ¡éªŒè§„åˆ™ èŒƒä¾‹ï¼šæ¯ä¸ªæ ¡éªŒè§„åˆ™æ‰€æºå¸¦çš„å‚æ•°ä¸åŒï¼Œæ ¹æ®æ ¡éªŒè§„åˆ™è¿›è¡Œç›¸åº”çš„è°ƒæ•´ï¼Œå…·ä½“çš„æ ¡éªŒè§„åˆ™æŸ¥çœ‹å¯¹åº”çš„æ ¡éªŒæ¡†æ¶è¿›è¡Œè·å– 1234public class Employee&#123; @NotNull(message = &quot;å§“åä¸èƒ½ä¸ºç©º&quot;) private String name;//å‘˜å·¥å§“å&#125; é”™è¯¯ä¿¡æ¯123456789101112131415@RequestMapping(value = &quot;/addemployee&quot;)//Errorså¯¹è±¡ç”¨äºå°è£…æ ¡éªŒç»“æœï¼Œå¦‚æœä¸æ»¡è¶³æ ¡éªŒè§„åˆ™ï¼Œå¯¹åº”çš„æ ¡éªŒç»“æœå°è£…åˆ°è¯¥å¯¹è±¡ä¸­ï¼ŒåŒ…å«æ ¡éªŒçš„å±æ€§åå’Œæ ¡éªŒä¸é€šè¿‡è¿”å›çš„æ¶ˆæ¯public String addEmployee(@Valid Employee employee, Errors errors, Model model)&#123; System.out.println(employee); //åˆ¤å®šErrorså¯¹è±¡ä¸­æ˜¯å¦å­˜åœ¨æœªé€šè¿‡æ ¡éªŒçš„å­—æ®µ if(errors.hasErrors())&#123; for(FieldError error : errors.getFieldErrors())&#123; //å°†æ ¡éªŒç»“æœæ·»åŠ åˆ°Modelå¯¹è±¡ä¸­ï¼Œç”¨äºé¡µé¢æ˜¾ç¤ºï¼Œè¿”å›jsonæ•°æ®å³å¯ model.addAttribute(error.getField(),error.getDefaultMessage()); &#125; //å½“å‡ºç°æœªé€šè¿‡æ ¡éªŒçš„å­—æ®µæ—¶ï¼Œè·³è½¬é¡µé¢åˆ°åŸå§‹é¡µé¢ï¼Œè¿›è¡Œæ•°æ®å›æ˜¾ return &quot;addemployee.jsp&quot;; &#125; return &quot;success.jsp&quot;;&#125; é€šè¿‡å½¢å‚Errorsè·å–æ ¡éªŒç»“æœæ•°æ®ï¼Œé€šè¿‡Modelæ¥å£å°†æ•°æ®å°è£…åä¼ é€’åˆ°é¡µé¢æ˜¾ç¤ºï¼Œé¡µé¢è·å–åå°å°è£…çš„æ ¡éªŒç»“æœä¿¡æ¯ 12345&lt;form action=&quot;/addemployee&quot; method=&quot;post&quot;&gt; å‘˜å·¥å§“åï¼š&lt;input type=&quot;text&quot; name=&quot;name&quot;&gt;&lt;span style=&quot;color:red&quot;&gt;$&#123;name&#125;&lt;/span&gt;&lt;br/&gt; å‘˜å·¥å¹´é¾„ï¼š&lt;input type=&quot;text&quot; name=&quot;age&quot;&gt;&lt;span style=&quot;color:red&quot;&gt;$&#123;age&#125;&lt;/span&gt;&lt;br/&gt; &lt;input type=&quot;submit&quot; value=&quot;æäº¤&quot;&gt;&lt;/form&gt; å¤šè§„åˆ™æ ¡éªŒ åŒä¸€ä¸ªå±æ€§å¯ä»¥æ·»åŠ å¤šä¸ªæ ¡éªŒå™¨ 123456789public class Employee&#123; @NotBlank(message = &quot;å§“åä¸èƒ½ä¸ºç©º&quot;) private String name;//å‘˜å·¥å§“å @NotNull(message = &quot;è¯·è¾“å…¥å¹´é¾„&quot;) @Max(value = 60,message = &quot;å¹´é¾„æœ€å¤§å€¼60&quot;) @Min(value = 18,message = &quot;å¹´é¾„æœ€å°å€¼18&quot;) private Integer age;//å‘˜å·¥å¹´é¾„&#125; ä¸‰ç§åˆ¤å®šç©ºæ ¡éªŒå™¨çš„åŒºåˆ« åµŒå¥—æ ¡éªŒåç§°ï¼š@Valid ç±»å‹ï¼šå±æ€§æ³¨è§£ ä½ç½®ï¼šå®ä½“ç±»ä¸­çš„å¼•ç”¨ç±»å‹å±æ€§ä¸Šæ–¹ ä½œç”¨ï¼šè®¾å®šå½“å‰åº”ç”¨ç±»å‹å±æ€§ä¸­çš„å±æ€§å¼€å¯æ ¡éªŒ èŒƒä¾‹ï¼š 12345public class Employee &#123; //å®ä½“ç±»ä¸­çš„å¼•ç”¨ç±»å‹é€šè¿‡æ ‡æ³¨@Validæ³¨è§£ï¼Œè®¾å®šå¼€å¯å½“å‰å¼•ç”¨ç±»å‹å­—æ®µä¸­çš„å±æ€§å‚ä¸æ ¡éªŒ @Valid private Address address;&#125; æ³¨æ„ï¼šå¼€å¯åµŒå¥—æ ¡éªŒåï¼Œè¢«æ ¡éªŒå¯¹è±¡å†…éƒ¨éœ€è¦æ·»åŠ å¯¹åº”çš„æ ¡éªŒè§„åˆ™ 123456789//åµŒå¥—æ ¡éªŒçš„å®ä½“ä¸­ï¼Œå¯¹æ¯ä¸ªå±æ€§æ­£å¸¸æ·»åŠ æ ¡éªŒè§„åˆ™å³å¯public class Address implements Serializable &#123; @NotBlank(message = &quot;è¯·è¾“å…¥çœä»½åç§°&quot;) private String provinceName;//çœä»½åç§° @NotBlank(message = &quot;è¯·è¾“å…¥é‚®æ”¿ç¼–ç &quot;) @Size(max = 6,min = 6,message = &quot;é‚®æ”¿ç¼–ç ç”±6ä½ç»„æˆ&quot;) private String zipCode;//é‚®æ”¿ç¼–ç &#125; åˆ†ç»„æ ¡éªŒåˆ†ç»„æ ¡éªŒçš„ä»‹ç» åŒä¸€ä¸ªæ¨¡å—ï¼Œæ ¹æ®æ‰§è¡Œçš„ä¸šåŠ¡ä¸åŒï¼Œéœ€è¦æ ¡éªŒçš„å±æ€§ä¼šæœ‰ä¸åŒ æ–°å¢ç”¨æˆ· ä¿®æ”¹ç”¨æˆ· å¯¹ä¸åŒç§ç±»çš„å±æ€§è¿›è¡Œåˆ†ç»„ï¼Œåœ¨æ ¡éªŒæ—¶å¯ä»¥æŒ‡å®šå‚ä¸æ ¡éªŒçš„å­—æ®µæ‰€å±çš„ç»„ç±»åˆ« å®šä¹‰ç»„ï¼ˆé€šç”¨ï¼‰ ä¸ºå±æ€§è®¾ç½®æ‰€å±ç»„ï¼Œå¯ä»¥è®¾ç½®å¤šä¸ª å¼€å¯ç»„æ ¡éªŒ domainï¼š 123//ç”¨äºè®¾å®šåˆ†ç»„æ ¡éªŒä¸­çš„ç»„åï¼Œå½“å‰æ¥å£ä»…æä¾›å­—èŠ‚ç ï¼Œç”¨äºè¯†åˆ«public interface GroupOne &#123;&#125; 12345678910111213public class Employee&#123; @NotBlank(message = &quot;å§“åä¸èƒ½ä¸ºç©º&quot;,groups = &#123;GroupA.class&#125;) private String name;//å‘˜å·¥å§“å @NotNull(message = &quot;è¯·è¾“å…¥å¹´é¾„&quot;,groups = &#123;GroupA.class&#125;) @Max(value = 60,message = &quot;å¹´é¾„æœ€å¤§å€¼60&quot;)//ä¸åŠ Groupçš„æ ¡éªŒä¸ç”Ÿæ•ˆ @Min(value = 18,message = &quot;å¹´é¾„æœ€å°å€¼18&quot;) private Integer age;//å‘˜å·¥å¹´é¾„ @Valid private Address address; //......&#125; controllerï¼š 123456789101112131415@Controllerpublic class EmployeeController &#123; @RequestMapping(value = &quot;/addemployee&quot;) public String addEmployee(@Validated(&#123;GroupA.class&#125;) Employee employee, Errors errors, Model m)&#123; if(errors.hasErrors())&#123; List&lt;FieldError&gt; fieldErrors = errors.getFieldErrors(); System.out.println(fieldErrors.size()); for(FieldError error : fieldErrors)&#123; m.addAttribute(error.getField(),error.getDefaultMessage()); &#125; return &quot;addemployee.jsp&quot;; &#125; return &quot;success.jsp&quot;; &#125;&#125; jspï¼š 1234567&lt;form action=&quot;/addemployee&quot; method=&quot;post&quot;&gt;&lt;%--é¡µé¢ä½¿ç”¨$&#123;&#125;è·å–åå°ä¼ é€’çš„æ ¡éªŒä¿¡æ¯--%&gt; å‘˜å·¥å§“åï¼š&lt;input type=&quot;text&quot; name=&quot;name&quot;&gt;&lt;span style=&quot;color:red&quot;&gt;$&#123;name&#125;&lt;/span&gt;&lt;br/&gt; å‘˜å·¥å¹´é¾„ï¼š&lt;input type=&quot;text&quot; name=&quot;age&quot;&gt;&lt;span style=&quot;color:red&quot;&gt;$&#123;age&#125;&lt;/span&gt;&lt;br/&gt; &lt;%--æ³¨æ„ï¼Œå¼•ç”¨ç±»å‹çš„æ ¡éªŒæœªé€šè¿‡ä¿¡æ¯ä¸æ˜¯é€šè¿‡å¯¹è±¡è¿›è¡Œå°è£…çš„ï¼Œç›´æ¥ä½¿ç”¨å¯¹è±¡å.å±æ€§åçš„æ ¼å¼ä½œä¸ºæ•´ä½“å±æ€§å­—ç¬¦ä¸²è¿›è¡Œä¿å­˜çš„ï¼Œå’Œä½¿ç”¨è€…çš„å±æ€§ä¼ é€’æ–¹å¼æœ‰å…³ï¼Œä¸å…·æœ‰é€šç”¨æ€§ï¼Œä»…é€‚ç”¨äºæœ¬æ¡ˆä¾‹--%&gt; çœï¼š&lt;input type=&quot;text&quot; name=&quot;address.provinceName&quot;&gt;&lt;span style=&quot;color:red&quot;&gt;$&#123;requestScope[&#x27;address.provinceName&#x27;]&#125;&lt;/span&gt;&lt;br/&gt; &lt;input type=&quot;submit&quot; value=&quot;æäº¤&quot;&gt;/form&gt; LombokLombok ç”¨æ ‡ç­¾æ–¹å¼ä»£æ›¿æ„é€ å™¨ã€getter&#x2F;setterã€toString() ç­‰æ–¹æ³• å¼•å…¥ä¾èµ–ï¼š 1234&lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt;&lt;/dependency&gt; ä¸‹è½½æ’ä»¶ï¼šIDEA ä¸­ File â†’ Settings â†’ Pluginsï¼Œæœç´¢å®‰è£… Lombok æ’ä»¶ å¸¸ç”¨æ³¨è§£ï¼š 12345@NoArgsConstructor // æ— å‚æ„é€ @AllArgsConstructor // å…¨å‚æ„é€ @Data // set + get@ToString // toString@EqualsAndHashCode // hashConde + equals ç®€åŒ–æ—¥å¿—ï¼š 123456789@Slf4j@RestControllerpublic class HelloController &#123; @RequestMapping(&quot;/hello&quot;) public String handle01(@RequestParam(&quot;name&quot;) String name)&#123; log.info(&quot;è¯·æ±‚è¿›æ¥äº†....&quot;); return &quot;Hello, Spring!&quot; + &quot;ä½ å¥½ï¼š&quot; + name; &#125;&#125; BootåŸºæœ¬ä»‹ç»Bootä»‹ç»SpringBoot æä¾›äº†ä¸€ç§å¿«é€Ÿä½¿ç”¨ Spring çš„æ–¹å¼ï¼ŒåŸºäºçº¦å®šä¼˜äºé…ç½®çš„æ€æƒ³ï¼Œå¯ä»¥è®©å¼€å‘äººå‘˜ä¸å¿…åœ¨é…ç½®ä¸é€»è¾‘ä¸šåŠ¡ä¹‹é—´è¿›è¡Œæ€ç»´çš„åˆ‡æ¢ï¼Œå…¨èº«å¿ƒçš„æŠ•å…¥åˆ°é€»è¾‘ä¸šåŠ¡çš„ä»£ç ç¼–å†™ä¸­ï¼Œä»è€Œå¤§å¤§æé«˜äº†å¼€å‘çš„æ•ˆç‡ SpringBoot åŠŸèƒ½ï¼š è‡ªåŠ¨é…ç½®ï¼Œè‡ªåŠ¨é…ç½®æ˜¯ä¸€ä¸ªè¿è¡Œæ—¶ï¼ˆæ›´å‡†ç¡®åœ°è¯´ï¼Œæ˜¯åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶ï¼‰çš„è¿‡ç¨‹ï¼Œè€ƒè™‘äº†ä¼—å¤šå› ç´ é€‰æ‹©ä½¿ç”¨å“ªä¸ªé…ç½®ï¼Œè¯¥è¿‡ç¨‹æ˜¯SpringBoot è‡ªåŠ¨å®Œæˆçš„ èµ·æ­¥ä¾èµ–ï¼Œèµ·æ­¥ä¾èµ–æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª Maven é¡¹ç›®å¯¹è±¡æ¨¡å‹ï¼ˆProject Object Modelï¼ŒPOMï¼‰ï¼Œå®šä¹‰äº†å¯¹å…¶ä»–åº“çš„ä¼ é€’ä¾èµ–ï¼Œè¿™äº›ä¸œè¥¿åŠ åœ¨ä¸€èµ·å³æ”¯æŒæŸé¡¹åŠŸèƒ½ã€‚ç®€å•çš„è¯´ï¼Œèµ·æ­¥ä¾èµ–å°±æ˜¯å°†å…·å¤‡æŸç§åŠŸèƒ½çš„åæ ‡æ‰“åŒ…åˆ°ä¸€èµ·ï¼Œå¹¶æä¾›ä¸€äº›é»˜è®¤çš„åŠŸèƒ½ è¾…åŠ©åŠŸèƒ½ï¼Œæä¾›äº†ä¸€äº›å¤§å‹é¡¹ç›®ä¸­å¸¸è§çš„éåŠŸèƒ½æ€§ç‰¹æ€§ï¼Œå¦‚å†…åµŒ web æœåŠ¡å™¨ã€å®‰å…¨ã€æŒ‡æ ‡ï¼Œå¥åº·æ£€æµ‹ã€å¤–éƒ¨é…ç½®ç­‰ å‚è€ƒè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV19K4y1L7MT æ„å»ºå·¥ç¨‹æ™®é€šæ„å»ºï¼š åˆ›å»º Maven é¡¹ç›® å¯¼å…¥ SpringBoot èµ·æ­¥ä¾èµ– 1234567891011121314&lt;!--springboot å·¥ç¨‹éœ€è¦ç»§æ‰¿çš„çˆ¶å·¥ç¨‹--&gt;&lt;parent&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt; &lt;version&gt;2.1.8.RELEASE&lt;/version&gt;&lt;/parent&gt;&lt;dependencies&gt; &lt;!--web å¼€å‘çš„èµ·æ­¥ä¾èµ–--&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt;&lt;/dependencies&gt; å®šä¹‰ Controller 1234567@RestControllerpublic class HelloController &#123; @RequestMapping(&quot;/hello&quot;) public String hello()&#123; return &quot; hello Spring Boot !&quot;; &#125;&#125; ç¼–å†™å¼•å¯¼ç±» 1234567// å¼•å¯¼ç±»ï¼ŒSpringBooté¡¹ç›®çš„å…¥å£@SpringBootApplicationpublic class HelloApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(HelloApplication.class, args); &#125;&#125; å¿«é€Ÿæ„å»ºï¼š è‡ªåŠ¨è£…é…ä¾èµ–ç®¡ç†åœ¨ spring-boot-starter-parent ä¸­å®šä¹‰äº†å„ç§æŠ€æœ¯çš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œç»„åˆäº†ä¸€å¥—æœ€ä¼˜æ­é…çš„æŠ€æœ¯ç‰ˆæœ¬ã€‚åœ¨å„ç§ starter ä¸­ï¼Œå®šä¹‰äº†å®Œæˆè¯¥åŠŸèƒ½éœ€è¦çš„åæ ‡åˆé›†ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†ç‰ˆæœ¬ä¿¡æ¯æ¥è‡ªäºçˆ¶å·¥ç¨‹ã€‚å·¥ç¨‹ç»§æ‰¿ parentï¼Œå¼•å…¥ starter åï¼Œé€šè¿‡ä¾èµ–ä¼ é€’ï¼Œå°±å¯ä»¥ç®€å•æ–¹ä¾¿è·å¾—éœ€è¦çš„ jar åŒ…ï¼Œå¹¶ä¸”ä¸ä¼šå­˜åœ¨ç‰ˆæœ¬å†²çªï¼Œè‡ªåŠ¨ç‰ˆæœ¬ä»²è£æœºåˆ¶ åº•å±‚æ³¨è§£SpringBoot@SpringBootApplicationï¼šå¯åŠ¨æ³¨è§£ï¼Œå®ç° SpringBoot çš„è‡ªåŠ¨éƒ¨ç½² å‚æ•° scanBasePackagesï¼šå¯ä»¥æŒ‡å®šæ‰«æèŒƒå›´ é»˜è®¤æ‰«æå½“å‰å¼•å¯¼ç±»æ‰€åœ¨åŒ…åŠå…¶å­åŒ… å‡å¦‚æ‰€åœ¨åŒ…ä¸º com.example.springbootenableï¼Œæ‰«æé…ç½®åŒ… com.example.config çš„ä¿¡æ¯ï¼Œä¸‰ç§è§£å†³åŠæ³•ï¼š ä½¿ç”¨ @ComponentScan æ‰«æ com.example.config åŒ… ä½¿ç”¨ @Import æ³¨è§£åŠ è½½ç±»ï¼Œè¿™äº›ç±»éƒ½ä¼šè¢« Spring åˆ›å»ºå¹¶æ”¾å…¥ ioc å®¹å™¨ï¼Œé»˜è®¤ç»„ä»¶çš„åå­—å°±æ˜¯å…¨ç±»å å¯¹ @Import æ³¨è§£è¿›è¡Œå°è£… 1234567891011121314//1.@ComponentScan(&quot;com.example.config&quot;)//2.@Import(UserConfig.class)@EnableUser@SpringBootApplicationpublic class SpringbootEnableApplication &#123; public static void main(String[] args) &#123; ConfigurableApplicationContext context = SpringApplication.run(SpringbootEnableApplication.class, args); //è·å–Bean Object user = context.getBean(&quot;user&quot;); System.out.println(user); &#125;&#125; UserConfigï¼š 1234567@Configurationpublic class UserConfig &#123; @Bean public User user() &#123; return new User(); &#125;&#125; EnableUser æ³¨è§£ç±»ï¼š 123456@Target(ElementType.TYPE)@Retention(RetentionPolicy.RUNTIME)@Documented@Import(UserConfig.class)//@Importæ³¨è§£å®ç°Beançš„åŠ¨æ€åŠ è½½public @interface EnableUser &#123;&#125; Configuration@Configurationï¼šè®¾ç½®å½“å‰ç±»ä¸º SpringBoot çš„é…ç½®ç±» proxyBeanMethods &#x3D; trueï¼šFull å…¨æ¨¡å¼ï¼Œæ¯ä¸ª @Bean æ–¹æ³•è¢«è°ƒç”¨å¤šå°‘æ¬¡è¿”å›çš„ç»„ä»¶éƒ½æ˜¯å•å®ä¾‹çš„ï¼Œé»˜è®¤å€¼ï¼Œç±»ç»„ä»¶ä¹‹é—´æœ‰ä¾èµ–å…³ç³»ï¼Œæ–¹æ³•ä¼šè¢«è°ƒç”¨å¾—åˆ°ä¹‹å‰å•å®ä¾‹ç»„ä»¶ proxyBeanMethods &#x3D; falseï¼šLite è½»é‡çº§æ¨¡å¼ï¼Œæ¯ä¸ª @Bean æ–¹æ³•è¢«è°ƒç”¨å¤šå°‘æ¬¡è¿”å›çš„ç»„ä»¶éƒ½æ˜¯æ–°åˆ›å»ºçš„ï¼Œç±»ç»„ä»¶ä¹‹é—´æ— ä¾èµ–å…³ç³»ç”¨ Lite æ¨¡å¼åŠ é€Ÿå®¹å™¨å¯åŠ¨è¿‡ç¨‹ 12345678@Configuration(proxyBeanMethods = true)public class MyConfig &#123; @Bean //ç»™å®¹å™¨ä¸­æ·»åŠ ç»„ä»¶ã€‚ä»¥æ–¹æ³•åä½œä¸ºç»„ä»¶çš„ idã€‚è¿”å›ç±»å‹å°±æ˜¯ç»„ä»¶ç±»å‹ã€‚è¿”å›çš„å€¼ï¼Œå°±æ˜¯ç»„ä»¶åœ¨å®¹å™¨ä¸­çš„å®ä¾‹ public User user()&#123; User user = new User(&quot;zhangsan&quot;, 18); return user; &#125;&#125; Conditionæ¡ä»¶æ³¨è§£Condition æ˜¯ Spring4.0 åå¼•å…¥çš„æ¡ä»¶åŒ–é…ç½®æ¥å£ï¼Œé€šè¿‡å®ç° Condition æ¥å£å¯ä»¥å®Œæˆæœ‰æ¡ä»¶çš„åŠ è½½ç›¸åº”çš„ Bean æ³¨è§£ï¼š@Conditional ä½œç”¨ï¼šæ¡ä»¶è£…é…ï¼Œæ»¡è¶³ Conditional æŒ‡å®šçš„æ¡ä»¶åˆ™è¿›è¡Œç»„ä»¶æ³¨å…¥ï¼ŒåŠ ä¸Šæ–¹æ³•æˆ–è€…ç±»ä¸Šï¼Œä½œç”¨èŒƒå›´ä¸åŒ ä½¿ç”¨ï¼š@Conditional é…åˆ Condition çš„å®ç°ç±»ï¼ˆClassConditionï¼‰è¿›è¡Œä½¿ç”¨ ConditionContext ç±»APIï¼š æ–¹æ³• è¯´æ˜ ConfigurableListableBeanFactory getBeanFactory() è·å–åˆ° IOC ä½¿ç”¨çš„ beanfactory ClassLoader getClassLoader() è·å–ç±»åŠ è½½å™¨ Environment getEnvironment() è·å–å½“å‰ç¯å¢ƒä¿¡æ¯ BeanDefinitionRegistry getRegistry() è·å–åˆ° bean å®šä¹‰çš„æ³¨å†Œç±» ClassConditionï¼š 12345678910111213141516171819public class ClassCondition implements Condition &#123; /** * context ä¸Šä¸‹æ–‡å¯¹è±¡ã€‚ç”¨äºè·å–ç¯å¢ƒï¼ŒIOCå®¹å™¨ï¼ŒClassLoaderå¯¹è±¡ * metadata æ³¨è§£å…ƒå¯¹è±¡ã€‚ å¯ä»¥ç”¨äºè·å–æ³¨è§£å®šä¹‰çš„å±æ€§å€¼ */ @Override public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) &#123; //1.éœ€æ±‚ï¼š å¯¼å…¥Jedisåæ ‡ååˆ›å»ºBean //æ€è·¯ï¼šåˆ¤æ–­redis.clients.jedis.Jedis.classæ–‡ä»¶æ˜¯å¦å­˜åœ¨ boolean flag = true; try &#123; Class&lt;?&gt; cls = Class.forName(&quot;redis.clients.jedis.Jedis&quot;); &#125; catch (ClassNotFoundException e) &#123; flag = false; &#125; return flag; &#125;&#125; UserConfigï¼š 12345678@Configurationpublic class UserConfig &#123; @Bean @Conditional(ClassCondition.class) public User user()&#123; return new User(); &#125;&#125; å¯åŠ¨ç±»ï¼š 12345678910@SpringBootApplicationpublic class SpringbootConditionApplication &#123; public static void main(String[] args) &#123; //å¯åŠ¨SpringBootåº”ç”¨ï¼Œè¿”å›Springçš„IOCå®¹å™¨ ConfigurableApplicationContext context = SpringApplication.run(SpringbootConditionApplication.class, args); Object user = context.getBean(&quot;user&quot;); System.out.println(user); &#125;&#125; è‡ªå®šä¹‰æ³¨è§£å°†ç±»çš„åˆ¤æ–­å®šä¹‰ä¸ºåŠ¨æ€çš„ï¼Œåˆ¤æ–­å“ªä¸ªå­—èŠ‚ç æ–‡ä»¶å­˜åœ¨å¯ä»¥åŠ¨æ€æŒ‡å®š è‡ªå®šä¹‰æ¡ä»¶æ³¨è§£ç±» 1234567@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)@Retention(RetentionPolicy.RUNTIME)@Documented@Conditional(ClassCondition.class)public @interface ConditionOnClass &#123; String[] value();&#125; ClassCondition 12345678910111213141516171819202122public class ClassCondition implements Condition &#123; @Override public boolean matches(ConditionContext conditionContext, AnnotatedTypeMetadata metadata) &#123; //éœ€æ±‚ï¼šé€šè¿‡æ³¨è§£å±æ€§å€¼valueæŒ‡å®šåæ ‡ååˆ›å»ºbean Map&lt;String, Object&gt; map = metadata.getAnnotationAttributes (ConditionOnClass.class.getName()); //map = &#123;value=&#123;å±æ€§å€¼&#125;&#125; //è·å–æ‰€æœ‰çš„ String[] value = (String[]) map.get(&quot;value&quot;); boolean flag = true; try &#123; for (String className : value) &#123; Class&lt;?&gt; cls = Class.forName(className); &#125; &#125; catch (Exception e) &#123; flag = false; &#125; return flag; &#125;&#125; UserConfig 12345678@Configurationpublic class UserConfig &#123; @Bean @ConditionOnClass(&quot;com.alibaba.fastjson.JSON&quot;)//JSONåŠ è½½äº†æ‰æ³¨å†Œ User åˆ°å®¹å™¨ public User user()&#123; return new User(); &#125;&#125; æµ‹è¯• User å¯¹è±¡çš„åˆ›å»º å¸¸ç”¨æ³¨è§£SpringBoot æä¾›çš„å¸¸ç”¨æ¡ä»¶æ³¨è§£ï¼š @ConditionalOnPropertyï¼šåˆ¤æ–­é…ç½®æ–‡ä»¶ä¸­æ˜¯å¦æœ‰å¯¹åº”å±æ€§å’Œå€¼æ‰åˆå§‹åŒ– Bean 12345678@Configurationpublic class UserConfig &#123; @Bean @ConditionalOnProperty(name = &quot;it&quot;, havingValue = &quot;seazean&quot;) public User user() &#123; return new User(); &#125;&#125; 1it=seazean @ConditionalOnClassï¼šåˆ¤æ–­ç¯å¢ƒä¸­æ˜¯å¦æœ‰å¯¹åº”ç±»æ–‡ä»¶æ‰åˆå§‹åŒ– Bean @ConditionalOnMissingClassï¼šåˆ¤æ–­ç¯å¢ƒä¸­æ˜¯å¦æœ‰å¯¹åº”ç±»æ–‡ä»¶æ‰åˆå§‹åŒ– Bean @ConditionalOnMissingBeanï¼šåˆ¤æ–­ç¯å¢ƒä¸­æ²¡æœ‰å¯¹åº”Beanæ‰åˆå§‹åŒ– Bean ImportResä½¿ç”¨ bean.xml æ–‡ä»¶ç”Ÿæˆé…ç½® beanï¼Œå¦‚æœéœ€è¦ç»§ç»­å¤ç”¨ bean.xmlï¼Œ@ImportResource å¯¼å…¥é…ç½®æ–‡ä»¶å³å¯ 1234@ImportResource(&quot;classpath:beans.xml&quot;)public class MyConfig &#123; //...&#125; 12345678910&lt;beans ...&gt; &lt;bean id=&quot;haha&quot; class=&quot;com.lun.boot.bean.User&quot;&gt; &lt;property name=&quot;name&quot; value=&quot;zhangsan&quot;&gt;&lt;/property&gt; &lt;property name=&quot;age&quot; value=&quot;18&quot;&gt;&lt;/property&gt; &lt;/bean&gt; &lt;bean id=&quot;hehe&quot; class=&quot;com.lun.boot.bean.Pet&quot;&gt; &lt;property name=&quot;name&quot; value=&quot;tomcat&quot;&gt;&lt;/property&gt; &lt;/bean&gt;&lt;/beans&gt; Properties@ConfigurationPropertiesï¼šè¯»å–åˆ° properties æ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œå¹¶ä¸”å°è£…åˆ° JavaBean ä¸­ é…ç½®æ–‡ä»¶ï¼š 12mycar.brand=BYDmycar.price=100000 JavaBean ç±»ï¼š 123456@Component //å¯¼å…¥åˆ°å®¹å™¨å†…@ConfigurationProperties(prefix = &quot;mycar&quot;)//ä»£è¡¨é…ç½®æ–‡ä»¶çš„å‰ç¼€public class Car &#123; private String brand; private Integer price;&#125; è£…é…åŸç†å¯åŠ¨æµç¨‹åº”ç”¨å¯åŠ¨ï¼š 1234567@SpringBootApplicationpublic class BootApplication &#123; public static void main(String[] args) &#123; // å¯åŠ¨ä»£ç  SpringApplication.run(BootApplication.class, args); &#125;&#125; SpringApplication æ„é€ æ–¹æ³•ï¼š this.resourceLoader = resourceLoaderï¼šèµ„æºåŠ è½½å™¨ï¼Œåˆå§‹ä¸º null this.webApplicationType = WebApplicationType.deduceFromClasspath()ï¼šåˆ¤æ–­å½“å‰åº”ç”¨çš„ç±»å‹ï¼Œæ˜¯å“åº”å¼è¿˜æ˜¯ Web ç±» this.bootstrapRegistryInitializers = getBootstrapRegistryInitializersFromSpringFactories()ï¼šè·å–å¼•å¯¼å™¨ å» META-INF/spring.factories æ–‡ä»¶ä¸­æ‰¾ org.springframework.boot.Bootstrapper å¯»æ‰¾çš„é¡ºåºï¼šclasspath â†’ spring-beans â†’ boot-devtools â†’ springboot â†’ boot-autoconfigure setInitializers(getSpringFactoriesInstances(ApplicationContextInitializer.class))ï¼šè·å–åˆå§‹åŒ–å™¨ å» META-INF/spring.factories æ–‡ä»¶ä¸­æ‰¾ org.springframework.context.ApplicationContextInitializer setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class))ï¼šè·å–ç›‘å¬å™¨ å» META-INF/spring.factories æ–‡ä»¶ä¸­æ‰¾ org.springframework.context.ApplicationListener this.mainApplicationClass = deduceMainApplicationClass()ï¼šè·å–å‡º main ç¨‹åºç±» SpringApplication#run(Stringâ€¦ args)ï¼šåˆ›å»º IOC å®¹å™¨å¹¶å®ç°äº†è‡ªåŠ¨è£…é… StopWatch stopWatch = new StopWatch()ï¼šåœæ­¢ç›‘å¬å™¨ï¼Œç›‘æ§æ•´ä¸ªåº”ç”¨çš„å¯åœ stopWatch.start()ï¼šè®°å½•åº”ç”¨çš„å¯åŠ¨æ—¶é—´ bootstrapContext = createBootstrapContext()ï¼šåˆ›å»ºå¼•å¯¼ä¸Šä¸‹æ–‡ç¯å¢ƒ bootstrapContext = new DefaultBootstrapContext()ï¼šåˆ›å»ºé»˜è®¤çš„å¼•å¯¼ç±»ç¯å¢ƒ this.bootstrapRegistryInitializers.forEach()ï¼šéå†æ‰€æœ‰çš„å¼•å¯¼å™¨è°ƒç”¨ initialize æ–¹æ³•å®Œæˆåˆå§‹åŒ–è®¾ç½® configureHeadlessProperty()ï¼šè®©å½“å‰åº”ç”¨è¿›å…¥ headless æ¨¡å¼ listeners = getRunListeners(args)ï¼šè·å–æ‰€æœ‰ RunListenerï¼ˆè¿è¡Œç›‘å¬å™¨ï¼‰ å» META-INF/spring.factories æ–‡ä»¶ä¸­æ‰¾ org.springframework.boot.SpringApplicationRunListener listeners.starting(bootstrapContext, this.mainApplicationClass)ï¼šéå†æ‰€æœ‰çš„è¿è¡Œç›‘å¬å™¨è°ƒç”¨ starting æ–¹æ³• applicationArguments = new DefaultApplicationArguments(args)ï¼šè·å–æ‰€æœ‰çš„å‘½ä»¤è¡Œå‚æ•° environment = prepareEnvironment(listeners, bootstrapContext, applicationArguments)ï¼šå‡†å¤‡ç¯å¢ƒ environment = getOrCreateEnvironment()ï¼šè¿”å›æˆ–åˆ›å»ºåŸºç¡€ç¯å¢ƒä¿¡æ¯å¯¹è±¡ switch (this.webApplicationType)ï¼šæ ¹æ®å½“å‰åº”ç”¨çš„ç±»å‹åˆ›å»ºç¯å¢ƒ case SERVLETï¼šWeb åº”ç”¨ç¯å¢ƒå¯¹åº” ApplicationServletEnvironment case REACTIVEï¼šå“åº”å¼ç¼–ç¨‹å¯¹åº” ApplicationReactiveWebEnvironment defaultï¼šé»˜è®¤ä¸º Spring ç¯å¢ƒ ApplicationEnvironment configureEnvironment(environment, applicationArguments.getSourceArgs())ï¼šè¯»å–æ‰€æœ‰é…ç½®æºçš„å±æ€§å€¼é…ç½®ç¯å¢ƒ ConfigurationPropertySources.attach(environment)ï¼šå±æ€§å€¼ç»‘å®šç¯å¢ƒä¿¡æ¯ sources.addFirst(ATTACHED_PROPERTY_SOURCE_NAME,..)ï¼šæŠŠ configurationProperties æ”¾å…¥ç¯å¢ƒçš„å±æ€§ä¿¡æ¯å¤´éƒ¨ listeners.environmentPrepared(bootstrapContext, environment)ï¼šè¿è¡Œç›‘å¬å™¨è°ƒç”¨ environmentPrepared()ï¼ŒEventPublishingRunListener å‘å¸ƒäº‹ä»¶é€šçŸ¥æ‰€æœ‰çš„ç›‘å¬å™¨å½“å‰ç¯å¢ƒå‡†å¤‡å®Œæˆ DefaultPropertiesPropertySource.moveToEnd(environment)ï¼šç§»åŠ¨ defaultProperties å±æ€§æºåˆ°ç¯å¢ƒä¸­çš„æœ€åä¸€ä¸ªæº bindToSpringApplication(environment)ï¼šä¸å®¹å™¨ç»‘å®šå½“å‰ç¯å¢ƒ ConfigurationPropertySources.attach(environment)ï¼šé‡æ–°å°†å±æ€§å€¼ç»‘å®šç¯å¢ƒä¿¡æ¯ sources.remove(ATTACHED_PROPERTY_SOURCE_NAME)ï¼šä»ç¯å¢ƒä¿¡æ¯ä¸­ç§»é™¤ configurationProperties sources.addFirst(ATTACHED_PROPERTY_SOURCE_NAME,..)ï¼šæŠŠ configurationProperties é‡æ–°æ”¾å…¥ç¯å¢ƒä¿¡æ¯ configureIgnoreBeanInfo(environment)ï¼šé…ç½®å¿½ç•¥çš„ bean printedBanner = printBanner(environment)ï¼šæ‰“å° SpringBoot æ ‡å¿— context = createApplicationContext()ï¼šåˆ›å»º IOC å®¹å™¨ switch (this.webApplicationType)ï¼šæ ¹æ®å½“å‰åº”ç”¨çš„ç±»å‹åˆ›å»º IOC å®¹å™¨ case SERVLETï¼šWeb åº”ç”¨ç¯å¢ƒå¯¹åº” AnnotationConfigServletWebServerApplicationContext case REACTIVEï¼šå“åº”å¼ç¼–ç¨‹å¯¹åº” AnnotationConfigReactiveWebServerApplicationContext defaultï¼šé»˜è®¤ä¸º Spring ç¯å¢ƒ AnnotationConfigApplicationContext context.setApplicationStartup(this.applicationStartup)ï¼šè®¾ç½®ä¸€ä¸ªå¯åŠ¨å™¨ prepareContext()ï¼šé…ç½® IOC å®¹å™¨çš„åŸºæœ¬ä¿¡æ¯ postProcessApplicationContext(context)ï¼šåç½®å¤„ç†æµç¨‹ applyInitializers(context)ï¼šè·å–æ‰€æœ‰çš„åˆå§‹åŒ–å™¨è°ƒç”¨ initialize() æ–¹æ³•è¿›è¡Œåˆå§‹åŒ– listeners.contextPrepared(context)ï¼šæ‰€æœ‰çš„è¿è¡Œç›‘å¬å™¨è°ƒç”¨ environmentPrepared() æ–¹æ³•ï¼ŒEventPublishingRunListener å‘å¸ƒäº‹ä»¶é€šçŸ¥ IOC å®¹å™¨å‡†å¤‡å®Œæˆ listeners.contextLoaded(context)ï¼šæ‰€æœ‰çš„è¿è¡Œç›‘å¬å™¨è°ƒç”¨ contextLoaded() æ–¹æ³•ï¼Œé€šçŸ¥ IOC åŠ è½½å®Œæˆ refreshContext(context)ï¼šåˆ·æ–° IOC å®¹å™¨ Spring çš„å®¹å™¨å¯åŠ¨æµç¨‹ invokeBeanFactoryPostProcessors(beanFactory)ï¼šå®ç°äº†è‡ªåŠ¨è£…é… onRefresh()ï¼šåˆ›å»º WebServer ä½¿ç”¨è¯¥æ¥å£ afterRefresh(context, applicationArguments)ï¼šç•™ç»™ç”¨æˆ·è‡ªå®šä¹‰å®¹å™¨åˆ·æ–°å®Œæˆåçš„å¤„ç†é€»è¾‘ stopWatch.stop()ï¼šè®°å½•åº”ç”¨å¯åŠ¨å®Œæˆçš„æ—¶é—´ callRunners(context, applicationArguments)ï¼šè°ƒç”¨æ‰€æœ‰ runners listeners.started(context)ï¼šæ‰€æœ‰çš„è¿è¡Œç›‘å¬å™¨è°ƒç”¨ started() æ–¹æ³• listeners.running(context)ï¼šæ‰€æœ‰çš„è¿è¡Œç›‘å¬å™¨è°ƒç”¨ running() æ–¹æ³• è·å–å®¹å™¨ä¸­çš„ ApplicationRunnerã€CommandLineRunner AnnotationAwareOrderComparator.sort(runners)ï¼šåˆå¹¶æ‰€æœ‰ runner å¹¶ä¸”æŒ‰ç…§ @Order è¿›è¡Œæ’åº callRunner()ï¼šéå†æ‰€æœ‰çš„ runnerï¼Œè°ƒç”¨ run æ–¹æ³• handleRunFailure(context, ex, listeners)ï¼šå¤„ç†å¼‚å¸¸ï¼Œå‡ºç°å¼‚å¸¸è¿›å…¥è¯¥é€»è¾‘ handleExitCode(context, exception)ï¼šå¤„ç†é”™è¯¯ä»£ç  listeners.failed(context, exception)ï¼šè¿è¡Œç›‘å¬å™¨è°ƒç”¨ failed() æ–¹æ³• reportFailure(getExceptionReporters(context), exception)ï¼šé€šçŸ¥å¼‚å¸¸ æ³¨è§£åˆ†æSpringBoot å®šä¹‰äº†ä¸€å¥—æ¥å£è§„èŒƒï¼Œè¿™å¥—è§„èŒƒè§„å®š SpringBoot åœ¨å¯åŠ¨æ—¶ä¼šæ‰«æå¤–éƒ¨å¼•ç”¨ jar åŒ…ä¸­çš„ META-INF/spring.factories æ–‡ä»¶ï¼Œå°†æ–‡ä»¶ä¸­é…ç½®çš„ç±»å‹ä¿¡æ¯åŠ è½½åˆ° Spring å®¹å™¨ï¼Œå¹¶æ‰§è¡Œç±»ä¸­å®šä¹‰çš„å„ç§æ“ä½œï¼Œå¯¹äºå¤–éƒ¨çš„ jar åŒ…ï¼Œç›´æ¥å¼•å…¥ä¸€ä¸ª starter å³å¯ @SpringBootApplication æ³¨è§£æ˜¯ @SpringBootConfigurationã€@EnableAutoConfigurationã€@ComponentScan æ³¨è§£çš„é›†åˆ @SpringBootApplication æ³¨è§£ 1234567@Inherited@SpringBootConfiguration //ä»£è¡¨ @SpringBootApplication æ‹¥æœ‰äº†è¯¥æ³¨è§£çš„åŠŸèƒ½@EnableAutoConfiguration //åŒç†@ComponentScan(excludeFilters = &#123; @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class), @Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)// æ‰«æè¢« @Component (@Service,@Controller)æ³¨è§£çš„ beanï¼Œå®¹å™¨ä¸­å°†æ’é™¤TypeExcludeFilter å’Œ AutoConfigurationExcludeFilterpublic @interface SpringBootApplication &#123; &#125; @SpringBootConfiguration æ³¨è§£ï¼š 123456@Configuration // ä»£è¡¨æ˜¯é…ç½®ç±»@Indexedpublic @interface SpringBootConfiguration &#123; @AliasFor(annotation = Configuration.class) boolean proxyBeanMethods() default true;&#125; @AliasFor æ³¨è§£ï¼šè¡¨ç¤ºåˆ«åï¼Œå¯ä»¥æ³¨è§£åˆ°è‡ªå®šä¹‰æ³¨è§£çš„ä¸¤ä¸ªå±æ€§ä¸Šè¡¨ç¤ºè¿™ä¸¤ä¸ªäº’ä¸ºåˆ«åï¼Œä¸¤ä¸ªå±æ€§å…¶å®æ˜¯åŒä¸€ä¸ªå«ä¹‰ç›¸äº’æ›¿ä»£ @ComponentScan æ³¨è§£ï¼šé»˜è®¤æ‰«æå½“å‰ç±»æ‰€åœ¨åŒ…åŠå…¶å­çº§åŒ…ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ @EnableAutoConfiguration æ³¨è§£ï¼šå¯ç”¨ SpringBoot çš„è‡ªåŠ¨é…ç½®æœºåˆ¶ 1234567@AutoConfigurationPackage @Import(AutoConfigurationImportSelector.class)public @interface EnableAutoConfiguration &#123; String ENABLED_OVERRIDE_PROPERTY = &quot;spring.boot.enableautoconfiguration&quot;; Class&lt;?&gt;[] exclude() default &#123;&#125;; String[] excludeName() default &#123;&#125;;&#125; @AutoConfigurationPackageï¼šå°†æ·»åŠ è¯¥æ³¨è§£çš„ç±»æ‰€åœ¨çš„ package ä½œä¸ºè‡ªåŠ¨é…ç½® package è¿›è¡Œç®¡ç†ï¼ŒæŠŠå¯åŠ¨ç±»æ‰€åœ¨çš„åŒ…è®¾ç½®ä¸€æ¬¡ï¼Œä¸ºäº†ç»™å„ç§è‡ªåŠ¨é…ç½®çš„ç¬¬ä¸‰æ–¹åº“æ‰«æç”¨ï¼Œæ¯”å¦‚å¸¦ @Mapper æ³¨è§£çš„ç±»ï¼ŒSpring è‡ªèº«æ˜¯ä¸èƒ½è¯†åˆ«çš„ï¼Œä½†è‡ªåŠ¨é…ç½®çš„ Mybatis éœ€è¦æ‰«æç”¨åˆ°ï¼Œè€Œ ComponentScan åªæ˜¯ç”¨æ¥æ‰«ææ³¨è§£ç±»ï¼Œå¹¶æ²¡æœ‰æä¾›æ¥å£ç»™ä¸‰æ–¹ä½¿ç”¨ 12345@Import(AutoConfigurationPackages.Registrar.class) // åˆ©ç”¨ Registrar ç»™å®¹å™¨ä¸­å¯¼å…¥ç»„ä»¶public @interface AutoConfigurationPackage &#123; String[] basePackages() default &#123;&#125;; //è‡ªåŠ¨é…ç½®åŒ…ï¼ŒæŒ‡å®šäº†é…ç½®ç±»çš„åŒ… Class&lt;?&gt;[] basePackageClasses() default &#123;&#125;;&#125; register(registry, new PackageImports(metadata).getPackageNames().toArray(new String[0]))ï¼šæ³¨å†Œ BD new PackageImports(metadata).getPackageNames()ï¼šè·å–æ·»åŠ å½“å‰æ³¨è§£çš„ç±»çš„æ‰€åœ¨åŒ… registry.registerBeanDefinition(BEAN, new BasePackagesBeanDefinition(packageNames))ï¼šå­˜æ”¾åˆ°å®¹å™¨ä¸­ new BasePackagesBeanDefinition(packageNames)ï¼šæŠŠå½“å‰ä¸»ç±»æ‰€åœ¨çš„åŒ…åå°è£…åˆ°è¯¥å¯¹è±¡ä¸­ @Import(AutoConfigurationImportSelector.class)ï¼šè‡ªåŠ¨è£…é…çš„æ ¸å¿ƒç±» å®¹å™¨åˆ·æ–°æ—¶æ‰§è¡Œï¼šinvokeBeanFactoryPostProcessors() â†’ invokeBeanDefinitionRegistryPostProcessors() â†’ postProcessBeanDefinitionRegistry() â†’ processConfigBeanDefinitions() â†’ parse() â†’ process() â†’ processGroupImports() â†’ getImports() â†’ process() â†’ AutoConfigurationImportSelector#getAutoConfigurationEntry() 12345678910111213141516171819202122protected AutoConfigurationEntry getAutoConfigurationEntry(AnnotationMetadata annotationMetadata) &#123; if (!isEnabled(annotationMetadata)) &#123; return EMPTY_ENTRY; &#125; // è·å–æ³¨è§£å±æ€§ï¼Œ@SpringBootApplication æ³¨è§£çš„ exclude å±æ€§å’Œ excludeName å±æ€§ AnnotationAttributes attributes = getAttributes(annotationMetadata); // è·å–æ‰€æœ‰éœ€è¦è‡ªåŠ¨è£…é…çš„å€™é€‰é¡¹ List&lt;String&gt; configurations = getCandidateConfigurations(annotationMetadata, attributes); // å»é™¤é‡å¤çš„é€‰é¡¹ configurations = removeDuplicates(configurations); // è·å–æ³¨è§£é…ç½®çš„æ’é™¤çš„è‡ªåŠ¨è£…é…ç±» Set&lt;String&gt; exclusions = getExclusions(annotationMetadata, attributes); checkExcludedClasses(configurations, exclusions); // ç§»é™¤æ‰€æœ‰çš„é…ç½®çš„ä¸éœ€è¦è‡ªåŠ¨è£…é…çš„ç±» configurations.removeAll(exclusions); // è¿‡æ»¤ï¼Œæ¡ä»¶è£…é… configurations = getConfigurationClassFilter().filter(configurations); // è·å– AutoConfigurationImportListener ç±»çš„ç›‘å¬å™¨è°ƒç”¨ onAutoConfigurationImportEvent æ–¹æ³• fireAutoConfigurationImportEvents(configurations, exclusions); // åŒ…è£…æˆ AutoConfigurationEntry è¿”å› return new AutoConfigurationEntry(configurations, exclusions);&#125; AutoConfigurationImportSelector#getCandidateConfigurationsï¼šè·å–è‡ªåŠ¨é…ç½®çš„å€™é€‰é¡¹ List&lt;String&gt; configurations = SpringFactoriesLoader.loadFactoryNames()ï¼šåŠ è½½è‡ªåŠ¨é…ç½®ç±» å‚æ•°ä¸€ï¼šgetSpringFactoriesLoaderFactoryClass()ï¼šè·å– @EnableAutoConfiguration æ³¨è§£ç±» å‚æ•°äºŒï¼šgetBeanClassLoader()ï¼šè·å–ç±»åŠ è½½å™¨ factoryTypeName = factoryType.getName()ï¼š@EnableAutoConfiguration æ³¨è§£çš„å…¨ç±»å return loadSpringFactories(classLoaderToUse).getOrDefault()ï¼šåŠ è½½èµ„æº urls = classLoader.getResources(FACTORIES_RESOURCE_LOCATION)ï¼šè·å–èµ„æºç±» FACTORIES_RESOURCE_LOCATION = &quot;META-INF/spring.factories&quot;ï¼šåŠ è½½çš„èµ„æºçš„ä½ç½® return configurationsï¼šè¿”å›æ‰€æœ‰è‡ªåŠ¨è£…é…ç±»çš„å€™é€‰é¡¹ ä» spring-boot-autoconfigure-2.5.3.jar&#x2F;META-INF&#x2F;spring.factories æ–‡ä»¶ä¸­å¯»æ‰¾ EnableAutoConfiguration å­—æ®µï¼Œè·å–è‡ªåŠ¨è£…é…ç±»ï¼Œè¿›è¡Œæ¡ä»¶è£…é…ï¼ŒæŒ‰éœ€è£…é… è£…é…æµç¨‹Spring Boot é€šè¿‡ @EnableAutoConfiguration å¼€å¯è‡ªåŠ¨è£…é…ï¼Œé€šè¿‡ SpringFactoriesLoader åŠ è½½ META-INF/spring.factories ä¸­çš„è‡ªåŠ¨é…ç½®ç±»å®ç°è‡ªåŠ¨è£…é…ï¼Œè‡ªåŠ¨é…ç½®ç±»å…¶å®å°±æ˜¯é€šè¿‡ @Conditional æ³¨è§£æŒ‰éœ€åŠ è½½çš„é…ç½®ç±»ï¼Œæƒ³è¦å…¶ç”Ÿæ•ˆå¿…é¡»å¼•å…¥ spring-boot-starter-xxx åŒ…å®ç°èµ·æ­¥ä¾èµ– SpringBoot å…ˆåŠ è½½æ‰€æœ‰çš„è‡ªåŠ¨é…ç½®ç±» xxxxxAutoConfiguration æ¯ä¸ªè‡ªåŠ¨é…ç½®ç±»è¿›è¡Œæ¡ä»¶è£…é…ï¼Œé»˜è®¤éƒ½ä¼šç»‘å®šé…ç½®æ–‡ä»¶æŒ‡å®šçš„å€¼ï¼ˆxxxProperties å’Œé…ç½®æ–‡ä»¶è¿›è¡Œäº†ç»‘å®šï¼‰ SpringBoot é»˜è®¤ä¼šåœ¨åº•å±‚é…å¥½æ‰€æœ‰çš„ç»„ä»¶ï¼Œå¦‚æœç”¨æˆ·è‡ªå·±é…ç½®äº†ä»¥ç”¨æˆ·çš„ä¼˜å…ˆ å®šåˆ¶åŒ–é…ç½®ï¼š ç”¨æˆ·å¯ä»¥ä½¿ç”¨ @Bean æ–°å»ºè‡ªå·±çš„ç»„ä»¶æ¥æ›¿æ¢åº•å±‚çš„ç»„ä»¶ ç”¨æˆ·å¯ä»¥å»çœ‹è¿™ä¸ªç»„ä»¶æ˜¯è·å–çš„é…ç½®æ–‡ä»¶å‰ç¼€å€¼ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹ ä»¥ DispatcherServletAutoConfiguration ä¸ºä¾‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243@AutoConfigureOrder(Ordered.HIGHEST_PRECEDENCE)// ç±»ä¸­çš„ Bean é»˜è®¤ä¸æ˜¯å•ä¾‹@Configuration(proxyBeanMethods = false)@ConditionalOnWebApplication(type = Type.SERVLET)// æ¡ä»¶è£…é…ï¼Œç¯å¢ƒä¸­æœ‰ DispatcherServlet ç±»æ‰è¿›è¡Œè‡ªåŠ¨è£…é…@ConditionalOnClass(DispatcherServlet.class)@AutoConfigureAfter(ServletWebServerFactoryAutoConfiguration.class)public class DispatcherServletAutoConfiguration &#123; // æ³¨å†Œçš„ DispatcherServlet çš„ BeanName public static final String DEFAULT_DISPATCHER_SERVLET_BEAN_NAME = &quot;dispatcherServlet&quot;; @Configuration(proxyBeanMethods = false) @Conditional(DefaultDispatcherServletCondition.class) @ConditionalOnClass(ServletRegistration.class) // ç»‘å®šé…ç½®æ–‡ä»¶çš„å±æ€§ï¼Œä»é…ç½®æ–‡ä»¶ä¸­è·å–é…ç½®é¡¹ @EnableConfigurationProperties(WebMvcProperties.class) protected static class DispatcherServletConfiguration &#123; // ç»™å®¹å™¨æ³¨å†Œä¸€ä¸ª DispatcherServletï¼Œèµ·åå­—ä¸º dispatcherServlet @Bean(name = DEFAULT_DISPATCHER_SERVLET_BEAN_NAME) public DispatcherServlet dispatcherServlet(WebMvcProperties webMvcProperties) &#123; // æ–°å»ºä¸€ä¸ª DispatcherServlet è®¾ç½®ç›¸å…³å±æ€§ DispatcherServlet dispatcherServlet = new DispatcherServlet(); // spring.mvc ä¸­çš„é…ç½®é¡¹è·å–æ³¨å…¥ï¼Œæ²¡æœ‰å°±å¡«å……é»˜è®¤å€¼ dispatcherServlet.setDispatchOptionsRequest(webMvcProperties.isDispatchOptionsRequest()); // ...... // è¿”å›è¯¥å¯¹è±¡æ³¨å†Œåˆ°å®¹å™¨å†… return dispatcherServlet; &#125; @Bean // å®¹å™¨ä¸­æœ‰è¿™ä¸ªç±»å‹ç»„ä»¶æ‰è¿›è¡Œè£…é… @ConditionalOnBean(MultipartResolver.class) // å®¹å™¨ä¸­æ²¡æœ‰è¿™ä¸ªåå­— multipartResolver çš„ç»„ä»¶ @ConditionalOnMissingBean(name = DispatcherServlet.MULTIPART_RESOLVER_BEAN_NAME) // æ–¹æ³•åå°±æ˜¯ BeanName public MultipartResolver multipartResolver(MultipartResolver resolver) &#123; // ç»™ @Bean æ ‡æ³¨çš„æ–¹æ³•ä¼ å…¥äº†å¯¹è±¡å‚æ•°ï¼Œè¿™ä¸ªå‚æ•°å°±ä¼šä»å®¹å™¨ä¸­æ‰¾ï¼Œå› ä¸ºç”¨æˆ·è‡ªå®šä¹‰äº†è¯¥ç±»å‹ï¼Œä»¥ç”¨æˆ·é…ç½®çš„ä¼˜å…ˆ // ä½†æ˜¯åå­—ä¸ç¬¦åˆè§„èŒƒï¼Œæ‰€ä»¥è·å–åˆ°è¯¥ Bean å¹¶è¿”å›åˆ°å®¹å™¨ä¸€ä¸ªè§„èŒƒçš„åç§°ï¼šmultipartResolver return resolver; &#125; &#125;&#125; 123// å°†é…ç½®æ–‡ä»¶ä¸­çš„ spring.mvc å‰ç¼€çš„å±æ€§ä¸è¯¥ç±»ç»‘å®š@ConfigurationProperties(prefix = &quot;spring.mvc&quot;) public class WebMvcProperties &#123; &#125; äº‹ä»¶ç›‘å¬SpringBoot åœ¨é¡¹ç›®å¯åŠ¨æ—¶ï¼Œä¼šå¯¹å‡ ä¸ªç›‘å¬å™¨è¿›è¡Œå›è°ƒï¼Œå¯ä»¥å®ç°ç›‘å¬å™¨æ¥å£ï¼Œåœ¨é¡¹ç›®å¯åŠ¨æ—¶å®Œæˆä¸€äº›æ“ä½œ ApplicationContextInitializerã€SpringApplicationRunListenerã€CommandLineRunnerã€ApplicationRunner MyApplicationRunner è‡ªå®šä¹‰ç›‘å¬å™¨çš„å¯åŠ¨æ—¶æœºï¼šMyApplicationRunner å’Œ MyCommandLineRunner éƒ½æ˜¯å½“é¡¹ç›®å¯åŠ¨åæ‰§è¡Œï¼Œä½¿ç”¨ @Component æ”¾å…¥å®¹å™¨å³å¯ä½¿ç”¨ 123456789//å½“é¡¹ç›®å¯åŠ¨åæ‰§è¡Œrunæ–¹æ³•@Componentpublic class MyApplicationRunner implements ApplicationRunner &#123; @Override public void run(ApplicationArguments args) throws Exception &#123; System.out.println(&quot;ApplicationRunner...run&quot;); System.out.println(Arrays.asList(args.getSourceArgs()));//propertiesé…ç½®ä¿¡æ¯ &#125;&#125; MyCommandLineRunner 12345678@Componentpublic class MyCommandLineRunner implements CommandLineRunner &#123; @Override public void run(String... args) throws Exception &#123; System.out.println(&quot;CommandLineRunner...run&quot;); System.out.println(Arrays.asList(args)); &#125;&#125; MyApplicationContextInitializer çš„å¯ç”¨è¦åœ¨ resource æ–‡ä»¶å¤¹ä¸‹æ·»åŠ  META-INF&#x2F;spring.factories 12org.springframework.context.ApplicationContextInitializer=\\com.example.springbootlistener.listener.MyApplicationContextInitializer 1234567@Componentpublic class MyApplicationContextInitializer implements ApplicationContextInitializer &#123; @Override public void initialize(ConfigurableApplicationContext applicationContext) &#123; System.out.println(&quot;ApplicationContextInitializer....initialize&quot;); &#125;&#125; MySpringApplicationRunListener çš„ä½¿ç”¨è¦æ·»åŠ æ„é€ å™¨ 12345678910111213141516171819202122232425262728293031323334353637383940public class MySpringApplicationRunListener implements SpringApplicationRunListener &#123; //æ„é€ å™¨ public MySpringApplicationRunListener(SpringApplication sa, String[] args) &#123; &#125; @Override public void starting() &#123; System.out.println(&quot;starting...é¡¹ç›®å¯åŠ¨ä¸­&quot;);//è¾“å‡ºSPRINGä¹‹å‰ &#125; @Override public void environmentPrepared(ConfigurableEnvironment environment) &#123; System.out.println(&quot;environmentPrepared...ç¯å¢ƒå¯¹è±¡å¼€å§‹å‡†å¤‡&quot;); &#125; @Override public void contextPrepared(ConfigurableApplicationContext context) &#123; System.out.println(&quot;contextPrepared...ä¸Šä¸‹æ–‡å¯¹è±¡å¼€å§‹å‡†å¤‡&quot;); &#125; @Override public void contextLoaded(ConfigurableApplicationContext context) &#123; System.out.println(&quot;contextLoaded...ä¸Šä¸‹æ–‡å¯¹è±¡å¼€å§‹åŠ è½½&quot;); &#125; @Override public void started(ConfigurableApplicationContext context) &#123; System.out.println(&quot;started...ä¸Šä¸‹æ–‡å¯¹è±¡åŠ è½½å®Œæˆ&quot;); &#125; @Override public void running(ConfigurableApplicationContext context) &#123; System.out.println(&quot;running...é¡¹ç›®å¯åŠ¨å®Œæˆï¼Œå¼€å§‹è¿è¡Œ&quot;); &#125; @Override public void failed(ConfigurableApplicationContext context, Throwable exception) &#123; System.out.println(&quot;failed...é¡¹ç›®å¯åŠ¨å¤±è´¥&quot;); &#125;&#125; é…ç½®æ–‡ä»¶é…ç½®æ–¹å¼æ–‡ä»¶ç±»å‹SpringBoot æ˜¯åŸºäºçº¦å®šçš„ï¼Œå¾ˆå¤šé…ç½®éƒ½æœ‰é»˜è®¤å€¼ï¼Œå¦‚æœæƒ³ä½¿ç”¨è‡ªå·±çš„é…ç½®æ›¿æ¢é»˜è®¤é…ç½®ï¼Œå¯ä»¥ä½¿ç”¨ application.properties æˆ–è€… application.ymlï¼ˆapplication.yamlï¼‰è¿›è¡Œé…ç½® é»˜è®¤é…ç½®æ–‡ä»¶åç§°ï¼šapplication åœ¨åŒä¸€çº§ç›®å½•ä¸‹ä¼˜å…ˆçº§ä¸ºï¼šproperties &gt; yml &gt; yaml ä¾‹å¦‚é…ç½®å†…ç½® Tomcat çš„ç«¯å£ propertiesï¼š 1server.port=8080 ymlï¼š 1server: port: 8080 yamlï¼š 1server: port: 8080 åŠ è½½é¡ºåºæ‰€æœ‰ä½ç½®çš„é…ç½®æ–‡ä»¶éƒ½ä¼šè¢«åŠ è½½ï¼Œäº’è¡¥é…ç½®ï¼Œé«˜ä¼˜å…ˆçº§é…ç½®å†…å®¹ä¼šè¦†ç›–ä½ä¼˜å…ˆçº§é…ç½®å†…å®¹ æ‰«æé…ç½®æ–‡ä»¶çš„ä½ç½®æŒ‰ä¼˜å…ˆçº§ä»é«˜åˆ°åº•ï¼š file:./config/ï¼šå½“å‰é¡¹ç›®ä¸‹çš„ &#x2F;config ç›®å½•ä¸‹ file:./ï¼šå½“å‰é¡¹ç›®çš„æ ¹ç›®å½•ï¼ŒProjectå·¥ç¨‹ç›®å½• classpath:/config/ï¼šclasspath çš„ &#x2F;config ç›®å½• classpath:/ï¼šclasspath çš„æ ¹ç›®å½•ï¼Œå°±æ˜¯ resoureces ç›®å½• é¡¹ç›®å¤–éƒ¨é…ç½®æ–‡ä»¶åŠ è½½é¡ºåºï¼šå¤–éƒ¨é…ç½®æ–‡ä»¶çš„ä½¿ç”¨æ˜¯ä¸ºäº†å¯¹å†…éƒ¨æ–‡ä»¶çš„é…åˆ å‘½ä»¤è¡Œï¼šåœ¨ package æ‰“åŒ…åçš„ target ç›®å½•ä¸‹ï¼Œä½¿ç”¨è¯¥å‘½ä»¤ 1java -jar myproject.jar --server.port=9000 æŒ‡å®šé…ç½®æ–‡ä»¶ä½ç½® 1java -jar myproject.jar --spring.config.location=e://application.properties æŒ‰ä¼˜å…ˆçº§ä»é«˜åˆ°åº•é€‰æ‹©é…ç½®æ–‡ä»¶çš„åŠ è½½å‘½ä»¤ 1java -jar myproject.jar yamlè¯­æ³•åŸºæœ¬è¯­æ³•ï¼š å¤§å°å†™æ•æ„Ÿ æ•°æ®å€¼å‰è¾¹å¿…é¡»æœ‰ç©ºæ ¼ï¼Œä½œä¸ºåˆ†éš”ç¬¦ ä½¿ç”¨ç¼©è¿›è¡¨ç¤ºå±‚çº§å…³ç³» ç¼©è¿›æ—¶ä¸å…è®¸ä½¿ç”¨Tabé”®ï¼Œåªå…è®¸ä½¿ç”¨ç©ºæ ¼ï¼ˆå„ä¸ªç³»ç»Ÿ Tabå¯¹åº”ç©ºæ ¼æ•°ç›®å¯èƒ½ä¸åŒï¼Œå¯¼è‡´å±‚æ¬¡æ··ä¹±ï¼‰ ç¼©è¿›çš„ç©ºæ ¼æ•°ç›®ä¸é‡è¦ï¼Œåªè¦ç›¸åŒå±‚çº§çš„å…ƒç´ å·¦ä¾§å¯¹é½å³å¯ â€˜â€™#â€ è¡¨ç¤ºæ³¨é‡Šï¼Œä»è¿™ä¸ªå­—ç¬¦ä¸€ç›´åˆ°è¡Œå°¾ï¼Œéƒ½ä¼šè¢«è§£æå™¨å¿½ç•¥ 123server: port: 8080 address: 127.0.0.1 æ•°æ®æ ¼å¼ï¼š çº¯é‡ï¼šå•ä¸ªçš„ã€ä¸å¯å†åˆ†çš„å€¼ 12msg1: &#x27;hello \\n world&#x27; # å•å¼•å¿½ç•¥è½¬ä¹‰å­—ç¬¦msg2: &quot;hello \\n world&quot; # åŒå¼•è¯†åˆ«è½¬ä¹‰å­—ç¬¦ å¯¹è±¡ï¼šé”®å€¼å¯¹é›†åˆï¼ŒMapã€Hash 12345person: name: zhangsan age: 20# è¡Œå†…å†™æ³•person: &#123;name: zhangsan&#125; æ³¨æ„ï¼šä¸å»ºè®®ä½¿ç”¨ JSONï¼Œåº”è¯¥ä½¿ç”¨ yaml è¯­æ³• æ•°ç»„ï¼šä¸€ç»„æŒ‰æ¬¡åºæ’åˆ—çš„å€¼ï¼ŒListã€Array 12345address: - beijing - shanghai# è¡Œå†…å†™æ³•address: [beijing,shanghai] 12345allPerson #List&lt;Person&gt; - &#123;name:lisi, age:18&#125; - &#123;name:wangwu, age:20&#125;# è¡Œå†…å†™æ³•allPerson: [&#123;name:lisi, age:18&#125;, &#123;name:wangwu, age:20&#125;] å‚æ•°å¼•ç”¨ï¼š 123name: lisi person: name: $&#123;name&#125; # å¼•ç”¨ä¸Šè¾¹å®šä¹‰çš„nameå€¼ è·å–é…ç½®ä¸‰ç§è·å–é…ç½®æ–‡ä»¶çš„æ–¹å¼ï¼š æ³¨è§£ @Value 1234567891011121314151617181920212223@RestControllerpublic class HelloController &#123; @Value(&quot;$&#123;name&#125;&quot;) private String name; @Value(&quot;$&#123;person.name&#125;&quot;) private String name2; @Value(&quot;$&#123;address[0]&#125;&quot;) private String address1; @Value(&quot;$&#123;msg1&#125;&quot;) private String msg1; @Value(&quot;$&#123;msg2&#125;&quot;) private String msg2; @RequestMapping(&quot;/hello&quot;) public String hello()&#123; System.out.println(&quot;æ‰€æœ‰çš„æ•°æ®&quot;); return &quot; hello Spring Boot !&quot;; &#125;&#125; Evironment å¯¹è±¡ 123456789@Autowiredprivate Environment env;@RequestMapping(&quot;/hello&quot;)public String hello() &#123; System.out.println(env.getProperty(&quot;person.name&quot;)); System.out.println(env.getProperty(&quot;address[0]&quot;)); return &quot; hello Spring Boot !&quot;;&#125; æ³¨è§£ @ConfigurationProperties é…åˆ @Component ä½¿ç”¨ æ³¨æ„ï¼šå‚æ•° prefix ä¸€å®šè¦æŒ‡å®š 1234567@Component //ä¸æ‰«æè¯¥ç»„ä»¶åˆ°å®¹å™¨å†…ï¼Œæ— æ³•å®Œæˆè‡ªåŠ¨è£…é…@ConfigurationProperties(prefix = &quot;person&quot;)public class Person &#123; private String name; private int age; private String[] address;&#125; 123456789@Autowiredprivate Person person;@RequestMapping(&quot;/hello&quot;)public String hello() &#123; System.out.println(person); //Person&#123;name=&#x27;zhangsan&#x27;, age=20, address=[beijing, shanghai]&#125; return &quot; hello Spring Boot !&quot;;&#125; é…ç½®æç¤ºè‡ªå®šä¹‰çš„ç±»å’Œé…ç½®æ–‡ä»¶ç»‘å®šä¸€èˆ¬æ²¡æœ‰æç¤ºï¼Œæ·»åŠ å¦‚ä¸‹ä¾èµ–å¯ä»¥ä½¿ç”¨æç¤ºï¼š 1234567891011121314151617181920212223&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-configuration-processor&lt;/artifactId&gt; &lt;optional&gt;true&lt;/optional&gt;&lt;/dependency&gt;&lt;!-- ä¸‹é¢æ’ä»¶ä½œç”¨æ˜¯å·¥ç¨‹æ‰“åŒ…æ—¶ï¼Œä¸å°†spring-boot-configuration-processoræ‰“è¿›åŒ…å†…ï¼Œè®©å…¶åªåœ¨ç¼–ç çš„æ—¶å€™æœ‰ç”¨ --&gt;&lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt; &lt;configuration&gt; &lt;excludes&gt; &lt;exclude&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-configuration-processor&lt;/artifactId&gt; &lt;/exclude&gt; &lt;/excludes&gt; &lt;/configuration&gt; &lt;/plugin&gt; &lt;/plugins&gt;&lt;/build&gt; Profile@Profileï¼šæŒ‡å®šç»„ä»¶åœ¨å“ªä¸ªç¯å¢ƒçš„æƒ…å†µä¸‹æ‰èƒ½è¢«æ³¨å†Œåˆ°å®¹å™¨ä¸­ï¼Œä¸æŒ‡å®šï¼Œä»»ä½•ç¯å¢ƒä¸‹éƒ½èƒ½æ³¨å†Œè¿™ä¸ªç»„ä»¶ åŠ äº†ç¯å¢ƒæ ‡è¯†çš„ beanï¼Œåªæœ‰è¿™ä¸ªç¯å¢ƒè¢«æ¿€æ´»çš„æ—¶å€™æ‰èƒ½æ³¨å†Œåˆ°å®¹å™¨ä¸­ï¼Œé»˜è®¤æ˜¯ default ç¯å¢ƒ å†™åœ¨é…ç½®ç±»ä¸Šï¼Œåªæœ‰æ˜¯æŒ‡å®šçš„ç¯å¢ƒçš„æ—¶å€™ï¼Œæ•´ä¸ªé…ç½®ç±»é‡Œé¢çš„æ‰€æœ‰é…ç½®æ‰èƒ½å¼€å§‹ç”Ÿæ•ˆ æ²¡æœ‰æ ‡æ³¨ç¯å¢ƒæ ‡è¯†çš„ bean åœ¨ï¼Œä»»ä½•ç¯å¢ƒä¸‹éƒ½æ˜¯åŠ è½½çš„ Profile çš„é…ç½®ï¼š profile æ˜¯ç”¨æ¥å®Œæˆä¸åŒç¯å¢ƒä¸‹ï¼Œé…ç½®åŠ¨æ€åˆ‡æ¢åŠŸèƒ½ profile é…ç½®æ–¹å¼ï¼šå¤š profile æ–‡ä»¶æ–¹å¼ï¼Œæä¾›å¤šä¸ªé…ç½®æ–‡ä»¶ï¼Œæ¯ä¸ªä»£è¡¨ä¸€ç§ç¯å¢ƒ application-dev.properties&#x2F;yml å¼€å‘ç¯å¢ƒ application-test.properties&#x2F;yml æµ‹è¯•ç¯å¢ƒ sapplication-pro.properties&#x2F;yml ç”Ÿäº§ç¯å¢ƒ yml å¤šæ–‡æ¡£æ–¹å¼ï¼šåœ¨ yml ä¸­ä½¿ç”¨ â€” åˆ†éš”ä¸åŒé…ç½® 12345678910111213141516---server: port: 8081spring: profiles:dev---server: port: 8082spring: profiles:test---server: port: 8083spring: profiles:pro--- profile æ¿€æ´»æ–¹å¼ é…ç½®æ–‡ä»¶ï¼šåœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼šspring.profiles.active&#x3D;dev 1spring.profiles.active=dev è™šæ‹Ÿæœºå‚æ•°ï¼šåœ¨VM options æŒ‡å®šï¼š-Dspring.profiles.active=dev å‘½ä»¤è¡Œå‚æ•°ï¼šjava â€“jar xxx.jar --spring.profiles.active=dev åœ¨ Program arguments é‡Œè¾“å…¥ï¼Œä¹Ÿå¯ä»¥å…ˆ package Webå¼€å‘åŠŸèƒ½æ”¯æŒSpringBoot è‡ªåŠ¨é…ç½®äº†å¾ˆå¤šçº¦å®šï¼Œå¤§å¤šåœºæ™¯éƒ½æ— éœ€è‡ªå®šä¹‰é…ç½® å†…å®¹åå•†è§†å›¾è§£æå™¨ ContentNegotiatingViewResolver å’Œ BeanName è§†å›¾è§£æå™¨ BeanNameViewResolver æ”¯æŒé™æ€èµ„æºï¼ˆåŒ…æ‹¬ webjarsï¼‰å’Œé™æ€ index.html é¡µæ”¯æŒ è‡ªåŠ¨æ³¨å†Œç›¸å…³ç±»ï¼šConverterã€GenericConverterã€Formatter å†…å®¹åå•†å¤„ç†å™¨ï¼šHttpMessageConverters å›½é™…åŒ–ï¼šMessageCodesResolver å¼€å‘è§„èŒƒï¼š ä½¿ç”¨ @Configuration + WebMvcConfigurer è‡ªå®šä¹‰è§„åˆ™ï¼Œä¸ä½¿ç”¨ @EnableWebMvc æ³¨è§£ å£°æ˜ WebMvcRegistrations çš„å®ç°ç±»æ”¹å˜é»˜è®¤åº•å±‚ç»„ä»¶ ä½¿ç”¨ @EnableWebMvc + @Configuration + DelegatingWebMvcConfiguration å…¨é¢æ¥ç®¡ SpringMVC é™æ€èµ„æºè®¿é—®è§„åˆ™é»˜è®¤çš„é™æ€èµ„æºè·¯å¾„æ˜¯ classpath ä¸‹çš„ï¼Œä¼˜å…ˆçº§ç”±é«˜åˆ°ä½ä¸ºï¼š&#x2F;META-INF&#x2F;resourcesã€&#x2F;resourcesã€ &#x2F;staticã€&#x2F;public çš„åŒ…å†…ï¼Œ/ è¡¨ç¤ºå½“å‰é¡¹ç›®çš„æ ¹è·¯å¾„ é™æ€æ˜ å°„ /** ï¼Œè¡¨ç¤ºè¯·æ±‚ / + é™æ€èµ„æºå å°±ç›´æ¥å»é»˜è®¤çš„èµ„æºè·¯å¾„å¯»æ‰¾è¯·æ±‚çš„èµ„æº å¤„ç†åŸç†ï¼šé™è¯·æ±‚å»å¯»æ‰¾ Controller å¤„ç†ï¼Œä¸èƒ½å¤„ç†çš„è¯·æ±‚å°±ä¼šäº¤ç»™é™æ€èµ„æºå¤„ç†å™¨ï¼Œé™æ€èµ„æºä¹Ÿæ‰¾ä¸åˆ°å°±å“åº” 404 é¡µé¢ ä¿®æ”¹é»˜è®¤èµ„æºè·¯å¾„ï¼š 1234spring: web: resources: static-locations:: [classpath:/haha/] ä¿®æ”¹é™æ€èµ„æºè®¿é—®å‰ç¼€ï¼Œé»˜è®¤æ˜¯ /**ï¼š 123spring: mvc: static-path-pattern: /resources/** è®¿é—® URLï¼šhttp://localhost:8080/resources/ + é™æ€èµ„æºåï¼Œå°†æ‰€æœ‰èµ„æºé‡å®šä½åˆ° /resources/ webjar è®¿é—®èµ„æºï¼š 12345&lt;dependency&gt; &lt;groupId&gt;org.webjars&lt;/groupId&gt; &lt;artifactId&gt;jquery&lt;/artifactId&gt; &lt;version&gt;3.5.1&lt;/version&gt;&lt;/dependency&gt; è®¿é—®åœ°å€ï¼šhttp://localhost:8080/webjars/jquery/3.5.1/jquery.jsï¼Œåé¢åœ°å€è¦æŒ‰ç…§ä¾èµ–é‡Œé¢çš„åŒ…è·¯å¾„ æ¬¢è¿é¡µé¢é™æ€èµ„æºè·¯å¾„ä¸‹ index.html é»˜è®¤ä½œä¸ºæ¬¢è¿é¡µé¢ï¼Œè®¿é—® http://localhost:8080 å‡ºç°è¯¥é¡µé¢ï¼Œä½¿ç”¨ welcome page åŠŸèƒ½ä¸èƒ½ä¿®æ”¹å‰ç¼€ ç½‘é¡µæ ‡ç­¾ä¸Šçš„å°å›¾æ ‡å¯ä»¥è‡ªå®šä¹‰è§„åˆ™ï¼ŒæŠŠèµ„æºé‡å‘½åä¸º favicon.ico æ”¾åœ¨é™æ€èµ„æºç›®å½•ä¸‹å³å¯ æºç åˆ†æSpringMVC åŠŸèƒ½çš„è‡ªåŠ¨é…ç½®ç±» WebMvcAutoConfigurationï¼š 1234public class WebMvcAutoConfiguration &#123; //å½“å‰é¡¹ç›®çš„æ ¹è·¯å¾„ private static final String SERVLET_LOCATION = &quot;/&quot;;&#125; å†…éƒ¨ç±» WebMvcAutoConfigurationAdapterï¼š 123456789101112131415161718@Import(EnableWebMvcConfiguration.class)// ç»‘å®š spring.mvcã€spring.webã€spring.resources ç›¸å…³çš„é…ç½®å±æ€§@EnableConfigurationProperties(&#123; WebMvcProperties.class,ResourceProperties.class, WebProperties.class &#125;)@Order(0)public static class WebMvcAutoConfigurationAdapter implements WebMvcConfigurer, ServletContextAware &#123; //æœ‰å‚æ„é€ å™¨æ‰€æœ‰å‚æ•°çš„å€¼éƒ½ä¼šä»å®¹å™¨ä¸­ç¡®å®š public WebMvcAutoConfigurationAdapter(/*å‚æ•°*/) &#123; this.resourceProperties = resourceProperties.hasBeenCustomized() ? resourceProperties : webProperties.getResources(); this.mvcProperties = mvcProperties; this.beanFactory = beanFactory; this.messageConvertersProvider = messageConvertersProvider; this.resourceHandlerRegistrationCustomizer = resourceHandlerRegistrationCustomizerProvider.getIfAvailable(); this.dispatcherServletPath = dispatcherServletPath; this.servletRegistrations = servletRegistrations; this.mvcProperties.checkConfiguration(); &#125;&#125; ResourceProperties resourcePropertiesï¼šè·å–å’Œ spring.resources ç»‘å®šçš„æ‰€æœ‰çš„å€¼çš„å¯¹è±¡ WebMvcProperties mvcPropertiesï¼šè·å–å’Œ spring.mvc ç»‘å®šçš„æ‰€æœ‰çš„å€¼çš„å¯¹è±¡ ListableBeanFactory beanFactoryï¼šSpring çš„ beanFactory HttpMessageConvertersï¼šæ‰¾åˆ°æ‰€æœ‰çš„ HttpMessageConverters ResourceHandlerRegistrationCustomizerï¼šæ‰¾åˆ° èµ„æºå¤„ç†å™¨çš„è‡ªå®šä¹‰å™¨ã€‚ DispatcherServletPathï¼šé¡¹ç›®è·¯å¾„ ServletRegistrationBeanï¼šç»™åº”ç”¨æ³¨å†Œ Servletã€Filter WebMvcAutoConfiguration.WebMvcAutoConfigurationAdapter.addResourceHandler()ï¼šä¸¤ç§é™æ€èµ„æºæ˜ å°„è§„åˆ™ 123456789101112131415161718public void addResourceHandlers(ResourceHandlerRegistry registry) &#123; //é…ç½®æ–‡ä»¶è®¾ç½® spring.resources.add-mappings: falseï¼Œç¦ç”¨æ‰€æœ‰é™æ€èµ„æº if (!this.resourceProperties.isAddMappings()) &#123; logger.debug(&quot;Default resource handling disabled&quot;);//è¢«ç¦ç”¨ return; &#125; //æ³¨å†Œwebjarsé™æ€èµ„æºçš„æ˜ å°„è§„åˆ™ æ˜ å°„ è·¯å¾„ addResourceHandler(registry, &quot;/webjars/**&quot;, &quot;classpath:/META-INF/resources/webjars/&quot;); //æ³¨å†Œé™æ€èµ„æºè·¯å¾„çš„æ˜ å°„è§„åˆ™ é»˜è®¤æ˜ å°„ staticPathPattern = &quot;/**&quot; addResourceHandler(registry, this.mvcProperties.getStaticPathPattern(), (registration) -&gt; &#123; //staticLocations = CLASSPATH_RESOURCE_LOCATIONS registration.addResourceLocations(this.resourceProperties.getStaticLocations()); if (this.servletContext != null) &#123; ServletContextResource resource = new ServletContextResource(this.servletContext, SERVLET_LOCATION); registration.addResourceLocations(resource); &#125; &#125;);&#125; 123456789101112131415@ConfigurationProperties(&quot;spring.web&quot;)public class WebProperties &#123; public static class Resources &#123; //é»˜è®¤èµ„æºè·¯å¾„ï¼Œä¼˜å…ˆçº§ä»é«˜åˆ°ä½ static final String[] CLASSPATH_RESOURCE_LOCATIONS = &#123; &quot;classpath:/META-INF/resources/&quot;, &quot;classpath:/resources/&quot;, &quot;classpath:/static/&quot;, &quot;classpath:/public/&quot; &#125; private String[] staticLocations = CLASSPATH_RESOURCE_LOCATIONS; //å¯ä»¥è¿›è¡Œè§„åˆ™é‡å†™ public void setStaticLocations(String[] staticLocations) &#123; this.staticLocations = appendSlashIfNecessary(staticLocations); this.customized = true; &#125; &#125;&#125; WebMvcAutoConfiguration.EnableWebMvcConfiguration.welcomePageHandlerMapping()ï¼šæ¬¢è¿é¡µ 12345678910111213141516171819202122232425//spring.web å±æ€§@EnableConfigurationProperties(WebProperties.class)public static class EnableWebMvcConfiguration &#123; @Bean public WelcomePageHandlerMapping welcomePageHandlerMapping(/*å‚æ•°*/) &#123; WelcomePageHandlerMapping welcomePageHandlerMapping = new WelcomePageHandlerMapping( new TemplateAvailabilityProviders(applicationContext), applicationContext, getWelcomePage(), //staticPathPattern = &quot;/**&quot; this.mvcProperties.getStaticPathPattern()); return welcomePageHandlerMapping; &#125;&#125;WelcomePageHandlerMapping(/*å‚æ•°*/) &#123; //æ‰€ä»¥é™åˆ¶ staticPathPattern å¿…é¡»ä¸º /** æ‰èƒ½å¯ç”¨è¯¥åŠŸèƒ½ if (welcomePage != null &amp;&amp; &quot;/**&quot;.equals(staticPathPattern)) &#123; logger.info(&quot;Adding welcome page: &quot; + welcomePage); //é‡å®šå‘ setRootViewName(&quot;forward:index.html&quot;); &#125; else if (welcomeTemplateExists(templateAvailabilityProviders, applicationContext)) &#123; logger.info(&quot;Adding welcome page template: index&quot;); setRootViewName(&quot;index&quot;); &#125;&#125; WelcomePageHandlerMappingï¼Œè®¿é—® &#x2F; èƒ½è®¿é—®åˆ° index.html Restæ˜ å°„å¼€å¯ Rest åŠŸèƒ½ 12345spring: mvc: hiddenmethod: filter: enabled: true #å¼€å¯é¡µé¢è¡¨å•çš„ReståŠŸèƒ½ æºç åˆ†æï¼Œæ³¨å…¥äº† HiddenHttpMethodFilte è§£æ Rest é£æ ¼çš„è®¿é—®ï¼š 12345678public class WebMvcAutoConfiguration &#123; @Bean @ConditionalOnMissingBean(HiddenHttpMethodFilter.class) @ConditionalOnProperty(prefix = &quot;spring.mvc.hiddenmethod.filter&quot;, name = &quot;enabled&quot;) public OrderedHiddenHttpMethodFilter hiddenHttpMethodFilter() &#123; return new OrderedHiddenHttpMethodFilter(); &#125;&#125; è¯¦ç»†æºç è§£æï¼šSpringMVC â†’ åŸºæœ¬æ“ä½œ â†’ Restful â†’ è¯†åˆ«åŸç† Web éƒ¨åˆ†æºç è¯¦è§£ï¼šSpringMVC â†’ è¿è¡ŒåŸç† å†…åµŒå®¹å™¨SpringBoot åµŒå…¥å¼ Servlet å®¹å™¨ï¼Œé»˜è®¤æ”¯æŒçš„ WebServeï¼šTomcatã€Jettyã€Undertow é…ç½®æ–¹å¼ï¼š 1234567891011121314&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;exclusions&gt; &lt;exclusion&gt; &lt;!--å¿…é¡»è¦æŠŠå†…åµŒçš„ Tomcat å®¹å™¨--&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-tomcat&lt;/artifactId&gt; &lt;/exclusion&gt; &lt;/exclusions&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-jetty&lt;/artifactId&gt;&lt;/dependency&gt; Web åº”ç”¨å¯åŠ¨ï¼ŒSpringBoot å¯¼å…¥ Web åœºæ™¯åŒ… tomcatï¼Œåˆ›å»ºä¸€ä¸ª Web ç‰ˆçš„ IOC å®¹å™¨ï¼š SpringApplication.run(BootApplication.class, args)ï¼šåº”ç”¨å¯åŠ¨ ConfigurableApplicationContext.run()ï¼š context = createApplicationContext()ï¼šåˆ›å»ºå®¹å™¨ applicationContextFactory = ApplicationContextFactory.DEFAULT 1234567891011121314151617ApplicationContextFactory DEFAULT = (webApplicationType) -&gt; &#123; try &#123; switch (webApplicationType) &#123; case SERVLET: // Servlet å®¹å™¨ï¼Œç»§æ‰¿è‡ª ServletWebServerApplicationContext return new AnnotationConfigServletWebServerApplicationContext(); case REACTIVE: // å“åº”å¼ç¼–ç¨‹ return new AnnotationConfigReactiveWebServerApplicationContext(); default: // æ™®é€š Spring å®¹å™¨ return new AnnotationConfigApplicationContext(); &#125; &#125; catch (Exception ex) &#123; throw new IllegalStateException(); &#125;&#125; applicationContextFactory.create(this.webApplicationType)ï¼šæ ¹æ®åº”ç”¨ç±»å‹åˆ›å»ºå®¹å™¨ refreshContext(context)ï¼šå®¹å™¨å¯åŠ¨åˆ·æ–° å†…åµŒå®¹å™¨å·¥ä½œæµç¨‹ï¼š Spring å®¹å™¨å¯åŠ¨é€»è¾‘ä¸­ï¼Œåœ¨å®ä¾‹åŒ–éæ‡’åŠ è½½çš„å•ä¾‹ Bean ä¹‹å‰æœ‰ä¸€ä¸ªæ–¹æ³• **onRefresh()**ï¼Œç•™ç»™å­ç±»å»æ‰©å±•ï¼ŒWeb å®¹å™¨å°±æ˜¯é‡å†™è¿™ä¸ªæ–¹æ³•åˆ›å»º WebServer 123456789protected void onRefresh() &#123; //çœç•¥.... createWebServer();&#125;private void createWebServer() &#123; ServletWebServerFactory factory = getWebServerFactory(); this.webServer = factory.getWebServer(getSelfInitializer()); createWebServer.end();&#125; è·å– WebServer å·¥å‚ ServletWebServerFactoryï¼Œå¹¶ä¸”è·å–çš„æ•°é‡ä¸ç­‰äº 1 ä¼šæŠ¥é”™ï¼ŒSpring åº•å±‚æœ‰ä¸‰ç§ï¼š TomcatServletWebServerFactoryã€JettyServletWebServerFactoryã€UndertowServletWebServerFactory è‡ªåŠ¨é…ç½®ç±» ServletWebServerFactoryAutoConfiguration å¯¼å…¥äº† ServletWebServerFactoryConfigurationï¼ˆé…ç½®ç±»ï¼‰ï¼Œæ ¹æ®æ¡ä»¶è£…é…åˆ¤æ–­ç³»ç»Ÿä¸­åˆ°åº•å¯¼å…¥äº†å“ªä¸ª Web æœåŠ¡å™¨çš„åŒ…ï¼Œåˆ›å»ºå‡ºæœåŠ¡å™¨å¹¶å¯åŠ¨ é»˜è®¤æ˜¯ web-starter å¯¼å…¥ tomcat åŒ…ï¼Œå®¹å™¨ä¸­å°±æœ‰ TomcatServletWebServerFactoryï¼Œåˆ›å»ºå‡º Tomcat æœåŠ¡å™¨å¹¶å¯åŠ¨ï¼Œ 1234public TomcatWebServer(Tomcat tomcat, boolean autoStart, Shutdown shutdown) &#123; // åˆå§‹åŒ– initialize();&#125; åˆå§‹åŒ–æ–¹æ³• initialize ä¸­æœ‰å¯åŠ¨æ–¹æ³•ï¼šthis.tomcat.start() è‡ªå®šä¹‰å®šåˆ¶è§„åˆ™1234567891011@Configurationpublic class MyWebMvcConfigurer implements WebMvcConfigurer &#123; @Bean public WebMvcConfigurer webMvcConfigurer() &#123; return new WebMvcConfigurer() &#123; //è¿›è¡Œä¸€äº›æ–¹æ³•é‡å†™ï¼Œæ¥å®ç°è‡ªå®šä¹‰çš„è§„åˆ™ //æ¯”å¦‚æ·»åŠ ä¸€äº›è§£æå™¨å’Œæ‹¦æˆªå™¨ï¼Œå°±æ˜¯å¯¹åŸå§‹å®¹å™¨åŠŸèƒ½çš„å¢åŠ  &#125; &#125; //ä¹Ÿå¯ä»¥ä¸åŠ  @Beanï¼Œç›´æ¥ä»è¿™é‡Œé‡å†™æ–¹æ³•è¿›è¡ŒåŠŸèƒ½å¢åŠ &#125; å®šåˆ¶å®¹å™¨@EnableWebMvcï¼šå…¨é¢æ¥ç®¡ SpringMVCï¼Œæ‰€æœ‰è§„åˆ™å…¨éƒ¨è‡ªå·±é‡æ–°é…ç½® @EnableWebMvc + WebMvcConfigurer + @Bean å…¨é¢æ¥ç®¡SpringMVC @Import(DelegatingWebMvcConfiguration.class)ï¼Œè¯¥ç±»ç»§æ‰¿ WebMvcConfigurationSupportï¼Œè‡ªåŠ¨é…ç½®äº†ä¸€äº›éå¸¸åº•å±‚çš„ç»„ä»¶ï¼Œåªèƒ½ä¿è¯ SpringMVC æœ€åŸºæœ¬çš„ä½¿ç”¨ åŸç†ï¼šè‡ªåŠ¨é…ç½®ç±» WebMvcAutoConfiguration é‡Œé¢çš„é…ç½®è¦èƒ½ç”Ÿæ•ˆï¼ŒWebMvcConfigurationSupport ç±»ä¸èƒ½è¢«åŠ è½½ï¼Œæ‰€ä»¥ @EnableWebMvc å¯¼è‡´é…ç½®ç±»å¤±æ•ˆï¼Œä»è€Œæ¥ç®¡äº† SpringMVC 12@ConditionalOnMissingBean(WebMvcConfigurationSupport.class)public class WebMvcAutoConfiguration &#123;&#125; æ³¨æ„ï¼šä¸€èˆ¬ä¸é€‚ç”¨æ­¤æ³¨è§£ æ•°æ®è®¿é—®JDBCåŸºæœ¬ä½¿ç”¨å¯¼å…¥ starterï¼š 1234567891011&lt;!--å¯¼å…¥ JDBC åœºæ™¯--&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-data-jdbc&lt;/artifactId&gt;&lt;/dependency&gt;&lt;!--å¯¼å…¥ MySQL é©±åŠ¨--&gt;&lt;dependency&gt; &lt;groupId&gt;mysql&lt;/groupId&gt; &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt; &lt;!--ç‰ˆæœ¬å¯¹åº”ä½ çš„ MySQL ç‰ˆæœ¬&lt;version&gt;5.1.49&lt;/version&gt;--&gt;&lt;/dependency&gt; å•ç‹¬å¯¼å…¥ MySQL é©±åŠ¨æ˜¯å› ä¸ºä¸ç¡®å®šç”¨æˆ·ä½¿ç”¨çš„ä»€ä¹ˆæ•°æ®åº“ é…ç½®æ–‡ä»¶ï¼š 123456spring: datasource: url: jdbc:mysql://192.168.0.107:3306/db1?useSSL=false # ä¸åŠ  useSSL ä¼šè­¦å‘Š username: root password: 123456 driver-class-name: com.mysql.jdbc.Driver æµ‹è¯•æ–‡ä»¶ï¼š 12345678910111213@Slf4j@SpringBootTestclass Boot05WebAdminApplicationTests &#123; @Autowired JdbcTemplate jdbcTemplate; @Test void contextLoads() &#123; Long res = jdbcTemplate.queryForObject(&quot;select count(*) from account_tbl&quot;, Long.class); log.info(&quot;è®°å½•æ€»æ•°ï¼š&#123;&#125;&quot;, res); &#125;&#125; è‡ªåŠ¨é…ç½®DataSourceAutoConfigurationï¼šæ•°æ®æºçš„è‡ªåŠ¨é…ç½® 1234567891011121314@Configuration(proxyBeanMethods = false)@ConditionalOnClass(&#123; DataSource.class, EmbeddedDatabaseType.class &#125;)@EnableConfigurationProperties(DataSourceProperties.class)public class DataSourceAutoConfiguration &#123; @Conditional(PooledDataSourceCondition.class) @ConditionalOnMissingBean(&#123; DataSource.class, XADataSource.class &#125;) @Import(&#123; DataSourceConfiguration.Hikari.class, DataSourceConfiguration.Tomcat.class, DataSourceConfiguration.Dbcp2.class, DataSourceConfiguration.OracleUcp.class&#125;) protected static class PooledDataSourceConfiguration &#123;&#125;&#125;// é…ç½®é¡¹@ConfigurationProperties(prefix = &quot;spring.datasource&quot;)public class DataSourceProperties implements BeanClassLoaderAware, InitializingBean &#123;&#125; åº•å±‚é»˜è®¤é…ç½®å¥½çš„è¿æ¥æ± æ˜¯ï¼šHikariDataSource æ•°æ®åº“è¿æ¥æ± çš„é…ç½®ï¼Œæ˜¯å®¹å™¨ä¸­æ²¡æœ‰ DataSource æ‰è‡ªåŠ¨é…ç½®çš„ ä¿®æ”¹æ•°æ®æºç›¸å…³çš„é…ç½®ï¼šspring.datasource ç›¸å…³é…ç½®ï¼š DataSourceTransactionManagerAutoConfigurationï¼š äº‹åŠ¡ç®¡ç†å™¨çš„è‡ªåŠ¨é…ç½® JdbcTemplateAutoConfigurationï¼š JdbcTemplate çš„è‡ªåŠ¨é…ç½® å¯ä»¥ä¿®æ”¹è¿™ä¸ªé…ç½®é¡¹ @ConfigurationProperties(prefix &#x3D; â€œspring.jdbcâ€) æ¥ä¿®æ”¹JdbcTemplate @AutoConfigureAfter(DataSourceAutoConfiguration.class)ï¼šåœ¨ DataSource è£…é…åè£…é… JndiDataSourceAutoConfigurationï¼š jndi çš„è‡ªåŠ¨é…ç½® XADataSourceAutoConfigurationï¼š åˆ†å¸ƒå¼äº‹åŠ¡ç›¸å…³ Druidå¯¼å…¥åæ ‡ï¼š 12345&lt;dependency&gt; &lt;groupId&gt;com.alibaba&lt;/groupId&gt; &lt;artifactId&gt;druid-spring-boot-starter&lt;/artifactId&gt; &lt;version&gt;1.1.17&lt;/version&gt;&lt;/dependency&gt; 123456789@Configuration@ConditionalOnClass(DruidDataSource.class)@AutoConfigureBefore(DataSourceAutoConfiguration.class)@EnableConfigurationProperties(&#123;DruidStatProperties.class, DataSourceProperties.class&#125;)@Import(&#123;DruidSpringAopConfiguration.class, DruidStatViewServletConfiguration.class, DruidWebStatFilterConfiguration.class, DruidFilterConfiguration.class&#125;)public class DruidDataSourceAutoConfigure &#123;&#125; è‡ªåŠ¨é…ç½®ï¼š æ‰©å±•é…ç½®é¡¹ spring.datasource.druid DruidSpringAopConfigurationï¼š ç›‘æ§ SpringBeanï¼Œé…ç½®é¡¹ä¸º spring.datasource.druid.aop-patterns DruidStatViewServletConfigurationï¼šç›‘æ§é¡µçš„é…ç½®é¡¹ä¸º spring.datasource.druid.stat-view-servletï¼Œé»˜è®¤å¼€å¯ DruidWebStatFilterConfigurationï¼šWeb ç›‘æ§é…ç½®é¡¹ä¸º spring.datasource.druid.web-stat-filterï¼Œé»˜è®¤å¼€å¯ DruidFilterConfigurationï¼šæ‰€æœ‰ Druid è‡ªå·± filter çš„é…ç½® é…ç½®ç¤ºä¾‹ï¼š 1234567891011121314151617181920212223242526272829303132spring: datasource: url: jdbc:mysql://localhost:3306/db_account username: root password: 123456 driver-class-name: com.mysql.jdbc.Driver druid: aop-patterns: com.atguigu.admin.* #ç›‘æ§SpringBean filters: stat,wall # åº•å±‚å¼€å¯åŠŸèƒ½ï¼Œstatï¼ˆsqlç›‘æ§ï¼‰ï¼Œwallï¼ˆé˜²ç«å¢™ï¼‰ stat-view-servlet: # é…ç½®ç›‘æ§é¡µåŠŸèƒ½ enabled: true login-username: admin #é¡¹ç›®å¯åŠ¨è®¿é—®ï¼šhttp://localhost:8080/druid ï¼Œè´¦å·å’Œå¯†ç æ˜¯ admin login-password: admin resetEnable: false web-stat-filter: # ç›‘æ§web enabled: true urlPattern: /* exclusions: &#x27;*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*&#x27; filter: stat: # å¯¹ä¸Šé¢filtersé‡Œé¢çš„statçš„è¯¦ç»†é…ç½® slow-sql-millis: 1000 logSlowSql: true enabled: true wall: enabled: true config: drop-table-allow: false é…ç½®ç¤ºä¾‹ï¼šhttps://github.com/alibaba/druid/tree/master/druid-spring-boot-starter é…ç½®é¡¹åˆ—è¡¨ï¼šhttps://github.com/alibaba/druid/wiki/DruidDataSource%E9%85%8D%E7%BD%AE%E5%B1%9E%E6%80%A7%E5%88%97%E8%A1%A8 MyBatisåŸºæœ¬ä½¿ç”¨å¯¼å…¥åæ ‡ï¼š 12345&lt;dependency&gt; &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt; &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt; &lt;version&gt;2.1.4&lt;/version&gt;&lt;/dependency&gt; ç¼–å†™ MyBatis ç›¸å…³é…ç½®ï¼šapplication.yml 12345678# é…ç½®mybatisè§„åˆ™mybatis:# config-location: classpath:mybatis/mybatis-config.xml å»ºè®®ä¸å†™ mapper-locations: classpath:mybatis/mapper/*.xml configuration: map-underscore-to-camel-case: true #å¯ä»¥ä¸å†™å…¨å±€é…ç½®æ–‡ä»¶ï¼Œæ‰€æœ‰å…¨å±€é…ç½®æ–‡ä»¶çš„é…ç½®éƒ½æ”¾åœ¨ configuration é…ç½®é¡¹ä¸­å³å¯ å®šä¹‰è¡¨å’Œå®ä½“ç±» 12345public class User &#123; private int id; private String username; private String password;&#125; ç¼–å†™ dao å’Œ mapper æ–‡ä»¶&#x2F;çº¯æ³¨è§£å¼€å‘ daoï¼š**@Mapper æ³¨è§£å¿…é¡»åŠ ï¼Œä½¿ç”¨è‡ªåŠ¨è£…é…çš„ packageï¼Œå¦åˆ™åœ¨å¯åŠ¨ç±»æŒ‡å®š @MapperScan() æ‰«æè·¯å¾„ï¼ˆä¸å»ºè®®ï¼‰** 12345@Mapper //å¿…é¡»åŠ Mapper@Repositorypublic interface UserXmlMapper &#123; public List&lt;User&gt; findAll();&#125; mapper.xml 1234567&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;&lt;mapper namespace=&quot;com.seazean.springbootmybatis.mapper.UserXmlMapper&quot;&gt; &lt;select id=&quot;findAll&quot; resultType=&quot;user&quot;&gt; select * from t_user &lt;/select&gt;&lt;/mapper&gt; çº¯æ³¨è§£å¼€å‘ 123456@Mapper@Repositorypublic interface UserMapper &#123; @Select(&quot;select * from t_user&quot;) public List&lt;User&gt; findAll();&#125; è‡ªåŠ¨é…ç½®MybatisAutoConfigurationï¼š 123456789101112131415161718@EnableConfigurationProperties(MybatisProperties.class) //MyBatisé…ç½®é¡¹ç»‘å®šç±»ã€‚@AutoConfigureAfter(&#123; DataSourceAutoConfiguration.class, MybatisLanguageDriverAutoConfiguration.class &#125;)public class MybatisAutoConfiguration &#123; @Bean @ConditionalOnMissingBean public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception &#123; SqlSessionFactoryBean factory = new SqlSessionFactoryBean(); return factory.getObject(); &#125; @org.springframework.context.annotation.Configuration @Import(AutoConfiguredMapperScannerRegistrar.class) @ConditionalOnMissingBean(&#123; MapperFactoryBean.class, MapperScannerConfigurer.class &#125;) public static class MapperScannerRegistrarNotFoundConfiguration implements InitializingBean &#123;&#125;&#125;@ConfigurationProperties(prefix = &quot;mybatis&quot;)public class MybatisProperties &#123;&#125; é…ç½®æ–‡ä»¶ï¼šmybatis è‡ªåŠ¨é…ç½®äº† SqlSessionFactory å¯¼å…¥ AutoConfiguredMapperScannerRegistra å®ç° @Mapper çš„æ‰«æ MyBatis-Plus12345&lt;dependency&gt; &lt;groupId&gt;com.baomidou&lt;/groupId&gt; &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt; &lt;version&gt;3.4.1&lt;/version&gt;&lt;/dependency&gt; è‡ªåŠ¨é…ç½®ç±»ï¼šMybatisPlusAutoConfiguration åªéœ€è¦ Mapper ç»§æ‰¿ BaseMapper å°±å¯ä»¥æ‹¥æœ‰ CRUD åŠŸèƒ½ RedisåŸºæœ¬ä½¿ç”¨1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;&lt;/dependency&gt; é…ç½®redisç›¸å…³å±æ€§ 1234spring: redis: host: 127.0.0.1 # redisçš„ä¸»æœºip port: 6379 æ³¨å…¥ RedisTemplate æ¨¡æ¿ 123456789101112131415161718@RunWith(SpringRunner.class)@SpringBootTestpublic class SpringbootRedisApplicationTests &#123; @Autowired private RedisTemplate redisTemplate; @Test public void testSet() &#123; //å­˜å…¥æ•°æ® redisTemplate.boundValueOps(&quot;name&quot;).set(&quot;zhangsan&quot;); &#125; @Test public void testGet() &#123; //è·å–æ•°æ® Object name = redisTemplate.boundValueOps(&quot;name&quot;).get(); System.out.println(name); &#125;&#125; è‡ªåŠ¨é…ç½®RedisAutoConfiguration è‡ªåŠ¨é…ç½®ç±» 123456789101112131415161718192021222324@Configuration(proxyBeanMethods = false)@ConditionalOnClass(RedisOperations.class)@EnableConfigurationProperties(RedisProperties.class)@Import(&#123; LettuceConnectionConfiguration.class, JedisConnectionConfiguration.class &#125;)public class RedisAutoConfiguration &#123; @Bean @ConditionalOnMissingBean(name = &quot;redisTemplate&quot;) @ConditionalOnSingleCandidate(RedisConnectionFactory.class) public RedisTemplate&lt;Object, Object&gt; redisTemplate(RedisConnectionFactory redisConnectionFactory) &#123; RedisTemplate&lt;Object, Object&gt; template = new RedisTemplate&lt;&gt;(); template.setConnectionFactory(redisConnectionFactory); return template; &#125; @Bean @ConditionalOnMissingBean @ConditionalOnSingleCandidate(RedisConnectionFactory.class) public StringRedisTemplate stringRedisTemplate(RedisConnectionFactory redisConnectionFactory) &#123; StringRedisTemplate template = new StringRedisTemplate(); template.setConnectionFactory(redisConnectionFactory); return template; &#125;&#125; é…ç½®é¡¹ï¼šspring.redis è‡ªåŠ¨å¯¼å…¥äº†è¿æ¥å·¥å‚é…ç½®ç±»ï¼šLettuceConnectionConfigurationã€JedisConnectionConfiguration è‡ªåŠ¨æ³¨å…¥äº†æ¨¡æ¿ç±»ï¼šRedisTemplate&lt;Object, Object&gt; ã€StringRedisTemplateï¼Œk v éƒ½æ˜¯ String ç±»å‹ ä½¿ç”¨ @Autowired æ³¨å…¥æ¨¡æ¿ç±»å°±å¯ä»¥æ“ä½œ redis å•å…ƒæµ‹è¯•Junit5Spring Boot 2.2.0 ç‰ˆæœ¬å¼€å§‹å¼•å…¥ JUnit 5 ä½œä¸ºå•å…ƒæµ‹è¯•é»˜è®¤åº“ï¼Œç”±ä¸‰ä¸ªä¸åŒçš„å­æ¨¡å—ç»„æˆï¼š JUnit Platformï¼šåœ¨ JVM ä¸Šå¯åŠ¨æµ‹è¯•æ¡†æ¶çš„åŸºç¡€ï¼Œä¸ä»…æ”¯æŒ Junit è‡ªåˆ¶çš„æµ‹è¯•å¼•æ“ï¼Œå…¶ä»–æµ‹è¯•å¼•æ“ä¹Ÿå¯ä»¥æ¥å…¥ JUnit Jupiterï¼šæä¾›äº† JUnit5 çš„æ–°çš„ç¼–ç¨‹æ¨¡å‹ï¼Œæ˜¯ JUnit5 æ–°ç‰¹æ€§çš„æ ¸å¿ƒï¼Œå†…éƒ¨åŒ…å«äº†ä¸€ä¸ªæµ‹è¯•å¼•æ“ï¼Œç”¨äºåœ¨ Junit Platform ä¸Šè¿è¡Œ JUnit Vintageï¼šJUnit Vintage æä¾›äº†å…¼å®¹ JUnit4.xã€Junit3.x çš„æµ‹è¯•å¼•æ“ æ³¨æ„ï¼šSpringBoot 2.4 ä»¥ä¸Šç‰ˆæœ¬ç§»é™¤äº†é»˜è®¤å¯¹ Vintage çš„ä¾èµ–ï¼Œå¦‚æœéœ€è¦å…¼å®¹ Junit4 éœ€è¦è‡ªè¡Œå¼•å…¥ 12345@SpringBootTestclass Boot05WebAdminApplicationTests &#123; @Test void contextLoads() &#123; &#125;&#125; å¸¸ç”¨æ³¨è§£JUnit5 çš„æ³¨è§£å¦‚ä¸‹ï¼š @Testï¼šè¡¨ç¤ºæ–¹æ³•æ˜¯æµ‹è¯•æ–¹æ³•ï¼Œä½†æ˜¯ä¸ JUnit4 çš„ @Test ä¸åŒï¼Œå®ƒçš„èŒè´£éå¸¸å•ä¸€ä¸èƒ½å£°æ˜ä»»ä½•å±æ€§ï¼Œæ‹“å±•çš„æµ‹è¯•å°†ä¼šç”± Jupiter æä¾›é¢å¤–æµ‹è¯•ï¼ŒåŒ…æ˜¯ org.junit.jupiter.api.Test @ParameterizedTestï¼šè¡¨ç¤ºæ–¹æ³•æ˜¯å‚æ•°åŒ–æµ‹è¯• @RepeatedTestï¼šè¡¨ç¤ºæ–¹æ³•å¯é‡å¤æ‰§è¡Œ @DisplayNameï¼šä¸ºæµ‹è¯•ç±»æˆ–è€…æµ‹è¯•æ–¹æ³•è®¾ç½®å±•ç¤ºåç§° @BeforeEachï¼šè¡¨ç¤ºåœ¨æ¯ä¸ªå•å…ƒæµ‹è¯•ä¹‹å‰æ‰§è¡Œ @AfterEachï¼šè¡¨ç¤ºåœ¨æ¯ä¸ªå•å…ƒæµ‹è¯•ä¹‹åæ‰§è¡Œ @BeforeAllï¼šè¡¨ç¤ºåœ¨æ‰€æœ‰å•å…ƒæµ‹è¯•ä¹‹å‰æ‰§è¡Œ @AfterAllï¼šè¡¨ç¤ºåœ¨æ‰€æœ‰å•å…ƒæµ‹è¯•ä¹‹åæ‰§è¡Œ @Tagï¼šè¡¨ç¤ºå•å…ƒæµ‹è¯•ç±»åˆ«ï¼Œç±»ä¼¼äº JUnit4 ä¸­çš„ @Categories @Disabledï¼šè¡¨ç¤ºæµ‹è¯•ç±»æˆ–æµ‹è¯•æ–¹æ³•ä¸æ‰§è¡Œï¼Œç±»ä¼¼äº JUnit4 ä¸­çš„ @Ignore @Timeoutï¼šè¡¨ç¤ºæµ‹è¯•æ–¹æ³•è¿è¡Œå¦‚æœè¶…è¿‡äº†æŒ‡å®šæ—¶é—´å°†ä¼šè¿”å›é”™è¯¯ @ExtendWithï¼šä¸ºæµ‹è¯•ç±»æˆ–æµ‹è¯•æ–¹æ³•æä¾›æ‰©å±•ç±»å¼•ç”¨ æ–­è¨€æœºåˆ¶ç®€å•æ–­è¨€æ–­è¨€ï¼ˆassertionsï¼‰æ˜¯æµ‹è¯•æ–¹æ³•ä¸­çš„æ ¸å¿ƒï¼Œç”¨æ¥å¯¹æµ‹è¯•éœ€è¦æ»¡è¶³çš„æ¡ä»¶è¿›è¡ŒéªŒè¯ï¼Œæ–­è¨€æ–¹æ³•éƒ½æ˜¯ org.junit.jupiter.api.Assertions çš„é™æ€æ–¹æ³• ç”¨æ¥å¯¹å•ä¸ªå€¼è¿›è¡Œç®€å•çš„éªŒè¯ï¼š æ–¹æ³• è¯´æ˜ assertEquals åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡æˆ–ä¸¤ä¸ªåŸå§‹ç±»å‹æ˜¯å¦ç›¸ç­‰ assertNotEquals åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡æˆ–ä¸¤ä¸ªåŸå§‹ç±»å‹æ˜¯å¦ä¸ç›¸ç­‰ assertSame åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡å¼•ç”¨æ˜¯å¦æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ assertNotSame åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡å¼•ç”¨æ˜¯å¦æŒ‡å‘ä¸åŒçš„å¯¹è±¡ assertTrue åˆ¤æ–­ç»™å®šçš„å¸ƒå°”å€¼æ˜¯å¦ä¸º true assertFalse åˆ¤æ–­ç»™å®šçš„å¸ƒå°”å€¼æ˜¯å¦ä¸º false assertNull åˆ¤æ–­ç»™å®šçš„å¯¹è±¡å¼•ç”¨æ˜¯å¦ä¸º null assertNotNull åˆ¤æ–­ç»™å®šçš„å¯¹è±¡å¼•ç”¨æ˜¯å¦ä¸ä¸º null 1234567@Test@DisplayName(&quot;simple assertion&quot;)public void simple() &#123; assertEquals(3, 1 + 2, &quot;simple math&quot;); assertNull(null); assertNotNull(new Object());&#125; æ•°ç»„æ–­è¨€é€šè¿‡ assertArrayEquals æ–¹æ³•æ¥åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡æˆ–åŸå§‹ç±»å‹çš„æ•°ç»„æ˜¯å¦ç›¸ç­‰ 12345@Test@DisplayName(&quot;array assertion&quot;)public void array() &#123; assertArrayEquals(new int[]&#123;1, 2&#125;, new int[] &#123;1, 2&#125;);&#125; ç»„åˆæ–­è¨€assertAll æ–¹æ³•æ¥å—å¤šä¸ª org.junit.jupiter.api.Executable å‡½æ•°å¼æ¥å£çš„å®ä¾‹ä½œä¸ºéªŒè¯çš„æ–­è¨€ï¼Œå¯ä»¥é€šè¿‡ lambda è¡¨è¾¾å¼æä¾›è¿™äº›æ–­è¨€ 12345678@Test@DisplayName(&quot;assert all&quot;)public void all() &#123; assertAll(&quot;Math&quot;, () -&gt; assertEquals(2, 1 + 1), () -&gt; assertTrue(1 &gt; 0) );&#125; å¼‚å¸¸æ–­è¨€Assertions.assertThrows()ï¼Œé…åˆå‡½æ•°å¼ç¼–ç¨‹å°±å¯ä»¥è¿›è¡Œä½¿ç”¨ 12345678@Test@DisplayName(&quot;å¼‚å¸¸æµ‹è¯•&quot;)public void exceptionTest() &#123; ArithmeticException exception = Assertions.assertThrows( //æ‰”å‡ºæ–­è¨€å¼‚å¸¸ ArithmeticException.class, () -&gt; System.out.println(1 / 0) );&#125; è¶…æ—¶æ–­è¨€Assertions.assertTimeout() ä¸ºæµ‹è¯•æ–¹æ³•è®¾ç½®äº†è¶…æ—¶æ—¶é—´ 123456@Test@DisplayName(&quot;è¶…æ—¶æµ‹è¯•&quot;)public void timeoutTest() &#123; //å¦‚æœæµ‹è¯•æ–¹æ³•æ—¶é—´è¶…è¿‡1så°†ä¼šå¼‚å¸¸ Assertions.assertTimeout(Duration.ofMillis(1000), () -&gt; Thread.sleep(500));&#125; å¿«é€Ÿå¤±è´¥é€šè¿‡ fail æ–¹æ³•ç›´æ¥ä½¿å¾—æµ‹è¯•å¤±è´¥ 12345@Test@DisplayName(&quot;fail&quot;)public void shouldFail() &#123; fail(&quot;This should fail&quot;);&#125; å‰ç½®æ¡ä»¶JUnit 5 ä¸­çš„å‰ç½®æ¡ä»¶ï¼ˆassumptionsï¼‰ç±»ä¼¼äºæ–­è¨€ï¼Œä¸åŒä¹‹å¤„åœ¨äºä¸æ»¡è¶³çš„æ–­è¨€ä¼šä½¿å¾—æµ‹è¯•æ–¹æ³•å¤±è´¥ï¼Œè€Œä¸æ»¡è¶³çš„å‰ç½®æ¡ä»¶åªä¼šä½¿å¾—æµ‹è¯•æ–¹æ³•çš„æ‰§è¡Œç»ˆæ­¢ï¼Œå‰ç½®æ¡ä»¶å¯ä»¥çœ‹æˆæ˜¯æµ‹è¯•æ–¹æ³•æ‰§è¡Œçš„å‰æï¼Œå½“è¯¥å‰æä¸æ»¡è¶³æ—¶ï¼Œå°±æ²¡æœ‰ç»§ç»­æ‰§è¡Œçš„å¿…è¦ 1234567@DisplayName(&quot;æµ‹è¯•å‰ç½®æ¡ä»¶&quot;)@Testvoid testassumptions()&#123; Assumptions.assumeTrue(false,&quot;ç»“æœä¸æ˜¯true&quot;); System.out.println(&quot;111111&quot;);&#125; åµŒå¥—æµ‹è¯•JUnit 5 å¯ä»¥é€šè¿‡ Java ä¸­çš„å†…éƒ¨ç±»å’Œ @Nested æ³¨è§£å®ç°åµŒå¥—æµ‹è¯•ï¼Œä»è€Œå¯ä»¥æ›´å¥½çš„æŠŠç›¸å…³çš„æµ‹è¯•æ–¹æ³•ç»„ç»‡åœ¨ä¸€èµ·ï¼Œåœ¨å†…éƒ¨ç±»ä¸­å¯ä»¥ä½¿ç”¨ @BeforeEach å’Œ @AfterEach æ³¨è§£ï¼Œè€Œä¸”åµŒå¥—çš„å±‚æ¬¡æ²¡æœ‰é™åˆ¶ 123456789101112131415161718192021222324252627282930313233@DisplayName(&quot;A stack&quot;)class TestingAStackDemo &#123; Stack&lt;Object&gt; stack; @Test @DisplayName(&quot;is instantiated with new Stack()&quot;) void isInstantiatedWithNew() &#123; assertNull(stack) &#125; @Nested @DisplayName(&quot;when new&quot;) class WhenNew &#123; @BeforeEach void createNewStack() &#123; stack = new Stack&lt;&gt;(); &#125; @Test @DisplayName(&quot;is empty&quot;) void isEmpty() &#123; assertTrue(stack.isEmpty()); &#125; @Test @DisplayName(&quot;throws EmptyStackException when popped&quot;) void throwsExceptionWhenPopped() &#123; assertThrows(EmptyStackException.class, stack::pop); &#125; &#125;&#125; å‚æ•°æµ‹è¯•å‚æ•°åŒ–æµ‹è¯•æ˜¯ JUnit5 å¾ˆé‡è¦çš„ä¸€ä¸ªæ–°ç‰¹æ€§ï¼Œå®ƒä½¿å¾—ç”¨ä¸åŒçš„å‚æ•°å¤šæ¬¡è¿è¡Œæµ‹è¯•æˆä¸ºäº†å¯èƒ½ åˆ©ç”¨**@ValueSource**ç­‰æ³¨è§£ï¼ŒæŒ‡å®šå…¥å‚ï¼Œæˆ‘ä»¬å°†å¯ä»¥ä½¿ç”¨ä¸åŒçš„å‚æ•°è¿›è¡Œå¤šæ¬¡å•å…ƒæµ‹è¯•ï¼Œè€Œä¸éœ€è¦æ¯æ–°å¢ä¸€ä¸ªå‚æ•°å°±æ–°å¢ä¸€ä¸ªå•å…ƒæµ‹è¯•ï¼Œçœå»äº†å¾ˆå¤šå†—ä½™ä»£ç ã€‚ @ValueSourceï¼šä¸ºå‚æ•°åŒ–æµ‹è¯•æŒ‡å®šå…¥å‚æ¥æºï¼Œæ”¯æŒå…«å¤§åŸºç¡€ç±»ä»¥åŠ String ç±»å‹ã€Class ç±»å‹ @NullSourceï¼šè¡¨ç¤ºä¸ºå‚æ•°åŒ–æµ‹è¯•æä¾›ä¸€ä¸ª null çš„å…¥å‚ @EnumSourceï¼šè¡¨ç¤ºä¸ºå‚æ•°åŒ–æµ‹è¯•æä¾›ä¸€ä¸ªæšä¸¾å…¥å‚ @CsvFileSourceï¼šè¡¨ç¤ºè¯»å–æŒ‡å®š CSV æ–‡ä»¶å†…å®¹ä½œä¸ºå‚æ•°åŒ–æµ‹è¯•å…¥å‚ @MethodSourceï¼šè¡¨ç¤ºè¯»å–æŒ‡å®šæ–¹æ³•çš„è¿”å›å€¼ä½œä¸ºå‚æ•°åŒ–æµ‹è¯•å…¥å‚ï¼ˆæ³¨æ„æ–¹æ³•è¿”å›éœ€è¦æ˜¯ä¸€ä¸ªæµï¼‰ æŒ‡æ ‡ç›‘æ§Actuatoræ¯ä¸€ä¸ªå¾®æœåŠ¡åœ¨äº‘ä¸Šéƒ¨ç½²ä»¥åï¼Œéƒ½éœ€è¦å¯¹å…¶è¿›è¡Œç›‘æ§ã€è¿½è¸ªã€å®¡è®¡ã€æ§åˆ¶ç­‰ï¼ŒSpringBoot æŠ½å–äº† Actuator åœºæ™¯ï¼Œä½¿å¾—æ¯ä¸ªå¾®æœåŠ¡å¿«é€Ÿå¼•ç”¨å³å¯è·å¾—ç”Ÿäº§çº§åˆ«çš„åº”ç”¨ç›‘æ§ã€å®¡è®¡ç­‰åŠŸèƒ½ 1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;&lt;/dependency&gt; æš´éœ²æ‰€æœ‰ç›‘æ§ä¿¡æ¯ä¸º HTTPï¼š 123456management: endpoints: enabled-by-default: true #æš´éœ²æ‰€æœ‰ç«¯ç‚¹ä¿¡æ¯ web: exposure: include: &#x27;*&#x27; #ä»¥webæ–¹å¼æš´éœ² è®¿é—® http://localhost:8080/actuator/[beans/health/metrics/] å¯è§†åŒ–ç•Œé¢ï¼šhttps://github.com/codecentric/spring-boot-admin Endpointé»˜è®¤æ‰€æœ‰çš„ Endpoint é™¤è¿‡ shutdown éƒ½æ˜¯å¼€å¯çš„ 12345678management: endpoints: enabled-by-default: false #ç¦ç”¨æ‰€æœ‰çš„ endpoint: #æ‰‹åŠ¨å¼€å¯ä¸€éƒ¨åˆ† beans: enabled: true health: enabled: true ç«¯ç‚¹ï¼š ID æè¿° auditevents æš´éœ²å½“å‰åº”ç”¨ç¨‹åºçš„å®¡æ ¸äº‹ä»¶ä¿¡æ¯ã€‚éœ€è¦ä¸€ä¸ª AuditEventRepository ç»„ä»¶ beans æ˜¾ç¤ºåº”ç”¨ç¨‹åºä¸­æ‰€æœ‰ Spring Bean çš„å®Œæ•´åˆ—è¡¨ caches æš´éœ²å¯ç”¨çš„ç¼“å­˜ conditions æ˜¾ç¤ºè‡ªåŠ¨é…ç½®çš„æ‰€æœ‰æ¡ä»¶ä¿¡æ¯ï¼ŒåŒ…æ‹¬åŒ¹é…æˆ–ä¸åŒ¹é…çš„åŸå›  configprops æ˜¾ç¤ºæ‰€æœ‰ @ConfigurationProperties env æš´éœ² Spring çš„å±æ€§ ConfigurableEnvironment flyway æ˜¾ç¤ºå·²åº”ç”¨çš„æ‰€æœ‰ Flyway æ•°æ®åº“è¿ç§»ã€‚ éœ€è¦ä¸€ä¸ªæˆ–å¤šä¸ª Flyway ç»„ä»¶ã€‚ health æ˜¾ç¤ºåº”ç”¨ç¨‹åºè¿è¡ŒçŠ¶å†µä¿¡æ¯ httptrace æ˜¾ç¤º HTTP è·Ÿè¸ªä¿¡æ¯ï¼Œé»˜è®¤æƒ…å†µä¸‹ 100 ä¸ª HTTP è¯·æ±‚-å“åº”éœ€è¦ä¸€ä¸ª HttpTraceRepository ç»„ä»¶ info æ˜¾ç¤ºåº”ç”¨ç¨‹åºä¿¡æ¯ integrationgraph æ˜¾ç¤º Spring integrationgraphï¼Œéœ€è¦ä¾èµ– spring-integration-core loggers æ˜¾ç¤ºå’Œä¿®æ”¹åº”ç”¨ç¨‹åºä¸­æ—¥å¿—çš„é…ç½® liquibase æ˜¾ç¤ºå·²åº”ç”¨çš„æ‰€æœ‰ Liquibase æ•°æ®åº“è¿ç§»ï¼Œéœ€è¦ä¸€ä¸ªæˆ–å¤šä¸ª Liquibase ç»„ä»¶ metrics æ˜¾ç¤ºå½“å‰åº”ç”¨ç¨‹åºçš„æŒ‡æ ‡ä¿¡æ¯ã€‚ mappings æ˜¾ç¤ºæ‰€æœ‰ @RequestMapping è·¯å¾„åˆ—è¡¨ scheduledtasks æ˜¾ç¤ºåº”ç”¨ç¨‹åºä¸­çš„è®¡åˆ’ä»»åŠ¡ sessions å…è®¸ä» Spring Session æ”¯æŒçš„ä¼šè¯å­˜å‚¨ä¸­æ£€ç´¢å’Œåˆ é™¤ç”¨æˆ·ä¼šè¯ï¼Œéœ€è¦ä½¿ç”¨ Spring Session çš„åŸºäº Servlet çš„ Web åº”ç”¨ç¨‹åº shutdown ä½¿åº”ç”¨ç¨‹åºæ­£å¸¸å…³é—­ï¼Œé»˜è®¤ç¦ç”¨ startup æ˜¾ç¤ºç”± ApplicationStartup æ”¶é›†çš„å¯åŠ¨æ­¥éª¤æ•°æ®ã€‚éœ€è¦ä½¿ç”¨ SpringApplication è¿›è¡Œé…ç½® BufferingApplicationStartup threaddump æ‰§è¡Œçº¿ç¨‹è½¬å‚¨ åº”ç”¨ç¨‹åºæ˜¯ Web åº”ç”¨ç¨‹åºï¼ˆSpring MVCï¼ŒSpring WebFlux æˆ– Jerseyï¼‰ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä»¥ä¸‹é™„åŠ ç«¯ç‚¹ï¼š ID æè¿° heapdump è¿”å› hprof å †è½¬å‚¨æ–‡ä»¶ã€‚ jolokia é€šè¿‡ HTTP æš´éœ² JMX beanï¼ˆéœ€è¦å¼•å…¥ Jolokiaï¼Œä¸é€‚ç”¨äº WebFluxï¼‰ï¼Œéœ€è¦å¼•å…¥ä¾èµ– jolokia-core logfile è¿”å›æ—¥å¿—æ–‡ä»¶çš„å†…å®¹ï¼ˆå¦‚æœå·²è®¾ç½® logging.file.name æˆ– logging.file.path å±æ€§ï¼‰ï¼Œæ”¯æŒä½¿ç”¨ HTTP Rangeæ ‡å¤´æ¥æ£€ç´¢éƒ¨åˆ†æ—¥å¿—æ–‡ä»¶çš„å†…å®¹ã€‚ prometheus ä»¥ Prometheus æœåŠ¡å™¨å¯ä»¥æŠ“å–çš„æ ¼å¼å…¬å¼€æŒ‡æ ‡ï¼Œéœ€è¦ä¾èµ– micrometer-registry-prometheus å¸¸ç”¨ Endpointï¼š Healthï¼šç›‘æ§çŠ¶å†µ Metricsï¼šè¿è¡Œæ—¶æŒ‡æ ‡ Loggersï¼šæ—¥å¿—è®°å½• é¡¹ç›®éƒ¨ç½²SpringBoot é¡¹ç›®å¼€å‘å®Œæ¯•åï¼Œæ”¯æŒä¸¤ç§æ–¹å¼éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼š jar åŒ… (å®˜æ–¹æ¨èï¼Œé»˜è®¤) war åŒ… æ›´æ”¹ pom æ–‡ä»¶ä¸­çš„æ‰“åŒ…æ–¹å¼ä¸º war ä¿®æ”¹å¯åŠ¨ç±» 1234567891011@SpringBootApplicationpublic class SpringbootDeployApplication extends SpringBootServletInitializer &#123; public static void main(String[] args) &#123; SpringApplication.run(SpringbootDeployApplication.class, args); &#125; @Override protected SpringApplicationBuilder configure(SpringApplicationBuilder b) &#123; return b.sources(SpringbootDeployApplication.class); &#125;&#125; æŒ‡å®šæ‰“åŒ…çš„åç§° 12345678910&lt;packaging&gt;war&lt;/packaging&gt;&lt;build&gt; &lt;finalName&gt;springboot&lt;/finalName&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt; &lt;/plugin&gt; &lt;/plugins&gt;&lt;/build&gt; CloudåŸºæœ¬ä»‹ç»SpringCloud æ˜¯åˆ†å¸ƒå¼å¾®æœåŠ¡çš„ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆï¼Œæ˜¯å¤šç§å¾®æœåŠ¡è½åœ°æŠ€æœ¯çš„é›†åˆä½“ï¼Œä¿—ç§°å¾®æœåŠ¡å…¨å®¶æ¡¶ å‚è€ƒæ–‡æ¡£ï¼šhttps://www.yuque.com/mrlinxi/pxvr4g/wcwd39 æœåŠ¡æ³¨å†ŒEurekaåŸºæœ¬ä»‹ç»Spring Cloud å°è£…äº† Netflix å…¬å¸å¼€å‘çš„ Eureka æ¨¡å—æ¥å®ç°æœåŠ¡æ²»ç†ã€‚Eureka é‡‡ç”¨äº† CS(Client-Server) çš„è®¾è®¡æ¶æ„ï¼ŒEureka Server æ˜¯æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œç³»ç»Ÿä¸­çš„å…¶ä»–å¾®æœåŠ¡ä½¿ç”¨ Eureka çš„å®¢æˆ·ç«¯è¿æ¥åˆ° Eureka Server å¹¶ç»´æŒå¿ƒè·³è¿æ¥ Eureka Server æä¾›æœåŠ¡æ³¨å†ŒæœåŠ¡ï¼šå„ä¸ªå¾®æœåŠ¡èŠ‚ç‚¹é€šè¿‡é…ç½®å¯åŠ¨åï¼Œä¼šåœ¨ EurekaServer ä¸­è¿›è¡Œæ³¨å†Œï¼ŒEurekaServer ä¸­çš„æœåŠ¡æ³¨å†Œè¡¨ä¸­å°†ä¼šå­˜å‚¨æ‰€æœ‰å¯ç”¨æœåŠ¡èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œå¹¶ä¸”å…·æœ‰å¯è§†åŒ–ç•Œé¢ Eureka Client é€šè¿‡æ³¨å†Œä¸­å¿ƒè¿›è¡Œè®¿é—®ï¼šç”¨äºç®€åŒ– Eureka Serverçš„äº¤äº’ï¼Œå®¢æˆ·ç«¯ä¹Ÿå…·å¤‡ä¸€ä¸ªå†…ç½®çš„ã€ä½¿ç”¨è½®è¯¢ (round-robin) è´Ÿè½½ç®—æ³•çš„è´Ÿè½½å‡è¡¡å™¨ã€‚åœ¨åº”ç”¨å¯åŠ¨åå°†ä¼šå‘ Eureka Server å‘é€å¿ƒè·³ï¼ˆé»˜è®¤å‘¨æœŸä¸º30ç§’ï¼‰ï¼Œå¦‚æœ Eureka Server åœ¨å¤šä¸ªå¿ƒè·³å‘¨æœŸå†…æ²¡æœ‰æ¥æ”¶åˆ°æŸä¸ªèŠ‚ç‚¹çš„å¿ƒè·³ï¼Œå°†ä¼šä»æœåŠ¡æ³¨å†Œè¡¨ä¸­æŠŠè¿™ä¸ªæœåŠ¡èŠ‚ç‚¹ç§»é™¤ï¼ˆé»˜è®¤ 90 ç§’ï¼‰ æœåŠ¡ç«¯æœåŠ¡å™¨ç«¯ä¸»å¯åŠ¨ç±»å¢åŠ  @EnableEurekaServer æ³¨è§£ï¼ŒæŒ‡å®šè¯¥æ¨¡å—ä½œä¸º Eureka æ³¨å†Œä¸­å¿ƒçš„æœåŠ¡å™¨ æ„å»ºæµç¨‹å¦‚ä¸‹ï¼š ä¸»å¯åŠ¨ç±» 1234567@SpringBootApplication@EnableEurekaServer // è¡¨ç¤ºå½“å‰æ˜¯Eurekaçš„æœåŠ¡æ³¨å†Œä¸­å¿ƒpublic class EurekaMain7001 &#123; public static void main(String[] args) &#123; SpringApplication.run(EurekaMain7001.class, args); &#125;&#125; ä¿®æ”¹ pom æ–‡ä»¶ 12345678910111213141.x: serverè·Ÿclientåˆåœ¨ä¸€èµ·&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-eureka&lt;/artifactId&gt;&lt;/dependency&gt;2.xï¼š serverè·Ÿclientåˆ†å¼€&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-server&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;&lt;/dependency&gt; ä¿®æ”¹ application.yml æ–‡ä»¶ 1234567891011121314server: port: 7001eureka: instance: hostname: localhost # eurekaæœåŠ¡ç«¯çš„å®ä¾‹åç§° client: # falseè¡¨ç¤ºä¸å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œè‡ªå·±ã€‚ register-with-eureka: false # falseè¡¨ç¤ºè‡ªå·±ç«¯å°±æ˜¯æ³¨å†Œä¸­å¿ƒï¼ŒèŒè´£å°±æ˜¯ç»´æŠ¤æœåŠ¡å®ä¾‹ï¼Œå¹¶ä¸éœ€è¦å»æ£€ç´¢æœåŠ¡ fetch-registry: false service-url: # è®¾ç½®ä¸ Eureka Server äº¤äº’çš„åœ°å€æŸ¥è¯¢æœåŠ¡å’Œæ³¨å†ŒæœåŠ¡éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªåœ°å€ã€‚ defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/ æ¸¸è§ˆå™¨è®¿é—® http://localhost:7001 å®¢æˆ·ç«¯ç”Ÿäº§è€…æœåŠ¡å™¨ç«¯ä¸»å¯åŠ¨ç±»éœ€è¦å¢åŠ  @EnableEurekaClient æ³¨è§£ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª Eureka å®¢æˆ·ç«¯ï¼Œè¦æ³¨å†Œè¿› EurekaServer ä¸­ ä¸»å¯åŠ¨ç±»ï¼šPaymentMain8001 1234567@SpringBootApplication@EnableEurekaClientpublic class PaymentMain8001 &#123; public static void main(String[] args) &#123; SpringApplication.run(PaymentMain8001.class, args); &#125;&#125; ä¿®æ”¹ pom æ–‡ä»¶ï¼šæ·»åŠ ä¸€ä¸ª Eureka-Client ä¾èµ– 1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;&lt;/dependency&gt; å†™ yml æ–‡ä»¶ 1234567891011121314server: port: 8001 eureka: client: # è¡¨ç¤ºå°†è‡ªå·±æ³¨å†Œè¿›EurekaServeré»˜è®¤ä¸ºtrue register-with-eureka: true # è¡¨ç¤ºå¯ä»¥ä»EurekaæŠ“å–å·²æœ‰çš„æ³¨å†Œä¿¡æ¯ï¼Œé»˜è®¤ä¸ºtrueã€‚å•èŠ‚ç‚¹æ— æ‰€è°“ï¼Œé›†ç¾¤å¿…é¡»è®¾ç½®ä¸ºtrueæ‰èƒ½é…åˆribbonä½¿ç”¨è´Ÿè½½å‡è¡¡ fetch-registry: true service-url: defaultZone: http://localhost:7001/eureka instance: instance-id: payment8001 # åªæš´éœ²æœåŠ¡åï¼Œä¸å¸¦æœ‰ä¸»æœºå prefer-ip-address: true # è®¿é—®ä¿¡æ¯æœ‰ IP ä¿¡æ¯æç¤º(é¼ æ ‡åœç•™åœ¨æœåŠ¡åç§°ä¸Šæ—¶) æ¸¸è§ˆå™¨è®¿é—® http://localhost:7001 æ¶ˆè´¹è€… ä¸»å¯åŠ¨ç±»ï¼šPaymentMain8001 12345678@SpringBootApplication@EnableEurekaClient@EnableDiscoveryClientpublic class PaymentMain8001 &#123; public static void main(String[] args) &#123; SpringApplication.run(PaymentMain8001.class, args); &#125;&#125; pom æ–‡ä»¶åŒç”Ÿäº§è€… å†™ yml æ–‡ä»¶ 12345678910111213server: port: 80# å¾®æœåŠ¡åç§°spring: application: name: cloud-order-serviceeureka: client: register-with-eureka: true fetch-registry: true service-url: defaultZone: http://localhost:7001/eureka æµè§ˆå™¨è®¿é—® http://localhost:7001 é›†ç¾¤æ„å»ºæœåŠ¡ç«¯Server ç«¯é«˜å¯ç”¨é›†ç¾¤åŸç†ï¼šå®ç°è´Ÿè½½å‡è¡¡å’Œæ•…éšœå®¹é”™ï¼Œäº’ç›¸æ³¨å†Œï¼Œç›¸äº’å®ˆæœ› å¤šå° Eureka æœåŠ¡å™¨ï¼Œæ¯ä¸€å° Eureka æœåŠ¡å™¨éœ€è¦æœ‰è‡ªå·±çš„ä¸»æœºåï¼ŒåŒæ—¶å„æœåŠ¡å™¨éœ€è¦ç›¸äº’æ³¨å†Œ Eureka1ï¼š 1234567891011121314151617server: port: 7001eureka: instance: hostname: eureka7001.com client: register-with-eureka: false fetch-registry: false service-url: # è®¾ç½®ä¸Eureka Serveräº¤äº’çš„åœ°å€æŸ¥è¯¢æœåŠ¡å’Œæ³¨å†ŒæœåŠ¡éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªåœ°å€ã€‚ # å•æœºå°±æ˜¯è‡ªå·± # defaultZone: http://eureka7001.com:7001/eureka/ # é›†ç¾¤æŒ‡å‘å…¶ä»–eureka #defaultZone: http://eureka7002.com:7002/eureka/ # å†™æˆè¿™æ ·å¯ä»¥ç›´æ¥é€šè¿‡å¯è§†åŒ–é¡µé¢è·³è½¬åˆ°7002 defaultZone: http://eureka7002.com:7002/ Eureka2ï¼š 123456789101112server: port: 7002eureka: instance: hostname: eureka7002.com client: register-with-eureka: false fetch-registry: false service-url: #å†™æˆè¿™æ ·å¯ä»¥ç›´æ¥é€šè¿‡å¯è§†åŒ–é¡µé¢è·³è½¬åˆ°7001 defaultZone: http://eureka7001.com:7001/ ä¸»å¯åŠ¨ç±»ï¼š 1234567@SpringBootApplication@EnableEurekaServerpublic class EurekaMain7002 &#123; public static void main(String[] args) &#123; SpringApplication.run(EurekaMain7002.class, args); &#125;&#125; è®¿é—® http://eureka7001.com:7001 å’Œ http://eureka7002.com:7002ï¼š RPC è°ƒç”¨ï¼šcontroller.OrderController 123456789101112131415@RestController@Slf4jpublic class OrderController &#123; public static final String PAYMENT_URL = &quot;http://localhost:8001&quot;; @Autowired private RestTemplate restTemplate; // CommonResult æ˜¯ä¸€ä¸ªå…¬å…±çš„è¿”å›ç±»å‹ @GetMapping(&quot;/consumer/payment/get/&#123;id&#125;&quot;) public CommonResult&lt;Payment&gt; getPayment(@PathVariable(&quot;id&quot;) long id) &#123; // è¿”å›å¯¹è±¡ä¸ºå“åº”ä½“ä¸­æ•°æ®è½¬åŒ–æˆçš„å¯¹è±¡ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥ç†è§£ä¸ºJSON return restTemplate.getForObject(PAYMENT_URL + &quot;/payment/get/&quot; + id, CommonResult.class); &#125;&#125; ç”Ÿäº§è€…æ„å»º PaymentMain8001 çš„æœåŠ¡é›†ç¾¤ ä¸»å¯åŠ¨ç±» 12345678@SpringBootApplication@EnableEurekaClient@EnableDiscoveryClientpublic class PaymentMain8002 &#123; public static void main(String[] args) &#123; SpringApplication.run(PaymentMain8002.class, args); &#125;&#125; å†™ yml æ–‡ä»¶ï¼šç«¯å£ä¿®æ”¹ï¼Œå¹¶ä¸” spring.application.name å‡ä¸º cloud-payment-service 123456789101112131415server: port: 8002spring: application: name: cloud-payment-service eureka: client: # è¡¨ç¤ºå°†è‡ªå·±æ³¨å†Œè¿›EurekaServeré»˜è®¤ä¸ºtrue register-with-eureka: true # è¡¨ç¤ºå¯ä»¥ä»EurekaæŠ“å–å·²æœ‰çš„æ³¨å†Œä¿¡æ¯ï¼Œé»˜è®¤ä¸ºtrueã€‚å•èŠ‚ç‚¹æ— æ‰€è°“ï¼Œé›†ç¾¤å¿…é¡»è®¾ç½®ä¸ºtrueæ‰èƒ½é…åˆribbonä½¿ç”¨è´Ÿè½½å‡è¡¡ fetch-registry: true service-url: defaultZone: http://localhost:7001/eureka è´Ÿè½½å‡è¡¡æ¶ˆè´¹è€…ç«¯çš„ Controller 12// public static final String PAYMENT_URL = &quot;http://localhost:8001&quot;;public static final String PAYMENT_URL = &quot;http://localhost:8002&quot;; ç”±äºå·²ç»å»ºç«‹äº†ç”Ÿäº§è€…é›†ç¾¤ï¼Œæ‰€ä»¥å¯ä»¥è¿›è¡Œè´Ÿè½½å‡è¡¡çš„æ“ä½œï¼š Controllerï¼šåªä¿®æ”¹ PAYMENT_URL ä¼šæŠ¥é”™ï¼Œå› ä¸º CLOUD-PAYMENT-SERVICE å¯¹åº”å¤šä¸ªå¾®æœåŠ¡ï¼Œéœ€è¦è§„åˆ™æ¥åˆ¤æ–­è°ƒç”¨å“ªä¸ªç«¯å£ 1public static final String PAYMENT_URL = &quot;http://CLOUD-PAYMENT-SERVICE&quot;; ä½¿ç”¨ @LoadBlanced æ³¨è§£èµ‹äºˆ RestTemplate è´Ÿè½½å‡è¡¡çš„èƒ½åŠ›ï¼Œå¢åŠ  config.ApplicationContextConfig æ–‡ä»¶ï¼š 12345678@Configurationpublic class ApplicationContextConfig &#123; @Bean @LoadBalanced public RestTemplate getRestTemplate() &#123; return new RestTemplate(); &#125;&#125; æœåŠ¡å‘ç°æœåŠ¡å‘ç°ï¼šå¯¹äºæ³¨å†Œè¿› Eureka é‡Œé¢çš„å¾®æœåŠ¡ï¼Œå¯ä»¥é€šè¿‡æœåŠ¡å‘ç°æ¥è·å¾—è¯¥æœåŠ¡çš„ä¿¡æ¯ ä¸»å¯åŠ¨ç±»å¢åŠ æ³¨è§£ @EnableDiscoveryClientï¼š 12345678@SpringBootApplication@EnableEurekaClient@EnableDiscoveryClientpublic class PaymentMain8001 &#123; public static void main(String[] args) &#123; SpringApplication.run(PaymentMain8001.class, args); &#125;&#125; ä¿®æ”¹ç”Ÿäº§è€…çš„ Controller 1234567891011121314151617181920@RestController@Slf4jpublic class PaymentController &#123; @Autowired private DiscoveryClient discoveryClient; @GetMapping(value = &quot;/payment/discovery&quot;) public Object discovery() &#123; List&lt;String&gt; services = discoveryClient.getServices(); for (String service : services) &#123; log.info(&quot;**** element:&quot; + service); &#125; List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(&quot;PAYMENT-SERVICE&quot;); for (ServiceInstance instance : instances) &#123; log.info(instance.getServiceId() + &quot;\\t&quot; + instance.getHost() + &quot;\\t&quot; + instance.getPort()); &#125; return this.discoveryClient; &#125;&#125; è‡ªæˆ‘ä¿æŠ¤ä¿æŠ¤æ¨¡å¼ç”¨äºå®¢æˆ·ç«¯å’Œ EurekaServer ä¹‹é—´å­˜åœ¨ç½‘ç»œåˆ†åŒºåœºæ™¯ä¸‹çš„ä¿æŠ¤ï¼Œä¸€æ—¦è¿›å…¥ä¿æŠ¤æ¨¡å¼ EurekaServer å°†ä¼šå°è¯•ä¿æŠ¤å…¶æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„ä¿¡æ¯ï¼Œä¸åœ¨åˆ é™¤æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„æ•°æ®ï¼Œå±äº CAP é‡Œé¢çš„ AP æ€æƒ³ï¼ˆå¯ç”¨æ€§å’Œåˆ†åŒºå®¹é”™æ€§ï¼‰ å¦‚æœä¸€å®šæ—¶é—´å†…ä¸¢å¤±å¤§é‡è¯¥å¾®æœåŠ¡çš„å®ä¾‹ï¼Œè¿™æ—¶ Eureka å°±ä¼šå¼€å¯è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ï¼Œä¸ä¼šå‰”é™¤è¯¥æœåŠ¡ã€‚ å› ä¸ºè¿™ä¸ªç°è±¡å¯èƒ½æ˜¯å› ä¸ºç½‘ç»œæš‚æ—¶ä¸é€šï¼Œå‡ºç°äº† Eureka çš„å‡æ­»ã€æ‹¥å µã€å¡é¡¿ï¼Œå®¢æˆ·ç«¯æ¢å¤åè¿˜èƒ½æ­£å¸¸å‘é€å¿ƒè·³ ç¦æ­¢è‡ªæˆ‘ä¿æŠ¤ï¼š Serverï¼š 12345eureka: server: # å…³é—­è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ï¼Œä¸å¯ç”¨çš„æœåŠ¡ç›´æ¥åˆ é™¤ enable-self-preservation: false eviction-interval-timer-in-ms: 2000 Clientï¼š 123456eureka: instance: # Eurekaå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€å¿ƒè·³çš„æ—¶é—´é—´éš”é»˜è®¤30ç§’ lease-renewal-interval-in-seconds: 1 # EurekaæœåŠ¡ç«¯åœ¨æ”¶åˆ°æœ€åä¸€æ¬¡å¿ƒè·³åï¼Œ90sæ²¡æœ‰æ”¶åˆ°å¿ƒè·³ï¼Œå‰”é™¤æœåŠ¡ lease-expiration-duration-in-seconds: 2 ConsulåŸºæœ¬ä»‹ç»Consul æ˜¯å¼€æºçš„åˆ†å¸ƒå¼æœåŠ¡å‘ç°å’Œé…ç½®ç®¡ç†ç³»ç»Ÿï¼Œé‡‡ç”¨ Go è¯­è¨€å¼€å‘ï¼Œå®˜ç½‘ï¼šhttps://developer.hashicorp.com/consul æä¾›äº†å¾®æœåŠ¡ç³»ç»Ÿä¸­å¿ƒçš„æœåŠ¡æ²»ç†ï¼Œé…ç½®ä¸­å¿ƒï¼Œæ§åˆ¶æ€»çº¿ç­‰åŠŸèƒ½ åŸºäº Raft åè®®ï¼Œæ”¯æŒå¥åº·æ£€æŸ¥ï¼ŒåŒæ—¶æ”¯æŒ HTTP å’Œ DNS åè®®æ”¯æŒè·¨æ•°æ®ä¸­å¿ƒçš„ WAN é›†ç¾¤ æä¾›å›¾å½¢ç•Œé¢ ä¸‹è½½ Consul åï¼Œè¿è¡ŒæŒ‡ä»¤ï¼šconsul -version 12345D:\\Program Files\\Java&gt;consul -versionConsul v1.15.1Revision 7c04b6a0Build Date 2023-03-07T20:35:33ZProtocol 2 spoken by default, understands 2 to 3 (.....) å¯åŠ¨å‘½ä»¤ï¼š 1consul agent -dev è®¿é—®æµè§ˆå™¨ï¼šhttp://localhost:8500/ ä¸­æ–‡æ–‡æ¡£ï¼šhttps://www.springcloud.cc/spring-cloud-consul.html åŸºæœ¬ä½¿ç”¨æ— éœ€ Server ç«¯ä»£ç çš„ç¼–å†™ ç”Ÿäº§è€…ï¼š å¼•å…¥ pom ä¾èµ–ï¼š 1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-consul-discovery&lt;/artifactId&gt;&lt;/dependency&gt; application.ymlï¼š 1234567891011121314###consul æœåŠ¡ç«¯å£å·server: port: 8006spring: application: name: consul-provider-payment ####consulæ³¨å†Œä¸­å¿ƒåœ°å€ cloud: consul: host: localhost port: 8500 discovery: service-name: $&#123;spring.application.name&#125; ä¸»å¯åŠ¨ç±»ï¼š 1234567@SpringBootApplication@EnableDiscoveryClientpublic class PaymentMain8006 &#123; public static void main(String[] args) &#123; SpringApplication.run(PaymentMain8006.class, args); &#125;&#125; æ¶ˆè´¹è€…ï¼š application.ymlï¼š 123456789101112131415###consulæœåŠ¡ç«¯å£å·server: port: 80spring: application: name: cloud-consumer-order ####consulæ³¨å†Œä¸­å¿ƒåœ°å€ cloud: consul: host: localhost port: 8500 discovery: #hostname: 127.0.0.1 service-name: $&#123;spring.application.name&#125; ä¸»å¯åŠ¨ç±»ï¼šåŒç”Ÿäº§è€… é…ç½®ç±»ï¼š 12345678@Configurationpublic class ApplicationContextConfig &#123; @Bean @LoadBalanced public RestTemplate getRestTemplate() &#123; return new RestTemplate(); &#125;&#125; ä¸šåŠ¡ç±» Controllerï¼š 12345678910111213@RestController@Slf4jpublic class OrderConsulController &#123; public static final String INVOKE_URL = &quot;http://cloud-provider-pament&quot;; @Resource private RestTemplate restTemplate; @GetMapping(&quot;/consumer/payment/consul&quot;) public String paymentInfo() &#123; return restTemplate.getForObject(INVOKE_URL, String.class); &#125;&#125; æœåŠ¡è°ƒç”¨RibbonåŸºæœ¬ä»‹ç»SpringCloud Ribbon æ˜¯åŸºäº Netflix Ribbon å®ç°çš„ä¸€å¥—è´Ÿè½½å‡è¡¡å·¥å…·ï¼Œæä¾›å®¢æˆ·ç«¯çš„è½¯ä»¶è´Ÿè½½å‡è¡¡ç®—æ³•å’ŒæœåŠ¡è°ƒç”¨ï¼ŒRibbon å®¢æˆ·ç«¯ç»„ä»¶æä¾›ä¸€ç³»åˆ—å®Œå–„çš„é…ç½®é¡¹å¦‚è¿æ¥è¶…æ—¶ï¼Œé‡è¯•ç­‰ å®˜ç½‘ï¼š https://github.com/Netflix/ribbon/wiki/Getting-Started ï¼ˆå·²è¿›å…¥ç»´æŠ¤æ¨¡å¼ï¼Œæœªæ¥æ›¿æ¢ä¸º Load Banlancerï¼‰ è´Ÿè½½å‡è¡¡ Load Balance (LB) å°±æ˜¯å°†ç”¨æˆ·çš„è¯·æ±‚å¹³æ‘Šçš„åˆ†é…åˆ°å¤šä¸ªæœåŠ¡ä¸Šï¼Œä»è€Œè¾¾åˆ°ç³»ç»Ÿçš„ HAï¼ˆé«˜å¯ç”¨ï¼‰ å¸¸è§çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼š è½®è¯¢ï¼šä¸ºè¯·æ±‚é€‰æ‹©å¥åº·æ± ä¸­çš„ç¬¬ä¸€ä¸ªåç«¯æœåŠ¡å™¨ï¼Œç„¶åæŒ‰é¡ºåºå¾€åä¾æ¬¡é€‰æ‹© æœ€å°è¿æ¥ï¼šä¼˜å…ˆé€‰æ‹©è¿æ¥æ•°æœ€å°‘ï¼Œå³å‹åŠ›æœ€å°çš„åç«¯æœåŠ¡å™¨ï¼Œåœ¨ä¼šè¯è¾ƒé•¿çš„æƒ…å†µä¸‹å¯ä»¥é‡‡å–è¿™ç§æ–¹å¼ æ•£åˆ—ï¼šæ ¹æ®è¯·æ±‚æºçš„ IP çš„æ•£åˆ—ï¼ˆhashï¼‰æ¥é€‰æ‹©è¦è½¬å‘çš„æœåŠ¡å™¨ï¼Œå¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šä¿è¯ç‰¹å®šç”¨æˆ·èƒ½è¿æ¥åˆ°ç›¸åŒçš„æœåŠ¡å™¨ï¼Œå¦‚æœåº”ç”¨éœ€è¦å¤„ç†çŠ¶æ€è€Œè¦æ±‚ç”¨æˆ·èƒ½è¿æ¥åˆ°å’Œä¹‹å‰ç›¸åŒçš„æœåŠ¡å™¨ï¼Œå¯ä»¥é‡‡å–è¿™ç§æ–¹å¼ Ribbon æœ¬åœ°è´Ÿè½½å‡è¡¡å®¢æˆ·ç«¯ä¸ Nginx æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡åŒºåˆ«ï¼š Nginx æ˜¯æœåŠ¡å™¨è´Ÿè½½å‡è¡¡ï¼Œå®¢æˆ·ç«¯æ‰€æœ‰è¯·æ±‚éƒ½ä¼šäº¤ç»™ Nginxï¼Œç„¶åç”± Nginx å®ç°è½¬å‘è¯·æ±‚ï¼Œå³è´Ÿè½½å‡è¡¡æ˜¯ç”±æœåŠ¡ç«¯å®ç°çš„ Ribbon æœ¬åœ°è´Ÿè½½å‡è¡¡ï¼Œåœ¨è°ƒç”¨å¾®æœåŠ¡æ¥å£æ—¶ä¼šåœ¨æ³¨å†Œä¸­å¿ƒä¸Šè·å–æ³¨å†Œä¿¡æ¯æœåŠ¡åˆ—è¡¨ï¼Œç„¶åç¼“å­˜åˆ° JVM æœ¬åœ°ï¼Œä»è€Œåœ¨æœ¬åœ°å®ç° RPC è¿œç¨‹æœåŠ¡è°ƒç”¨æŠ€æœ¯ é›†ä¸­å¼ LB å’Œè¿›ç¨‹å†… LB çš„å¯¹æ¯”ï¼š é›†ä¸­å¼ LBï¼šåœ¨æœåŠ¡çš„æ¶ˆè´¹æ–¹å’Œæä¾›æ–¹ä¹‹é—´ä½¿ç”¨ç‹¬ç«‹çš„ LB è®¾æ–½ï¼ˆå¦‚ Nginxï¼‰ï¼Œç”±è¯¥è®¾æ–½æŠŠè®¿é—®è¯·æ±‚é€šè¿‡æŸç§ç­–ç•¥è½¬å‘è‡³æœåŠ¡çš„æä¾›æ–¹ è¿›ç¨‹å†… LBï¼šå°† LB é€»è¾‘é›†æˆåˆ°æ¶ˆè´¹æ–¹ï¼Œæ¶ˆè´¹æ–¹ä»æœåŠ¡æ³¨å†Œä¸­å¿ƒè·çŸ¥æœ‰å“ªäº›æœåŠ¡å¯ç”¨ï¼Œç„¶åä»ä¸­é€‰æ‹©å‡ºä¸€ä¸ªæœåŠ¡å™¨ï¼ŒRibbon å±äºè¯¥ç±» å·¥ä½œæµç¨‹Ribbon æ˜¯ä¸€ä¸ªè½¯è´Ÿè½½å‡è¡¡çš„å®¢æˆ·ç«¯ç»„ä»¶ ç¬¬ä¸€æ­¥å…ˆé€‰æ‹© EurekaServerï¼Œä¼˜å…ˆé€‰æ‹©åœ¨åŒä¸€ä¸ªåŒºåŸŸå†…è´Ÿè½½è¾ƒå°‘çš„ Server ç¬¬äºŒæ­¥æ ¹æ®ç”¨æˆ·æŒ‡å®šçš„ç­–ç•¥ï¼Œå†ä» Server å–åˆ°çš„æœåŠ¡æ³¨å†Œåˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªåœ°å€ æ ¸å¿ƒç»„ä»¶Ribbon æ ¸å¿ƒç»„ä»¶ IRule æ¥å£ï¼Œä¸»è¦å®ç°ç±»ï¼š RoundRobinRuleï¼šè½®è¯¢ RandomRuleï¼šéšæœº RetryRuleï¼šå…ˆæŒ‰ç…§ RoundRobinRule çš„ç­–ç•¥è·å–æœåŠ¡ï¼Œå¦‚æœè·å–æœåŠ¡å¤±è´¥åˆ™åœ¨æŒ‡å®šæ—¶é—´å†…ä¼šè¿›è¡Œé‡è¯• WeightedResponseTimeRuleï¼šå¯¹ RoundRobinRule çš„æ‰©å±•ï¼Œå“åº”é€Ÿåº¦è¶Šå¿«çš„å®ä¾‹é€‰æ‹©æƒé‡è¶Šå¤§ï¼Œè¶Šå®¹æ˜“è¢«é€‰æ‹© BestAvailableRuleï¼šä¼šå…ˆè¿‡æ»¤æ‰ç”±äºå¤šæ¬¡è®¿é—®æ•…éšœè€Œå¤„äºæ–­è·¯å™¨è·³é—¸çŠ¶æ€çš„æœåŠ¡ï¼Œç„¶åé€‰æ‹©ä¸€ä¸ªå¹¶å‘é‡æœ€å°çš„æœåŠ¡ AvailabilityFilteringRuleï¼šå…ˆè¿‡æ»¤æ‰æ•…éšœå®ä¾‹ï¼Œå†é€‰æ‹©å¹¶å‘è¾ƒå°çš„å®ä¾‹ ZoneAvoidanceRuleï¼šé»˜è®¤è§„åˆ™ï¼Œå¤åˆåˆ¤æ–­ Server æ‰€åœ¨åŒºåŸŸçš„æ€§èƒ½å’Œ Server çš„å¯ç”¨æ€§é€‰æ‹©æœåŠ¡å™¨ æ³¨æ„ï¼šå®˜æ–¹æ–‡æ¡£æ˜ç¡®ç»™å‡ºäº†è­¦å‘Šï¼Œè‡ªå®šä¹‰è´Ÿè½½å‡è¡¡é…ç½®ç±»ä¸èƒ½æ”¾åœ¨ @ComponentScan æ‰€æ‰«æçš„å½“å‰åŒ…ä¸‹ä»¥åŠå­åŒ…ä¸‹ æ›´æ¢è´Ÿè½½å‡è¡¡ç®—æ³•æ–¹å¼ï¼š è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡é…ç½®ç±» MySelfRuleï¼š 1234567@Configurationpublic class MySelfRule &#123; @Bean public IRule myRule() &#123; return new RandomRule();//å®šä¹‰ä¸ºéšæœºè´Ÿè½½å‡è¡¡ç®—æ³• &#125;&#125; ä¸»å¯åŠ¨ç±»æ·»åŠ  @RibbonCilent æ³¨è§£ 123456789@SpringBootApplication@EnableEurekaClient// æŒ‡æ˜è®¿é—®çš„æœåŠ¡CLOUD-PAYMENT-SERVICEï¼Œä»¥åŠæŒ‡å®šè´Ÿè½½å‡è¡¡ç­–ç•¥@RibbonClient(name = &quot;CLOUD-PAYMENT-SERVICE&quot;, configuration= MySelfRule.class)public class OrderMain80 &#123; public static void main(String[] args) &#123; SpringApplication.run(OrderMain80.class, args); &#125;&#125; OpenFeignåŸºæœ¬ä»‹ç»Feign æ˜¯ä¸€ä¸ªå£°æ˜å¼ WebService å®¢æˆ·ç«¯ï¼Œèƒ½è®©ç¼–å†™ Web å®¢æˆ·ç«¯æ›´åŠ ç®€å•ï¼Œåªè¦åˆ›å»ºä¸€ä¸ªæ¥å£å¹¶æ·»åŠ æ³¨è§£ @Feign å³å¯ï¼Œå¯ä»¥ä¸ Eureka å’Œ Ribbon ç»„åˆä½¿ç”¨æ”¯æŒè´Ÿè½½å‡è¡¡ï¼Œæ‰€ä»¥ä¸€èˆ¬ç”¨åœ¨æ¶ˆè´¹è€…ç«¯ OpenFeign åœ¨ Feign çš„åŸºç¡€ä¸Šæ”¯æŒäº† SpringMVC æ³¨è§£ï¼Œå¹¶ä¸” @FeignClient æ³¨è§£å¯ä»¥è§£æ @RequestMapping æ³¨è§£ä¸‹çš„æ¥å£ï¼Œå¹¶é€šè¿‡åŠ¨æ€ä»£ç†çš„æ–¹å¼äº§ç”Ÿå®ç°ç±»ï¼Œåœ¨å®ç°ç±»ä¸­åšè´Ÿè½½å‡è¡¡å’ŒæœåŠ¡è°ƒç”¨ ä¼˜ç‚¹ï¼šåˆ©ç”¨ RestTemplate å¯¹ HTTP è¯·æ±‚çš„å°è£…å¤„ç†ï¼Œå½¢æˆäº†ä¸€å¥—æ¨¡ç‰ˆåŒ–çš„è°ƒç”¨æ–¹æ³•ã€‚ä½†æ˜¯å¯¹æœåŠ¡ä¾èµ–çš„è°ƒç”¨å¯èƒ½ä¸æ­¢ä¸€å¤„ï¼Œå¾€å¾€ä¸€ä¸ªæ¥å£ä¼šè¢«å¤šå¤„è°ƒç”¨ï¼Œæ‰€ä»¥ä¸€ä¸ªå¾®æœåŠ¡æ¥å£ä¸Šé¢æ ‡æ³¨ä¸€ä¸ª @Feign æ³¨è§£ï¼Œå°±å¯ä»¥å®ŒæˆåŒ…è£…ä¾èµ–æœåŠ¡çš„è°ƒç”¨ åŸºæœ¬ä½¿ç”¨@FeignClient(â€œprovider nameâ€) æ³¨è§£ä½¿ç”¨è§„åˆ™ï¼š å£°æ˜çš„æ–¹æ³•ç­¾åå¿…é¡»å’Œ provider å¾®æœåŠ¡ä¸­çš„ controller ä¸­çš„æ–¹æ³•ç­¾åä¸€è‡´ å¦‚æœéœ€è¦ä¼ é€’å‚æ•°ï¼Œé‚£ä¹ˆ @RequestParam ã€@RequestBody ã€@PathVariable ä¹Ÿéœ€è¦åŠ ä¸Š æ”¹é€ æ¶ˆè´¹è€…æœåŠ¡ å¼•å…¥ pom ä¾èµ–ï¼šOpenFeign æ•´åˆäº† Ribbonï¼Œå…·æœ‰è´Ÿè½½å‡è¡¡çš„åŠŸèƒ½ 1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;&lt;/dependency&gt; application.ymlï¼šä¸å°†å…¶æ³¨å†Œåˆ° Eureka ä½œä¸ºå¾®æœåŠ¡ 12345678910server: port: 80eureka: client: # è¡¨ç¤ºä¸å°†å…¶æ³¨å…¥Eurekaä½œä¸ºå¾®æœåŠ¡ï¼Œä¸ä½œä¸ºEureakå®¢æˆ·ç«¯äº†ï¼Œè€Œæ˜¯ä½œä¸ºFeignå®¢æˆ·ç«¯ register-with-eureka: false service-url: # é›†ç¾¤ç‰ˆ defaultZone: http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka ä¸»å¯åŠ¨ç±»ï¼šå¼€å¯ Feign 12345678@SpringBootApplication@EnableFeignClients //ä¸ä½œä¸ºEureakå®¢æˆ·ç«¯äº†ï¼Œè€Œæ˜¯ä½œä¸ºFeignå®¢æˆ·ç«¯public class OrderOpenFeignMain80 &#123; public static void main(String[] args) &#123; SpringApplication.run(OrderOpenFeignMain80.class, args); &#125;&#125; æ–°å»º Service æ¥å£ï¼šPaymentFeignService æ¥å£å’Œ @FeignClient æ³¨è§£ï¼Œå®Œæˆ Feign çš„åŒ…è£…è°ƒç”¨ 123456789@Component@FeignClient(value = &quot;CLOUD-PAYMENT-SERVICE&quot;) // ä½œä¸ºä¸€ä¸ªFeignåŠŸèƒ½ç»‘å®šçš„çš„æ¥å£public interface PaymentFeignService &#123; @GetMapping(value = &quot;/payment/get/&#123;id&#125;&quot;) public CommonResult&lt;Payment&gt; getPaymentById(@PathVariable(&quot;id&quot;) long id); @GetMapping(&quot;/payment/feign/timeout&quot;) public String paymentFeignTimeout();&#125; Controllerï¼š 12345678910111213141516171819@RestController@Slf4jpublic class OrderFeignController &#123; @Autowired private PaymentFeignService paymentFeignService; @GetMapping(&quot;/consumer/payment/get/&#123;id&#125;&quot;) public CommonResult&lt;Payment&gt; getPayment(@PathVariable(&quot;id&quot;) long id) &#123; // è¿”å›å¯¹è±¡ä¸ºå“åº”ä½“ä¸­æ•°æ®è½¬åŒ–æˆçš„å¯¹è±¡ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥ç†è§£ä¸ºJSON return paymentFeignService.getPaymentById(id); &#125; @GetMapping(&quot;/consumer/payment/feign/timeout&quot;) public String paymentFeignTimeout() &#123; // openfeign-ribbonï¼Œå®¢æˆ·ç«¯ä¸€èˆ¬é»˜è®¤ç­‰å¾…1s return paymentFeignService.paymentFeignTimeout(); &#125;&#125; è¶…æ—¶é—®é¢˜Feign é»˜è®¤æ˜¯æ”¯æŒ Ribbonï¼ŒFeign å®¢æˆ·ç«¯çš„è´Ÿè½½å‡è¡¡å’Œè¶…æ—¶æ§åˆ¶éƒ½ç”± Ribbon æ§åˆ¶ è®¾ç½® Feign å®¢æˆ·ç«¯çš„è¶…æ—¶ç­‰å¾…æ—¶é—´ï¼š 12345ribbon: #æŒ‡çš„æ˜¯å»ºç«‹è¿æ¥åä»æœåŠ¡å™¨è¯»å–åˆ°å¯ç”¨èµ„æºæ‰€ç”¨çš„æ—¶é—´ ReadTimeout: 5000 #æŒ‡çš„æ˜¯å»ºç«‹è¿æ¥æ‰€ç”¨çš„æ—¶é—´ï¼Œé€‚ç”¨äºç½‘ç»œçŠ¶å†µæ­£å¸¸çš„æƒ…å†µä¸‹,ä¸¤ç«¯è¿æ¥æ‰€ç”¨çš„æ—¶é—´ ConnectTimeout: 5000 æ¼”ç¤ºè¶…æ—¶ç°è±¡ï¼šOpenFeign é»˜è®¤ç­‰å¾…æ—¶é—´ä¸º 1 ç§’é’Ÿï¼Œè¶…è¿‡åä¼šæŠ¥é”™ æœåŠ¡æä¾›æ–¹ Controllerï¼š 123456789@GetMapping(&quot;/payment/feign/timeout&quot;)public String paymentFeignTimeout() &#123; try &#123; TimeUnit.SECONDS.sleep(3); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; return serverPort;&#125; æ¶ˆè´¹è€… PaymentFeignService å’Œ OrderFeignController å‚è€ƒä¸Šä¸€å°èŠ‚ä»£ç  æµ‹è¯•æŠ¥é”™ï¼š !](C:\\Users\\Seazean\\Desktop\\123\\Cloud-OpenFeignè¶…æ—¶é”™è¯¯.png) æ—¥å¿—çº§åˆ«Feign æä¾›äº†æ—¥å¿—æ‰“å°åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡é…ç½®æ¥è°ƒæ•´æ—¥å¿—çº§åˆ«ï¼Œä»è€Œäº†è§£ Feign ä¸­ HTTP è¯·æ±‚çš„ç»†èŠ‚ NONE é»˜è®¤çš„ï¼Œä¸æ˜¾ç¤ºä»»ä½•æ—¥å¿— BASIC ä»…è®°å½•è¯·æ±‚æ–¹æ³•ã€URLã€å“åº”çŠ¶æ€ç åŠæ‰§è¡Œæ—¶é—´ HEADERS é™¤äº† BASIC ä¸­å®šä¹‰çš„ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜æœ‰è¯·æ±‚å’Œå“åº”çš„å¤´ä¿¡æ¯ FULL é™¤äº† HEADERS ä¸­å®šä¹‰çš„ä¿¡æ¯å¤–ï¼Œè¿˜æœ‰è¯·æ±‚å’Œå“åº”çš„æ­£æ–‡åŠå…ƒæ•°æ® é…ç½®åœ¨æ¶ˆè´¹è€…ç«¯ æ–°å»º config.FeignConfig æ–‡ä»¶ï¼šé…ç½®æ—¥å¿— Bean 1234567@Configurationpublic class FeignConfig &#123; @Bean Logger.Level feignLoggerLevel() &#123; return Logger.Level.FULL; &#125;&#125; application.ymlï¼š 1234logging: level: # feign æ—¥å¿—ä»¥ä»€ä¹ˆçº§åˆ«ç›‘æ§å“ªä¸ªæ¥å£ com.atguigu.springcloud.service.PaymentFeignService: debug Debug åæŸ¥çœ‹åå°æ—¥å¿— æœåŠ¡ç†”æ–­HystrixåŸºæœ¬ä»‹ç»Hystrix æ˜¯ä¸€ä¸ªç”¨äºå¤„ç†åˆ†å¸ƒå¼ç³»ç»Ÿçš„å»¶è¿Ÿå’Œå®¹é”™çš„å¼€æºåº“ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿé‡Œï¼Œè®¸å¤šä¾èµ–ä¼šå‡ºç°è°ƒç”¨å¤±è´¥ï¼Œæ¯”å¦‚è¶…æ—¶ã€å¼‚å¸¸ç­‰ï¼ŒHystrix èƒ½å¤Ÿä¿è¯åœ¨ä¸€ä¸ªä¾èµ–å‡ºé—®é¢˜çš„æƒ…å†µä¸‹ï¼Œä¸ä¼šå¯¼è‡´æ•´ä½“æœåŠ¡å¤±è´¥ï¼Œé¿å…çº§è”æ•…éšœï¼Œä»¥æé«˜åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¼¹æ€§ æ–­è·¯å™¨æœ¬èº«æ˜¯ä¸€ç§å¼€å…³è£…ç½®ï¼Œå½“æŸä¸ªæœåŠ¡å•å…ƒå‘ç”Ÿæ•…éšœä¹‹åï¼Œé€šè¿‡æ–­è·¯å™¨çš„æ•…éšœç›‘æ§ï¼ˆç±»ä¼¼ç†”æ–­ä¿é™©ä¸ï¼‰ï¼Œå‘è°ƒç”¨æ–¹è¿”å›ä¸€ä¸ªç¬¦åˆé¢„æœŸçš„ã€å¯å¤„ç†çš„å¤‡é€‰å“åº”ï¼ˆFallBackï¼‰ï¼Œè€Œä¸æ˜¯é•¿æ—¶é—´çš„ç­‰å¾…æˆ–è€…æŠ›å‡ºè°ƒç”¨æ–¹æ— æ³•å¤„ç†çš„å¼‚å¸¸ï¼Œè¿™æ ·å°±ä¿è¯äº†æœåŠ¡è°ƒç”¨æ–¹çš„çº¿ç¨‹ä¸ä¼šè¢«é•¿æ—¶é—´åœ°å ç”¨ï¼Œé¿å…äº†æ•…éšœåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„è”“å»¶ï¼Œä¹ƒè‡³é›ªå´© æœåŠ¡é™çº§ Fallbackï¼šç³»ç»Ÿä¸å¯ç”¨æ—¶éœ€è¦ä¸€ä¸ªå…œåº•çš„è§£å†³æ–¹æ¡ˆæˆ–å¤‡é€‰å“åº”ï¼Œå‘è°ƒç”¨æ–¹è¿”å›ä¸€ä¸ªå¯å¤„ç†çš„å“åº” æœåŠ¡ç†”æ–­ Breakï¼šè¾¾åˆ°æœ€å¤§æœåŠ¡è®¿é—®åï¼Œç›´æ¥æ‹’ç»è®¿é—® æœåŠ¡é™æµ Flowlimitï¼šé«˜å¹¶å‘æ“ä½œæ—¶ä¸¥ç¦æ‰€æœ‰è¯·æ±‚ä¸€æ¬¡æ€§è¿‡æ¥æ‹¥æŒ¤ï¼Œä¸€ç§’é’Ÿ N ä¸ªï¼Œæœ‰åºæ’é˜Ÿè¿›è¡Œ å®˜æ–¹æ–‡æ¡£ï¼šhttps://github.com/Netflix/Hystrix/wiki/How-To-Use æœåŠ¡é™çº§æ¡ˆä¾‹æ„å»ºç”Ÿäº§è€…æ¨¡å—ï¼š å¼•å…¥ pom ä¾èµ–ï¼š 1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;/artifactId&gt;&lt;/dependency&gt; ä¸»å¯åŠ¨ç±»ï¼šå¼€å¯ Feign 12345678@SpringBootApplication@EnableEurekaClient@EnableCircuitBreaker // é™çº§ä½¿ç”¨public class PaymentHystrixMain8001 &#123; public static void main(String[] args) &#123; SpringApplication.run(PaymentHystrixMain8001.class, args); &#125;&#125; Controllerï¼š 1234567891011121314151617181920@RestController@Slf4jpublic class PaymentController &#123; @Resource private PaymentService paymentService; @Value(&quot;$&#123;server.port&#125;&quot;) private String serverPort; // æ­£å¸¸è®¿é—® @GetMapping(&quot;/payment/hystrix/ok/&#123;id&#125;&quot;) private String paymentInfo_Ok(@PathVariable(&quot;id&quot;) Integer id) &#123; return paymentService.paymentInfo_Ok(id); &#125; // è¶…æ—¶ @GetMapping(&quot;/payment/hystrix/timeout/&#123;id&#125;&quot;) private String paymentInfo_Timeout(@PathVariable(&quot;id&quot;) Integer id) &#123; // service å±‚æœ‰ Thread.sleep() æ“ä½œï¼Œä¿è¯è¶…æ—¶ return paymentService.paymentInfo_Timeout(id); &#125;&#125; Serviceï¼š 12345678910111213141516@Servicepublic class PaymentService &#123; public String paymentInfo_Ok(Integer id) &#123; return &quot;çº¿ç¨‹æ± : &quot; + Thread.currentThread().getName() + &quot;paymentInfo_OK, id: &quot; + id&quot;; &#125; public String paymentInfo_Timeout(Integer id) &#123; int timeNumber = 3; try &#123; TimeUnit.SECONDS.sleep(timeNumber); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; return &quot;çº¿ç¨‹æ± : &quot; + Thread.currentThread().getName() + &quot; payment_Timeout, id: &quot; + id; &#125;&#125; jmeter å‹æµ‹ä¸¤ä¸ªæ¥å£ï¼Œå‘ç°æ¥å£ paymentInfo_Ok ä¹Ÿå˜çš„å¡é¡¿ æ¶ˆè´¹è€…æ¨¡å—ï¼š Service æ¥å£ï¼š 123456789@Component@FeignClient(value = &quot;CLOUD-PROVIDER-HYSTRIX-PAYMENT&quot;)public interface PaymentHystrixService &#123; @GetMapping(&quot;/payment/hystrix/ok/&#123;id&#125;&quot;) public String paymentInfo_Ok(@PathVariable(&quot;id&quot;) Integer id); @GetMapping(&quot;/payment/hystrix/timeout/&#123;id&#125;&quot;) public String paymentInfo_Timeout(@PathVariable(&quot;id&quot;) Integer id);&#125; Controllerï¼š 12345678910111213141516@RestController@Slf4jpublic class OrderHystirxController &#123; @Resource PaymentHystrixService paymentHystrixService; @GetMapping(&quot;/consumer/payment/hystrix/ok/&#123;id&#125;&quot;) public String paymentInfo_Ok(@PathVariable(&quot;id&quot;) Integer id) &#123; return paymentHystrixService.paymentInfo_Ok(id); &#125; @GetMapping(&quot;/consumer/payment/hystrix/timeout/&#123;id&#125;&quot;) public String paymentInfo_Timeout(@PathVariable(&quot;id&quot;) Integer id) &#123; return paymentHystrixService.paymentInfo_Timeout(id); &#125;&#125; æµ‹è¯•ï¼šä½¿ç”¨çš„æ˜¯ Feign ä½œä¸ºå®¢æˆ·ç«¯ï¼Œé»˜è®¤ 1s æ²¡æœ‰å¾—åˆ°å“åº”å°±ä¼šæŠ¥è¶…æ—¶é”™è¯¯ï¼Œè¿›è¡Œå¹¶å‘å‹æµ‹ è§£å†³ï¼š è¶…æ—¶å¯¼è‡´æœåŠ¡å™¨å˜æ…¢ï¼ˆè½¬åœˆï¼‰ï¼šè¶…æ—¶ä¸å†ç­‰å¾… å‡ºé”™ï¼ˆå®•æœºæˆ–ç¨‹åºè¿è¡Œå‡ºé”™ï¼‰ï¼šå‡ºé”™è¦æœ‰å…œåº• é™çº§æ“ä½œç”Ÿäº§è€…ç«¯å’Œæ¶ˆè´¹è€…ç«¯éƒ½å¯ä»¥è¿›è¡ŒæœåŠ¡é™çº§ï¼Œä½¿ç”¨ @HystrixCommand æ³¨è§£æŒ‡å®šé™çº§åçš„æ–¹æ³• ç”Ÿäº§è€…ç«¯ï¼šä¸»å¯åŠ¨ç±»æ·»åŠ æ–°æ³¨è§£ @EnableCircuitBreakerï¼Œä¸šåŠ¡ç±»ï¼ˆServiceï¼‰æ–¹æ³•è¿›è¡Œå¦‚ä¸‹ä¿®æ”¹ï¼Œ 123456789101112// æ¨¡æ‹Ÿæ‹¥å µçš„æƒ…å†µ@HystrixCommand(fallbackMethod = &quot;paymentInfo_TimeoutHandler&quot;, commandProperties = &#123; //è§„å®šè¿™ä¸ªçº¿ç¨‹çš„è¶…æ—¶æ—¶é—´æ˜¯3sï¼Œ3såå°±ç”±fallbackMethodæŒ‡å®šçš„æ–¹æ³•â€œå…œåº•â€ï¼ˆæœåŠ¡é™çº§ï¼‰ @HystrixProperty(name=&quot;execution.isolation.thread.timeoutInMilliseconds&quot;, value = &quot;3000&quot;)&#125;)public String paymentInfo_Timeout(Integer id) &#123; // è¶…æ—¶æˆ–è€…å‡ºé”™&#125;public String paymentInfo_TimeoutHandler(Integer id) &#123; return &quot;çº¿ç¨‹æ± ï¼š&quot; + Thread.currentThread().getName() + &quot; paymentInfo_TimeoutHandler, id: &quot; + id&quot;;&#125; æœåŠ¡é™çº§çš„æ–¹æ³•å’Œä¸šåŠ¡å¤„ç†çš„æ–¹æ³•æ··æ‚åœ¨äº†ä¸€å—ï¼Œè€¦åˆåº¦å¾ˆé«˜ï¼Œå¹¶ä¸”æ¯ä¸ªæ–¹æ³•é…ç½®ä¸€ä¸ªæœåŠ¡é™çº§æ–¹æ³• åœ¨ä¸šåŠ¡ç±»Controllerä¸ŠåŠ  @DefaultProperties(defaultFallback &#x3D; â€œmethod_nameâ€) æ³¨è§£ åœ¨éœ€è¦æœåŠ¡é™çº§çš„æ–¹æ³•ä¸Šæ ‡æ³¨ @HystrixCommand æ³¨è§£ï¼Œå¦‚æœ @HystrixCommand é‡Œæ²¡æœ‰æŒ‡æ˜ fallbackMethodï¼Œå°±é»˜è®¤ä½¿ç”¨ @DefaultProperties ä¸­æŒ‡æ˜çš„é™çº§æœåŠ¡ 1234567891011121314151617181920212223242526@RestController@Slf4j@DefaultProperties(defaultFallback = &quot;payment_Global_FallbackMethod&quot;)public class OrderHystrixController &#123; @Resource PaymentHystrixService paymentHystrixService; @GetMapping(&quot;/consumer/payment/hystrix/ok/&#123;id&#125;&quot;) public String paymentInfo_Ok(@PathVariable(&quot;id&quot;) Integer id) &#123; return paymentHystrixService.paymentInfo_OK(id); &#125; @HystrixCommand public String paymentInfo_Timeout(@PathVariable(&quot;id&quot;) Integer id) &#123; return paymentHystrixService.paymentInfo_Timeout(id); &#125; public String paymentTimeOutFallbackMethod(@PathVariable(&quot;id&quot;) Integer id) &#123; return &quot;fallback&quot;; &#125; // ä¸‹é¢æ˜¯å…¨å±€fallbackæ–¹æ³• public String payment_Global_FallbackMethod() &#123; return &quot;Global fallback&quot;; &#125;&#125; å®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡ç«¯ï¼Œé‡åˆ°æœåŠ¡ç«¯å®•æœºæˆ–å…³é—­ç­‰æç«¯æƒ…å†µï¼Œä¸º Feign å®¢æˆ·ç«¯å®šä¹‰çš„æ¥å£æ·»åŠ ä¸€ä¸ªæœåŠ¡é™çº§å®ç°ç±»å³å¯å®ç°è§£è€¦ application.ymlï¼šé…ç½®æ–‡ä»¶ä¸­å¼€å¯äº† Hystrix 1234# ç”¨äºæœåŠ¡é™çº§ åœ¨æ³¨è§£ @FeignClientä¸­æ·»åŠ fallbackFactoryå±æ€§å€¼feign: hystrix: enabled: true #åœ¨Feignä¸­å¼€å¯Hystrix Serviceï¼šç»Ÿä¸€ä¸ºæ¥å£é‡Œé¢çš„æ–¹æ³•è¿›è¡Œå¼‚å¸¸å¤„ç†ï¼ŒæœåŠ¡å¼‚å¸¸æ‰¾ PaymentFallbackServiceï¼Œæ¥ç»Ÿä¸€è¿›è¡ŒæœåŠ¡é™çº§çš„å¤„ç† 12345678910@Component@FeignClient(value = &quot;PROVIDER-HYSTRIX-PAYMENT&quot;, fallback = PaymentFallbackService.class)public interface PaymentHystrixService &#123; @GetMapping(&quot;/payment/hystrix/ok/&#123;id&#125;&quot;) public String paymentInfo_OK(@PathVariable(&quot;id&quot;) Integer id); @GetMapping(&quot;/payment/hystrix/timeout/&#123;id&#125;&quot;) public String paymentInfo_Timeout(@PathVariable(&quot;id&quot;) Integer id);&#125; PaymentFallbackServiceï¼š 123456789101112@Componentpublic class PaymentFallbackService implements PaymentHystrixService &#123; @Override public String paymentInfo_OK(Integer id) &#123; return &quot;------PaymentFallbackService-paymentInfo_Ok, fallback&quot;; &#125; @Override public String paymentInfo_Timeout(Integer id) &#123; return &quot;------PaymentFallbackService-paymentInfo_Timeout, fallback&quot;; &#125;&#125; æœåŠ¡ç†”æ–­ç†”æ–­ç±»å‹ç†”æ–­æœºåˆ¶æ˜¯åº”å¯¹é›ªå´©æ•ˆåº”çš„ä¸€ç§å¾®æœåŠ¡é“¾è·¯ä¿æŠ¤æœºåˆ¶ï¼Œå½“æ‰‡å‡ºé“¾è·¯çš„æŸä¸ªå¾®æœåŠ¡å‡ºé”™ä¸å¯ç”¨æˆ–è€…å“åº”æ—¶é—´å¤ªé•¿æ—¶ï¼Œä¼šè¿›è¡ŒæœåŠ¡çš„é™çº§ï¼Œè¿›è€Œç†”æ–­è¯¥èŠ‚ç‚¹å¾®æœåŠ¡çš„è°ƒç”¨ï¼Œå¿«é€Ÿè¿”å›é”™è¯¯çš„å“åº”ä¿¡æ¯ Hystrix ä¼šç›‘æ§å¾®æœåŠ¡é—´è°ƒç”¨çš„çŠ¶å†µï¼Œå½“å¤±è´¥çš„è°ƒç”¨åˆ°ä¸€å®šé˜ˆå€¼ï¼Œç¼ºçœæ—¶ 5 ç§’å†… 20 æ¬¡è°ƒç”¨å¤±è´¥ï¼Œå°±ä¼šå¯åŠ¨ç†”æ–­æœºåˆ¶ï¼›å½“æ£€æµ‹åˆ°è¯¥èŠ‚ç‚¹å¾®æœåŠ¡è°ƒç”¨å“åº”æ­£å¸¸åï¼ˆæ£€æµ‹æ–¹å¼æ˜¯å°è¯•æ€§æ”¾å¼€è¯·æ±‚ï¼‰ï¼Œè‡ªåŠ¨æ¢å¤è°ƒç”¨é“¾è·¯ ç†”æ–­æ‰“å¼€ï¼šè¯·æ±‚ä¸å†è¿›è¡Œè°ƒç”¨å½“å‰æœåŠ¡ï¼Œå†æœ‰è¯·æ±‚è°ƒç”¨æ—¶å°†ä¸ä¼šè°ƒç”¨ä¸»é€»è¾‘ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨é™çº§ fallbackã€‚å®ç°äº†è‡ªåŠ¨çš„å‘ç°é”™è¯¯å¹¶å°†é™çº§é€»è¾‘åˆ‡æ¢ä¸ºä¸»é€»è¾‘ï¼Œå‡å°‘å“åº”å»¶è¿Ÿæ•ˆæœã€‚å†…éƒ¨è®¾ç½®æ—¶é’Ÿä¸€èˆ¬ä¸º MTTRï¼ˆMean time to repairï¼Œå¹³å‡æ•…éšœå¤„ç†æ—¶é—´ï¼‰ï¼Œå½“æ‰“å¼€æ—¶é•¿è¾¾åˆ°æ‰€è®¾æ—¶é’Ÿåˆ™è¿›å…¥åŠç†”æ–­çŠ¶æ€ ç†”æ–­å…³é—­ï¼šç†”æ–­å…³é—­ä¸ä¼šå¯¹æœåŠ¡è¿›è¡Œç†”æ–­ï¼ŒæœåŠ¡æ­£å¸¸è°ƒç”¨ ç†”æ–­åŠå¼€ï¼šéƒ¨åˆ†è¯·æ±‚æ ¹æ®è§„åˆ™è°ƒç”¨å½“å‰æœåŠ¡ï¼Œå¦‚æœè¯·æ±‚æˆåŠŸä¸”ç¬¦åˆè§„åˆ™åˆ™è®¤ä¸ºå½“å‰æœåŠ¡æ¢å¤æ­£å¸¸ï¼Œå…³é—­ç†”æ–­ï¼Œåä¹‹ç»§ç»­ç†”æ–­ ç†”æ–­æ“ä½œæ¶‰åŠåˆ°æ–­è·¯å™¨çš„å››ä¸ªé‡è¦å‚æ•°ï¼šå¿«ç…§æ—¶é—´çª—ã€è¯·æ±‚æ€»æ•°é˜€å€¼ã€çª—å£ç¡çœ æ—¶é—´ã€é”™è¯¯ç™¾åˆ†æ¯”é˜€å€¼ circuitBreaker.enabledï¼šæ˜¯å¦å¼€å¯æ–­è·¯å™¨ metrics.rollingStats.timeInMillisecondsï¼šå¿«ç…§æ—¶é—´çª—å£ï¼Œæ–­è·¯å™¨ç¡®å®šæ˜¯å¦æ‰“å¼€éœ€è¦ç»Ÿè®¡ä¸€äº›è¯·æ±‚å’Œé”™è¯¯æ•°æ®ï¼Œè€Œç»Ÿè®¡çš„æ—¶é—´èŒƒå›´å°±æ˜¯å¿«ç…§æ—¶é—´çª—ï¼Œé»˜è®¤ä¸ºæœ€è¿‘çš„ 10 ç§’ circuitBreaker.requestVolumeThresholdï¼šè¯·æ±‚æ€»æ•°é˜€å€¼ï¼Œè¯¥å±æ€§è®¾ç½®åœ¨å¿«ç…§æ—¶é—´çª—å†…ï¼ˆé»˜è®¤ 10sï¼‰ä½¿æ–­è·¯å™¨è·³é—¸çš„æœ€å°è¯·æ±‚æ•°é‡ï¼ˆé»˜è®¤æ˜¯ 20ï¼‰ï¼Œå¦‚æœ 10s å†…è¯·æ±‚æ•°å°äºè®¾å®šå€¼ï¼Œå°±ç®—è¯·æ±‚å…¨éƒ¨å¤±è´¥ä¹Ÿä¸ä¼šè§¦å‘æ–­è·¯å™¨ circuitBreaker.sleepWindowInMillisecondsï¼šçª—å£ç¡çœ æ—¶é—´ï¼ŒçŸ­è·¯å¤šä¹…ä»¥åå¼€å§‹å°è¯•æ˜¯å¦æ¢å¤è¿›å…¥åŠå¼€çŠ¶æ€ï¼Œé»˜è®¤ 5s circuitBreaker.errorThresholdPercentageï¼šé”™è¯¯ç™¾åˆ†æ¯”é˜€å€¼ï¼Œå¤±è´¥ç‡è¾¾åˆ°å¤šå°‘åå°†æ–­è·¯å™¨æ‰“å¼€ 123456789101112131415 //æ€»çš„æ„æ€å°±æ˜¯åœ¨n(10)æ¯«ç§’å†…çš„æ—¶é—´çª—å£æœŸå†…ï¼Œmæ¬¡è¯·æ±‚ä¸­æœ‰p% (60%)çš„è¯·æ±‚å¤±è´¥äº†ï¼Œé‚£ä¹ˆæ–­è·¯å™¨å¯åŠ¨@HystrixCommand(fallbackMethod = &quot;paymentCircuitBreaker_fallback&quot;, commandProperties = &#123; @HystrixProperty(name = &quot;circuitBreaker.enabled&quot;, value = &quot;true&quot;), @HystrixProperty(name = &quot;circuitBreaker.requestVolumeThreshold&quot;, value = &quot;10&quot;), @HystrixProperty(name = &quot;circuitBreaker.sleepWindowInMilliseconds&quot;, value = &quot;10000&quot;), @HystrixProperty(name = &quot;circuitBreaker.errorThresholdPercentage&quot;, value = &quot;60&quot;) &#125;)public String paymentCircuitBreaker(@PathVariable(&quot;id&quot;) Integer id) &#123; if (id &lt; 0) &#123; throw new RuntimeException(&quot;******id ä¸èƒ½è´Ÿæ•°&quot;); &#125; String serialNumber = IdUtil.simpleUUID(); // ç­‰ä»·äºUUID.randomUUID().toString() return Thread.currentThread().getName() + &quot;\\t&quot; + &quot;è°ƒç”¨æˆåŠŸï¼Œæµæ°´å·: &quot; + serialNumber;&#125; å¼€å¯ï¼šæ»¡è¶³ä¸€å®šçš„é˜ˆå€¼ï¼ˆé»˜è®¤ 10 ç§’å†…è¶…è¿‡ 20 ä¸ªè¯·æ±‚æ¬¡æ•°ï¼‰ã€å¤±è´¥ç‡è¾¾åˆ°é˜ˆå€¼ï¼ˆé»˜è®¤ 10 ç§’å†…è¶…è¿‡ 50% çš„è¯·æ±‚å¤±è´¥ï¼‰ å…³é—­ï¼šä¸€æ®µæ—¶é—´ä¹‹åï¼ˆé»˜è®¤æ˜¯ 5 ç§’ï¼‰ï¼Œæ–­è·¯å™¨æ˜¯åŠå¼€çŠ¶æ€ï¼Œä¼šè®©å…¶ä¸­ä¸€ä¸ªè¯·æ±‚è¿›è¡Œè½¬å‘ï¼Œå¦‚æœæˆåŠŸæ–­è·¯å™¨ä¼šå…³é—­ï¼Œåä¹‹ç»§ç»­å¼€å¯ å·¥ä½œæµç¨‹å…·ä½“å·¥ä½œæµç¨‹ï¼š åˆ›å»º HystrixCommandï¼ˆç”¨åœ¨ä¾èµ–çš„æœåŠ¡è¿”å›å•ä¸ªæ“ä½œç»“æœçš„æ—¶å€™ï¼‰ æˆ– HystrixObserableCommandï¼ˆç”¨åœ¨ä¾èµ–çš„æœåŠ¡è¿”å›å¤šä¸ªæ“ä½œç»“æœçš„æ—¶å€™ï¼‰ å¯¹è±¡ å‘½ä»¤æ‰§è¡Œï¼Œå…¶ä¸­ HystrixComand å®ç°äº†ä¸‹é¢å‰ä¸¤ç§æ‰§è¡Œæ–¹å¼ï¼Œè€Œ HystrixObservableCommand å®ç°äº†åä¸¤ç§æ‰§è¡Œæ–¹å¼ execute()ï¼šåŒæ­¥æ‰§è¡Œï¼Œä»ä¾èµ–çš„æœåŠ¡è¿”å›ä¸€ä¸ªå•ä¸€çš„ç»“æœå¯¹è±¡ï¼Œ æˆ–æ˜¯åœ¨å‘ç”Ÿé”™è¯¯çš„æ—¶å€™æŠ›å‡ºå¼‚å¸¸ queue()ï¼šå¼‚æ­¥æ‰§è¡Œï¼Œ ç›´æ¥è¿”å› ä¸€ä¸ª Future å¯¹è±¡ï¼Œ å…¶ä¸­åŒ…å«äº†æœåŠ¡æ‰§è¡Œç»“æŸæ—¶è¦è¿”å›çš„å•ä¸€ç»“æœå¯¹è±¡ observe()ï¼šè¿”å› Observable å¯¹è±¡ï¼Œä»£è¡¨äº†æ“ä½œçš„å¤šä¸ªç»“æœï¼Œå®ƒæ˜¯ä¸€ä¸ª Hot Obserableï¼ˆä¸è®ºäº‹ä»¶æºæ˜¯å¦æœ‰è®¢é˜…è€…ï¼Œéƒ½ä¼šåœ¨åˆ›å»ºåå¯¹äº‹ä»¶è¿›è¡Œå‘å¸ƒï¼Œæ‰€ä»¥å¯¹äº Hot Observable çš„æ¯ä¸ªè®¢é˜…è€…éƒ½æœ‰å¯èƒ½æ˜¯ä»äº‹ä»¶æºçš„ä¸­é€”å¼€å§‹çš„ï¼Œå¹¶å¯èƒ½åªæ˜¯çœ‹åˆ°äº†æ•´ä¸ªæ“ä½œçš„å±€éƒ¨è¿‡ç¨‹ï¼‰ toObservable()ï¼šåŒæ ·ä¼šè¿”å› Observable å¯¹è±¡ï¼Œä¹Ÿä»£è¡¨äº†æ“ä½œçš„å¤šä¸ªç»“æœï¼Œä½†å®ƒè¿”å›çš„æ˜¯ä¸€ä¸ª Cold Observableï¼ˆæ²¡æœ‰è®¢é˜…è€…çš„æ—¶å€™å¹¶ä¸ä¼šå‘å¸ƒäº‹ä»¶ï¼Œè€Œæ˜¯è¿›è¡Œç­‰å¾…ï¼Œç›´åˆ°æœ‰è®¢é˜…è€…ä¹‹åæ‰å‘å¸ƒäº‹ä»¶ï¼Œæ‰€ä»¥å¯¹äº Cold Observable çš„è®¢é˜…è€…ï¼Œå®ƒå¯ä»¥ä¿è¯ä»ä¸€å¼€å§‹çœ‹åˆ°æ•´ä¸ªæ“ä½œçš„å…¨éƒ¨è¿‡ç¨‹ï¼‰ è‹¥å½“å‰å‘½ä»¤çš„è¯·æ±‚ç¼“å­˜åŠŸèƒ½æ˜¯è¢«å¯ç”¨çš„ï¼Œå¹¶ä¸”è¯¥å‘½ä»¤ç¼“å­˜å‘½ä¸­ï¼Œé‚£ä¹ˆç¼“å­˜çš„ç»“æœä¼šç«‹å³ä»¥ Observable å¯¹è±¡çš„å½¢å¼è¿”å› æ£€æŸ¥æ–­è·¯å™¨æ˜¯å¦ä¸ºæ‰“å¼€çŠ¶æ€ï¼Œå¦‚æœæ–­è·¯å™¨æ˜¯æ‰“å¼€çš„ï¼Œé‚£ä¹ˆ Hystrix ä¸ä¼šæ‰§è¡Œå‘½ä»¤ï¼Œè€Œæ˜¯è½¬æ¥åˆ° fallback å¤„ç†é€»è¾‘ï¼ˆç¬¬ 8 æ­¥ï¼‰ï¼›å¦‚æœæ–­è·¯å™¨æ˜¯å…³é—­çš„ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨èµ„æºæ¥æ‰§è¡Œå‘½ä»¤ï¼ˆç¬¬ 5 æ­¥ï¼‰ çº¿ç¨‹æ± &#x2F;è¯·æ±‚é˜Ÿåˆ—&#x2F;ä¿¡å·é‡æ˜¯å¦å æ»¡ï¼Œå¦‚æœå‘½ä»¤ä¾èµ–æœåŠ¡çš„ä¸“æœ‰çº¿ç¨‹æ± å’Œè¯·æ±‚é˜Ÿåˆ—ï¼Œæˆ–è€…ä¿¡å·é‡ï¼ˆä¸ä½¿ç”¨çº¿ç¨‹æ± æ—¶ï¼‰å·²ç»è¢«å æ»¡ï¼Œ é‚£ä¹ˆ Hystrix ä¹Ÿä¸ä¼šæ‰§è¡Œå‘½ä»¤ï¼Œ è€Œæ˜¯è½¬æ¥åˆ° fallback å¤„ç†é€»è¾‘ï¼ˆç¬¬ 8 æ­¥ï¼‰ Hystrix ä¼šæ ¹æ®æˆ‘ä»¬ç¼–å†™çš„æ–¹æ³•æ¥å†³å®šé‡‡å–ä»€ä¹ˆæ ·çš„æ–¹å¼å»è¯·æ±‚ä¾èµ–æœåŠ¡ HystrixCommand.run()ï¼šè¿”å›ä¸€ä¸ªå•ä¸€çš„ç»“æœï¼Œæˆ–è€…æŠ›å‡ºå¼‚å¸¸ HystrixObservableCommand.construct()ï¼šè¿”å›ä¸€ä¸ªObservable å¯¹è±¡æ¥å‘å°„å¤šä¸ªç»“æœï¼Œæˆ–é€šè¿‡ onError å‘é€é”™è¯¯é€šçŸ¥ Hystrixä¼šå°†â€æˆåŠŸâ€ã€â€å¤±è´¥â€ã€â€æ‹’ç»â€ã€â€è¶…æ—¶â€ç­‰ä¿¡æ¯æŠ¥å‘Šç»™æ–­è·¯å™¨ï¼Œè€Œæ–­è·¯å™¨ä¼šç»´æŠ¤ä¸€ç»„è®¡æ•°å™¨æ¥ç»Ÿè®¡è¿™äº›æ•°æ®ã€‚æ–­è·¯å™¨ä¼šä½¿ç”¨è¿™äº›ç»Ÿè®¡æ•°æ®æ¥å†³å®šæ˜¯å¦è¦å°†æ–­è·¯å™¨æ‰“å¼€ï¼Œæ¥å¯¹æŸä¸ªä¾èµ–æœåŠ¡çš„è¯·æ±‚è¿›è¡Œâ€ç†”æ–­&#x2F;çŸ­è·¯â€ å½“å‘½ä»¤æ‰§è¡Œå¤±è´¥çš„æ—¶å€™ï¼ŒHystrix ä¼šè¿›å…¥ fallback å°è¯•å›é€€å¤„ç†ï¼Œé€šå¸¸ä¹Ÿç§°è¯¥æ“ä½œä¸ºâ€æœåŠ¡é™çº§â€ï¼Œè€Œèƒ½å¤Ÿå¼•èµ·æœåŠ¡é™çº§æƒ…å†µï¼š ç¬¬ 4 æ­¥ï¼šå½“å‰å‘½ä»¤å¤„äºâ€ç†”æ–­&#x2F;çŸ­è·¯â€çŠ¶æ€ï¼Œæ–­è·¯å™¨æ˜¯æ‰“å¼€çš„æ—¶å€™ ç¬¬ 5 æ­¥ï¼šå½“å‰å‘½ä»¤çš„çº¿ç¨‹æ± ã€è¯·æ±‚é˜Ÿåˆ—æˆ– è€…ä¿¡å·é‡è¢«å æ»¡çš„æ—¶å€™ ç¬¬ 6 æ­¥ï¼šHystrixObservableCommand.construct() æˆ– HystrixCommand.run() æŠ›å‡ºå¼‚å¸¸çš„æ—¶å€™ å½“ Hystrix å‘½ä»¤æ‰§è¡ŒæˆåŠŸä¹‹åï¼Œ å®ƒä¼šå°†å¤„ç†ç»“æœç›´æ¥è¿”å›æˆ–æ˜¯ä»¥ Observable çš„å½¢å¼è¿”å› æ³¨æ„ï¼šå¦‚æœã€æ²¡æœ‰ä¸ºå‘½ä»¤å®ç°é™çº§é€»è¾‘æˆ–è€…åœ¨é™çº§å¤„ç†é€»è¾‘ä¸­æŠ›å‡ºäº†å¼‚å¸¸ï¼Œ Hystrix ä¾ç„¶ä¼šè¿”å›ä¸€ä¸ª Observable å¯¹è±¡ï¼Œ ä½†æ˜¯å®ƒä¸ä¼šå‘å°„ä»»ä½•ç»“æœæ•°æ®ï¼Œè€Œæ˜¯é€šè¿‡ onError æ–¹æ³•é€šçŸ¥å‘½ä»¤ç«‹å³ä¸­æ–­è¯·æ±‚ï¼Œå¹¶é€šè¿‡ onError() æ–¹æ³•å°†å¼•èµ·å‘½ä»¤å¤±è´¥çš„å¼‚å¸¸å‘é€ç»™è°ƒç”¨è€… å®˜æ–¹æ–‡æ¡£ï¼šhttps://github.com/Netflix/Hystrix/wiki/How-it-Works æœåŠ¡ç›‘æ§Hystrix æä¾›äº†å‡†å®æ—¶çš„è°ƒç”¨ç›‘æ§ï¼ˆHystrix Dashboardï¼‰ï¼ŒHystrix ä¼šæŒç»­çš„è®°å½•æ‰€æœ‰é€šè¿‡ Hystrix å‘èµ·çš„è¯·æ±‚çš„æ‰§è¡Œä¿¡æ¯ï¼Œå¹¶ä»¥ç»Ÿè®¡æŠ¥è¡¨å’Œå›¾å½¢çš„å½¢å¼å±•ç¤ºç»™ç”¨æˆ·ï¼ŒåŒ…æ‹¬æ¯ç§’æ‰§è¡Œå¤šå°‘è¯·æ±‚å¤šå°‘æˆåŠŸï¼Œå¤šå°‘å¤±è´¥ç­‰ï¼ŒNetflix é€šè¿‡ hystrix-metrics-event-stream é¡¹ç›®å®ç°äº†å¯¹ä»¥ä¸ŠæŒ‡æ ‡çš„ç›‘æ§ï¼ŒSpring Cloud æä¾›äº† Hystrix Dashboard çš„æ•´åˆï¼Œå¯¹ç›‘æ§å†…å®¹è½¬åŒ–æˆå¯è§†åŒ–é¡µé¢ å¼•å…¥ pom ä¾èµ–ï¼š 1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix-dashboard&lt;/artifactId&gt;&lt;/dependency&gt; application.ymlï¼šåªéœ€è¦ç«¯å£å³å¯ 12server: port: 9001 ä¸»å¯åŠ¨ç±»ï¼š 1234567@SpringBootApplication@EnableHystrixDashboard // å¼€å¯Hystrixä»ªè¡¨ç›˜public class HystrixDashboardMain9001 &#123; public static void main(String[] args) &#123; SpringApplication.run(HystrixDashboardMain9001.class, args); &#125;&#125; æ‰€æœ‰å¾®æœåŠ¡ï¼ˆç”Ÿäº§è€…ï¼‰æä¾›ç±» 8001&#x2F;8002&#x2F;8003 éƒ½éœ€è¦ç›‘æ§ä¾èµ–é…ç½® 1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;&lt;/dependency&gt; å¯åŠ¨æµ‹è¯•ï¼šhttp://localhost:9001/hystrix æ–°ç‰ˆæœ¬ Hystrix éœ€è¦åœ¨éœ€è¦ç›‘æ§çš„å¾®æœåŠ¡ç«¯çš„ä¸»å¯åŠ¨ç±»ä¸­æŒ‡å®šç›‘æ§è·¯å¾„ï¼Œä¸ç„¶ä¼šæŠ¥é”™ 1234567891011121314151617181920212223@SpringBootApplication@EnableEurekaClient // æœ¬æœåŠ¡å¯åŠ¨åä¼šè‡ªåŠ¨æ³¨å†Œè¿›eurekaæœåŠ¡ä¸­@EnableCircuitBreaker // å¯¹hystrixRç†”æ–­æœºåˆ¶çš„æ”¯æŒpublic class PaymentHystrixMain8001 &#123; public static void main(String[] args) &#123; SpringApplication.run(PaymentHystrixMain8001.class, args); &#125; /** ======================================éœ€è¦æ·»åŠ çš„ä»£ç ================== *æ­¤é…ç½®æ˜¯ä¸ºäº†æœåŠ¡ç›‘æ§è€Œé…ç½®ï¼Œä¸æœåŠ¡å®¹é”™æœ¬èº«æ— å…³ï¼Œspringcloudå‡çº§åçš„å‘ *ServletRegistrationBeanå› ä¸ºspringbootçš„é»˜è®¤è·¯å¾„ä¸æ˜¯&quot;/hystrix.stream&quot;ï¼Œ *åªè¦åœ¨è‡ªå·±çš„é¡¹ç›®é‡Œé…ç½®ä¸Šä¸‹é¢çš„servletå°±å¯ä»¥äº† */ @Bean public ServletRegistrationBean getServlet() &#123; HystrixMetricsStreamServlet streamServlet = new HystrixMetricsStreamServlet(); ServletRegistrationBean registrationBean = new ServletRegistrationBean(streamServlet); registrationBean.setLoadOnStartup(1); registrationBean.addUrlMappings(&quot;/hystrix.stream&quot;); registrationBean.setName(&quot;HystrixMetricsStreamServlet&quot;); return registrationBean; &#125;&#125; æŒ‡æ ‡è¯´æ˜ï¼š æœåŠ¡ç½‘å…³ZuulSpringCloud ä¸­æ‰€é›†æˆçš„ Zuul ç‰ˆæœ¬ï¼Œé‡‡ç”¨çš„æ˜¯ Tomcat å®¹å™¨ï¼ŒåŸºäº Servlet ä¹‹ä¸Šçš„ä¸€ä¸ªé˜»å¡å¼å¤„ç†æ¨¡å‹ï¼Œä¸æ”¯æŒä»»ä½•é•¿è¿æ¥ï¼Œç”¨ Java å®ç°ï¼Œè€Œ JVM æœ¬èº«ä¼šæœ‰ç¬¬ä¸€æ¬¡åŠ è½½è¾ƒæ…¢çš„æƒ…å†µï¼Œä½¿å¾— Zuul çš„æ€§èƒ½ç›¸å¯¹è¾ƒå·® å®˜ç½‘ï¼š https://github.com/Netflix/zuul/wiki GatewayåŸºæœ¬ä»‹ç»SpringCloud Gateway æ˜¯ Spring Cloud çš„ä¸€ä¸ªå…¨æ–°é¡¹ç›®ï¼ŒåŸºäº Spring 5.0+Spring Boot 2.0 å’Œ Project Reactor ç­‰æŠ€æœ¯å¼€å‘çš„ç½‘å…³ï¼Œæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•æœ‰æ•ˆçš„ç»Ÿä¸€çš„ API è·¯ç”±ç®¡ç†æ–¹å¼ã€‚ åŸºäº WebFlux æ¡†æ¶å®ç°ï¼Œè€Œ WebFlux æ¡†æ¶åº•å±‚åˆ™ä½¿ç”¨äº†é«˜æ€§èƒ½çš„ Reactor æ¨¡å¼é€šä¿¡æ¡†æ¶ Nettyï¼ˆå¼‚æ­¥éé˜»å¡å“åº”å¼çš„æ¡†æ¶ï¼‰ åŸºäº Filter é“¾çš„æ–¹å¼æä¾›äº†ç½‘å…³åŸºæœ¬çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼šå®‰å…¨ã€ç›‘æ§&#x2F;æŒ‡æ ‡ã€é™æµç­‰ Gateway çš„ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š Routeï¼šè·¯ç”±æ˜¯æ„å»ºç½‘å…³çš„åŸºæœ¬æ¨¡å—ï¼Œç”± IDã€ç›®æ ‡ URIã€ä¸€ç³»åˆ—çš„æ–­è¨€å’Œè¿‡æ»¤å™¨ç»„æˆï¼Œå¦‚æœæ–­è¨€ä¸º true åˆ™åŒ¹é…è¯¥è·¯ç”± Predicateï¼šæ–­è¨€ï¼Œå¯ä»¥åŒ¹é… HTTP è¯·æ±‚ä¸­çš„æ‰€æœ‰å†…å®¹ï¼ˆä¾‹å¦‚è¯·æ±‚å¤´æˆ–è¯·æ±‚å‚æ•°ï¼‰ï¼Œå¦‚æœè¯·æ±‚å‚æ•°ä¸æ–­è¨€ç›¸åŒ¹é…åˆ™è¿›è¡Œè·¯ç”± Filterï¼šæŒ‡ Spring æ¡†æ¶ä¸­çš„ GatewayFilterå®ä¾‹ï¼Œä½¿ç”¨è¿‡æ»¤å™¨å¯ä»¥åœ¨è¯·æ±‚è¢«è·¯ç”±å‰æˆ–ä¹‹åï¼ˆæ‹¦æˆªï¼‰å¯¹è¯·æ±‚è¿›è¡Œä¿®æ”¹ æ ¸å¿ƒé€»è¾‘ï¼šè·¯ç”±è½¬å‘ + æ‰§è¡Œè¿‡æ»¤å™¨é“¾ å®¢æˆ·ç«¯å‘ Spring Cloud Gateway å‘å‡ºè¯·æ±‚ï¼Œç„¶ååœ¨ Gateway Handler Mapping ä¸­æ‰¾åˆ°ä¸è¯·æ±‚ç›¸åŒ¹é…çš„è·¯ç”±ï¼Œå°†å…¶å‘é€åˆ° Gateway Web Handler Handler é€šè¿‡æŒ‡å®šçš„è¿‡æ»¤å™¨é“¾æ¥å°†è¯·æ±‚å‘é€åˆ°é™…çš„æœåŠ¡æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œç„¶åè¿”å› è¿‡æ»¤å™¨ä¹‹é—´ç”¨è™šçº¿åˆ†å¼€æ˜¯å› ä¸ºè¿‡æ»¤å™¨å¯èƒ½ä¼šåœ¨å‘é€ä»£ç†è¯·æ±‚ä¹‹å‰ï¼ˆpreï¼‰æˆ–ä¹‹åï¼ˆpostï¼‰æ‰§è¡Œä¸šåŠ¡é€»è¾‘ Filter åœ¨ pre ç±»å‹çš„è¿‡æ»¤å™¨å¯ä»¥åšå‚æ•°æ ¡éªŒã€æƒé™æ ¡éªŒã€æµé‡ç›‘æ§ã€æ—¥å¿—è¾“å‡ºã€åè®®è½¬æ¢ç­‰ï¼Œåœ¨ post ç±»å‹çš„è¿‡æ»¤å™¨ä¸­å¯ä»¥åšå“åº”å†…å®¹ã€å“åº”å¤´çš„ä¿®æ”¹ã€æ—¥å¿—çš„è¾“å‡ºã€æµé‡ç›‘æ§ç­‰ ç½‘å…³ä½¿ç”¨é…ç½®æ–¹å¼Gateway ç½‘å…³è·¯ç”±æœ‰ä¸¤ç§é…ç½®æ–¹å¼ï¼Œåˆ†åˆ«ä¸ºé€šè¿‡ yml é…ç½®å’Œæ³¨å…¥ Bean å¼•å…¥ pom ä¾èµ–ï¼šGateway ä¸éœ€è¦ spring-boot-starter-web ä¾èµ–ï¼Œå¦åœ¨ä¼šæŠ¥é”™ï¼ŒåŸå› æ˜¯åº•å±‚ä½¿ç”¨çš„æ˜¯ WebFlux ä¸ Web å†²çª 1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;&lt;/dependency&gt; application.ymlï¼š 123456789101112131415server: port: 9527spring: application: name: cloud-gatewayeureka: instance: hostname: cloud-gateway-service client: #æœåŠ¡æä¾›è€…provideræ³¨å†Œè¿›eurekaæœåŠ¡åˆ—è¡¨å†… service-url: register-with-eureka: true fetch-registry: true defaultZone: http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka #é›†ç¾¤ç‰ˆ ä¸»å¯åŠ¨ç±»ï¼ˆç½‘å…³ä¸éœ€è¦ä¸šåŠ¡ç±»ï¼‰ï¼š 1234567@SpringBootApplication@EnableEurekaClientpublic class GateWayMain9527 &#123; public static void main(String[] args) &#123; SpringApplication.run(GateWayMain9527.class, args); &#125;&#125; ä»¥å‰è®¿é—® provider-payment8001 ä¸­çš„ Controller æ–¹æ³•ï¼Œé€šè¿‡ localhost:8001&#x2F;payment&#x2F;get&#x2F;id å’Œ localhost:8001&#x2F;payment&#x2F;lbï¼Œé¡¹ç›®ä¸æƒ³æš´éœ² 8001 ç«¯å£å·ï¼Œå¸Œæœ›åœ¨ 8001 å¤–é¢å¥—ä¸€å±‚ 9527 ç«¯å£ï¼š 12345678910111213141516171819server: port: 9527spring: application: name: cloud-gateway## =====================æ–°å¢==================== cloud: gateway: routes: - id: payment_routh # payment_route #è·¯ç”±çš„IDï¼Œæ²¡æœ‰å›ºå®šè§„åˆ™ä½†è¦æ±‚ã€å”¯ä¸€ã€‘ï¼Œå»ºè®®é…åˆæœåŠ¡å uri: http://localhost:8001 #åŒ¹é…åæä¾›æœåŠ¡çš„è·¯ç”±åœ°å€ predicates: - Path=/payment/get/** # æ–­è¨€ï¼Œè·¯å¾„ç›¸åŒ¹é…çš„è¿›è¡Œè·¯ç”± - id: payment_routh2 # payment_route#è·¯ç”±çš„IDï¼Œæ²¡æœ‰å›ºå®šè§„åˆ™ä½†è¦æ±‚ã€å”¯ä¸€ã€‘ï¼Œå»ºè®®é…åˆæœåŠ¡å uri: http://localhost:8001 #åŒ¹é…åæä¾›æœåŠ¡çš„è·¯ç”±åœ°å€ predicates: - Path=/payment/lb/** # æ–­è¨€ï¼Œè·¯å¾„ç›¸åŒ¹é…çš„è¿›è¡Œè·¯ç”± uri + predicate æ‹¼æ¥å°±æ˜¯å…·ä½“çš„æ¥å£è¯·æ±‚è·¯å¾„ï¼Œé€šè¿‡ localhost:9527 æ˜ å°„çš„åœ°å€ predicate æ–­è¨€ http://localhost:8001ä¸‹é¢æœ‰ä¸€ä¸ª &#x2F;payment&#x2F;get&#x2F;** çš„åœ°å€ï¼Œå¦‚æœæ‰¾åˆ°äº†è¯¥åœ°å€å°±è¿”å› trueï¼Œå¯ä»¥ç”¨ 9527 ç«¯å£è®¿é—®ï¼Œè¿›è¡Œç«¯å£çš„é€‚é… ** è¡¨ç¤ºé€šé…ç¬¦ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªä¸ç¡®å®šçš„å‚æ•° æ³¨å…¥Beané€šè¿‡ 9527 ç½‘å…³è®¿é—®åˆ°ç™¾åº¦çš„ç½‘å€ https://www.baidu.com/ï¼Œåœ¨ config åŒ…ä¸‹åˆ›å»ºä¸€ä¸ªé…ç½®ç±»ï¼Œè·¯ç”±è§„åˆ™æ˜¯è®¿é—® &#x2F;baidu è·³è½¬åˆ°ç™¾åº¦ 12345678910111213@Configurationpublic class GatewayConfig &#123; // é…ç½®äº†ä¸€ä¸ª id ä¸º path_route_cloud çš„è·¯ç”±è§„åˆ™ @Bean public RouteLocator customRouteLocator(RouteLocatorBuilder routeLocatorBuilder)&#123; // æ„å»ºä¸€ä¸ªè·¯ç”±å™¨ï¼Œè¿™ä¸ªroutesç›¸å½“äºymlé…ç½®æ–‡ä»¶ä¸­çš„routes RouteLocatorBuilder.Builder routes = routeLocatorBuilder.routes(); // è·¯ç”±å™¨çš„idæ˜¯ï¼špath_route_cloudï¼Œè§„åˆ™æ˜¯è®¿é—®/baidu ï¼Œå°†ä¼šè½¬å‘åˆ° https://www.baidu.com/ routes.route(&quot;path_route_cloud&quot;, r -&gt; r.path(&quot;/baidu&quot;).uri(&quot; https://www.baidu.com&quot;)).build(); return routes.build(); &#125;&#125; åŠ¨æ€è·¯ç”±Gateway ä¼šæ ¹æ®æ³¨å†Œä¸­å¿ƒæ³¨å†Œçš„æœåŠ¡åˆ—è¡¨ï¼Œä»¥æ³¨å†Œä¸­å¿ƒä¸Šå¾®æœåŠ¡åä¸ºè·¯å¾„åˆ›å»ºåŠ¨æ€è·¯ç”±è¿›è¡Œè½¬å‘ï¼Œä»è€Œå®ç°åŠ¨æ€è·¯ç”±å’Œè´Ÿè½½å‡è¡¡ï¼Œé¿å…å‡ºç°ä¸€ä¸ªè·¯ç”±è§„åˆ™ä»…å¯¹åº”ä¸€ä¸ªæ¥å£æ–¹æ³•ï¼Œå½“è¯·æ±‚åœ°å€å¾ˆå¤šæ—¶éœ€è¦å¾ˆå¤§çš„é…ç½®æ–‡ä»¶ application.yml å¼€å¯åŠ¨æ€è·¯ç”±åŠŸèƒ½ 12345678910111213141516171819spring: application: name: cloud-gateway cloud: gateway: discovery: locator: enabled: true # å¼€å¯ä»æ³¨å†Œä¸­å¿ƒåŠ¨æ€åˆ›å»ºè·¯ç”±çš„åŠŸèƒ½ï¼Œåˆ©ç”¨å¾®æœåŠ¡åè¿›è¡Œè·¯ç”± routes: - id: payment_routh1 # è·¯ç”±çš„IDï¼Œæ²¡æœ‰å›ºå®šè§„åˆ™ä½†è¦æ±‚å”¯ä¸€ï¼Œå»ºè®®é…åˆæœåŠ¡å uri: lb://cloud-payment-service # åŒ¹é…åæä¾›æœåŠ¡çš„è·¯ç”±åœ°å€ predicates: - Path=/payment/get/** # æ–­è¨€ï¼Œè·¯å¾„ç›¸åŒ¹é…çš„è¿›è¡Œè·¯ç”± - id: payment_routh2 #è·¯ç”±çš„IDï¼Œæ²¡æœ‰å›ºå®šè§„åˆ™ä½†è¦æ±‚å”¯ä¸€ï¼Œå»ºè®®é…åˆæœåŠ¡å uri: lb://cloud-payment-service #åŒ¹é…åæä¾›æœåŠ¡çš„è·¯ç”±åœ°å€ predicates: - Path=/payment/lb/** # æ–­è¨€ï¼Œè·¯å¾„ç›¸åŒ¹é…çš„è¿›è¡Œè·¯ç”± - After=2021-09-28T19:14:51.514+08:00[Asia/Shanghai] lb:&#x2F;&#x2F; å¼€å¤´ä»£è¡¨ä»æ³¨å†Œä¸­å¿ƒä¸­è·å–æœåŠ¡ï¼Œåé¢æ˜¯éœ€è¦è½¬å‘åˆ°çš„æœåŠ¡åç§° æ–­è¨€ç±»å‹After Route Predicateï¼šåŒ¹é…è¯¥æ–­è¨€æ—¶é—´ä¹‹åçš„ URI è¯·æ±‚ è·å–æ—¶é—´ï¼š 123456public class TimeTest &#123; public static void main(String[] args) &#123; ZonedDateTime zbj = ZonedDateTime.now(); // é»˜è®¤æ—¶åŒº System.out.println(zbj); //2023-01-10T16:31:44.106+08:00[Asia/Shanghai] &#125;&#125; é…ç½® ymlï¼šåŠ¨æ€è·¯ç”±å°ç»“æœ‰é…ç½® æµ‹è¯•ï¼šæ­£å¸¸è®¿é—®æˆåŠŸï¼Œå°†æ—¶é—´ä¿®æ”¹åˆ° 2023-01-10T16:31:44.106+08:00[Asia&#x2F;Shanghai] ä¹‹åè®¿é—®å¤±è´¥ å¸¸è§æ–­è¨€ç±»å‹ï¼š Before Route Predicateï¼šåŒ¹é…è¯¥æ–­è¨€æ—¶é—´ä¹‹å‰çš„ URI è¯·æ±‚ Between Route Predicateï¼šåŒ¹é…è¯¥æ–­è¨€æ—¶é—´ä¹‹é—´çš„ URI è¯·æ±‚ 1- Between=2022-02-02T17:45:06.206+08:00[Asia/Shanghai],2022-03-25T18:59:06.206+08:00[Asia/Shanghai] Cookie Route Predicateï¼šCookie æ–­è¨€ï¼Œä¸¤ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ Cookie name å’Œæ­£åˆ™è¡¨è¾¾å¼ï¼Œè·¯ç”±è§„åˆ™ä¼šé€šè¿‡è·å–å¯¹åº”çš„ Cookie name å€¼å’Œæ­£åˆ™è¡¨è¾¾å¼å»åŒ¹é…ï¼Œå¦‚æœåŒ¹é…ä¸Šå°±ä¼šæ‰§è¡Œè·¯ç”± 1- Cookie=username, seazean # åªæœ‰å‘é€çš„è¯·æ±‚æœ‰ cookieï¼Œè€Œä¸”æœ‰username=seazeanè¿™ä¸ªæ•°æ®æ‰èƒ½è®¿é—®ï¼Œåä¹‹404 Header Route Predicateï¼šè¯·æ±‚å¤´æ–­è¨€ 1- Header=X-Request-Id, \\d+ # è¯·æ±‚å¤´è¦æœ‰ X-Request-Id å±æ€§ï¼Œå¹¶ä¸”å€¼ä¸ºæ•´æ•°çš„æ­£åˆ™è¡¨è¾¾å¼ Host Route Predicateï¼šæŒ‡å®šä¸»æœºå¯ä»¥è®¿é—®ï¼Œå¯ä»¥æŒ‡å®šå¤šä¸ªç”¨ , åˆ†éš”å¼€ 1- Host=**.seazean.com Method Route Predicateï¼šè¯·æ±‚ç±»å‹æ–­è¨€ 1- Method=GET # åªæœ‰ Get è¯·æ±‚æ‰èƒ½è®¿é—® Path Route Predicateï¼šè·¯å¾„åŒ¹é…æ–­è¨€ Query Route Predicateï¼šè¯·æ±‚å‚æ•°æ–­è¨€ 1- Query=username, \\d+ # è¦æœ‰å‚æ•°å username å¹¶ä¸”å€¼è¿˜è¦æ˜¯æ•´æ•°æ‰èƒ½è·¯ç”± Filterä½¿ç”¨Filter é“¾æ˜¯åŒæ—¶æ»¡è¶³ä¸€ç³»åˆ—çš„è¿‡æ»¤é“¾ï¼Œè·¯ç”±è¿‡æ»¤å™¨å¯ç”¨äºä¿®æ”¹è¿›å…¥çš„ HTTP è¯·æ±‚å’Œè¿”å›çš„ HTTP å“åº”ï¼Œè·¯ç”±è¿‡æ»¤å™¨åªèƒ½æŒ‡å®šè·¯ç”±è¿›è¡Œä½¿ç”¨ï¼ŒSpring Cloud Gateway å†…ç½®äº†å¤šç§è·¯ç”±è¿‡æ»¤å™¨ï¼Œéƒ½ç”± GatewayFilter çš„å·¥å‚ç±»æ¥äº§ç”Ÿ é…ç½®æ–‡ä»¶ï¼šhttps://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/#gatewayfilter-factories è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨ï¼šå®ç°ä¸¤ä¸ªä¸»è¦æ¥å£ GlobalFilter, Ordered 1234567891011121314151617181920212223242526272829@Component@Slf4jpublic class MyLogGateWayFilter implements GlobalFilter, Ordered &#123; @Override public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123; log.info(&quot;*********************come in MyLogGateWayFilter: &quot;+ new Date()); // å–å‡ºè¯·æ±‚å‚æ•°çš„unameå¯¹åº”çš„å€¼ String uname = exchange.getRequest().getQueryParams().getFirst(&quot;uname&quot;); // å¦‚æœ uname ä¸ºç©ºï¼Œå°±ç›´æ¥è¿‡æ»¤æ‰ï¼Œä¸èµ°è·¯ç”± if(uname == null)&#123; log.info(&quot;************* ç”¨æˆ·åä¸º NULL éæ³•ç”¨æˆ· o(â•¥ï¹â•¥)o&quot;); // åˆ¤æ–­è¯¥è¯·æ±‚ä¸é€šè¿‡æ—¶ï¼šç»™ä¸€ä¸ªå›åº”ï¼Œè¿”å› exchange.getResponse().setStatusCode(HttpStatus.NOT_ACCEPTABLE); return exchange.getResponse().setComplete(); &#125; // åä¹‹ï¼Œè°ƒç”¨ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œä¹Ÿå°±æ˜¯æ”¾è¡Œï¼šåœ¨è¯¥ç¯èŠ‚åˆ¤æ–­é€šè¿‡çš„ exchange æ”¾è¡Œï¼Œäº¤ç»™ä¸‹ä¸€ä¸ª filter åˆ¤æ–­ return chain.filter(exchange); &#125; // è®¾ç½®è¿™ä¸ªè¿‡æ»¤å™¨åœ¨Filteré“¾ä¸­çš„åŠ è½½é¡ºåºï¼Œæ•°å­—è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ @Override public int getOrder() &#123; return 0; &#125;&#125; æœåŠ¡é…ç½®configåŸºæœ¬ä»‹ç»SpringCloud Config ä¸ºå¾®æœåŠ¡æ¶æ„ä¸­çš„å¾®æœåŠ¡æä¾›é›†ä¸­åŒ–çš„å¤–éƒ¨é…ç½®æ”¯æŒï¼ˆGit&#x2F;GitHubï¼‰ï¼Œä¸ºå„ä¸ªä¸åŒå¾®æœåŠ¡åº”ç”¨çš„æ‰€æœ‰ç¯å¢ƒæä¾›äº†ä¸€ä¸ªä¸­å¿ƒåŒ–çš„å¤–éƒ¨é…ç½®ï¼ˆConfig Serverï¼‰ SpringCloud Config åˆ†ä¸ºæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¸¤éƒ¨åˆ† æœåŠ¡ç«¯ä¹Ÿç§°ä¸ºåˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒï¼Œæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¾®æœåŠ¡åº”ç”¨ï¼Œè¿æ¥é…ç½®æœåŠ¡å™¨å¹¶ä¸ºå®¢æˆ·ç«¯æä¾›è·å–é…ç½®ä¿¡æ¯ï¼ŒåŠ å¯†&#x2F;è§£å¯†ç­‰ä¿¡æ¯è®¿é—®æ¥å£ å®¢æˆ·ç«¯é€šè¿‡æŒ‡å®šçš„é…ç½®ä¸­å¿ƒæ¥ç®¡ç†åº”ç”¨èµ„æºï¼Œä»¥åŠä¸ä¸šåŠ¡ç›¸å…³çš„é…ç½®å†…å®¹ï¼Œå¹¶åœ¨å¯åŠ¨æ—¶ä»é…ç½®ä¸­å¿ƒè·å–å’ŒåŠ è½½é…ç½®ä¿¡æ¯ï¼Œé…ç½®æœåŠ¡å™¨é»˜è®¤é‡‡ç”¨ Git æ¥å­˜å‚¨é…ç½®ä¿¡æ¯ï¼Œè¿™æ ·æ—¢æœ‰åŠ©äºå¯¹ç¯å¢ƒé…ç½®è¿›è¡Œç‰ˆæœ¬ç®¡ç†ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Git å®¢æˆ·ç«¯æ¥æ–¹ä¾¿çš„ç®¡ç†å’Œè®¿é—®é…ç½®å†…å®¹ ä¼˜ç‚¹ï¼š é›†ä¸­ç®¡ç†é…ç½®æ–‡ä»¶ ä¸åŒç¯å¢ƒä¸åŒé…ç½®ï¼ŒåŠ¨æ€åŒ–çš„é…ç½®æ›´æ–°ï¼Œåˆ†ç¯å¢ƒéƒ¨ç½²æ¯”å¦‚ dev&#x2F;test&#x2F;prod&#x2F;beta&#x2F;release è¿è¡ŒæœŸé—´åŠ¨æ€è°ƒæ•´é…ç½®ï¼ŒæœåŠ¡å‘é…ç½®ä¸­å¿ƒç»Ÿä¸€æ‹‰å–é…ç½®çš„ä¿¡æ¯ï¼ŒæœåŠ¡ä¸éœ€è¦é‡å¯å³å¯æ„ŸçŸ¥åˆ°é…ç½®çš„å˜åŒ–å¹¶åº”ç”¨æ–°çš„é…ç½® å°†é…ç½®ä¿¡æ¯ä»¥ Rest æ¥å£çš„å½¢å¼æš´éœ² å®˜ç½‘ï¼š https://cloud.spring.io/spring-cloud-static/spring-cloud-config/2.2.1.RELEASE/reference/html/ æœåŠ¡ç«¯æ„å»º Config Server æ¨¡å— å¼•å…¥ pom ä¾èµ–ï¼š 12345&lt;!--springCloud Config Server--&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt;&lt;/dependency&gt; application.ymlï¼š 123456789101112131415161718192021222324server: port: 3344spring: application: name: cloud-config-center #æ³¨å†Œè¿›EurekaæœåŠ¡å™¨çš„å¾®æœåŠ¡å cloud: config: server: git: # GitHubä¸Šé¢çš„gitä»“åº“åå­— è¿™é‡Œå¯ä»¥å†™httpsåœ°å€è·Ÿsshåœ°å€ï¼Œhttpsåœ°å€éœ€è¦é…ç½®usernameå’Œ password uri: git@github.com:seazean/springcloud-config.git default-label: main search-paths: - springcloud-config # æœç´¢ç›®å½• # username: # password: label: main # è¯»å–åˆ†æ”¯,ä»¥å‰æ˜¯master#æœåŠ¡æ³¨å†Œåˆ°eurekaåœ°å€eureka: client: service-url: defaultZone: http://localhost:7001/eureka,http://localhost:7002/eureka #é›†ç¾¤ç‰ˆ search-paths è¡¨ç¤ºè¿œç¨‹ä»“åº“ä¸‹æœ‰ä¸€ä¸ªå«åš springcloud-config çš„ï¼Œlabel åˆ™è¡¨ç¤ºè¯»å– mainåˆ†æ”¯é‡Œé¢çš„å†…å®¹ ä¸»å¯åŠ¨ç±»ï¼š 12345678@SpringBootApplication@EnableEurekaClient@EnableConfigServer //å¼€å¯SpringCloudçš„public class ConfigCenterMain3344 &#123; public static void main(String[] args) &#123; SpringApplication.run(ConfigCenterMain3344.class, args); &#125;&#125; é…ç½®è¯»å–è§„åˆ™ï¼š 12345/&#123;application&#125;/&#123;profile&#125;[/&#123;label&#125;]/&#123;application&#125;-&#123;profile&#125;.yml/&#123;label&#125;/&#123;application&#125;-&#123;profile&#125;.yml/&#123;application&#125;-&#123;profile&#125;.properties/&#123;label&#125;/&#123;application&#125;-&#123;profile&#125;.properties labelï¼šåˆ†æ”¯ nameï¼šæœåŠ¡å profileï¼šç¯å¢ƒï¼ˆdev&#x2F;test&#x2F;prodï¼‰ æ¯”å¦‚ï¼šhttp://localhost:3344/master/config-dev.yaml å®¢æˆ·ç«¯åŸºæœ¬é…ç½®é…ç½®å®¢æˆ·ç«¯ Config Clientï¼Œå®¢æˆ·ç«¯ä»é…ç½®ä¸­å¿ƒï¼ˆConfig Serverï¼‰è·å–é…ç½®ä¿¡æ¯ å¼•å…¥ pom ä¾èµ–ï¼š 12345&lt;!--è¿™é‡Œå°±æ˜¯å®¢æˆ·ç«¯çš„SpringCloud config å› ä¸ºæ˜¯å®¢æˆ·ç«¯æ‰€ä»¥æ²¡æœ‰server--&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt;&lt;/dependency&gt; bootstrap.ymlï¼šç³»ç»Ÿçº§é…ç½®ï¼Œä¼˜å…ˆçº§æ›´é«˜ï¼Œapplication.yml æ˜¯ç”¨æˆ·çº§çš„èµ„æºé…ç½®é¡¹ Spring Cloud ä¼šåˆ›å»ºä¸€ä¸ª Bootstrap Context ä½œä¸º Spring åº”ç”¨çš„ Application Context çš„çˆ¶ä¸Šä¸‹æ–‡ï¼Œåˆå§‹åŒ–çš„æ—¶å€™ Bootstrap Context è´Ÿè´£ä»å¤–éƒ¨æºåŠ è½½é…ç½®å±æ€§å¹¶è§£æé…ç½®ï¼Œè¿™ä¸¤ä¸ªä¸Šä¸‹æ–‡å…±äº«ä¸€ä¸ªä»å¤–éƒ¨è·å–çš„ Environmentï¼Œä¸ºäº†é…ç½®æ–‡ä»¶çš„åŠ è½½é¡ºåºå’Œåˆ†çº§ç®¡ç†ï¼Œè¿™é‡Œä½¿ç”¨ bootstrap.yml 1234567891011121314151617181920server: port: 3355 # æ„å»ºå¤šä¸ªå¾®æœåŠ¡ï¼Œ3366 3377 ç­‰spring: application: name: config-client cloud: #Configå®¢æˆ·ç«¯é…ç½® config: label: main #åˆ†æ”¯åç§° ä»¥å‰æ˜¯master name: config #é…ç½®æ–‡ä»¶åç§° profile: dev #è¯»å–åç¼€åç§° # mainåˆ†æ”¯ä¸Šconfig-dev.ymlçš„é…ç½®æ–‡ä»¶è¢«è¯»å– http://config-3344.com:3344/master/config-dev.yml uri: http://localhost:3344 # é…ç½®ä¸­å¿ƒåœ°å€k#æœåŠ¡æ³¨å†Œåˆ°eurekaåœ°å€eureka: client: service-url: defaultZone: http://localhost:7001/eureka,http://localhost:7002/eureka ä¸»å¯åŠ¨ç±»ï¼š 1234567@SpringBootApplication@EnableEurekaClientpublic class ConfigClientMain3355 &#123; public static void main(String[] args) &#123; SpringApplication.run(ConfigClientMain3355.class, args); &#125;&#125; ä¸šåŠ¡ç±»ï¼šå°†é…ç½®ä¿¡æ¯ä»¥ REST çª—å£çš„å½¢å¼æš´éœ² 12345678910@RestControllerpublic class ConfigClientController &#123; @Value(&quot;$&#123;config.info&#125;&quot;) private String configInfo; @GetMapping(&quot;/configInfo&quot;) public String getConfigInfo() &#123; return configInfo; &#125;&#125; åŠ¨æ€åˆ·æ–°åˆ†å¸ƒå¼é…ç½®çš„åŠ¨æ€åˆ·æ–°é—®é¢˜ï¼Œä¿®æ”¹ GitHub ä¸Šçš„é…ç½®æ–‡ä»¶ï¼ŒConfig Server é…ç½®ä¸­å¿ƒç«‹åˆ»å“åº”ï¼Œä½†æ˜¯ Config Client å®¢æˆ·ç«¯æ²¡æœ‰ä»»ä½•å“åº”ï¼Œéœ€è¦é‡å¯å®¢æˆ·ç«¯ å¼•å…¥ pom ä¾èµ–ï¼š 123456789&lt;!--web/actuatorè¿™ä¸¤ä¸ªä¸€èˆ¬ä¸€èµ·ä½¿ç”¨ï¼Œå†™åœ¨ä¸€èµ·--&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;&lt;/dependency&gt; ä¿®æ”¹ ymlï¼Œæš´éœ²ç›‘æ§ç«¯å£ï¼šSpringBoot çš„ actuator å¯åŠ¨ç«¯ç‚¹ç›‘æ§ Web ç«¯é»˜è®¤åŠ è½½é»˜è®¤åªæœ‰ä¸¤ä¸ª infoï¼Œhealth å¯è§çš„é¡µé¢èŠ‚ç‚¹ 123456management: endpoints: web: exposure: include: &quot;*&quot; # è¡¨ç¤ºåŒ…å«æ‰€æœ‰èŠ‚ç‚¹é¡µé¢ exclude: env,beans # è¡¨ç¤ºæ’é™¤envã€beans ä¸šåŠ¡ç±»ï¼šåŠ  @RefreshScope æ³¨è§£ 123456789101112@RestController@RefreshScopepublic class ConfigClientController &#123; // ä»é…ç½®æ–‡ä»¶ä¸­å–å‰ç¼€ä¸ºserver.portçš„å€¼ @Value(&quot;$&#123;config.info&#125;&quot;) private String configInfo; // config-&#123;profile&#125;.yml @GetMapping(&quot;/configInfo&quot;) public String getConfigInfo() &#123; return configInfo; &#125;&#125; æ­¤æ—¶å®¢æˆ·ç«¯è¿˜æ˜¯æ²¡æœ‰åˆ·æ–°ï¼Œéœ€è¦å‘é€ POST è¯·æ±‚åˆ·æ–° 3355ï¼šcurl -X POST &quot;http://localhost:3355/actuator/refresh å¼•å‡ºé—®é¢˜ï¼š åœ¨å¾®æœåŠ¡å¤šçš„æƒ…å†µä¸‹ï¼Œæ¯ä¸ªå¾®æœåŠ¡éƒ½éœ€è¦æ‰§è¡Œä¸€ä¸ª POST è¯·æ±‚ï¼Œæ‰‹åŠ¨åˆ·æ–°æˆæœ¬å¤ªå¤§ å¯å¦å¹¿æ’­ï¼Œä¸€æ¬¡é€šçŸ¥ï¼Œå¤„å¤„ç”Ÿæ•ˆï¼Œå¤§èŒƒå›´çš„å®ç°è‡ªåŠ¨åˆ·æ–° è§£å†³æ–¹æ³•ï¼šBus æ€»çº¿ æœåŠ¡æ¶ˆæ¯BusåŸºæœ¬ä»‹ç»Spring Cloud Bus èƒ½ç®¡ç†å’Œä¼ æ’­åˆ†å¸ƒå¼ç³»ç»Ÿé—´çš„æ¶ˆæ¯ï¼Œå°±åƒåˆ†å¸ƒå¼æ‰§è¡Œå™¨ï¼Œå¯ç”¨äºå¹¿æ’­çŠ¶æ€æ›´æ”¹ã€äº‹ä»¶æ¨é€ã€å¾®æœåŠ¡é—´çš„é€šä¿¡é€šé“ç­‰ æ¶ˆæ¯æ€»çº¿ï¼šåœ¨å¾®æœåŠ¡æ¶æ„çš„ç³»ç»Ÿä¸­ï¼Œé€šå¸¸ä¼šä½¿ç”¨è½»é‡çº§çš„æ¶ˆæ¯ä»£ç†æ¥æ„å»ºä¸€ä¸ªå…±ç”¨çš„æ¶ˆæ¯ä¸»é¢˜ï¼Œå¹¶è®©ç³»ç»Ÿä¸­æ‰€æœ‰å¾®æœåŠ¡å®ä¾‹éƒ½è¿æ¥ä¸Šæ¥ã€‚ç”±äºè¯¥ä¸»é¢˜ä¸­äº§ç”Ÿçš„æ¶ˆæ¯ä¼šè¢«æ‰€æœ‰å®ä¾‹ç›‘å¬å’Œæ¶ˆè´¹ï¼Œæ‰€ä»¥ç§°ä¸ºæ¶ˆæ¯æ€»çº¿ åŸºæœ¬åŸç†ï¼šConfigClient å®ä¾‹éƒ½ç›‘å¬ MQ ä¸­åŒä¸€ä¸ª Topicï¼ˆé»˜è®¤ springCloudBus)ï¼Œå½“ä¸€ä¸ªæœåŠ¡åˆ·æ–°æ•°æ®æ—¶ï¼Œä¼šæŠŠä¿¡æ¯æ”¾å…¥ Topic ä¸­ï¼Œè¿™æ ·å…¶å®ƒç›‘å¬åŒä¸€ Topic çš„æœåŠ¡å°±èƒ½å¾—åˆ°é€šçŸ¥ï¼Œç„¶åå»æ›´æ–°è‡ªèº«çš„é…ç½® å…¨å±€å¹¿æ’­åˆ©ç”¨æ¶ˆæ¯æ€»çº¿æ¥è§¦ä¸€ä¸ªæœåŠ¡ç«¯ ConfigServer çš„ /bus/refresh æ–­ç‚¹ï¼Œä»è€Œåˆ·æ–°æ‰€æœ‰å®¢æˆ·ç«¯çš„é…ç½® æ”¹é€  ConfigClientï¼š å¼•å…¥ MQ çš„ä¾èµ–ï¼š 12345&lt;!--æ·»åŠ æ¶ˆæ¯æ€»çº¿RabbitMQæ”¯æŒ--&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-bus-amqp&lt;/artifactId&gt;&lt;/dependency&gt; yml æ–‡ä»¶æ·»åŠ  MQ ä¿¡æ¯ï¼š 1234567891011121314151617181920server: port: 3344spring: application: name: config-client #æ³¨å†Œè¿›EurekaæœåŠ¡å™¨çš„å¾®æœåŠ¡å cloud: # rabbitmqç›¸å…³é…ç½® rabbitmq: host: localhost port: 5672 username: guest password: guest# rabbitmqç›¸å…³é…ç½®,æš´éœ²busåˆ·æ–°é…ç½®çš„ç«¯ç‚¹management: endpoints: # æš´éœ²busåˆ·æ–°é…ç½®çš„ç«¯ç‚¹ web: exposure: include: &#x27;bus-refresh&#x27; åªéœ€è¦è°ƒç”¨ä¸€æ¬¡ curl -X POST &quot;http://localhost:3344/actuator/bus-refreshï¼Œå¯ä»¥å®ç°å…¨å±€å¹¿æ’­ å®šç‚¹é€šçŸ¥åŠ¨æ€åˆ·æ–°æƒ…å†µä¸‹ï¼Œåªé€šçŸ¥æŒ‡å®šçš„å¾®æœåŠ¡ï¼Œæ¯”å¦‚åªé€šçŸ¥ 3355 æœåŠ¡ï¼Œä¸é€šçŸ¥ 3366ï¼ŒæŒ‡å®šå…·ä½“æŸä¸€ä¸ªå®ä¾‹ç”Ÿæ•ˆï¼Œè€Œä¸æ˜¯å…¨éƒ¨ å…¬å¼ï¼šhttp://localhost:port/actuator/bus-refresh/&#123;destination&#125; &#x2F;bus&#x2F;refresh è¯·æ±‚ä¸å†å‘é€åˆ°å…·ä½“çš„æœåŠ¡å®ä¾‹ä¸Šï¼Œè€Œæ˜¯å‘ç»™ Config Server å¹¶é€šè¿‡ destination å‚æ•°ç±»æŒ‡å®šéœ€è¦æ›´æ–°é…ç½®çš„æœåŠ¡æˆ–å®ä¾‹ StreamåŸºæœ¬ä»‹ç»Spring Cloud Stream æ˜¯ä¸€ä¸ªæ„å»ºæ¶ˆæ¯é©±åŠ¨å¾®æœåŠ¡çš„æ¡†æ¶ï¼Œé€šè¿‡å®šä¹‰ç»‘å®šå™¨ Binder ä½œä¸ºä¸­é—´å±‚ï¼Œå®ç°äº†åº”ç”¨ç¨‹åºä¸æ¶ˆæ¯ä¸­é—´ä»¶ç»†èŠ‚ä¹‹é—´çš„éš”ç¦»ï¼Œå±è”½åº•å±‚æ¶ˆæ¯ä¸­é—´ä»¶çš„å·®å¼‚ï¼Œé™ä½åˆ‡æ¢æˆæœ¬ï¼Œç»Ÿä¸€æ¶ˆæ¯çš„ç¼–ç¨‹æ¨¡å‹ Stream ä¸­çš„æ¶ˆæ¯é€šä¿¡æ–¹å¼éµå¾ªäº†å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼ŒBinder å¯ä»¥ç”Ÿæˆ Binding ç”¨æ¥ç»‘å®šæ¶ˆæ¯å®¹å™¨çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼ŒBinding æœ‰ä¸¤ç§ç±»å‹ Input å’Œ Outputï¼ŒInput å¯¹åº”äºæ¶ˆè´¹è€…ï¼ˆæ¶ˆè´¹è€…ä» Stream æ¥æ”¶æ¶ˆæ¯ï¼‰ï¼ŒOutput å¯¹åº”äºç”Ÿäº§è€…ï¼ˆç”Ÿäº§è€…ä» Stream å‘å¸ƒæ¶ˆæ¯ï¼‰ Binderï¼šè¿æ¥ä¸­é—´ä»¶ Channelï¼šé€šé“ï¼Œæ˜¯é˜Ÿåˆ— Queue çš„ä¸€ç§æŠ½è±¡ï¼Œåœ¨æ¶ˆæ¯é€šè®¯ç³»ç»Ÿä¸­å®ç°å­˜å‚¨å’Œè½¬å‘çš„åª’ä»‹ï¼Œé€šè¿‡ Channel å¯¹é˜Ÿåˆ—è¿›è¡Œé…ç½® Sourceã€Sinkï¼šç”Ÿäº§è€…å’Œæ¶ˆè´¹è€… ä¸­æ–‡æ‰‹å†Œï¼šhttps://m.wang1314.com/doc/webapp/topic/20971999.html åŸºæœ¬ä½¿ç”¨Binder æ˜¯åº”ç”¨ä¸æ¶ˆæ¯ä¸­é—´ä»¶ä¹‹é—´çš„å°è£…ï¼Œç›®å‰å®ç°äº† Kafka å’Œ RabbitMQ çš„ Binderï¼Œå¯ä»¥åŠ¨æ€çš„æ”¹å˜æ¶ˆæ¯ç±»å‹ï¼ˆKafka çš„ Topic å’Œ RabbitMQ çš„ Exchangeï¼‰ï¼Œå¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶å®ç°ï¼Œå¸¸ç”¨æ³¨è§£å¦‚ä¸‹ï¼š @Inputï¼šæ ‡è¯†è¾“å…¥é€šé“ï¼Œæ¥æ”¶çš„æ¶ˆæ¯é€šè¿‡è¯¥é€šé“è¿›å…¥åº”ç”¨ç¨‹åº @Outputï¼šæ ‡è¯†è¾“å‡ºé€šé“ï¼Œå‘å¸ƒçš„æ¶ˆæ¯é€šè¿‡è¯¥é€šé“ç¦»å¼€åº”ç”¨ç¨‹åº @StreamListenerï¼šç›‘å¬é˜Ÿåˆ—ï¼Œç”¨äºæ¶ˆè´¹è€…é˜Ÿåˆ—çš„æ¶ˆæ¯æ¥æ”¶ @EnableBindingï¼šä¿¡é“ Channel å’Œ Exchange ç»‘å®š ç”Ÿäº§è€…å‘æ¶ˆæ¯æ¨¡å—ï¼š å¼•å…¥ pom ä¾èµ–ï¼šRabbitMQ 1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-stream-rabbit&lt;/artifactId&gt;&lt;/dependency&gt; application.ymlï¼š 123456789101112131415161718192021222324252627282930313233server: port: 8801spring: application: name: cloud-stream-provider cloud: stream: binders: # åœ¨æ­¤å¤„é…ç½®è¦ç»‘å®šçš„rabbitmqçš„æœåŠ¡ä¿¡æ¯ï¼› defaultRabbit: # è¡¨ç¤ºå®šä¹‰çš„åç§°ï¼Œç”¨äºäºbindingæ•´åˆ type: rabbit # æ¶ˆæ¯ç»„ä»¶ç±»å‹ environment: # è®¾ç½®rabbitmqçš„ç›¸å…³çš„ç¯å¢ƒé…ç½® spring: rabbitmq: host: localhost port: 5672 username: guest password: guest bindings: # æœåŠ¡çš„æ•´åˆå¤„ç† output: # è¿™ä¸ªåå­—æ˜¯ä¸€ä¸ªé€šé“çš„åç§° destination: studyExchange # è¡¨ç¤ºè¦ä½¿ç”¨çš„Exchangeåç§°å®šä¹‰ content-type: application/json # è®¾ç½®æ¶ˆæ¯ç±»å‹ï¼Œæœ¬æ¬¡ä¸ºjsonï¼Œæ–‡æœ¬åˆ™è®¾ç½®â€œtext/plainâ€ binder: defaultRabbit # è®¾ç½®è¦ç»‘å®šçš„æ¶ˆæ¯æœåŠ¡çš„å…·ä½“è®¾ç½®eureka: client: # å®¢æˆ·ç«¯è¿›è¡ŒEurekaæ³¨å†Œçš„é…ç½® service-url: defaultZone: http://localhost:7001/eureka,http://localhost:7002/eureka instance: lease-renewal-interval-in-seconds: 2 # è®¾ç½®å¿ƒè·³çš„æ—¶é—´é—´éš”ï¼ˆé»˜è®¤æ˜¯30ç§’ï¼‰ lease-expiration-duration-in-seconds: 5 # å¦‚æœç°åœ¨è¶…è¿‡äº†5ç§’çš„é—´éš”ï¼ˆé»˜è®¤æ˜¯90ç§’ï¼‰ instance-id: send-8801.com # åœ¨ä¿¡æ¯åˆ—è¡¨æ—¶æ˜¾ç¤ºä¸»æœºåç§° prefer-ip-address: true # è®¿é—®çš„è·¯å¾„å˜ä¸ºIPåœ°å€ ä¸»å¯åŠ¨ç±»ï¼š 1234567@SpringBootApplication@EnableEurekaClientpublic class StreamMQMain8801 &#123; public static void main(String[] args) &#123; SpringApplication.run(StreamMQMain8801.class, args); &#125;&#125; ä¸šåŠ¡ç±»ï¼šMessageChannel çš„å®ä¾‹åå¿…é¡»æ˜¯ outputï¼Œå¦åˆ™æ— æ³•å¯åŠ¨ 123456789101112131415161718// å¯ä»¥ç†è§£ä¸ºå®šä¹‰æ¶ˆæ¯çš„å‘é€ç®¡é“Sourceå¯¹åº”output(ç”Ÿäº§è€…)ï¼ŒSinkå¯¹åº”input(æ¶ˆè´¹è€…)@EnableBinding(Source.class)// @Serviceï¼šè¿™é‡Œä¸éœ€è¦ï¼Œä¸æ˜¯ä¼ ç»Ÿçš„controllerè°ƒç”¨serviceã€‚è¿™ä¸ªserviceæ˜¯å’ŒrabbitMQæ‰“äº¤é“çš„// IMessageProvider åªæœ‰ä¸€ä¸ª send æ–¹æ³•çš„æ¥å£public class MessageProviderImpl implements IMessageProvider &#123; @Resource private MessageChannel output; // æ¶ˆæ¯çš„å‘é€ç®¡é“ @Override public String send() &#123; String serial = UUID.randomUUID().toString(); //åˆ›å»ºæ¶ˆæ¯ï¼Œé€šè¿‡outputè¿™ä¸ªç®¡é“å‘æ¶ˆæ¯ä¸­é—´ä»¶å‘æ¶ˆæ¯ this.output.send(MessageBuilder.withPayload(serial).build()); System.out.println(&quot;***serial: &quot; + serial); return serial; &#125;&#125; Controllerï¼š 12345678910@RestControllerpublic class SendMessageController &#123; @Resource private IMessageProvider messageProvider; @GetMapping(value = &quot;/sendMessage&quot;) public String sendMessage() &#123; return messageProvider.send(); &#125;&#125; æ¶ˆè´¹è€…æ¨¡å—ï¼š8802 å’Œ 8803 ä¸¤ä¸ªæ¶ˆè´¹è€… application.ymlï¼šåªæ ‡æ³¨å‡ºä¸ç”Ÿäº§è€…ä¸åŒçš„åœ°æ–¹ 12345678910111213141516171819server: port: 8802spring: application: name: cloud-stream-consumer cloud: stream: # ... bindings: # æœåŠ¡çš„æ•´åˆå¤„ç† input: # è¿™ä¸ªåå­—æ˜¯ä¸€ä¸ªé€šé“çš„åç§° # ... binder: &#123; defaultRabbit &#125; # è®¾ç½®è¦ç»‘å®šçš„æ¶ˆæ¯æœåŠ¡çš„å…·ä½“è®¾ç½®eureka: # ... instance: # ... instance-id: receive-8802.com # åœ¨ä¿¡æ¯åˆ—è¡¨æ—¶æ˜¾ç¤ºä¸»æœºåç§° Controllerï¼š 12345678910111213@Component@EnableBinding(Sink.class) // ç†è§£ä¸ºå®šä¹‰ä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹è€…çš„æ¥æ”¶ç®¡é“public class ReceiveMessageListener &#123; @Value(&quot;$&#123;server.port&#125;&quot;) private String serverPort; @StreamListener(Sink.INPUT) //è¾“å…¥æºï¼šä½œä¸ºä¸€ä¸ªæ¶ˆæ¯ç›‘å¬è€… public void input(Message&lt;String&gt; message) &#123; // è·å–åˆ°æ¶ˆæ¯ String messageStr = message.getPayload(); System.out.println(&quot;æ¶ˆè´¹è€…1å·ï¼Œ-------&gt;æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼š&quot; + messageStr + &quot;\\t port: &quot; + serverPort); &#125;&#125; é«˜çº§ç‰¹æ€§é‡å¤æ¶ˆè´¹é—®é¢˜ï¼šç”Ÿäº§è€… 8801 å‘é€ä¸€æ¡æ¶ˆæ¯åï¼Œ8802 å’Œ 8803 ä¼šåŒæ—¶æ”¶åˆ° 8801 çš„æ¶ˆæ¯ è§£å†³æ–¹æ³•ï¼šå¾®æœåŠ¡åº”ç”¨æ”¾ç½®äºåŒä¸€ä¸ª group ä¸­ï¼Œèƒ½å¤Ÿä¿è¯æ¶ˆæ¯åªä¼šè¢«å…¶ä¸­ä¸€ä¸ªåº”ç”¨æ¶ˆè´¹ä¸€æ¬¡ã€‚ä¸åŒçš„ç»„æ˜¯å¯ä»¥å…¨é¢æ¶ˆè´¹çš„ï¼ˆé‡å¤æ¶ˆè´¹ï¼‰ï¼ŒåŒä¸€ä¸ªç»„å†…çš„å¤šä¸ªæ¶ˆè´¹è€…ä¼šå‘ç”Ÿç«äº‰å…³ç³»ï¼Œåªæœ‰å…¶ä¸­ä¸€ä¸ªå¯ä»¥æ¶ˆè´¹ 123456bindings: input: destination: studyExchange content-type: application/json binder: &#123; defaultRabbit &#125; group: seazean # è®¾ç½®åˆ†ç»„ æ¶ˆæ¯æŒä¹…åŒ–é—®é¢˜ï¼š åœæ­¢ 8802&#x2F;8803 å¹¶å»é™¤æ‰ 8802 çš„åˆ†ç»„ group: seazeanï¼Œ8801 å…ˆå‘é€ 4 æ¡æ¶ˆæ¯åˆ° MQ å…ˆå¯åŠ¨ 8802ï¼Œæ— åˆ†ç»„å±æ€§é…ç½®ï¼Œåå°æ²¡æœ‰æ‰“å‡ºæ¥æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä¸¢å¤± å†å¯åŠ¨ 8803ï¼Œæœ‰åˆ†ç»„å±æ€§é…ç½®ï¼Œåå°æ‰“å°å‡ºæ¥äº† MQ ä¸Šçš„æ¶ˆæ¯ SleuthåŸºæœ¬ä»‹ç»Spring Cloud Sleuth æä¾›äº†ä¸€å¥—å®Œæ•´çš„åˆ†å¸ƒå¼è¯·æ±‚é“¾è·¯è·Ÿè¸ªçš„è§£å†³æ–¹æ¡ˆï¼Œå¹¶ä¸”å…¼å®¹æ”¯æŒäº† zipkin åœ¨å¾®æœåŠ¡æ¡†æ¶ä¸­ï¼Œä¸€ä¸ªå®¢æˆ·ç«¯å‘èµ·çš„è¯·æ±‚åœ¨åç«¯ç³»ç»Ÿä¸­ä¼šç»è¿‡å¤šæ¬¡ä¸åŒçš„æœåŠ¡èŠ‚ç‚¹è°ƒç”¨æ¥ååŒäº§ç”Ÿæœ€åçš„è¯·æ±‚ç»“æœï¼Œå½¢æˆä¸€æ¡å¤æ‚çš„åˆ†å¸ƒå¼æœåŠ¡è°ƒç”¨é“¾è·¯ï¼Œé“¾è·¯ä¸­çš„ä»»ä½•ä¸€ç¯å‡ºç°é«˜å»¶æ—¶æˆ–é”™è¯¯éƒ½ä¼šå¼•èµ·æ•´ä¸ªè¯·æ±‚æœ€åçš„å¤±è´¥ï¼Œæ‰€ä»¥éœ€è¦é“¾è·¯è¿½è¸ª Sleuth å®˜ç½‘ï¼šhttps://github.com/spring-cloud/spring-cloud-sleuth zipkin ä¸‹è½½åœ°å€ï¼šhttps://repo1.maven.org/maven2/io/zipkin/java/zipkin-server/ é“¾è·¯ç›‘æ§Sleuth è´Ÿè´£è·Ÿè¸ªæ•´ç†ï¼Œzipkin è´Ÿè´£å¯è§†åŒ–å±•ç¤º 1java -jar zipkin-server-2.12.9-exec.jar # å¯åŠ¨ zipkin è®¿é—® http://localhost:9411/zipkin/ å±•ç¤ºäº¤äº’ç•Œé¢ ä¸€æ¡è¯·æ±‚é“¾è·¯é€šè¿‡ Trace ID å”¯ä¸€æ ‡è¯†ï¼ŒSpan æ ‡è¯†å‘èµ·çš„è¯·æ±‚ä¿¡æ¯ Traceï¼šç±»ä¼¼äºæ ‘ç»“æ„çš„ Span é›†åˆï¼Œè¡¨ç¤ºä¸€æ¡è°ƒç”¨é“¾è·¯ï¼Œå­˜åœ¨å”¯ä¸€ ID æ ‡è¯† Spanï¼šè¡¨ç¤ºè°ƒç”¨é“¾è·¯æ¥æºï¼Œé€šä¿—çš„ç†è§£ Span å°±æ˜¯ä¸€æ¬¡è¯·æ±‚ä¿¡æ¯ï¼Œå„ä¸ª Span é€šè¿‡ ParentID å…³è”èµ·æ¥ æœåŠ¡ç”Ÿäº§è€…æ¨¡å—ï¼š å¼•å…¥ pom ä¾èµ–ï¼š 12345&lt;!--åŒ…å«äº†sleuth+zipkin--&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-zipkin&lt;/artifactId&gt;&lt;/dependency&gt; application.ymlï¼š 123456789101112server: port: 8001spring: application: name: cloud-payment-service zipkin: base-url: http://localhost:9411 sleuth: sampler: #é‡‡æ ·ç‡å€¼ä»‹äº 0 åˆ° 1 ä¹‹é—´ï¼Œ1 åˆ™è¡¨ç¤ºå…¨éƒ¨é‡‡é›† probability: 1 ä¸šåŠ¡ç±»ï¼š 1234@GetMapping(&quot;/payment/zipkin&quot;)public String paymentZipkin() &#123; return &quot;hi ,i&#x27;am paymentzipkin server fall backï¼Œwelcome to seazean&quot;;&#125; æœåŠ¡æ¶ˆè´¹è€…æ¨¡å—ï¼š application.ymlï¼š 123456789101112server: port: 80# å¾®æœåŠ¡åç§°spring: application: name: cloud-order-service zipkin: base-url: http://localhost:9411 sleuth: sampler: probability: 1 ä¸šåŠ¡ç±»ï¼š 12345@GetMapping(&quot;/comsumer/payment/zipkin&quot;)public String paymentZipKin() &#123; String result = restTemplate.getForObject(&quot;http://localhost:8001&quot; + &quot;/payment/zipkin/&quot;, String.class); return result;&#125; AlibabaSpring Cloud Alibaba è‡´åŠ›äºæä¾›å¾®æœåŠ¡å¼€å‘çš„ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆï¼Œæ­¤é¡¹ç›®åŒ…å«å¼€å‘åˆ†å¸ƒå¼åº”ç”¨å¾®æœåŠ¡çš„å¿…éœ€ç»„ä»¶ï¼Œæ–¹ä¾¿å¼€å‘è€…é€šè¿‡ Spring Cloud ç¼–ç¨‹æ¨¡å‹è½»æ¾ä½¿ç”¨è¿™äº›ç»„ä»¶æ¥å¼€å‘åˆ†å¸ƒå¼åº”ç”¨æœåŠ¡ æœåŠ¡é™æµé™çº§ï¼šé»˜è®¤æ”¯æŒ WebServletã€WebFluxã€OpenFeignã€RestTemplateã€Spring Cloud Gatewayã€Zuulã€Dubbo å’Œ RocketMQ é™æµé™çº§åŠŸèƒ½çš„æ¥å…¥ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶é€šè¿‡æ§åˆ¶å°å®æ—¶ä¿®æ”¹é™æµé™çº§è§„åˆ™ï¼Œè¿˜æ”¯æŒæŸ¥çœ‹é™æµé™çº§ Metrics ç›‘æ§ã€‚ æœåŠ¡æ³¨å†Œä¸å‘ç°ï¼šé€‚é… Spring Cloud æœåŠ¡æ³¨å†Œä¸å‘ç°æ ‡å‡†ï¼Œé»˜è®¤é›†æˆäº† Ribbon çš„æ”¯æŒ åˆ†å¸ƒå¼é…ç½®ç®¡ç†ï¼šæ”¯æŒåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å¤–éƒ¨åŒ–é…ç½®ï¼Œé…ç½®æ›´æ”¹æ—¶è‡ªåŠ¨åˆ·æ–° æ¶ˆæ¯é©±åŠ¨èƒ½åŠ›ï¼šåŸºäº Spring Cloud Stream ä¸ºå¾®æœåŠ¡åº”ç”¨æ„å»ºæ¶ˆæ¯é©±åŠ¨èƒ½åŠ› åˆ†å¸ƒå¼äº‹åŠ¡ï¼šä½¿ç”¨ @GlobalTransactional æ³¨è§£ï¼Œ é«˜æ•ˆå¹¶ä¸”å¯¹ä¸šåŠ¡é›¶ä¾µå…¥åœ°è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ é˜¿é‡Œäº‘å¯¹è±¡å­˜å‚¨ï¼šé˜¿é‡Œäº‘æä¾›çš„æµ·é‡ã€å®‰å…¨ã€ä½æˆæœ¬ã€é«˜å¯é çš„äº‘å­˜å‚¨æœåŠ¡ åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ï¼šæä¾›ç§’çº§ã€ç²¾å‡†ã€é«˜å¯é ã€é«˜å¯ç”¨çš„å®šæ—¶ï¼ˆåŸºäº Cron è¡¨è¾¾å¼ï¼‰ä»»åŠ¡è°ƒåº¦æœåŠ¡ã€‚åŒæ—¶æä¾›åˆ†å¸ƒå¼çš„ä»»åŠ¡æ‰§è¡Œæ¨¡å‹ï¼Œå¦‚ç½‘æ ¼ä»»åŠ¡ã€‚ç½‘æ ¼ä»»åŠ¡æ”¯æŒæµ·é‡å­ä»»åŠ¡å‡åŒ€åˆ†é…åˆ°æ‰€æœ‰ Workerï¼ˆschedulerx-clientï¼‰ä¸Šæ‰§è¡Œ å®˜æ–¹æ–‡æ¡£ï¼šhttps://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md å®˜æ–¹æ‰‹å†Œï¼šhttps://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html NacosåŸºæœ¬ä»‹ç»Nacos å…¨ç§° Dynamic Naming and Configuration Serviceï¼Œä¸€ä¸ªæ›´æ˜“äºæ„å»ºäº‘åŸç”Ÿåº”ç”¨çš„åŠ¨æ€æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’ŒæœåŠ¡çš„ç®¡ç†å¹³å°ï¼ŒNacos &#x3D; Eureka + Config + Bus ä¸‹è½½åœ°å€ï¼šhttps://github.com/alibaba/nacos/releases å¯åŠ¨å‘½ä»¤ï¼šå‘½ä»¤è¿è¡ŒæˆåŠŸåç›´æ¥è®¿é—® http://localhost:8848/nacosï¼Œé»˜è®¤è´¦å·å¯†ç éƒ½æ˜¯ nacos 1startup.cmd -m standalone # standalone ä»£è¡¨ç€å•æœºæ¨¡å¼è¿è¡Œï¼Œéé›†ç¾¤æ¨¡å¼ å…³é—­å‘½ä»¤ï¼š 1shutdown.cmd æ³¨å†Œä¸­å¿ƒå¯¹æ¯”ï¼šC ä¸€è‡´æ€§ï¼ŒA å¯ç”¨æ€§ï¼ŒP åˆ†åŒºå®¹é”™æ€§ æ³¨å†Œä¸­å¿ƒ CAP æ¨¡å‹ æ§åˆ¶å°ç®¡ç† Eureka AP æ”¯æŒ Zookeeper CP ä¸æ”¯æŒ Consul CP æ”¯æŒ Nacos AP æ”¯æŒ åˆ‡æ¢æ¨¡å¼ï¼šcurl -X PUT &#39;$NACOS_SERVER:8848/nacos/v1/ns/operator/switches?entry=serverMode&amp;value=CP å®˜ç½‘ï¼šhttps://nacos.io æ³¨å†Œä¸­å¿ƒNacos ä½œä¸ºæœåŠ¡æ³¨å†Œä¸­å¿ƒ æœåŠ¡æä¾›è€…ï¼š å¼•å…¥ pom ä¾èµ–ï¼š 1234&lt;dependency&gt; &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;&lt;/dependency&gt; application.ymlï¼š 12345678910111213141516server: port: 9001spring: application: name: nacos-payment-provider cloud: nacos: discovery: server-addr: localhost:8848 #é…ç½®Nacosåœ°å€ï¼Œæ³¨å†Œåˆ°Nacos# åšç›‘æ§éœ€è¦æŠŠè¿™ä¸ªå…¨éƒ¨æš´éœ²å‡ºæ¥management: endpoints: web: exposure: include: &#x27;*&#x27; ä¸»å¯åŠ¨ç±»ï¼šæ³¨è§£æ˜¯ EnableDiscoveryClient 1234567@EnableDiscoveryClient@SpringBootApplicationpublic class PaymentMain9001 &#123; public static void main(String[] args) &#123; SpringApplication.run(PaymentMain9001.class, args); &#125;&#125; Controllerï¼š 12345678910@RestControllerpublic class PaymentController &#123; @Value(&quot;$&#123;server.port&#125;&quot;) private String serverPort; @GetMapping(value = &quot;/payment/nacos/&#123;id&#125;&quot;) public String getPayment(@PathVariable(&quot;id&quot;) Integer id) &#123; return &quot;nacos registry, serverPort: &quot; + serverPort + &quot;\\t id&quot; + id; &#125;&#125; ç®¡ç†åå°æœåŠ¡ï¼š æ–°å»ºä¸€ä¸ªæ¨¡å—ç«¯å£æ˜¯ 9002ï¼Œå…¶ä»–ä¸ 9001 æœåŠ¡ä¸€æ ·ï¼Œnacos-payment-provider çš„å®ä¾‹æ•°å°±å˜ä¸º 2 æœåŠ¡æ¶ˆè´¹è€…ï¼š application.ymlï¼š 1234567891011121314server: port: 83spring: application: name: nacos-order-consumer cloud: nacos: discovery: server-addr: localhost:8848# æ¶ˆè´¹è€…å°†è¦å»è®¿é—®çš„å¾®æœåŠ¡åç§°(æ³¨å†ŒæˆåŠŸè¿›nacosçš„å¾®æœåŠ¡æä¾›è€…)service-url: nacos-user-service: http://nacos-payment-provider ä¸»å¯åŠ¨ç±»ï¼š 1234567@SpringBootApplication@EnableDiscoveryClientpublic class OrderNacosMain83 &#123; public static void main(String[] args) &#123; SpringApplication.run(OrderNacosMain83.class, args); &#125;&#125; ä¸šåŠ¡ç±»ï¼š 12345678@Configurationpublic class ApplicationContextBean &#123; @Bean @LoadBalanced // ç”Ÿäº§è€…é›†ç¾¤çŠ¶æ€ä¸‹ï¼Œå¿…é¡»æ·»åŠ ï¼Œé˜²æ­¢æ‰¾ä¸åˆ°å®ä¾‹ public RestTemplate getRestTemplate() &#123; return new RestTemplate(); &#125;&#125; 123456789101112131415@RestController@Slf4jpublic class OrderNacosController &#123; @Resource private RestTemplate restTemplate; // ä»é…ç½®æ–‡ä»¶ä¸­è¯»å– URL @Value(&quot;$&#123;service-url.nacos-user-service&#125;&quot;) private String serverURL; @GetMapping(&quot;/consumer/payment/nacos/&#123;id&#125;&quot;) public String paymentInfo(@PathVariable(&quot;id&quot;) Long id) &#123; String result = restTemplate.getForObject(serverURL + &quot;/payment/nacos/&quot; + id, String.class); return result; &#125;&#125; é…ç½®ä¸­å¿ƒåŸºç¡€é…ç½®æŠŠé…ç½®æ–‡ä»¶å†™è¿› Nacosï¼Œç„¶åå†ç”¨ Nacos åš config è¿™æ ·çš„åŠŸèƒ½ï¼Œç›´æ¥ä» Nacos ä¸ŠæŠ“å–æœåŠ¡çš„é…ç½®ä¿¡æ¯ åœ¨ Nacos ä¸­ï¼ŒdataId çš„å®Œæ•´æ ¼å¼å¦‚ä¸‹ $&#123;prefix&#125;-$&#123;spring.profiles.active&#125;.$&#123;file-extension&#125; prefixï¼šé»˜è®¤ä¸º spring.application.name çš„å€¼ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é…ç½®é¡¹ spring.cloud.nacos.config.prefix æ¥é…ç½® spring.profiles.activeï¼šå½“å‰ç¯å¢ƒå¯¹åº”çš„ profileï¼Œå½“è¯¥å€¼ä¸ºç©ºæ—¶ï¼ŒdataId çš„æ‹¼æ¥æ ¼å¼å˜æˆ $&#123;prefix&#125;.$&#123;file-extension&#125; file-exetensionï¼šé…ç½®å†…å®¹çš„æ•°æ®æ ¼å¼ï¼Œå¯ä»¥é€šè¿‡é…ç½®é¡¹ spring.cloud.nacos.config.file-extension æ¥é…ç½®ï¼Œç›®å‰åªæ”¯æŒ properties å’Œ yaml ç±»å‹ï¼ˆä¸æ˜¯ ymlï¼‰ æ„å»ºæµç¨‹ï¼š å¼•å…¥ pom ä¾èµ–ï¼š 1234&lt;dependency&gt; &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;&lt;/dependency&gt; é…ç½®ä¸¤ä¸ª yml æ–‡ä»¶ï¼šé…ç½®æ–‡ä»¶çš„åŠ è½½æ˜¯å­˜åœ¨ä¼˜å…ˆçº§é¡ºåºçš„ï¼Œbootstrap ä¼˜å…ˆçº§é«˜äº application bootstrap.ymlï¼šå…¨å±€é…ç½® 12345678910111213141516# nacosé…ç½®server: port: 3377spring: application: name: nacos-config-client cloud: nacos: discovery: server-addr: localhost:8848 #NacosæœåŠ¡æ³¨å†Œä¸­å¿ƒåœ°å€ config: server-addr: localhost:8848 #Nacosä½œä¸ºé…ç½®ä¸­å¿ƒåœ°å€ file-extension: yaml #æŒ‡å®šyamlæ ¼å¼çš„é…ç½®# $&#123;spring.application.name&#125;-$&#123;spring.profile.active&#125;.$&#123;spring.cloud.nacos.config.file-extension&#125; application.ymlï¼šæœåŠ¡ç‹¬ç«‹é…ç½®ï¼Œè¡¨ç¤ºæœåŠ¡è¦å»é…ç½®ä¸­å¿ƒæ‰¾åä¸º nacos-config-client-dev.yaml çš„æ–‡ä»¶ 123spring: profiles: active: dev # è¡¨ç¤ºå¼€å‘ç¯å¢ƒ ä¸»å¯åŠ¨ç±»ï¼š 1234567@SpringBootApplication@EnableDiscoveryClientpublic class NacosConfigClientMain3377 &#123; public static void main(String[] args) &#123; SpringApplication.run(NacosConfigClientMain3377.class, args); &#125;&#125; ä¸šåŠ¡ç±»ï¼š@RefreshScope æ³¨è§£ä½¿å½“å‰ç±»ä¸‹çš„é…ç½®æ”¯æŒ Nacos çš„åŠ¨æ€åˆ·æ–°åŠŸèƒ½ 1234567891011@RestController@RefreshScopepublic class ConfigClientController &#123; @Value(&quot;$&#123;config.info&#125;&quot;) private String configInfo; @GetMapping(&quot;/config/info&quot;) public String getConfigInfo() &#123; return configInfo; &#125;&#125; æ–°å¢é…ç½®ï¼Œç„¶åè®¿é—® http://localhost:3377/config/info åˆ†ç±»é…ç½®åˆ†å¸ƒå¼å¼€å‘ä¸­çš„å¤šç¯å¢ƒå¤šé¡¹ç›®ç®¡ç†é—®é¢˜ï¼ŒNamespace ç”¨äºåŒºåˆ†éƒ¨ç½²ç¯å¢ƒï¼ŒGroup å’Œ DataID é€»è¾‘ä¸ŠåŒºåˆ†ä¸¤ä¸ªç›®æ ‡å¯¹è±¡ Namespace é»˜è®¤ publicï¼Œä¸»è¦ç”¨æ¥å®ç°éš”ç¦»ï¼Œå›¾ç¤ºä¸‰ä¸ªå¼€å‘ç¯å¢ƒ Group é»˜è®¤æ˜¯ DEFAULT_GROUPï¼ŒGroup å¯ä»¥æŠŠä¸åŒçš„å¾®æœåŠ¡åˆ’åˆ†åˆ°åŒä¸€ä¸ªåˆ†ç»„é‡Œé¢å» åŠ è½½é…ç½®DataID æ–¹æ¡ˆï¼šæŒ‡å®š spring.profile.active å’Œé…ç½®æ–‡ä»¶çš„ DataID æ¥ä½¿ä¸åŒç¯å¢ƒä¸‹è¯»å–ä¸åŒçš„é…ç½® Group æ–¹æ¡ˆï¼šé€šè¿‡ Group å®ç°ç¯å¢ƒåˆ†åŒºï¼Œåœ¨ config ä¸‹å¢åŠ ä¸€æ¡ Group çš„é…ç½®å³å¯ Namespace æ–¹æ¡ˆï¼š 123456789101112131415server: port: 3377spring: application: name: nacos-config-client cloud: nacos: discovery: server-addr: localhost:8848 #NacosæœåŠ¡æ³¨å†Œä¸­å¿ƒåœ°å€ config: server-addr: localhost:8848 #Nacosä½œä¸ºé…ç½®ä¸­å¿ƒåœ°å€ file-extension: yaml #æŒ‡å®šyamlæ ¼å¼çš„é…ç½® group: DEV_GROUP namespace: 95d44530-a4a6-4ead-98c6-23d192cee298 é›†ç¾¤æ¶æ„é›†ç¾¤éƒ¨ç½²å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼ŒNacos æ”¯æŒçš„ä¸‰ç§éƒ¨ç½²æ¨¡å¼ï¼š å•æœºæ¨¡å¼ï¼šç”¨äºæµ‹è¯•å’Œå•æœºä½¿ç”¨ é›†ç¾¤æ¨¡å¼ï¼šç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œç¡®ä¿é«˜å¯ç”¨ å¤šé›†ç¾¤æ¨¡å¼ï¼šç”¨äºå¤šæ•°æ®ä¸­å¿ƒåœºæ™¯ é›†ç¾¤éƒ¨ç½²æ–‡æ¡£ï¼šhttps://nacos.io/zh-cn/docs/v2/guide/admin/cluster-mode-quick-start.html é»˜è®¤ Nacos ä½¿ç”¨åµŒå…¥å¼æ•°æ®åº“ derby å®ç°æ•°æ®çš„å­˜å‚¨ï¼Œé‡å¯ Nacos åé…ç½®æ–‡ä»¶ä¸ä¼šæ¶ˆå¤±ï¼Œä½†æ˜¯å¤šä¸ª Nacos èŠ‚ç‚¹æ•°æ®å­˜å‚¨å­˜åœ¨ä¸€è‡´æ€§é—®é¢˜ï¼Œæ¯ä¸ª Nacos éƒ½æœ‰ç‹¬ç«‹çš„åµŒå…¥å¼æ•°æ®åº“ï¼Œæ‰€ä»¥ Nacos é‡‡ç”¨äº†é›†ä¸­å¼å­˜å‚¨çš„æ–¹å¼æ¥æ”¯æŒé›†ç¾¤åŒ–éƒ¨ç½²ï¼Œç›®å‰åªæ”¯æŒ MySQL çš„å­˜å‚¨ Windows ä¸‹ Nacos åˆ‡æ¢ MySQL å­˜å‚¨ï¼š åœ¨ Nacos å®‰è£…ç›®å½•çš„ conf ç›®å½•ä¸‹æ‰¾åˆ°ä¸€ä¸ªåä¸º nacos-mysql.sql çš„è„šæœ¬å¹¶æ‰§è¡Œ åœ¨ conf ç›®å½•ä¸‹æ‰¾åˆ° application.propertiesï¼Œå¢åŠ å¦‚ä¸‹æ•°æ® 123456spring.datasource.platform=mysql db.num=1db.url.0=jdbc:mysql://127.0.0.1:3306/nacos_config?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=truedb.user=usernamedb.password=password é‡æ–°å¯åŠ¨ Nacosï¼Œå¯ä»¥çœ‹åˆ°æ˜¯ä¸ªå…¨æ–°çš„ç©ºè®°å½•ç•Œé¢ Linux å‚è€ƒï¼šhttps://www.yuque.com/mrlinxi/pxvr4g/rnahsn#dPvMy SentinelåŸºæœ¬ä»‹ç»Sentinel æ˜¯é¢å‘åˆ†å¸ƒå¼ã€å¤šè¯­è¨€å¼‚æ„åŒ–æœåŠ¡æ¶æ„çš„æµé‡æ²»ç†ç»„ä»¶ Sentinel åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š æ ¸å¿ƒåº“ï¼ˆJava å®¢æˆ·ç«¯ï¼‰ä¸ä¾èµ–ä»»ä½•æ¡†æ¶&#x2F;åº“ï¼Œèƒ½å¤Ÿè¿è¡Œäº Java 8 åŠä»¥ä¸Šçš„ç‰ˆæœ¬çš„è¿è¡Œæ—¶ç¯å¢ƒ æ§åˆ¶å°ï¼ˆDashboardï¼‰ä¸»è¦è´Ÿè´£ç®¡ç†æ¨é€è§„åˆ™ã€ç›‘æ§ã€ç®¡ç†æœºå™¨ä¿¡æ¯ç­‰ ä¸‹è½½åˆ°æœ¬åœ°ï¼Œè¿è¡Œå‘½ä»¤ï¼šjava -jar sentinel-dashboard-1.8.2.jar ï¼ˆè¦æ±‚ Java8ï¼Œä¸” 8080 ç«¯å£ä¸èƒ½è¢«å ç”¨ï¼‰ï¼Œè®¿é—® http://localhost:8080/ï¼Œè´¦å·å¯†ç å‡ä¸º sentinel å®˜ç½‘ï¼šhttps://sentinelguard.io ä¸‹è½½åœ°å€ï¼šhttps://github.com/alibaba/Sentinel/releases åŸºæœ¬ä½¿ç”¨æ„å»ºæ¼”ç¤ºå·¥ç¨‹ï¼š å¼•å…¥ pom ä¾èµ–ï¼š 1234&lt;dependency&gt; &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;&lt;/dependency&gt; application.ymlï¼šsentinel.transport.port ç«¯å£é…ç½®ä¼šåœ¨åº”ç”¨å¯¹åº”çš„æœºå™¨ä¸Šå¯åŠ¨ä¸€ä¸ª HTTP Serverï¼Œè¯¥ Server ä¸ Sentinel æ§åˆ¶å°åšäº¤äº’ã€‚æ¯”å¦‚ Sentinel æ§åˆ¶å°æ·»åŠ äº† 1 ä¸ªé™æµè§„åˆ™ï¼Œä¼šæŠŠè§„åˆ™æ•°æ® Push ç»™ Server æ¥æ”¶ï¼ŒServer å†å°†è§„åˆ™æ³¨å†Œåˆ° Sentinel ä¸­ 12345678910111213141516171819202122server: port: 8401spring: application: name: cloudalibaba-sentinel-service cloud: nacos: discovery: server-addr: localhost:8848 # Nacos æœåŠ¡æ³¨å†Œä¸­å¿ƒåœ°å€ã€éœ€è¦å¯åŠ¨Nacos8848ã€‘ sentinel: transport: # é…ç½®Sentinel dashboardåœ°å€ dashboard: localhost:8080 # é»˜è®¤8719ç«¯å£ï¼Œå‡å¦‚è¢«å ç”¨ä¼šè‡ªåŠ¨ä»8719å¼€å§‹ä¾æ¬¡+1æ‰«æ,ç›´è‡³æ‰¾åˆ°æœªè¢«å ç”¨çš„ç«¯å£ port: 8719management: endpoints: web: exposure: include: &#x27;*&#x27; ä¸»å¯åŠ¨ç±»ï¼š 1234567@EnableDiscoveryClient@SpringBootApplicationpublic class SentinelMainApp8401 &#123; public static void main(String[] args) &#123; SpringApplication.run(SentinelMainApp8401.class, args); &#125;&#125; æµé‡æ§åˆ¶ Controllerï¼š 12345678910111213@RestController@Slf4jpublic class FlowLimitController &#123; @GetMapping(&quot;/testA&quot;) public String testA() &#123; return &quot;------testA&quot;; &#125; @GetMapping(&quot;/testB&quot;) public String testB() &#123; return &quot;------testB&quot;; &#125;&#125; Sentinel é‡‡ç”¨æ‡’åŠ è½½æœºåˆ¶ï¼Œéœ€è¦å…ˆè®¿é—® http://localhost:8401/testAï¼Œæ§åˆ¶å°æ‰èƒ½çœ‹åˆ° æµæ§è§„åˆ™æµé‡æ§åˆ¶è§„åˆ™ FlowRuleï¼šåŒä¸€ä¸ªèµ„æºå¯ä»¥åŒæ—¶æœ‰å¤šä¸ªé™æµè§„åˆ™ èµ„æºå resourceï¼šé™æµè§„åˆ™çš„ä½œç”¨å¯¹è±¡ï¼ŒDemo ä¸­ä¸º testA é’ˆå¯¹èµ„æº limitAppï¼šé’ˆå¯¹è°ƒç”¨è€…è¿›è¡Œé™æµï¼Œé»˜è®¤ä¸º default ä»£è¡¨ä¸åŒºåˆ†è°ƒç”¨æ¥æº é˜ˆå€¼ç±»å‹ gradeï¼šQPS æˆ–çº¿ç¨‹æ•°æ¨¡å¼ å•æœºé˜ˆå€¼ countï¼šé™æµé˜ˆå€¼ æµæ§æ¨¡å¼ strategyï¼šè°ƒç”¨å…³ç³»é™æµç­–ç•¥ ç›´æ¥ï¼šèµ„æºæœ¬èº«è¾¾åˆ°é™æµæ¡ä»¶ç›´æ¥é™æµ å…³è”ï¼šå½“å…³è”çš„èµ„æºè¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œé™æµè‡ªèº« é“¾è·¯ï¼šåªè®°å½•æŒ‡å®šé“¾è·¯ä¸Šçš„æµé‡ï¼Œä»å…¥å£èµ„æºè¿›æ¥çš„æµé‡ æµæ§æ•ˆæœ controlBehaviorï¼š å¿«é€Ÿå¤±è´¥ï¼šç›´æ¥å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸ Warm Upï¼šå†·å¯åŠ¨ï¼Œæ ¹æ® codeFactoryï¼ˆå†·åŠ è½½å› å­ï¼Œé»˜è®¤ 3ï¼‰çš„å€¼ï¼Œä» count&#x2F;codeFactory å¼€å§‹ç¼“æ…¢å¢åŠ ï¼Œç»™ç³»ç»Ÿé¢„çƒ­æ—¶é—´ æ’é˜Ÿç­‰å¾…ï¼šåŒ€é€Ÿæ’é˜Ÿï¼Œè®©è¯·æ±‚ä»¥åŒ€é€Ÿçš„æ–¹å¼é€šè¿‡ï¼Œé˜ˆå€¼ç±»å‹å¿…é¡»è®¾ç½®ä¸º QPSï¼Œå¦åˆ™æ— æ•ˆ é€šè¿‡è°ƒç”¨ SystemRuleManager.loadRules() æ–¹æ³•æ¥ç”¨ç¡¬ç¼–ç çš„æ–¹å¼å®šä¹‰æµé‡æ§åˆ¶è§„åˆ™ï¼š 1234567private void initSystemProtectionRule() &#123; List&lt;SystemRule&gt; rules = new ArrayList&lt;&gt;(); SystemRule rule = new SystemRule(); rule.setHighestSystemLoad(10); rules.add(rule); SystemRuleManager.loadRules(rules);&#125; è¯¦ç»†å†…å®¹å‚è€ƒæ–‡æ¡£ï¼šhttps://sentinelguard.io/zh-cn/docs/flow-control.html é™çº§ç†”æ–­Sentinel ç†”æ–­é™çº§ä¼šåœ¨è°ƒç”¨é“¾è·¯ä¸­æŸä¸ªèµ„æºå‡ºç°ä¸ç¨³å®šçŠ¶æ€æ—¶ï¼Œå¯¹è¿™ä¸ªèµ„æºçš„è°ƒç”¨è¿›è¡Œé™åˆ¶ï¼Œè®©è¯·æ±‚å¿«é€Ÿå¤±è´¥ï¼Œé¿å…å½±å“åˆ°å…¶å®ƒçš„èµ„æºè€Œå¯¼è‡´çº§è”é”™è¯¯ã€‚å½“èµ„æºè¢«é™çº§åï¼Œåœ¨æ¥ä¸‹æ¥çš„é™çº§æ—¶é—´çª—å£ä¹‹å†…ï¼Œå¯¹è¯¥èµ„æºçš„è°ƒç”¨éƒ½è‡ªåŠ¨ç†”æ–­ï¼ˆé»˜è®¤è¡Œä¸ºæ˜¯æŠ›å‡º DegradeExceptionï¼‰ Sentinel æä¾›ä»¥ä¸‹å‡ ç§ç†”æ–­ç­–ç•¥ï¼š èµ„æºå resourceï¼šé™æµè§„åˆ™çš„ä½œç”¨å¯¹è±¡ï¼ŒDemo ä¸­ä¸º testA ç†”æ–­ç­–ç•¥ gradeï¼š æ…¢è°ƒç”¨æ¯”ä¾‹ï¼ˆSLOW_REQUEST_RATIOï¼‰ï¼šä»¥æ…¢è°ƒç”¨æ¯”ä¾‹ä½œä¸ºé˜ˆå€¼ï¼Œéœ€è¦è®¾ç½®å…è®¸çš„æ…¢è°ƒç”¨ RTï¼ˆå³æœ€å¤§çš„å“åº”æ—¶é—´ï¼‰ï¼Œè¯·æ±‚çš„å“åº”æ—¶é—´å¤§äºè¯¥å€¼åˆ™ç»Ÿè®¡ä¸ºæ…¢è°ƒç”¨ã€‚å½“å•ä½ç»Ÿè®¡æ—¶é•¿ï¼ˆstatIntervalMsï¼‰å†…è¯·æ±‚æ•°ç›®å¤§äºè®¾ç½®çš„æœ€å°è¯·æ±‚æ•°ç›®ï¼Œå¹¶ä¸”æ…¢è°ƒç”¨çš„æ¯”ä¾‹å¤§äºé˜ˆå€¼ï¼Œåˆ™æ¥ä¸‹æ¥çš„ç†”æ–­æ—¶é•¿å†…è¯·æ±‚ä¼šè‡ªåŠ¨è¢«ç†”æ–­ã€‚ç»è¿‡ç†”æ–­æ—¶é•¿åç†”æ–­å™¨ä¼šè¿›å…¥æ¢æµ‹æ¢å¤çŠ¶æ€ï¼ˆHALF-OPEN çŠ¶æ€ï¼‰ï¼Œè‹¥æ¥ä¸‹æ¥çš„ä¸€ä¸ªè¯·æ±‚å“åº”æ—¶é—´å°äºè®¾ç½®çš„æ…¢è°ƒç”¨ RT åˆ™ç»“æŸç†”æ–­ï¼Œè‹¥å¤§äºè®¾ç½®çš„æ…¢è°ƒç”¨ RT åˆ™ä¼šå†æ¬¡è¢«ç†”æ–­ å¼‚å¸¸æ¯”ä¾‹ï¼ˆERROR_RATIOï¼‰ï¼šå½“å•ä½ç»Ÿè®¡æ—¶é•¿å†…è¯·æ±‚æ•°ç›®å¤§äºè®¾ç½®çš„æœ€å°è¯·æ±‚æ•°ç›®ï¼Œå¹¶ä¸”å¼‚å¸¸çš„æ¯”ä¾‹å¤§äºé˜ˆå€¼ï¼Œåˆ™æ¥ä¸‹æ¥çš„ç†”æ–­æ—¶é•¿å†…è¯·æ±‚ä¼šè‡ªåŠ¨è¢«ç†”æ–­ã€‚ç»è¿‡ç†”æ–­æ—¶é•¿åç†”æ–­å™¨ä¼šè¿›å…¥æ¢æµ‹æ¢å¤çŠ¶æ€ï¼Œè‹¥æ¥ä¸‹æ¥çš„ä¸€ä¸ªè¯·æ±‚æˆåŠŸå®Œæˆï¼ˆæ²¡æœ‰é”™è¯¯ï¼‰åˆ™ç»“æŸç†”æ–­ï¼Œå¦åˆ™ä¼šå†æ¬¡è¢«ç†”æ–­ã€‚å¼‚å¸¸æ¯”ç‡çš„é˜ˆå€¼èŒƒå›´æ˜¯ [0.0, 1.0]ï¼Œä»£è¡¨ 0% - 100% å¼‚å¸¸æ•° ï¼ˆERROR_COUNTï¼‰ï¼šå½“å•ä½ç»Ÿè®¡æ—¶é•¿å†…çš„å¼‚å¸¸æ•°ç›®è¶…è¿‡é˜ˆå€¼ä¹‹åä¼šè‡ªåŠ¨è¿›è¡Œç†”æ–­ã€‚ç»è¿‡ç†”æ–­æ—¶é•¿åç†”æ–­å™¨ä¼šè¿›å…¥æ¢æµ‹æ¢å¤çŠ¶æ€ï¼Œè‹¥æ¥ä¸‹æ¥çš„ä¸€ä¸ªè¯·æ±‚æˆåŠŸå®Œæˆï¼ˆæ²¡æœ‰é”™è¯¯ï¼‰åˆ™ç»“æŸç†”æ–­ï¼Œå¦åˆ™ä¼šå†æ¬¡è¢«ç†”æ–­ å•æœºé˜ˆå€¼ countï¼šæ…¢è°ƒç”¨æ¯”ä¾‹æ¨¡å¼ä¸‹ä¸ºæ…¢è°ƒç”¨ä¸´ç•Œ RTï¼›å¼‚å¸¸æ¯”ä¾‹&#x2F;å¼‚å¸¸æ•°æ¨¡å¼ä¸‹ä¸ºå¯¹åº”çš„é˜ˆå€¼ ç†”æ–­æ—¶é•¿ timeWindowï¼šå•ä½ä¸º s æœ€å°è¯·æ±‚æ•° minRequestAmountï¼šç†”æ–­è§¦å‘çš„æœ€å°è¯·æ±‚æ•°ï¼Œè¯·æ±‚æ•°å°äºè¯¥å€¼æ—¶å³ä½¿å¼‚å¸¸æ¯”ç‡è¶…å‡ºé˜ˆå€¼ä¹Ÿä¸ä¼šç†”æ–­ï¼Œé»˜è®¤ 5 ç»Ÿè®¡æ—¶é•¿ statIntervalMsï¼šå•ä½ç»Ÿè®¡æ—¶é•¿ æ…¢è°ƒç”¨æ¯”ä¾‹é˜ˆå€¼ slowRatioThresholdï¼šä»…æ…¢è°ƒç”¨æ¯”ä¾‹æ¨¡å¼æœ‰æ•ˆ æ³¨æ„å¼‚å¸¸é™çº§ä»…é’ˆå¯¹ä¸šåŠ¡å¼‚å¸¸ï¼Œå¯¹ Sentinel é™æµé™çº§æœ¬èº«çš„å¼‚å¸¸ BlockException ä¸ç”Ÿæ•ˆï¼Œä¸ºäº†ç»Ÿè®¡å¼‚å¸¸æ¯”ä¾‹æˆ–å¼‚å¸¸æ•°ï¼Œéœ€è¦é€šè¿‡ Tracer.trace(ex) è®°å½•ä¸šåŠ¡å¼‚å¸¸æˆ–è€…é€šè¿‡@SentinelResource æ³¨è§£ä¼šè‡ªåŠ¨ç»Ÿè®¡ä¸šåŠ¡å¼‚å¸¸ 123456789101112131415Entry entry = null;try &#123; entry = SphU.entry(resource); // Write your biz code here. // &lt;&lt;BIZ CODE&gt;&gt;&#125; catch (Throwable t) &#123; if (!BlockException.isBlockException(t)) &#123; Tracer.trace(t); &#125;&#125; finally &#123; if (entry != null) &#123; entry.exit(); &#125;&#125; è¯¦ç»†å†…å®¹å‚è€ƒæ–‡æ¡£ï¼šhttps://sentinelguard.io/zh-cn/docs/circuit-breaking.html çƒ­ç‚¹é™æµçƒ­ç‚¹å‚æ•°é™æµä¼šç»Ÿè®¡ä¼ å…¥å‚æ•°ä¸­çš„çƒ­ç‚¹å‚æ•°ï¼Œå¹¶æ ¹æ®é…ç½®çš„é™æµé˜ˆå€¼ä¸æ¨¡å¼ï¼Œå¯¹åŒ…å«çƒ­ç‚¹å‚æ•°çš„èµ„æºè°ƒç”¨è¿›è¡Œé™æµï¼ŒSentinel åˆ©ç”¨ LRU ç­–ç•¥ç»Ÿè®¡æœ€è¿‘æœ€å¸¸è®¿é—®çš„çƒ­ç‚¹å‚æ•°ï¼Œç»“åˆä»¤ç‰Œæ¡¶ç®—æ³•æ¥è¿›è¡Œå‚æ•°çº§åˆ«çš„æµæ§ å¼•å…¥ @SentinelResource æ³¨è§£ï¼šhttps://sentinelguard.io/zh-cn/docs/annotation-support.html valueï¼šSentinel èµ„æºåï¼Œé»˜è®¤ä¸ºè¯·æ±‚è·¯å¾„ï¼Œè¿™é‡Œ value çš„å€¼å¯ä»¥ä»»æ„å†™ï¼Œä½†æ˜¯çº¦å®šä¸ Restful åœ°å€ä¸€è‡´ blockHandlerï¼šè¡¨ç¤ºè§¦å‘äº† Sentinel ä¸­é…ç½®çš„æµæ§è§„åˆ™ï¼Œå°±ä¼šè°ƒç”¨å…œåº•æ–¹æ³• del_testHotKey blockHandlerClassï¼šå¦‚æœè®¾ç½®äº†è¯¥å€¼ï¼Œå°±ä¼šå»è¯¥ç±»ä¸­å¯»æ‰¾ blockHandler æ–¹æ³• fallbackï¼šç”¨äºåœ¨æŠ›å‡ºå¼‚å¸¸çš„æ—¶å€™æä¾› fallback å¤„ç†é€»è¾‘ è¯´æ˜ï¼šfallback å¯¹åº”æœåŠ¡é™çº§ï¼ˆæœåŠ¡å‡ºé”™äº†éœ€è¦æœ‰ä¸ªå…œåº•æ–¹æ³•ï¼‰ï¼ŒblockHandler å¯¹åº”æœåŠ¡ç†”æ–­ï¼ˆæœåŠ¡ä¸å¯ç”¨çš„å…œåº•æ–¹æ³•ï¼‰ 1234567891011@GetMapping(&quot;/testHotKey&quot;)@SentinelResource(value = &quot;testHotKey&quot;, blockHandler = &quot;del_testHotKey&quot;)public String testHotkey(@RequestParam(value = &quot;p1&quot;, required = false) String p1, @RequestParam(value = &quot;p1&quot;, required = false) String p2) &#123; return &quot;------testHotkey&quot;;&#125;// è‡ªå®šä¹‰çš„å…œåº•æ–¹æ³•ï¼Œå¿…é¡»æ˜¯ BlockExceptionpublic String del_testHotKey(String p1, String p2, BlockException e) &#123; return &quot;ä¸ç”¨é»˜è®¤çš„å…œåº•æç¤º Blocked by Sentinel(flow limiting)ï¼Œè‡ªå®šä¹‰æç¤ºï¼šdel_testHotKeyo.&quot;;&#125; å›¾ç¤ºè®¾ç½® p1 å‚æ•°é™æµï¼Œè§„åˆ™æ˜¯ 1s è®¿é—® 1 æ¬¡ï¼Œå½“ p1&#x3D;5 æ—¶ QPS &gt; 100ï¼Œåªè®¿é—® p2 ä¸ä¼šå‡ºç°é™æµ http://localhost:8401/testHotKey?p2=b å‚æ•°ç´¢å¼• paramIdxï¼šçƒ­ç‚¹å‚æ•°çš„ç´¢å¼•ï¼Œå›¾ä¸­ç´¢å¼• 0 å¯¹åº”æ–¹æ³•ä¸­çš„ p1 å‚æ•° å‚æ•°ä¾‹å¤–é¡¹ paramFlowItemListï¼šé’ˆå¯¹æŒ‡å®šçš„å‚æ•°å€¼å•ç‹¬è®¾ç½®é™æµé˜ˆå€¼ï¼Œä¸å— count é˜ˆå€¼çš„é™åˆ¶ï¼Œä»…æ”¯æŒåŸºæœ¬ç±»å‹å’Œå­—ç¬¦ä¸²ç±»å‹ è¯´æ˜ï¼š@SentinelResource åªç®¡æ§åˆ¶å°é…ç½®è§„åˆ™é—®é¢˜ï¼Œå‡ºç°è¿è¡Œæ—¶å¼‚å¸¸ä¾ç„¶ä¼šæŠ¥é”™ è¯¦ç»†å†…å®¹å‚è€ƒæ–‡æ¡£ï¼šhttps://sentinelguard.io/zh-cn/docs/parameter-flow-control.html ç³»ç»Ÿè§„åˆ™Sentinel ç³»ç»Ÿè‡ªé€‚åº”ä¿æŠ¤ä»æ•´ä½“ç»´åº¦å¯¹åº”ç”¨å…¥å£æµé‡è¿›è¡Œæ§åˆ¶ï¼Œè®©ç³»ç»Ÿå°½å¯èƒ½è·‘åœ¨æœ€å¤§ååé‡çš„åŒæ—¶ä¿è¯ç³»ç»Ÿæ•´ä½“çš„ç¨³å®šæ€§ ç³»ç»Ÿè§„åˆ™æ”¯æŒä»¥ä¸‹çš„é˜ˆå€¼ç±»å‹ï¼š Loadï¼ˆä»…å¯¹ Linux&#x2F;Unix-like æœºå™¨ç”Ÿæ•ˆï¼‰ï¼šå½“ç³»ç»Ÿ load1 è¶…è¿‡é˜ˆå€¼ï¼Œä¸”ç³»ç»Ÿå½“å‰çš„å¹¶å‘çº¿ç¨‹æ•°è¶…è¿‡ç³»ç»Ÿå®¹é‡æ—¶æ‰ä¼šè§¦å‘ç³»ç»Ÿä¿æŠ¤ï¼Œç³»ç»Ÿå®¹é‡ç”±ç³»ç»Ÿçš„ maxQps * minRt è®¡ç®—å¾—å‡ºï¼Œè®¾å®šå‚è€ƒå€¼ä¸€èˆ¬æ˜¯ CPU cores * 2.5 RTï¼šå½“å•å°æœºå™¨ä¸Šæ‰€æœ‰å…¥å£æµé‡çš„å¹³å‡ RT è¾¾åˆ°é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ï¼Œå•ä½æ˜¯æ¯«ç§’ çº¿ç¨‹æ•°ï¼šå½“å•å°æœºå™¨ä¸Šæ‰€æœ‰å…¥å£æµé‡çš„å¹¶å‘çº¿ç¨‹æ•°è¾¾åˆ°é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ å…¥å£ QPSï¼šå½“å•å°æœºå™¨ä¸Šæ‰€æœ‰å…¥å£æµé‡çš„ QPS è¾¾åˆ°é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ CPU usageï¼šå½“ç³»ç»Ÿ CPU ä½¿ç”¨ç‡è¶…è¿‡é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ï¼ˆå–å€¼èŒƒå›´ 0.0-1.0ï¼‰ è¯¦ç»†å†…å®¹å‚è€ƒæ–‡æ¡£ï¼šhttps://sentinelguard.io/zh-cn/docs/system-adaptive-protection.html æœåŠ¡è°ƒç”¨æ¶ˆè´¹è€…éœ€è¦è¿›è¡ŒæœåŠ¡è°ƒç”¨ å¼•å…¥ pom ä¾èµ–ï¼š 1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;&lt;/dependency&gt; application.ymlï¼šæ¿€æ´» Sentinel å¯¹ Feign çš„æ”¯æŒ 123feign: sentinel: enabled: true ä¸»å¯åŠ¨ç±»ï¼šåŠ ä¸Š @EnableFeignClient æ³¨è§£å¼€å¯ OpenFeign ä¸šåŠ¡ç±»ï¼š 123456789// æŒ‡æ˜è°ƒç”¨å¤±è´¥çš„å…œåº•æ–¹æ³•åœ¨PaymentFallbackServiceï¼Œä½¿ç”¨ fallback æ–¹å¼æ˜¯æ— æ³•è·å–å¼‚å¸¸ä¿¡æ¯çš„ï¼Œ// å¦‚æœæƒ³è¦è·å–å¼‚å¸¸ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨ fallbackFactory å‚æ•°@FeignClient(value = &quot;nacos-payment-provider&quot;, fallback = PaymentFallbackService.class)public interface PaymentFeignService &#123; // å»ç”Ÿäº§åˆ™æœåŠ¡ä¸­æ‰¾ç›¸åº”çš„æ¥å£ï¼Œæ–¹æ³•ç­¾åä¸€å®šè¦å’Œç”Ÿäº§è€…ä¸­ controller çš„ä¸€è‡´ @GetMapping(value = &quot;/paymentSQL/&#123;id&#125;&quot;) public CommonResult&lt;Payment&gt; paymentSQL(@PathVariable(&quot;id&quot;) Long id);&#125; 12345@Component //ä¸è¦å¿˜è®°æ³¨è§£ï¼Œé™çº§æ–¹æ³•public class PaymentFallbackService implements PaymentFeignService &#123; @Override public CommonResult&lt;Payment&gt; paymentSQL(Long id) &#123; return new CommonResult&lt;&gt;(444,&quot;æœåŠ¡é™çº§è¿”å›,æ²¡æœ‰è¯¥æµæ°´ä¿¡æ¯-------PaymentFallbackSe æŒä¹…åŒ–é…ç½®æŒä¹…åŒ–ï¼š å¼•å…¥ pom ä¾èµ–ï¼š 12345&lt;!--SpringCloud ailibaba sentinel-datasource-nacos åç»­åšæŒä¹…åŒ–ç”¨åˆ°--&gt;&lt;dependency&gt; &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt; &lt;artifactId&gt;sentinel-datasource-nacos&lt;/artifactId&gt;&lt;/dependency&gt; æ·»åŠ  Nacos æ•°æ®æºé…ç½®ï¼š 12345678910111213141516171819202122232425262728server: port: 8401spring: application: name: cloudalibaba-sentinel-service cloud: nacos: discovery: server-addr: localhost:8848 #NacosæœåŠ¡æ³¨å†Œä¸­å¿ƒåœ°å€ sentinel: transport: dashboard: localhost:8080 port: 8719 # å…³é—­é»˜è®¤æ”¶æ•›æ‰€æœ‰URLçš„å…¥å£contextï¼Œä¸ç„¶é“¾è·¯é™æµä¸ç”Ÿæ•ˆ web-context-unify: false # filter: # enabled: false # å…³é—­è‡ªåŠ¨æ”¶æ•› #æŒä¹…åŒ–é…ç½® datasource: ds1: nacos: server-addr: localhost:8848 dataId: cloudalibaba-sentinel-service groupId: DEFAULT_GROUP data-type: json rule-type: flow Seataåˆ†å¸ƒäº‹ç‰©ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡è¿‡ç¨‹ï¼Œå¯ä»¥ç”¨åˆ†å¸ƒå¼å¤„ç†è¿‡ç¨‹çš„ä¸€ ID + ä¸‰ç»„ä»¶æ¨¡å‹æ¥æè¿°ï¼š XID (Transaction ID)ï¼šå…¨å±€å”¯ä¸€çš„äº‹åŠ¡ IDï¼Œåœ¨è¿™ä¸ªäº‹åŠ¡IDä¸‹çš„æ‰€æœ‰äº‹åŠ¡ä¼šè¢«ç»Ÿä¸€æ§åˆ¶ TC (Transaction Coordinator)ï¼šäº‹åŠ¡åè°ƒè€…ï¼Œç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œé©±åŠ¨å…¨å±€äº‹åŠ¡æäº¤æˆ–å›æ»š TM (Transaction Manager)ï¼šäº‹åŠ¡ç®¡ç†å™¨ï¼Œå®šä¹‰å…¨å±€äº‹åŠ¡çš„èŒƒå›´ï¼Œå¼€å§‹å…¨å±€äº‹åŠ¡ã€æäº¤æˆ–å›æ»šå…¨å±€äº‹åŠ¡ RM (Resource Manager)ï¼šèµ„æºç®¡ç†å™¨ï¼Œç®¡ç†åˆ†æ”¯äº‹åŠ¡å¤„ç†çš„èµ„æºï¼Œä¸ TC äº¤è°ˆä»¥æ³¨å†Œåˆ†æ”¯äº‹åŠ¡å’ŒæŠ¥å‘Šåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œå¹¶é©±åŠ¨åˆ†æ”¯äº‹åŠ¡æäº¤æˆ–å›æ»š å…¸å‹çš„åˆ†å¸ƒå¼äº‹åŠ¡æµç¨‹ï¼š TM å‘ TC ç”³è¯·å¼€å¯ä¸€ä¸ªå…¨å±€äº‹åŠ¡ï¼Œå…¨å±€äº‹åŠ¡åˆ›å»ºæˆåŠŸå¹¶ç”Ÿæˆä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ XID XID åœ¨å¾®æœåŠ¡è°ƒç”¨é“¾è·¯çš„ä¸Šä¸‹æ–‡ä¸­ä¼ æ’­ï¼ˆä¹Ÿå°±æ˜¯åœ¨å¤šä¸ª TMï¼ŒRM ä¸­ä¼ æ’­ï¼‰ RM å‘ TC æ³¨å†Œåˆ†æ”¯äº‹åŠ¡ï¼Œå°†å…¶çº³å…¥ XID å¯¹åº”å…¨å±€äº‹åŠ¡çš„ç®¡è¾– TM å‘ TC å‘èµ·é’ˆå¯¹ XID çš„å…¨å±€æäº¤æˆ–å›æ»šå†³è®® TC è°ƒåº¦ XID ä¸‹ç®¡è¾–çš„å…¨éƒ¨åˆ†æ”¯äº‹åŠ¡å®Œæˆæäº¤æˆ–å›æ»šè¯·æ±‚ åŸºæœ¬é…ç½®Seata æ˜¯ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œè‡´åŠ›äºæä¾›é«˜æ€§èƒ½å’Œç®€å•æ˜“ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ã€‚Seata å°†ä¸ºç”¨æˆ·æä¾›äº† ATã€TCCã€SAGA å’Œ XA äº‹åŠ¡æ¨¡å¼ï¼Œä¸ºç”¨æˆ·æ‰“é€ ä¸€ç«™å¼çš„åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆ ä¸‹è½½ seata-server æ–‡ä»¶ä¿®æ”¹ conf ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶ file.confï¼šè‡ªå®šä¹‰äº‹åŠ¡ç»„åç§°ã€äº‹åŠ¡æ—¥å¿—å­˜å‚¨æ¨¡å¼ä¸º dbã€æ•°æ®åº“è¿æ¥ä¿¡æ¯ äº‹åŠ¡åˆ†ç»„ï¼šseata çš„èµ„æºé€»è¾‘ï¼Œå¯ä»¥æŒ‰å¾®æœåŠ¡çš„éœ€è¦ï¼Œåœ¨åº”ç”¨ç¨‹åºï¼ˆå®¢æˆ·ç«¯ï¼‰å¯¹è‡ªè¡Œå®šä¹‰äº‹åŠ¡åˆ†ç»„ï¼Œæ¯ç»„å–ä¸€ä¸ªåå­— æ•°æ®åº“æ–°å»ºåº“ seataï¼Œå»ºè¡¨ db_store.sql åœ¨ https://github.com/seata/seata/tree/2.x/script/server/db ç›®å½•é‡Œé¢ registry.confï¼šæŒ‡æ˜æ³¨å†Œä¸­å¿ƒä¸º Nacosï¼ŒåŠä¿®æ”¹ Nacos è¿æ¥ä¿¡æ¯ å¯åŠ¨ Nacos å’Œ Seataï¼Œå¦‚æœ DB æŠ¥é”™ï¼Œéœ€è¦æŠŠå°† lib æ–‡ä»¶å¤¹ä¸‹ mysql-connector-java-5.1.30.jar åˆ é™¤ï¼Œæ›¿æ¢ä¸ºè‡ªå·± MySQL è¿æ¥å™¨ç‰ˆæœ¬ å®˜ç½‘ï¼šhttps://seata.io ä¸‹è½½åœ°å€ï¼šhttps://github.com/seata/seata/releases åŸºæœ¬ä»‹ç»ï¼šhttps://seata.io/zh-cn/docs/overview/what-is-seata.html åŸºæœ¬ä½¿ç”¨ä¸¤ä¸ªæ³¨è§£ï¼š Spring æä¾›çš„æœ¬åœ°äº‹åŠ¡ï¼š@Transactional Seata æä¾›çš„å…¨å±€äº‹åŠ¡ï¼š**@GlobalTransactional** æ­å»ºç®€å• Demoï¼š åˆ›å»º UNDO_LOG è¡¨ï¼šSEATA AT æ¨¡å¼éœ€è¦ UNDO_LOG è¡¨ï¼Œå¦‚æœä¸€ä¸ªæ¨¡å—çš„äº‹åŠ¡æäº¤äº†ï¼ŒSeata ä¼šæŠŠæäº¤äº†å“ªäº›æ•°æ®è®°å½•åˆ° undo_log è¡¨ä¸­ï¼Œå¦‚æœè¿™æ—¶ TC é€šçŸ¥å…¨å±€äº‹åŠ¡å›æ»šï¼Œé‚£ä¹ˆ RM å°±ä» undo_log è¡¨ä¸­è·å–ä¹‹å‰ä¿®æ”¹äº†å“ªäº›èµ„æºï¼Œå¹¶æ ¹æ®è¿™ä¸ªè¡¨å›æ»š 1234567891011121314-- æ³¨æ„æ­¤å¤„0.3.0+ å¢åŠ å”¯ä¸€ç´¢å¼• ux_undo_logCREATE TABLE `undo_log` ( `id` bigint(20) NOT NULL AUTO_INCREMENT, `branch_id` bigint(20) NOT NULL, `xid` varchar(100) NOT NULL, `context` varchar(128) NOT NULL, `rollback_info` longblob NOT NULL, `log_status` int(11) NOT NULL, `log_created` datetime NOT NULL, `log_modified` datetime NOT NULL, `ext` varchar(100) DEFAULT NULL, PRIMARY KEY (`id`), UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8; å¼•å…¥ pom ä¾èµ–ï¼š 12345&lt;dependency&gt; &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-alibaba-seata&lt;/artifactId&gt; &lt;version&gt;$&#123;spring-cloud-alibaba.version&#125;&lt;/version&gt;&lt;/dependency&gt; application.ymlï¼š 1234567891011121314151617spring: application: name: seata-order-service cloud: alibaba: seata: # è‡ªå®šä¹‰äº‹åŠ¡ç»„åç§°éœ€è¦ä¸seata-serverä¸­file.confä¸­é…ç½®çš„äº‹åŠ¡ç»„IDå¯¹åº” # vgroup_mapping.my_test_tx_group = &quot;my_group&quot; tx-service-group: my_group nacos: discovery: server-addr: localhost:8848 datasource: driver-class-name: com.mysql.cj.jdbc.Driver url: jdbc:mysql://localhost:3306/seata_order?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=UTC username: root password: 123456 æ„å»ºä¸‰ä¸ªæœåŠ¡ï¼š 1234567891011121314151617// ä»“å‚¨æœåŠ¡public interface StorageService &#123; // æ‰£é™¤å­˜å‚¨æ•°é‡ void deduct(String commodityCode, int count);&#125;// è®¢å•æœåŠ¡public interface OrderService &#123; // åˆ›å»ºè®¢å• Order create(String userId, String commodityCode, int orderCount);&#125;// å¸æˆ·æœåŠ¡public interface AccountService &#123; // ä»ç”¨æˆ·è´¦æˆ·ä¸­å€Ÿå‡º void debit(String userId, int money);&#125; ä¸šåŠ¡é€»è¾‘ï¼šå¢åŠ  @GlobalTransactional æ³¨è§£ 123456789101112131415161718192021public class OrderServiceImpl implements OrderService &#123; @Resource private OrderDAO orderDAO; @Resource private AccountService accountService; @Transactional(rollbackFor = Exception.class) public Order create(String userId, String commodityCode, int orderCount) &#123; int orderMoney = calculate(commodityCode, orderCount); // è´¦æˆ·æ‰£é’± accountService.debit(userId, orderMoney); Order order = new Order(); order.userId = userId; order.commodityCode = commodityCode; order.count = orderCount; order.money = orderMoney; return orderDAO.insert(order); &#125;&#125; 1234567891011121314public class BusinessServiceImpl implements BusinessService &#123; @Resource private StorageService storageService; @Resource private OrderService orderService; // é‡‡è´­ï¼Œæ¶‰åŠå¤šæœåŠ¡çš„åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ @GlobalTransactional @Transactional(rollbackFor = Exception.class) public void purchase(String userId, String commodityCode, int orderCount) &#123; storageService.deduct(commodityCode, orderCount); orderService.create(userId, commodityCode, orderCount); &#125;&#125; è¯¦ç»†ç¤ºä¾‹å‚è€ƒï¼šhttps://github.com/seata/seata-samples/tree/master/springcloud-nacos-seata","categories":[],"tags":[]},{"title":"","slug":"README","date":"2025-05-20T16:25:06.359Z","updated":"2023-04-07T03:39:44.000Z","comments":true,"path":"2025/05/21/README/","link":"","permalink":"https://dddwah11.github.io/2025/05/21/README/","excerpt":"","text":"Java å­¦ä¹ ç¬”è®°ï¼Œè®°å½•ä½œè€…ä»ç¼–ç¨‹å…¥é—¨åˆ°æ·±å…¥å­¦ä¹ çš„æ‰€æœ‰çŸ¥è¯†ï¼Œæ¯æ¬¡å­¦æœ‰æ‰€è·éƒ½ä¼šæ›´æ–°ç¬”è®°ï¼Œæ’ç‰ˆå¸ƒå±€ç¾è§‚æ•´æ´ï¼Œå¸Œæœ›å¯¹å„ä½è¯»è€…æœ‹å‹æœ‰æ‰€å¸®åŠ©ã€‚ ä¸ªäººé‚®ç®±ï¼š&#x69;&#x6d;&#x73;&#101;&#x61;&#122;&#101;&#97;&#x6e;&#64;&#103;&#x6d;&#97;&#x69;&#108;&#46;&#99;&#x6f;&#x6d; å†…å®¹è¯´æ˜ï¼š DBï¼šMySQLã€Redis Frameï¼šMavenã€Nettyã€RocketMQã€Zookeeper Javaï¼šJavaSEã€JVMã€Algorithm Progï¼šConcurrentã€Network Programming SSMï¼šMyBatisã€Springã€SpringMVCã€SpringBootã€SpringCloud Toolï¼šGitã€Linuxã€Docker Webï¼šHTMLã€CSSã€HTTPã€Servletã€JavaScript å…¶ä»–è¯´æ˜ï¼š æ¨èä½¿ç”¨ Typora é˜…è¯»ç¬”è®°ï¼Œæ‰“å¼€ç›®å½•æ æ•ˆæœæ›´ä½³ã€‚ æ‰€æœ‰çš„çŸ¥è¯†ä¸ä¿è¯æƒå¨æ€§ï¼Œå¦‚æœå„ä½æœ‹å‹å‘ç°é”™è¯¯ï¼Œæ¬¢è¿ä¸æˆ‘è®¨è®ºã€‚ ç¬”è®°çš„ç¼–å†™åŸºäº Windows å¹³å°ï¼Œå¯èƒ½ä¼šå› ä¸ºå¹³å°çš„ä¸åŒè€Œé€ æˆç©ºæ ¼ã€åˆ¶è¡¨ç¬¦çš„æ˜¾ç¤ºæ•ˆæœä¸åŒã€‚","categories":[],"tags":[]},{"title":"","slug":"Frame","date":"2025-05-20T16:25:06.348Z","updated":"2023-04-07T03:39:44.000Z","comments":true,"path":"2025/05/21/Frame/","link":"","permalink":"https://dddwah11.github.io/2025/05/21/Frame/","excerpt":"","text":"MavenåŸºæœ¬ä»‹ç»Mvnä»‹ç»Mavenï¼šæœ¬è´¨æ˜¯ä¸€ä¸ªé¡¹ç›®ç®¡ç†å·¥å…·ï¼Œå°†é¡¹ç›®å¼€å‘å’Œç®¡ç†è¿‡ç¨‹æŠ½è±¡æˆä¸€ä¸ªé¡¹ç›®å¯¹è±¡æ¨¡å‹ï¼ˆPOMï¼‰ POMï¼šProject Object Model é¡¹ç›®å¯¹è±¡æ¨¡å‹ã€‚Maven æ˜¯ç”¨ Java è¯­è¨€ç¼–å†™çš„ï¼Œç®¡ç†çš„ä¸œè¥¿ä»¥é¢å‘å¯¹è±¡çš„å½¢å¼è¿›è¡Œè®¾è®¡ï¼Œæœ€ç»ˆæŠŠä¸€ä¸ªé¡¹ç›®çœ‹æˆä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å«åš POM pom.xmlï¼šMaven éœ€è¦ä¸€ä¸ª pom.xml æ–‡ä»¶ï¼ŒMaven é€šè¿‡åŠ è½½è¿™ä¸ªé…ç½®æ–‡ä»¶å¯ä»¥çŸ¥é“é¡¹ç›®çš„ç›¸å…³ä¿¡æ¯ï¼Œè¿™ä¸ªæ–‡ä»¶ä»£è¡¨å°±ä¸€ä¸ªé¡¹ç›®ã€‚å¦‚æœåš 8 ä¸ªé¡¹ç›®ï¼Œå¯¹åº”çš„æ˜¯ 8 ä¸ª pom.xml æ–‡ä»¶ ä¾èµ–ç®¡ç†ï¼šMaven å¯¹é¡¹ç›®æ‰€æœ‰ä¾èµ–èµ„æºçš„ä¸€ç§ç®¡ç†ï¼Œå®ƒå’Œé¡¹ç›®ä¹‹é—´æ˜¯ä¸€ç§åŒå‘å…³ç³»ï¼Œå³åšé¡¹ç›®æ—¶å¯ä»¥ç®¡ç†æ‰€éœ€è¦çš„å…¶ä»–èµ„æºï¼Œå½“å…¶ä»–é¡¹ç›®éœ€è¦ä¾èµ–æˆ‘ä»¬é¡¹ç›®æ—¶ï¼ŒMaven ä¹Ÿä¼šæŠŠæˆ‘ä»¬çš„é¡¹ç›®å½“ä½œä¸€ç§èµ„æºå»è¿›è¡Œç®¡ç†ã€‚ ç®¡ç†èµ„æºçš„å­˜å‚¨ä½ç½®ï¼šæœ¬åœ°ä»“åº“ï¼Œç§æœï¼Œä¸­å¤®ä»“åº“ åŸºæœ¬ä½œç”¨ï¼š é¡¹ç›®æ„å»ºï¼šæä¾›æ ‡å‡†çš„ï¼Œè·¨å¹³å°çš„è‡ªåŠ¨åŒ–æ„å»ºé¡¹ç›®çš„æ–¹å¼ ä¾èµ–ç®¡ç†ï¼šæ–¹ä¾¿å¿«æ·çš„ç®¡ç†é¡¹ç›®ä¾èµ–çš„èµ„æºï¼ˆjar åŒ…ï¼‰ï¼Œé¿å…èµ„æºé—´çš„ç‰ˆæœ¬å†²çªç­‰é—®é¢˜ ç»Ÿä¸€å¼€å‘ç»“æ„ï¼šæä¾›æ ‡å‡†çš„ï¼Œç»Ÿä¸€çš„é¡¹ç›®å¼€å‘ç»“æ„ å„ç›®å½•å­˜æ”¾èµ„æºç±»å‹è¯´æ˜ï¼š src&#x2F;main&#x2F;javaï¼šé¡¹ç›® java æºç  src&#x2F;main&#x2F;resourcesï¼šé¡¹ç›®çš„ç›¸å…³é…ç½®æ–‡ä»¶ï¼ˆæ¯”å¦‚ mybatis é…ç½®ï¼Œxml æ˜ å°„é…ç½®ï¼Œè‡ªå®šä¹‰é…ç½®æ–‡ä»¶ç­‰ï¼‰ src&#x2F;main&#x2F;webappï¼šweb èµ„æºï¼ˆæ¯”å¦‚ htmlã€cssã€js ç­‰ï¼‰ src&#x2F;test&#x2F;javaï¼šæµ‹è¯•ä»£ç  src&#x2F;test&#x2F;resourcesï¼šæµ‹è¯•ç›¸å…³é…ç½®æ–‡ä»¶ src&#x2F;pom.xmlï¼šé¡¹ç›® pom æ–‡ä»¶ å‚è€ƒè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV1Ah411S7ZE åŸºç¡€æ¦‚å¿µä»“åº“ï¼šç”¨äºå­˜å‚¨èµ„æºï¼Œä¸»è¦æ˜¯å„ç§ jar åŒ…ã€‚æœ‰æœ¬åœ°ä»“åº“ï¼Œç§æœï¼Œä¸­å¤®ä»“åº“ï¼Œç§æœå’Œä¸­å¤®ä»“åº“éƒ½æ˜¯è¿œç¨‹ä»“åº“ ä¸­å¤®ä»“åº“ï¼šMaven å›¢é˜Ÿè‡ªèº«ç»´æŠ¤çš„ä»“åº“ï¼Œå±äºå¼€æºçš„ ç§æœï¼šå„å…¬å¸&#x2F;éƒ¨é—¨ç­‰å°èŒƒå›´å†…å­˜å‚¨èµ„æºçš„ä»“åº“ï¼Œç§æœä¹Ÿå¯ä»¥ä»ä¸­å¤®ä»“åº“è·å–èµ„æºï¼Œä½œç”¨ï¼š ä¿å­˜å…·æœ‰ç‰ˆæƒçš„èµ„æºï¼ŒåŒ…å«è´­ä¹°æˆ–è‡ªä¸»ç ”å‘çš„ jar ä¸€å®šèŒƒå›´å†…å…±äº«èµ„æºï¼Œèƒ½åšåˆ°ä»…å¯¹å†…ä¸å¯¹å¤–å¼€æ”¾ æœ¬åœ°ä»“åº“ï¼šå¼€å‘è€…è‡ªå·±ç”µè„‘ä¸Šå­˜å‚¨èµ„æºçš„ä»“åº“ï¼Œä¹Ÿå¯ä»è¿œç¨‹ä»“åº“è·å–èµ„æº åæ ‡ï¼šMaven ä¸­çš„åæ ‡ç”¨äºæè¿°ä»“åº“ä¸­èµ„æºçš„ä½ç½® ä½œç”¨ï¼šä½¿ç”¨å”¯ä¸€æ ‡è¯†ï¼Œå”¯ä¸€æ€§å®šä¹‰èµ„æºä½ç½®ï¼Œé€šè¿‡è¯¥æ ‡è¯†å¯ä»¥å°†èµ„æºçš„è¯†åˆ«ä¸ä¸‹è½½å·¥ä½œäº¤ç”±æœºå™¨å®Œæˆ https://mvnrepository.comï¼šæŸ¥è¯¢ maven æŸä¸€ä¸ªèµ„æºçš„åæ ‡ï¼Œè¾“å…¥èµ„æºåç§°è¿›è¡Œæ£€ç´¢ ä¾èµ–è®¾ç½®ï¼š groupIdï¼šå®šä¹‰å½“å‰èµ„æºéš¶å±ç»„ç»‡åç§°ï¼ˆé€šå¸¸æ˜¯åŸŸååå†™ï¼Œå¦‚ï¼šorg.mybatisï¼‰ artifactIdï¼šå®šä¹‰å½“å‰èµ„æºçš„åç§°ï¼ˆé€šå¸¸æ˜¯é¡¹ç›®æˆ–æ¨¡å—åç§°ï¼Œå¦‚ï¼šcrmã€smsï¼‰ versionï¼šå®šä¹‰å½“å‰èµ„æºçš„ç‰ˆæœ¬å· packagingï¼šå®šä¹‰èµ„æºçš„æ‰“åŒ…æ–¹å¼ï¼Œå–å€¼ä¸€èˆ¬æœ‰å¦‚ä¸‹ä¸‰ç§ jarï¼šè¯¥èµ„æºæ‰“æˆ jar åŒ…ï¼Œé»˜è®¤æ˜¯ jar warï¼šè¯¥èµ„æºæ‰“æˆ war åŒ… pomï¼šè¯¥èµ„æºæ˜¯ä¸€ä¸ªçˆ¶èµ„æºï¼ˆè¡¨æ˜ä½¿ç”¨ Maven åˆ†æ¨¡å—ç®¡ç†ï¼‰ï¼Œæ‰“åŒ…æ—¶åªç”Ÿæˆä¸€ä¸ª pom.xml ä¸ç”Ÿæˆ jar æˆ–å…¶ä»–åŒ…ç»“æ„ ç¯å¢ƒæ­å»ºç¯å¢ƒé…ç½®Maven çš„å®˜ç½‘ï¼šhttp://maven.apache.org/ ä¸‹è½½å®‰è£…ï¼šMaven æ˜¯ä¸€ä¸ªç»¿è‰²è½¯ä»¶ï¼Œè§£å‹å³å®‰è£… ç›®å½•ç»“æ„ï¼š binï¼šå¯æ‰§è¡Œç¨‹åºç›®å½• bootï¼šMaven è‡ªèº«çš„å¯åŠ¨åŠ è½½å™¨ confï¼šMaven é…ç½®æ–‡ä»¶çš„å­˜æ”¾ç›®å½• libï¼šMavenè¿è¡Œæ‰€éœ€åº“çš„å­˜æ”¾ç›®å½• é…ç½® MAVEN_HOMEï¼š Path ä¸‹é…ç½®ï¼š%MAVEN_HOME%\\bin ç¯å¢ƒå˜é‡é…ç½®å¥½ä¹‹åéœ€è¦æµ‹è¯•ç¯å¢ƒé…ç½®ç»“æœï¼Œåœ¨ DOS å‘½ä»¤çª—å£ä¸‹è¾“å…¥ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹è¾“å‡ºï¼šmvn -v ä»“åº“é…ç½®é»˜è®¤æƒ…å†µ Maven æœ¬åœ°ä»“åº“åœ¨ç³»ç»Ÿç”¨æˆ·ç›®å½•ä¸‹çš„ .m2/repositoryï¼Œä¿®æ”¹ Maven çš„é…ç½®æ–‡ä»¶ conf/settings.xml æ¥ä¿®æ”¹ä»“åº“ä½ç½® ä¿®æ”¹æœ¬åœ°ä»“åº“ä½ç½®ï¼šæ‰¾åˆ° æ ‡ç­¾ï¼Œä¿®æ”¹é»˜è®¤å€¼ 123456&lt;!-- localRepository| The path to the local repository maven will use to store artifacts.| Default: $&#123;user.home&#125;/.m2/repository&lt;localRepository&gt;/path/to/local/repo&lt;/localRepository&gt;--&gt;&lt;localRepository&gt;E:\\Workspace\\Java\\Project\\.m2\\repository&lt;/localRepository&gt; æ³¨æ„ï¼šåœ¨ä»“åº“çš„åŒçº§ç›®å½•å³ .m2 ä¹Ÿåº”è¯¥åŒ…å«ä¸€ä¸ª settings.xml é…ç½®æ–‡ä»¶ï¼Œå±€éƒ¨ç”¨æˆ·é…ç½®ä¼˜å…ˆä¸å…¨å±€é…ç½® å…¨å±€ setting å®šä¹‰äº† Maven çš„å…¬å…±é…ç½® ç”¨æˆ· setting å®šä¹‰äº†å½“å‰ç”¨æˆ·çš„é…ç½® ä¿®æ”¹è¿œç¨‹ä»“åº“ï¼šåœ¨é…ç½®æ–‡ä»¶ä¸­æ‰¾åˆ° &lt;mirrors&gt; æ ‡ç­¾ï¼Œåœ¨è¿™ç»„æ ‡ç­¾ä¸‹æ·»åŠ å›½å†…é•œåƒ 123456&lt;mirror&gt; &lt;id&gt;nexus-aliyun&lt;/id&gt; &lt;mirrorOf&gt;central&lt;/mirrorOf&gt; &lt;!--å¿…é¡»æ˜¯central--&gt; &lt;name&gt;Nexus aliyun&lt;/name&gt; &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public&lt;/url&gt;&lt;/mirror&gt; ä¿®æ”¹é»˜è®¤ JDKï¼šåœ¨é…ç½®æ–‡ä»¶ä¸­æ‰¾åˆ° &lt;profiles&gt; æ ‡ç­¾ï¼Œæ·»åŠ é…ç½® 123456789101112&lt;profile&gt; &lt;id&gt;jdk-10&lt;/id&gt; &lt;activation&gt; &lt;activeByDefault&gt;true&lt;/activeByDefault&gt; &lt;jdk&gt;10&lt;/jdk&gt; &lt;/activation&gt; &lt;properties&gt; &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt; &lt;maven.compiler.source&gt;10&lt;/maven.compiler.source&gt; &lt;maven.compiler.target&gt;10&lt;/maven.compiler.target&gt; &lt;/properties&gt; &lt;/profile&gt; é¡¹ç›®æ­å»ºæ‰‹åŠ¨æ­å»º åœ¨ E ç›˜ä¸‹åˆ›å»ºç›®å½• mvnproject è¿›å…¥è¯¥ç›®å½•ï¼Œä½œä¸ºæˆ‘ä»¬çš„æ“ä½œç›®å½• åˆ›å»ºæˆ‘ä»¬çš„ Maven é¡¹ç›®ï¼Œåˆ›å»ºä¸€ä¸ªç›®å½• project-java ä½œä¸ºæˆ‘ä»¬çš„é¡¹ç›®æ–‡ä»¶å¤¹ï¼Œå¹¶è¿›å…¥åˆ°è¯¥ç›®å½• åˆ›å»º Java ä»£ç ï¼ˆæºä»£ç ï¼‰æ‰€åœ¨ç›®å½•ï¼Œå³åˆ›å»º src/main/java åˆ›å»ºé…ç½®æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼Œå³åˆ›å»º src/main/resources åˆ›å»ºæµ‹è¯•æºä»£ç æ‰€åœ¨ç›®å½•ï¼Œå³åˆ›å»º src/test/java åˆ›å»ºæµ‹è¯•å­˜æ”¾é…ç½®æ–‡ä»¶å­˜æ”¾ç›®å½•ï¼Œå³ src/test/resources åœ¨ src/main/java ä¸­åˆ›å»ºä¸€ä¸ªåŒ…ï¼ˆæ³¨æ„åœ¨ Windos æ–‡ä»¶å¤¹ä¸‹å°±æ˜¯åˆ›å»ºç›®å½•ï¼‰demoï¼Œåœ¨è¯¥ç›®å½•ä¸‹åˆ›å»º Demo.java æ–‡ä»¶ï¼Œä½œä¸ºæ¼”ç¤ºæ‰€éœ€ Java ç¨‹åºï¼Œå†…å®¹å¦‚ä¸‹ 1234567package demo;public class Demo&#123; public String say(String name)&#123; System.out.println(&quot;hello &quot;+name); return &quot;hello &quot;+name; &#125;&#125; åœ¨ src/test/java ä¸­åˆ›å»ºä¸€ä¸ªæµ‹è¯•åŒ…ï¼ˆç›®å½•ï¼‰demoï¼Œåœ¨è¯¥åŒ…ä¸‹åˆ›å»ºæµ‹è¯•ç¨‹åº DemoTest.java 12345678910package demo;import org.junit.*;public class DemoTest&#123; @Test public void testSay()&#123; Demo d = new Demo(); String ret = d.say(&quot;maven&quot;); Assert.assertEquals(&quot;hello maven&quot;,ret); &#125;&#125; åœ¨ project-java/src ä¸‹åˆ›å»º pom.xml æ–‡ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&quot;&gt; &lt;!--æŒ‡å®špomçš„æ¨¡å‹ç‰ˆæœ¬--&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;!--æ‰“åŒ…æ–¹å¼ï¼Œwebå·¥ç¨‹æ‰“åŒ…ä¸ºwarï¼Œjavaå·¥ç¨‹æ‰“åŒ…ä¸ºjar --&gt; &lt;packaging&gt;jar&lt;/packaging&gt; &lt;!--ç»„ç»‡id--&gt; &lt;groupId&gt;demo&lt;/groupId&gt; &lt;!--é¡¹ç›®id--&gt; &lt;artifactId&gt;project-java&lt;/artifactId&gt; &lt;!--ç‰ˆæœ¬å·:release,snapshot--&gt; &lt;version&gt;1.0&lt;/version&gt; &lt;!--è®¾ç½®å½“å‰å·¥ç¨‹çš„æ‰€æœ‰ä¾èµ–--&gt; &lt;dependencies&gt; &lt;!--å…·ä½“çš„ä¾èµ–--&gt; &lt;dependency&gt; &lt;groupId&gt;junit&lt;/groupId&gt; &lt;artifactId&gt;junit&lt;/artifactId&gt; &lt;version&gt;4.12&lt;/version&gt; &lt;/dependency&gt; &lt;/dependencies&gt;&lt;/project&gt; æ­å»ºå®Œæˆ Maven çš„é¡¹ç›®ç»“æ„ï¼Œé€šè¿‡ Maven æ¥æ„å»ºé¡¹ç›®ã€‚Maven çš„æ„å»ºå‘½ä»¤ä»¥ mvn å¼€å¤´ï¼Œåé¢æ·»åŠ åŠŸèƒ½å‚æ•°ï¼Œå¯ä»¥ä¸€æ¬¡æ€§æ‰§è¡Œå¤šä¸ªå‘½ä»¤ï¼Œç”¨ç©ºæ ¼åˆ†ç¦» mvn compileï¼šç¼–è¯‘ mvn cleanï¼šæ¸…ç† mvn testï¼šæµ‹è¯• mvn packageï¼šæ‰“åŒ… mvn installï¼šå®‰è£…åˆ°æœ¬åœ°ä»“åº“ æ³¨æ„ï¼šæ‰§è¡ŒæŸä¸€æ¡å‘½ä»¤ï¼Œåˆ™ä¼šæŠŠå‰é¢æ‰€æœ‰çš„éƒ½æ‰§è¡Œä¸€é IDEAæ­å»ºä¸ç”¨åŸå‹ åœ¨ IDEA ä¸­é…ç½® Mavenï¼Œé€‰æ‹© maven3.6.1 é˜²æ­¢ä¾èµ–é—®é¢˜ åˆ›å»º Mavenï¼ŒNew Module â†’ Maven â†’ ä¸é€‰ä¸­ Create from archetype å¡«å†™é¡¹ç›®çš„åæ ‡ GroupIdï¼šdemo ArtifactIdï¼šproject-java æŸ¥çœ‹å„ç›®å½•é¢œè‰²æ ‡è®°æ˜¯å¦æ­£ç¡® IDEA å³ä¾§ä¾§æ æœ‰ Maven Projectï¼Œæ‰“å¼€åæœ‰ Lifecycle ç”Ÿå‘½å‘¨æœŸ è‡ªå®šä¹‰ Maven å‘½ä»¤ï¼šRun â†’ Edit Configurations â†’ å·¦ä¸Šè§’ + â†’ Maven ä½¿ç”¨åŸå‹æ™®é€šå·¥ç¨‹ï¼š åˆ›å»º Maven é¡¹ç›®çš„æ—¶å€™é€‰æ‹©ä½¿ç”¨åŸå‹éª¨æ¶ åˆ›å»ºå®Œæˆåå‘ç°é€šè¿‡è¿™ç§æ–¹å¼ç¼ºå°‘ä¸€äº›ç›®å½•ï¼Œéœ€è¦æ‰‹åŠ¨å»è¡¥å…¨ç›®å½•ï¼Œå¹¶ä¸”è¦å¯¹è¡¥å…¨çš„ç›®å½•è¿›è¡Œæ ‡è®° Web å·¥ç¨‹ï¼š é€‰æ‹© Web å¯¹åº”çš„åŸå‹éª¨æ¶ï¼ˆé€‰æ‹© Maven å¼€å¤´çš„æ˜¯ç®€åŒ–çš„ï¼‰ é€šè¿‡åŸå‹åˆ›å»º Web é¡¹ç›®å¾—åˆ°çš„ç›®å½•ç»“æ„æ˜¯ä¸å…¨çš„ï¼Œå› æ­¤éœ€è¦æˆ‘ä»¬è‡ªè¡Œè¡¥å…¨ï¼ŒåŒæ—¶è¦æ ‡è®°æ­£ç¡® Web å·¥ç¨‹åˆ›å»ºä¹‹åéœ€è¦å¯åŠ¨è¿è¡Œï¼Œä½¿ç”¨ tomcat æ’ä»¶æ¥è¿è¡Œé¡¹ç›®ï¼Œåœ¨ pom.xml ä¸­æ·»åŠ æ’ä»¶çš„åæ ‡ï¼š 1234567891011121314151617181920212223242526272829303132333435&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&quot;&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;packaging&gt;war&lt;/packaging&gt; &lt;name&gt;web01&lt;/name&gt; &lt;groupId&gt;demo&lt;/groupId&gt; &lt;artifactId&gt;web01&lt;/artifactId&gt; &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt; &lt;dependencies&gt; &lt;/dependencies&gt; &lt;!--æ„å»º--&gt; &lt;build&gt; &lt;!--è®¾ç½®æ’ä»¶--&gt; &lt;plugins&gt; &lt;!--å…·ä½“çš„æ’ä»¶é…ç½®--&gt; &lt;plugin&gt; &lt;!--https://mvnrepository.com/ æœç´¢--&gt; &lt;groupId&gt;org.apache.tomcat.maven&lt;/groupId&gt; &lt;artifactId&gt;tomcat7-maven-plugin&lt;/artifactId&gt; &lt;version&gt;2.1&lt;/version&gt; &lt;configuration&gt; &lt;port&gt;80&lt;/port&gt; &lt;!--80ç«¯å£é»˜è®¤ä¸æ˜¾ç¤º--&gt; &lt;path&gt;/&lt;/path&gt; &lt;/configuration&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt;&lt;/project&gt; æ’ä»¶é…ç½®ä»¥åï¼Œåœ¨ IDEA å³ä¾§ maven-project æ“ä½œé¢æ¿çœ‹åˆ°è¯¥æ’ä»¶ï¼Œå¹¶ä¸”å¯ä»¥åˆ©ç”¨è¯¥æ’ä»¶å¯åŠ¨é¡¹ç›®ï¼Œweb01 â†’ Plugins â†’ tomcat7 â†’ tomcat7:run ä¾èµ–ç®¡ç†ä¾èµ–é…ç½®ä¾èµ–æ˜¯æŒ‡åœ¨å½“å‰é¡¹ç›®ä¸­è¿è¡Œæ‰€éœ€çš„ jarï¼Œä¾èµ–é…ç½®çš„æ ¼å¼å¦‚ä¸‹ï¼š 123456789101112&lt;!--è®¾ç½®å½“å‰é¡¹ç›®æ‰€ä¾èµ–çš„æ‰€æœ‰jar--&gt;&lt;dependencies&gt; &lt;!--è®¾ç½®å…·ä½“çš„ä¾èµ–--&gt; &lt;dependency&gt; &lt;!--ä¾èµ–æ‰€å±ç¾¤ç»„id--&gt; &lt;groupId&gt;junit&lt;/groupId&gt; &lt;!--ä¾èµ–æ‰€å±é¡¹ç›®id--&gt; &lt;artifactId&gt;junit&lt;/artifactId&gt; &lt;!--ä¾èµ–ç‰ˆæœ¬å·--&gt; &lt;version&gt;4.12&lt;/version&gt; &lt;/dependency&gt;&lt;/dependencies&gt; ä¾èµ–ä¼ é€’ä¾èµ–å…·æœ‰ä¼ é€’æ€§ï¼Œåˆ†ä¸¤ç§ï¼š ç›´æ¥ä¾èµ–ï¼šåœ¨å½“å‰é¡¹ç›®ä¸­é€šè¿‡ä¾èµ–é…ç½®å»ºç«‹çš„ä¾èµ–å…³ç³» é—´æ¥ä¾èµ–ï¼šè¢«ä¾èµ–çš„èµ„æºå¦‚æœä¾èµ–å…¶ä»–èµ„æºï¼Œåˆ™è¡¨æ˜å½“å‰é¡¹ç›®é—´æ¥ä¾èµ–å…¶ä»–èµ„æº æ³¨æ„ï¼šç›´æ¥ä¾èµ–å’Œé—´æ¥ä¾èµ–å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªç›¸å¯¹å…³ç³» ä¾èµ–ä¼ é€’çš„å†²çªé—®é¢˜ï¼šåœ¨ä¾èµ–ä¼ é€’è¿‡ç¨‹ä¸­äº§ç”Ÿäº†å†²çªï¼Œæœ‰ä¸‰ç§ä¼˜å…ˆæ³•åˆ™ è·¯å¾„ä¼˜å…ˆï¼šå½“ä¾èµ–ä¸­å‡ºç°ç›¸åŒèµ„æºæ—¶ï¼Œå±‚çº§è¶Šæ·±ï¼Œä¼˜å…ˆçº§è¶Šä½ï¼Œåä¹‹åˆ™è¶Šé«˜ å£°æ˜ä¼˜å…ˆï¼šå½“èµ„æºåœ¨ç›¸åŒå±‚çº§è¢«ä¾èµ–æ—¶ï¼Œé…ç½®é¡ºåºé å‰çš„è¦†ç›–é åçš„ ç‰¹æ®Šä¼˜å…ˆï¼šå½“åŒçº§é…ç½®äº†ç›¸åŒèµ„æºçš„ä¸åŒç‰ˆæœ¬æ—¶ï¼Œåé…ç½®çš„è¦†ç›–å…ˆé…ç½®çš„ å¯é€‰ä¾èµ–ï¼šå¯¹å¤–éšè—å½“å‰æ‰€ä¾èµ–çš„èµ„æºï¼Œä¸é€æ˜ 1234567&lt;dependency&gt; &lt;groupId&gt;junit&lt;/groupId&gt; &lt;artifactId&gt;junit&lt;/artifactId&gt; &lt;version&gt;4.11&lt;/version&gt; &lt;optional&gt;true&lt;/optional&gt; &lt;!--é»˜è®¤æ˜¯falseï¼Œtrueä»¥åå°±å˜å¾—ä¸é€æ˜--&gt;&lt;/dependency&gt; æ’é™¤ä¾èµ–ï¼šä¸»åŠ¨æ–­å¼€ä¾èµ–çš„èµ„æºï¼Œè¢«æ’é™¤çš„èµ„æºæ— éœ€æŒ‡å®šç‰ˆæœ¬ 1234567891011&lt;dependency&gt; &lt;groupId&gt;junit&lt;/groupId&gt; &lt;artifactId&gt;junit&lt;/artifactId&gt; &lt;version&gt;4.12&lt;/version&gt; &lt;exclusions&gt; &lt;exclusion&gt; &lt;groupId&gt;org.hamcrest&lt;/groupId&gt; &lt;!--æ’é™¤è¿™ä¸ªèµ„æº--&gt; &lt;artifactId&gt;hamcrest-core&lt;/artifactId&gt; &lt;/exclusion&gt; &lt;/exclusions&gt;&lt;/dependency&gt; ä¾èµ–èŒƒå›´ä¾èµ–çš„ jar é»˜è®¤æƒ…å†µå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹å¯ç”¨ï¼Œå¯ä»¥é€šè¿‡ scope æ ‡ç­¾è®¾å®šå…¶ä½œç”¨èŒƒå›´ï¼Œæœ‰ä¸‰ç§ï¼š ä¸»ç¨‹åºèŒƒå›´æœ‰æ•ˆï¼ˆsrc&#x2F;main ç›®å½•èŒƒå›´å†…ï¼‰ æµ‹è¯•ç¨‹åºèŒƒå›´å†…æœ‰æ•ˆï¼ˆsrc&#x2F;test ç›®å½•èŒƒå›´å†…ï¼‰ æ˜¯å¦å‚ä¸æ‰“åŒ…ï¼ˆpackage æŒ‡ä»¤èŒƒå›´å†…ï¼‰ scope æ ‡ç­¾çš„å–å€¼æœ‰å››ç§ï¼šcompile,test,provided,runtime ä¾èµ–èŒƒå›´çš„ä¼ é€’æ€§ï¼š ç”Ÿå‘½å‘¨æœŸç›¸å…³äº‹ä»¶Maven çš„æ„å»ºç”Ÿå‘½å‘¨æœŸæè¿°çš„æ˜¯ä¸€æ¬¡æ„å»ºè¿‡ç¨‹ç»å†äº†å¤šå°‘ä¸ªäº‹ä»¶ æœ€å¸¸ç”¨çš„ä¸€å¥—æµç¨‹ï¼šcompile â†’ test-compile â†’ test â†’ package â†’ install cleanï¼šæ¸…ç†å·¥ä½œ pre-cleanï¼šæ‰§è¡Œä¸€äº›åœ¨ clean ä¹‹å‰çš„å·¥ä½œ cleanï¼šç§»é™¤ä¸Šä¸€æ¬¡æ„å»ºäº§ç”Ÿçš„æ‰€æœ‰æ–‡ä»¶ post-cleanï¼šæ‰§è¡Œä¸€äº›åœ¨ clean ä¹‹åç«‹åˆ»å®Œæˆçš„å·¥ä½œ defaultï¼šæ ¸å¿ƒå·¥ä½œï¼Œä¾‹å¦‚ç¼–è¯‘ï¼Œæµ‹è¯•ï¼Œæ‰“åŒ…ï¼Œéƒ¨ç½²ç­‰ï¼Œæ¯ä¸ªäº‹ä»¶åœ¨æ‰§è¡Œä¹‹å‰éƒ½ä¼šå°†ä¹‹å‰çš„æ‰€æœ‰äº‹ä»¶ä¾æ¬¡æ‰§è¡Œä¸€é siteï¼šäº§ç”ŸæŠ¥å‘Šï¼Œå‘å¸ƒç«™ç‚¹ç­‰ pre-siteï¼šæ‰§è¡Œä¸€äº›åœ¨ç”Ÿæˆç«™ç‚¹æ–‡æ¡£ä¹‹å‰çš„å·¥ä½œ siteï¼šç”Ÿæˆé¡¹ç›®çš„ç«™ç‚¹æ–‡æ¡£ post-siteï¼šæ‰§è¡Œä¸€äº›åœ¨ç”Ÿæˆç«™ç‚¹æ–‡æ¡£ä¹‹åå®Œæˆçš„å·¥ä½œï¼Œå¹¶ä¸ºéƒ¨ç½²åšå‡†å¤‡ site-deployï¼šå°†ç”Ÿæˆçš„ç«™ç‚¹æ–‡æ¡£éƒ¨ç½²åˆ°ç‰¹å®šçš„æœåŠ¡å™¨ä¸Š æ‰§è¡Œäº‹ä»¶Maven çš„æ’ä»¶ç”¨æ¥æ‰§è¡Œç”Ÿå‘½å‘¨æœŸä¸­çš„ç›¸å…³äº‹ä»¶ æ’ä»¶ä¸ç”Ÿå‘½å‘¨æœŸå†…çš„é˜¶æ®µç»‘å®šï¼Œåœ¨æ‰§è¡Œåˆ°å¯¹åº”ç”Ÿå‘½å‘¨æœŸæ—¶æ‰§è¡Œå¯¹åº”çš„æ’ä»¶ Maven é»˜è®¤åœ¨å„ä¸ªç”Ÿå‘½å‘¨æœŸä¸Šéƒ½ç»‘å®šäº†é¢„å…ˆè®¾å®šçš„æ’ä»¶æ¥å®Œæˆç›¸åº”åŠŸèƒ½ æ’ä»¶è¿˜å¯ä»¥å®Œæˆä¸€äº›è‡ªå®šä¹‰åŠŸèƒ½ 1234567891011121314151617181920212223&lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-source-plugin&lt;/artifactId&gt; &lt;version&gt;2.2.1&lt;/version&gt; &lt;!--æ‰§è¡Œ--&gt; &lt;excutions&gt; &lt;!--å…·ä½“æ‰§è¡Œä½ç½®--&gt; &lt;excution&gt; &lt;goals&gt; &lt;!--å¯¹æºç è¿›è¡Œæ‰“åŒ…ï¼Œæ‰“åŒ…æ”¾åœ¨targetç›®å½•--&gt; &lt;goal&gt;jar&lt;/goal&gt; &lt;!--å¯¹æµ‹è¯•ä»£ç è¿›è¡Œæ‰“åŒ…--&gt; &lt;goal&gt;test-jar&lt;/goal&gt; &lt;/goals&gt; &lt;!--æ‰§è¡Œçš„ç”Ÿå‘½å‘¨æœŸ--&gt; &lt;phase&gt;generate-test-resources&lt;/phase&gt; &lt;/excution&gt; &lt;/excutions&gt; &lt;/plugin&gt; &lt;/plugins&gt;&lt;/build&gt; æ¨¡å—å¼€å‘æ‹†åˆ†å·¥ç¨‹æ¨¡å—ä¸æ¨¡å—åˆ’åˆ†ï¼š ssm_pojo æ‹†åˆ† æ–°å»ºæ¨¡å—ï¼Œæ‹·è´åŸå§‹é¡¹ç›®ä¸­å¯¹åº”çš„ç›¸å…³å†…å®¹åˆ° ssm_pojo æ¨¡å—ä¸­ å®ä½“ç±»ï¼ˆUserï¼‰ é…ç½®æ–‡ä»¶ï¼ˆæ— ï¼‰ ssm_dao æ‹†åˆ† æ–°å»ºæ¨¡å— æ‹·è´åŸå§‹é¡¹ç›®ä¸­å¯¹åº”çš„ç›¸å…³å†…å®¹åˆ° ssm_dao æ¨¡å—ä¸­ æ•°æ®å±‚æ¥å£ï¼ˆUserDaoï¼‰ é…ç½®æ–‡ä»¶ï¼šä¿ç•™ä¸æ•°æ®å±‚ç›¸å…³é…ç½®æ–‡ä»¶(3 ä¸ªï¼‰ æ³¨æ„ï¼šåˆ†é¡µæ’ä»¶åœ¨é…ç½®ä¸­ä¸ SqlSessionFactoryBean ç»‘å®šï¼Œéœ€è¦ä¿ç•™ pom.xmlï¼šå¼•å…¥æ•°æ®å±‚ç›¸å…³åæ ‡å³å¯ï¼Œåˆ é™¤ SpringMVC ç›¸å…³åæ ‡ Spring MyBatis Spring æ•´åˆ MyBatis MySQL druid pagehelper ç›´æ¥ä¾èµ– ssm_pojoï¼ˆå¯¹ ssm_pojo æ¨¡å—æ‰§è¡Œ install æŒ‡ä»¤ï¼Œå°†å…¶å®‰è£…åˆ°æœ¬åœ°ä»“åº“ï¼‰ 1234567891011121314&lt;dependencies&gt; &lt;!--å¯¼å…¥èµ„æºæ–‡ä»¶pojo--&gt; &lt;dependency&gt; &lt;groupId&gt;demo&lt;/groupId&gt; &lt;artifactId&gt;ssm_pojo&lt;/artifactId&gt; &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt; &lt;/dependency&gt; &lt;!--springç¯å¢ƒ--&gt; &lt;!--mybatisç¯å¢ƒ--&gt; &lt;!--mysqlç¯å¢ƒ--&gt; &lt;!--springæ•´åˆjdbc--&gt; &lt;!--springæ•´åˆmybatis--&gt; &lt;!--druidè¿æ¥æ± --&gt; &lt;!--åˆ†é¡µæ’ä»¶åæ ‡--&gt; &lt;/dependencies&gt; ssm_service æ‹†åˆ† æ–°å»ºæ¨¡å— æ‹·è´åŸå§‹é¡¹ç›®ä¸­å¯¹åº”çš„ç›¸å…³å†…å®¹åˆ° ssm_service æ¨¡å—ä¸­ ä¸šåŠ¡å±‚æ¥å£ä¸å®ç°ç±»ï¼ˆUserServiceã€UserServiceImplï¼‰ é…ç½®æ–‡ä»¶ï¼šä¿ç•™ä¸æ•°æ®å±‚ç›¸å…³é…ç½®æ–‡ä»¶(1 ä¸ªï¼‰ pom.xmlï¼šå¼•å…¥æ•°æ®å±‚ç›¸å…³åæ ‡å³å¯ï¼Œåˆ é™¤ SpringMVC ç›¸å…³åæ ‡ spring junit spring æ•´åˆ junit ç›´æ¥ä¾èµ– ssm_daoï¼ˆå¯¹ ssm_dao æ¨¡å—æ‰§è¡Œ install æŒ‡ä»¤ï¼Œå°†å…¶å®‰è£…åˆ°æœ¬åœ°ä»“åº“ï¼‰ é—´æ¥ä¾èµ– ssm_pojoï¼ˆç”± ssm_dao æ¨¡å—è´Ÿè´£ä¾èµ–å…³ç³»çš„å»ºç«‹ï¼‰ ä¿®æ”¹ service æ¨¡å— Spring æ ¸å¿ƒé…ç½®æ–‡ä»¶åï¼Œæ·»åŠ æ¨¡å—åç§°ï¼Œæ ¼å¼ï¼šapplicationContext-service.xml ä¿®æ”¹ dao æ¨¡å— Spring æ ¸å¿ƒé…ç½®æ–‡ä»¶åï¼Œæ·»åŠ æ¨¡å—åç§°ï¼Œæ ¼å¼ï¼šapplicationContext-dao.xml ä¿®æ”¹å•å…ƒæµ‹è¯•å¼•å…¥çš„é…ç½®æ–‡ä»¶åç§°ï¼Œç”±å•ä¸ªæ–‡ä»¶ä¿®æ”¹ä¸ºå¤šä¸ªæ–‡ä»¶ ssm_control æ‹†åˆ† æ–°å»ºæ¨¡å—ï¼ˆä½¿ç”¨ webapp æ¨¡æ¿ï¼‰ æ‹·è´åŸå§‹é¡¹ç›®ä¸­å¯¹åº”çš„ç›¸å…³å†…å®¹åˆ° ssm_controller æ¨¡å—ä¸­ ç°å±‚æ§åˆ¶å™¨ç±»ä¸ç›¸å…³è®¾ç½®ç±»ï¼ˆUserControllerã€å¼‚å¸¸ç›¸å…³â€¦â€¦ï¼‰ é…ç½®æ–‡ä»¶ï¼šä¿ç•™ä¸è¡¨ç°å±‚ç›¸å…³é…ç½®æ–‡ä»¶(1 ä¸ªï¼‰ã€æœåŠ¡å™¨ç›¸å…³é…ç½®æ–‡ä»¶ï¼ˆ1 ä¸ªï¼‰ pom.xmlï¼šå¼•å…¥æ•°æ®å±‚ç›¸å…³åæ ‡å³å¯ï¼Œåˆ é™¤ SpringMVC ç›¸å…³åæ ‡ spring springmvc jackson servlet tomcat æœåŠ¡å™¨æ’ä»¶ ç›´æ¥ä¾èµ– ssm_serviceï¼ˆå¯¹ ssm_service æ¨¡å—æ‰§è¡Œ install æŒ‡ä»¤ï¼Œå°†å…¶å®‰è£…åˆ°æœ¬åœ°ä»“åº“ï¼‰ é—´æ¥ä¾èµ– ssm_daoã€ssm_pojo 12345678910111213141516171819&lt;dependencies&gt; &lt;!--å¯¼å…¥èµ„æºæ–‡ä»¶service--&gt; &lt;dependency&gt; &lt;groupId&gt;demo&lt;/groupId&gt; &lt;artifactId&gt;ssm_service&lt;/artifactId&gt; &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt; &lt;/dependency&gt; &lt;!--springmvcç¯å¢ƒ--&gt; &lt;!--jacksonç›¸å…³åæ ‡3ä¸ª--&gt; &lt;!--servletç¯å¢ƒ--&gt; &lt;/dependencies&gt; &lt;build&gt; &lt;!--è®¾ç½®æ’ä»¶--&gt; &lt;plugins&gt; &lt;!--å…·ä½“çš„æ’ä»¶é…ç½®--&gt; &lt;plugin&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt; ä¿®æ”¹ web.xml é…ç½®æ–‡ä»¶ä¸­åŠ è½½ Spring ç¯å¢ƒçš„é…ç½®æ–‡ä»¶åç§°ï¼Œä½¿ç”¨*é€šé…ï¼ŒåŠ è½½æ‰€æœ‰ applicationContext- å¼€å§‹çš„é…ç½®æ–‡ä»¶ï¼š 12345&lt;!--åŠ è½½é…ç½®æ–‡ä»¶--&gt;&lt;context-param&gt; &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt; &lt;param-value&gt;classpath*:applicationContext-*.xml&lt;/param-value&gt;&lt;/context-param&gt; spring-mvc 1&lt;mvc:annotation-driven/&gt;&lt;context:component-scan base-package=&quot;controller&quot;/&gt; èšåˆä½œç”¨ï¼šèšåˆç”¨äºå¿«é€Ÿæ„å»º Maven å·¥ç¨‹ï¼Œä¸€æ¬¡æ€§æ„å»ºå¤šä¸ªé¡¹ç›®&#x2F;æ¨¡å— åˆ¶ä½œæ–¹å¼ï¼š åˆ›å»ºä¸€ä¸ªç©ºæ¨¡å—ï¼Œæ‰“åŒ…ç±»å‹å®šä¹‰ä¸º pom 1&lt;packaging&gt;pom&lt;/packaging&gt; å®šä¹‰å½“å‰æ¨¡å—è¿›è¡Œæ„å»ºæ“ä½œæ—¶å…³è”çš„å…¶ä»–æ¨¡å—åç§° 123456789101112131415&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;project xmlns=&quot;............&quot;&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;groupId&gt;demo&lt;/groupId&gt; &lt;artifactId&gt;ssm&lt;/artifactId&gt; &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt; &lt;!--å®šä¹‰è¯¥å·¥ç¨‹ç”¨äºæ„å»ºç®¡ç†--&gt; &lt;packaging&gt;pom&lt;/packaging&gt; &lt;!--ç®¡ç†çš„å·¥ç¨‹åˆ—è¡¨--&gt; &lt;modules&gt; &lt;!--å…·ä½“çš„å·¥ç¨‹åç§°--&gt; &lt;module&gt;../ssm_pojo&lt;/module&gt; &lt;module&gt;../ssm_dao&lt;/module&gt; &lt;module&gt;../ssm_service&lt;/module&gt; &lt;module&gt;../ssm_controller&lt;/module&gt; &lt;/modules&gt;&lt;/project&gt; æ³¨æ„äº‹é¡¹ï¼šå‚ä¸èšåˆæ“ä½œçš„æ¨¡å—æœ€ç»ˆæ‰§è¡Œé¡ºåºä¸æ¨¡å—é—´çš„ä¾èµ–å…³ç³»æœ‰å…³ï¼Œä¸é…ç½®é¡ºåºæ— å…³ ç»§æ‰¿Maven ä¸­çš„ç»§æ‰¿ä¸ Java ä¸­çš„ç»§æ‰¿ç›¸ä¼¼ï¼Œå¯ä»¥å®ç°åœ¨å­å·¥ç¨‹ä¸­æ²¿ç”¨çˆ¶å·¥ç¨‹ä¸­çš„é…ç½® dependencyManagement é‡Œåªæ˜¯å£°æ˜ä¾èµ–ï¼Œå¹¶ä¸å®ç°å¼•å…¥ï¼Œæ‰€ä»¥å­å·¥ç¨‹éœ€è¦æ˜¾å¼å£°æ˜éœ€è¦ç”¨çš„ä¾èµ– å¦‚æœå­å·¥ç¨‹ä¸­æœªå£°æ˜ä¾èµ–ï¼Œåˆ™ä¸ä¼šä»çˆ¶é¡¹ç›®ç»§æ‰¿ä¸‹æ¥ åœ¨å­å·¥ç¨‹ä¸­å£°æ˜è¯¥ä¾èµ–é¡¹ï¼Œå¹¶ä¸”ä¸æŒ‡å®šå…·ä½“ç‰ˆæœ¬ï¼Œæ‰ä¼šä»çˆ¶é¡¹ç›®ä¸­ç»§æ‰¿è¯¥é¡¹ï¼Œversion å’Œ scope éƒ½ç»§æ‰¿å–è‡ªçˆ¶å·¥ç¨‹ pom æ–‡ä»¶ å¦‚æœå­å·¥ç¨‹ä¸­æŒ‡å®šäº†ç‰ˆæœ¬å·ï¼Œé‚£ä¹ˆä½¿ç”¨å­å·¥ç¨‹ä¸­æŒ‡å®šçš„ jar ç‰ˆæœ¬ åˆ¶ä½œæ–¹å¼ï¼š åœ¨å­å·¥ç¨‹ä¸­å£°æ˜å…¶çˆ¶å·¥ç¨‹åæ ‡ä¸å¯¹åº”çš„ä½ç½® 12345678&lt;!--å®šä¹‰è¯¥å·¥ç¨‹çš„çˆ¶å·¥ç¨‹--&gt;&lt;parent&gt; &lt;groupId&gt;com.seazean&lt;/groupId&gt; &lt;artifactId&gt;ssm&lt;/artifactId&gt; &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt; &lt;!--å¡«å†™çˆ¶å·¥ç¨‹çš„pomæ–‡ä»¶--&gt; &lt;relativePath&gt;../ssm/pom.xml&lt;/relativePath&gt;&lt;/parent&gt; ç»§æ‰¿ä¾èµ–çš„å®šä¹‰ï¼šåœ¨çˆ¶å·¥ç¨‹ä¸­å®šä¹‰ä¾èµ–ç®¡ç† 12345678910111213&lt;!--å£°æ˜æ­¤å¤„è¿›è¡Œä¾èµ–ç®¡ç†ï¼Œç‰ˆæœ¬é”å®š--&gt;&lt;dependencyManagement&gt; &lt;!--å…·ä½“çš„ä¾èµ–--&gt; &lt;dependencies&gt; &lt;!--springç¯å¢ƒ--&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-context&lt;/artifactId&gt; &lt;version&gt;5.1.9.RELEASE&lt;/version&gt; &lt;/dependency&gt; &lt;!--ç­‰ç­‰æ‰€æœ‰--&gt; &lt;/dependencies&gt;&lt;/dependencyManagement&gt; ç»§æ‰¿ä¾èµ–çš„ä½¿ç”¨ï¼šåœ¨å­å·¥ç¨‹ä¸­å®šä¹‰ä¾èµ–å…³ç³»ï¼Œæ— éœ€å£°æ˜ä¾èµ–ç‰ˆæœ¬ï¼Œç‰ˆæœ¬å‚ç…§çˆ¶å·¥ç¨‹ä¸­ä¾èµ–çš„ç‰ˆæœ¬ 1234567&lt;dependencies&gt; &lt;!--springç¯å¢ƒ--&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-context&lt;/artifactId&gt; &lt;/dependency&gt;&lt;/dependencies&gt; ç»§æ‰¿çš„èµ„æºï¼š 12345678910111213141516171819groupIdï¼šé¡¹ç›®ç»„IDï¼Œé¡¹ç›®åæ ‡çš„æ ¸å¿ƒå…ƒç´ versionï¼šé¡¹ç›®ç‰ˆæœ¬ï¼Œé¡¹ç›®åæ ‡çš„æ ¸å¿ƒå› ç´ descriptionï¼šé¡¹ç›®çš„æè¿°ä¿¡æ¯organizationï¼šé¡¹ç›®çš„ç»„ç»‡ä¿¡æ¯inceptionYearï¼šé¡¹ç›®çš„åˆ›å§‹å¹´ä»½urlï¼šé¡¹ç›®çš„URLåœ°å€developersï¼šé¡¹ç›®çš„å¼€å‘è€…ä¿¡æ¯contributorsï¼šé¡¹ç›®çš„è´¡çŒ®è€…ä¿¡æ¯distributionManagementï¼šé¡¹ç›®çš„éƒ¨ç½²é…ç½®issueManagementï¼šé¡¹ç›®çš„ç¼ºé™·è·Ÿè¸ªç³»ç»Ÿä¿¡æ¯ciManagementï¼šé¡¹ç›®çš„æŒç»­é›†æˆç³»ç»Ÿä¿¡æ¯scmï¼šé¡¹ç›®çš„ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿä¿¡æ¯malilingListsï¼šé¡¹ç›®çš„é‚®ä»¶åˆ—è¡¨ä¿¡æ¯propertiesï¼šè‡ªå®šä¹‰çš„Mavenå±æ€§dependenciesï¼šé¡¹ç›®çš„ä¾èµ–é…ç½®dependencyManagementï¼šé¡¹ç›®çš„ä¾èµ–ç®¡ç†é…ç½®repositoriesï¼šé¡¹ç›®çš„ä»“åº“é…ç½®buildï¼šåŒ…æ‹¬é¡¹ç›®çš„æºç ç›®å½•é…ç½®ã€è¾“å‡ºç›®å½•é…ç½®ã€æ’ä»¶é…ç½®ã€æ’ä»¶ç®¡ç†é…ç½®ç­‰reportingï¼šåŒ…æ‹¬é¡¹ç›®çš„æŠ¥å‘Šè¾“å‡ºç›®å½•é…ç½®ã€æŠ¥å‘Šæ’ä»¶é…ç½®ç­‰ ç»§æ‰¿ä¸èšåˆï¼š ä½œç”¨ï¼š èšåˆç”¨äºå¿«é€Ÿæ„å»ºé¡¹ç›® ç»§æ‰¿ç”¨äºå¿«é€Ÿé…ç½® ç›¸åŒç‚¹ï¼š èšåˆä¸ç»§æ‰¿çš„ pom.xml æ–‡ä»¶æ‰“åŒ…æ–¹å¼å‡ä¸º pomï¼Œå¯ä»¥å°†ä¸¤ç§å…³ç³»åˆ¶ä½œåˆ°åŒä¸€ä¸ª pom æ–‡ä»¶ä¸­ èšåˆä¸ç»§æ‰¿å‡å±äºè®¾è®¡å‹æ¨¡å—ï¼Œå¹¶æ— å®é™…çš„æ¨¡å—å†…å®¹ ä¸åŒç‚¹ï¼š èšåˆæ˜¯åœ¨å½“å‰æ¨¡å—ä¸­é…ç½®å…³ç³»ï¼Œèšåˆå¯ä»¥æ„ŸçŸ¥åˆ°å‚ä¸èšåˆçš„æ¨¡å—æœ‰å“ªäº› ç»§æ‰¿æ˜¯åœ¨å­æ¨¡å—ä¸­é…ç½®å…³ç³»ï¼Œçˆ¶æ¨¡å—æ— æ³•æ„ŸçŸ¥å“ªäº›å­æ¨¡å—ç»§æ‰¿äº†è‡ªå·± å±æ€§ ç‰ˆæœ¬ç»Ÿä¸€çš„é‡è¦æ€§ï¼š å±æ€§ç±»åˆ«ï¼š è‡ªå®šä¹‰å±æ€§ å†…ç½®å±æ€§ setting å±æ€§ Java ç³»ç»Ÿå±æ€§ ç¯å¢ƒå˜é‡å±æ€§ è‡ªå®šä¹‰å±æ€§ï¼š ä½œç”¨ï¼šç­‰åŒäºå®šä¹‰å˜é‡ï¼Œæ–¹ä¾¿ç»Ÿä¸€ç»´æŠ¤ å®šä¹‰æ ¼å¼ï¼š 12345&lt;!--å®šä¹‰è‡ªå®šä¹‰å±æ€§ï¼Œæ”¾åœ¨dependencyManagementä¸Šæ–¹--&gt;&lt;properties&gt; &lt;spring.version&gt;5.1.9.RELEASE&lt;/spring.version&gt; &lt;junit.version&gt;4.12&lt;/junit.version&gt;&lt;/properties&gt; èšåˆä¸ç»§æ‰¿çš„ pom.xml æ–‡ä»¶æ‰“åŒ…æ–¹å¼å‡ä¸º pomï¼Œå¯ä»¥å°†ä¸¤ç§å…³ç³»åˆ¶ä½œåˆ°åŒä¸€ä¸ª pom æ–‡ä»¶ä¸­ èšåˆä¸ç»§æ‰¿å‡å±äºè®¾è®¡å‹æ¨¡å—ï¼Œå¹¶æ— å®é™…çš„æ¨¡å—å†…å®¹ è°ƒç”¨æ ¼å¼ï¼š 12345&lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-context&lt;/artifactId&gt; &lt;version&gt;$&#123;spring.version&#125;&lt;/version&gt;&lt;/dependency&gt; å†…ç½®å±æ€§ï¼š ä½œç”¨ï¼šä½¿ç”¨ Maven å†…ç½®å±æ€§ï¼Œå¿«é€Ÿé…ç½® è°ƒç”¨æ ¼å¼ï¼š 1$&#123;project.basedir&#125; or $&#123;project.basedir&#125; &lt;!--../ssmæ ¹ç›®å½•--&gt;$&#123;version&#125; or $&#123;project.version&#125; vresion æ˜¯ 1.0-SNAPSHOT 123&lt;groupId&gt;demo&lt;/groupId&gt;&lt;artifactId&gt;ssm&lt;/artifactId&gt;&lt;version&gt;1.0-SNAPSHOT&lt;/version&gt; setting å±æ€§ ä½¿ç”¨ Maven é…ç½®æ–‡ä»¶ setting.xml ä¸­çš„æ ‡ç­¾å±æ€§ï¼Œç”¨äºåŠ¨æ€é…ç½® è°ƒç”¨æ ¼å¼ï¼š 1$&#123;settings.localRepository&#125; Java ç³»ç»Ÿå±æ€§ï¼š ä½œç”¨ï¼šè¯»å– Java ç³»ç»Ÿå±æ€§ è°ƒç”¨æ ¼å¼ï¼š 1$&#123;user.home&#125; ç³»ç»Ÿå±æ€§æŸ¥è¯¢æ–¹å¼ cmd å‘½ä»¤ï¼š 1mvn help:system ç¯å¢ƒå˜é‡å±æ€§ ä½œç”¨ï¼šä½¿ç”¨ Maven é…ç½®æ–‡ä»¶ setting.xml ä¸­çš„æ ‡ç­¾å±æ€§ï¼Œç”¨äºåŠ¨æ€é…ç½® è°ƒç”¨æ ¼å¼ï¼š 1$&#123;env.JAVA_HOME&#125; ç¯å¢ƒå˜é‡å±æ€§æŸ¥è¯¢æ–¹å¼ï¼š 1mvn help:system å·¥ç¨‹ç‰ˆæœ¬SNAPSHOTï¼ˆå¿«ç…§ç‰ˆæœ¬ï¼‰ é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¸ºæ–¹ä¾¿å›¢é˜Ÿæˆå‘˜åˆä½œï¼Œè§£å†³æ¨¡å—é—´ç›¸äº’ä¾èµ–å’Œæ—¶æ—¶æ›´æ–°çš„é—®é¢˜ï¼Œå¼€å‘è€…å¯¹æ¯ä¸ªæ¨¡å—è¿›è¡Œæ„å»ºçš„æ—¶å€™ï¼Œè¾“å‡ºçš„ä¸´æ—¶æ€§ç‰ˆæœ¬å«å¿«ç…§ç‰ˆæœ¬ï¼ˆæµ‹è¯•é˜¶æ®µç‰ˆæœ¬ï¼‰ å¿«ç…§ç‰ˆæœ¬ä¼šéšç€å¼€å‘çš„è¿›å±•ä¸æ–­æ›´æ–° RELEASEï¼ˆå‘å¸ƒç‰ˆæœ¬ï¼‰ é¡¹ç›®å¼€å‘åˆ°è¿›å…¥é˜¶æ®µé‡Œç¨‹ç¢‘åï¼Œå‘å›¢é˜Ÿå¤–éƒ¨å‘å¸ƒè¾ƒä¸ºç¨³å®šçš„ç‰ˆæœ¬ï¼Œè¿™ç§ç‰ˆæœ¬æ‰€å¯¹åº”çš„æ„ä»¶æ–‡ä»¶æ˜¯ç¨³å®šçš„ï¼Œå³ä¾¿è¿›è¡ŒåŠŸèƒ½çš„åç»­å¼€å‘ï¼Œä¹Ÿä¸ä¼šæ”¹å˜å½“å‰å‘å¸ƒç‰ˆæœ¬å†…å®¹ï¼Œè¿™ç§ç‰ˆæœ¬ç§°ä¸ºå‘å¸ƒç‰ˆæœ¬ çº¦å®šè§„èŒƒï¼š &lt;ä¸»ç‰ˆæœ¬&gt;.&lt;æ¬¡ç‰ˆæœ¬&gt;.&lt;å¢é‡ç‰ˆæœ¬&gt;.&lt;é‡Œç¨‹ç¢‘ç‰ˆæœ¬&gt; ä¸»ç‰ˆæœ¬ï¼šè¡¨ç¤ºé¡¹ç›®é‡å¤§æ¶æ„çš„å˜æ›´ï¼Œå¦‚ï¼šSpring5 ç›¸è¾ƒäº Spring4 çš„è¿­ä»£ æ¬¡ç‰ˆæœ¬ï¼šè¡¨ç¤ºæœ‰è¾ƒå¤§çš„åŠŸèƒ½å¢åŠ å’Œå˜åŒ–ï¼Œæˆ–è€…å…¨é¢ç³»ç»Ÿåœ°ä¿®å¤æ¼æ´ å¢é‡ç‰ˆæœ¬ï¼šè¡¨ç¤ºæœ‰é‡å¤§æ¼æ´çš„ä¿®å¤ é‡Œç¨‹ç¢‘ç‰ˆæœ¬ï¼šè¡¨æ˜ä¸€ä¸ªç‰ˆæœ¬çš„é‡Œç¨‹ç¢‘ï¼ˆç‰ˆæœ¬å†…éƒ¨ï¼‰ã€‚è¿™æ ·çš„ç‰ˆæœ¬åŒä¸‹ä¸€ä¸ªæ­£å¼ç‰ˆæœ¬ç›¸æ¯”ï¼Œç›¸å¯¹æ¥è¯´ä¸æ˜¯å¾ˆç¨³å®šï¼Œæœ‰å¾…æ›´å¤šçš„æµ‹è¯• èµ„æºé…ç½®ä½œç”¨ï¼šåœ¨ä»»æ„é…ç½®æ–‡ä»¶ä¸­åŠ è½½ pom æ–‡ä»¶ä¸­å®šä¹‰çš„å±æ€§ çˆ¶æ–‡ä»¶ pom.xml 12&lt;properties&gt; &lt;jdbc.url&gt;jdbc:mysql://192.168.0.137:3306/ssm_db?useSSL=false&lt;/jdbc.url&gt;&lt;/properties&gt; å¼€å¯é…ç½®æ–‡ä»¶åŠ è½½ pom å±æ€§ï¼š 123456789&lt;!--é…ç½®èµ„æºæ–‡ä»¶å¯¹åº”çš„ä¿¡æ¯--&gt;&lt;resources&gt; &lt;resource&gt; &lt;!--è®¾å®šé…ç½®æ–‡ä»¶å¯¹åº”çš„ä½ç½®ç›®å½•ï¼Œæ”¯æŒä½¿ç”¨å±æ€§åŠ¨æ€è®¾å®šè·¯å¾„--&gt; &lt;directory&gt;$&#123;project.basedir&#125;/src/main/resources&lt;/directory&gt; &lt;!--å¼€å¯å¯¹é…ç½®æ–‡ä»¶çš„èµ„æºåŠ è½½è¿‡æ»¤--&gt; &lt;filtering&gt;true&lt;/filtering&gt; &lt;/resource&gt;&lt;/resources&gt; properties æ–‡ä»¶ä¸­è°ƒç”¨æ ¼å¼ï¼š 12jdbc.driver=com.mysql.jdbc.Driverjdbc.url=$&#123;jdbc.url&#125;jdbc.username=rootjdbc.password=123456 å¤šç¯å¢ƒé…ç½® ç¯å¢ƒé…ç½® 123456789101112131415161718192021&lt;!--åˆ›å»ºå¤šç¯å¢ƒ--&gt;&lt;profiles&gt; &lt;!--å®šä¹‰å…·ä½“çš„ç¯å¢ƒï¼šç”Ÿäº§ç¯å¢ƒ--&gt; &lt;profile&gt; &lt;!--å®šä¹‰ç¯å¢ƒå¯¹åº”çš„å”¯ä¸€åç§°--&gt; &lt;id&gt;pro_env&lt;/id&gt; &lt;!--å®šä¹‰ç¯å¢ƒä¸­ä¸“ç”¨çš„å±æ€§å€¼--&gt; &lt;properties&gt; &lt;jdbc.url&gt;jdbc:mysql://127.1.1.1:3306/ssm_db&lt;/jdbc.url&gt; &lt;/properties&gt; &lt;!--è®¾ç½®é»˜è®¤å¯åŠ¨--&gt; &lt;activation&gt; &lt;activeByDefault&gt;true&lt;/activeByDefault&gt; &lt;/activation&gt; &lt;/profile&gt; &lt;!--å®šä¹‰å…·ä½“çš„ç¯å¢ƒï¼šå¼€å‘ç¯å¢ƒ--&gt; &lt;profile&gt; &lt;id&gt;dev_env&lt;/id&gt; â€¦â€¦ &lt;/profile&gt;&lt;/profiles&gt; åŠ è½½æŒ‡å®šç¯å¢ƒ ä½œç”¨ï¼šåŠ è½½æŒ‡å®šç¯å¢ƒé…ç½® è°ƒç”¨æ ¼å¼ï¼š 1mvn æŒ‡ä»¤ â€“P ç¯å¢ƒå®šä¹‰id èŒƒä¾‹ï¼š 1mvn install â€“P pro_env è·³è¿‡æµ‹è¯•å‘½ä»¤ï¼š 1mvn æŒ‡ä»¤ â€“D skipTests æ³¨æ„äº‹é¡¹ï¼šæ‰§è¡Œçš„æŒ‡ä»¤ç”Ÿå‘½å‘¨æœŸå¿…é¡»åŒ…å«æµ‹è¯•ç¯èŠ‚ IEDA ç•Œé¢ï¼š é…ç½®è·³è¿‡ï¼š 1234567891011121314&lt;plugin&gt; &lt;!--&lt;groupId&gt;org.apache.maven&lt;/groupId&gt;--&gt; &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt; &lt;version&gt;2.22.1&lt;/version&gt; &lt;configuration&gt; &lt;skipTests&gt;true&lt;/skipTests&gt;&lt;!--è®¾ç½®è·³è¿‡æµ‹è¯•--&gt; &lt;includes&gt; &lt;!--åŒ…å«æŒ‡å®šçš„æµ‹è¯•ç”¨ä¾‹--&gt; &lt;include&gt;**/User*Test.java&lt;/include&gt; &lt;/includes&gt; &lt;excludes&gt;&lt;!--æ’é™¤æŒ‡å®šçš„æµ‹è¯•ç”¨ä¾‹--&gt; &lt;exclude&gt;**/User*TestCase.java&lt;/exclude&gt; &lt;/excludes&gt; &lt;/configuration&gt;&lt;/plugin&gt; ç§æœNexusNexus æ˜¯ Sonatype å…¬å¸çš„ä¸€æ¬¾ Maven ç§æœäº§å“ ä¸‹è½½åœ°å€ï¼šhttps://help.sonatype.com/repomanager3/download å¯åŠ¨æœåŠ¡å™¨ï¼ˆå‘½ä»¤è¡Œå¯åŠ¨ï¼‰ï¼š 1nexus.exe /run nexus è®¿é—®æœåŠ¡å™¨ï¼ˆé»˜è®¤ç«¯å£ï¼š8081ï¼‰ï¼š 1http://localhost:8081 ä¿®æ”¹åŸºç¡€é…ç½®ä¿¡æ¯ å®‰è£…è·¯å¾„ä¸‹ etc ç›®å½•ä¸­ nexus-default.properties æ–‡ä»¶ä¿å­˜æœ‰ nexus åŸºç¡€é…ç½®ä¿¡æ¯ï¼Œä¾‹å¦‚é»˜è®¤è®¿é—®ç«¯å£ ä¿®æ”¹æœåŠ¡å™¨è¿è¡Œé…ç½®ä¿¡æ¯ å®‰è£…è·¯å¾„ä¸‹ bin ç›®å½•ä¸­ nexus.vmoptions æ–‡ä»¶ä¿å­˜æœ‰ nexus æœåŠ¡å™¨å¯åŠ¨çš„é…ç½®ä¿¡æ¯ï¼Œä¾‹å¦‚é»˜è®¤å ç”¨å†…å­˜ç©ºé—´ èµ„æºæ“ä½œ ä»“åº“åˆ†ç±»ï¼š å®¿ä¸»ä»“åº“ hosted ä¿å­˜æ— æ³•ä»ä¸­å¤®ä»“åº“è·å–çš„èµ„æº è‡ªä¸»ç ”å‘ ç¬¬ä¸‰æ–¹éå¼€æºé¡¹ç›® ä»£ç†ä»“åº“ proxy ä»£ç†è¿œç¨‹ä»“åº“ï¼Œé€šè¿‡ nexus è®¿é—®å…¶ä»–å…¬å…±ä»“åº“ï¼Œä¾‹å¦‚ä¸­å¤®ä»“åº“ ä»“åº“ç»„ group å°†è‹¥å¹²ä¸ªä»“åº“ç»„æˆä¸€ä¸ªç¾¤ç»„ï¼Œç®€åŒ–é…ç½® ä»“åº“ç»„ä¸èƒ½ä¿å­˜èµ„æºï¼Œå±äºè®¾è®¡å‹ä»“åº“ èµ„æºä¸Šä¼ ï¼Œä¸Šä¼ èµ„æºæ—¶æä¾›å¯¹åº”çš„ä¿¡æ¯ ä¿å­˜çš„ä½ç½®ï¼ˆå®¿ä¸»ä»“åº“ï¼‰ èµ„æºæ–‡ä»¶ å¯¹åº”åæ ‡ IDEAæ“ä½œä¸Šä¼ ä¸‹è½½ è®¿é—®ç§æœæœ¬åœ°è®¿é—®é…ç½®æœ¬åœ°ä»“åº“è®¿é—®ç§æœçš„æƒé™ï¼ˆsetting.xmlï¼‰ 123456789101112&lt;servers&gt; &lt;server&gt; &lt;id&gt;heima-release&lt;/id&gt; &lt;username&gt;admin&lt;/username&gt; &lt;password&gt;admin&lt;/password&gt; &lt;/server&gt; &lt;server&gt; &lt;id&gt;heima-snapshots&lt;/id&gt; &lt;username&gt;admin&lt;/username&gt; &lt;password&gt;admin&lt;/password&gt; &lt;/server&gt;&lt;/servers&gt; é…ç½®æœ¬åœ°ä»“åº“èµ„æºæ¥æºï¼ˆsetting.xmlï¼‰ 1234567&lt;mirrors&gt; &lt;mirror&gt; &lt;id&gt;nexus-heima&lt;/id&gt; &lt;mirrorOf&gt;*&lt;/mirrorOf&gt; &lt;url&gt;http://localhost:8081/repository/maven-public/&lt;/url&gt; &lt;/mirror&gt;&lt;/mirrors&gt; å·¥ç¨‹è®¿é—®é…ç½®å½“å‰é¡¹ç›®è®¿é—®ç§æœä¸Šä¼ èµ„æºçš„ä¿å­˜ä½ç½®ï¼ˆpom.xmlï¼‰ 12345678910&lt;distributionManagement&gt; &lt;repository&gt; &lt;id&gt;heima-release&lt;/id&gt; &lt;url&gt;http://localhost:8081/repository/heima-release/&lt;/url&gt; &lt;/repository&gt; &lt;snapshotRepository&gt; &lt;id&gt;heima-snapshots&lt;/id&gt; &lt;url&gt;http://localhost:8081/repository/heima-snapshots/&lt;/url&gt; &lt;/snapshotRepository&gt;&lt;/distributionManagement&gt; å‘å¸ƒèµ„æºåˆ°ç§æœå‘½ä»¤ 1mvn deploy æ—¥å¿—Log4jç¨‹åºä¸­çš„æ—¥å¿—å¯ä»¥ç”¨æ¥è®°å½•ç¨‹åºåœ¨è¿è¡Œæ—¶å€™çš„è¯¦æƒ…ï¼Œå¹¶å¯ä»¥è¿›è¡Œæ°¸ä¹…å­˜å‚¨ã€‚ è¾“å‡ºè¯­å¥ æ—¥å¿—æŠ€æœ¯ å–æ¶ˆæ—¥å¿— éœ€è¦ä¿®æ”¹ä»£ç ï¼Œçµæ´»æ€§æ¯”è¾ƒå·® ä¸éœ€è¦ä¿®æ”¹ä»£ç ï¼Œçµæ´»æ€§æ¯”è¾ƒå¥½ è¾“å‡ºä½ç½® åªèƒ½æ˜¯æ§åˆ¶å° å¯ä»¥å°†æ—¥å¿—ä¿¡æ¯å†™å…¥åˆ°æ–‡ä»¶æˆ–è€…æ•°æ®åº“ä¸­ å¤šçº¿ç¨‹ å’Œä¸šåŠ¡ä»£ç å¤„äºä¸€ä¸ªçº¿ç¨‹ä¸­ å¤šçº¿ç¨‹æ–¹å¼è®°å½•æ—¥å¿—ï¼Œä¸å½±å“ä¸šåŠ¡ä»£ç çš„æ€§èƒ½ Log4j æ˜¯ Apache çš„ä¸€ä¸ªå¼€æºé¡¹ç›®ã€‚ä½¿ç”¨ Log4jï¼Œé€šè¿‡ä¸€ä¸ªé…ç½®æ–‡ä»¶æ¥çµæ´»åœ°è¿›è¡Œé…ç½®ï¼Œè€Œä¸éœ€è¦ä¿®æ”¹åº”ç”¨çš„ä»£ç ã€‚æˆ‘ä»¬å¯ä»¥æ§åˆ¶æ—¥å¿—ä¿¡æ¯è¾“é€çš„ç›®çš„åœ°æ˜¯æ§åˆ¶å°ã€æ–‡ä»¶ç­‰ä½ç½®ï¼Œä¹Ÿå¯ä»¥æ§åˆ¶æ¯ä¸€æ¡æ—¥å¿—çš„è¾“å‡ºæ ¼å¼ã€‚ é…ç½®æ–‡ä»¶é…ç½®æ–‡ä»¶çš„ä¸‰ä¸ªæ ¸å¿ƒï¼š é…ç½®æ ¹ Logger æ ¼å¼ï¼šlog4j.rootLogger&#x3D;æ—¥å¿—çº§åˆ«ï¼ŒappenderName1ï¼ŒappenderName2ï¼Œâ€¦ æ—¥å¿—çº§åˆ«ï¼šå¸¸è§çš„äº”ä¸ªçº§åˆ«ï¼šDEBUG &lt; INFO &lt; WARN &lt; ERROR &lt; FATALï¼ˆå¯ä»¥è‡ªå®šä¹‰ï¼‰Log4j è§„åˆ™ï¼šåªè¾“å‡ºçº§åˆ«ä¸ä½äºè®¾å®šçº§åˆ«çš„æ—¥å¿—ä¿¡æ¯ appenderName1ï¼šæŒ‡å®šæ—¥å¿—ä¿¡æ¯è¦è¾“å‡ºåœ°å€ã€‚å¯ä»¥åŒæ—¶æŒ‡å®šå¤šä¸ªè¾“å‡ºç›®çš„åœ°ï¼Œç”¨é€—å·éš”å¼€ï¼š ä¾‹å¦‚ï¼šlog4j.rootLoggerï¼INFOï¼Œcaï¼Œfa Appendersï¼ˆè¾“å‡ºæºï¼‰ï¼šæ—¥å¿—è¦è¾“å‡ºçš„åœ°æ–¹ï¼Œå¦‚æ§åˆ¶å°ï¼ˆConsoleï¼‰ã€æ–‡ä»¶ï¼ˆFilesï¼‰ç­‰ Appenders å–å€¼ï¼š org.apache.log4j.ConsoleAppenderï¼ˆæ§åˆ¶å°ï¼‰ org.apache.log4j.FileAppenderï¼ˆæ–‡ä»¶ï¼‰ ConsoleAppender å¸¸ç”¨å‚æ•° ImmediateFlush=trueï¼šè¡¨ç¤ºæ‰€æœ‰æ¶ˆæ¯éƒ½ä¼šè¢«ç«‹å³è¾“å‡ºï¼Œè®¾ä¸º false åˆ™ä¸è¾“å‡ºï¼Œé»˜è®¤å€¼æ˜¯ true Target=System.errï¼šé»˜è®¤å€¼æ˜¯ System.out FileAppenderå¸¸ç”¨çš„é€‰é¡¹ ImmediateFlush=trueï¼šè¡¨ç¤ºæ‰€æœ‰æ¶ˆæ¯éƒ½ä¼šè¢«ç«‹å³è¾“å‡ºã€‚è®¾ä¸º false åˆ™ä¸è¾“å‡ºï¼Œé»˜è®¤å€¼æ˜¯ true Append=falseï¼štrue è¡¨ç¤ºå°†æ¶ˆæ¯æ·»åŠ åˆ°æŒ‡å®šæ–‡ä»¶ä¸­ï¼ŒåŸæ¥çš„æ¶ˆæ¯ä¸è¦†ç›–ã€‚é»˜è®¤å€¼æ˜¯ true File=E:/logs/logging.log4jï¼šæŒ‡å®šæ¶ˆæ¯è¾“å‡ºåˆ° logging.log4j æ–‡ä»¶ä¸­ Layouts (å¸ƒå±€)ï¼šæ—¥å¿—è¾“å‡ºçš„æ ¼å¼ï¼Œå¸¸ç”¨çš„å¸ƒå±€ç®¡ç†å™¨ï¼š org.apache.log4j.PatternLayoutï¼ˆå¯ä»¥çµæ´»åœ°æŒ‡å®šå¸ƒå±€æ¨¡å¼ï¼‰ org.apache.log4j.SimpleLayoutï¼ˆåŒ…å«æ—¥å¿—ä¿¡æ¯çš„çº§åˆ«å’Œä¿¡æ¯å­—ç¬¦ä¸²ï¼‰ org.apache.log4j.TTCCLayoutï¼ˆåŒ…å«æ—¥å¿—äº§ç”Ÿçš„æ—¶é—´ã€çº¿ç¨‹ã€ç±»åˆ«ç­‰ä¿¡æ¯ï¼‰ PatternLayout å¸¸ç”¨çš„é€‰é¡¹ æ—¥å¿—åº”ç”¨ log4j çš„é…ç½®æ–‡ä»¶,åå­—ä¸º log4j.properties, æ”¾åœ¨ src æ ¹ç›®å½•ä¸‹ 12345678910111213141516log4j.rootLogger=I### direct log messages to my ###log4j.appender.my=org.apache.log4j.ConsoleAppenderlog4j.appender.my.ImmediateFlush = truelog4j.appender.my.Target=System.outlog4j.appender.my.layout=org.apache.log4j.PatternLayoutlog4j.appender.my.layout.ConversionPattern=%d %t %5p %c&#123;1&#125;:%L - %m%n# fileAppenderæ¼”ç¤ºlog4j.appender.fileAppender=org.apache.log4j.FileAppenderlog4j.appender.fileAppender.ImmediateFlush = truelog4j.appender.fileAppender.Append=truelog4j.appender.fileAppender.File=E:/log4j-log.loglog4j.appender.fileAppender.layout=org.apache.log4j.PatternLayoutlog4j.appender.fileAppender.layout.ConversionPattern=%d %5p %c&#123;1&#125;:%L - %m%n æµ‹è¯•ç±» 123456789101112131415161718192021// æµ‹è¯•ç±»public class Log4JTest01 &#123; //ä½¿ç”¨log4jçš„apiæ¥è·å–æ—¥å¿—çš„å¯¹è±¡ //å¼Šç«¯ï¼šå¦‚æœä»¥åæˆ‘ä»¬æ›´æ¢æ—¥å¿—çš„å®ç°ç±»ï¼Œé‚£ä¹ˆä¸‹é¢çš„ä»£ç å°±éœ€è¦è·Ÿç€æ”¹ //ä¸æ¨èä½¿ç”¨ //private static final Logger LOGGER = Logger.getLogger(Log4JTest01.class); //ä½¿ç”¨slf4jé‡Œé¢çš„apiæ¥è·å–æ—¥å¿—çš„å¯¹è±¡ //å¥½å¤„ï¼šå¦‚æœä»¥åæˆ‘ä»¬æ›´æ¢æ—¥å¿—çš„å®ç°ç±»ï¼Œé‚£ä¹ˆä¸‹é¢çš„ä»£ç ä¸éœ€è¦è·Ÿç€ä¿®æ”¹ //æ¨èä½¿ç”¨ private static final Logger LOGGER = LoggerFactory.getLogger(Log4JTest01.class); public static void main(String[] args) &#123; //1.å¯¼å…¥jaråŒ… //2.ç¼–å†™é…ç½®æ–‡ä»¶ //3.åœ¨ä»£ç ä¸­è·å–æ—¥å¿—çš„å¯¹è±¡ //4.æŒ‰ç…§æ—¥å¿—çº§åˆ«è®¾ç½®æ—¥å¿—ä¿¡æ¯ LOGGER.debug(&quot;debugçº§åˆ«çš„æ—¥å¿—&quot;); LOGGER.info(&quot;infoçº§åˆ«çš„æ—¥å¿—&quot;); LOGGER.warn(&quot;warnçº§åˆ«çš„æ—¥å¿—&quot;); LOGGER.error(&quot;errorçº§åˆ«çš„æ—¥å¿—&quot;); &#125;&#125; NettyåŸºæœ¬ä»‹ç»Netty æ˜¯ä¸€ä¸ªå¼‚æ­¥äº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨ç¨‹åºæ¡†æ¶ï¼Œç”¨äºå¿«é€Ÿå¼€å‘å¯ç»´æŠ¤ã€é«˜æ€§èƒ½çš„ç½‘ç»œæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ Netty å®˜ç½‘ï¼šhttps://netty.io/ Netty çš„å¯¹ JDK è‡ªå¸¦çš„ NIO çš„ API è¿›è¡Œå°è£…ï¼Œè§£å†³ä¸Šè¿°é—®é¢˜ï¼Œä¸»è¦ç‰¹ç‚¹æœ‰ï¼š è®¾è®¡ä¼˜é›…ï¼Œé€‚ç”¨äºå„ç§ä¼ è¾“ç±»å‹çš„ç»Ÿä¸€ APIï¼Œ é˜»å¡å’Œéé˜»å¡ Socket åŸºäºçµæ´»ä¸”å¯æ‰©å±•çš„äº‹ä»¶æ¨¡å‹ ä½¿ç”¨æ–¹ä¾¿ï¼Œè¯¦ç»†è®°å½•çš„ Javadocã€ç”¨æˆ·æŒ‡å—å’Œç¤ºä¾‹ï¼Œæ²¡æœ‰å…¶ä»–ä¾èµ–é¡¹ é«˜æ€§èƒ½ï¼Œååé‡æ›´é«˜ï¼Œå»¶è¿Ÿæ›´ä½ï¼Œå‡å°‘èµ„æºæ¶ˆè€—ï¼Œæœ€å°åŒ–ä¸å¿…è¦çš„å†…å­˜å¤åˆ¶ å®‰å…¨ï¼Œå®Œæ•´çš„ SSL&#x2F;TLS å’Œ StartTLS æ”¯æŒ Netty çš„åŠŸèƒ½ç‰¹æ€§ï¼š ä¼ è¾“æœåŠ¡ï¼šæ”¯æŒ BIO å’Œ NIO å®¹å™¨é›†æˆï¼šæ”¯æŒ OSGIã€JBossMCã€Springã€Guice å®¹å™¨ åè®®æ”¯æŒï¼šHTTPã€Protobufã€äºŒè¿›åˆ¶ã€æ–‡æœ¬ã€WebSocket ç­‰ä¸€ç³»åˆ—åè®®éƒ½æ”¯æŒï¼Œä¹Ÿæ”¯æŒé€šè¿‡å®è¡Œç¼–ç è§£ç é€»è¾‘æ¥å®ç°è‡ªå®šä¹‰åè®® Core æ ¸å¿ƒï¼šå¯æ‰©å±•äº‹ä»¶æ¨¡å‹ã€é€šç”¨é€šä¿¡ APIã€æ”¯æŒé›¶æ‹·è´çš„ ByteBuf ç¼“å†²å¯¹è±¡ çº¿ç¨‹æ¨¡å‹é˜»å¡æ¨¡å‹ä¼ ç»Ÿé˜»å¡å‹ I&#x2F;O æ¨¡å¼ï¼Œæ¯ä¸ªè¿æ¥éƒ½éœ€è¦ç‹¬ç«‹çš„çº¿ç¨‹å®Œæˆæ•°æ®çš„è¾“å…¥ï¼Œä¸šåŠ¡å¤„ç†ï¼Œæ•°æ®è¿”å› æ¨¡å‹ç¼ºç‚¹ï¼š å½“å¹¶å‘æ•°è¾ƒå¤§æ—¶ï¼Œéœ€è¦åˆ›å»ºå¤§é‡çº¿ç¨‹æ¥å¤„ç†è¿æ¥ï¼Œç³»ç»Ÿèµ„æºå ç”¨è¾ƒå¤§ è¿æ¥å»ºç«‹åï¼Œå¦‚æœå½“å‰çº¿ç¨‹æš‚æ—¶æ²¡æœ‰æ•°æ®å¯è¯»ï¼Œåˆ™çº¿ç¨‹å°±é˜»å¡åœ¨ read æ“ä½œä¸Šï¼Œé€ æˆçº¿ç¨‹èµ„æºæµªè´¹ å‚è€ƒæ–‡ç« ï¼šhttps://www.jianshu.com/p/2965fca6bb8f Reactorè®¾è®¡æ€æƒ³Reactor æ¨¡å¼ï¼Œé€šè¿‡ä¸€ä¸ªæˆ–å¤šä¸ªè¾“å…¥åŒæ—¶ä¼ é€’ç»™æœåŠ¡å¤„ç†å™¨çš„äº‹ä»¶é©±åŠ¨å¤„ç†æ¨¡å¼ã€‚ æœåŠ¡ç«¯ç¨‹åºå¤„ç†ä¼ å…¥çš„å¤šè·¯è¯·æ±‚ï¼Œå¹¶å°†å®ƒä»¬åŒæ­¥åˆ†æ´¾ç»™å¯¹åº”çš„å¤„ç†çº¿ç¨‹ï¼ŒReactor æ¨¡å¼ä¹Ÿå« Dispatcher æ¨¡å¼ï¼Œå³ I&#x2F;O å¤šè·¯å¤ç”¨ç»Ÿä¸€ç›‘å¬äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶ååˆ†å‘ï¼ˆDispatch ç»™æŸçº¿ç¨‹ï¼‰ I&#x2F;O å¤ç”¨ç»“åˆçº¿ç¨‹æ± ï¼Œå°±æ˜¯ Reactor æ¨¡å¼åŸºæœ¬è®¾è®¡æ€æƒ³ï¼š Reactor æ¨¡å¼å…³é”®ç»„æˆï¼š Reactorï¼šåœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸­è¿è¡Œï¼Œè´Ÿè´£ç›‘å¬å’Œåˆ†å‘äº‹ä»¶ï¼Œåˆ†å‘ç»™é€‚å½“çš„å¤„ç†ç¨‹åºæ¥å¯¹ I&#x2F;O äº‹ä»¶åšå‡ºååº” Handlerï¼šå¤„ç†ç¨‹åºæ‰§è¡Œ I&#x2F;O è¦å®Œæˆçš„å®é™…äº‹ä»¶ï¼ŒReactor é€šè¿‡è°ƒåº¦é€‚å½“çš„å¤„ç†ç¨‹åºæ¥å“åº” I&#x2F;O äº‹ä»¶ï¼Œå¤„ç†ç¨‹åºæ‰§è¡Œéé˜»å¡æ“ä½œ Reactor æ¨¡å¼å…·æœ‰å¦‚ä¸‹çš„ä¼˜ç‚¹ï¼š å“åº”å¿«ï¼Œä¸å¿…ä¸ºå•ä¸ªåŒæ­¥æ—¶é—´æ‰€é˜»å¡ï¼Œè™½ç„¶ Reactor æœ¬èº«ä¾ç„¶æ˜¯åŒæ­¥çš„ ç¼–ç¨‹ç›¸å¯¹ç®€å•ï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦çš„é¿å…å¤æ‚çš„å¤šçº¿ç¨‹åŠåŒæ­¥é—®é¢˜ï¼Œå¹¶ä¸”é¿å…äº†å¤šçº¿ç¨‹&#x2F;è¿›ç¨‹çš„åˆ‡æ¢å¼€é”€ å¯æ‰©å±•æ€§ï¼Œå¯ä»¥æ–¹ä¾¿çš„é€šè¿‡å¢åŠ  Reactor å®ä¾‹ä¸ªæ•°æ¥å……åˆ†åˆ©ç”¨ CPU èµ„æº å¯å¤ç”¨æ€§ï¼ŒReactor æ¨¡å‹æœ¬èº«ä¸å…·ä½“äº‹ä»¶å¤„ç†é€»è¾‘æ— å…³ï¼Œå…·æœ‰å¾ˆé«˜çš„å¤ç”¨æ€§ æ ¹æ® Reactor çš„æ•°é‡å’Œå¤„ç†èµ„æºæ± çº¿ç¨‹çš„æ•°é‡ä¸åŒï¼Œæœ‰ä¸‰ç§å…¸å‹çš„å®ç°ï¼š å• Reactor å•çº¿ç¨‹ å• Reactor å¤šçº¿ç¨‹ ä¸»ä» Reactor å¤šçº¿ç¨‹ å•Rå•çº¿ç¨‹Reactor å¯¹è±¡é€šè¿‡ select ç›‘æ§å®¢æˆ·ç«¯è¯·æ±‚äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åé€šè¿‡ dispatch è¿›è¡Œåˆ†å‘ï¼š å¦‚æœæ˜¯å»ºç«‹è¿æ¥è¯·æ±‚äº‹ä»¶ï¼Œåˆ™ç”± Acceptor é€šè¿‡ accept å¤„ç†è¿æ¥è¯·æ±‚ï¼Œç„¶ååˆ›å»ºä¸€ä¸ª Handler å¯¹è±¡å¤„ç†è¿æ¥å®Œæˆåçš„åç»­ä¸šåŠ¡å¤„ç† å¦‚æœä¸æ˜¯å»ºç«‹è¿æ¥äº‹ä»¶ï¼Œåˆ™ Reactor ä¼šåˆ†å‘ç»™è¿æ¥å¯¹åº”çš„ Handler æ¥å“åº”ï¼ŒHandler ä¼šå®Œæˆ readã€ä¸šåŠ¡å¤„ç†ã€send çš„å®Œæ•´æµç¨‹ è¯´æ˜ï¼šHandler å’Œ Acceptor å±äºåŒä¸€ä¸ªçº¿ç¨‹ æ¨¡å‹ä¼˜ç‚¹ï¼šæ¨¡å‹ç®€å•ï¼Œæ²¡æœ‰å¤šçº¿ç¨‹ã€è¿›ç¨‹é€šä¿¡ã€ç«äº‰çš„é—®é¢˜ï¼Œå…¨éƒ¨éƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å®Œæˆ æ¨¡å‹ç¼ºç‚¹ï¼š æ€§èƒ½é—®é¢˜ï¼šåªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œæ— æ³•å‘æŒ¥å¤šæ ¸ CPU çš„æ€§èƒ½ï¼ŒHandler åœ¨å¤„ç†æŸä¸ªè¿æ¥ä¸Šçš„ä¸šåŠ¡æ—¶ï¼Œæ•´ä¸ªè¿›ç¨‹æ— æ³•å¤„ç†å…¶ä»–è¿æ¥äº‹ä»¶ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´æ€§èƒ½ç“¶é¢ˆ å¯é æ€§é—®é¢˜ï¼šçº¿ç¨‹æ„å¤–è·‘é£ï¼Œæˆ–è€…è¿›å…¥æ­»å¾ªç¯ï¼Œä¼šå¯¼è‡´æ•´ä¸ªç³»ç»Ÿé€šä¿¡æ¨¡å—ä¸å¯ç”¨ï¼Œä¸èƒ½æ¥æ”¶å’Œå¤„ç†å¤–éƒ¨æ¶ˆæ¯ï¼Œé€ æˆèŠ‚ç‚¹æ•…éšœ ä½¿ç”¨åœºæ™¯ï¼šå®¢æˆ·ç«¯çš„æ•°é‡æœ‰é™ï¼Œä¸šåŠ¡å¤„ç†éå¸¸å¿«é€Ÿï¼Œæ¯”å¦‚ Redisï¼Œä¸šåŠ¡å¤„ç†çš„æ—¶é—´å¤æ‚åº¦ O(1) å•Rå¤šçº¿ç¨‹æ‰§è¡Œæµç¨‹é€šåŒå• Reactor å•çº¿ç¨‹ï¼Œä¸åŒçš„æ˜¯ï¼š Handler åªè´Ÿè´£å“åº”äº‹ä»¶ï¼Œä¸åšå…·ä½“ä¸šåŠ¡å¤„ç†ï¼Œé€šè¿‡ read è¯»å–æ•°æ®åï¼Œä¼šåˆ†å‘ç»™åé¢çš„ Worker çº¿ç¨‹æ± è¿›è¡Œä¸šåŠ¡å¤„ç† Worker çº¿ç¨‹æ± ä¼šåˆ†é…ç‹¬ç«‹çš„çº¿ç¨‹å®ŒæˆçœŸæ­£çš„ä¸šåŠ¡å¤„ç†ï¼Œå°†å“åº”ç»“æœå‘ç»™ Handler è¿›è¡Œå¤„ç†ï¼Œæœ€åç”± Handler æ”¶åˆ°å“åº”ç»“æœåé€šè¿‡ send å°†å“åº”ç»“æœè¿”å›ç»™ Client æ¨¡å‹ä¼˜ç‚¹ï¼šå¯ä»¥å……åˆ†åˆ©ç”¨å¤šæ ¸ CPU çš„å¤„ç†èƒ½åŠ› æ¨¡å‹ç¼ºç‚¹ï¼š å¤šçº¿ç¨‹æ•°æ®å…±äº«å’Œè®¿é—®æ¯”è¾ƒå¤æ‚ Reactor æ‰¿æ‹…æ‰€æœ‰äº‹ä»¶çš„ç›‘å¬å’Œå“åº”ï¼Œåœ¨å•çº¿ç¨‹ä¸­è¿è¡Œï¼Œé«˜å¹¶å‘åœºæ™¯ä¸‹å®¹æ˜“æˆä¸ºæ€§èƒ½ç“¶é¢ˆ ä¸»ä»æ¨¡å‹é‡‡ç”¨å¤šä¸ª Reactor ï¼Œæ‰§è¡Œæµç¨‹ï¼š Reactor ä¸»çº¿ç¨‹ MainReactor é€šè¿‡ select ç›‘æ§å»ºç«‹è¿æ¥äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åé€šè¿‡ Acceptor æ¥æ”¶ï¼Œå¤„ç†å»ºç«‹è¿æ¥äº‹ä»¶ï¼Œå¤„ç†å®Œæˆå MainReactor ä¼šå°†è¿æ¥åˆ†é…ç»™ Reactor å­çº¿ç¨‹çš„ SubReactorï¼ˆæœ‰å¤šä¸ªï¼‰å¤„ç† SubReactor å°†è¿æ¥åŠ å…¥è¿æ¥é˜Ÿåˆ—è¿›è¡Œç›‘å¬å…¶ä»–äº‹ä»¶ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª Handler ç”¨äºå¤„ç†è¯¥è¿æ¥çš„äº‹ä»¶ï¼Œå½“æœ‰æ–°çš„äº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒSubReactor ä¼šè°ƒç”¨è¿æ¥å¯¹åº”çš„ Handler è¿›è¡Œå“åº” Handler é€šè¿‡ read è¯»å–æ•°æ®åï¼Œä¼šåˆ†å‘ç»™ Worker çº¿ç¨‹æ± è¿›è¡Œä¸šåŠ¡å¤„ç† Worker çº¿ç¨‹æ± ä¼šåˆ†é…ç‹¬ç«‹çš„çº¿ç¨‹å®ŒæˆçœŸæ­£çš„ä¸šåŠ¡å¤„ç†ï¼Œå°†å“åº”ç»“æœå‘ç»™ Handler è¿›è¡Œå¤„ç†ï¼Œæœ€åç”± Handler æ”¶åˆ°å“åº”ç»“æœåé€šè¿‡ send å°†å“åº”ç»“æœè¿”å›ç»™ Client æ¨¡å‹ä¼˜ç‚¹ çˆ¶çº¿ç¨‹ä¸å­çº¿ç¨‹çš„æ•°æ®äº¤äº’ç®€å•èŒè´£æ˜ç¡®ï¼Œçˆ¶çº¿ç¨‹åªéœ€è¦æ¥æ”¶æ–°è¿æ¥ï¼Œå­çº¿ç¨‹å®Œæˆåç»­çš„ä¸šåŠ¡å¤„ç† çˆ¶çº¿ç¨‹ä¸å­çº¿ç¨‹çš„æ•°æ®äº¤äº’ç®€å•ï¼ŒReactor ä¸»çº¿ç¨‹åªéœ€è¦æŠŠæ–°è¿æ¥ä¼ ç»™å­çº¿ç¨‹ï¼Œå­çº¿ç¨‹æ— éœ€è¿”å›æ•°æ® ä½¿ç”¨åœºæ™¯ï¼šNginx ä¸»ä» Reactor å¤šè¿›ç¨‹æ¨¡å‹ï¼ŒMemcached ä¸»ä»å¤šçº¿ç¨‹ï¼ŒNetty ä¸»ä»å¤šçº¿ç¨‹æ¨¡å‹çš„æ”¯æŒ ProactorReactor æ¨¡å¼ä¸­ï¼ŒReactor ç­‰å¾…æŸä¸ªäº‹ä»¶çš„æ“ä½œçŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼ˆæ–‡ä»¶æè¿°ç¬¦å¯è¯»å†™ï¼Œsocket å¯è¯»å†™ï¼‰ï¼Œç„¶åæŠŠäº‹ä»¶ä¼ é€’ç»™äº‹å…ˆæ³¨å†Œçš„ Handler æ¥åšå®é™…çš„è¯»å†™æ“ä½œï¼Œå…¶ä¸­çš„è¯»å†™æ“ä½œéƒ½éœ€è¦åº”ç”¨ç¨‹åºåŒæ­¥æ“ä½œï¼Œæ‰€ä»¥ Reactor æ˜¯éé˜»å¡åŒæ­¥ç½‘ç»œæ¨¡å‹ï¼ˆNIOï¼‰ æŠŠ I&#x2F;O æ“ä½œæ”¹ä¸ºå¼‚æ­¥ï¼Œäº¤ç»™æ“ä½œç³»ç»Ÿæ¥å®Œæˆå°±èƒ½è¿›ä¸€æ­¥æå‡æ€§èƒ½ï¼Œè¿™å°±æ˜¯å¼‚æ­¥ç½‘ç»œæ¨¡å‹ Proactorï¼ˆAIOï¼‰ï¼š å·¥ä½œæµç¨‹ï¼š ProactorInitiator åˆ›å»º Proactor å’Œ Handler å¯¹è±¡ï¼Œå¹¶å°† Proactor å’Œ Handler é€šè¿‡ Asynchronous Operation Processorï¼ˆAsyOptProcessorï¼‰æ³¨å†Œåˆ°å†…æ ¸ AsyOptProcessor å¤„ç†æ³¨å†Œè¯·æ±‚ï¼Œå¹¶å¤„ç† I&#x2F;O æ“ä½œï¼Œå®ŒæˆI&#x2F;Oåé€šçŸ¥ Proactor Proactor æ ¹æ®ä¸åŒçš„äº‹ä»¶ç±»å‹å›è°ƒä¸åŒçš„ Handler è¿›è¡Œä¸šåŠ¡å¤„ç†ï¼Œæœ€åç”± Handler å®Œæˆä¸šåŠ¡å¤„ç† å¯¹æ¯”ï¼šReactor åœ¨äº‹ä»¶å‘ç”Ÿæ—¶å°±é€šçŸ¥äº‹å…ˆæ³¨å†Œçš„å¤„ç†å™¨ï¼ˆè¯»å†™åœ¨åº”ç”¨ç¨‹åºçº¿ç¨‹ä¸­å¤„ç†å®Œæˆï¼‰ï¼›Proactor æ˜¯åœ¨äº‹ä»¶å‘ç”Ÿæ—¶åŸºäºå¼‚æ­¥ I&#x2F;O å®Œæˆè¯»å†™æ“ä½œï¼ˆå†…æ ¸å®Œæˆï¼‰ï¼ŒI&#x2F;O å®Œæˆåæ‰å›è°ƒåº”ç”¨ç¨‹åºçš„å¤„ç†å™¨è¿›è¡Œä¸šåŠ¡å¤„ç† æ¨¡å¼ä¼˜ç‚¹ï¼šå¼‚æ­¥ I&#x2F;O æ›´åŠ å……åˆ†å‘æŒ¥ DMAï¼ˆDirect Memory Access ç›´æ¥å†…å­˜å­˜å–ï¼‰çš„ä¼˜åŠ¿ æ¨¡å¼ç¼ºç‚¹ï¼š ç¼–ç¨‹å¤æ‚æ€§ï¼Œç”±äºå¼‚æ­¥æ“ä½œæµç¨‹çš„äº‹ä»¶çš„åˆå§‹åŒ–å’Œäº‹ä»¶å®Œæˆåœ¨æ—¶é—´å’Œç©ºé—´ä¸Šéƒ½æ˜¯ç›¸äº’åˆ†ç¦»çš„ï¼Œå› æ­¤å¼€å‘å¼‚æ­¥åº”ç”¨ç¨‹åºæ›´åŠ å¤æ‚ï¼Œåº”ç”¨ç¨‹åºè¿˜å¯èƒ½å› ä¸ºåå‘çš„æµæ§è€Œå˜å¾—æ›´åŠ éš¾ä»¥è°ƒè¯• å†…å­˜ä½¿ç”¨ï¼Œç¼“å†²åŒºåœ¨è¯»æˆ–å†™æ“ä½œçš„æ—¶é—´æ®µå†…å¿…é¡»ä¿æŒä½ï¼Œå¯èƒ½é€ æˆæŒç»­çš„ä¸ç¡®å®šæ€§ï¼Œå¹¶ä¸”æ¯ä¸ªå¹¶å‘æ“ä½œéƒ½è¦æ±‚æœ‰ç‹¬ç«‹çš„ç¼“å­˜ï¼ŒReactor æ¨¡å¼åœ¨ socket å‡†å¤‡å¥½è¯»æˆ–å†™ä¹‹å‰æ˜¯ä¸è¦æ±‚å¼€è¾Ÿç¼“å­˜çš„ æ“ä½œç³»ç»Ÿæ”¯æŒï¼ŒWindows ä¸‹é€šè¿‡ IOCP å®ç°äº†çœŸæ­£çš„å¼‚æ­¥ I&#x2F;Oï¼Œè€Œåœ¨ Linux ç³»ç»Ÿä¸‹ï¼ŒLinux2.6 æ‰å¼•å…¥å¼‚æ­¥ I&#x2F;Oï¼Œç›®å‰è¿˜ä¸å®Œå–„ï¼Œæ‰€ä»¥åœ¨ Linux ä¸‹å®ç°é«˜å¹¶å‘ç½‘ç»œç¼–ç¨‹éƒ½æ˜¯ä»¥ Reactor æ¨¡å‹ä¸ºä¸» NettyNetty ä¸»è¦åŸºäºä¸»ä» Reactors å¤šçº¿ç¨‹æ¨¡å‹åšäº†ä¸€å®šçš„æ”¹è¿›ï¼ŒNetty çš„å·¥ä½œæ¶æ„å›¾ï¼š å·¥ä½œæµç¨‹ï¼š Netty æŠ½è±¡å‡ºä¸¤ç»„çº¿ç¨‹æ±  BossGroup ä¸“é—¨è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥ï¼ŒWorkerGroup ä¸“é—¨è´Ÿè´£ç½‘ç»œçš„è¯»å†™ BossGroup å’Œ WorkerGroup ç±»å‹éƒ½æ˜¯ NioEventLoopGroupï¼Œè¯¥ Group ç›¸å½“äºä¸€ä¸ªäº‹ä»¶å¾ªç¯ç»„ï¼Œå«æœ‰å¤šä¸ªäº‹ä»¶å¾ªç¯ï¼Œæ¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯æ˜¯ NioEventLoopï¼Œæ‰€ä»¥å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ NioEventLoop è¡¨ç¤ºä¸€ä¸ªå¾ªç¯å¤„ç†ä»»åŠ¡çš„çº¿ç¨‹ï¼Œæ¯ä¸ª NioEventLoop éƒ½æœ‰ä¸€ä¸ª Selectorï¼Œç”¨äºç›‘å¬ç»‘å®šåœ¨å…¶ä¸Šçš„ Socket çš„é€šè®¯ æ¯ä¸ª Boss NioEventLoop å¾ªç¯æ‰§è¡Œçš„æ­¥éª¤ï¼š è½®è¯¢ accept äº‹ä»¶ å¤„ç† accept äº‹ä»¶ï¼Œä¸ client å»ºç«‹è¿æ¥ï¼Œç”Ÿæˆ NioScocketChannelï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ°æŸä¸ª Worker ä¸­çš„æŸä¸ª NioEventLoop ä¸Šçš„ Selectorï¼Œè¿æ¥å°±ä¸ NioEventLoop ç»‘å®š å¤„ç†ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œå³ runAllTasks æ¯ä¸ª Worker NioEventLoop å¾ªç¯æ‰§è¡Œçš„æ­¥éª¤ï¼š è½®è¯¢ readã€write äº‹ä»¶ å¤„ç† I&#x2F;O äº‹ä»¶ï¼Œå³ readï¼Œwrite äº‹ä»¶ï¼Œåœ¨å¯¹åº” NioSocketChannel å¤„ç† å¤„ç†ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œå³ runAllTasks æ¯ä¸ª Worker NioEventLoop å¤„ç†ä¸šåŠ¡æ—¶ï¼Œä¼šä½¿ç”¨ Pipelineï¼ˆç®¡é“ï¼‰ï¼ŒPipeline ä¸­åŒ…å«äº† Channelï¼Œå³é€šè¿‡ Pipeline å¯ä»¥è·å–åˆ°å¯¹åº”é€šé“ï¼Œç®¡é“ä¸­ç»´æŠ¤äº†å¾ˆå¤šçš„å¤„ç†å™¨ Handler åŸºæœ¬å®ç°å¼€å‘ç®€å•çš„æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯ï¼ŒåŸºæœ¬ä»‹ç»ï¼š Channel ç†è§£ä¸ºæ•°æ®çš„é€šé“ï¼ŒæŠŠ msg ç†è§£ä¸ºæµåŠ¨çš„æ•°æ®ï¼Œæœ€å¼€å§‹è¾“å…¥æ˜¯ ByteBufï¼Œä½†ç»è¿‡ Pipeline çš„åŠ å·¥ï¼Œä¼šå˜æˆå…¶å®ƒç±»å‹å¯¹è±¡ï¼Œæœ€åè¾“å‡ºåˆå˜æˆ ByteBuf Handler ç†è§£ä¸ºæ•°æ®çš„å¤„ç†å·¥åºï¼ŒPipeline è´Ÿè´£å‘å¸ƒäº‹ä»¶ä¼ æ’­ç»™æ¯ä¸ª Handlerï¼ŒHandler å¯¹è‡ªå·±æ„Ÿå…´è¶£çš„äº‹ä»¶è¿›è¡Œå¤„ç†ï¼ˆé‡å†™äº†ç›¸åº”äº‹ä»¶å¤„ç†æ–¹æ³•ï¼‰ï¼Œåˆ† Inbound å’Œ Outbound ä¸¤ç±» EventLoop ç†è§£ä¸ºå¤„ç†æ•°æ®çš„æ‰§è¡Œè€…ï¼Œæ—¢å¯ä»¥æ‰§è¡Œ IO æ“ä½œï¼Œä¹Ÿå¯ä»¥è¿›è¡Œä»»åŠ¡å¤„ç†ã€‚æ¯ä¸ªæ‰§è¡Œè€…æœ‰ä»»åŠ¡é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—é‡Œå¯ä»¥å †æ”¾å¤šä¸ª Channel çš„å¾…å¤„ç†ä»»åŠ¡ï¼Œä»»åŠ¡åˆ†ä¸ºæ™®é€šä»»åŠ¡ã€å®šæ—¶ä»»åŠ¡ã€‚æŒ‰ç…§ Pipeline é¡ºåºï¼Œä¾æ¬¡æŒ‰ç…§ Handler çš„è§„åˆ’ï¼ˆä»£ç ï¼‰å¤„ç†æ•°æ® ä»£ç å®ç°ï¼š pom.xml 12345&lt;dependency&gt; &lt;groupId&gt;io.netty&lt;/groupId&gt; &lt;artifactId&gt;netty-all&lt;/artifactId&gt; &lt;version&gt;4.1.20.Final&lt;/version&gt;&lt;/dependency&gt; Server.java 12345678910111213141516171819202122232425262728293031323334public class HelloServer &#123; public static void main(String[] args) &#123; EventLoopGroup boss = new NioEventLoopGroup(); EventLoopGroup worker = new NioEventLoopGroup(2); // 1. å¯åŠ¨å™¨ï¼Œè´Ÿè´£ç»„è£… netty ç»„ä»¶ï¼Œå¯åŠ¨æœåŠ¡å™¨ new ServerBootstrap() // 2. çº¿ç¨‹ç»„ï¼Œboss åªè´Ÿè´£ã€å¤„ç† accept äº‹ä»¶ã€‘ï¼Œ worker åªã€è´Ÿè´£ channel ä¸Šçš„è¯»å†™ã€‘ .group(boss, worker) //.option() // ç»™ ServerSocketChannel é…ç½®å‚æ•° //.childOption() // ç»™ SocketChannel é…ç½®å‚æ•° // 3. é€‰æ‹©æœåŠ¡å™¨çš„ ServerSocketChannel å®ç° .channel(NioServerSocketChannel.class) // 4. boss è´Ÿè´£å¤„ç†è¿æ¥ï¼Œworker(child) è´Ÿè´£å¤„ç†è¯»å†™ï¼Œå†³å®šäº†èƒ½æ‰§è¡Œå“ªäº›æ“ä½œ(handler) .childHandler(new ChannelInitializer&lt;NioSocketChannel&gt;() &#123; // 5. channel ä»£è¡¨å’Œå®¢æˆ·ç«¯è¿›è¡Œæ•°æ®è¯»å†™çš„é€šé“ Initializer åˆå§‹åŒ–ï¼Œè´Ÿè´£æ·»åŠ åˆ«çš„ handler // 7. è¿æ¥å»ºç«‹åï¼Œæ‰§è¡Œåˆå§‹åŒ–æ–¹æ³• @Override protected void initChannel(NioSocketChannel ch) throws Exception &#123; // æ·»åŠ å…·ä½“çš„ handler ch.pipeline().addLast(new StringDecoder());// å°† ByteBuf è½¬æˆå­—ç¬¦ä¸² ch.pipeline().addLast(new ChannelInboundHandlerAdapter() &#123; // è‡ªå®šä¹‰ handler // è¯»äº‹ä»¶ @Override public void channelRead(ChannelHandlerContext ctx, Object msg) &#123; // æ‰“å°è½¬æ¢å¥½çš„å­—ç¬¦ä¸² System.out.println(msg); &#125; &#125;); &#125; &#125;) // 6. ç»‘å®šç›‘å¬ç«¯å£ .bind(8080); &#125;&#125; Client.java 12345678910111213141516171819202122232425262728public class HelloClient &#123; public static void main(String[] args) throws InterruptedException &#123; // 1. åˆ›å»ºå¯åŠ¨å™¨ç±» new Bootstrap() // 2. æ·»åŠ  EventLoop .group(new NioEventLoopGroup()) //.option()ï¼Œç»™ SocketChannel é…ç½®å‚æ•° // 3. é€‰æ‹©å®¢æˆ·ç«¯ channel å®ç° .channel(NioSocketChannel.class) // 4. æ·»åŠ å¤„ç†å™¨ .handler(new ChannelInitializer&lt;NioSocketChannel&gt;() &#123; // 4.1 è¿æ¥å»ºç«‹åè¢«è°ƒç”¨ @Override protected void initChannel(NioSocketChannel ch) throws Exception &#123; // å°† Hello World è½¬ä¸º ByteBuf ch.pipeline().addLast(new StringEncoder()); &#125; &#125;) // 5. è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œç„¶åè°ƒç”¨ 4.1 .connect(new InetSocketAddress(&quot;127.0.0.1&quot;,8080)) // 6. é˜»å¡æ–¹æ³•ï¼Œç›´åˆ°è¿æ¥å»ºç«‹ .sync() // 7. ä»£è¡¨è¿æ¥å¯¹è±¡ .channel() // 8. å‘æœåŠ¡å™¨å‘é€æ•°æ® .writeAndFlush(&quot;Hello World&quot;); &#125;&#125; å‚è€ƒè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV1py4y1E7oA ç»„ä»¶ä»‹ç»EventLoopåŸºæœ¬ä»‹ç»äº‹ä»¶å¾ªç¯å¯¹è±¡ EventLoopï¼Œæœ¬è´¨æ˜¯ä¸€ä¸ªå•çº¿ç¨‹æ‰§è¡Œå™¨åŒæ—¶ç»´æŠ¤äº†ä¸€ä¸ª Selectorï¼Œæœ‰ run æ–¹æ³•å¤„ç† Channel ä¸Šæºæºä¸æ–­çš„ IO äº‹ä»¶ äº‹ä»¶å¾ªç¯ç»„ EventLoopGroup æ˜¯ä¸€ç»„ EventLoopï¼ŒChannel ä¼šè°ƒç”¨ Boss EventLoopGroup çš„ register æ–¹æ³•æ¥ç»‘å®šå…¶ä¸­ä¸€ä¸ª Worker çš„ EventLoopï¼Œåç»­è¿™ä¸ª Channel ä¸Šçš„ IO äº‹ä»¶éƒ½ç”±æ­¤ EventLoop æ¥å¤„ç†ï¼Œä¿è¯äº†äº‹ä»¶å¤„ç†æ—¶çš„çº¿ç¨‹å®‰å…¨ EventLoopGroup ç±» APIï¼š EventLoop next()ï¼šè·å–é›†åˆä¸­ä¸‹ä¸€ä¸ª EventLoopï¼ŒEventLoopGroup å®ç°äº† Iterable æ¥å£æä¾›éå† EventLoop çš„èƒ½åŠ› Future&lt;?&gt; shutdownGracefully()ï¼šä¼˜é›…å…³é—­çš„æ–¹æ³•ï¼Œä¼šé¦–å…ˆåˆ‡æ¢ EventLoopGroup åˆ°å…³é—­çŠ¶æ€ä»è€Œæ‹’ç»æ–°çš„ä»»åŠ¡çš„åŠ å…¥ï¼Œç„¶ååœ¨ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡éƒ½å¤„ç†å®Œæˆåï¼Œåœæ­¢çº¿ç¨‹çš„è¿è¡Œï¼Œä»è€Œç¡®ä¿æ•´ä½“åº”ç”¨æ˜¯åœ¨æ­£å¸¸æœ‰åºçš„çŠ¶æ€ä¸‹é€€å‡ºçš„ &lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task)ï¼šæäº¤ä»»åŠ¡ ScheduledFuture&lt;?&gt; scheduleWithFixedDelayï¼šæäº¤å®šæ—¶ä»»åŠ¡ ä»»åŠ¡ä¼ é€’æŠŠè¦è°ƒç”¨çš„ä»£ç å°è£…ä¸ºä¸€ä¸ªä»»åŠ¡å¯¹è±¡ï¼Œç”±ä¸‹ä¸€ä¸ª handler çš„çº¿ç¨‹æ¥è°ƒç”¨ 12345678910111213141516171819202122232425262728public class EventLoopServer &#123; public static void main(String[] args) &#123; EventLoopGroup group = new DefaultEventLoopGroup(); new ServerBootstrap() .group(new NioEventLoopGroup(), new NioEventLoopGroup(2)) .channel(NioServerSocketChannel.class) .childHandler(new ChannelInitializer&lt;NioSocketChannel&gt;() &#123; @Override protected void initChannel(NioSocketChannel ch) &#123; ch.pipeline().addLast(&quot;handler1&quot;, new ChannelInboundHandlerAdapter() &#123; @Override public void channelRead(ChannelHandlerContext ctx, Object msg) &#123; ByteBuf buf = (ByteBuf) msg; log.debug(buf.toString(Charset.defaultCharset())); ctx.fireChannelRead(msg); // è®©æ¶ˆæ¯ã€ä¼ é€’ã€‘ç»™ä¸‹ä¸€ä¸ª handler &#125; &#125;).addLast(group, &quot;handler2&quot;, new ChannelInboundHandlerAdapter() &#123; @Override public void channelRead(ChannelHandlerContext ctx, Object msg) &#123; ByteBuf buf = (ByteBuf) msg; log.debug(buf.toString(Charset.defaultCharset())); &#125; &#125;); &#125; &#125;) .bind(8080); &#125;&#125; æºç åˆ†æï¼š 123456789101112131415161718192021public ChannelHandlerContext fireChannelRead(final Object msg) &#123; invokeChannelRead(findContextInbound(MASK_CHANNEL_READ), msg); return this;&#125;static void invokeChannelRead(final AbstractChannelHandlerContext next, Object msg) &#123; final Object m = next.pipeline.touch(ObjectUtil.checkNotNull(msg, &quot;msg&quot;), next); EventExecutor executor = next.executor(); // ä¸‹ä¸€ä¸ª handler çš„äº‹ä»¶å¾ªç¯æ˜¯å¦ä¸å½“å‰çš„äº‹ä»¶å¾ªç¯æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ if (executor.inEventLoop()) &#123; // æ˜¯ï¼Œç›´æ¥è°ƒç”¨ next.invokeChannelRead(m); &#125; else &#123; // ä¸æ˜¯ï¼Œå°†è¦æ‰§è¡Œçš„ä»£ç ä½œä¸ºä»»åŠ¡æäº¤ç»™ä¸‹ä¸€ä¸ª handler å¤„ç† executor.execute(new Runnable() &#123; @Override public void run() &#123; next.invokeChannelRead(m); &#125; &#125;); &#125;&#125; Channelè¿æ¥æ“ä½œChannel ç±» APIï¼š ChannelFuture close()ï¼šå…³é—­é€šé“ ChannelPipeline pipeline()ï¼šæ·»åŠ å¤„ç†å™¨ ChannelFuture write(Object msg)ï¼šæ•°æ®å†™å…¥ç¼“å†²åŒº ChannelFuture writeAndFlush(Object msg)ï¼šæ•°æ®å†™å…¥ç¼“å†²åŒºå¹¶ä¸”åˆ·å‡º ChannelFuture ç±» APIï¼š ChannelFuture sync()ï¼šåŒæ­¥é˜»å¡ç­‰å¾…è¿æ¥æˆåŠŸ ChannelFuture addListener(GenericFutureListener listener)ï¼šå¼‚æ­¥ç­‰å¾… ä»£ç å®ç°ï¼š connect æ–¹æ³•æ˜¯å¼‚æ­¥çš„ï¼Œä¸ç­‰è¿æ¥å»ºç«‹å®Œæˆå°±è¿”å›ï¼Œå› æ­¤ channelFuture å¯¹è±¡ä¸­ä¸èƒ½ç«‹åˆ»è·å¾—åˆ°æ­£ç¡®çš„ Channel å¯¹è±¡ï¼Œéœ€è¦ç­‰å¾… è¿æ¥æœªå»ºç«‹ channel æ‰“å°ä¸º [id: 0x2e1884dd]ï¼›å»ºç«‹æˆåŠŸæ‰“å°ä¸º [id: 0x2e1884dd, L:/127.0.0.1:57191 - R:/127.0.0.1:8080] 12345678910111213141516171819202122232425262728293031323334353637public class ChannelClient &#123; public static void main(String[] args) throws InterruptedException &#123; ChannelFuture channelFuture = new Bootstrap() .group(new NioEventLoopGroup()) .channel(NioSocketChannel.class) .handler(new ChannelInitializer&lt;NioSocketChannel&gt;() &#123; @Override protected void initChannel(NioSocketChannel ch) throws Exception &#123; ch.pipeline().addLast(new StringEncoder()); &#125; &#125;) // 1. è¿æ¥æœåŠ¡å™¨ï¼Œã€å¼‚æ­¥éé˜»å¡ã€‘ï¼Œmain è°ƒç”¨ connect æ–¹æ³•ï¼ŒçœŸæ­£æ‰§è¡Œè¿æ¥çš„æ˜¯ nio çº¿ç¨‹ .connect(new InetSocketAddress(&quot;127.0.0.1&quot;, 8080)); // 2.1 ä½¿ç”¨ sync æ–¹æ³•ã€åŒæ­¥ã€‘å¤„ç†ç»“æœï¼Œé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ° nio çº¿ç¨‹è¿æ¥å»ºç«‹å®Œæ¯• channelFuture.sync(); Channel channel = channelFuture.channel(); System.out.println(channel); // ã€æ‰“å°ã€‘ // å‘æœåŠ¡å™¨å‘é€æ•°æ® channel.writeAndFlush(&quot;hello world&quot;); **************************************************************************************äºŒé€‰ä¸€ // 2.2 ä½¿ç”¨ addListener æ–¹æ³•ã€å¼‚æ­¥ã€‘å¤„ç†ç»“æœ channelFuture.addListener(new ChannelFutureListener() &#123; @Override // nio çº¿ç¨‹è¿æ¥å»ºç«‹å¥½ä»¥åï¼Œå›è°ƒè¯¥æ–¹æ³• public void operationComplete(ChannelFuture future) throws Exception &#123; if (future.isSuccess()) &#123; Channel channel = future.channel(); channel.writeAndFlush(&quot;hello, world&quot;); &#125; else &#123; // å»ºç«‹å¤±è´¥ï¼Œéœ€è¦å…³é—­ future.channel().close(); &#125; &#125; &#125;); &#125;&#125; å…³é—­æ“ä½œå…³é—­ EventLoopGroup çš„è¿è¡Œï¼Œåˆ†ä¸ºåŒæ­¥å…³é—­å’Œå¼‚æ­¥å…³é—­ 12345678910111213141516171819202122232425262728293031323334353637public class CloseFutureClient &#123; public static void main(String[] args) throws InterruptedException &#123; NioEventLoopGroup group = new NioEventLoopGroup(); ChannelFuture channelFuture = new Bootstrap() // .... .connect(new InetSocketAddress(&quot;127.0.0.1&quot;, 8080)); Channel channel = channelFuture.sync().channel(); // å‘é€æ•°æ® new Thread(() -&gt; &#123; Scanner sc = new Scanner(System.in); while (true) &#123; String line = sc.nextLine(); if (line.equals(&quot;q&quot;)) &#123; channel.close(); break; &#125; channel.writeAndFlush(line); &#125; &#125;, &quot;input&quot;).start(); // è·å– CloseFuture å¯¹è±¡ ChannelFuture closeFuture = channel.closeFuture(); // 1. åŒæ­¥å¤„ç†å…³é—­ System.out.println(&quot;waiting close...&quot;); closeFuture.sync(); System.out.println(&quot;å¤„ç†å…³é—­åçš„æ“ä½œ&quot;);**************************************************** // 2. å¼‚æ­¥å¤„ç†å…³é—­ closeFuture.addListener(new ChannelFutureListener() &#123; @Override public void operationComplete(ChannelFuture future) throws Exception &#123; System.out.println(&quot;å¤„ç†å…³é—­åçš„æ“ä½œ&quot;); group.shutdownGracefully(); &#125; &#125;); &#125;&#125; FutureåŸºæœ¬ä»‹ç»Netty ä¸­çš„ Future ä¸ JDK ä¸­çš„ Future åŒåï¼Œä½†æ˜¯åŠŸèƒ½çš„å®ç°ä¸åŒ 12package io.netty.util.concurrent;public interface Future&lt;V&gt; extends java.util.concurrent.Future&lt;V&gt; Future ç±» APIï¼š V get()ï¼šé˜»å¡ç­‰å¾…è·å–ä»»åŠ¡æ‰§è¡Œç»“æœ V getNow()ï¼šéé˜»å¡è·å–ä»»åŠ¡ç»“æœï¼Œè¿˜æœªäº§ç”Ÿç»“æœæ—¶è¿”å› null Throwable cause()ï¼šéé˜»å¡è·å–å¤±è´¥ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰å¤±è´¥ï¼Œè¿”å› null Future&lt;V&gt; sync()ï¼šç­‰å¾…ä»»åŠ¡ç»“æŸï¼Œå¦‚æœä»»åŠ¡å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸ boolean cancel(boolean mayInterruptIfRunning)ï¼šå–æ¶ˆä»»åŠ¡ Future&lt;V&gt; addListener(GenericFutureListener listener)ï¼šæ·»åŠ å›è°ƒï¼Œå¼‚æ­¥æ¥æ”¶ç»“æœ boolean isSuccess()ï¼šåˆ¤æ–­ä»»åŠ¡æ˜¯å¦æˆåŠŸ boolean isCancellable()ï¼šåˆ¤æ–­ä»»åŠ¡æ˜¯å¦å–æ¶ˆ 1234567891011121314151617public class NettyFutureDemo &#123; public static void main(String[] args) throws Exception &#123; NioEventLoopGroup group = new NioEventLoopGroup(); EventLoop eventLoop = group.next(); Future&lt;Integer&gt; future = eventLoop.submit(new Callable&lt;Integer&gt;() &#123; @Override public Integer call() throws Exception &#123; System.out.println(&quot;æ‰§è¡Œè®¡ç®—&quot;); Thread.sleep(1000); return 70; &#125; &#125;); future.getNow(); System.out.println(new Date() + &quot;ç­‰å¾…ç»“æœ&quot;); System.out.println(new Date() + &quot;&quot; + future.get()); &#125;&#125; æ‰©å±•å­ç±»Promise ç±»æ˜¯ Future çš„å­ç±»ï¼Œå¯ä»¥è„±ç¦»ä»»åŠ¡ç‹¬ç«‹å­˜åœ¨ï¼Œä½œä¸ºä¸¤ä¸ªçº¿ç¨‹é—´ä¼ é€’ç»“æœçš„å®¹å™¨ 1public interface Promise&lt;V&gt; extends Future&lt;V&gt; Promise ç±» APIï¼š Promise&lt;V&gt; setSuccess(V result)ï¼šè®¾ç½®æˆåŠŸç»“æœ Promise&lt;V&gt; setFailure(Throwable cause)ï¼šè®¾ç½®å¤±è´¥ç»“æœ 123456789101112131415161718192021public class NettyPromiseDemo &#123; public static void main(String[] args) throws Exception &#123; // 1. å‡†å¤‡ EventLoop å¯¹è±¡ EventLoop eventLoop = new NioEventLoopGroup().next(); // 2. ä¸»åŠ¨åˆ›å»º promise DefaultPromise&lt;Integer&gt; promise = new DefaultPromise&lt;&gt;(eventLoop); // 3. ä»»æ„ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè®¡ç®—ï¼Œè®¡ç®—å®Œæ¯•åå‘ promise å¡«å……ç»“æœ new Thread(() -&gt; &#123; try &#123; Thread.sleep(1000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; promise.setSuccess(200); &#125;).start(); // 4. æ¥å—ç»“æœçš„çº¿ç¨‹ System.out.println(new Date() + &quot;ç­‰å¾…ç»“æœ&quot;); System.out.println(new Date() + &quot;&quot; + promise.get()); &#125;&#125; PipelineChannelHandler ç”¨æ¥å¤„ç† Channel ä¸Šçš„å„ç§äº‹ä»¶ï¼Œåˆ†ä¸ºå…¥ç«™å‡ºç«™ä¸¤ç§ï¼Œæ‰€æœ‰ ChannelHandler è¿æ¥æˆåŒå‘é“¾è¡¨å°±æ˜¯ Pipeline å…¥ç«™å¤„ç†å™¨é€šå¸¸æ˜¯ ChannelInboundHandlerAdapter çš„å­ç±»ï¼Œä¸»è¦ç”¨æ¥è¯»å–å®¢æˆ·ç«¯æ•°æ®ï¼Œå†™å›ç»“æœ å‡ºç«™å¤„ç†å™¨é€šå¸¸æ˜¯ ChannelOutboundHandlerAdapter çš„å­ç±»ï¼Œä¸»è¦å¯¹å†™å›ç»“æœè¿›è¡ŒåŠ å·¥ï¼ˆå…¥ç«™å’Œå‡ºç«™æ˜¯å¯¹äºæœåŠ¡ç«¯æ¥è¯´çš„ï¼‰ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748public static void main(String[] args) &#123; new ServerBootstrap() .group(new NioEventLoopGroup()) .channel(NioServerSocketChannel.class) .childHandler(new ChannelInitializer&lt;NioSocketChannel&gt;() &#123; @Override protected void initChannel(NioSocketChannel ch) throws Exception &#123; // 1. é€šè¿‡ channel æ‹¿åˆ° pipeline ChannelPipeline pipeline = ch.pipeline(); // 2. æ·»åŠ å¤„ç†å™¨ head -&gt; h1 -&gt; h2 -&gt; h3 -&gt; h4 -&gt; tail pipeline.addLast(&quot;h1&quot;, new ChannelInboundHandlerAdapter() &#123; @Override public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception &#123; log.debug(&quot;1&quot;); ByteBuf buf = (ByteBuf) msg; String s = buf.toString(Charset.defaultCharset()); // å°†æ•°æ®ä¼ é€’ç»™ä¸‹ä¸€ä¸ªã€å…¥ç«™ã€‘handlerï¼Œå¦‚æœä¸è°ƒç”¨è¯¥æ–¹æ³•åˆ™é“¾ä¼šæ–­å¼€ super.channelRead(ctx, s); &#125; &#125;); pipeline.addLast(&quot;h2&quot;, new ChannelInboundHandlerAdapter() &#123; @Override public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception &#123; log.debug(&quot;2&quot;); // ä»ã€å°¾éƒ¨å¼€å§‹å‘å‰è§¦å‘ã€‘å‡ºç«™å¤„ç†å™¨ ch.writeAndFlush(ctx.alloc().buffer().writeBytes(&quot;server&quot;.getBytes())); // è¯¥æ–¹æ³•ä¼šè®©ç®¡é“ä»ã€å½“å‰ handler å‘å‰ã€‘å¯»æ‰¾å‡ºç«™å¤„ç†å™¨ // ctx.writeAndFlush(); &#125; &#125;); pipeline.addLast(&quot;h3&quot;, new ChannelOutboundHandlerAdapter() &#123; @Override public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception &#123; log.debug(&quot;3&quot;); super.write(ctx, msg, promise); &#125; &#125;); pipeline.addLast(&quot;h4&quot;, new ChannelOutboundHandlerAdapter() &#123; @Override public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception &#123; log.debug(&quot;4&quot;); super.write(ctx, msg, promise); &#125; &#125;); &#125; &#125;) .bind(8080);&#125; æœåŠ¡å™¨ç«¯ä¾æ¬¡æ‰“å°ï¼š1 2 4 3 ï¼Œæ‰€ä»¥å…¥ç«™æ˜¯æŒ‰ç…§ addLast çš„é¡ºåºæ‰§è¡Œçš„ï¼Œå‡ºç«™æ˜¯æŒ‰ç…§ addLast çš„é€†åºæ‰§è¡Œ ä¸€ä¸ª Channel åŒ…å«äº†ä¸€ä¸ª ChannelPipelineï¼Œè€Œ ChannelPipeline ä¸­åˆç»´æŠ¤äº†ä¸€ä¸ªç”± ChannelHandlerContext ç»„æˆçš„åŒå‘é“¾è¡¨ï¼Œå¹¶ä¸”æ¯ä¸ª ChannelHandlerContext ä¸­å…³è”ç€ä¸€ä¸ª ChannelHandler å…¥ç«™äº‹ä»¶å’Œå‡ºç«™äº‹ä»¶åœ¨ä¸€ä¸ªåŒå‘é“¾è¡¨ä¸­ï¼Œä¸¤ç§ç±»å‹çš„ handler äº’ä¸å¹²æ‰°ï¼š å…¥ç«™äº‹ä»¶ä¼šä»é“¾è¡¨ head å¾€åä¼ é€’åˆ°æœ€åä¸€ä¸ªå…¥ç«™çš„ handler å‡ºç«™äº‹ä»¶ä¼šä»é“¾è¡¨ tail å¾€å‰ä¼ é€’åˆ°æœ€å‰ä¸€ä¸ªå‡ºç«™çš„ handler ByteBufåŸºæœ¬ä»‹ç»ByteBuf æ˜¯å¯¹å­—èŠ‚æ•°æ®çš„å°è£…ï¼Œä¼˜ç‚¹ï¼š æ± åŒ–ï¼Œå¯ä»¥é‡ç”¨æ± ä¸­ ByteBuf å®ä¾‹ï¼Œæ›´èŠ‚çº¦å†…å­˜ï¼Œå‡å°‘å†…å­˜æº¢å‡ºçš„å¯èƒ½ è¯»å†™æŒ‡é’ˆåˆ†ç¦»ï¼Œä¸éœ€è¦åƒ ByteBuffer ä¸€æ ·åˆ‡æ¢è¯»å†™æ¨¡å¼ å¯ä»¥è‡ªåŠ¨æ‰©å®¹ æ”¯æŒé“¾å¼è°ƒç”¨ï¼Œä½¿ç”¨æ›´æµç•… é›¶æ‹·è´æ€æƒ³ï¼Œä¾‹å¦‚ sliceã€duplicateã€CompositeByteBuf åˆ›å»ºæ–¹æ³•åˆ›å»ºæ–¹å¼ ByteBuf buffer = ByteBufAllocator.DEFAULT.buffer(10)ï¼šåˆ›å»ºäº†ä¸€ä¸ªé»˜è®¤çš„ ByteBufï¼Œåˆå§‹å®¹é‡æ˜¯ 10 123456public ByteBuf buffer() &#123; if (directByDefault) &#123; return directBuffer(); &#125; return heapBuffer();&#125; ByteBuf buffer = ByteBufAllocator.DEFAULT.heapBuffer(10)ï¼šåˆ›å»ºæ± åŒ–åŸºäºå †çš„ ByteBuf ByteBuf buffer = ByteBufAllocator.DEFAULT.directBuffer(10)ï¼šåˆ›å»ºæ± åŒ–åŸºäºç›´æ¥å†…å­˜çš„ ByteBuf æ¨èçš„åˆ›å»ºæ–¹å¼ï¼šåœ¨æ·»åŠ å¤„ç†å™¨çš„æ–¹æ³•ä¸­ 123456pipeline.addLast(new ChannelInboundHandlerAdapter() &#123; @Override public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception &#123; ByteBuf buffer = ctx.alloc().buffer(); &#125;&#125;); ç›´æ¥å†…å­˜å¯¹æ¯”å †å†…å­˜ï¼š ç›´æ¥å†…å­˜åˆ›å»ºå’Œé”€æ¯çš„ä»£ä»·æ˜‚è´µï¼Œä½†è¯»å†™æ€§èƒ½é«˜ï¼ˆå°‘ä¸€æ¬¡å†…å­˜å¤åˆ¶ï¼‰ï¼Œé€‚åˆé…åˆæ± åŒ–åŠŸèƒ½ä¸€èµ·ç”¨ ç›´æ¥å†…å­˜å¯¹ GC å‹åŠ›å°ï¼Œå› ä¸ºè¿™éƒ¨åˆ†å†…å­˜ä¸å— JVM åƒåœ¾å›æ”¶çš„ç®¡ç†ï¼Œä½†ä¹Ÿè¦æ³¨æ„åŠæ—¶ä¸»åŠ¨é‡Šæ”¾ æ± åŒ–çš„æ„ä¹‰åœ¨äºå¯ä»¥é‡ç”¨ ByteBufï¼Œé«˜å¹¶å‘æ—¶æ± åŒ–åŠŸèƒ½æ›´èŠ‚çº¦å†…å­˜ï¼Œå‡å°‘å†…å­˜æº¢å‡ºçš„å¯èƒ½ï¼Œä¸éæ± åŒ–å¯¹æ¯”ï¼š éæ± åŒ–ï¼Œæ¯æ¬¡éƒ½è¦åˆ›å»ºæ–°çš„ ByteBuf å®ä¾‹ï¼Œè¿™ä¸ªæ“ä½œå¯¹ç›´æ¥å†…å­˜ä»£ä»·æ˜‚è´µï¼Œå †å†…å­˜ä¼šå¢åŠ  GC å‹åŠ› æ± åŒ–ï¼Œå¯ä»¥é‡ç”¨æ± ä¸­ ByteBuf å®ä¾‹ï¼Œå¹¶ä¸”é‡‡ç”¨äº†ä¸ jemalloc ç±»ä¼¼çš„å†…å­˜åˆ†é…ç®—æ³•æå‡åˆ†é…æ•ˆç‡ æ± åŒ–åŠŸèƒ½çš„å¼€å¯ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„ç³»ç»Ÿç¯å¢ƒå˜é‡æ¥è®¾ç½®ï¼š 1-Dio.netty.allocator.type=&#123;unpooled|pooled&#125; # VM å‚æ•° 4.1 ä»¥åï¼Œé Android å¹³å°é»˜è®¤å¯ç”¨æ± åŒ–å®ç°ï¼ŒAndroid å¹³å°å¯ç”¨éæ± åŒ–å®ç° 4.1 ä¹‹å‰ï¼Œæ± åŒ–åŠŸèƒ½è¿˜ä¸æˆç†Ÿï¼Œé»˜è®¤æ˜¯éæ± åŒ–å®ç° è¯»å†™æ“ä½œByteBuf ç”±å››éƒ¨åˆ†ç»„æˆï¼Œæœ€å¼€å§‹è¯»å†™æŒ‡é’ˆï¼ˆåŒæŒ‡é’ˆï¼‰éƒ½åœ¨ 0 ä½ç½® å†™å…¥æ–¹æ³•ï¼š æ–¹æ³•å è¯´æ˜ å¤‡æ³¨ writeBoolean(boolean value) å†™å…¥ boolean å€¼ ç”¨ä¸€å­—èŠ‚ 01|00 ä»£è¡¨ true|false writeByte(int value) å†™å…¥ byte å€¼ writeInt(int value) å†™å…¥ int å€¼ Big Endianï¼Œå³ 0x250ï¼Œå†™å…¥å 00 00 02 50 writeIntLE(int value) å†™å…¥ int å€¼ Little Endianï¼Œå³ 0x250ï¼Œå†™å…¥å 50 02 00 00 writeBytes(ByteBuf src) å†™å…¥ ByteBuf writeBytes(byte[] src) å†™å…¥ byte[] writeBytes(ByteBuffer src) å†™å…¥ NIO çš„ ByteBuffer int writeCharSequence(CharSequence s, Charset c) å†™å…¥å­—ç¬¦ä¸² è¿™äº›æ–¹æ³•çš„æœªæŒ‡æ˜è¿”å›å€¼çš„ï¼Œå…¶è¿”å›å€¼éƒ½æ˜¯ ByteBufï¼Œæ„å‘³ç€å¯ä»¥é“¾å¼è°ƒç”¨ å†™å…¥å‡ ä½å†™æŒ‡é’ˆåç§»å‡ ä½ï¼ŒæŒ‡å‘å¯ä»¥å†™å…¥çš„ä½ç½® ç½‘ç»œä¼ è¾“ï¼Œé»˜è®¤ä¹ æƒ¯æ˜¯ Big Endian æ‰©å®¹ï¼šå†™å…¥æ•°æ®æ—¶ï¼Œå®¹é‡ä¸å¤Ÿäº†ï¼ˆåˆå§‹å®¹é‡æ˜¯ 10ï¼‰ï¼Œè¿™æ—¶ä¼šå¼•å‘æ‰©å®¹ å¦‚æœå†™å…¥åæ•°æ®å¤§å°æœªè¶…è¿‡ 512ï¼Œåˆ™é€‰æ‹©ä¸‹ä¸€ä¸ª 16 çš„æ•´æ•°å€ï¼Œä¾‹å¦‚å†™å…¥åå¤§å°ä¸º 12 ï¼Œåˆ™æ‰©å®¹å capacity æ˜¯ 16 å¦‚æœå†™å…¥åæ•°æ®å¤§å°è¶…è¿‡ 512ï¼Œåˆ™é€‰æ‹©ä¸‹ä¸€ä¸ª 2^nï¼Œä¾‹å¦‚å†™å…¥åå¤§å°ä¸º 513ï¼Œåˆ™æ‰©å®¹å capacity æ˜¯ 2^10 &#x3D; 1024ï¼ˆ2^9&#x3D;512 ä¸å¤Ÿï¼‰ æ‰©å®¹ä¸èƒ½è¶…è¿‡ max capacity ä¼šæŠ¥é”™ è¯»å–æ–¹æ³•ï¼š byte readByte()ï¼šè¯»å–ä¸€ä¸ªå­—èŠ‚ï¼Œè¯»æŒ‡é’ˆåç§» byte getByte(int index)ï¼šè¯»å–æŒ‡å®šç´¢å¼•ä½ç½®çš„å­—èŠ‚ï¼Œè¯»æŒ‡é’ˆä¸åŠ¨ ByteBuf markReaderIndex()ï¼šæ ‡è®°è¯»æ•°æ®çš„ä½ç½® ByteBuf resetReaderIndex()ï¼šé‡ç½®åˆ°æ ‡è®°ä½ç½®ï¼Œå¯ä»¥é‡å¤è¯»å–æ ‡è®°ä½ç½®å‘åçš„æ•°æ® å†…å­˜é‡Šæ”¾Netty ä¸­ä¸‰ç§å†…å­˜çš„å›æ”¶ï¼š UnpooledHeapByteBuf ä½¿ç”¨çš„æ˜¯ JVM å†…å­˜ï¼Œåªéœ€ç­‰ GC å›æ”¶å†…å­˜ UnpooledDirectByteBuf ä½¿ç”¨çš„å°±æ˜¯ç›´æ¥å†…å­˜äº†ï¼Œéœ€è¦ç‰¹æ®Šçš„æ–¹æ³•æ¥å›æ”¶å†…å­˜ PooledByteBuf å’Œå­ç±»ä½¿ç”¨äº†æ± åŒ–æœºåˆ¶ï¼Œéœ€è¦æ›´å¤æ‚çš„è§„åˆ™æ¥å›æ”¶å†…å­˜ Netty é‡‡ç”¨äº†å¼•ç”¨è®¡æ•°æ³•æ¥æ§åˆ¶å›æ”¶å†…å­˜ï¼Œæ¯ä¸ª ByteBuf éƒ½å®ç°äº† ReferenceCounted æ¥å£ï¼Œå›æ”¶çš„è§„åˆ™ï¼š æ¯ä¸ª ByteBuf å¯¹è±¡çš„åˆå§‹è®¡æ•°ä¸º 1 è°ƒç”¨ release æ–¹æ³•è®¡æ•°å‡ 1ï¼Œå¦‚æœè®¡æ•°ä¸º 0ï¼ŒByteBuf å†…å­˜è¢«å›æ”¶ è°ƒç”¨ retain æ–¹æ³•è®¡æ•°åŠ  1ï¼Œè¡¨ç¤ºè°ƒç”¨è€…æ²¡ç”¨å®Œä¹‹å‰ï¼Œå…¶å®ƒ handler å³ä½¿è°ƒç”¨äº† release ä¹Ÿä¸ä¼šé€ æˆå›æ”¶ å½“è®¡æ•°ä¸º 0 æ—¶ï¼Œåº•å±‚å†…å­˜ä¼šè¢«å›æ”¶ï¼Œè¿™æ—¶å³ä½¿ ByteBuf å¯¹è±¡è¿˜åœ¨ï¼Œå…¶å„ä¸ªæ–¹æ³•å‡æ— æ³•æ­£å¸¸ä½¿ç”¨ 123456ByteBuf buf = .ByteBufAllocator.DEFAULT.buffer(10)try &#123; // é€»è¾‘å¤„ç†&#125; finally &#123; buf.release();&#125; Pipeline çš„å­˜åœ¨ï¼Œéœ€è¦å°† ByteBuf ä¼ é€’ç»™ä¸‹ä¸€ä¸ª ChannelHandlerï¼Œå¦‚æœåœ¨ finally ä¸­ release äº†ï¼Œå°±å¤±å»äº†ä¼ é€’æ€§ï¼Œå¤„ç†è§„åˆ™ï¼š åˆ›å»º ByteBuf æ”¾å…¥ Pipeline å…¥ç«™ ByteBuf å¤„ç†åŸåˆ™ å¯¹åŸå§‹ ByteBuf ä¸åšå¤„ç†ï¼Œè°ƒç”¨ ctx.fireChannelRead(msg) å‘åä¼ é€’ï¼Œè¿™æ—¶æ— é¡» releaseï¼Œåä¹‹ä¸ä¼ é€’éœ€è¦ å°†åŸå§‹ ByteBuf è½¬æ¢ä¸ºå…¶å®ƒç±»å‹çš„ Java å¯¹è±¡ï¼Œè¿™æ—¶ ByteBuf å°±æ²¡ç”¨äº†ï¼Œæ­¤æ—¶å¿…é¡» release å¦‚æœå‡ºç°å¼‚å¸¸ï¼ŒByteBuf æ²¡æœ‰æˆåŠŸä¼ é€’åˆ°ä¸‹ä¸€ä¸ª ChannelHandlerï¼Œå¿…é¡» release å‡è®¾æ¶ˆæ¯ä¸€ç›´å‘åä¼ ï¼Œé‚£ä¹ˆ TailContext ä¼šè´Ÿè´£é‡Šæ”¾æœªå¤„ç†æ¶ˆæ¯ï¼ˆåŸå§‹çš„ ByteBufï¼‰ 123456789101112131415// io.netty.channel.DefaultChannelPipeline#onUnhandledInboundMessage(java.lang.Object)protected void onUnhandledInboundMessage(Object msg) &#123; try &#123; logger.debug(); &#125; finally &#123; ReferenceCountUtil.release(msg); &#125;&#125;// io.netty.util.ReferenceCountUtil#release(java.lang.Object)public static boolean release(Object msg) &#123; if (msg instanceof ReferenceCounted) &#123; return ((ReferenceCounted) msg).release(); &#125; return false;&#125; å‡ºç«™ ByteBuf å¤„ç†åŸåˆ™ å‡ºç«™æ¶ˆæ¯æœ€ç»ˆéƒ½ä¼šè½¬ä¸º ByteBuf è¾“å‡ºï¼Œä¸€ç›´å‘å‰ä¼ ï¼Œç”± HeadContext flush å release ä¸ç¡®å®š ByteBuf è¢«å¼•ç”¨äº†å¤šå°‘æ¬¡ï¼Œä½†åˆå¿…é¡»å½»åº•é‡Šæ”¾ï¼Œå¯ä»¥å¾ªç¯è°ƒç”¨ release ç›´åˆ°è¿”å› true æ‹·è´æ“ä½œé›¶æ‹·è´æ–¹æ³•ï¼š ByteBuf slice(int index, int length)ï¼šå¯¹åŸå§‹ ByteBuf è¿›è¡Œåˆ‡ç‰‡æˆå¤šä¸ª ByteBufï¼Œåˆ‡ç‰‡åçš„ ByteBuf å¹¶æ²¡æœ‰å‘ç”Ÿå†…å­˜å¤åˆ¶ï¼Œå…±ç”¨åŸå§‹ ByteBuf çš„å†…å­˜ï¼Œåˆ‡ç‰‡åçš„ ByteBuf ç»´æŠ¤ç‹¬ç«‹çš„ readï¼Œwrite æŒ‡é’ˆ 12345678910public static void main(String[] args) &#123; ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(10); buf.writeBytes(new byte[]&#123;&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27;, &#x27;e&#x27;, &#x27;f&#x27;, &#x27;g&#x27;, &#x27;h&#x27;, &#x27;i&#x27;, &#x27;j&#x27;&#125;); // åœ¨åˆ‡ç‰‡è¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰å‘ç”Ÿæ•°æ®å¤åˆ¶ ByteBuf f1 = buf.slice(0, 5); f1.retain(); ByteBuf f2 = buf.slice(5, 5); f2.retain(); // å¯¹ f1 è¿›è¡Œç›¸å…³çš„æ“ä½œä¹Ÿä¼šä½“ç°åœ¨ buf ä¸Š&#125; ByteBuf duplicate()ï¼šæˆªå–åŸå§‹ ByteBuf æ‰€æœ‰å†…å®¹ï¼Œå¹¶ä¸”æ²¡æœ‰ max capacity çš„é™åˆ¶ï¼Œä¹Ÿæ˜¯ä¸åŸå§‹ ByteBuf ä½¿ç”¨åŒä¸€å—åº•å±‚å†…å­˜ï¼Œåªæ˜¯è¯»å†™æŒ‡é’ˆæ˜¯ç‹¬ç«‹çš„ CompositeByteBuf addComponents(boolean increaseWriterIndex, ByteBuf... buffers)ï¼šåˆå¹¶å¤šä¸ª ByteBuf 1234567891011public static void main(String[] args) &#123; ByteBuf buf1 = ByteBufAllocator.DEFAULT.buffer(); buf1.writeBytes(new byte[]&#123;1, 2, 3, 4, 5&#125;); ByteBuf buf2 = ByteBufAllocator.DEFAULT.buffer(); buf1.writeBytes(new byte[]&#123;6, 7, 8, 9, 10&#125;); CompositeByteBuf buf = ByteBufAllocator.DEFAULT.compositeBuffer(); // true è¡¨ç¤ºå¢åŠ æ–°çš„ ByteBuf è‡ªåŠ¨é€’å¢ write index, å¦åˆ™ write index ä¼šå§‹ç»ˆä¸º 0 buf.addComponents(true, buf1, buf2);&#125; CompositeByteBuf æ˜¯ä¸€ä¸ªç»„åˆçš„ ByteBufï¼Œå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª Component æ•°ç»„ï¼Œæ¯ä¸ª Component ç®¡ç†ä¸€ä¸ª ByteBufï¼Œè®°å½•äº†è¿™ä¸ª ByteBuf ç›¸å¯¹äºæ•´ä½“åç§»é‡ç­‰ä¿¡æ¯ï¼Œä»£è¡¨ç€æ•´ä½“ä¸­æŸä¸€æ®µçš„æ•°æ® ä¼˜ç‚¹ï¼šå¯¹å¤–æ˜¯ä¸€ä¸ªè™šæ‹Ÿè§†å›¾ï¼Œç»„åˆè¿™äº› ByteBuf ä¸ä¼šäº§ç”Ÿå†…å­˜å¤åˆ¶ ç¼ºç‚¹ï¼šå¤æ‚äº†å¾ˆå¤šï¼Œå¤šæ¬¡æ“ä½œä¼šå¸¦æ¥æ€§èƒ½çš„æŸè€— æ·±æ‹·è´ï¼š ByteBuf copy()ï¼šå°†åº•å±‚å†…å­˜æ•°æ®è¿›è¡Œæ·±æ‹·è´ï¼Œå› æ­¤æ— è®ºè¯»å†™ï¼Œéƒ½ä¸åŸå§‹ ByteBuf æ— å…³ æ± åŒ–ç›¸å…³ï¼š Unpooled æ˜¯ä¸€ä¸ªå·¥å…·ç±»ï¼Œæä¾›äº†éæ± åŒ–çš„ ByteBuf åˆ›å»ºã€ç»„åˆã€å¤åˆ¶ç­‰æ“ä½œ 1234567ByteBuf buf1 = ByteBufAllocator.DEFAULT.buffer(5);buf1.writeBytes(new byte[]&#123;1, 2, 3, 4, 5&#125;);ByteBuf buf2 = ByteBufAllocator.DEFAULT.buffer(5);buf2.writeBytes(new byte[]&#123;6, 7, 8, 9, 10&#125;);// å½“åŒ…è£… ByteBuf ä¸ªæ•°è¶…è¿‡ä¸€ä¸ªæ—¶, åº•å±‚ä½¿ç”¨äº† CompositeByteBufï¼Œé›¶æ‹·è´æ€æƒ³ByteBuf buf = Unpooled.wrappedBuffer(buf1, buf2); ç²˜åŒ…åŠåŒ…ç°è±¡æ¼”ç¤ºåœ¨ TCP ä¼ è¾“ä¸­ï¼Œå®¢æˆ·ç«¯å‘é€æ¶ˆæ¯æ—¶ï¼Œå®é™…ä¸Šæ˜¯å°†æ•°æ®å†™å…¥ TCP çš„ç¼“å­˜ï¼Œæ­¤æ—¶æ•°æ®çš„å¤§å°å’Œç¼“å­˜çš„å¤§å°å°±ä¼šé€ æˆç²˜åŒ…å’ŒåŠåŒ… å½“æ•°æ®è¶…è¿‡ TCP ç¼“å­˜å®¹é‡æ—¶ï¼Œå°±ä¼šè¢«æ‹†åˆ†æˆå¤šä¸ªåŒ…ï¼Œé€šè¿‡ Socket å¤šæ¬¡å‘é€åˆ°æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯æ¯æ¬¡ä»ç¼“å­˜ä¸­å–æ•°æ®ï¼Œäº§ç”ŸåŠåŒ…é—®é¢˜ å½“æ•°æ®å°äº TCP ç¼“å­˜å®¹é‡æ—¶ï¼Œç¼“å­˜ä¸­å¯ä»¥å­˜æ”¾å¤šä¸ªåŒ…ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¸€æ¬¡é€šä¿¡å°±å¯èƒ½ä¼ é€’å¤šä¸ªåŒ…ï¼Œè¿™æ—¶å€™æœåŠ¡ç«¯å°±å¯èƒ½ä¸€æ¬¡è¯»å–å¤šä¸ªåŒ…ï¼Œäº§ç”Ÿç²˜åŒ…çš„é—®é¢˜ ä»£ç æ¼”ç¤ºï¼š å®¢æˆ·ç«¯ä»£ç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445public class HelloWorldClient &#123; public static void main(String[] args) &#123; send(); &#125; private static void send() &#123; NioEventLoopGroup worker = new NioEventLoopGroup(); try &#123; Bootstrap bootstrap = new Bootstrap(); bootstrap.channel(NioSocketChannel.class); bootstrap.group(worker); bootstrap.handler(new ChannelInitializer&lt;SocketChannel&gt;() &#123; @Override protected void initChannel(SocketChannel ch) throws Exception &#123; ch.pipeline().addLast(new ChannelInboundHandlerAdapter() &#123; // ã€åœ¨è¿æ¥ channel å»ºç«‹æˆåŠŸåï¼Œä¼šè§¦å‘ active æ–¹æ³•ã€‘ @Override public void channelActive(ChannelHandlerContext ctx) throws Exception &#123; // å‘é€å†…å®¹éšæœºçš„æ•°æ®åŒ… Random r = new Random(); char c = &#x27;0&#x27;; ByteBuf buf = ctx.alloc().buffer(); for (int i = 0; i &lt; 10; i++) &#123; byte[] bytes = new byte[10]; for (int j = 0; j &lt; r.nextInt(9) + 1; j++) &#123; bytes[j] = (byte) c; &#125; c++; buf.writeBytes(bytes); &#125; ctx.writeAndFlush(buf); &#125; &#125;); &#125; &#125;); ChannelFuture channelFuture = bootstrap.connect(&quot;127.0.0.1&quot;, 8080).sync(); channelFuture.channel().closeFuture().sync(); &#125; catch (InterruptedException e) &#123; log.error(&quot;client error&quot;, e); &#125; finally &#123; worker.shutdownGracefully(); &#125; &#125;&#125; æœåŠ¡å™¨ä»£ç ï¼š 123456789101112131415161718192021222324252627282930313233public class HelloWorldServer &#123; public static void main(String[] args) &#123; NioEventLoopGroup boss = new NioEventLoopGroup(1); NioEventLoopGroup worker = new NioEventLoopGroup(); try &#123; ServerBootstrap serverBootstrap = new ServerBootstrap(); serverBootstrap.channel(NioServerSocketChannel.class); // è°ƒæ•´ç³»ç»Ÿçš„æ¥å—ç¼“å†²åŒºã€æ»‘åŠ¨çª—å£ã€‘ //serverBootstrap.option(ChannelOption.SO_RCVBUF, 10); // è°ƒæ•´ netty çš„æ¥å—ç¼“å†²åŒºï¼ˆByteBufï¼‰ //serverBootstrap.childOption(ChannelOption.RCVBUF_ALLOCATOR, // new AdaptiveRecvByteBufAllocator(16, 16, 16)); serverBootstrap.group(boss, worker); serverBootstrap.childHandler(new ChannelInitializer&lt;SocketChannel&gt;() &#123; @Override protected void initChannel(SocketChannel ch) throws Exception &#123; // ã€è¿™é‡Œå¯ä»¥æ·»åŠ è§£ç å™¨ã€‘ // LoggingHandler ç”¨æ¥æ‰“å°æ¶ˆæ¯ ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG)); &#125; &#125;); ChannelFuture channelFuture = serverBootstrap.bind(8080); channelFuture.sync(); channelFuture.channel().closeFuture().sync(); &#125; catch (InterruptedException e) &#123; log.error(&quot;server error&quot;, e); &#125; finally &#123; boss.shutdownGracefully(); worker.shutdownGracefully(); log.debug(&quot;stop&quot;); &#125; &#125;&#125; ç²˜åŒ…æ•ˆæœå±•ç¤ºï¼š 12345678910111209:57:27.140 [nioEventLoopGroup-3-1] DEBUG io.netty.handler.logging.LoggingHandler - [id: 0xddbaaef6, L:/127.0.0.1:8080 - R:/127.0.0.1:8701] READ: 100B // è¯»äº† 100 å­—èŠ‚ï¼Œå‘ç”Ÿç²˜åŒ… +-------------------------------------------------+ | 0 1 2 3 4 5 6 7 8 9 a b c d e f |+--------+-------------------------------------------------+----------------+|00000000| 30 30 30 30 30 00 00 00 00 00 31 00 00 00 00 00 |00000.....1.....||00000010| 00 00 00 00 32 32 32 32 00 00 00 00 00 00 33 00 |....2222......3.||00000020| 00 00 00 00 00 00 00 00 34 34 00 00 00 00 00 00 |........44......||00000030| 00 00 35 35 35 35 00 00 00 00 00 00 36 36 36 00 |..5555......666.||00000040| 00 00 00 00 00 00 37 37 37 37 00 00 00 00 00 00 |......7777......||00000050| 38 38 38 38 38 00 00 00 00 00 39 39 00 00 00 00 |88888.....99....||00000060| 00 00 00 00 |.... |+--------+-------------------------------------------------+----------------+ è§£å†³æ–¹æ³•ï¼šé€šè¿‡è°ƒæ•´ç³»ç»Ÿçš„æ¥å—ç¼“å†²åŒºçš„æ»‘åŠ¨çª—å£å’Œ Netty çš„æ¥å—ç¼“å†²åŒºä¿è¯æ¯æ¡åŒ…åªå«æœ‰ä¸€æ¡æ•°æ®ï¼Œæ»‘åŠ¨çª—å£çš„å¤§å°ä»…å†³å®šäº† Netty è¯»å–çš„æœ€å°å•ä½ï¼Œå®é™…æ¯æ¬¡è¯»å–çš„ä¸€èˆ¬æ˜¯å®ƒçš„æ•´æ•°å€ è§£å†³æ–¹æ¡ˆçŸ­è¿æ¥å‘ä¸€ä¸ªåŒ…å»ºç«‹ä¸€æ¬¡è¿æ¥ï¼Œè¿™æ ·è¿æ¥å»ºç«‹åˆ°è¿æ¥æ–­å¼€ä¹‹é—´å°±æ˜¯æ¶ˆæ¯çš„è¾¹ç•Œï¼Œç¼ºç‚¹å°±æ˜¯æ•ˆç‡å¾ˆä½ å®¢æˆ·ç«¯ä»£ç æ”¹é€ ï¼š 12345678public class HelloWorldClient &#123; public static void main(String[] args) &#123; // åˆ† 10 æ¬¡å‘é€ for (int i = 0; i &lt; 10; i++) &#123; send(); &#125; &#125;&#125; å›ºå®šé•¿åº¦æœåŠ¡å™¨ç«¯åŠ å…¥å®šé•¿è§£ç å™¨ï¼Œæ¯ä¸€æ¡æ¶ˆæ¯é‡‡ç”¨å›ºå®šé•¿åº¦ã€‚å¦‚æœæ˜¯åŠåŒ…æ¶ˆæ¯ï¼Œä¼šç¼“å­˜åŠåŒ…æ¶ˆæ¯å¹¶ç­‰å¾…ä¸‹ä¸ªåŒ…åˆ°è¾¾ä¹‹åè¿›è¡Œæ‹¼åŒ…åˆå¹¶ï¼Œç›´åˆ°è¯»å–ä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯åŒ…ï¼›å¦‚æœæ˜¯ç²˜åŒ…æ¶ˆæ¯ï¼Œç©ºä½™çš„ä½ç½®ä¼šè¿›è¡Œè¡¥ 0ï¼Œä¼šæµªè´¹ç©ºé—´ 12345678serverBootstrap.childHandler(new ChannelInitializer&lt;SocketChannel&gt;() &#123; @Override protected void initChannel(SocketChannel ch) throws Exception &#123; ch.pipeline().addLast(new FixedLengthFrameDecoder(10)); // LoggingHandler ç”¨æ¥æ‰“å°æ¶ˆæ¯ ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG)); &#125;&#125;); 12345678910111210:29:06.522 [nioEventLoopGroup-3-1] DEBUG io.netty.handler.logging.LoggingHandler - [id: 0x38a70fbf, L:/127.0.0.1:8080 - R:/127.0.0.1:10144] READ: 10B +-------------------------------------------------+ | 0 1 2 3 4 5 6 7 8 9 a b c d e f |+--------+-------------------------------------------------+----------------+|00000000| 31 31 00 00 00 00 00 00 00 00 |11........ |+--------+-------------------------------------------------+----------------+10:29:06.522 [nioEventLoopGroup-3-1] DEBUG io.netty.handler.logging.LoggingHandler - [id: 0x38a70fbf, L:/127.0.0.1:8080 - R:/127.0.0.1:10144] READ: 10B +-------------------------------------------------+ | 0 1 2 3 4 5 6 7 8 9 a b c d e f |+--------+-------------------------------------------------+----------------+|00000000| 32 32 32 32 32 32 00 00 00 00 |222222.... |+--------+-------------------------------------------------+----------------+ åˆ†éš”ç¬¦æœåŠ¡ç«¯åŠ å…¥è¡Œè§£ç å™¨ï¼Œé»˜è®¤ä»¥ \\n æˆ– \\r\\n ä½œä¸ºåˆ†éš”ç¬¦ï¼Œå¦‚æœè¶…å‡ºæŒ‡å®šé•¿åº¦ä»æœªå‡ºç°åˆ†éš”ç¬¦ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼š 1234567serverBootstrap.childHandler(new ChannelInitializer&lt;SocketChannel&gt;() &#123; @Override protected void initChannel(SocketChannel ch) throws Exception &#123; ch.pipeline().addLast(new FixedLengthFrameDecoder(8)); ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG)); &#125;&#125;); å®¢æˆ·ç«¯åœ¨æ¯æ¡æ¶ˆæ¯ä¹‹åï¼ŒåŠ å…¥ \\n åˆ†éš”ç¬¦ï¼š 1234567891011121314public void channelActive(ChannelHandlerContext ctx) throws Exception &#123; Random r = new Random(); char c = &#x27;a&#x27;; ByteBuf buffer = ctx.alloc().buffer(); for (int i = 0; i &lt; 10; i++) &#123; for (int j = 1; j &lt;= r.nextInt(16)+1; j++) &#123; buffer.writeByte((byte) c); &#125; // 10 ä»£è¡¨ &#x27;\\n&#x27; buffer.writeByte(10); c++; &#125; ctx.writeAndFlush(buffer);&#125; é¢„è®¾é•¿åº¦LengthFieldBasedFrameDecoder è§£ç å™¨è‡ªå®šä¹‰é•¿åº¦è§£å†³ TCP ç²˜åŒ…é»åŒ…é—®é¢˜ 12345int maxFrameLength // æ•°æ®æœ€å¤§é•¿åº¦int lengthFieldOffset // é•¿åº¦å­—æ®µåç§»é‡ï¼Œä»ç¬¬å‡ ä¸ªå­—èŠ‚å¼€å§‹æ˜¯å†…å®¹çš„é•¿åº¦å­—æ®µint lengthFieldLength // é•¿åº¦å­—æ®µæœ¬èº«çš„é•¿åº¦int lengthAdjustment // é•¿åº¦å­—æ®µä¸ºåŸºå‡†ï¼Œå‡ ä¸ªå­—èŠ‚åæ‰æ˜¯å†…å®¹int initialBytesToStrip // ä»å¤´å¼€å§‹å‰¥ç¦»å‡ ä¸ªå­—èŠ‚è§£ç åæ˜¾ç¤º 12345678910lengthFieldOffset = 1 (= the length of HDR1)lengthFieldLength = 2lengthAdjustment = 1 (= the length of HDR2)initialBytesToStrip = 3 (= the length of HDR1 + LEN)BEFORE DECODE (16 bytes) AFTER DECODE (13 bytes)//è§£ç +------+--------+------+----------------+ +------+----------------+| HDR1 | Length | HDR2 | Actual Content |-----&gt;| HDR2 | Actual Content || 0xCA | 0x000C | 0xFE | &quot;HELLO, WORLD&quot; | | 0xFE | &quot;HELLO, WORLD&quot; |+------+--------+------+----------------+ +------+----------------+ ä»£ç å®ç°ï¼š 123456789101112131415161718192021222324public class LengthFieldDecoderDemo &#123; public static void main(String[] args) &#123; EmbeddedChannel channel = new EmbeddedChannel( // int å  4 å­—èŠ‚ï¼Œç‰ˆæœ¬å·ä¸€ä¸ªå­—èŠ‚ new LengthFieldBasedFrameDecoder(1024, 0, 4, 1,5), new LoggingHandler(LogLevel.DEBUG) ); // 4 ä¸ªå­—èŠ‚çš„å†…å®¹é•¿åº¦ï¼Œ å®é™…å†…å®¹ ByteBuf buffer = ByteBufAllocator.DEFAULT.buffer(); send(buffer, &quot;Hello, world&quot;); send(buffer, &quot;Hi!&quot;); // å†™å‡ºç¼“å­˜ channel.writeInbound(buffer); &#125; // å†™å…¥ç¼“å­˜ private static void send(ByteBuf buffer, String content) &#123; byte[] bytes = content.getBytes(); // å®é™…å†…å®¹ int length = bytes.length; // å®é™…å†…å®¹é•¿åº¦ buffer.writeInt(length); buffer.writeByte(1); // è¡¨ç¤ºç‰ˆæœ¬å· buffer.writeBytes(bytes); &#125;&#125; 12345678910111210:49:59.344 [main] DEBUG io.netty.handler.logging.LoggingHandler - [id: 0xembedded, L:embedded - R:embedded] READ: 12B +-------------------------------------------------+ | 0 1 2 3 4 5 6 7 8 9 a b c d e f |+--------+-------------------------------------------------+----------------+|00000000| 48 65 6c 6c 6f 2c 20 77 6f 72 6c 64 |Hello, world |+--------+-------------------------------------------------+----------------+10:49:59.344 [main] DEBUG io.netty.handler.logging.LoggingHandler - [id: 0xembedded, L:embedded - R:embedded] READ: 3B +-------------------------------------------------+ | 0 1 2 3 4 5 6 7 8 9 a b c d e f |+--------+-------------------------------------------------+----------------+|00000000| 48 69 21 |Hi! |+--------+-------------------------------------------------+----------------+ åè®®è®¾è®¡HTTPè®¿é—® URLï¼šhttp://localhost:8080/ 123456789101112131415161718192021222324252627282930313233343536373839404142434445public class HttpDemo &#123; public static void main(String[] args) &#123; NioEventLoopGroup boss = new NioEventLoopGroup(); NioEventLoopGroup worker = new NioEventLoopGroup(); try &#123; ServerBootstrap serverBootstrap = new ServerBootstrap(); serverBootstrap.channel(NioServerSocketChannel.class); serverBootstrap.group(boss, worker); serverBootstrap.childHandler(new ChannelInitializer&lt;SocketChannel&gt;() &#123; @Override protected void initChannel(SocketChannel ch) throws Exception &#123; ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG)); ch.pipeline().addLast(new HttpServerCodec()); // åªé’ˆå¯¹æŸä¸€ç§ç±»å‹çš„è¯·æ±‚å¤„ç†ï¼Œæ­¤å¤„é’ˆå¯¹ HttpRequest ch.pipeline().addLast(new SimpleChannelInboundHandler&lt;HttpRequest&gt;() &#123; @Override protected void channelRead0(ChannelHandlerContext ctx, HttpRequest msg) &#123; // è·å–è¯·æ±‚ log.debug(msg.uri()); // è¿”å›å“åº” DefaultFullHttpResponse response = new DefaultFullHttpResponse( msg.protocolVersion(), HttpResponseStatus.OK); byte[] bytes = &quot;&lt;h1&gt;Hello, world!&lt;/h1&gt;&quot;.getBytes(); response.headers().setInt(CONTENT_LENGTH, bytes.length); response.content().writeBytes(bytes); // å†™å›å“åº” ctx.writeAndFlush(response); &#125; &#125;); &#125; &#125;); ChannelFuture channelFuture = serverBootstrap.bind(8080).sync(); channelFuture.channel().closeFuture().sync(); &#125; catch (InterruptedException e) &#123; log.error(&quot;n3.server error&quot;, e); &#125; finally &#123; boss.shutdownGracefully(); worker.shutdownGracefully(); &#125; &#125;&#125; è‡ªå®šä¹‰å¤„ç†å™¨ä»£ç ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647@Slf4jpublic class MessageCodec extends ByteToMessageCodec&lt;Message&gt; &#123; // ç¼–ç  @Override public void encode(ChannelHandlerContext ctx, Message msg, ByteBuf out) throws Exception &#123; // 4 å­—èŠ‚çš„é­”æ•° out.writeBytes(new byte[]&#123;1, 2, 3, 4&#125;); // 1 å­—èŠ‚çš„ç‰ˆæœ¬, out.writeByte(1); // 1 å­—èŠ‚çš„åºåˆ—åŒ–æ–¹å¼ jdk 0 , json 1 out.writeByte(0); // 1 å­—èŠ‚çš„æŒ‡ä»¤ç±»å‹ out.writeByte(msg.getMessageType()); // 4 ä¸ªå­—èŠ‚ out.writeInt(msg.getSequenceId()); // æ— æ„ä¹‰ï¼Œå¯¹é½å¡«å……, 1 å­—èŠ‚ out.writeByte(0xff); // è·å–å†…å®¹çš„å­—èŠ‚æ•°ç»„ï¼Œmsg å¯¹è±¡åºåˆ—åŒ– ByteArrayOutputStream bos = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(bos); oos.writeObject(msg); byte[] bytes = bos.toByteArray(); // é•¿åº¦ out.writeInt(bytes.length); // å†™å…¥å†…å®¹ out.writeBytes(bytes); &#125; // è§£ç  @Override protected void decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out) throws Exception &#123; int magicNum = in.readInt(); byte version = in.readByte(); byte serializerType = in.readByte(); byte messageType = in.readByte(); int sequenceId = in.readInt(); in.readByte(); int length = in.readInt(); byte[] bytes = new byte[length]; in.readBytes(bytes, 0, length); ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(bytes)); Message message = (Message) ois.readObject(); log.debug(&quot;&#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;&quot;, magicNum, version, serializerType, messageType, sequenceId, length); log.debug(&quot;&#123;&#125;&quot;, message); out.add(message); &#125;&#125; æµ‹è¯•ä»£ç ï¼š 1234567891011121314151617public static void main(String[] args) throws Exception &#123; EmbeddedChannel channel = new EmbeddedChannel(new LoggingHandler(), new MessageCodec()); // encode LoginRequestMessage message = new LoginRequestMessage(&quot;zhangsan&quot;, &quot;123&quot;); channel.writeOutbound(message); // decode ByteBuf buf = ByteBufAllocator.DEFAULT.buffer(); new MessageCodec().encode(null, message, buf); // å…¥ç«™ channel.writeInbound(buf);&#125;public class LoginRequestMessage extends Message &#123; private String username; private String password; // set + get &#125; Sharable@Sharable æ³¨è§£çš„æ·»åŠ æ—¶æœºï¼š å½“ handler ä¸ä¿å­˜çŠ¶æ€æ—¶ï¼Œå°±å¯ä»¥å®‰å…¨åœ°åœ¨å¤šçº¿ç¨‹ä¸‹è¢«å…±äº« å¯¹äºç¼–è§£ç å™¨ç±»ä¸èƒ½ç»§æ‰¿ ByteToMessageCodec æˆ– CombinedChannelDuplexHandlerï¼Œå®ƒä»¬çš„æ„é€ æ–¹æ³•å¯¹ @Sharable æœ‰é™åˆ¶ 12345protected ByteToMessageCodec(boolean preferDirect) &#123; ensureNotSharable(); outboundMsgMatcher = TypeParameterMatcher.find(this, ByteToMessageCodec.class, &quot;I&quot;); encoder = new Encoder(preferDirect);&#125; 123456protected void ensureNotSharable() &#123; // å¦‚æœç±»ä¸Šæœ‰è¯¥æ³¨è§£ if (isSharable()) &#123; throw new IllegalStateException(); &#125;&#125; å¦‚æœèƒ½ç¡®ä¿ç¼–è§£ç å™¨ä¸ä¼šä¿å­˜çŠ¶æ€ï¼Œå¯ä»¥ç»§æ‰¿ MessageToMessageCodec çˆ¶ç±» 123456789101112131415161718@Slf4j@ChannelHandler.Sharable// å¿…é¡»å’Œ LengthFieldBasedFrameDecoder ä¸€èµ·ä½¿ç”¨ï¼Œç¡®ä¿æ¥åˆ°çš„ ByteBuf æ¶ˆæ¯æ˜¯å®Œæ•´çš„public class MessageCodecSharable extends MessageToMessageCodec&lt;ByteBuf, Message&gt; &#123; @Override protected void encode(ChannelHandlerContext ctx, Message msg, List&lt;Object&gt; outList) throws Exception &#123; ByteBuf out = ctx.alloc().buffer(); // 4 å­—èŠ‚çš„é­”æ•° out.writeBytes(new byte[]&#123;1, 2, 3, 4&#125;); // .... outList.add(out); &#125; @Override protected void decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out) throws Exception &#123; //.... &#125;&#125; åœºæ™¯ä¼˜åŒ–ç©ºé—²æ£€æµ‹è¿æ¥å‡æ­»è¿æ¥å‡æ­»å°±æ˜¯å®¢æˆ·ç«¯æ•°æ®å‘ä¸å‡ºå»ï¼ŒæœåŠ¡ç«¯ä¹Ÿä¸€ç›´æ”¶ä¸åˆ°æ•°æ®ï¼Œä¿æŒè¿™ç§çŠ¶æ€ï¼Œå‡æ­»çš„è¿æ¥å ç”¨çš„èµ„æºä¸èƒ½è‡ªåŠ¨é‡Šæ”¾ï¼Œè€Œä¸”å‘å‡æ­»è¿æ¥å‘é€æ•°æ®ï¼Œå¾—åˆ°çš„åé¦ˆæ˜¯å‘é€è¶…æ—¶ è§£å†³æ–¹æ¡ˆï¼šæ¯éš”ä¸€æ®µæ—¶é—´å°±æ£€æŸ¥è¿™æ®µæ—¶é—´å†…æ˜¯å¦æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ•°æ®ï¼Œæ²¡æœ‰å°±å¯ä»¥åˆ¤å®šä¸ºè¿æ¥å‡æ­» IdleStateHandler æ˜¯ Netty æä¾›çš„å¤„ç†ç©ºé—²çŠ¶æ€çš„å¤„ç†å™¨ï¼Œç”¨æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯è¯»ç©ºé—²æ—¶é—´æˆ–å†™ç©ºé—²æ—¶é—´è¿‡é•¿ å‚æ•°ä¸€ long readerIdleTimeï¼šè¯»ç©ºé—²ï¼Œè¡¨ç¤ºå¤šé•¿æ—¶é—´æ²¡æœ‰è¯» å‚æ•°äºŒ long writerIdleTimeï¼šå†™ç©ºé—²ï¼Œè¡¨ç¤ºå¤šé•¿æ—¶é—´æ²¡æœ‰å†™ å‚æ•°ä¸‰ long allIdleTimeï¼šè¯»å†™ç©ºé—²ï¼Œè¡¨ç¤ºå¤šé•¿æ—¶é—´æ²¡æœ‰è¯»å†™ 12345678910111213141516171819202122serverBootstrap.childHandler(new ChannelInitializer&lt;SocketChannel&gt;() &#123; @Override protected void initChannel(SocketChannel ch) throws Exception &#123; ch.pipeline().addLast(new LengthFieldBasedFrameDecoder(1024, 12, 4, 0, 0)); ch.pipeline().addLast(new MessageCodec()); // 5s å†…å¦‚æœæ²¡æœ‰æ”¶åˆ° channel çš„æ•°æ®ï¼Œä¼šè§¦å‘ä¸€ä¸ª IdleState#READER_IDLE äº‹ä»¶ï¼Œ ch.pipeline().addLast(new IdleStateHandler(5, 0, 0)); // ChannelDuplexHandler ã€å¯ä»¥åŒæ—¶ä½œä¸ºå…¥ç«™å’Œå‡ºç«™ã€‘å¤„ç†å™¨ ch.pipeline().addLast(new ChannelDuplexHandler() &#123; // ç”¨æ¥è§¦å‘ç‰¹æ®Šäº‹ä»¶ @Override public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception&#123; IdleStateEvent event = (IdleStateEvent) evt; // è§¦å‘äº†è¯»ç©ºé—²äº‹ä»¶ if (event.state() == IdleState.READER_IDLE) &#123; log.debug(&quot;å·²ç» 5s æ²¡æœ‰è¯»åˆ°æ•°æ®äº†&quot;); ctx.channel().close(); &#125; &#125; &#125;); &#125;&#125; å¿ƒè·³æœºåˆ¶å®¢æˆ·ç«¯å®šæ—¶å‘æœåŠ¡å™¨ç«¯å‘é€æ•°æ®ï¼Œæ—¶é—´é—´éš”è¦å°äºæœåŠ¡å™¨å®šä¹‰çš„ç©ºé—²æ£€æµ‹çš„æ—¶é—´é—´éš”ï¼Œå°±èƒ½é˜²æ­¢è¯¯åˆ¤è¿æ¥å‡æ­»ï¼Œè¿™å°±æ˜¯å¿ƒè·³æœºåˆ¶ 12345678910111213141516171819202122bootstrap.handler(new ChannelInitializer&lt;SocketChannel&gt;() &#123; @Override protected void initChannel(SocketChannel ch) throws Exception &#123; ch.pipeline().addLast(new LengthFieldBasedFrameDecoder(1024, 12, 4, 0, 0)); ch.pipeline().addLast(new MessageCodec()); // 3s å†…å¦‚æœæ²¡æœ‰å‘æœåŠ¡å™¨å†™æ•°æ®ï¼Œä¼šè§¦å‘ä¸€ä¸ª IdleState#WRITER_IDLE äº‹ä»¶ ch.pipeline().addLast(new IdleStateHandler(0, 3, 0)); // ChannelDuplexHandler å¯ä»¥åŒæ—¶ä½œä¸ºå…¥ç«™å’Œå‡ºç«™å¤„ç†å™¨ ch.pipeline().addLast(new ChannelDuplexHandler() &#123; // ç”¨æ¥è§¦å‘ç‰¹æ®Šäº‹ä»¶ @Override public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception &#123; IdleStateEvent event = (IdleStateEvent) evt; // è§¦å‘äº†å†™ç©ºé—²äº‹ä»¶ if (event.state() == IdleState.WRITER_IDLE) &#123; // 3s æ²¡æœ‰å†™æ•°æ®äº†ï¼Œã€å‘é€ä¸€ä¸ªå¿ƒè·³åŒ…ã€‘ ctx.writeAndFlush(new PingMessage()); &#125; &#125; &#125;); &#125;&#125; åºåˆ—åŒ–æ™®é€šæ–¹å¼åºåˆ—åŒ–ï¼Œååºåˆ—åŒ–ä¸»è¦ç”¨åœ¨æ¶ˆæ¯æ­£æ–‡çš„è½¬æ¢ä¸Š åºåˆ—åŒ–æ—¶ï¼Œéœ€è¦å°† Java å¯¹è±¡å˜ä¸ºè¦ä¼ è¾“çš„æ•°æ®ï¼ˆå¯ä»¥æ˜¯ byte[]ï¼Œæˆ– json ç­‰ï¼Œæœ€ç»ˆéƒ½éœ€è¦å˜æˆ byte[]ï¼‰ ååºåˆ—åŒ–æ—¶ï¼Œéœ€è¦å°†ä¼ å…¥çš„æ­£æ–‡æ•°æ®è¿˜åŸæˆ Java å¯¹è±¡ï¼Œä¾¿äºå¤„ç† ä»£ç å®ç°ï¼š æŠ½è±¡ä¸€ä¸ª Serializer æ¥å£ 123456public interface Serializer &#123; // ååºåˆ—åŒ–æ–¹æ³• &lt;T&gt; T deserialize(Class&lt;T&gt; clazz, byte[] bytes); // åºåˆ—åŒ–æ–¹æ³• &lt;T&gt; byte[] serialize(T object);&#125; æä¾›ä¸¤ä¸ªå®ç° 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748enum SerializerAlgorithm implements Serializer &#123; // Java å®ç° Java &#123; @Override public &lt;T&gt; T deserialize(Class&lt;T&gt; clazz, byte[] bytes) &#123; try &#123; ObjectInputStream in = new ObjectInputStream(new ByteArrayInputStream(bytes)); Object object = in.readObject(); return (T) object; &#125; catch (IOException | ClassNotFoundException e) &#123; throw new RuntimeException(&quot;SerializerAlgorithm.Java ååºåˆ—åŒ–é”™è¯¯&quot;, e); &#125; &#125; @Override public &lt;T&gt; byte[] serialize(T object) &#123; try &#123; ByteArrayOutputStream out = new ByteArrayOutputStream(); new ObjectOutputStream(out).writeObject(object); return out.toByteArray(); &#125; catch (IOException e) &#123; throw new RuntimeException(&quot;SerializerAlgorithm.Java åºåˆ—åŒ–é”™è¯¯&quot;, e); &#125; &#125; &#125;, // Json å®ç°(å¼•å…¥äº† Gson ä¾èµ–) Json &#123; @Override public &lt;T&gt; T deserialize(Class&lt;T&gt; clazz, byte[] bytes) &#123; return new Gson().fromJson(new String(bytes, StandardCharsets.UTF_8), clazz); &#125; @Override public &lt;T&gt; byte[] serialize(T object) &#123; return new Gson().toJson(object).getBytes(StandardCharsets.UTF_8); &#125; &#125;; // éœ€è¦ä»åè®®çš„å­—èŠ‚ä¸­å¾—åˆ°æ˜¯å“ªç§åºåˆ—åŒ–ç®—æ³• public static SerializerAlgorithm getByInt(int type) &#123; SerializerAlgorithm[] array = SerializerAlgorithm.values(); if (type &lt; 0 || type &gt; array.length - 1) &#123; throw new IllegalArgumentException(&quot;è¶…è¿‡ SerializerAlgorithm èŒƒå›´&quot;); &#125; return array[type]; &#125;&#125; ProtoBufåŸºæœ¬ä»‹ç»Codecï¼ˆç¼–è§£ç å™¨ï¼‰çš„ç»„æˆéƒ¨åˆ†æœ‰ä¸¤ä¸ªï¼šDecoderï¼ˆè§£ç å™¨ï¼‰å’Œ Encoderï¼ˆç¼–ç å™¨ï¼‰ã€‚Encoder è´Ÿè´£æŠŠä¸šåŠ¡æ•°æ®è½¬æ¢æˆå­—èŠ‚ç æ•°æ®ï¼ŒDecoder è´Ÿè´£æŠŠå­—èŠ‚ç æ•°æ®è½¬æ¢æˆä¸šåŠ¡æ•°æ® Protobuf æ˜¯ Google å‘å¸ƒçš„å¼€æºé¡¹ç›®ï¼Œå…¨ç§° Google Protocol Buffers ï¼Œæ˜¯ä¸€ç§è½»ä¾¿é«˜æ•ˆçš„ç»“æ„åŒ–æ•°æ®å­˜å‚¨æ ¼å¼ï¼Œå¯ä»¥ç”¨äºç»“æ„åŒ–æ•°æ®ä¸²è¡ŒåŒ–ï¼Œæˆ–è€…è¯´åºåˆ—åŒ–ã€‚å¾ˆé€‚åˆåšæ•°æ®å­˜å‚¨æˆ– RPCï¼ˆè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ remote procedure callï¼‰æ•°æ®äº¤æ¢æ ¼å¼ã€‚ç›®å‰å¾ˆå¤šå…¬å¸ä» HTTP + Json è½¬å‘ TCP + Protobuf ï¼Œæ•ˆç‡ä¼šæ›´é«˜ Protobuf æ˜¯ä»¥ message çš„æ–¹å¼æ¥ç®¡ç†æ•°æ®ï¼Œæ”¯æŒè·¨å¹³å°ã€è·¨è¯­è¨€ï¼ˆå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯å¯ä»¥æ˜¯ä¸åŒçš„è¯­è¨€ç¼–å†™çš„ï¼‰ï¼Œé«˜æ€§èƒ½ã€é«˜å¯é æ€§ å·¥ä½œè¿‡ç¨‹ï¼šä½¿ç”¨ Protobuf ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆä»£ç ï¼ŒProtobuf æ˜¯å°†ç±»çš„å®šä¹‰ä½¿ç”¨ .proto æ–‡ä»¶è¿›è¡Œæè¿°ï¼Œç„¶åé€šè¿‡ protoc.exe ç¼–è¯‘å™¨æ ¹æ® .proto è‡ªåŠ¨ç”Ÿæˆ .java æ–‡ä»¶ ä»£ç å®ç° å•ä¸ª messageï¼š 1234567syntax = &quot;proto3&quot;; // ç‰ˆæœ¬option java_outer_classname = &quot;StudentPOJO&quot;; // ç”Ÿæˆçš„å¤–éƒ¨ç±»åï¼ŒåŒæ—¶ä¹Ÿæ˜¯æ–‡ä»¶åmessage Student &#123; // åœ¨ StudentPOJO å¤–éƒ¨ç±»ç§ç”Ÿæˆä¸€ä¸ªå†…éƒ¨ç±» Studentï¼Œæ˜¯çœŸæ­£å‘é€çš„ POJO å¯¹è±¡ int32 id = 1; // Student ç±»ä¸­æœ‰ä¸€ä¸ªå±æ€§ï¼šåå­—ä¸º id ç±»å‹ä¸º int32(protobufç±»å‹) ï¼Œ1è¡¨ç¤ºå±æ€§åºå·ï¼Œä¸æ˜¯å€¼ string name = 2;&#125; ç¼–è¯‘ protoc.exe --java_out=.Student.protoï¼ˆcmd çª—å£è¾“å…¥ï¼‰ å°†ç”Ÿæˆçš„ StudentPOJO æ”¾å…¥åˆ°é¡¹ç›®ä½¿ç”¨ Server ç«¯ï¼š 123456789101112new ServerBootstrap() //... .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() &#123; // åˆ›å»ºä¸€ä¸ªé€šé“åˆå§‹åŒ–å¯¹è±¡ // ç»™pipeline è®¾ç½®å¤„ç†å™¨ @Override protected void initChannel(SocketChannel ch) throws Exception &#123; // åœ¨pipelineåŠ å…¥ProtoBufDecoderï¼ŒæŒ‡å®šå¯¹å“ªç§å¯¹è±¡è¿›è¡Œè§£ç  ch.pipeline().addLast(&quot;decoder&quot;, new ProtobufDecoder( StudentPOJO.Student.getDefaultInstance())); ch.pipeline().addLast(new NettyServerHandler()); &#125; &#125;); &#125; Client ç«¯ï¼š 12345678910new Bootstrap().group(group) // è®¾ç½®çº¿ç¨‹ç»„ .channel(NioSocketChannel.class) // è®¾ç½®å®¢æˆ·ç«¯é€šé“çš„å®ç°ç±»(åå°„) .handler(new ChannelInitializer&lt;SocketChannel&gt;() &#123; @Override protected void initChannel(SocketChannel ch) throws Exception &#123; // åœ¨pipelineä¸­åŠ å…¥ ProtoBufEncoder ch.pipeline().addLast(&quot;encoder&quot;, new ProtobufEncoder()); ch.pipeline().addLast(new NettyClientHandler()); // åŠ å…¥è‡ªå®šä¹‰çš„ä¸šåŠ¡å¤„ç†å™¨ &#125; &#125;); å¤šä¸ª messageï¼šProtobuf å¯ä»¥ä½¿ç”¨ message ç®¡ç†å…¶ä»–çš„ messageã€‚å‡è®¾æŸä¸ªé¡¹ç›®éœ€è¦ä¼ è¾“ 20 ä¸ªå¯¹è±¡ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œå®šä¹‰ 20 ä¸ª messageï¼Œæœ€åå†ç”¨ä¸€ä¸ªæ€»çš„ message æ¥å†³å®šåœ¨å®é™…ä¼ è¾“æ—¶çœŸæ­£éœ€è¦ä¼ è¾“å“ªä¸€ä¸ªå¯¹è±¡ 12345678910111213141516171819202122232425262728293031323334syntax = &quot;proto3&quot;;option optimize_for = SPEED; // åŠ å¿«è§£æoption java_package=&quot;com.atguigu.netty.codec2&quot;; // æŒ‡å®šç”Ÿæˆåˆ°å“ªä¸ªåŒ…ä¸‹option java_outer_classname=&quot;MyDataInfo&quot;; // å¤–éƒ¨ç±»å, æ–‡ä»¶åmessage MyMessage &#123; // å®šä¹‰ä¸€ä¸ªæšä¸¾ç±»å‹ï¼ŒDataType å¦‚æœæ˜¯ 0 åˆ™è¡¨ç¤ºä¸€ä¸ª Student å¯¹è±¡å®ä¾‹ï¼ŒDataType è¿™ä¸ªåç§°è‡ªå®šä¹‰ enum DataType &#123; StudentType = 0; //åœ¨ proto3 è¦æ±‚ enum çš„ç¼–å·ä» 0 å¼€å§‹ WorkerType = 1; &#125; // ç”¨ data_type æ¥æ ‡è¯†ä¼ çš„æ˜¯å“ªä¸€ä¸ªæšä¸¾ç±»å‹ï¼Œè¿™é‡Œæ‰çœŸæ­£å¼€å§‹å®šä¹‰ Message çš„æ•°æ®ç±»å‹ DataType data_type = 1; // æ‰€æœ‰åé¢çš„æ•°å­—éƒ½åªæ˜¯ç¼–å·è€Œå·² // oneof å…³é”®å­—ï¼Œè¡¨ç¤ºæ¯æ¬¡æšä¸¾ç±»å‹è¿›è¡Œä¼ è¾“æ—¶ï¼Œé™åˆ¶æœ€å¤šåªèƒ½ä¼ è¾“ä¸€ä¸ªå¯¹è±¡ã€‚ // dataBodyåç§°ä¹Ÿæ˜¯è‡ªå®šä¹‰çš„ // MyMessage é‡Œå‡ºç°çš„ç±»å‹åªæœ‰ä¸¤ä¸ª DataType ç±»å‹ï¼ŒStudent æˆ–è€… Worker ç±»å‹ï¼Œåœ¨çœŸæ­£ä¼ è¾“çš„æ—¶å€™åªä¼šæœ‰ä¸€ä¸ªå‡ºç° oneof dataBody &#123; Student student = 2; //æ³¨æ„è¿™åé¢çš„æ•°å­—ä¹Ÿéƒ½åªæ˜¯ç¼–å·è€Œå·²ï¼Œä¸Šé¢DataType data_type = 1 å äº†ç¬¬ä¸€ä¸ªåºå·äº† Worker worker = 3; &#125;&#125;message Student &#123; int32 id = 1; // Studentç±»çš„å±æ€§ string name = 2; //&#125;message Worker &#123; string name=1; int32 age=2;&#125; ç¼–è¯‘ï¼š Server ç«¯ï¼š 1ch.pipeline().addLast(&quot;decoder&quot;, new ProtobufDecoder(MyDataInfo.MyMessage.getDefaultInstance())); Client ç«¯ï¼š 1pipeline.addLast(&quot;encoder&quot;, new ProtobufEncoder()); é•¿è¿æ¥HTTP åè®®æ˜¯æ— çŠ¶æ€çš„ï¼Œæµè§ˆå™¨å’ŒæœåŠ¡å™¨é—´çš„è¯·æ±‚å“åº”ä¸€æ¬¡ï¼Œä¸‹ä¸€æ¬¡ä¼šé‡æ–°åˆ›å»ºè¿æ¥ã€‚å®ç°åŸºäº WebSocket çš„é•¿è¿æ¥çš„å…¨åŒå·¥çš„äº¤äº’ï¼Œæ”¹å˜ HTTP åè®®å¤šæ¬¡è¯·æ±‚çš„çº¦æŸ å¼€å‘éœ€æ±‚ï¼š å®ç°é•¿è¿æ¥ï¼ŒæœåŠ¡å™¨ä¸æµè§ˆå™¨ç›¸äº’é€šä¿¡å®¢æˆ·ç«¯ æµè§ˆå™¨å’ŒæœåŠ¡å™¨ç«¯ä¼šç›¸äº’æ„ŸçŸ¥ï¼Œæ¯”å¦‚æœåŠ¡å™¨å…³é—­äº†ï¼Œæµè§ˆå™¨ä¼šæ„ŸçŸ¥ï¼ŒåŒæ ·æµè§ˆå™¨å…³é—­äº†ï¼ŒæœåŠ¡å™¨ä¼šæ„ŸçŸ¥ ä»£ç å®ç°ï¼š WebSocketï¼š WebSocket çš„æ•°æ®æ˜¯ä»¥å¸§ï¼ˆframeï¼‰å½¢å¼ä¼ é€’ï¼ŒWebSocketFrame ä¸‹é¢æœ‰å…­ä¸ªå­ç±»ï¼Œä»£è¡¨ä¸åŒçš„å¸§æ ¼å¼ æµè§ˆå™¨è¯·æ±‚ URLï¼šws:&#x2F;&#x2F;localhost:8080&#x2F;xxx 12345678910111213141516171819202122232425262728293031323334353637383940414243public class MyWebSocket &#123; public static void main(String[] args) throws Exception &#123; // åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ç»„ EventLoopGroup bossGroup = new NioEventLoopGroup(1); EventLoopGroup workerGroup = new NioEventLoopGroup(); try &#123; ServerBootstrap serverBootstrap = new ServerBootstrap(); serverBootstrap.group(bossGroup, workerGroup); serverBootstrap.channel(NioServerSocketChannel.class); serverBootstrap.handler(new LoggingHandler(LogLevel.INFO)); serverBootstrap.childHandler(new ChannelInitializer&lt;SocketChannel&gt;() &#123; @Override protected void initChannel(SocketChannel ch) throws Exception &#123; ChannelPipeline pipeline = ch.pipeline(); // åŸºäº http åè®®ï¼Œä½¿ç”¨ http çš„ç¼–ç å’Œè§£ç å™¨ pipeline.addLast(new HttpServerCodec()); // æ˜¯ä»¥å—æ–¹å¼å†™ï¼Œæ·»åŠ  ChunkedWriteHandler å¤„ç†å™¨ pipeline.addLast(new ChunkedWriteHandler()); // http æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ˜¯åˆ†æ®µ, HttpObjectAggregator å°±æ˜¯å¯ä»¥å°†å¤šä¸ªæ®µèšåˆ // è¿™å°±å°±æ˜¯ä¸ºä»€ä¹ˆï¼Œå½“æµè§ˆå™¨å‘é€å¤§é‡æ•°æ®æ—¶ï¼Œå°±ä¼šå‘å‡ºå¤šæ¬¡ http è¯·æ±‚ pipeline.addLast(new HttpObjectAggregator(8192)); // WebSocketServerProtocolHandler æ ¸å¿ƒåŠŸèƒ½æ˜¯ã€å°† http åè®®å‡çº§ä¸º ws åè®®ã€‘ï¼Œä¿æŒé•¿è¿æ¥ pipeline.addLast(new WebSocketServerProtocolHandler(&quot;/hello&quot;)); // è‡ªå®šä¹‰çš„handler ï¼Œå¤„ç†ä¸šåŠ¡é€»è¾‘ pipeline.addLast(new MyTextWebSocketFrameHandler()); &#125; &#125;); // å¯åŠ¨æœåŠ¡å™¨ ChannelFuture channelFuture = serverBootstrap.bind(8080).sync(); channelFuture.channel().closeFuture().sync(); &#125; finally &#123; bossGroup.shutdownGracefully(); workerGroup.shutdownGracefully(); &#125; &#125;&#125; å¤„ç†å™¨ï¼š 12345678910111213141516171819202122232425262728public class MyTextWebSocketFrameHandler extends SimpleChannelInboundHandler&lt;TextWebSocketFrame&gt; &#123; // TextWebSocketFrame ç±»å‹ï¼Œè¡¨ç¤ºä¸€ä¸ªæ–‡æœ¬å¸§(frame) @Override protected void channelRead0(ChannelHandlerContext ctx, TextWebSocketFrame msg) throws Exception &#123; System.out.println(&quot;æœåŠ¡å™¨æ”¶åˆ°æ¶ˆæ¯ &quot; + msg.text()); // å›å¤æ¶ˆæ¯ ctx.writeAndFlush(new TextWebSocketFrame(&quot;æœåŠ¡å™¨æ—¶é—´&quot; + LocalDateTime.now() + &quot; &quot; + msg.text())); &#125; // å½“webå®¢æˆ·ç«¯è¿æ¥åï¼Œ è§¦å‘æ–¹æ³• @Override public void handlerAdded(ChannelHandlerContext ctx) throws Exception &#123; // id è¡¨ç¤ºå”¯ä¸€çš„å€¼ï¼ŒLongText æ˜¯å”¯ä¸€çš„ ShortText ä¸æ˜¯å”¯ä¸€ System.out.println(&quot;handlerAdded è¢«è°ƒç”¨&quot; + ctx.channel().id().asLongText()); System.out.println(&quot;handlerAdded è¢«è°ƒç”¨&quot; + ctx.channel().id().asShortText()); &#125; @Override public void handlerRemoved(ChannelHandlerContext ctx) throws Exception &#123; System.out.println(&quot;handlerRemoved è¢«è°ƒç”¨&quot; + ctx.channel().id().asLongText()); &#125; @Override public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception &#123; System.out.println(&quot;å¼‚å¸¸å‘ç”Ÿ &quot; + cause.getMessage()); ctx.close(); // å…³é—­è¿æ¥ &#125;&#125; HTMLï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;Title&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;script&gt; var socket; // åˆ¤æ–­å½“å‰æµè§ˆå™¨æ˜¯å¦æ”¯æŒwebsocket if(window.WebSocket) &#123; //go on socket = new WebSocket(&quot;ws://localhost:8080/hello&quot;); //ç›¸å½“äºchannelReado, ev æ”¶åˆ°æœåŠ¡å™¨ç«¯å›é€çš„æ¶ˆæ¯ socket.onmessage = function (ev) &#123; var rt = document.getElementById(&quot;responseText&quot;); rt.value = rt.value + &quot;\\n&quot; + ev.data; &#125; //ç›¸å½“äºè¿æ¥å¼€å¯(æ„ŸçŸ¥åˆ°è¿æ¥å¼€å¯) socket.onopen = function (ev) &#123; var rt = document.getElementById(&quot;responseText&quot;); rt.value = &quot;è¿æ¥å¼€å¯äº†..&quot; &#125; //ç›¸å½“äºè¿æ¥å…³é—­(æ„ŸçŸ¥åˆ°è¿æ¥å…³é—­) socket.onclose = function (ev) &#123; var rt = document.getElementById(&quot;responseText&quot;); rt.value = rt.value + &quot;\\n&quot; + &quot;è¿æ¥å…³é—­äº†..&quot; &#125; &#125; else &#123; alert(&quot;å½“å‰æµè§ˆå™¨ä¸æ”¯æŒwebsocket&quot;) &#125; // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨ function send(message) &#123; // å…ˆåˆ¤æ–­socketæ˜¯å¦åˆ›å»ºå¥½ if(!window.socket) &#123; return; &#125; if(socket.readyState == WebSocket.OPEN) &#123; // é€šè¿‡socket å‘é€æ¶ˆæ¯ socket.send(message) &#125; else &#123; alert(&quot;è¿æ¥æ²¡æœ‰å¼€å¯&quot;); &#125; &#125;&lt;/script&gt; &lt;form onsubmit=&quot;return false&quot;&gt; &lt;textarea name=&quot;message&quot; style=&quot;height: 300px; width: 300px&quot;&gt;&lt;/textarea&gt; &lt;input type=&quot;button&quot; value=&quot;å‘ç”Ÿæ¶ˆæ¯&quot; onclick=&quot;send(this.form.message.value)&quot;&gt; &lt;textarea id=&quot;responseText&quot; style=&quot;height: 300px; width: 300px&quot;&gt;&lt;/textarea&gt; &lt;input type=&quot;button&quot; value=&quot;æ¸…ç©ºå†…å®¹&quot; onclick=&quot;document.getElementById(&#x27;responseText&#x27;).value=&#x27;&#x27;&quot;&gt; &lt;/form&gt;&lt;/body&gt;&lt;/html&gt; å‚æ•°è°ƒä¼˜CONNECTå‚æ•°é…ç½®æ–¹å¼ï¼š å®¢æˆ·ç«¯é€šè¿‡ .option() æ–¹æ³•é…ç½®å‚æ•°ï¼Œç»™ SocketChannel é…ç½®å‚æ•° æœåŠ¡å™¨ç«¯ï¼š new ServerBootstrap().option()ï¼š ç»™ ServerSocketChannel é…ç½®å‚æ•° new ServerBootstrap().childOption()ï¼šç»™ SocketChannel é…ç½®å‚æ•° CONNECT_TIMEOUT_MILLIS å‚æ•°ï¼š å±äº SocketChannal å‚æ•° åœ¨å®¢æˆ·ç«¯å»ºç«‹è¿æ¥æ—¶ï¼Œå¦‚æœåœ¨æŒ‡å®šæ¯«ç§’å†…æ— æ³•è¿æ¥ï¼Œä¼šæŠ›å‡º timeout å¼‚å¸¸ SO_TIMEOUT ä¸»è¦ç”¨åœ¨é˜»å¡ IOï¼Œé˜»å¡ IO ä¸­ acceptï¼Œread ç­‰éƒ½æ˜¯æ— é™ç­‰å¾…çš„ï¼Œå¦‚æœä¸å¸Œæœ›æ°¸è¿œé˜»å¡ï¼Œå¯ä»¥è°ƒæ•´è¶…æ—¶æ—¶é—´ 12345678910111213141516171819public class ConnectionTimeoutTest &#123; public static void main(String[] args) &#123; NioEventLoopGroup group = new NioEventLoopGroup(); try &#123; Bootstrap bootstrap = new Bootstrap() .group(group) .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, 5000) .channel(NioSocketChannel.class) .handler(new LoggingHandler()); ChannelFuture future = bootstrap.connect(&quot;127.0.0.1&quot;, 8080); future.sync().channel().closeFuture().sync(); &#125; catch (Exception e) &#123; e.printStackTrace(); log.debug(&quot;timeout&quot;); &#125; finally &#123; group.shutdownGracefully(); &#125; &#125;&#125; SO_BACKLOGå±äº ServerSocketChannal å‚æ•°ï¼Œé€šè¿‡ option(ChannelOption.SO_BACKLOG, value) æ¥è®¾ç½®å¤§å° åœ¨ Linux 2.2 ä¹‹å‰ï¼Œbacklog å¤§å°åŒ…æ‹¬äº†ä¸¤ä¸ªé˜Ÿåˆ—çš„å¤§å°ï¼Œåœ¨ 2.2 ä¹‹åï¼Œåˆ†åˆ«ç”¨ä¸‹é¢ä¸¤ä¸ªå‚æ•°æ¥æ§åˆ¶ sync queueï¼šåŠè¿æ¥é˜Ÿåˆ—ï¼Œå¤§å°é€šè¿‡ /proc/sys/net/ipv4/tcp_max_syn_backlog æŒ‡å®šï¼Œåœ¨ syncookies å¯ç”¨çš„æƒ…å†µä¸‹ï¼Œé€»è¾‘ä¸Šæ²¡æœ‰æœ€å¤§å€¼é™åˆ¶ accept queueï¼šå…¨è¿æ¥é˜Ÿåˆ—ï¼Œå¤§å°é€šè¿‡ /proc/sys/net/core/somaxconn æŒ‡å®šï¼Œåœ¨ä½¿ç”¨ listen å‡½æ•°æ—¶ï¼Œå†…æ ¸ä¼šæ ¹æ®ä¼ å…¥çš„ backlog å‚æ•°ä¸ç³»ç»Ÿå‚æ•°ï¼Œå–äºŒè€…çš„è¾ƒå°å€¼ã€‚å¦‚æœ accpet queue é˜Ÿåˆ—æ»¡äº†ï¼Œserver å°†å‘é€ä¸€ä¸ªæ‹’ç»è¿æ¥çš„é”™è¯¯ä¿¡æ¯åˆ° client å…¶ä»–å‚æ•°ALLOCATORï¼šå±äº SocketChannal å‚æ•°ï¼Œç”¨æ¥åˆ†é… ByteBufï¼Œ ctx.alloc() RCVBUF_ALLOCATORï¼šå±äº SocketChannal å‚æ•° æ§åˆ¶ Netty æ¥æ”¶ç¼“å†²åŒºå¤§å° è´Ÿè´£å…¥ç«™æ•°æ®çš„åˆ†é…ï¼Œå†³å®šå…¥ç«™ç¼“å†²åŒºçš„å¤§å°ï¼ˆå¹¶å¯åŠ¨æ€è°ƒæ•´ï¼‰ï¼Œç»Ÿä¸€é‡‡ç”¨ direct ç›´æ¥å†…å­˜ï¼Œå…·ä½“æ± åŒ–è¿˜æ˜¯éæ± åŒ–ç”± allocator å†³å®š RocketMQåŸºæœ¬ä»‹ç»æ¶ˆæ¯é˜Ÿåˆ—åº”ç”¨åœºæ™¯æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ä¸€ç§å…ˆè¿›å…ˆå‡ºçš„æ•°æ®ç»“æ„ï¼Œå¸¸è§çš„åº”ç”¨åœºæ™¯ï¼š åº”ç”¨è§£è€¦ï¼šç³»ç»Ÿçš„è€¦åˆæ€§è¶Šé«˜ï¼Œå®¹é”™æ€§å°±è¶Šä½ å®ä¾‹ï¼šç”¨æˆ·åˆ›å»ºè®¢å•åï¼Œè€¦åˆè°ƒç”¨åº“å­˜ç³»ç»Ÿã€ç‰©æµç³»ç»Ÿã€æ”¯ä»˜ç³»ç»Ÿï¼Œä»»ä½•ä¸€ä¸ªå­ç³»ç»Ÿå‡ºäº†æ•…éšœéƒ½ä¼šé€ æˆä¸‹å•å¼‚å¸¸ï¼Œå½±å“ç”¨æˆ·ä½¿ç”¨ä½“éªŒã€‚ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦åˆï¼Œæ¯”å¦‚ç‰©æµç³»ç»Ÿå‘ç”Ÿæ•…éšœï¼Œéœ€è¦å‡ åˆ†é’Ÿæ¢å¤ï¼Œå°†ç‰©æµç³»ç»Ÿè¦å¤„ç†çš„æ•°æ®ç¼“å­˜åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç”¨æˆ·çš„ä¸‹å•æ“ä½œæ­£å¸¸å®Œæˆã€‚ç­‰å¾…ç‰©æµç³»ç»Ÿæ­£å¸¸åå¤„ç†å­˜åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„è®¢å•æ¶ˆæ¯å³å¯ï¼Œç»ˆç«¯ç³»ç»Ÿæ„ŸçŸ¥ä¸åˆ°ç‰©æµç³»ç»Ÿå‘ç”Ÿè¿‡å‡ åˆ†é’Ÿæ•…éšœ æµé‡å‰Šå³°ï¼šåº”ç”¨ç³»ç»Ÿå¦‚æœé‡åˆ°ç³»ç»Ÿè¯·æ±‚æµé‡çš„ç¬é—´çŒ›å¢ï¼Œæœ‰å¯èƒ½ä¼šå°†ç³»ç»Ÿå‹å®ï¼Œä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥å°†å¤§é‡è¯·æ±‚ç¼“å­˜èµ·æ¥ï¼Œåˆ†æ•£åˆ°å¾ˆé•¿ä¸€æ®µæ—¶é—´å¤„ç†ï¼Œè¿™æ ·å¯ä»¥æé«˜ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œç”¨æˆ·ä½“éªŒ æ•°æ®åˆ†å‘ï¼šè®©æ•°æ®åœ¨å¤šä¸ªç³»ç»Ÿæ›´åŠ ä¹‹é—´è¿›è¡Œæµé€šï¼Œæ•°æ®çš„äº§ç”Ÿæ–¹ä¸éœ€è¦å…³å¿ƒè°æ¥ä½¿ç”¨æ•°æ®ï¼Œåªéœ€è¦å°†æ•°æ®å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ•°æ®ä½¿ç”¨æ–¹ç›´æ¥åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ç›´æ¥è·å–æ•°æ® å‚è€ƒè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV1L4411y7mn æŠ€æœ¯é€‰å‹RocketMQ å¯¹æ¯” Kafka çš„ä¼˜ç‚¹ æ”¯æŒ Pullå’Œ Push ä¸¤ç§æ¶ˆæ¯æ¨¡å¼ æ”¯æŒå»¶æ—¶æ¶ˆæ¯ã€æ­»ä¿¡é˜Ÿåˆ—ã€æ¶ˆæ¯é‡è¯•ã€æ¶ˆæ¯å›æº¯ã€æ¶ˆæ¯è·Ÿè¸ªã€äº‹åŠ¡æ¶ˆæ¯ç­‰é«˜çº§ç‰¹æ€§ å¯¹æ¶ˆæ¯å¯é æ€§åšäº†æ”¹è¿›ï¼Œä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±å¹¶ä¸”è‡³å°‘æ¶ˆè´¹ä¸€æ¬¡ï¼Œä¸ Kafka ä¸€æ ·æ˜¯å…ˆå†™ PageCache å†è½ç›˜ï¼Œå¹¶ä¸”æ•°æ®æœ‰å¤šå‰¯æœ¬ RocketMQ å­˜å‚¨æ¨¡å‹æ˜¯æ‰€æœ‰çš„ Topic éƒ½å†™åˆ°åŒä¸€ä¸ª Commitlog é‡Œï¼Œæ˜¯ä¸€ä¸ª append only æ“ä½œï¼Œåœ¨æµ·é‡ Topic ä¸‹ä¹Ÿèƒ½å°†ç£ç›˜çš„æ€§èƒ½å‘æŒ¥åˆ°æè‡´ï¼Œå¹¶ä¸”ä¿æŒç¨³å®šçš„å†™å…¥æ—¶å»¶ã€‚Kafka çš„ååéå¸¸é«˜ï¼ˆé›¶æ‹·è´ã€æ“ä½œç³»ç»Ÿé¡µç¼“å­˜ã€ç£ç›˜é¡ºåºå†™ï¼‰ï¼Œä½†æ˜¯åœ¨å¤š Topic ä¸‹æ—¶å»¶ä¸å¤Ÿç¨³å®šï¼ˆé¡ºåºå†™å…¥ç‰¹æ€§ä¼šè¢«ç ´åä»è€Œå¼•å…¥å¤§é‡çš„éšæœº I&#x2F;Oï¼‰ï¼Œä¸é€‚åˆå®æ—¶åœ¨çº¿ä¸šåŠ¡åœºæ™¯ ç»è¿‡é˜¿é‡Œå·´å·´å¤šå¹´åŒ 11 éªŒè¯è¿‡ã€å¯ä»¥æ”¯æŒäº¿çº§å¹¶å‘çš„å¼€æºæ¶ˆæ¯é˜Ÿåˆ— Kafka æ¯” RocketMQ ååé‡é«˜ï¼š Kafka å°† Producer ç«¯å°†å¤šä¸ªå°æ¶ˆæ¯åˆå¹¶ï¼Œé‡‡ç”¨å¼‚æ­¥æ‰¹é‡å‘é€çš„æœºåˆ¶ï¼Œå½“å‘é€ä¸€æ¡æ¶ˆæ¯æ—¶ï¼Œæ¶ˆæ¯å¹¶æ²¡æœ‰å‘é€åˆ° Broker è€Œæ˜¯ç¼“å­˜èµ·æ¥ï¼Œç›´æ¥å‘ä¸šåŠ¡è¿”å›æˆåŠŸï¼Œå½“ç¼“å­˜çš„æ¶ˆæ¯è¾¾åˆ°ä¸€å®šæ•°é‡æ—¶å†æ‰¹é‡å‘é€ å‡å°‘äº†ç½‘ç»œ I&#x2F;Oï¼Œæé«˜äº†æ¶ˆæ¯å‘é€çš„æ€§èƒ½ï¼Œä½†æ˜¯å¦‚æœæ¶ˆæ¯å‘é€è€…å®•æœºï¼Œä¼šå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼Œé™ä½äº†å¯é æ€§ RocketMQ ç¼“å­˜è¿‡å¤šæ¶ˆæ¯ä¼šå¯¼è‡´é¢‘ç¹ GCï¼Œå¹¶ä¸”ä¸ºäº†ä¿è¯å¯é æ€§æ²¡æœ‰é‡‡ç”¨è¿™ç§æ–¹å¼ Topic çš„ partition æ•°é‡è¿‡å¤šæ—¶ï¼ŒKafka çš„æ€§èƒ½ä¸å¦‚ RocketMQï¼š ä¸¤è€…éƒ½ä½¿ç”¨æ–‡ä»¶å­˜å‚¨ï¼Œä½†æ˜¯ Kafka æ˜¯ä¸€ä¸ªåˆ†åŒºä¸€ä¸ªæ–‡ä»¶ï¼ŒTopic è¿‡å¤šæ—¶åˆ†åŒºçš„æ€»é‡ä¹Ÿä¼šå¢åŠ ï¼Œè¿‡å¤šçš„æ–‡ä»¶å¯¼è‡´å¯¹æ¶ˆæ¯åˆ·ç›˜æ—¶å‡ºç°æ–‡ä»¶ç«äº‰ç£ç›˜ï¼Œé€ æˆæ€§èƒ½çš„ä¸‹é™ã€‚ä¸€ä¸ªåˆ†åŒºåªèƒ½è¢«ä¸€ä¸ªæ¶ˆè´¹ç»„ä¸­çš„ä¸€ä¸ªæ¶ˆè´¹çº¿ç¨‹è¿›è¡Œæ¶ˆè´¹ï¼Œå› æ­¤å¯ä»¥åŒæ—¶æ¶ˆè´¹çš„æ¶ˆè´¹ç«¯ä¹Ÿæ¯”è¾ƒå°‘ RocketMQ æ‰€æœ‰é˜Ÿåˆ—éƒ½å­˜å‚¨åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œæ¯ä¸ªé˜Ÿåˆ—å­˜å‚¨çš„æ¶ˆæ¯é‡ä¹Ÿæ¯”è¾ƒå°ï¼Œå› æ­¤å¤š Topic çš„å¯¹ RocketMQ çš„æ€§èƒ½çš„å½±å“è¾ƒå° å®‰è£…æµ‹è¯•å®‰è£…éœ€è¦ Java ç¯å¢ƒï¼Œä¸‹è½½è§£å‹åè¿›å…¥å®‰è£…ç›®å½•ï¼Œè¿›è¡Œå¯åŠ¨ï¼š å¯åŠ¨ NameServer 1234# 1.å¯åŠ¨ NameServernohup sh bin/mqnamesrv &amp;# 2.æŸ¥çœ‹å¯åŠ¨æ—¥å¿—tail -f ~/logs/rocketmqlogs/namesrv.log RocketMQ é»˜è®¤çš„è™šæ‹Ÿæœºå†…å­˜è¾ƒå¤§ï¼Œéœ€è¦ç¼–è¾‘å¦‚ä¸‹ä¸¤ä¸ªé…ç½®æ–‡ä»¶ï¼Œä¿®æ”¹ JVM å†…å­˜å¤§å° 123# ç¼–è¾‘runbroker.shå’Œrunserver.shä¿®æ”¹é»˜è®¤JVMå¤§å°vi runbroker.shvi runserver.sh å‚è€ƒé…ç½®ï¼šJAVA_OPT&#x3D;â€${JAVA_OPT} -server -Xms256m -Xmx256m -Xmn128m -XX:MetaspaceSize&#x3D;128m -XX:MaxMetaspaceSize&#x3D;320mâ€ å¯åŠ¨ Broker 1234# 1.å¯åŠ¨ Brokernohup sh bin/mqbroker -n localhost:9876 autoCreateTopicEnable=true &amp;# 2.æŸ¥çœ‹å¯åŠ¨æ—¥å¿—tail -f ~/logs/rocketmqlogs/broker.log å‘é€æ¶ˆæ¯ï¼š 1234# 1.è®¾ç½®ç¯å¢ƒå˜é‡export NAMESRV_ADDR=localhost:9876# 2.ä½¿ç”¨å®‰è£…åŒ…çš„ Demo å‘é€æ¶ˆæ¯sh bin/tools.sh org.apache.rocketmq.example.quickstart.Producer æ¥å—æ¶ˆæ¯ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576 # 1.è®¾ç½®ç¯å¢ƒå˜é‡ export NAMESRV_ADDR=localhost:9876 # 2.æ¥æ”¶æ¶ˆæ¯ sh bin/tools.sh org.apache.rocketmq.example.quickstart.Consumer* å…³é—­ RocketMQï¼š ```sh # 1.å…³é—­ NameServer sh bin/mqshutdown namesrv # 2.å…³é—­ Broker sh bin/mqshutdown broker***### ç›¸å…³æ¦‚å¿µRocketMQ ä¸»è¦ç”± Producerã€Brokerã€Consumer ä¸‰éƒ¨åˆ†ç»„æˆï¼Œå…¶ä¸­ Producer è´Ÿè´£ç”Ÿäº§æ¶ˆæ¯ï¼ŒConsumer è´Ÿè´£æ¶ˆè´¹æ¶ˆæ¯ï¼ŒBroker è´Ÿè´£å­˜å‚¨æ¶ˆæ¯ï¼ŒNameServer è´Ÿè´£ç®¡ç† Broker* ä»£ç†æœåŠ¡å™¨ï¼ˆBroker Serverï¼‰ï¼šæ¶ˆæ¯ä¸­è½¬è§’è‰²ï¼Œè´Ÿè´£**å­˜å‚¨æ¶ˆæ¯ã€è½¬å‘æ¶ˆæ¯**ã€‚åœ¨ RocketMQ ç³»ç»Ÿä¸­è´Ÿè´£æ¥æ”¶ä»ç”Ÿäº§è€…å‘é€æ¥çš„æ¶ˆæ¯å¹¶å­˜å‚¨ã€åŒæ—¶ä¸ºæ¶ˆè´¹è€…çš„æ‹‰å–è¯·æ±‚ä½œå‡†å¤‡ï¼Œä¹Ÿå­˜å‚¨æ¶ˆæ¯ç›¸å…³çš„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬æ¶ˆè´¹è€…ç»„ã€æ¶ˆè´¹è¿›åº¦åç§»å’Œä¸»é¢˜å’Œé˜Ÿåˆ—æ¶ˆæ¯ç­‰* åå­—æœåŠ¡ï¼ˆName Serverï¼‰ï¼šå……å½“**è·¯ç”±æ¶ˆæ¯**çš„æä¾›è€…ã€‚ç”Ÿäº§è€…æˆ–æ¶ˆè´¹è€…èƒ½å¤Ÿé€šè¿‡åå­—æœåŠ¡æŸ¥æ‰¾å„ä¸»é¢˜ç›¸åº”çš„ Broker IP åˆ—è¡¨* æ¶ˆæ¯ç”Ÿäº§è€…ï¼ˆProducerï¼‰ï¼šè´Ÿè´£**ç”Ÿäº§æ¶ˆæ¯**ï¼ŒæŠŠä¸šåŠ¡åº”ç”¨ç³»ç»Ÿé‡Œäº§ç”Ÿçš„æ¶ˆæ¯å‘é€åˆ° Broker æœåŠ¡å™¨ã€‚RocketMQ æä¾›å¤šç§å‘é€æ–¹å¼ï¼ŒåŒæ­¥å‘é€ã€å¼‚æ­¥å‘é€ã€é¡ºåºå‘é€ã€å•å‘å‘é€ï¼ŒåŒæ­¥å’Œå¼‚æ­¥æ–¹å¼å‡éœ€è¦ Broker è¿”å›ç¡®è®¤ä¿¡æ¯ï¼Œå•å‘å‘é€ä¸éœ€è¦ï¼›å¯ä»¥é€šè¿‡ MQ çš„è´Ÿè½½å‡è¡¡æ¨¡å—é€‰æ‹©ç›¸åº”çš„ Broker é›†ç¾¤é˜Ÿåˆ—è¿›è¡Œæ¶ˆæ¯æŠ•é€’ï¼ŒæŠ•é€’çš„è¿‡ç¨‹æ”¯æŒå¿«é€Ÿå¤±è´¥å¹¶ä¸”ä½å»¶è¿Ÿ* æ¶ˆæ¯æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰ï¼šè´Ÿè´£**æ¶ˆè´¹æ¶ˆæ¯**ï¼Œä¸€èˆ¬æ˜¯åå°ç³»ç»Ÿè´Ÿè´£å¼‚æ­¥æ¶ˆè´¹ï¼Œä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹è€…ä¼šä» Broker æœåŠ¡å™¨æ‹‰å–æ¶ˆæ¯ã€å¹¶å°†å…¶æä¾›ç»™åº”ç”¨ç¨‹åºã€‚ä»ç”¨æˆ·åº”ç”¨çš„è§’åº¦è€Œæä¾›äº†ä¸¤ç§æ¶ˆè´¹å½¢å¼ï¼š * æ‹‰å–å¼æ¶ˆè´¹ï¼ˆPull Consumerï¼‰ï¼šåº”ç”¨é€šä¸»åŠ¨è°ƒç”¨ Consumer çš„æ‹‰æ¶ˆæ¯æ–¹æ³•ä» Broker æœåŠ¡å™¨æ‹‰æ¶ˆæ¯ï¼Œä¸»åŠ¨æƒç”±åº”ç”¨æ§åˆ¶ï¼Œä¸€æ—¦è·å–äº†æ‰¹é‡æ¶ˆæ¯ï¼Œåº”ç”¨å°±ä¼šå¯åŠ¨æ¶ˆè´¹è¿‡ç¨‹ * æ¨åŠ¨å¼æ¶ˆè´¹ï¼ˆPush Consumerï¼‰ï¼šè¯¥æ¨¡å¼ä¸‹ Broker æ”¶åˆ°æ•°æ®åä¼šä¸»åŠ¨æ¨é€ç»™æ¶ˆè´¹ç«¯ï¼Œå®æ—¶æ€§è¾ƒé«˜* ç”Ÿäº§è€…ç»„ï¼ˆProducer Groupï¼‰ï¼šåŒä¸€ç±» Producer çš„é›†åˆï¼Œå‘é€åŒä¸€ç±»æ¶ˆæ¯ä¸”å‘é€é€»è¾‘ä¸€è‡´ã€‚å¦‚æœå‘é€çš„æ˜¯äº‹åŠ¡æ¶ˆæ¯ä¸”åŸå§‹ç”Ÿäº§è€…åœ¨å‘é€ä¹‹åå´©æºƒï¼Œ**åˆ™ Broker æœåŠ¡å™¨ä¼šè”ç³»åŒä¸€ç”Ÿäº§è€…ç»„çš„å…¶ä»–ç”Ÿäº§è€…å®ä¾‹ä»¥æäº¤æˆ–å›æº¯æ¶ˆè´¹*** æ¶ˆè´¹è€…ç»„ï¼ˆConsumer Groupï¼‰ï¼šåŒä¸€ç±» Consumer çš„é›†åˆï¼Œæ¶ˆè´¹è€…å®ä¾‹å¿…é¡»è®¢é˜…å®Œå…¨ç›¸åŒçš„ Topicï¼Œæ¶ˆè´¹åŒä¸€ç±»æ¶ˆæ¯ä¸”æ¶ˆè´¹é€»è¾‘ä¸€è‡´ã€‚æ¶ˆè´¹è€…ç»„ä½¿å¾—åœ¨æ¶ˆæ¯æ¶ˆè´¹æ–¹é¢æ›´å®¹æ˜“çš„å®ç°è´Ÿè½½å‡è¡¡å’Œå®¹é”™ã€‚RocketMQ æ”¯æŒä¸¤ç§æ¶ˆæ¯æ¨¡å¼ï¼š * é›†ç¾¤æ¶ˆè´¹ï¼ˆClusteringï¼‰ï¼šç›¸åŒ Consumer Group çš„æ¯ä¸ª Consumer å®ä¾‹å¹³å‡åˆ†æ‘Šæ¶ˆæ¯ * å¹¿æ’­æ¶ˆè´¹ï¼ˆBroadcastingï¼‰ï¼šç›¸åŒ Consumer Group çš„æ¯ä¸ª Consumer å®ä¾‹éƒ½æ¥æ”¶å…¨é‡çš„æ¶ˆæ¯æ¯ä¸ª Broker å¯ä»¥å­˜å‚¨å¤šä¸ª Topic çš„æ¶ˆæ¯ï¼Œæ¯ä¸ª Topic çš„æ¶ˆæ¯ä¹Ÿå¯ä»¥åˆ†ç‰‡å­˜å‚¨äºä¸åŒçš„ Brokerï¼ŒMessage Queueï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰æ˜¯ç”¨äºå­˜å‚¨æ¶ˆæ¯çš„ç‰©ç†åœ°å€ï¼Œæ¯ä¸ª Topic ä¸­çš„æ¶ˆæ¯åœ°å€å­˜å‚¨äºå¤šä¸ª Message Queue ä¸­* ä¸»é¢˜ï¼ˆTopicï¼‰ï¼šè¡¨ç¤ºä¸€ç±»æ¶ˆæ¯çš„é›†åˆï¼Œæ¯ä¸ªä¸»é¢˜åŒ…å«è‹¥å¹²æ¡æ¶ˆæ¯ï¼Œæ¯æ¡æ¶ˆæ¯åªå±äºä¸€ä¸ªä¸»é¢˜ï¼Œæ˜¯ RocketMQ æ¶ˆæ¯è®¢é˜…çš„åŸºæœ¬å•ä½* æ¶ˆæ¯ï¼ˆMessageï¼‰ï¼šæ¶ˆæ¯ç³»ç»Ÿæ‰€ä¼ è¾“ä¿¡æ¯çš„ç‰©ç†è½½ä½“ï¼Œç”Ÿäº§å’Œæ¶ˆè´¹æ•°æ®çš„æœ€å°å•ä½ï¼Œæ¯æ¡æ¶ˆæ¯å¿…é¡»å±äºä¸€ä¸ªä¸»é¢˜ã€‚RocketMQ ä¸­æ¯ä¸ªæ¶ˆæ¯æ‹¥æœ‰å”¯ä¸€çš„ Message IDï¼Œä¸”å¯ä»¥æºå¸¦å…·æœ‰ä¸šåŠ¡æ ‡è¯†çš„ Keyï¼Œç³»ç»Ÿæä¾›äº†é€šè¿‡ Message ID å’Œ Key æŸ¥è¯¢æ¶ˆæ¯çš„åŠŸèƒ½* æ ‡ç­¾ï¼ˆTagï¼‰ï¼šä¸ºæ¶ˆæ¯è®¾ç½®çš„æ ‡å¿—ï¼Œç”¨äºåŒä¸€ä¸»é¢˜ä¸‹åŒºåˆ†ä¸åŒç±»å‹çš„æ¶ˆæ¯ã€‚æ ‡ç­¾èƒ½å¤Ÿæœ‰æ•ˆåœ°ä¿æŒä»£ç çš„æ¸…æ™°åº¦å’Œè¿è´¯æ€§ï¼Œå¹¶ä¼˜åŒ– RocketMQ æä¾›çš„æŸ¥è¯¢ç³»ç»Ÿï¼Œæ¶ˆè´¹è€…å¯ä»¥æ ¹æ® Tag å®ç°å¯¹ä¸åŒå­ä¸»é¢˜çš„ä¸åŒæ¶ˆè´¹é€»è¾‘ï¼Œå®ç°æ›´å¥½çš„æ‰©å±•æ€§* æ™®é€šé¡ºåºæ¶ˆæ¯ï¼ˆNormal Ordered Messageï¼‰ï¼šæ¶ˆè´¹è€…é€šè¿‡åŒä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆTopic åˆ†åŒºï¼‰æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯æœ‰é¡ºåºçš„ï¼Œä¸åŒæ¶ˆæ¯é˜Ÿåˆ—æ”¶åˆ°çš„æ¶ˆæ¯åˆ™å¯èƒ½æ˜¯æ— é¡ºåºçš„* ä¸¥æ ¼é¡ºåºæ¶ˆæ¯ï¼ˆStrictly Ordered Messageï¼‰ï¼šæ¶ˆè´¹è€…æ”¶åˆ°çš„æ‰€æœ‰æ¶ˆæ¯å‡æ˜¯æœ‰é¡ºåºçš„å®˜æ–¹æ–‡æ¡£ï¼šhttps://github.com/apache/rocketmq/tree/master/docs/cnï¼ˆåŸºç¡€çŸ¥è¯†éƒ¨åˆ†çš„ç¬”è®°å‚è€ƒå®˜æ–¹æ–‡æ¡£ç¼–å†™ï¼‰****## æ¶ˆæ¯æ“ä½œ### åŸºæœ¬æ ·ä¾‹#### è®¢é˜…å‘å¸ƒæ¶ˆæ¯çš„å‘å¸ƒæ˜¯æŒ‡æŸä¸ªç”Ÿäº§è€…å‘æŸä¸ª Topic å‘é€æ¶ˆæ¯ï¼Œæ¶ˆæ¯çš„è®¢é˜…æ˜¯æŒ‡æŸä¸ªæ¶ˆè´¹è€…å…³æ³¨äº†æŸä¸ª Topic ä¸­å¸¦æœ‰æŸäº› Tag çš„æ¶ˆæ¯ï¼Œè¿›è€Œä»è¯¥ Topic æ¶ˆè´¹æ•°æ®å¯¼å…¥ MQ å®¢æˆ·ç«¯ä¾èµ–ï¼š```xml&lt;dependency&gt; &lt;groupId&gt;org.apache.rocketmq&lt;/groupId&gt; &lt;artifactId&gt;rocketmq-client&lt;/artifactId&gt; &lt;version&gt;4.4.0&lt;/version&gt;&lt;/dependency&gt; æ¶ˆæ¯å‘é€è€…æ­¥éª¤åˆ†æï¼š åˆ›å»ºæ¶ˆæ¯ç”Ÿäº§è€… Producerï¼Œå¹¶åˆ¶å®šç”Ÿäº§è€…ç»„å æŒ‡å®š Nameserver åœ°å€ å¯åŠ¨ Producer åˆ›å»ºæ¶ˆæ¯å¯¹è±¡ï¼ŒæŒ‡å®šä¸»é¢˜ Topicã€Tag å’Œæ¶ˆæ¯ä½“ å‘é€æ¶ˆæ¯ å…³é—­ç”Ÿäº§è€… Producer æ¶ˆæ¯æ¶ˆè´¹è€…æ­¥éª¤åˆ†æï¼š åˆ›å»ºæ¶ˆè´¹è€… Consumerï¼Œåˆ¶å®šæ¶ˆè´¹è€…ç»„å æŒ‡å®š Nameserver åœ°å€ è®¢é˜…ä¸»é¢˜ Topic å’Œ Tag è®¾ç½®å›è°ƒå‡½æ•°ï¼Œå¤„ç†æ¶ˆæ¯ å¯åŠ¨æ¶ˆè´¹è€… Consumer å®˜æ–¹æ–‡æ¡£ï¼šhttps://github.com/apache/rocketmq/blob/master/docs/cn/RocketMQ_Example.md å‘é€æ¶ˆæ¯åŒæ­¥å‘é€ä½¿ç”¨ RocketMQ å‘é€ä¸‰ç§ç±»å‹çš„æ¶ˆæ¯ï¼šåŒæ­¥æ¶ˆæ¯ã€å¼‚æ­¥æ¶ˆæ¯å’Œå•å‘æ¶ˆæ¯ï¼Œå…¶ä¸­å‰ä¸¤ç§æ¶ˆæ¯æ˜¯å¯é çš„ï¼Œå› ä¸ºä¼šæœ‰å‘é€æ˜¯å¦æˆåŠŸçš„åº”ç­” è¿™ç§å¯é æ€§åŒæ­¥åœ°å‘é€æ–¹å¼ä½¿ç”¨çš„æ¯”è¾ƒå¹¿æ³›ï¼Œæ¯”å¦‚ï¼šé‡è¦çš„æ¶ˆæ¯é€šçŸ¥ï¼ŒçŸ­ä¿¡é€šçŸ¥ 123456789101112131415161718192021222324public class SyncProducer &#123; public static void main(String[] args) throws Exception &#123; // å®ä¾‹åŒ–æ¶ˆæ¯ç”Ÿäº§è€…Producer DefaultMQProducer producer = new DefaultMQProducer(&quot;please_rename_unique_group_name&quot;); // è®¾ç½®NameServerçš„åœ°å€ producer.setNamesrvAddr(&quot;localhost:9876&quot;); // å¯åŠ¨Producerå®ä¾‹ producer.start(); for (int i = 0; i &lt; 100; i++) &#123; // åˆ›å»ºæ¶ˆæ¯ï¼Œå¹¶æŒ‡å®šTopicï¼ŒTagå’Œæ¶ˆæ¯ä½“ Message msg = new Message( &quot;TopicTest&quot; /* Topic */, &quot;TagA&quot; /* Tag */, (&quot;Hello RocketMQ &quot; + i).getBytes(RemotingHelper.DEFAULT_CHARSET) /* Message body */); // å‘é€æ¶ˆæ¯åˆ°ä¸€ä¸ªBroker SendResult sendResult = producer.send(msg); // é€šè¿‡sendResultè¿”å›æ¶ˆæ¯æ˜¯å¦æˆåŠŸé€è¾¾ System.out.printf(&quot;%s%n&quot;, sendResult); &#125; // å¦‚æœä¸å†å‘é€æ¶ˆæ¯ï¼Œå…³é—­Producerå®ä¾‹ã€‚ producer.shutdown(); &#125;&#125; å¼‚æ­¥å‘é€å¼‚æ­¥æ¶ˆæ¯é€šå¸¸ç”¨åœ¨å¯¹å“åº”æ—¶é—´æ•æ„Ÿçš„ä¸šåŠ¡åœºæ™¯ï¼Œå³å‘é€ç«¯ä¸èƒ½å®¹å¿é•¿æ—¶é—´åœ°ç­‰å¾… Broker çš„å“åº” 123456789101112131415161718192021222324252627282930313233343536373839404142public class AsyncProducer &#123; public static void main(String[] args) throws Exception &#123; // å®ä¾‹åŒ–æ¶ˆæ¯ç”Ÿäº§è€…Producer DefaultMQProducer producer = new DefaultMQProducer(&quot;please_rename_unique_group_name&quot;); // è®¾ç½®NameServerçš„åœ°å€ producer.setNamesrvAddr(&quot;localhost:9876&quot;); // å¯åŠ¨Producerå®ä¾‹ producer.start(); producer.setRetryTimesWhenSendAsyncFailed(0); int messageCount = 100; // æ ¹æ®æ¶ˆæ¯æ•°é‡å®ä¾‹åŒ–å€’è®¡æ—¶è®¡ç®—å™¨ final CountDownLatch2 countDownLatch = new CountDownLatch2(messageCount); for (int i = 0; i &lt; messageCount; i++) &#123; final int index = i; // åˆ›å»ºæ¶ˆæ¯ï¼Œå¹¶æŒ‡å®šTopicï¼ŒTagå’Œæ¶ˆæ¯ä½“ Message msg = new Message(&quot;TopicTest&quot;, &quot;TagA&quot;, &quot;OrderID188&quot;, &quot;Hello world&quot;.getBytes(RemotingHelper.DEFAULT_CHARSET)); // SendCallbackæ¥æ”¶å¼‚æ­¥è¿”å›ç»“æœçš„å›è°ƒ producer.send(msg, new SendCallback() &#123; // å‘é€æˆåŠŸå›è°ƒå‡½æ•° @Override public void onSuccess(SendResult sendResult) &#123; countDownLatch.countDown(); System.out.printf(&quot;%-10d OK %s %n&quot;, index, sendResult.getMsgId()); &#125; @Override public void onException(Throwable e) &#123; countDownLatch.countDown(); System.out.printf(&quot;%-10d Exception %s %n&quot;, index, e); e.printStackTrace(); &#125; &#125;); &#125; // ç­‰å¾…5s countDownLatch.await(5, TimeUnit.SECONDS); // å¦‚æœä¸å†å‘é€æ¶ˆæ¯ï¼Œå…³é—­Producerå®ä¾‹ã€‚ producer.shutdown(); &#125;&#125; å•å‘å‘é€å•å‘å‘é€ä¸»è¦ç”¨åœ¨ä¸ç‰¹åˆ«å…³å¿ƒå‘é€ç»“æœçš„åœºæ™¯ï¼Œä¾‹å¦‚æ—¥å¿—å‘é€ 12345678910111213141516171819public class OnewayProducer &#123; public static void main(String[] args) throws Exception&#123; // å®ä¾‹åŒ–æ¶ˆæ¯ç”Ÿäº§è€…Producer DefaultMQProducer producer = new DefaultMQProducer(&quot;please_rename_unique_group_name&quot;); // è®¾ç½®NameServerçš„åœ°å€ producer.setNamesrvAddr(&quot;localhost:9876&quot;); // å¯åŠ¨Producerå®ä¾‹ producer.start(); for (int i = 0; i &lt; 100; i++) &#123; // åˆ›å»ºæ¶ˆæ¯ï¼Œå¹¶æŒ‡å®šTopicï¼ŒTagå’Œæ¶ˆæ¯ä½“ Message msg = new Message(&quot;TopicTest&quot;,&quot;TagA&quot;, (&quot;Hello RocketMQ &quot; + i).getBytes(RemotingHelper.DEFAULT_CHARSET)); // å‘é€å•å‘æ¶ˆæ¯ï¼Œæ²¡æœ‰ä»»ä½•è¿”å›ç»“æœ producer.sendOneway(msg); &#125; // å¦‚æœä¸å†å‘é€æ¶ˆæ¯ï¼Œå…³é—­Producerå®ä¾‹ã€‚ producer.shutdown(); &#125;&#125; æ¶ˆè´¹æ¶ˆæ¯123456789101112131415161718192021222324public class Consumer &#123; public static void main(String[] args) throws InterruptedException, MQClientException &#123; // å®ä¾‹åŒ–æ¶ˆè´¹è€… DefaultMQPushConsumer consumer = new DefaultMQPushConsumer(&quot;please_rename_unique_group_name&quot;); // è®¾ç½®NameServerçš„åœ°å€ consumer.setNamesrvAddr(&quot;localhost:9876&quot;); // è®¢é˜…ä¸€ä¸ªæˆ–è€…å¤šä¸ªTopicï¼Œä»¥åŠTagæ¥è¿‡æ»¤éœ€è¦æ¶ˆè´¹çš„æ¶ˆæ¯ consumer.subscribe(&quot;TopicTest&quot;, &quot;*&quot;); // æ³¨å†Œæ¶ˆæ¯ç›‘å¬å™¨ï¼Œå›è°ƒå®ç°ç±»æ¥å¤„ç†ä»brokeræ‹‰å–å›æ¥çš„æ¶ˆæ¯ consumer.registerMessageListener(new MessageListenerConcurrently() &#123; // æ¥å—æ¶ˆæ¯å†…å®¹ @Override public ConsumeConcurrentlyStatus consumeMessage(List&lt;MessageExt&gt; msgs, ConsumeConcurrentlyContext context) &#123; System.out.printf(&quot;%s Receive New Messages: %s %n&quot;, Thread.currentThread().getName(), msgs); // æ ‡è®°è¯¥æ¶ˆæ¯å·²ç»è¢«æˆåŠŸæ¶ˆè´¹ return ConsumeConcurrentlyStatus.CONSUME_SUCCESS; &#125; &#125;); // å¯åŠ¨æ¶ˆè´¹è€…å®ä¾‹ consumer.start(); System.out.printf(&quot;Consumer Started.%n&quot;); &#125;&#125; é¡ºåºæ¶ˆæ¯åŸç†è§£ææ¶ˆæ¯æœ‰åºæŒ‡çš„æ˜¯ä¸€ç±»æ¶ˆæ¯æ¶ˆè´¹æ—¶ï¼Œèƒ½æŒ‰ç…§å‘é€çš„é¡ºåºæ¥æ¶ˆè´¹ã€‚ä¾‹å¦‚ï¼šä¸€ä¸ªè®¢å•äº§ç”Ÿäº†ä¸‰æ¡æ¶ˆæ¯åˆ†åˆ«æ˜¯è®¢å•åˆ›å»ºã€è®¢å•ä»˜æ¬¾ã€è®¢å•å®Œæˆã€‚æ¶ˆè´¹æ—¶è¦æŒ‰ç…§è¿™ä¸ªé¡ºåºæ¶ˆè´¹æ‰èƒ½æœ‰æ„ä¹‰ï¼Œä½†æ˜¯åŒæ—¶è®¢å•ä¹‹é—´æ˜¯å¯ä»¥å¹¶è¡Œæ¶ˆè´¹çš„ï¼ŒRocketMQ å¯ä»¥ä¸¥æ ¼çš„ä¿è¯æ¶ˆæ¯æœ‰åºã€‚ é¡ºåºæ¶ˆæ¯åˆ†ä¸ºå…¨å±€é¡ºåºæ¶ˆæ¯ä¸åˆ†åŒºé¡ºåºæ¶ˆæ¯ï¼Œ å…¨å±€é¡ºåºï¼šå¯¹äºæŒ‡å®šçš„ä¸€ä¸ª Topicï¼Œæ‰€æœ‰æ¶ˆæ¯æŒ‰ç…§ä¸¥æ ¼çš„å…ˆå…¥å…ˆå‡ºï¼ˆFIFOï¼‰çš„é¡ºåºè¿›è¡Œå‘å¸ƒå’Œæ¶ˆè´¹ï¼Œé€‚ç”¨äºæ€§èƒ½è¦æ±‚ä¸é«˜ï¼Œæ‰€æœ‰çš„æ¶ˆæ¯ä¸¥æ ¼æŒ‰ç…§ FIFO åŸåˆ™è¿›è¡Œæ¶ˆæ¯å‘å¸ƒå’Œæ¶ˆè´¹çš„åœºæ™¯ åˆ†åŒºé¡ºåºï¼šå¯¹äºæŒ‡å®šçš„ä¸€ä¸ª Topicï¼Œæ‰€æœ‰æ¶ˆæ¯æ ¹æ® Sharding key è¿›è¡Œåˆ†åŒºï¼ŒåŒä¸€ä¸ªåˆ†ç»„å†…çš„æ¶ˆæ¯æŒ‰ç…§ä¸¥æ ¼çš„ FIFO é¡ºåºè¿›è¡Œå‘å¸ƒå’Œæ¶ˆè´¹ã€‚Sharding key æ˜¯é¡ºåºæ¶ˆæ¯ä¸­ç”¨æ¥åŒºåˆ†ä¸åŒåˆ†åŒºçš„å…³é”®å­—æ®µï¼Œå’Œæ™®é€šæ¶ˆæ¯çš„ Key æ˜¯å®Œå…¨ä¸åŒçš„æ¦‚å¿µï¼Œé€‚ç”¨äºæ€§èƒ½è¦æ±‚é«˜çš„åœºæ™¯ åœ¨é»˜è®¤çš„æƒ…å†µä¸‹æ¶ˆæ¯å‘é€ä¼šé‡‡å– Round Robin è½®è¯¢æ–¹å¼æŠŠæ¶ˆæ¯å‘é€åˆ°ä¸åŒçš„ queueï¼ˆåˆ†åŒºé˜Ÿåˆ—ï¼‰ï¼Œè€Œæ¶ˆè´¹æ¶ˆæ¯æ˜¯ä»å¤šä¸ª queue ä¸Šæ‹‰å–æ¶ˆæ¯ï¼Œè¿™ç§æƒ…å†µå‘é€å’Œæ¶ˆè´¹æ˜¯ä¸èƒ½ä¿è¯é¡ºåºã€‚ä½†æ˜¯å¦‚æœæ§åˆ¶å‘é€çš„é¡ºåºæ¶ˆæ¯åªä¾æ¬¡å‘é€åˆ°åŒä¸€ä¸ª queue ä¸­ï¼Œæ¶ˆè´¹çš„æ—¶å€™åªä»è¿™ä¸ª queue ä¸Šä¾æ¬¡æ‹‰å–ï¼Œåˆ™å°±ä¿è¯äº†é¡ºåºã€‚å½“å‘é€å’Œæ¶ˆè´¹å‚ä¸çš„ queue åªæœ‰ä¸€ä¸ªï¼Œåˆ™æ˜¯å…¨å±€æœ‰åºï¼›å¦‚æœå¤šä¸ªqueue å‚ä¸ï¼Œåˆ™ä¸ºåˆ†åŒºæœ‰åºï¼Œå³ç›¸å¯¹æ¯ä¸ª queueï¼Œæ¶ˆæ¯éƒ½æ˜¯æœ‰åºçš„ ä»£ç å®ç°ä¸€ä¸ªè®¢å•çš„é¡ºåºæµç¨‹æ˜¯ï¼šåˆ›å»ºã€ä»˜æ¬¾ã€æ¨é€ã€å®Œæˆï¼Œè®¢å•å·ç›¸åŒçš„æ¶ˆæ¯ä¼šè¢«å…ˆåå‘é€åˆ°åŒä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œæ¶ˆè´¹æ—¶åŒä¸€ä¸ª OrderId è·å–åˆ°çš„è‚¯å®šæ˜¯åŒä¸€ä¸ªé˜Ÿåˆ— 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110public class Producer &#123; public static void main(String[] args) throws Exception &#123; DefaultMQProducer producer = new DefaultMQProducer(&quot;please_rename_unique_group_name&quot;); producer.setNamesrvAddr(&quot;127.0.0.1:9876&quot;); producer.start(); // æ ‡ç­¾é›†åˆ String[] tags = new String[]&#123;&quot;TagA&quot;, &quot;TagC&quot;, &quot;TagD&quot;&#125;; // è®¢å•åˆ—è¡¨ List&lt;OrderStep&gt; orderList = new Producer().buildOrders(); Date date = new Date(); SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;); String dateStr = sdf.format(date); for (int i = 0; i &lt; 10; i++) &#123; // åŠ ä¸ªæ—¶é—´å‰ç¼€ String body = dateStr + &quot; Hello RocketMQ &quot; + orderList.get(i); Message msg = new Message(&quot;OrderTopic&quot;, tags[i % tags.length], &quot;KEY&quot; + i, body.getBytes()); /** * å‚æ•°ä¸€ï¼šæ¶ˆæ¯å¯¹è±¡ * å‚æ•°äºŒï¼šæ¶ˆæ¯é˜Ÿåˆ—çš„é€‰æ‹©å™¨ * å‚æ•°ä¸‰ï¼šé€‰æ‹©é˜Ÿåˆ—çš„ä¸šåŠ¡æ ‡è¯†ï¼ˆè®¢å• IDï¼‰ */ SendResult sendResult = producer.send(msg, new MessageQueueSelector() &#123; @Override /** * mqsï¼šé˜Ÿåˆ—é›†åˆ * msgï¼šæ¶ˆæ¯å¯¹è±¡ * argï¼šä¸šåŠ¡æ ‡è¯†çš„å‚æ•° */ public MessageQueue select(List&lt;MessageQueue&gt; mqs, Message msg, Object arg) &#123; Long id = (Long) arg; long index = id % mqs.size(); // æ ¹æ®è®¢å•idé€‰æ‹©å‘é€queue return mqs.get((int) index); &#125; &#125;, orderList.get(i).getOrderId());//è®¢å•id System.out.println(String.format(&quot;SendResult status:%s, queueId:%d, body:%s&quot;, sendResult.getSendStatus(), sendResult.getMessageQueue().getQueueId(), body)); &#125; producer.shutdown(); &#125; // è®¢å•çš„æ­¥éª¤ private static class OrderStep &#123; private long orderId; private String desc; // set + get &#125; // ç”Ÿæˆæ¨¡æ‹Ÿè®¢å•æ•°æ® private List&lt;OrderStep&gt; buildOrders() &#123; List&lt;OrderStep&gt; orderList = new ArrayList&lt;OrderStep&gt;(); OrderStep orderDemo = new OrderStep(); orderDemo.setOrderId(15103111039L); orderDemo.setDesc(&quot;åˆ›å»º&quot;); orderList.add(orderDemo); orderDemo = new OrderStep(); orderDemo.setOrderId(15103111065L); orderDemo.setDesc(&quot;åˆ›å»º&quot;); orderList.add(orderDemo); orderDemo = new OrderStep(); orderDemo.setOrderId(15103111039L); orderDemo.setDesc(&quot;ä»˜æ¬¾&quot;); orderList.add(orderDemo); orderDemo = new OrderStep(); orderDemo.setOrderId(15103117235L); orderDemo.setDesc(&quot;åˆ›å»º&quot;); orderList.add(orderDemo); orderDemo = new OrderStep(); orderDemo.setOrderId(15103111065L); orderDemo.setDesc(&quot;ä»˜æ¬¾&quot;); orderList.add(orderDemo); orderDemo = new OrderStep(); orderDemo.setOrderId(15103117235L); orderDemo.setDesc(&quot;ä»˜æ¬¾&quot;); orderList.add(orderDemo); orderDemo = new OrderStep(); orderDemo.setOrderId(15103111065L); orderDemo.setDesc(&quot;å®Œæˆ&quot;); orderList.add(orderDemo); orderDemo = new OrderStep(); orderDemo.setOrderId(15103111039L); orderDemo.setDesc(&quot;æ¨é€&quot;); orderList.add(orderDemo); orderDemo = new OrderStep(); orderDemo.setOrderId(15103117235L); orderDemo.setDesc(&quot;å®Œæˆ&quot;); orderList.add(orderDemo); orderDemo = new OrderStep(); orderDemo.setOrderId(15103111039L); orderDemo.setDesc(&quot;å®Œæˆ&quot;); orderList.add(orderDemo); return orderList; &#125;&#125; 1234567891011121314151617181920212223242526// é¡ºåºæ¶ˆæ¯æ¶ˆè´¹ï¼Œå¸¦äº‹åŠ¡æ–¹å¼ï¼ˆåº”ç”¨å¯æ§åˆ¶Offsetä»€ä¹ˆæ—¶å€™æäº¤ï¼‰public class ConsumerInOrder &#123; public static void main(String[] args) throws Exception &#123; DefaultMQPushConsumer consumer = new DefaultMQPushConsumer(&quot;please_rename_unique_group_name_3&quot;); consumer.setNamesrvAddr(&quot;127.0.0.1:9876&quot;); // è®¾ç½®Consumerç¬¬ä¸€æ¬¡å¯åŠ¨æ˜¯ä»é˜Ÿåˆ—å¤´éƒ¨å¼€å§‹æ¶ˆè´¹è¿˜æ˜¯é˜Ÿåˆ—å°¾éƒ¨å¼€å§‹æ¶ˆè´¹ // å¦‚æœéç¬¬ä¸€æ¬¡å¯åŠ¨ï¼Œé‚£ä¹ˆæŒ‰ç…§ä¸Šæ¬¡æ¶ˆè´¹çš„ä½ç½®ç»§ç»­æ¶ˆè´¹ consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET); // è®¢é˜…ä¸‰ä¸ªtag consumer.subscribe(&quot;OrderTopic&quot;, &quot;TagA || TagC || TagD&quot;); consumer.registerMessageListener(new MessageListenerOrderly() &#123; Random random = new Random(); @Override public ConsumeOrderlyStatus consumeMessage(List&lt;MessageExt&gt; msgs, ConsumeOrderlyContext context) &#123; context.setAutoCommit(true); for (MessageExt msg : msgs) &#123; // å¯ä»¥çœ‹åˆ°æ¯ä¸ªqueueæœ‰å”¯ä¸€çš„consumeçº¿ç¨‹æ¥æ¶ˆè´¹, è®¢å•å¯¹æ¯ä¸ªqueue(åˆ†åŒº)æœ‰åº System.out.println(&quot;consumeThread=&quot; + Thread.currentThread().getName() + &quot;queueId=&quot; + msg.getQueueId() + &quot;, content:&quot; + new String(msg.getBody())); &#125; return ConsumeOrderlyStatus.SUCCESS; &#125; &#125;); consumer.start(); System.out.println(&quot;Consumer Started.&quot;); &#125;&#125; å»¶æ—¶æ¶ˆæ¯åŸç†è§£æå®šæ—¶æ¶ˆæ¯ï¼ˆå»¶è¿Ÿé˜Ÿåˆ—ï¼‰æ˜¯æŒ‡æ¶ˆæ¯å‘é€åˆ° Broker åï¼Œä¸ä¼šç«‹å³è¢«æ¶ˆè´¹ï¼Œç­‰å¾…ç‰¹å®šæ—¶é—´æŠ•é€’ç»™çœŸæ­£çš„ Topic RocketMQ å¹¶ä¸æ”¯æŒä»»æ„æ—¶é—´çš„å»¶æ—¶ï¼Œéœ€è¦è®¾ç½®å‡ ä¸ªå›ºå®šçš„å»¶æ—¶ç­‰çº§ï¼Œä» 1s åˆ° 2h åˆ†åˆ«å¯¹åº”ç€ç­‰çº§ 1 åˆ° 18ï¼Œæ¶ˆæ¯æ¶ˆè´¹å¤±è´¥ä¼šè¿›å…¥å»¶æ—¶æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¶ˆæ¯å‘é€æ—¶é—´ä¸è®¾ç½®çš„å»¶æ—¶ç­‰çº§å’Œé‡è¯•æ¬¡æ•°æœ‰å…³ï¼Œè¯¦è§ä»£ç  SendMessageProcessor.java 1private String messageDelayLevel = &quot;1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h&quot;; Broker å¯ä»¥é…ç½® messageDelayLevelï¼Œè¯¥å±æ€§æ˜¯ Broker çš„å±æ€§ï¼Œä¸å±äºæŸä¸ª Topic å‘æ¶ˆæ¯æ—¶ï¼Œå¯ä»¥è®¾ç½®å»¶è¿Ÿç­‰çº§ msg.setDelayLevel(level)ï¼Œlevel æœ‰ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š level &#x3D;&#x3D; 0ï¼šæ¶ˆæ¯ä¸ºéå»¶è¿Ÿæ¶ˆæ¯ 1&lt;&#x3D;level&lt;&#x3D;maxLevelï¼šæ¶ˆæ¯å»¶è¿Ÿç‰¹å®šæ—¶é—´ï¼Œä¾‹å¦‚ level&#x3D;&#x3D;1ï¼Œå»¶è¿Ÿ 1s level &gt; maxLevelï¼šåˆ™ level&#x3D;&#x3D; maxLevelï¼Œä¾‹å¦‚ level&#x3D;&#x3D;20ï¼Œå»¶è¿Ÿ 2h å®šæ—¶æ¶ˆæ¯ä¼šæš‚å­˜åœ¨åä¸º SCHEDULE_TOPIC_XXXX çš„ Topic ä¸­ï¼Œå¹¶æ ¹æ® delayTimeLevel å­˜å…¥ç‰¹å®šçš„ queueï¼Œé˜Ÿåˆ—çš„æ ‡è¯† queueId = delayTimeLevel â€“ 1ï¼Œå³ä¸€ä¸ª queue åªå­˜ç›¸åŒå»¶è¿Ÿçš„æ¶ˆæ¯ï¼Œä¿è¯å…·æœ‰ç›¸åŒå‘é€å»¶è¿Ÿçš„æ¶ˆæ¯èƒ½å¤Ÿé¡ºåºæ¶ˆè´¹ã€‚Broker ä¼šä¸ºæ¯ä¸ªå»¶è¿Ÿçº§åˆ«æäº¤ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œè°ƒåº¦åœ°æ¶ˆè´¹ SCHEDULE_TOPIC_XXXXï¼Œå°†æ¶ˆæ¯å†™å…¥çœŸå®çš„ Topic æ³¨æ„ï¼šå®šæ—¶æ¶ˆæ¯åœ¨ç¬¬ä¸€æ¬¡å†™å…¥å’Œè°ƒåº¦å†™å…¥çœŸå® Topic æ—¶éƒ½ä¼šè®¡æ•°ï¼Œå› æ­¤å‘é€æ•°é‡ã€tps éƒ½ä¼šå˜é«˜ ä»£ç å®ç°æäº¤äº†ä¸€ä¸ªè®¢å•å°±å¯ä»¥å‘é€ä¸€ä¸ªå»¶æ—¶æ¶ˆæ¯ï¼Œ1h åå»æ£€æŸ¥è¿™ä¸ªè®¢å•çš„çŠ¶æ€ï¼Œå¦‚æœè¿˜æ˜¯æœªä»˜æ¬¾å°±å–æ¶ˆè®¢å•é‡Šæ”¾åº“å­˜ 12345678910111213141516171819public class ScheduledMessageProducer &#123; public static void main(String[] args) throws Exception &#123; // å®ä¾‹åŒ–ä¸€ä¸ªç”Ÿäº§è€…æ¥äº§ç”Ÿå»¶æ—¶æ¶ˆæ¯ DefaultMQProducer producer = new DefaultMQProducer(&quot;ExampleProducerGroup&quot;); producer.setNamesrvAddr(&quot;127.0.0.1:9876&quot;); // å¯åŠ¨ç”Ÿäº§è€… producer.start(); int totalMessagesToSend = 100; for (int i = 0; i &lt; totalMessagesToSend; i++) &#123; Message message = new Message(&quot;DelayTopic&quot;, (&quot;Hello scheduled message &quot; + i).getBytes()); // è®¾ç½®å»¶æ—¶ç­‰çº§3,è¿™ä¸ªæ¶ˆæ¯å°†åœ¨10sä¹‹åå‘é€(ç°åœ¨åªæ”¯æŒå›ºå®šçš„å‡ ä¸ªæ—¶é—´,è¯¦çœ‹delayTimeLevel) message.setDelayTimeLevel(3); // å‘é€æ¶ˆæ¯ producer.send(message); &#125; // å…³é—­ç”Ÿäº§è€… producer.shutdown(); &#125;&#125; 123456789101112131415161718192021public class ScheduledMessageConsumer &#123; public static void main(String[] args) throws Exception &#123; // å®ä¾‹åŒ–æ¶ˆè´¹è€… DefaultMQPushConsumer consumer = new DefaultMQPushConsumer(&quot;ExampleConsumer&quot;); consumer.setNamesrvAddr(&quot;127.0.0.1:9876&quot;); // è®¢é˜…Topics consumer.subscribe(&quot;DelayTopic&quot;, &quot;*&quot;); // æ³¨å†Œæ¶ˆæ¯ç›‘å¬è€… consumer.registerMessageListener(new MessageListenerConcurrently() &#123; @Override public ConsumeConcurrentlyStatus consumeMessage(List&lt;MessageExt&gt; messages, ConsumeConcurrentlyContext context) &#123; for (MessageExt message : messages) &#123; // æ‰“å°å»¶è¿Ÿçš„æ—¶é—´æ®µ System.out.println(&quot;Receive message[msgId=&quot; + message.getMsgId() + &quot;] &quot; + (System.currentTimeMillis() - message.getBornTimestamp()) + &quot;ms later&quot;);&#125; return ConsumeConcurrentlyStatus.CONSUME_SUCCESS; &#125; &#125;); // å¯åŠ¨æ¶ˆè´¹è€… consumer.start(); &#125;&#125; æ‰¹é‡æ¶ˆæ¯æ‰¹é‡å‘é€æ¶ˆæ¯èƒ½æ˜¾è‘—æé«˜ä¼ é€’å°æ¶ˆæ¯çš„æ€§èƒ½ï¼Œé™åˆ¶æ˜¯è¿™äº›æ‰¹é‡æ¶ˆæ¯åº”è¯¥æœ‰ç›¸åŒçš„ topicï¼Œç›¸åŒçš„ waitStoreMsgOKï¼Œè€Œä¸”ä¸èƒ½æ˜¯å»¶æ—¶æ¶ˆæ¯ï¼Œå¹¶ä¸”è¿™ä¸€æ‰¹æ¶ˆæ¯çš„æ€»å¤§å°ä¸åº”è¶…è¿‡ 4MB 12345678910111213141516171819202122232425public class Producer &#123; public static void main(String[] args) throws Exception &#123; DefaultMQProducer producer = new DefaultMQProducer(&quot;ExampleProducerGroup&quot;) producer.setNamesrvAddr(&quot;127.0.0.1:9876&quot;); //å¯åŠ¨producer producer.start(); List&lt;Message&gt; msgs = new ArrayList&lt;Message&gt;(); // åˆ›å»ºæ¶ˆæ¯å¯¹è±¡ï¼ŒæŒ‡å®šä¸»é¢˜Topicã€Tagå’Œæ¶ˆæ¯ä½“ Message msg1 = new Message(&quot;BatchTopic&quot;, &quot;Tag1&quot;, (&quot;Hello World&quot; + 1).getBytes()); Message msg2 = new Message(&quot;BatchTopic&quot;, &quot;Tag1&quot;, (&quot;Hello World&quot; + 2).getBytes()); Message msg3 = new Message(&quot;BatchTopic&quot;, &quot;Tag1&quot;, (&quot;Hello World&quot; + 3).getBytes()); msgs.add(msg1); msgs.add(msg2); msgs.add(msg3); // å‘é€æ¶ˆæ¯ SendResult result = producer.send(msgs); System.out.println(&quot;å‘é€ç»“æœ:&quot; + result); // å…³é—­ç”Ÿäº§è€…producer producer.shutdown(); &#125;&#125; å½“å‘é€å¤§æ‰¹é‡æ•°æ®æ—¶ï¼Œå¯èƒ½ä¸ç¡®å®šæ¶ˆæ¯æ˜¯å¦è¶…è¿‡äº†å¤§å°é™åˆ¶ï¼ˆ4MBï¼‰ï¼Œæ‰€ä»¥éœ€è¦å°†æ¶ˆæ¯åˆ—è¡¨åˆ†å‰²ä¸€ä¸‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869public class ListSplitter implements Iterator&lt;List&lt;Message&gt;&gt; &#123; private final int SIZE_LIMIT = 1024 * 1024 * 4; private final List&lt;Message&gt; messages; private int currIndex; public ListSplitter(List&lt;Message&gt; messages) &#123; this.messages = messages; &#125; @Override public boolean hasNext() &#123; return currIndex &lt; messages.size(); &#125; @Override public List&lt;Message&gt; next() &#123; int startIndex = getStartIndex(); int nextIndex = startIndex; int totalSize = 0; for (; nextIndex &lt; messages.size(); nextIndex++) &#123; Message message = messages.get(nextIndex); int tmpSize = calcMessageSize(message); // å•ä¸ªæ¶ˆæ¯è¶…è¿‡äº†æœ€å¤§çš„é™åˆ¶ if (tmpSize + totalSize &gt; SIZE_LIMIT) &#123; break; &#125; else &#123; totalSize += tmpSize; &#125; &#125; List&lt;Message&gt; subList = messages.subList(startIndex, nextIndex); currIndex = nextIndex; return subList; &#125; private int getStartIndex() &#123; Message currMessage = messages.get(currIndex); int tmpSize = calcMessageSize(currMessage); while (tmpSize &gt; SIZE_LIMIT) &#123; currIndex += 1; Message message = messages.get(curIndex); tmpSize = calcMessageSize(message); &#125; return currIndex; &#125; private int calcMessageSize(Message message) &#123; int tmpSize = message.getTopic().length() + message.getBody().length; Map&lt;String, String&gt; properties = message.getProperties(); for (Map.Entry&lt;String, String&gt; entry : properties.entrySet()) &#123; tmpSize += entry.getKey().length() + entry.getValue().length(); &#125; tmpSize = tmpSize + 20; // å¢åŠ â½‡æ—¥å¿—çš„å¼€é”€20å­—èŠ‚ return tmpSize; &#125; public static void main(String[] args) &#123; //æŠŠå¤§çš„æ¶ˆæ¯åˆ†è£‚æˆè‹¥å¹²ä¸ªå°çš„æ¶ˆæ¯ ListSplitter splitter = new ListSplitter(messages); while (splitter.hasNext()) &#123; try &#123; List&lt;Message&gt; listItem = splitter.next(); producer.send(listItem); &#125; catch (Exception e) &#123; e.printStackTrace(); //å¤„ç†error &#125; &#125; &#125;&#125; è¿‡æ»¤æ¶ˆæ¯åŸºæœ¬è¯­æ³•RocketMQ å®šä¹‰äº†ä¸€äº›åŸºæœ¬è¯­æ³•æ¥æ”¯æŒè¿‡æ»¤ç‰¹æ€§ï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°æ‰©å±•ï¼š æ•°å€¼æ¯”è¾ƒï¼Œæ¯”å¦‚ï¼š&gt;ï¼Œ&gt;&#x3D;ï¼Œ&lt;ï¼Œ&lt;&#x3D;ï¼ŒBETWEENï¼Œ&#x3D; å­—ç¬¦æ¯”è¾ƒï¼Œæ¯”å¦‚ï¼š&#x3D;ï¼Œ&lt;&gt;ï¼ŒIN IS NULL æˆ–è€… IS NOT NULL é€»è¾‘ç¬¦å· ANDï¼ŒORï¼ŒNOT å¸¸é‡æ”¯æŒç±»å‹ä¸ºï¼š æ•°å€¼ï¼Œæ¯”å¦‚ 123ï¼Œ3.1415 å­—ç¬¦ï¼Œæ¯”å¦‚ â€˜abcâ€™ï¼Œå¿…é¡»ç”¨å•å¼•å·åŒ…è£¹èµ·æ¥ NULLï¼Œç‰¹æ®Šçš„å¸¸é‡ å¸ƒå°”å€¼ï¼ŒTRUE æˆ– FALSE åªæœ‰ä½¿ç”¨ push æ¨¡å¼çš„æ¶ˆè´¹è€…æ‰èƒ½ç”¨ä½¿ç”¨ SQL92 æ ‡å‡†çš„ sql è¯­å¥ï¼Œæ¥å£å¦‚ä¸‹ï¼š 1public void subscribe(final String topic, final MessageSelector messageSelector) ä¾‹å¦‚ï¼šæ¶ˆè´¹è€…æ¥æ”¶åŒ…å« TAGA æˆ– TAGB æˆ– TAGC çš„æ¶ˆæ¯ 12DefaultMQPushConsumer consumer = new DefaultMQPushConsumer(&quot;CID_EXAMPLE&quot;);consumer.subscribe(&quot;TOPIC&quot;, &quot;TAGA || TAGB || TAGC&quot;); åŸç†è§£æRocketMQ åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆæ¯è¿‡æ»¤æ–¹å¼æ˜¯åœ¨ Consumer ç«¯è®¢é˜…æ¶ˆæ¯æ—¶å†åšæ¶ˆæ¯è¿‡æ»¤çš„ï¼Œæ‰€ä»¥æ˜¯åœ¨ Broker ç«¯å®ç°çš„ï¼Œä¼˜ç‚¹æ˜¯å‡å°‘äº†å¯¹äº Consumer æ— ç”¨æ¶ˆæ¯çš„ç½‘ç»œä¼ è¾“ï¼Œç¼ºç‚¹æ˜¯å¢åŠ äº† Broker çš„è´Ÿæ‹…ï¼Œè€Œä¸”å®ç°ç›¸å¯¹å¤æ‚ RocketMQ åœ¨ Producer ç«¯å†™å…¥æ¶ˆæ¯å’Œåœ¨ Consumer ç«¯è®¢é˜…æ¶ˆæ¯é‡‡ç”¨åˆ†ç¦»å­˜å‚¨çš„æœºåˆ¶å®ç°ï¼ŒConsumer ç«¯è®¢é˜…æ¶ˆæ¯æ˜¯éœ€è¦é€šè¿‡ ConsumeQueue è¿™ä¸ªæ¶ˆæ¯æ¶ˆè´¹çš„é€»è¾‘é˜Ÿåˆ—æ‹¿åˆ°ä¸€ä¸ªç´¢å¼•ï¼Œç„¶åå†ä» CommitLog é‡Œé¢è¯»å–çœŸæ­£çš„æ¶ˆæ¯å®ä½“å†…å®¹ ConsumeQueue çš„å­˜å‚¨ç»“æ„å¦‚ä¸‹ï¼Œæœ‰ 8 ä¸ªå­—èŠ‚å­˜å‚¨çš„ Message Tag çš„å“ˆå¸Œå€¼ï¼ŒåŸºäº Tag çš„æ¶ˆæ¯è¿‡æ»¤å°±æ˜¯åŸºäºè¿™ä¸ªå­—æ®µ Tag è¿‡æ»¤ï¼šConsumer ç«¯è®¢é˜…æ¶ˆæ¯æ—¶æŒ‡å®š Topic å’Œ TAGï¼Œç„¶åå°†è®¢é˜…è¯·æ±‚æ„å»ºæˆä¸€ä¸ª SubscriptionDataï¼Œå‘é€ä¸€ä¸ª Pull æ¶ˆæ¯çš„è¯·æ±‚ç»™ Broker ç«¯ã€‚Broker ç«¯ç”¨è¿™äº›æ•°æ®å…ˆæ„å»ºä¸€ä¸ª MessageFilterï¼Œç„¶åä¼ ç»™æ–‡ä»¶å­˜å‚¨å±‚ Storeã€‚Store ä» ConsumeQueue è¯»å–åˆ°ä¸€æ¡è®°å½•åï¼Œä¼šç”¨å®ƒè®°å½•çš„æ¶ˆæ¯ tag hash å€¼å»åšè¿‡æ»¤ã€‚å› ä¸ºåœ¨æœåŠ¡ç«¯åªæ˜¯æ ¹æ® hashcode è¿›è¡Œåˆ¤æ–­ï¼Œæ— æ³•ç²¾ç¡®å¯¹ tag åŸå§‹å­—ç¬¦ä¸²è¿›è¡Œè¿‡æ»¤ï¼Œæ‰€ä»¥æ¶ˆè´¹ç«¯æ‹‰å–åˆ°æ¶ˆæ¯åï¼Œè¿˜éœ€è¦å¯¹æ¶ˆæ¯çš„åŸå§‹ tag å­—ç¬¦ä¸²è¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœä¸åŒï¼Œåˆ™ä¸¢å¼ƒè¯¥æ¶ˆæ¯ï¼Œä¸è¿›è¡Œæ¶ˆæ¯æ¶ˆè´¹ SQL92 è¿‡æ»¤ï¼šå·¥ä½œæµç¨‹å’Œ Tag è¿‡æ»¤å¤§è‡´ä¸€æ ·ï¼Œåªæ˜¯åœ¨ Store å±‚çš„å…·ä½“è¿‡æ»¤æ–¹å¼ä¸ä¸€æ ·ã€‚çœŸæ­£çš„ SQL expression çš„æ„å»ºå’Œæ‰§è¡Œç”± rocketmq-filter æ¨¡å—è´Ÿè´£ï¼Œæ¯æ¬¡è¿‡æ»¤éƒ½å»æ‰§è¡Œ SQL è¡¨è¾¾å¼ä¼šå½±å“æ•ˆç‡ï¼Œæ‰€ä»¥ RocketMQ ä½¿ç”¨äº† BloomFilter æ¥é¿å…äº†æ¯æ¬¡éƒ½å»æ‰§è¡Œ ä»£ç å®ç°å‘é€æ¶ˆæ¯æ—¶ï¼Œé€šè¿‡ putUserProperty æ¥è®¾ç½®æ¶ˆæ¯çš„å±æ€§ï¼ŒSQL92 çš„è¡¨è¾¾å¼ä¸Šä¸‹æ–‡ä¸ºæ¶ˆæ¯çš„å±æ€§ 123456789101112131415public class Producer &#123; public static void main(String[] args) throws Exception &#123; DefaultMQProducer producer = new DefaultMQProducer(&quot;please_rename_unique_group_name&quot;); producer.setNamesrvAddr(&quot;127.0.0.1:9876&quot;); producer.start(); for (int i = 0; i &lt; 10; i++) &#123; Message msg = new Message(&quot;FilterTopic&quot;, &quot;tag&quot;, (&quot;Hello RocketMQ &quot; + i).getBytes(RemotingHelper.DEFAULT_CHARSET)); // è®¾ç½®ä¸€äº›å±æ€§ msg.putUserProperty(&quot;i&quot;, String.valueOf(i)); SendResult sendResult = producer.send(msg); &#125; producer.shutdown(); &#125;&#125; ä½¿ç”¨ SQL ç­›é€‰è¿‡æ»¤æ¶ˆæ¯ï¼š 12345678910111213141516171819202122public class Consumer &#123; public static void main(String[] args) throws Exception &#123; DefaultMQPushConsumer consumer = new DefaultMQPushConsumer(&quot;please_rename_unique_group_name&quot;); consumer.setNamesrvAddr(&quot;127.0.0.1:9876&quot;); // è¿‡æ»¤å±æ€§å¤§äº 5 çš„æ¶ˆæ¯ consumer.subscribe(&quot;FilterTopic&quot;, MessageSelector.bySql(&quot;i&gt;5&quot;)); // è®¾ç½®å›è°ƒå‡½æ•°ï¼Œå¤„ç†æ¶ˆæ¯ consumer.registerMessageListener(new MessageListenerConcurrently() &#123; //æ¥å—æ¶ˆæ¯å†…å®¹ @Override public ConsumeConcurrentlyStatus consumeMessage(List&lt;MessageExt&gt; msgs, ConsumeConcurrentlyContext context) &#123; for (MessageExt msg : msgs) &#123; System.out.println(&quot;consumeThread=&quot; + Thread.currentThread().getName() + &quot;,&quot; + new String(msg.getBody())); &#125; return ConsumeConcurrentlyStatus.CONSUME_SUCCESS; &#125; &#125;); // å¯åŠ¨æ¶ˆè´¹è€…consumer consumer.start(); &#125;&#125; äº‹åŠ¡æ¶ˆæ¯å·¥ä½œæµç¨‹RocketMQ æ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡æ¶ˆæ¯ï¼Œé‡‡ç”¨äº† 2PC çš„æ€æƒ³æ¥å®ç°äº†æäº¤äº‹åŠ¡æ¶ˆæ¯ï¼ŒåŒæ—¶å¢åŠ ä¸€ä¸ªè¡¥å¿é€»è¾‘æ¥å¤„ç†äºŒé˜¶æ®µè¶…æ—¶æˆ–è€…å¤±è´¥çš„æ¶ˆæ¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š äº‹åŠ¡æ¶ˆæ¯çš„å¤§è‡´æ–¹æ¡ˆåˆ†ä¸ºä¸¤ä¸ªæµç¨‹ï¼šæ­£å¸¸äº‹åŠ¡æ¶ˆæ¯çš„å‘é€åŠæäº¤ã€äº‹åŠ¡æ¶ˆæ¯çš„è¡¥å¿æµç¨‹ äº‹åŠ¡æ¶ˆæ¯å‘é€åŠæäº¤ï¼š å‘é€æ¶ˆæ¯ï¼ˆHalf æ¶ˆæ¯ï¼‰ï¼ŒæœåŠ¡å™¨å°†æ¶ˆæ¯çš„ä¸»é¢˜å’Œé˜Ÿåˆ—æ”¹ä¸ºåŠæ¶ˆæ¯çŠ¶æ€ï¼Œå¹¶æ”¾å…¥åŠæ¶ˆæ¯é˜Ÿåˆ— æœåŠ¡ç«¯å“åº”æ¶ˆæ¯å†™å…¥ç»“æœï¼ˆå¦‚æœå†™å…¥å¤±è´¥ï¼Œæ­¤æ—¶ Half æ¶ˆæ¯å¯¹ä¸šåŠ¡ä¸å¯è§ï¼‰ æ ¹æ®å‘é€ç»“æœæ‰§è¡Œæœ¬åœ°äº‹åŠ¡ æ ¹æ®æœ¬åœ°äº‹åŠ¡çŠ¶æ€æ‰§è¡Œ Commit æˆ–è€… Rollback è¡¥å¿æœºåˆ¶ï¼šç”¨äºè§£å†³æ¶ˆæ¯ Commit æˆ–è€… Rollback å‘ç”Ÿè¶…æ—¶æˆ–è€…å¤±è´¥çš„æƒ…å†µï¼Œæ¯”å¦‚å‡ºç°ç½‘ç»œé—®é¢˜ Broker æœåŠ¡ç«¯é€šè¿‡å¯¹æ¯” Half æ¶ˆæ¯å’Œ Op æ¶ˆæ¯ï¼Œå¯¹æœªç¡®å®šçŠ¶æ€çš„æ¶ˆæ¯æ¨è¿› CheckPoint æ²¡æœ‰ Commit&#x2F;Rollback çš„äº‹åŠ¡æ¶ˆæ¯ï¼ŒæœåŠ¡ç«¯æ ¹æ®æ ¹æ®åŠæ¶ˆæ¯çš„ç”Ÿäº§è€…ç»„ï¼Œåˆ° ProducerManager ä¸­è·å–ç”Ÿäº§è€…ï¼ˆåŒä¸€ä¸ª Group çš„ Producerï¼‰çš„ä¼šè¯é€šé“ï¼Œå‘èµ·ä¸€æ¬¡å›æŸ¥ï¼ˆå•å‘è¯·æ±‚ï¼‰ Producer æ”¶åˆ°å›æŸ¥æ¶ˆæ¯ï¼Œæ£€æŸ¥äº‹åŠ¡æ¶ˆæ¯çŠ¶æ€è¡¨å†…å¯¹åº”çš„æœ¬åœ°äº‹åŠ¡çš„çŠ¶æ€ æ ¹æ®æœ¬åœ°äº‹åŠ¡çŠ¶æ€ï¼Œé‡æ–° Commit æˆ–è€… Rollback RocketMQ å¹¶ä¸ä¼šæ— ä¼‘æ­¢çš„è¿›è¡Œäº‹åŠ¡çŠ¶æ€å›æŸ¥ï¼Œæœ€å¤§å›æŸ¥ 15 æ¬¡ï¼Œå¦‚æœ 15 æ¬¡å›æŸ¥è¿˜æ˜¯æ— æ³•å¾—çŸ¥äº‹åŠ¡çŠ¶æ€ï¼Œåˆ™é»˜è®¤å›æ»šè¯¥æ¶ˆæ¯ï¼Œ å›æŸ¥æœåŠ¡ï¼šTransactionalMessageCheckService#run ä¸¤é˜¶æ®µä¸€é˜¶æ®µäº‹åŠ¡æ¶ˆæ¯ç›¸å¯¹æ™®é€šæ¶ˆæ¯æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯ä¸€é˜¶æ®µå‘é€çš„æ¶ˆæ¯å¯¹ç”¨æˆ·æ˜¯ä¸å¯è§çš„ï¼Œå› ä¸ºå¯¹äº Half æ¶ˆæ¯ï¼Œä¼šå¤‡ä»½åŸæ¶ˆæ¯çš„ä¸»é¢˜ä¸æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ï¼Œç„¶åæ”¹å˜ä¸»é¢˜ä¸º RMQ_SYS_TRANS_HALF_TOPICï¼Œç”±äºæ¶ˆè´¹ç»„æœªè®¢é˜…è¯¥ä¸»é¢˜ï¼Œæ•…æ¶ˆè´¹ç«¯æ— æ³•æ¶ˆè´¹ Half ç±»å‹çš„æ¶ˆæ¯ RocketMQ ä¼šå¼€å¯ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œä» Topic ä¸º RMQ_SYS_TRANS_HALF_TOPIC ä¸­æ‹‰å–æ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹ï¼Œæ ¹æ®ç”Ÿäº§è€…ç»„è·å–ä¸€ä¸ªæœåŠ¡æä¾›è€…å‘é€å›æŸ¥äº‹åŠ¡çŠ¶æ€è¯·æ±‚ï¼Œæ ¹æ®äº‹åŠ¡çŠ¶æ€æ¥å†³å®šæ˜¯æäº¤æˆ–å›æ»šæ¶ˆæ¯ RocketMQ çš„å…·ä½“å®ç°ç­–ç•¥ï¼šå¦‚æœå†™å…¥çš„æ˜¯äº‹åŠ¡æ¶ˆæ¯ï¼Œå¯¹æ¶ˆæ¯çš„ Topic å’Œ Queue ç­‰å±æ€§è¿›è¡Œæ›¿æ¢ï¼ŒåŒæ—¶å°†åŸæ¥çš„ Topic å’Œ Queue ä¿¡æ¯å­˜å‚¨åˆ°æ¶ˆæ¯çš„å±æ€§ä¸­ï¼Œå› ä¸ºæ¶ˆæ¯çš„ä¸»é¢˜è¢«æ›¿æ¢ï¼Œæ‰€ä»¥æ¶ˆæ¯ä¸ä¼šè½¬å‘åˆ°è¯¥åŸä¸»é¢˜çš„æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…æ— æ³•æ„ŸçŸ¥æ¶ˆæ¯çš„å­˜åœ¨ï¼Œä¸ä¼šæ¶ˆè´¹ äºŒé˜¶æ®µä¸€é˜¶æ®µå†™å…¥ä¸å¯è§çš„æ¶ˆæ¯åï¼ŒäºŒé˜¶æ®µæ“ä½œï¼š å¦‚æœæ‰§è¡Œ Commit æ“ä½œï¼Œåˆ™éœ€è¦è®©æ¶ˆæ¯å¯¹ç”¨æˆ·å¯è§ï¼Œæ„å»ºå‡º Half æ¶ˆæ¯çš„ç´¢å¼•ã€‚ä¸€é˜¶æ®µçš„ Half æ¶ˆæ¯å†™åˆ°ä¸€ä¸ªç‰¹æ®Šçš„ Topicï¼Œæ„å»ºç´¢å¼•æ—¶éœ€è¦è¯»å–å‡º Half æ¶ˆæ¯ï¼Œç„¶åé€šè¿‡ä¸€æ¬¡æ™®é€šæ¶ˆæ¯çš„å†™å…¥æ“ä½œå°† Topic å’Œ Queue æ›¿æ¢æˆçœŸæ­£çš„ç›®æ ‡ Topic å’Œ Queueï¼Œç”Ÿæˆä¸€æ¡å¯¹ç”¨æˆ·å¯è§çš„æ¶ˆæ¯ã€‚å…¶å®å°±æ˜¯åˆ©ç”¨äº†ä¸€é˜¶æ®µå­˜å‚¨çš„æ¶ˆæ¯çš„å†…å®¹ï¼Œåœ¨äºŒé˜¶æ®µæ—¶æ¢å¤å‡ºä¸€æ¡å®Œæ•´çš„æ™®é€šæ¶ˆæ¯ï¼Œç„¶åèµ°ä¸€éæ¶ˆæ¯å†™å…¥æµç¨‹ å¦‚æœæ˜¯ Rollback åˆ™éœ€è¦æ’¤é”€ä¸€é˜¶æ®µçš„æ¶ˆæ¯ï¼Œå› ä¸ºæ¶ˆæ¯æœ¬å°±ä¸å¯è§ï¼Œæ‰€ä»¥å¹¶ä¸éœ€è¦çœŸæ­£æ’¤é”€æ¶ˆæ¯ï¼ˆå®é™…ä¸Š RocketMQ ä¹Ÿæ— æ³•å»åˆ é™¤ä¸€æ¡æ¶ˆæ¯ï¼Œå› ä¸ºæ˜¯é¡ºåºå†™æ–‡ä»¶çš„ï¼‰ã€‚RocketMQ ä¸ºäº†åŒºåˆ†è¿™æ¡æ¶ˆæ¯æ²¡æœ‰ç¡®å®šçŠ¶æ€çš„æ¶ˆæ¯ï¼Œé‡‡ç”¨ Op æ¶ˆæ¯æ ‡è¯†å·²ç»ç¡®å®šçŠ¶æ€çš„äº‹åŠ¡æ¶ˆæ¯ï¼ˆCommit æˆ–è€… Rollbackï¼‰ äº‹åŠ¡æ¶ˆæ¯æ— è®ºæ˜¯ Commit æˆ–è€… Rollback éƒ½ä¼šè®°å½•ä¸€ä¸ª Op æ“ä½œï¼Œä¸¤è€…çš„åŒºåˆ«æ˜¯ Commit ç›¸å¯¹äº Rollback åœ¨å†™å…¥ Op æ¶ˆæ¯å‰å°†åŸæ¶ˆæ¯çš„ä¸»é¢˜å’Œé˜Ÿåˆ—æ¢å¤ã€‚å¦‚æœä¸€æ¡äº‹åŠ¡æ¶ˆæ¯æ²¡æœ‰å¯¹åº”çš„ Op æ¶ˆæ¯ï¼Œè¯´æ˜è¿™ä¸ªäº‹åŠ¡çš„çŠ¶æ€è¿˜æ— æ³•ç¡®å®šï¼ˆå¯èƒ½æ˜¯äºŒé˜¶æ®µå¤±è´¥äº†ï¼‰ RocketMQ å°† Op æ¶ˆæ¯å†™å…¥åˆ°å…¨å±€ä¸€ä¸ªç‰¹å®šçš„ Topic ä¸­ï¼Œé€šè¿‡æºç ä¸­çš„æ–¹æ³• TransactionalMessageUtil.buildOpTopic()ï¼Œè¿™ä¸ªä¸»é¢˜æ˜¯ä¸€ä¸ªå†…éƒ¨çš„ Topicï¼ˆåƒ Half æ¶ˆæ¯çš„ Topic ä¸€æ ·ï¼‰ï¼Œä¸ä¼šè¢«ç”¨æˆ·æ¶ˆè´¹ã€‚Op æ¶ˆæ¯çš„å†…å®¹ä¸ºå¯¹åº”çš„ Half æ¶ˆæ¯çš„å­˜å‚¨çš„ Offsetï¼Œè¿™æ ·é€šè¿‡ Op æ¶ˆæ¯èƒ½ç´¢å¼•åˆ° Half æ¶ˆæ¯ åŸºæœ¬ä½¿ç”¨ä½¿ç”¨æ–¹å¼äº‹åŠ¡æ¶ˆæ¯å…±æœ‰ä¸‰ç§çŠ¶æ€ï¼Œæäº¤çŠ¶æ€ã€å›æ»šçŠ¶æ€ã€ä¸­é—´çŠ¶æ€ï¼š TransactionStatus.CommitTransactionï¼šæäº¤äº‹åŠ¡ï¼Œå…è®¸æ¶ˆè´¹è€…æ¶ˆè´¹æ­¤æ¶ˆæ¯ã€‚ TransactionStatus.RollbackTransactionï¼šå›æ»šäº‹åŠ¡ï¼Œä»£è¡¨è¯¥æ¶ˆæ¯å°†è¢«åˆ é™¤ï¼Œä¸å…è®¸è¢«æ¶ˆè´¹ TransactionStatus.Unknownï¼šä¸­é—´çŠ¶æ€ï¼Œä»£è¡¨éœ€è¦æ£€æŸ¥æ¶ˆæ¯é˜Ÿåˆ—æ¥ç¡®å®šçŠ¶æ€ ä½¿ç”¨é™åˆ¶ï¼š äº‹åŠ¡æ¶ˆæ¯ä¸æ”¯æŒå»¶æ—¶æ¶ˆæ¯å’Œæ‰¹é‡æ¶ˆæ¯ Broker é…ç½®æ–‡ä»¶ä¸­çš„å‚æ•° transactionTimeout ä¸ºç‰¹å®šæ—¶é—´ï¼Œäº‹åŠ¡æ¶ˆæ¯å°†åœ¨ç‰¹å®šæ—¶é—´é•¿åº¦ä¹‹åè¢«æ£€æŸ¥ã€‚å½“å‘é€äº‹åŠ¡æ¶ˆæ¯æ—¶ï¼Œè¿˜å¯ä»¥é€šè¿‡è®¾ç½®ç”¨æˆ·å±æ€§ CHECK_IMMUNITY_TIME_IN_SECONDS æ¥æ”¹å˜è¿™ä¸ªé™åˆ¶ï¼Œè¯¥å‚æ•°ä¼˜å…ˆäº transactionTimeout å‚æ•° ä¸ºäº†é¿å…å•ä¸ªæ¶ˆæ¯è¢«æ£€æŸ¥å¤ªå¤šæ¬¡è€Œå¯¼è‡´åŠé˜Ÿåˆ—æ¶ˆæ¯ç´¯ç§¯ï¼Œé»˜è®¤å°†å•ä¸ªæ¶ˆæ¯çš„æ£€æŸ¥æ¬¡æ•°é™åˆ¶ä¸º 15 æ¬¡ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡ Broker é…ç½®æ–‡ä»¶çš„ transactionCheckMax å‚æ•°æ¥ä¿®æ”¹æ­¤é™åˆ¶ã€‚å¦‚æœå·²ç»æ£€æŸ¥æŸæ¡æ¶ˆæ¯è¶…è¿‡ N æ¬¡ï¼ˆN &#x3D; transactionCheckMaxï¼‰ï¼Œ åˆ™ Broker å°†ä¸¢å¼ƒæ­¤æ¶ˆæ¯ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ä¼šæ‰“å°é”™è¯¯æ—¥å¿—ã€‚å¯ä»¥é€šè¿‡é‡å†™ AbstractTransactionalMessageCheckListener ç±»æ¥ä¿®æ”¹è¿™ä¸ªè¡Œä¸º äº‹åŠ¡æ€§æ¶ˆæ¯å¯èƒ½ä¸æ­¢ä¸€æ¬¡è¢«æ£€æŸ¥æˆ–æ¶ˆè´¹ æäº¤ç»™ç”¨æˆ·çš„ç›®æ ‡ä¸»é¢˜æ¶ˆæ¯å¯èƒ½ä¼šå¤±è´¥ï¼Œå¯ä»¥æŸ¥çœ‹æ—¥å¿—çš„è®°å½•ã€‚äº‹åŠ¡çš„é«˜å¯ç”¨æ€§é€šè¿‡ RocketMQ æœ¬èº«çš„é«˜å¯ç”¨æ€§æœºåˆ¶æ¥ä¿è¯ï¼Œå¦‚æœå¸Œæœ›äº‹åŠ¡æ¶ˆæ¯ä¸ä¸¢å¤±ã€å¹¶ä¸”äº‹åŠ¡å®Œæ•´æ€§å¾—åˆ°ä¿è¯ï¼Œå¯ä»¥ä½¿ç”¨åŒæ­¥çš„åŒé‡å†™å…¥æœºåˆ¶ äº‹åŠ¡æ¶ˆæ¯çš„ç”Ÿäº§è€… ID ä¸èƒ½ä¸å…¶ä»–ç±»å‹æ¶ˆæ¯çš„ç”Ÿäº§è€… ID å…±äº«ã€‚ä¸å…¶ä»–ç±»å‹çš„æ¶ˆæ¯ä¸åŒï¼Œäº‹åŠ¡æ¶ˆæ¯å…è®¸åå‘æŸ¥è¯¢ï¼ŒMQ æœåŠ¡å™¨èƒ½é€šè¿‡æ¶ˆæ¯çš„ç”Ÿäº§è€… ID æŸ¥è¯¢åˆ°æ¶ˆè´¹è€… ä»£ç å®ç°å®ç°äº‹åŠ¡çš„ç›‘å¬æ¥å£ï¼Œå½“å‘é€åŠæ¶ˆæ¯æˆåŠŸæ—¶ï¼š executeLocalTransaction æ–¹æ³•æ¥æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼Œè¿”å›ä¸‰ä¸ªäº‹åŠ¡çŠ¶æ€ä¹‹ä¸€ checkLocalTransaction æ–¹æ³•æ£€æŸ¥æœ¬åœ°äº‹åŠ¡çŠ¶æ€ï¼Œå“åº”æ¶ˆæ¯é˜Ÿåˆ—çš„æ£€æŸ¥è¯·æ±‚ï¼Œè¿”å›ä¸‰ä¸ªäº‹åŠ¡çŠ¶æ€ä¹‹ä¸€ 123456789101112131415161718192021222324252627282930public class TransactionListenerImpl implements TransactionListener &#123; private AtomicInteger transactionIndex = new AtomicInteger(0); private ConcurrentHashMap&lt;String, Integer&gt; localTrans = new ConcurrentHashMap&lt;&gt;(); @Override public LocalTransactionState executeLocalTransaction(Message msg, Object arg) &#123; int value = transactionIndex.getAndIncrement(); int status = value % 3; // å°†äº‹åŠ¡IDå’ŒçŠ¶æ€å­˜å…¥ map é›†åˆ localTrans.put(msg.getTransactionId(), status); return LocalTransactionState.UNKNOW; &#125; @Override public LocalTransactionState checkLocalTransaction(MessageExt msg) &#123; // ä» map é›†åˆè¯»å‡ºå½“å‰äº‹åŠ¡å¯¹åº”çš„çŠ¶æ€ Integer status = localTrans.get(msg.getTransactionId()); if (null != status) &#123; switch (status) &#123; case 0: return LocalTransactionState.UNKNOW; case 1: return LocalTransactionState.COMMIT_MESSAGE; case 2: return LocalTransactionState.ROLLBACK_MESSAGE; &#125; &#125; return LocalTransactionState.COMMIT_MESSAGE; &#125;&#125; ä½¿ç”¨ TransactionMQProducer ç±»åˆ›å»ºäº‹åŠ¡æ€§ç”Ÿäº§è€…ï¼Œå¹¶æŒ‡å®šå”¯ä¸€çš„ ProducerGroupï¼Œå°±å¯ä»¥è®¾ç½®è‡ªå®šä¹‰çº¿ç¨‹æ± æ¥å¤„ç†è¿™äº›æ£€æŸ¥è¯·æ±‚ï¼Œæ‰§è¡Œæœ¬åœ°äº‹åŠ¡åï¼Œéœ€è¦æ ¹æ®æ‰§è¡Œç»“æœå¯¹æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œå›å¤ 123456789101112131415161718192021222324252627282930public class Producer &#123; public static void main(String[] args) throws MQClientException, InterruptedException &#123; // åˆ›å»ºæ¶ˆæ¯ç”Ÿäº§è€… TransactionMQProducer producer = new TransactionMQProducer(&quot;please_rename_unique_group_name&quot;); ExecutorService executorService = new ThreadPoolExecutor(2, 5, 100, TimeUnit.SECONDS); producer.setExecutorService(executorService); // åˆ›å»ºäº‹åŠ¡ç›‘å¬å™¨ TransactionListener transactionListener = new TransactionListenerImpl(); // ç”Ÿäº§è€…çš„ç›‘å¬å™¨ producer.setTransactionListener(transactionListener); // å¯åŠ¨ç”Ÿäº§è€… producer.start(); String[] tags = new String[] &#123;&quot;TagA&quot;, &quot;TagB&quot;, &quot;TagC&quot;, &quot;TagD&quot;, &quot;TagE&quot;&#125;; for (int i = 0; i &lt; 10; i++) &#123; try &#123; Message msg = new Message(&quot;TransactionTopic&quot;, tags[i % tags.length], &quot;KEY&quot; + i, (&quot;Hello RocketMQ &quot; + i).getBytes(RemotingHelper.DEFAULT_CHARSET)); // å‘é€æ¶ˆæ¯ SendResult sendResult = producer.sendMessageInTransaction(msg, null); System.out.printf(&quot;%s%n&quot;, sendResult); Thread.sleep(10); &#125; catch (MQClientException | UnsupportedEncodingException e) &#123; e.printStackTrace(); &#125; &#125; //Thread.sleep(1000000); //producer.shutdown();æš‚æ—¶ä¸å…³é—­ &#125;&#125; æ¶ˆè´¹è€…ä»£ç å’Œå‰é¢çš„å®ä¾‹ç›¸åŒçš„ ç³»ç»Ÿç‰¹æ€§å·¥ä½œæµç¨‹æ¨¡å—ä»‹ç»NameServer æ˜¯ä¸€ä¸ªç®€å•çš„ Topic è·¯ç”±æ³¨å†Œä¸­å¿ƒï¼Œæ”¯æŒ Broker çš„åŠ¨æ€æ³¨å†Œä¸å‘ç°ï¼Œç”Ÿäº§è€…æˆ–æ¶ˆè´¹è€…èƒ½å¤Ÿé€šè¿‡åå­—æœåŠ¡æŸ¥æ‰¾å„ä¸»é¢˜ç›¸åº”çš„ Broker IP åˆ—è¡¨ NameServer ä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªåŠŸèƒ½ï¼š Broker ç®¡ç†ï¼ŒNameServer æ¥å— Broker é›†ç¾¤çš„æ³¨å†Œä¿¡æ¯ï¼Œä¿å­˜ä¸‹æ¥ä½œä¸ºè·¯ç”±ä¿¡æ¯çš„åŸºæœ¬æ•°æ®ï¼Œæä¾›å¿ƒè·³æ£€æµ‹æœºåˆ¶æ£€æŸ¥ Broker æ˜¯å¦è¿˜å­˜æ´»ï¼Œæ¯ 10 ç§’æ¸…é™¤ä¸€æ¬¡ä¸¤å°æ—¶æ²¡æœ‰æ´»è·ƒçš„ Broker è·¯ç”±ä¿¡æ¯ç®¡ç†ï¼Œæ¯ä¸ª NameServer å°†ä¿å­˜å…³äº Broker é›†ç¾¤çš„æ•´ä¸ªè·¯ç”±ä¿¡æ¯å’Œç”¨äºå®¢æˆ·ç«¯æŸ¥è¯¢çš„é˜Ÿåˆ—ä¿¡æ¯ï¼Œç„¶å Producer å’Œ Conumser é€šè¿‡ NameServer å°±å¯ä»¥çŸ¥é“æ•´ä¸ª Broker é›†ç¾¤çš„è·¯ç”±ä¿¡æ¯ï¼Œä»è€Œè¿›è¡Œæ¶ˆæ¯çš„æŠ•é€’å’Œæ¶ˆè´¹ NameServer ç‰¹ç‚¹ï¼š NameServer é€šå¸¸æ˜¯é›†ç¾¤çš„æ–¹å¼éƒ¨ç½²ï¼Œå„å®ä¾‹é—´ç›¸äº’ä¸è¿›è¡Œä¿¡æ¯é€šè®¯ Broker å‘æ¯ä¸€å° NameServerï¼ˆé›†ç¾¤ï¼‰æ³¨å†Œè‡ªå·±çš„è·¯ç”±ä¿¡æ¯ï¼Œæ‰€ä»¥æ¯ä¸ª NameServer å®ä¾‹ä¸Šé¢éƒ½ä¿å­˜ä¸€ä»½å®Œæ•´çš„è·¯ç”±ä¿¡æ¯ å½“æŸä¸ª NameServer å› æŸç§åŸå› ä¸‹çº¿äº†ï¼ŒBroker ä»å¯ä»¥å‘å…¶å®ƒ NameServer åŒæ­¥å…¶è·¯ç”±ä¿¡æ¯ BrokerServer ä¸»è¦è´Ÿè´£æ¶ˆæ¯çš„å­˜å‚¨ã€æŠ•é€’å’ŒæŸ¥è¯¢ä»¥åŠæœåŠ¡é«˜å¯ç”¨ä¿è¯ï¼Œåœ¨ RocketMQ ç³»ç»Ÿä¸­æ¥æ”¶ä»ç”Ÿäº§è€…å‘é€æ¥çš„æ¶ˆæ¯å¹¶å­˜å‚¨ã€åŒæ—¶ä¸ºæ¶ˆè´¹è€…çš„æ‹‰å–è¯·æ±‚ä½œå‡†å¤‡ï¼Œä¹Ÿå­˜å‚¨æ¶ˆæ¯ç›¸å…³çš„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬æ¶ˆè´¹è€…ç»„ã€æ¶ˆè´¹è¿›åº¦åç§»å’Œä¸»é¢˜å’Œé˜Ÿåˆ—æ¶ˆæ¯ç­‰ Broker åŒ…å«äº†ä»¥ä¸‹å‡ ä¸ªé‡è¦å­æ¨¡å—ï¼š Remoting Moduleï¼šæ•´ä¸ª Broker çš„å®ä½“ï¼Œè´Ÿè´£å¤„ç†æ¥è‡ª Clients ç«¯çš„è¯·æ±‚ Client Managerï¼šè´Ÿè´£ç®¡ç†å®¢æˆ·ç«¯ï¼ˆProducer&#x2F;Consumerï¼‰å’Œç»´æŠ¤ Consumer çš„ Topic è®¢é˜…ä¿¡æ¯ Store Serviceï¼šæä¾›æ–¹ä¾¿ç®€å•çš„ API æ¥å£å¤„ç†æ¶ˆæ¯å­˜å‚¨åˆ°ç‰©ç†ç¡¬ç›˜å’ŒæŸ¥è¯¢åŠŸèƒ½ HA Serviceï¼šé«˜å¯ç”¨æœåŠ¡ï¼Œæä¾› Master Broker å’Œ Slave Broker ä¹‹é—´çš„æ•°æ®åŒæ­¥åŠŸèƒ½ Index Serviceï¼šæ ¹æ®ç‰¹å®šçš„ Message key å¯¹æŠ•é€’åˆ° Broker çš„æ¶ˆæ¯è¿›è¡Œç´¢å¼•æœåŠ¡ï¼Œä»¥æä¾›æ¶ˆæ¯çš„å¿«é€ŸæŸ¥è¯¢ æ€»ä½“æµç¨‹RocketMQ çš„å·¥ä½œæµç¨‹ï¼š å¯åŠ¨ NameServer ç›‘å¬ç«¯å£ï¼Œç­‰å¾… Brokerã€Producerã€Consumer è¿ä¸Šæ¥ï¼Œç›¸å½“äºä¸€ä¸ªè·¯ç”±æ§åˆ¶ä¸­å¿ƒ Broker å¯åŠ¨ï¼Œè·Ÿæ‰€æœ‰çš„ NameServer ä¿æŒé•¿è¿æ¥ï¼Œæ¯éš” 30s æ—¶é—´å‘ NameServer ä¸ŠæŠ¥ Topic è·¯ç”±ä¿¡æ¯ï¼ˆå¿ƒè·³åŒ…ï¼‰ã€‚å¿ƒè·³åŒ…ä¸­åŒ…å«å½“å‰ Broker ä¿¡æ¯ï¼ˆIPã€ç«¯å£ç­‰ï¼‰ä»¥åŠå­˜å‚¨æ‰€æœ‰ Topic ä¿¡æ¯ã€‚æ³¨å†ŒæˆåŠŸåï¼ŒNameServer é›†ç¾¤ä¸­å°±æœ‰ Topic è·Ÿ Broker çš„æ˜ å°„å…³ç³» æ”¶å‘æ¶ˆæ¯å‰ï¼Œå…ˆåˆ›å»º Topicï¼Œåˆ›å»º Topic æ—¶éœ€è¦æŒ‡å®šè¯¥ Topic è¦å­˜å‚¨åœ¨å“ªäº› Broker ä¸Šï¼Œä¹Ÿå¯ä»¥åœ¨å‘é€æ¶ˆæ¯æ—¶è‡ªåŠ¨åˆ›å»º Topic Producer å¯åŠ¨æ—¶å…ˆè·Ÿ NameServer é›†ç¾¤ä¸­çš„å…¶ä¸­ä¸€å°å»ºç«‹é•¿è¿æ¥ï¼Œå¹¶ä» NameServer ä¸­è·å–å½“å‰å‘é€çš„ Topic å­˜åœ¨å“ªäº› Broker ä¸Šï¼ŒåŒæ—¶ Producer ä¼šé»˜è®¤æ¯éš” 30s å‘ NameServer å®šæ—¶æ‹‰å–ä¸€æ¬¡è·¯ç”±ä¿¡æ¯ Producer å‘é€æ¶ˆæ¯æ—¶ï¼Œæ ¹æ®æ¶ˆæ¯çš„ Topic ä»æœ¬åœ°ç¼“å­˜çš„ TopicPublishInfoTable è·å–è·¯ç”±ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¼šä» NameServer ä¸Šé‡æ–°æ‹‰å–å¹¶æ›´æ–°ï¼Œè½®è¯¢é˜Ÿåˆ—åˆ—è¡¨å¹¶é€‰æ‹©ä¸€ä¸ªé˜Ÿåˆ— MessageQueueï¼Œç„¶åä¸é˜Ÿåˆ—æ‰€åœ¨çš„ Broker å»ºç«‹é•¿è¿æ¥ï¼Œå‘ Broker å‘æ¶ˆæ¯ Consumer è·Ÿ Producer ç±»ä¼¼ï¼Œè·Ÿå…¶ä¸­ä¸€å° NameServer å»ºç«‹é•¿è¿æ¥ï¼Œå®šæ—¶è·å–è·¯ç”±ä¿¡æ¯ï¼Œæ ¹æ®å½“å‰è®¢é˜… Topic å­˜åœ¨å“ªäº› Broker ä¸Šï¼Œç›´æ¥è·Ÿ Broker å»ºç«‹è¿æ¥é€šé“ï¼Œåœ¨å®Œæˆå®¢æˆ·ç«¯çš„è´Ÿè½½å‡è¡¡åï¼Œé€‰æ‹©å…¶ä¸­çš„æŸä¸€ä¸ªæˆ–è€…æŸå‡ ä¸ª MessageQueue æ¥æ‹‰å–æ¶ˆæ¯å¹¶è¿›è¡Œæ¶ˆè´¹ ç”Ÿäº§æ¶ˆè´¹At least Onceï¼šè‡³å°‘ä¸€æ¬¡ï¼ŒæŒ‡æ¯ä¸ªæ¶ˆæ¯å¿…é¡»æŠ•é€’ä¸€æ¬¡ï¼ŒConsumer å…ˆ Pull æ¶ˆæ¯åˆ°æœ¬åœ°ï¼Œæ¶ˆè´¹å®Œæˆåæ‰å‘æœåŠ¡å™¨è¿”å› ACKï¼Œå¦‚æœæ²¡æœ‰æ¶ˆè´¹ä¸€å®šä¸ä¼š ACK æ¶ˆæ¯ å›æº¯æ¶ˆè´¹ï¼šæŒ‡ Consumer å·²ç»æ¶ˆè´¹æˆåŠŸçš„æ¶ˆæ¯ï¼Œç”±äºä¸šåŠ¡ä¸Šéœ€æ±‚éœ€è¦é‡æ–°æ¶ˆè´¹ï¼ŒBroker åœ¨å‘ Consumer æŠ•é€’æˆåŠŸæ¶ˆæ¯åï¼Œæ¶ˆæ¯ä»ç„¶éœ€è¦ä¿ç•™ã€‚å¹¶ä¸”é‡æ–°æ¶ˆè´¹ä¸€èˆ¬æ˜¯æŒ‰ç…§æ—¶é—´ç»´åº¦ï¼Œä¾‹å¦‚ç”±äº Consumer ç³»ç»Ÿæ•…éšœï¼Œæ¢å¤åéœ€è¦é‡æ–°æ¶ˆè´¹ 1 å°æ—¶å‰çš„æ•°æ®ï¼ŒRocketMQ æ”¯æŒæŒ‰ç…§æ—¶é—´å›æº¯æ¶ˆè´¹ï¼Œæ—¶é—´ç»´åº¦ç²¾ç¡®åˆ°æ¯«ç§’ åˆ†å¸ƒå¼é˜Ÿåˆ—å› ä¸ºæœ‰é«˜å¯é æ€§çš„è¦æ±‚ï¼Œæ‰€ä»¥æ•°æ®è¦è¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨ æ¶ˆæ¯ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ MQ æ”¶åˆ°æ¶ˆæ¯ï¼Œå°†æ¶ˆæ¯è¿›è¡ŒæŒä¹…åŒ–ï¼Œåœ¨å­˜å‚¨ä¸­æ–°å¢ä¸€æ¡è®°å½• è¿”å› ACK ç»™ç”Ÿäº§è€… MQ push æ¶ˆæ¯ç»™å¯¹åº”çš„æ¶ˆè´¹è€…ï¼Œç„¶åç­‰å¾…æ¶ˆè´¹è€…è¿”å› ACK å¦‚æœæ¶ˆæ¯æ¶ˆè´¹è€…åœ¨æŒ‡å®šæ—¶é—´å†…æˆåŠŸè¿”å› ACKï¼Œé‚£ä¹ˆ MQ è®¤ä¸ºæ¶ˆæ¯æ¶ˆè´¹æˆåŠŸï¼Œåœ¨å­˜å‚¨ä¸­åˆ é™¤æ¶ˆæ¯ï¼›å¦‚æœ MQ åœ¨æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ° ACKï¼Œåˆ™è®¤ä¸ºæ¶ˆæ¯æ¶ˆè´¹å¤±è´¥ï¼Œä¼šå°è¯•é‡æ–° push æ¶ˆæ¯ï¼Œé‡å¤æ‰§è¡Œ 4ã€5ã€6 æ­¥éª¤ MQ åˆ é™¤æ¶ˆæ¯ å­˜å‚¨æœºåˆ¶å­˜å‚¨ç»“æ„RocketMQ ä¸­ Broker è´Ÿè´£å­˜å‚¨æ¶ˆæ¯è½¬å‘æ¶ˆæ¯ï¼Œæ‰€ä»¥ä»¥ä¸‹çš„ç»“æ„æ˜¯å­˜å‚¨åœ¨ Broker Server ä¸Šçš„ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¸ Broker è¿›è¡Œæ¶ˆæ¯çš„æ”¶å‘æ˜¯é€šè¿‡ä¸»é¢˜å¯¹åº”çš„ Message Queue å®Œæˆï¼Œç±»ä¼¼äºé€šé“ RocketMQ æ¶ˆæ¯çš„å­˜å‚¨æ˜¯ç”± ConsumeQueue å’Œ CommitLog é…åˆå®Œæˆ çš„ï¼ŒCommitLog æ˜¯æ¶ˆæ¯çœŸæ­£çš„ç‰©ç†å­˜å‚¨æ–‡ä»¶ï¼ŒConsumeQueue æ˜¯æ¶ˆæ¯çš„é€»è¾‘é˜Ÿåˆ—ï¼Œç±»ä¼¼æ•°æ®åº“çš„ç´¢å¼•èŠ‚ç‚¹ï¼Œå­˜å‚¨çš„æ˜¯æŒ‡å‘ç‰©ç†å­˜å‚¨çš„åœ°å€ã€‚æ¯ä¸ª Topic ä¸‹çš„æ¯ä¸ª Message Queue éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ ConsumeQueue æ–‡ä»¶ æ¯æ¡æ¶ˆæ¯éƒ½ä¼šæœ‰å¯¹åº”çš„ç´¢å¼•ä¿¡æ¯ï¼ŒConsumer é€šè¿‡ ConsumeQueue è¿™ä¸ªç»“æ„æ¥è¯»å–æ¶ˆæ¯å®ä½“å†…å®¹ CommitLogï¼šæ¶ˆæ¯ä¸»ä½“ä»¥åŠå…ƒæ•°æ®çš„å­˜å‚¨ä¸»ä½“ï¼Œå­˜å‚¨ Producer ç«¯å†™å…¥çš„æ¶ˆæ¯å†…å®¹ï¼Œæ¶ˆæ¯å†…å®¹ä¸æ˜¯å®šé•¿çš„ã€‚æ¶ˆæ¯ä¸»è¦æ˜¯é¡ºåºå†™å…¥æ—¥å¿—æ–‡ä»¶ï¼Œå•ä¸ªæ–‡ä»¶å¤§å°é»˜è®¤ 1Gï¼Œåç§»é‡ä»£è¡¨ä¸‹ä¸€æ¬¡å†™å…¥çš„ä½ç½®ï¼Œå½“æ–‡ä»¶å†™æ»¡äº†å°±ç»§ç»­å†™å…¥ä¸‹ä¸€ä¸ªæ–‡ä»¶ ConsumerQueueï¼šæ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ï¼Œå­˜å‚¨æ¶ˆæ¯åœ¨ CommitLog çš„ç´¢å¼•ã€‚RocketMQ æ¶ˆæ¯æ¶ˆè´¹æ—¶è¦éå† CommitLog æ–‡ä»¶ï¼Œå¹¶æ ¹æ®ä¸»é¢˜ Topic æ£€ç´¢æ¶ˆæ¯ï¼Œè¿™æ˜¯éå¸¸ä½æ•ˆçš„ã€‚å¼•å…¥ ConsumeQueue ä½œä¸ºæ¶ˆè´¹æ¶ˆæ¯çš„ç´¢å¼•ï¼Œä¿å­˜äº†æŒ‡å®š Topic ä¸‹çš„é˜Ÿåˆ—æ¶ˆæ¯åœ¨ CommitLog ä¸­çš„èµ·å§‹ç‰©ç†åç§»é‡ offsetï¼Œæ¶ˆæ¯å¤§å° size å’Œæ¶ˆæ¯ Tag çš„ HashCode å€¼ï¼Œæ¯ä¸ª ConsumeQueue æ–‡ä»¶å¤§å°çº¦ 5.72M IndexFileï¼šä¸ºäº†æ¶ˆæ¯æŸ¥è¯¢æä¾›äº†ä¸€ç§é€šè¿‡ Key æˆ–æ—¶é—´åŒºé—´æ¥æŸ¥è¯¢æ¶ˆæ¯çš„æ–¹æ³•ï¼Œé€šè¿‡ IndexFile æ¥æŸ¥æ‰¾æ¶ˆæ¯çš„æ–¹æ³•ä¸å½±å“å‘é€ä¸æ¶ˆè´¹æ¶ˆæ¯çš„ä¸»æµç¨‹ã€‚IndexFile çš„åº•å±‚å­˜å‚¨ä¸ºåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­å®ç°çš„ HashMap ç»“æ„ï¼Œæ•… RocketMQ çš„ç´¢å¼•æ–‡ä»¶å…¶åº•å±‚å®ç°ä¸º hash ç´¢å¼• RocketMQ é‡‡ç”¨çš„æ˜¯æ··åˆå‹çš„å­˜å‚¨ç»“æ„ï¼Œå³ä¸º Broker å•ä¸ªå®ä¾‹ä¸‹æ‰€æœ‰çš„é˜Ÿåˆ—å…±ç”¨ä¸€ä¸ªæ—¥å¿—æ•°æ®æ–‡ä»¶ï¼ˆCommitLogï¼‰æ¥å­˜å‚¨ï¼Œå¤šä¸ª Topic çš„æ¶ˆæ¯å®ä½“å†…å®¹éƒ½å­˜å‚¨äºä¸€ä¸ª CommitLog ä¸­ã€‚æ··åˆå‹å­˜å‚¨ç»“æ„é’ˆå¯¹ Producer å’Œ Consumer åˆ†åˆ«é‡‡ç”¨äº†æ•°æ®å’Œç´¢å¼•éƒ¨åˆ†ç›¸åˆ†ç¦»çš„å­˜å‚¨ç»“æ„ï¼ŒProducer å‘é€æ¶ˆæ¯è‡³ Broker ç«¯ï¼Œç„¶å Broker ç«¯ä½¿ç”¨åŒæ­¥æˆ–è€…å¼‚æ­¥çš„æ–¹å¼å¯¹æ¶ˆæ¯åˆ·ç›˜æŒä¹…åŒ–ï¼Œä¿å­˜è‡³ CommitLog ä¸­ã€‚åªè¦æ¶ˆæ¯è¢«æŒä¹…åŒ–è‡³ç£ç›˜æ–‡ä»¶ CommitLog ä¸­ï¼ŒProducer å‘é€çš„æ¶ˆæ¯å°±ä¸ä¼šä¸¢å¤±ï¼ŒConsumer ä¹Ÿå°±è‚¯å®šæœ‰æœºä¼šå»æ¶ˆè´¹è¿™æ¡æ¶ˆæ¯ æœåŠ¡ç«¯æ”¯æŒé•¿è½®è¯¢æ¨¡å¼ï¼Œå½“æ¶ˆè´¹è€…æ— æ³•æ‹‰å–åˆ°æ¶ˆæ¯åï¼Œå¯ä»¥ç­‰ä¸‹ä¸€æ¬¡æ¶ˆæ¯æ‹‰å–ï¼ŒBroker å…è®¸ç­‰å¾… 30s çš„æ—¶é—´ï¼Œåªè¦è¿™æ®µæ—¶é—´å†…æœ‰æ–°æ¶ˆæ¯åˆ°è¾¾ï¼Œå°†ç›´æ¥è¿”å›ç»™æ¶ˆè´¹ç«¯ã€‚RocketMQ çš„å…·ä½“åšæ³•æ˜¯ï¼Œä½¿ç”¨ Broker ç«¯çš„åå°æœåŠ¡çº¿ç¨‹ ReputMessageService ä¸åœåœ°åˆ†å‘è¯·æ±‚å¹¶å¼‚æ­¥æ„å»º ConsumeQueueï¼ˆé€»è¾‘æ¶ˆè´¹é˜Ÿåˆ—ï¼‰å’Œ IndexFileï¼ˆç´¢å¼•æ–‡ä»¶ï¼‰æ•°æ® å†…å­˜æ˜ å°„æ“ä½œç³»ç»Ÿåˆ†ä¸ºç”¨æˆ·æ€å’Œå†…æ ¸æ€ï¼Œæ–‡ä»¶æ“ä½œã€ç½‘ç»œæ“ä½œéœ€è¦æ¶‰åŠè¿™ä¸¤ç§å½¢æ€çš„åˆ‡æ¢ï¼Œéœ€è¦è¿›è¡Œæ•°æ®å¤åˆ¶ã€‚ä¸€å°æœåŠ¡å™¨æŠŠæœ¬æœºç£ç›˜æ–‡ä»¶çš„å†…å®¹å‘é€åˆ°å®¢æˆ·ç«¯ï¼Œåˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š readï¼šè¯»å–æœ¬åœ°æ–‡ä»¶å†…å®¹ writeï¼šå°†è¯»å–çš„å†…å®¹é€šè¿‡ç½‘ç»œå‘é€å‡ºå» è¡¥å……ï¼šProg â†’ NET â†’ I&#x2F;O â†’ é›¶æ‹·è´éƒ¨åˆ†çš„ç¬”è®°è¯¦è§£ç›¸å…³å†…å®¹ é€šè¿‡ä½¿ç”¨ mmap çš„æ–¹å¼ï¼Œå¯ä»¥çœå»å‘ç”¨æˆ·æ€çš„å†…å­˜å¤åˆ¶ï¼ŒRocketMQ å……åˆ†åˆ©ç”¨é›¶æ‹·è´æŠ€æœ¯ï¼Œæé«˜æ¶ˆæ¯å­˜ç›˜å’Œç½‘ç»œå‘é€çš„é€Ÿåº¦ RocketMQ é€šè¿‡ MappedByteBuffer å¯¹æ–‡ä»¶è¿›è¡Œè¯»å†™æ“ä½œï¼Œåˆ©ç”¨äº† NIO ä¸­çš„ FileChannel æ¨¡å‹å°†ç£ç›˜ä¸Šçš„ç‰©ç†æ–‡ä»¶ç›´æ¥æ˜ å°„åˆ°ç”¨æˆ·æ€çš„å†…å­˜åœ°å€ä¸­ï¼Œå°†å¯¹æ–‡ä»¶çš„æ“ä½œè½¬åŒ–ä¸ºç›´æ¥å¯¹å†…å­˜åœ°å€è¿›è¡Œæ“ä½œï¼Œä»è€Œæå¤§åœ°æé«˜äº†æ–‡ä»¶çš„è¯»å†™æ•ˆç‡ MappedByteBuffer å†…å­˜æ˜ å°„çš„æ–¹å¼é™åˆ¶ä¸€æ¬¡åªèƒ½æ˜ å°„ 1.5~2G çš„æ–‡ä»¶è‡³ç”¨æˆ·æ€çš„è™šæ‹Ÿå†…å­˜ï¼Œæ‰€ä»¥ RocketMQ é»˜è®¤è®¾ç½®å•ä¸ª CommitLog æ—¥å¿—æ•°æ®æ–‡ä»¶ä¸º 1Gã€‚RocketMQ çš„æ–‡ä»¶å­˜å‚¨ä½¿ç”¨å®šé•¿ç»“æ„æ¥å­˜å‚¨ï¼Œæ–¹ä¾¿ä¸€æ¬¡å°†æ•´ä¸ªæ–‡ä»¶æ˜ å°„è‡³å†…å­˜ é¡µé¢ç¼“å­˜é¡µç¼“å­˜ï¼ˆPageCacheï¼‰æ˜¯ OS å¯¹æ–‡ä»¶çš„ç¼“å­˜ï¼Œæ¯ä¸€é¡µçš„å¤§å°é€šå¸¸æ˜¯ 4Kï¼Œç”¨äºåŠ é€Ÿå¯¹æ–‡ä»¶çš„è¯»å†™ã€‚å› ä¸º OS å°†ä¸€éƒ¨åˆ†çš„å†…å­˜ç”¨ä½œ PageCacheï¼Œæ‰€ä»¥ç¨‹åºå¯¹æ–‡ä»¶è¿›è¡Œé¡ºåºè¯»å†™çš„é€Ÿåº¦å‡ ä¹æ¥è¿‘äºå†…å­˜çš„è¯»å†™é€Ÿåº¦ å¯¹äºæ•°æ®çš„å†™å…¥ï¼ŒOS ä¼šå…ˆå†™å…¥è‡³ Cache å†…ï¼Œéšåé€šè¿‡å¼‚æ­¥çš„æ–¹å¼ç”± pdflush å†…æ ¸çº¿ç¨‹å°† Cache å†…çš„æ•°æ®åˆ·ç›˜è‡³ç‰©ç†ç£ç›˜ä¸Š å¯¹äºæ•°æ®çš„è¯»å–ï¼Œå¦‚æœä¸€æ¬¡è¯»å–æ–‡ä»¶æ—¶å‡ºç°æœªå‘½ä¸­ PageCache çš„æƒ…å†µï¼ŒOS ä»ç‰©ç†ç£ç›˜ä¸Šè®¿é—®è¯»å–æ–‡ä»¶çš„åŒæ—¶ï¼Œä¼šé¡ºåºå¯¹å…¶ä»–ç›¸é‚»å—çš„æ•°æ®æ–‡ä»¶è¿›è¡Œé¢„è¯»å–ï¼ˆå±€éƒ¨æ€§åŸç†ï¼Œæœ€å¤§ 128Kï¼‰ åœ¨ RocketMQ ä¸­ï¼ŒConsumeQueue é€»è¾‘æ¶ˆè´¹é˜Ÿåˆ—å­˜å‚¨çš„æ•°æ®è¾ƒå°‘ï¼Œå¹¶ä¸”æ˜¯é¡ºåºè¯»å–ï¼Œåœ¨ PageCache æœºåˆ¶çš„é¢„è¯»å–ä½œç”¨ä¸‹ï¼ŒConsume Queue æ–‡ä»¶çš„è¯»æ€§èƒ½å‡ ä¹æ¥è¿‘è¯»å†…å­˜ï¼Œå³ä½¿åœ¨æœ‰æ¶ˆæ¯å †ç§¯æƒ…å†µä¸‹ä¹Ÿä¸ä¼šå½±å“æ€§èƒ½ã€‚ä½†æ˜¯ CommitLog æ¶ˆæ¯å­˜å‚¨çš„æ—¥å¿—æ•°æ®æ–‡ä»¶è¯»å–å†…å®¹æ—¶ä¼šäº§ç”Ÿè¾ƒå¤šçš„éšæœºè®¿é—®è¯»å–ï¼Œä¸¥é‡å½±å“æ€§èƒ½ã€‚é€‰æ‹©åˆé€‚çš„ç³»ç»Ÿ IO è°ƒåº¦ç®—æ³•å’Œå›ºæ€ç¡¬ç›˜ï¼Œæ¯”å¦‚è®¾ç½®è°ƒåº¦ç®—æ³•ä¸º Deadlineï¼Œéšæœºè¯»çš„æ€§èƒ½ä¹Ÿä¼šæœ‰æ‰€æå‡ åˆ·ç›˜æœºåˆ¶ä¸¤ç§æŒä¹…åŒ–çš„æ–¹æ¡ˆï¼š å…³ç³»å‹æ•°æ®åº“ DBï¼šIO è¯»å†™æ€§èƒ½æ¯”è¾ƒå·®ï¼Œå¦‚æœ DB å‡ºç°æ•…éšœï¼Œåˆ™ MQ çš„æ¶ˆæ¯å°±æ— æ³•è½ç›˜å­˜å‚¨å¯¼è‡´çº¿ä¸Šæ•…éšœï¼Œå¯é æ€§ä¸é«˜ æ–‡ä»¶ç³»ç»Ÿï¼šæ¶ˆæ¯åˆ·ç›˜è‡³æ‰€éƒ¨ç½²è™šæ‹Ÿæœº&#x2F;ç‰©ç†æœºçš„æ–‡ä»¶ç³»ç»Ÿæ¥åšæŒä¹…åŒ–ï¼Œåˆ†ä¸ºå¼‚æ­¥åˆ·ç›˜å’ŒåŒæ­¥åˆ·ç›˜ä¸¤ç§æ¨¡å¼ã€‚æ¶ˆæ¯åˆ·ç›˜ä¸ºæ¶ˆæ¯å­˜å‚¨æä¾›äº†ä¸€ç§é«˜æ•ˆç‡ã€é«˜å¯é æ€§å’Œé«˜æ€§èƒ½çš„æ•°æ®æŒä¹…åŒ–æ–¹å¼ï¼Œé™¤ééƒ¨ç½² MQ æœºå™¨æœ¬èº«æˆ–æ˜¯æœ¬åœ°ç£ç›˜æŒ‚äº†ï¼Œä¸€èˆ¬ä¸ä¼šå‡ºç°æ— æ³•æŒä¹…åŒ–çš„é—®é¢˜ RocketMQ é‡‡ç”¨æ–‡ä»¶ç³»ç»Ÿçš„æ–¹å¼ï¼Œæ— è®ºåŒæ­¥è¿˜æ˜¯å¼‚æ­¥åˆ·ç›˜ï¼Œéƒ½ä½¿ç”¨é¡ºåº IOï¼Œå› ä¸ºç£ç›˜çš„é¡ºåºè¯»å†™è¦æ¯”éšæœºè¯»å†™å¿«å¾ˆå¤š åŒæ­¥åˆ·ç›˜ï¼šåªæœ‰åœ¨æ¶ˆæ¯çœŸæ­£æŒä¹…åŒ–è‡³ç£ç›˜å RocketMQ çš„ Broker ç«¯æ‰ä¼šçœŸæ­£è¿”å›ç»™ Producer ç«¯ä¸€ä¸ªæˆåŠŸçš„ ACK å“åº”ï¼Œä¿éšœ MQ æ¶ˆæ¯çš„å¯é æ€§ï¼Œä½†æ˜¯æ€§èƒ½ä¸Šä¼šæœ‰è¾ƒå¤§å½±å“ï¼Œä¸€èˆ¬é€‚ç”¨äºé‡‘èä¸šåŠ¡åº”ç”¨è¯¥æ¨¡å¼è¾ƒå¤š å¼‚æ­¥åˆ·ç›˜ï¼šåˆ©ç”¨ OS çš„ PageCacheï¼Œåªè¦æ¶ˆæ¯å†™å…¥å†…å­˜ PageCache å³å¯å°†æˆåŠŸçš„ ACK è¿”å›ç»™ Producer ç«¯ï¼Œé™ä½äº†è¯»å†™å»¶è¿Ÿï¼Œæé«˜äº† MQ çš„æ€§èƒ½å’Œååé‡ã€‚æ¶ˆæ¯åˆ·ç›˜é‡‡ç”¨åå°å¼‚æ­¥çº¿ç¨‹æäº¤çš„æ–¹å¼è¿›è¡Œï¼Œå½“å†…å­˜é‡Œçš„æ¶ˆæ¯é‡ç§¯ç´¯åˆ°ä¸€å®šç¨‹åº¦æ—¶ï¼Œè§¦å‘å†™ç£ç›˜åŠ¨ä½œ é€šè¿‡ Broker é…ç½®æ–‡ä»¶é‡Œçš„ flushDiskType å‚æ•°è®¾ç½®é‡‡ç”¨ä»€ä¹ˆæ–¹å¼ï¼Œå¯ä»¥é…ç½®æˆ SYNC_FLUSHã€ASYNC_FLUSH ä¸­çš„ä¸€ä¸ª å®˜æ–¹æ–‡æ¡£ï¼šhttps://github.com/apache/rocketmq/blob/master/docs/cn/design.md é›†ç¾¤è®¾è®¡é›†ç¾¤æ¨¡å¼å¸¸ç”¨çš„ä»¥ä¸‹å‡ ç§æ¨¡å¼ï¼š å• Master æ¨¡å¼ï¼šè¿™ç§æ–¹å¼é£é™©è¾ƒå¤§ï¼Œä¸€æ—¦ Broker é‡å¯æˆ–è€…å®•æœºï¼Œä¼šå¯¼è‡´æ•´ä¸ªæœåŠ¡ä¸å¯ç”¨ å¤š Master æ¨¡å¼ï¼šä¸€ä¸ªé›†ç¾¤æ—  Slaveï¼Œå…¨æ˜¯ Master ä¼˜ç‚¹ï¼šé…ç½®ç®€å•ï¼Œå•ä¸ª Master å®•æœºæˆ–é‡å¯ç»´æŠ¤å¯¹åº”ç”¨æ— å½±å“ï¼Œåœ¨ç£ç›˜é…ç½®ä¸º RAID10 æ—¶ï¼Œå³ä½¿æœºå™¨å®•æœºä¸å¯æ¢å¤æƒ…å†µä¸‹ï¼Œç”±äº RAID10 ç£ç›˜éå¸¸å¯é ï¼Œæ¶ˆæ¯ä¹Ÿä¸ä¼šä¸¢ï¼ˆå¼‚æ­¥åˆ·ç›˜ä¸¢å¤±å°‘é‡æ¶ˆæ¯ï¼ŒåŒæ­¥åˆ·ç›˜ä¸€æ¡ä¸ä¸¢ï¼‰ï¼Œæ€§èƒ½æœ€é«˜ ç¼ºç‚¹ï¼šå•å°æœºå™¨å®•æœºæœŸé—´ï¼Œè¿™å°æœºå™¨ä¸Šæœªè¢«æ¶ˆè´¹çš„æ¶ˆæ¯åœ¨æœºå™¨æ¢å¤ä¹‹å‰ä¸å¯è®¢é˜…ï¼Œæ¶ˆæ¯å®æ—¶æ€§ä¼šå—åˆ°å½±å“ å¤š Master å¤š Slave æ¨¡å¼ï¼ˆåŒæ­¥ï¼‰ï¼šæ¯ä¸ª Master é…ç½®ä¸€ä¸ª Slaveï¼Œæœ‰å¤šå¯¹ Master-Slaveï¼ŒHA é‡‡ç”¨åŒæ­¥åŒå†™æ–¹å¼ï¼Œå³åªæœ‰ä¸»å¤‡éƒ½å†™æˆåŠŸï¼Œæ‰å‘åº”ç”¨è¿”å›æˆåŠŸ ä¼˜ç‚¹ï¼šæ•°æ®ä¸æœåŠ¡éƒ½æ— å•ç‚¹æ•…éšœï¼ŒMaster å®•æœºæƒ…å†µä¸‹ï¼Œæ¶ˆæ¯æ— å»¶è¿Ÿï¼ŒæœåŠ¡å¯ç”¨æ€§ä¸æ•°æ®å¯ç”¨æ€§éƒ½éå¸¸é«˜ ç¼ºç‚¹ï¼šæ€§èƒ½æ¯”å¼‚æ­¥å¤åˆ¶ç•¥ä½ï¼ˆå¤§çº¦ä½ 10% å·¦å³ï¼‰ï¼Œå‘é€å•ä¸ªæ¶ˆæ¯çš„ RT ç•¥é«˜ï¼Œç›®å‰ä¸èƒ½å®ç°ä¸»èŠ‚ç‚¹å®•æœºï¼Œå¤‡æœºè‡ªåŠ¨åˆ‡æ¢ä¸ºä¸»æœº å¤š Master å¤š Slave æ¨¡å¼ï¼ˆå¼‚æ­¥ï¼‰ï¼šHA é‡‡ç”¨å¼‚æ­¥å¤åˆ¶çš„æ–¹å¼ï¼Œä¼šé€ æˆä¸»å¤‡æœ‰çŸ­æš‚çš„æ¶ˆæ¯å»¶è¿Ÿï¼ˆæ¯«ç§’çº§åˆ«ï¼‰ ä¼˜ç‚¹ï¼šå³ä½¿ç£ç›˜æŸåï¼Œæ¶ˆæ¯ä¸¢å¤±çš„éå¸¸å°‘ï¼Œä¸”æ¶ˆæ¯å®æ—¶æ€§ä¸ä¼šå—å½±å“ï¼ŒåŒæ—¶ Master å®•æœºåï¼Œæ¶ˆè´¹è€…ä»ç„¶å¯ä»¥ä» Slave æ¶ˆè´¹ï¼Œè€Œä¸”æ­¤è¿‡ç¨‹å¯¹åº”ç”¨é€æ˜ï¼Œä¸éœ€è¦äººå·¥å¹²é¢„ï¼Œæ€§èƒ½åŒå¤š Master æ¨¡å¼å‡ ä¹ä¸€æ · ç¼ºç‚¹ï¼šMaster å®•æœºï¼Œç£ç›˜æŸåæƒ…å†µä¸‹ä¼šä¸¢å¤±å°‘é‡æ¶ˆæ¯ é›†ç¾¤æ¶æ„RocketMQ ç½‘ç»œéƒ¨ç½²ç‰¹ç‚¹ï¼š NameServer æ˜¯ä¸€ä¸ªå‡ ä¹æ— çŠ¶æ€èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œæ— ä»»ä½•ä¿¡æ¯åŒæ­¥ Broker éƒ¨ç½²ç›¸å¯¹å¤æ‚ï¼ŒBroker åˆ†ä¸º Master ä¸ Slaveï¼ŒMaster å¯ä»¥éƒ¨ç½²å¤šä¸ªï¼Œä¸€ä¸ª Master å¯ä»¥å¯¹åº”å¤šä¸ª Slaveï¼Œä½†æ˜¯ä¸€ä¸ª Slave åªèƒ½å¯¹åº”ä¸€ä¸ª Masterï¼ŒMaster ä¸ Slave çš„å¯¹åº”å…³ç³»é€šè¿‡æŒ‡å®šç›¸åŒ BrokerNameã€ä¸åŒ BrokerId æ¥å®šä¹‰ï¼ŒBrokerId ä¸º 0 æ˜¯ Masterï¼Œé 0 è¡¨ç¤º Slaveã€‚æ¯ä¸ª Broker ä¸ NameServer é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹å»ºç«‹é•¿è¿æ¥ï¼Œå®šæ—¶æ³¨å†Œ Topic ä¿¡æ¯åˆ°æ‰€æœ‰ NameServer è¯´æ˜ï¼šéƒ¨ç½²æ¶æ„ä¸Šä¹Ÿæ”¯æŒä¸€ Master å¤š Slaveï¼Œä½†åªæœ‰ BrokerId&#x3D;1 çš„ä»æœåŠ¡å™¨æ‰ä¼šå‚ä¸æ¶ˆæ¯çš„è¯»è´Ÿè½½ï¼ˆè¯»å†™åˆ†ç¦»ï¼‰ Producer ä¸ NameServer é›†ç¾¤ä¸­çš„å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆéšæœºé€‰æ‹©ï¼‰å»ºç«‹é•¿è¿æ¥ï¼Œå®šæœŸä» NameServer è·å– Topic è·¯ç”±ä¿¡æ¯ï¼Œå¹¶å‘æä¾› Topic æœåŠ¡çš„ Master å»ºç«‹é•¿è¿æ¥ï¼Œä¸”å®šæ—¶å‘ Master å‘é€å¿ƒè·³ã€‚Producer å®Œå…¨æ— çŠ¶æ€ï¼Œå¯é›†ç¾¤éƒ¨ç½² Consumer ä¸ NameServer é›†ç¾¤ä¸­çš„å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆéšæœºé€‰æ‹©ï¼‰å»ºç«‹é•¿è¿æ¥ï¼Œå®šæœŸä» NameServer è·å– Topic è·¯ç”±ä¿¡æ¯ï¼Œå¹¶å‘æä¾› Topic æœåŠ¡çš„ Masterã€Slave å»ºç«‹é•¿è¿æ¥ï¼Œä¸”å®šæ—¶å‘ Masterã€Slave å‘é€å¿ƒè·³ Consumer æ—¢å¯ä»¥ä» Master è®¢é˜…æ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥ä» Slave è®¢é˜…æ¶ˆæ¯ï¼Œåœ¨å‘ Master æ‹‰å–æ¶ˆæ¯æ—¶ï¼ŒMaster æœåŠ¡å™¨ä¼šæ ¹æ®æ‹‰å–åç§»é‡ä¸æœ€å¤§åç§»é‡çš„è·ç¦»ï¼ˆåˆ¤æ–­æ˜¯å¦è¯»è€æ¶ˆæ¯ï¼Œäº§ç”Ÿè¯» I&#x2F;Oï¼‰ï¼Œä»¥åŠä»æœåŠ¡å™¨æ˜¯å¦å¯è¯»ç­‰å› ç´ å»ºè®®ä¸‹ä¸€æ¬¡æ˜¯ä» Master è¿˜æ˜¯ Slave æ‹‰å– å®˜æ–¹æ–‡æ¡£ï¼šhttps://github.com/apache/rocketmq/blob/master/docs/cn/architecture.md é«˜å¯ç”¨æ€§NameServer èŠ‚ç‚¹æ˜¯æ— çŠ¶æ€çš„ï¼Œä¸”å„ä¸ªèŠ‚ç‚¹ç›´æ¥çš„æ•°æ®æ˜¯ä¸€è‡´çš„ï¼Œéƒ¨åˆ† NameServer ä¸å¯ç”¨ä¹Ÿå¯ä»¥ä¿è¯ MQ æœåŠ¡æ­£å¸¸è¿è¡Œ BrokerServer çš„é«˜å¯ç”¨é€šè¿‡ Master å’Œ Slave çš„é…åˆï¼š Slave åªè´Ÿè´£è¯»ï¼Œå½“ Master ä¸å¯ç”¨ï¼Œå¯¹åº”çš„ Slave ä»èƒ½ä¿è¯æ¶ˆæ¯è¢«æ­£å¸¸æ¶ˆè´¹ é…ç½®å¤šç»„ Master-Slave ç»„ï¼Œå…¶ä»–çš„ Master-Slave ç»„ä¹Ÿä¼šä¿è¯æ¶ˆæ¯çš„æ­£å¸¸å‘é€å’Œæ¶ˆè´¹ ç›®å‰ä¸æ”¯æŒæŠŠ Slave è‡ªåŠ¨è½¬æˆ Masterï¼Œéœ€è¦æ‰‹åŠ¨åœæ­¢ Slave è§’è‰²çš„ Brokerï¼Œæ›´æ”¹é…ç½®æ–‡ä»¶ï¼Œç”¨æ–°çš„é…ç½®æ–‡ä»¶å¯åŠ¨ Broker æ‰€ä»¥éœ€è¦é…ç½®å¤šä¸ª Master ä¿è¯å¯ç”¨æ€§ï¼Œå¦åˆ™ä¸€ä¸ª Master æŒ‚äº†å¯¼è‡´æ•´ä½“ç³»ç»Ÿçš„å†™æ“ä½œä¸å¯ç”¨ ç”Ÿäº§ç«¯çš„é«˜å¯ç”¨ï¼šåœ¨åˆ›å»º Topic çš„æ—¶å€™ï¼ŒæŠŠ Topic çš„å¤šä¸ª Message Queue åˆ›å»ºåœ¨å¤šä¸ª Broker ç»„ä¸Šï¼ˆç›¸åŒ Broker åç§°ï¼Œä¸åŒ brokerId çš„æœºå™¨ï¼‰ï¼Œå½“ä¸€ä¸ª Broker ç»„çš„ Master ä¸å¯ç”¨åï¼Œå…¶ä»–ç»„çš„ Master ä»ç„¶å¯ç”¨ï¼ŒProducer ä»ç„¶å¯ä»¥å‘é€æ¶ˆæ¯ æ¶ˆè´¹ç«¯çš„é«˜å¯ç”¨ï¼šåœ¨ Consumer çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œå¹¶ä¸éœ€è¦è®¾ç½®æ˜¯ä» Master Broker è¯»è¿˜æ˜¯ä» Slave è¯»ï¼Œå½“ Master ä¸å¯ç”¨æˆ–è€…ç¹å¿™çš„æ—¶å€™ï¼ŒConsumer ä¼šè¢«è‡ªåŠ¨åˆ‡æ¢åˆ°ä» Slave è¯»ã€‚æœ‰äº†è‡ªåŠ¨åˆ‡æ¢çš„æœºåˆ¶ï¼Œå½“ä¸€ä¸ª Master æœºå™¨å‡ºç°æ•…éšœåï¼ŒConsumer ä»ç„¶å¯ä»¥ä» Slave è¯»å–æ¶ˆæ¯ï¼Œä¸å½±å“ Consumer ç¨‹åºï¼Œè¾¾åˆ°äº†æ¶ˆè´¹ç«¯çš„é«˜å¯ç”¨æ€§ ä¸»ä»å¤åˆ¶å¦‚æœä¸€ä¸ª Broker ç»„æœ‰ Master å’Œ Slaveï¼Œæ¶ˆæ¯éœ€è¦ä» Master å¤åˆ¶åˆ° Slave ä¸Šï¼Œæœ‰åŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§å¤åˆ¶æ–¹å¼ï¼š åŒæ­¥å¤åˆ¶æ–¹å¼ï¼šMaster å’Œ Slave å‡å†™æˆåŠŸåæ‰åé¦ˆç»™å®¢æˆ·ç«¯å†™æˆåŠŸçŠ¶æ€ï¼ˆå†™ Page Cacheï¼‰ã€‚åœ¨åŒæ­¥å¤åˆ¶æ–¹å¼ä¸‹ï¼Œå¦‚æœ Master å‡ºæ•…éšœï¼Œ Slave ä¸Šæœ‰å…¨éƒ¨çš„å¤‡ä»½æ•°æ®ï¼Œå®¹æ˜“æ¢å¤ï¼Œä½†æ˜¯åŒæ­¥å¤åˆ¶ä¼šå¢å¤§æ•°æ®å†™å…¥å»¶è¿Ÿï¼Œé™ä½ç³»ç»Ÿååé‡ å¼‚æ­¥å¤åˆ¶æ–¹å¼ï¼šåªè¦ Master å†™æˆåŠŸï¼Œå³å¯åé¦ˆç»™å®¢æˆ·ç«¯å†™æˆåŠŸçŠ¶æ€ï¼Œç³»ç»Ÿæ‹¥æœ‰è¾ƒä½çš„å»¶è¿Ÿå’Œè¾ƒé«˜çš„ååé‡ï¼Œä½†æ˜¯å¦‚æœ Master å‡ºäº†æ•…éšœï¼Œæœ‰äº›æ•°æ®å› ä¸ºæ²¡æœ‰è¢«å†™å…¥ Slaveï¼Œæœ‰å¯èƒ½ä¼šä¸¢å¤± åŒæ­¥å¤åˆ¶å’Œå¼‚æ­¥å¤åˆ¶æ˜¯é€šè¿‡ Broker é…ç½®æ–‡ä»¶é‡Œçš„ brokerRole å‚æ•°è¿›è¡Œè®¾ç½®çš„ï¼Œå¯ä»¥è®¾ç½®æˆ ASYNC_MASTEã€RSYNC_MASTERã€SLAVE ä¸‰ä¸ªå€¼ä¸­çš„ä¸€ä¸ª ä¸€èˆ¬æŠŠåˆ·ç›˜æœºåˆ¶é…ç½®æˆ ASYNC_FLUSHï¼Œä¸»ä»å¤åˆ¶ä¸º SYNC_MASTERï¼Œè¿™æ ·å³ä½¿æœ‰ä¸€å°æœºå™¨å‡ºæ•…éšœï¼Œä»ç„¶èƒ½ä¿è¯æ•°æ®ä¸ä¸¢ RocketMQ æ”¯æŒæ¶ˆæ¯çš„é«˜å¯é ï¼Œå½±å“æ¶ˆæ¯å¯é æ€§çš„å‡ ç§æƒ…å†µï¼š Broker éæ­£å¸¸å…³é—­ Broker å¼‚å¸¸ Crash OS Crash æœºå™¨æ‰ç”µï¼Œä½†æ˜¯èƒ½ç«‹å³æ¢å¤ä¾›ç”µæƒ…å†µ æœºå™¨æ— æ³•å¼€æœºï¼ˆå¯èƒ½æ˜¯ CPUã€ä¸»æ¿ã€å†…å­˜ç­‰å…³é”®è®¾å¤‡æŸåï¼‰ ç£ç›˜è®¾å¤‡æŸå å‰å››ç§æƒ…å†µéƒ½å±äºç¡¬ä»¶èµ„æºå¯ç«‹å³æ¢å¤æƒ…å†µï¼ŒRocketMQ åœ¨è¿™å››ç§æƒ…å†µä¸‹èƒ½ä¿è¯æ¶ˆæ¯ä¸ä¸¢ï¼Œæˆ–è€…ä¸¢å¤±å°‘é‡æ•°æ®ï¼ˆä¾èµ–åˆ·ç›˜æ–¹å¼ï¼‰ åä¸¤ç§å±äºå•ç‚¹æ•…éšœï¼Œä¸”æ— æ³•æ¢å¤ï¼Œä¸€æ—¦å‘ç”Ÿï¼Œåœ¨æ­¤å•ç‚¹ä¸Šçš„æ¶ˆæ¯å…¨éƒ¨ä¸¢å¤±ã€‚RocketMQ åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œé€šè¿‡ä¸»ä»å¼‚æ­¥å¤åˆ¶ï¼Œå¯ä¿è¯ 99% çš„æ¶ˆæ¯ä¸ä¸¢ï¼Œä½†æ˜¯ä»ç„¶ä¼šæœ‰æå°‘é‡çš„æ¶ˆæ¯å¯èƒ½ä¸¢å¤±ã€‚é€šè¿‡åŒæ­¥åŒå†™æŠ€æœ¯å¯ä»¥å®Œå…¨é¿å…å•ç‚¹ï¼Œä½†æ˜¯ä¼šå½±å“æ€§èƒ½ï¼Œé€‚åˆå¯¹æ¶ˆæ¯å¯é æ€§è¦æ±‚æé«˜çš„åœºåˆï¼ŒRocketMQ ä» 3.0 ç‰ˆæœ¬å¼€å§‹æ”¯æŒåŒæ­¥åŒå†™ ä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬ä¼šå»ºè®®é‡‡å–åŒæ­¥åŒå†™ + å¼‚æ­¥åˆ·ç›˜çš„æ–¹å¼ï¼Œåœ¨æ¶ˆæ¯çš„å¯é æ€§å’Œæ€§èƒ½é—´æœ‰ä¸€ä¸ªè¾ƒå¥½çš„å¹³è¡¡ è´Ÿè½½å‡è¡¡ç”Ÿäº§ç«¯RocketMQ ä¸­çš„è´Ÿè½½å‡è¡¡å¯ä»¥åˆ†ä¸º Producer ç«¯å‘é€æ¶ˆæ¯æ—¶å€™çš„è´Ÿè½½å‡è¡¡å’Œ Consumer ç«¯è®¢é˜…æ¶ˆæ¯çš„è´Ÿè½½å‡è¡¡ Producer ç«¯åœ¨å‘é€æ¶ˆæ¯æ—¶ï¼Œä¼šå…ˆæ ¹æ® Topic æ‰¾åˆ°æŒ‡å®šçš„ TopicPublishInfoï¼Œåœ¨è·å–äº† TopicPublishInfo è·¯ç”±ä¿¡æ¯åï¼ŒRocketMQ çš„å®¢æˆ·ç«¯åœ¨é»˜è®¤æ–¹å¼è°ƒç”¨ selectOneMessageQueue() æ–¹æ³•ä» TopicPublishInfo ä¸­çš„ messageQueueList ä¸­é€‰æ‹©ä¸€ä¸ªé˜Ÿåˆ— MessageQueue è¿›è¡Œå‘é€æ¶ˆæ¯ é»˜è®¤ä¼šè½®è¯¢æ‰€æœ‰çš„ Message Queue å‘é€ï¼Œä»¥è®©æ¶ˆæ¯å¹³å‡è½åœ¨ä¸åŒçš„ queue ä¸Šï¼Œè€Œç”±äº queueå¯ä»¥æ•£è½åœ¨ä¸åŒçš„ Brokerï¼Œæ‰€ä»¥æ¶ˆæ¯å°±å‘é€åˆ°ä¸åŒçš„ Broker ä¸‹ï¼Œå›¾ä¸­ç®­å¤´çº¿æ¡ä¸Šçš„æ ‡å·ä»£è¡¨é¡ºåºï¼Œå‘å¸ƒæ–¹ä¼šæŠŠç¬¬ä¸€æ¡æ¶ˆæ¯å‘é€è‡³ Queue 0ï¼Œç„¶åç¬¬äºŒæ¡æ¶ˆæ¯å‘é€è‡³ Queue 1ï¼Œä»¥æ­¤ç±»æ¨ï¼š å®¹é”™ç­–ç•¥å‡åœ¨ MQFaultStrategy è¿™ä¸ªç±»ä¸­å®šä¹‰ï¼Œæœ‰ä¸€ä¸ª sendLatencyFaultEnable å¼€å…³å˜é‡ï¼š å¦‚æœå¼€å¯ï¼Œä¼šåœ¨éšæœºï¼ˆåªæœ‰åˆå§‹åŒ–ç´¢å¼•å˜é‡æ—¶æ‰éšæœºï¼Œæ­£å¸¸éƒ½æ˜¯é€’å¢ï¼‰é€’å¢å–æ¨¡çš„åŸºç¡€ä¸Šï¼Œå†è¿‡æ»¤æ‰ not available çš„ Broker å¦‚æœå…³é—­ï¼Œé‡‡ç”¨éšæœºé€’å¢å–æ¨¡çš„æ–¹å¼é€‰æ‹©ä¸€ä¸ªé˜Ÿåˆ—ï¼ˆMessageQueueï¼‰æ¥å‘é€æ¶ˆæ¯ LatencyFaultTolerance æœºåˆ¶æ˜¯å®ç°æ¶ˆæ¯å‘é€é«˜å¯ç”¨çš„æ ¸å¿ƒå…³é”®æ‰€åœ¨ï¼Œå¯¹ä¹‹å‰å¤±è´¥çš„ï¼ŒæŒ‰ä¸€å®šçš„æ—¶é—´åšé€€é¿ã€‚ä¾‹å¦‚ä¸Šæ¬¡è¯·æ±‚çš„ latency è¶…è¿‡ 550Lmsï¼Œå°±é€€é¿ 3000Lmsï¼›è¶…è¿‡ 1000Lï¼Œå°±é€€é¿ 60000L æ¶ˆè´¹ç«¯åœ¨ RocketMQ ä¸­ï¼ŒConsumer ç«¯çš„ä¸¤ç§æ¶ˆè´¹æ¨¡å¼ï¼ˆPush&#x2F;Pullï¼‰éƒ½æ˜¯åŸºäºæ‹‰æ¨¡å¼æ¥è·å–æ¶ˆæ¯çš„ï¼Œè€Œåœ¨ Push æ¨¡å¼åªæ˜¯å¯¹ Pull æ¨¡å¼çš„ä¸€ç§å°è£…ï¼Œå…¶æœ¬è´¨å®ç°ä¸ºæ¶ˆæ¯æ‹‰å–çº¿ç¨‹åœ¨ä»æœåŠ¡å™¨æ‹‰å–åˆ°ä¸€æ‰¹æ¶ˆæ¯ï¼Œæäº¤åˆ°æ¶ˆæ¯æ¶ˆè´¹çº¿ç¨‹æ± åï¼Œåˆç»§ç»­å‘æœåŠ¡å™¨å†æ¬¡å°è¯•æ‹‰å–æ¶ˆæ¯ï¼Œå¦‚æœæœªæ‹‰å–åˆ°æ¶ˆæ¯ï¼Œåˆ™å»¶è¿Ÿä¸€ä¸‹åˆç»§ç»­æ‹‰å– åœ¨ä¸¤ç§åŸºäºæ‹‰æ¨¡å¼çš„æ¶ˆè´¹æ–¹å¼ï¼ˆPush&#x2F;Pullï¼‰ä¸­ï¼Œå‡éœ€è¦ Consumer ç«¯åœ¨çŸ¥é“ä» Broker ç«¯çš„å“ªä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­å»è·å–æ¶ˆæ¯ï¼Œæ‰€ä»¥åœ¨ Consumer ç«¯æ¥åšè´Ÿè½½å‡è¡¡ï¼Œå³ Broker ç«¯ä¸­å¤šä¸ª MessageQueue åˆ†é…ç»™åŒä¸€ä¸ª Consumer Group ä¸­çš„å“ªäº› Consumer æ¶ˆè´¹ å¹¿æ’­æ¨¡å¼ä¸‹è¦æ±‚ä¸€æ¡æ¶ˆæ¯éœ€è¦æŠ•é€’åˆ°ä¸€ä¸ªæ¶ˆè´¹ç»„ä¸‹é¢æ‰€æœ‰çš„æ¶ˆè´¹è€…å®ä¾‹ï¼Œæ‰€ä»¥ä¸å­˜åœ¨è´Ÿè½½å‡è¡¡ï¼Œåœ¨å®ç°ä¸Šï¼ŒConsumer åˆ†é… queue æ—¶ï¼Œæ‰€æœ‰ Consumer éƒ½åˆ†åˆ°æ‰€æœ‰çš„ queueã€‚ åœ¨é›†ç¾¤æ¶ˆè´¹æ¨¡å¼ä¸‹ï¼Œæ¯æ¡æ¶ˆæ¯åªéœ€è¦æŠ•é€’åˆ°è®¢é˜…è¿™ä¸ª Topic çš„ Consumer Group ä¸‹çš„ä¸€ä¸ªå®ä¾‹å³å¯ï¼ŒRocketMQ é‡‡ç”¨ä¸»åŠ¨æ‹‰å–çš„æ–¹å¼æ‹‰å–å¹¶æ¶ˆè´¹æ¶ˆæ¯ï¼Œåœ¨æ‹‰å–çš„æ—¶å€™éœ€è¦æ˜ç¡®æŒ‡å®šæ‹‰å–å“ªä¸€æ¡ Message Queue é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œæ¯å½“æ¶ˆè´¹è€…å®ä¾‹çš„æ•°é‡æœ‰å˜æ›´ï¼Œéƒ½ä¼šè§¦å‘ä¸€æ¬¡æ‰€æœ‰å®ä¾‹çš„è´Ÿè½½å‡è¡¡ï¼Œè¿™æ—¶å€™ä¼šæŒ‰ç…§ queue çš„æ•°é‡å’Œå®ä¾‹çš„æ•°é‡å¹³å‡åˆ†é… queue ç»™æ¯ä¸ªå®ä¾‹ã€‚é»˜è®¤çš„åˆ†é…ç®—æ³•æ˜¯ AllocateMessageQueueAveragelyï¼š è¿˜æœ‰ä¸€ç§å¹³å‡çš„ç®—æ³•æ˜¯ AllocateMessageQueueAveragelyByCircleï¼Œä»¥ç¯çŠ¶è½®æµå‡åˆ† queue çš„å½¢å¼ï¼š é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œqueue éƒ½æ˜¯åªå…è®¸åˆ†é…ä¸€ä¸ªå®ä¾‹ï¼Œå¦‚æœå¤šä¸ªå®ä¾‹åŒæ—¶æ¶ˆè´¹ä¸€ä¸ª queue çš„æ¶ˆæ¯ï¼Œç”±äºæ‹‰å–å“ªäº›æ¶ˆæ¯æ˜¯ Consumer ä¸»åŠ¨æ§åˆ¶çš„ï¼Œä¼šå¯¼è‡´åŒä¸€ä¸ªæ¶ˆæ¯åœ¨ä¸åŒçš„å®ä¾‹ä¸‹è¢«æ¶ˆè´¹å¤šæ¬¡ é€šè¿‡å¢åŠ  Consumer å®ä¾‹å»åˆ†æ‘Š queue çš„æ¶ˆè´¹ï¼Œå¯ä»¥èµ·åˆ°æ°´å¹³æ‰©å±•çš„æ¶ˆè´¹èƒ½åŠ›çš„ä½œç”¨ã€‚è€Œå½“æœ‰å®ä¾‹ä¸‹çº¿æ—¶ï¼Œä¼šé‡æ–°è§¦å‘è´Ÿè½½å‡è¡¡ï¼Œè¿™æ—¶å€™åŸæ¥åˆ†é…åˆ°çš„ queue å°†åˆ†é…åˆ°å…¶ä»–å®ä¾‹ä¸Šç»§ç»­æ¶ˆè´¹ã€‚ä½†æ˜¯å¦‚æœ Consumer å®ä¾‹çš„æ•°é‡æ¯” Message Queue çš„æ€»æ•°é‡è¿˜å¤šçš„è¯ï¼Œå¤šå‡ºæ¥çš„ Consumer å®ä¾‹å°†æ— æ³•åˆ†åˆ° queueï¼Œä¹Ÿå°±æ— æ³•æ¶ˆè´¹åˆ°æ¶ˆæ¯ï¼Œä¹Ÿå°±æ— æ³•èµ·åˆ°åˆ†æ‘Šè´Ÿè½½çš„ä½œç”¨äº†ï¼Œæ‰€ä»¥éœ€è¦æ§åˆ¶è®© queue çš„æ€»æ•°é‡å¤§äºç­‰äº Consumer çš„æ•°é‡ åŸç†è§£æåœ¨ Consumer å¯åŠ¨åï¼Œä¼šé€šè¿‡å®šæ—¶ä»»åŠ¡ä¸æ–­åœ°å‘ RocketMQ é›†ç¾¤ä¸­çš„æ‰€æœ‰ Broker å®ä¾‹å‘é€å¿ƒè·³åŒ…ã€‚Broker ç«¯åœ¨æ”¶åˆ° Consumer çš„å¿ƒè·³æ¶ˆæ¯åï¼Œä¼šå°†å®ƒç»´æŠ¤åœ¨ ConsumerManager çš„æœ¬åœ°ç¼“å­˜å˜é‡ consumerTableï¼ŒåŒæ—¶å¹¶å°†å°è£…åçš„å®¢æˆ·ç«¯ç½‘ç»œé€šé“ä¿¡æ¯ä¿å­˜åœ¨æœ¬åœ°ç¼“å­˜å˜é‡ channelInfoTable ä¸­ï¼Œä¸º Consumer ç«¯çš„è´Ÿè½½å‡è¡¡æä¾›å¯ä»¥ä¾æ®çš„å…ƒæ•°æ®ä¿¡æ¯ Consumer ç«¯å®ç°è´Ÿè½½å‡è¡¡çš„æ ¸å¿ƒç±» RebalanceImpl åœ¨ Consumer å®ä¾‹çš„å¯åŠ¨æµç¨‹ä¸­çš„ä¼šå¯åŠ¨ MQClientInstance å®ä¾‹ï¼Œå®Œæˆè´Ÿè½½å‡è¡¡æœåŠ¡çº¿ç¨‹ RebalanceService çš„å¯åŠ¨ï¼ˆæ¯éš” 20s æ‰§è¡Œä¸€æ¬¡è´Ÿè½½å‡è¡¡ï¼‰ï¼ŒRebalanceService çº¿ç¨‹çš„ run() æ–¹æ³•æœ€ç»ˆè°ƒç”¨çš„æ˜¯ RebalanceImpl ç±»çš„ rebalanceByTopic() æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯å®ç° Consumer ç«¯è´Ÿè½½å‡è¡¡çš„æ ¸å¿ƒã€‚rebalanceByTopic() æ–¹æ³•ä¼šæ ¹æ®å¹¿æ’­æ¨¡å¼è¿˜æ˜¯é›†ç¾¤æ¨¡å¼åšä¸åŒçš„é€»è¾‘å¤„ç†ã€‚ä¸»è¦çœ‹é›†ç¾¤æ¨¡å¼ï¼š ä» rebalanceImpl å®ä¾‹çš„æœ¬åœ°ç¼“å­˜å˜é‡ topicSubscribeInfoTable ä¸­ï¼Œè·å–è¯¥ Topic ä¸»é¢˜ä¸‹çš„æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—é›†åˆ mqSet æ ¹æ® Topic å’Œ consumerGroup ä¸ºå‚æ•°è°ƒç”¨ mQClientFactory.findConsumerIdList() æ–¹æ³•å‘ Broker ç«¯å‘é€è·å–è¯¥æ¶ˆè´¹ç»„ä¸‹æ¶ˆè´¹è€… ID åˆ—è¡¨çš„ RPC é€šä¿¡è¯·æ±‚ï¼ˆBroker ç«¯åŸºäºå‰é¢ Consumer ç«¯ä¸ŠæŠ¥çš„å¿ƒè·³åŒ…æ•°æ®è€Œæ„å»ºçš„ consumerTable åšå‡ºå“åº”è¿”å›ï¼Œä¸šåŠ¡è¯·æ±‚ç  GET_CONSUMER_LIST_BY_GROUPï¼‰ å…ˆå¯¹ Topic ä¸‹çš„æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ã€æ¶ˆè´¹è€… ID æ’åºï¼Œç„¶åç”¨æ¶ˆæ¯é˜Ÿåˆ—åˆ†é…ç­–ç•¥ç®—æ³•ï¼ˆé»˜è®¤æ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„å¹³å‡åˆ†é…ç®—æ³•ï¼‰ï¼Œè®¡ç®—å‡ºå¾…æ‹‰å–çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚å¹³å‡åˆ†é…ç®—æ³•ç±»ä¼¼äºåˆ†é¡µçš„ç®—æ³•ï¼Œå°†æ‰€æœ‰ MessageQueue æ’å¥½åºç±»ä¼¼äºè®°å½•ï¼Œå°†æ‰€æœ‰æ¶ˆè´¹ç«¯ Consumer æ’å¥½åºç±»ä¼¼é¡µæ•°ï¼Œå¹¶æ±‚å‡ºæ¯ä¸€é¡µéœ€è¦åŒ…å«çš„å¹³å‡ size å’Œæ¯ä¸ªé¡µé¢è®°å½•çš„èŒƒå›´ rangeï¼Œæœ€åéå†æ•´ä¸ª range è€Œè®¡ç®—å‡ºå½“å‰ Consumer ç«¯åº”è¯¥åˆ†é…åˆ°çš„è®°å½•ï¼ˆè¿™é‡Œå³ä¸º MessageQueueï¼‰ è°ƒç”¨ updateProcessQueueTableInRebalance() æ–¹æ³•ï¼Œå…ˆå°†åˆ†é…åˆ°çš„æ¶ˆæ¯é˜Ÿåˆ—é›†åˆ mqSet ä¸ processQueueTable åšä¸€ä¸ªè¿‡æ»¤æ¯”å¯¹ processQueueTable æ ‡æ³¨çš„çº¢è‰²éƒ¨åˆ†ï¼Œè¡¨ç¤ºä¸åˆ†é…åˆ°çš„æ¶ˆæ¯é˜Ÿåˆ—é›†åˆ mqSet äº’ä¸åŒ…å«ï¼Œå°†è¿™äº›é˜Ÿåˆ—è®¾ç½® Dropped å±æ€§ä¸º trueï¼Œç„¶åæŸ¥çœ‹è¿™äº›é˜Ÿåˆ—æ˜¯å¦å¯ä»¥ç§»é™¤å‡º processQueueTable ç¼“å­˜å˜é‡ã€‚å…·ä½“æ‰§è¡Œ removeUnnecessaryMessageQueue() æ–¹æ³•ï¼Œå³æ¯éš” 1s æŸ¥çœ‹æ˜¯å¦å¯ä»¥è·å–å½“å‰æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—çš„é”ï¼Œæ‹¿åˆ°çš„è¯è¿”å› trueï¼›å¦‚æœç­‰å¾… 1s åï¼Œä»ç„¶æ‹¿ä¸åˆ°å½“å‰æ¶ˆè´¹å¤„ç†é˜Ÿåˆ—çš„é”åˆ™è¿”å› falseã€‚å¦‚æœè¿”å› trueï¼Œåˆ™ä» processQueueTable ç¼“å­˜å˜é‡ä¸­ç§»é™¤å¯¹åº”çš„ Entry processQueueTable çš„ç»¿è‰²éƒ¨åˆ†ï¼Œè¡¨ç¤ºä¸åˆ†é…åˆ°çš„æ¶ˆæ¯é˜Ÿåˆ—é›†åˆ mqSet çš„äº¤é›†ï¼Œåˆ¤æ–­è¯¥ ProcessQueue æ˜¯å¦å·²ç»è¿‡æœŸäº†ï¼Œåœ¨ Pull æ¨¡å¼çš„ä¸ç”¨ç®¡ï¼Œå¦‚æœæ˜¯ Push æ¨¡å¼çš„ï¼Œè®¾ç½® Dropped å±æ€§ä¸º trueï¼Œå¹¶ä¸”è°ƒç”¨ removeUnnecessaryMessageQueue() æ–¹æ³•ï¼Œåƒä¸Šé¢ä¸€æ ·å°è¯•ç§»é™¤ Entry ä¸ºè¿‡æ»¤åçš„æ¶ˆæ¯é˜Ÿåˆ—é›†åˆ mqSet ä¸­æ¯ä¸ª MessageQueue åˆ›å»º ProcessQueue å¯¹è±¡å­˜å…¥ RebalanceImpl çš„ processQueueTable é˜Ÿåˆ—ä¸­ï¼ˆå…¶ä¸­è°ƒç”¨ RebalanceImpl å®ä¾‹çš„ computePullFromWhere(MessageQueue mq) æ–¹æ³•è·å–è¯¥ MessageQueue å¯¹è±¡çš„ä¸‹ä¸€ä¸ªè¿›åº¦æ¶ˆè´¹å€¼ offsetï¼Œéšåå¡«å……è‡³æ¥ä¸‹æ¥è¦åˆ›å»ºçš„ pullRequest å¯¹è±¡å±æ€§ä¸­ï¼‰ï¼Œå¹¶åˆ›å»ºæ‹‰å–è¯·æ±‚å¯¹è±¡ pullRequest æ·»åŠ åˆ°æ‹‰å–åˆ—è¡¨ pullRequestList ä¸­ï¼Œæœ€åæ‰§è¡Œ dispatchPullRequest() æ–¹æ³•ï¼Œå°† Pull æ¶ˆæ¯çš„è¯·æ±‚å¯¹è±¡ PullRequest æ”¾å…¥ PullMessageService æœåŠ¡çº¿ç¨‹çš„é˜»å¡é˜Ÿåˆ— pullRequestQueue ä¸­ï¼Œå¾…è¯¥æœåŠ¡çº¿ç¨‹å–å‡ºåå‘ Broker ç«¯å‘èµ· Pull æ¶ˆæ¯çš„è¯·æ±‚ å¯¹æ¯”ä¸‹ RebalancePushImpl å’Œ RebalancePullImpl ä¸¤ä¸ªå®ç°ç±»çš„ dispatchPullRequest() æ–¹æ³•ï¼ŒRebalancePullImpl ç±»é‡Œé¢çš„è¯¥æ–¹æ³•ä¸ºç©º æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—åœ¨åŒä¸€æ¶ˆè´¹ç»„ä¸åŒæ¶ˆè´¹è€…ä¹‹é—´çš„è´Ÿè½½å‡è¡¡ï¼Œå…¶æ ¸å¿ƒè®¾è®¡ç†å¿µæ˜¯åœ¨ä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—åœ¨åŒä¸€æ—¶é—´åªå…è®¸è¢«åŒä¸€æ¶ˆè´¹ç»„å†…çš„ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹è€…èƒ½åŒæ—¶æ¶ˆè´¹å¤šä¸ªæ¶ˆæ¯é˜Ÿåˆ— æ¶ˆæ¯æŸ¥è¯¢æŸ¥è¯¢æ–¹å¼RocketMQ æ”¯æŒæŒ‰ç…§ä¸¤ç§ç»´åº¦è¿›è¡Œæ¶ˆæ¯æŸ¥è¯¢ï¼šæŒ‰ç…§ Message ID æŸ¥è¯¢æ¶ˆæ¯ã€æŒ‰ç…§ Message Key æŸ¥è¯¢æ¶ˆæ¯ RocketMQ ä¸­çš„ MessageID çš„é•¿åº¦æ€»å…±æœ‰ 16 å­—èŠ‚ï¼Œå…¶ä¸­åŒ…å«äº†æ¶ˆæ¯å­˜å‚¨ä¸»æœºåœ°å€ï¼ˆIP åœ°å€å’Œç«¯å£ï¼‰ï¼Œæ¶ˆæ¯ Commit Log offset å®ç°æ–¹å¼ï¼šClient ç«¯ä» MessageID ä¸­è§£æå‡º Broker çš„åœ°å€ï¼ˆIP åœ°å€å’Œç«¯å£ï¼‰å’Œ Commit Log çš„åç§»åœ°å€ï¼Œå°è£…æˆä¸€ä¸ª RPC è¯·æ±‚åé€šè¿‡ Remoting é€šä¿¡å±‚å‘é€ï¼ˆä¸šåŠ¡è¯·æ±‚ç  VIEW_MESSAGE_BY_IDï¼‰ã€‚Broker ç«¯èµ°çš„æ˜¯ QueryMessageProcessorï¼Œè¯»å–æ¶ˆæ¯çš„è¿‡ç¨‹ç”¨å…¶ä¸­çš„ CommitLog çš„ offset å’Œ size å» CommitLog ä¸­æ‰¾åˆ°çœŸæ­£çš„è®°å½•å¹¶è§£ææˆä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯è¿”å› æŒ‰ç…§ Message Key æŸ¥è¯¢æ¶ˆæ¯ï¼ŒIndexFile ç´¢å¼•æ–‡ä»¶ä¸ºæä¾›äº†é€šè¿‡ Message Key æŸ¥è¯¢æ¶ˆæ¯çš„æœåŠ¡ å®ç°æ–¹å¼ï¼šé€šè¿‡ Broker ç«¯çš„ QueryMessageProcessor ä¸šåŠ¡å¤„ç†å™¨æ¥æŸ¥è¯¢ï¼Œè¯»å–æ¶ˆæ¯çš„è¿‡ç¨‹ç”¨ Topic å’Œ Key æ‰¾åˆ° IndexFile ç´¢å¼•æ–‡ä»¶ä¸­çš„ä¸€æ¡è®°å½•ï¼Œæ ¹æ®å…¶ä¸­çš„ CommitLog Offset ä» CommitLog æ–‡ä»¶ä¸­è¯»å–æ¶ˆæ¯çš„å®ä½“å†…å®¹ ç´¢å¼•æœºåˆ¶RocketMQ çš„ç´¢å¼•æ–‡ä»¶é€»è¾‘ç»“æ„ï¼Œç±»ä¼¼ JDK ä¸­ HashMap çš„å®ç°ï¼Œå…·ä½“ç»“æ„å¦‚ä¸‹ï¼š IndexFile æ–‡ä»¶çš„å­˜å‚¨åœ¨ $HOME\\store\\index$&#123;fileName&#125;ï¼Œæ–‡ä»¶å fileName æ˜¯ä»¥åˆ›å»ºæ—¶çš„æ—¶é—´æˆ³å‘½åï¼Œæ–‡ä»¶å¤§å°æ˜¯å›ºå®šçš„ï¼Œç­‰äº 40+500W*4+2000W*20= 420000040 ä¸ªå­—èŠ‚å¤§å°ã€‚å¦‚æœæ¶ˆæ¯çš„ properties ä¸­è®¾ç½®äº† UNIQ_KEY è¿™ä¸ªå±æ€§ï¼Œå°±ç”¨ topic + â€œ#â€ + UNIQ_KEY ä½œä¸º key æ¥åšå†™å…¥æ“ä½œï¼›å¦‚æœæ¶ˆæ¯è®¾ç½®äº† KEYS å±æ€§ï¼ˆå¤šä¸ª KEY ä»¥ç©ºæ ¼åˆ†éš”ï¼‰ï¼Œä¹Ÿä¼šç”¨ topic + â€œ#â€ + KEY æ¥åšç´¢å¼• æ•´ä¸ª Index File çš„ç»“æ„å¦‚å›¾ï¼Œ40 Byte çš„ Header ç”¨äºä¿å­˜ä¸€äº›æ€»çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œ4*500W çš„ Slot Table å¹¶ä¸ä¿å­˜çœŸæ­£çš„ç´¢å¼•æ•°æ®ï¼Œè€Œæ˜¯ä¿å­˜æ¯ä¸ªæ§½ä½å¯¹åº”çš„å•å‘é“¾è¡¨çš„å¤´æŒ‡é’ˆï¼Œå³ä¸€ä¸ª Index File å¯ä»¥ä¿å­˜ 2000W ä¸ªç´¢å¼•ï¼Œ20*2000W æ˜¯çœŸæ­£çš„ç´¢å¼•æ•°æ® ç´¢å¼•æ•°æ®åŒ…å«äº† Key Hash&#x2F;CommitLog Offset&#x2F;Timestamp&#x2F;NextIndex offset è¿™å››ä¸ªå­—æ®µï¼Œä¸€å…± 20 Byte NextIndex offset å³å‰é¢è¯»å‡ºæ¥çš„ slotValueï¼Œå¦‚æœæœ‰ hash å†²çªï¼Œå°±å¯ä»¥ç”¨è¿™ä¸ªå­—æ®µå°†æ‰€æœ‰å†²çªçš„ç´¢å¼•ç”¨é“¾è¡¨çš„æ–¹å¼ä¸²èµ·æ¥ Timestamp è®°å½•çš„æ˜¯æ¶ˆæ¯ storeTimestamp ä¹‹é—´çš„å·®ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªç»å¯¹çš„æ—¶é—´ å‚è€ƒæ–‡æ¡£ï¼šhttps://github.com/apache/rocketmq/blob/master/docs/cn/design.md æ¶ˆæ¯é‡è¯•æ¶ˆæ¯é‡æŠ•ç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯æ—¶ï¼ŒåŒæ­¥æ¶ˆæ¯å’Œå¼‚æ­¥æ¶ˆæ¯å¤±è´¥ä¼šé‡æŠ•ï¼Œoneway æ²¡æœ‰ä»»ä½•ä¿è¯ã€‚æ¶ˆæ¯é‡æŠ•ä¿è¯æ¶ˆæ¯å°½å¯èƒ½å‘é€æˆåŠŸã€ä¸ä¸¢å¤±ï¼Œä½†å½“å‡ºç°æ¶ˆæ¯é‡å¤§ã€ç½‘ç»œæŠ–åŠ¨æ—¶ï¼Œå¯èƒ½ä¼šé€ æˆæ¶ˆæ¯é‡å¤ï¼›ç”Ÿäº§è€…ä¸»åŠ¨é‡å‘ã€Consumer è´Ÿè½½å˜åŒ–ä¹Ÿä¼šå¯¼è‡´é‡å¤æ¶ˆæ¯ å¦‚ä¸‹æ–¹æ³•å¯ä»¥è®¾ç½®æ¶ˆæ¯é‡æŠ•ç­–ç•¥ï¼š retryTimesWhenSendFailedï¼šåŒæ­¥å‘é€å¤±è´¥é‡æŠ•æ¬¡æ•°ï¼Œé»˜è®¤ä¸º 2ï¼Œå› æ­¤ç”Ÿäº§è€…ä¼šæœ€å¤šå°è¯•å‘é€ retryTimesWhenSendFailed + 1 æ¬¡ã€‚ä¸ä¼šé€‰æ‹©ä¸Šæ¬¡å¤±è´¥çš„ Brokerï¼Œå°è¯•å‘å…¶ä»– Broker å‘é€ï¼Œæœ€å¤§ç¨‹åº¦ä¿è¯æ¶ˆæ¯ä¸ä¸¢ã€‚è¶…è¿‡é‡æŠ•æ¬¡æ•°æŠ›å‡ºå¼‚å¸¸ï¼Œç”±å®¢æˆ·ç«¯ä¿è¯æ¶ˆæ¯ä¸ä¸¢ã€‚å½“å‡ºç° RemotingExceptionã€MQClientException å’Œéƒ¨åˆ† MQBrokerException æ—¶ä¼šé‡æŠ• retryTimesWhenSendAsyncFailedï¼šå¼‚æ­¥å‘é€å¤±è´¥é‡è¯•æ¬¡æ•°ï¼Œå¼‚æ­¥é‡è¯•ä¸ä¼šé€‰æ‹©å…¶ä»– Brokerï¼Œä»…åœ¨åŒä¸€ä¸ª Broker ä¸Šåšé‡è¯•ï¼Œä¸ä¿è¯æ¶ˆæ¯ä¸ä¸¢ retryAnotherBrokerWhenNotStoreOKï¼šæ¶ˆæ¯åˆ·ç›˜ï¼ˆä¸»æˆ–å¤‡ï¼‰è¶…æ—¶æˆ– slave ä¸å¯ç”¨ï¼ˆè¿”å›çŠ¶æ€é SEND_OKï¼‰ï¼Œæ˜¯å¦å°è¯•å‘é€åˆ°å…¶ä»– Brokerï¼Œé»˜è®¤ falseï¼Œååˆ†é‡è¦æ¶ˆæ¯å¯ä»¥å¼€å¯ æ³¨æ„ç‚¹ï¼š å¦‚æœåŒæ­¥æ¨¡å¼å‘é€å¤±è´¥ï¼Œåˆ™é€‰æ‹©åˆ°ä¸‹ä¸€ä¸ª Brokerï¼Œå¦‚æœå¼‚æ­¥æ¨¡å¼å‘é€å¤±è´¥ï¼Œåˆ™åªä¼šåœ¨å½“å‰ Broker è¿›è¡Œé‡è¯• å‘é€æ¶ˆæ¯è¶…æ—¶æ—¶é—´é»˜è®¤ 3000 æ¯«ç§’ï¼Œå°±ä¸ä¼šå†å°è¯•é‡è¯• æ¶ˆæ¯é‡è¯•Consumer æ¶ˆè´¹æ¶ˆæ¯å¤±è´¥åï¼Œæä¾›äº†ä¸€ç§é‡è¯•æœºåˆ¶ï¼Œä»¤æ¶ˆæ¯å†æ¶ˆè´¹ä¸€æ¬¡ã€‚Consumer æ¶ˆè´¹æ¶ˆæ¯å¤±è´¥å¯ä»¥è®¤ä¸ºæœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š ç”±äºæ¶ˆæ¯æœ¬èº«çš„åŸå› ï¼Œä¾‹å¦‚ååºåˆ—åŒ–å¤±è´¥ï¼Œæ¶ˆæ¯æ•°æ®æœ¬èº«æ— æ³•å¤„ç†ç­‰ã€‚è¿™ç§é”™è¯¯é€šå¸¸éœ€è¦è·³è¿‡è¿™æ¡æ¶ˆæ¯ï¼Œå†æ¶ˆè´¹å…¶å®ƒæ¶ˆæ¯ï¼Œè€Œè¿™æ¡å¤±è´¥çš„æ¶ˆæ¯å³ä½¿ç«‹åˆ»é‡è¯•æ¶ˆè´¹ï¼Œ99% ä¹Ÿä¸æˆåŠŸï¼Œæ‰€ä»¥éœ€è¦æä¾›ä¸€ç§å®šæ—¶é‡è¯•æœºåˆ¶ï¼Œå³è¿‡ 10 ç§’åå†é‡è¯• ç”±äºä¾èµ–çš„ä¸‹æ¸¸åº”ç”¨æœåŠ¡ä¸å¯ç”¨ï¼Œä¾‹å¦‚ DB è¿æ¥ä¸å¯ç”¨ï¼Œå¤–ç³»ç»Ÿç½‘ç»œä¸å¯è¾¾ç­‰ã€‚è¿™ç§æƒ…å†µå³ä½¿è·³è¿‡å½“å‰å¤±è´¥çš„æ¶ˆæ¯ï¼Œæ¶ˆè´¹å…¶ä»–æ¶ˆæ¯åŒæ ·ä¹Ÿä¼šæŠ¥é”™ï¼Œè¿™ç§æƒ…å†µå»ºè®®åº”ç”¨ sleep 30sï¼Œå†æ¶ˆè´¹ä¸‹ä¸€æ¡æ¶ˆæ¯ï¼Œè¿™æ ·å¯ä»¥å‡è½» Broker é‡è¯•æ¶ˆæ¯çš„å‹åŠ› RocketMQ ä¼šä¸ºæ¯ä¸ªæ¶ˆè´¹ç»„éƒ½è®¾ç½®ä¸€ä¸ª Topic åç§°ä¸º %RETRY%+consumerGroup çš„é‡è¯•é˜Ÿåˆ—ï¼ˆè¿™ä¸ª Topic çš„é‡è¯•é˜Ÿåˆ—æ˜¯é’ˆå¯¹æ¶ˆè´¹ç»„ï¼Œè€Œä¸æ˜¯é’ˆå¯¹æ¯ä¸ª Topic è®¾ç½®çš„ï¼‰ï¼Œç”¨äºæš‚æ—¶ä¿å­˜å› ä¸ºå„ç§å¼‚å¸¸è€Œå¯¼è‡´ Consumer ç«¯æ— æ³•æ¶ˆè´¹çš„æ¶ˆæ¯ é¡ºåºæ¶ˆæ¯çš„é‡è¯•ï¼Œå½“æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯å¤±è´¥åï¼Œæ¶ˆæ¯é˜Ÿåˆ— RocketMQ ä¼šè‡ªåŠ¨ä¸æ–­è¿›è¡Œæ¶ˆæ¯é‡è¯•ï¼ˆæ¯æ¬¡é—´éš”æ—¶é—´ä¸º 1 ç§’ï¼‰ï¼Œè¿™æ—¶åº”ç”¨ä¼šå‡ºç°æ¶ˆæ¯æ¶ˆè´¹è¢«é˜»å¡çš„æƒ…å†µã€‚æ‰€ä»¥åœ¨ä½¿ç”¨é¡ºåºæ¶ˆæ¯æ—¶ï¼Œå¿…é¡»ä¿è¯åº”ç”¨èƒ½å¤ŸåŠæ—¶ç›‘æ§å¹¶å¤„ç†æ¶ˆè´¹å¤±è´¥çš„æƒ…å†µï¼Œé¿å…é˜»å¡ç°è±¡çš„å‘ç”Ÿ æ— åºæ¶ˆæ¯ï¼ˆæ™®é€šã€å®šæ—¶ã€å»¶æ—¶ã€äº‹åŠ¡æ¶ˆæ¯ï¼‰çš„é‡è¯•ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®è¿”å›çŠ¶æ€è¾¾åˆ°æ¶ˆæ¯é‡è¯•çš„ç»“æœã€‚æ— åºæ¶ˆæ¯çš„é‡è¯•åªé’ˆå¯¹é›†ç¾¤æ¶ˆè´¹æ–¹å¼ç”Ÿæ•ˆï¼Œå¹¿æ’­æ–¹å¼ä¸æä¾›å¤±è´¥é‡è¯•ç‰¹æ€§ï¼Œå³æ¶ˆè´¹å¤±è´¥åï¼Œå¤±è´¥æ¶ˆæ¯ä¸å†é‡è¯•ï¼Œç»§ç»­æ¶ˆè´¹æ–°çš„æ¶ˆæ¯ æ— åºæ¶ˆæ¯æƒ…å†µä¸‹ï¼Œå› ä¸ºå¼‚å¸¸æ¢å¤éœ€è¦ä¸€äº›æ—¶é—´ï¼Œä¼šä¸ºé‡è¯•é˜Ÿåˆ—è®¾ç½®å¤šä¸ªé‡è¯•çº§åˆ«ï¼Œæ¯ä¸ªé‡è¯•çº§åˆ«éƒ½æœ‰å¯¹åº”çš„é‡æ–°æŠ•é€’å»¶æ—¶ï¼Œé‡è¯•æ¬¡æ•°è¶Šå¤šæŠ•é€’å»¶æ—¶å°±è¶Šå¤§ã€‚RocketMQ å¯¹äºé‡è¯•æ¶ˆæ¯çš„å¤„ç†æ˜¯å…ˆä¿å­˜è‡³ Topic åç§°ä¸º SCHEDULE_TOPIC_XXXX çš„å»¶è¿Ÿé˜Ÿåˆ—ä¸­ï¼Œåå°å®šæ—¶ä»»åŠ¡æŒ‰ç…§å¯¹åº”çš„æ—¶é—´è¿›è¡Œ Delay åé‡æ–°ä¿å­˜è‡³ %RETRY%+consumerGroup çš„é‡è¯•é˜Ÿåˆ—ä¸­ æ¶ˆæ¯é˜Ÿåˆ— RocketMQ é»˜è®¤å…è®¸æ¯æ¡æ¶ˆæ¯æœ€å¤šé‡è¯• 16 æ¬¡ï¼Œæ¯æ¬¡é‡è¯•çš„é—´éš”æ—¶é—´å¦‚ä¸‹è¡¨ç¤ºï¼š ç¬¬å‡ æ¬¡é‡è¯• ä¸ä¸Šæ¬¡é‡è¯•çš„é—´éš”æ—¶é—´ ç¬¬å‡ æ¬¡é‡è¯• ä¸ä¸Šæ¬¡é‡è¯•çš„é—´éš”æ—¶é—´ 1 10 ç§’ 9 7 åˆ†é’Ÿ 2 30 ç§’ 10 8 åˆ†é’Ÿ 3 1 åˆ†é’Ÿ 11 9 åˆ†é’Ÿ 4 2 åˆ†é’Ÿ 12 10 åˆ†é’Ÿ 5 3 åˆ†é’Ÿ 13 20 åˆ†é’Ÿ 6 4 åˆ†é’Ÿ 14 30 åˆ†é’Ÿ 7 5 åˆ†é’Ÿ 15 1 å°æ—¶ 8 6 åˆ†é’Ÿ 16 2 å°æ—¶ å¦‚æœæ¶ˆæ¯é‡è¯• 16 æ¬¡åä»ç„¶å¤±è´¥ï¼Œæ¶ˆæ¯å°†ä¸å†æŠ•é€’ï¼Œå¦‚æœä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°é‡è¯•æ—¶é—´é—´éš”è®¡ç®—ï¼ŒæŸæ¡æ¶ˆæ¯åœ¨ä¸€ç›´æ¶ˆè´¹å¤±è´¥çš„å‰æä¸‹ï¼Œå°†ä¼šåœ¨æ¥ä¸‹æ¥çš„ 4 å°æ—¶ 46 åˆ†é’Ÿä¹‹å†…è¿›è¡Œ 16 æ¬¡é‡è¯•ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´èŒƒå›´æ¶ˆæ¯å°†ä¸å†é‡è¯•æŠ•é€’ æ—¶é—´é—´éš”ä¸æ”¯æŒè‡ªå®šä¹‰é…ç½®ï¼Œæœ€å¤§é‡è¯•æ¬¡æ•°å¯é€šè¿‡è‡ªå®šä¹‰å‚æ•° MaxReconsumeTimes å–å€¼è¿›è¡Œé…ç½®ï¼Œè‹¥é…ç½®è¶…è¿‡ 16 æ¬¡ï¼Œåˆ™è¶…è¿‡çš„é—´éš”æ—¶é—´å‡ä¸º 2 å°æ—¶ è¯´æ˜ï¼šä¸€æ¡æ¶ˆæ¯æ— è®ºé‡è¯•å¤šå°‘æ¬¡ï¼Œæ¶ˆæ¯çš„ Message ID æ˜¯ä¸ä¼šæ”¹å˜çš„ é‡è¯•æ“ä½œé›†ç¾¤æ¶ˆè´¹æ–¹å¼ä¸‹ï¼Œæ¶ˆæ¯æ¶ˆè´¹å¤±è´¥åæœŸæœ›æ¶ˆæ¯é‡è¯•ï¼Œéœ€è¦åœ¨æ¶ˆæ¯ç›‘å¬å™¨æ¥å£çš„å®ç°ä¸­æ˜ç¡®è¿›è¡Œé…ç½®ï¼ˆä¸‰ç§æ–¹å¼ä»»é€‰ä¸€ç§ï¼‰ï¼š è¿”å› Action.ReconsumeLater ï¼ˆæ¨èï¼‰ è¿”å› null æŠ›å‡ºå¼‚å¸¸ 12345678910111213public class MessageListenerImpl implements MessageListener &#123; @Override public Action consume(Message message, ConsumeContext context) &#123; // å¤„ç†æ¶ˆæ¯ doConsumeMessage(message); //æ–¹å¼1ï¼šè¿”å› Action.ReconsumeLaterï¼Œæ¶ˆæ¯å°†é‡è¯• return Action.ReconsumeLater; //æ–¹å¼2ï¼šè¿”å› nullï¼Œæ¶ˆæ¯å°†é‡è¯• return null; //æ–¹å¼3ï¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œ æ¶ˆæ¯å°†é‡è¯• throw new RuntimeException(&quot;Consumer Message exceotion&quot;); &#125;&#125; é›†ç¾¤æ¶ˆè´¹æ–¹å¼ä¸‹ï¼Œæ¶ˆæ¯å¤±è´¥åæœŸæœ›æ¶ˆæ¯ä¸é‡è¯•ï¼Œéœ€è¦æ•è·æ¶ˆè´¹é€»è¾‘ä¸­å¯èƒ½æŠ›å‡ºçš„å¼‚å¸¸ï¼Œæœ€ç»ˆè¿”å› Action.CommitMessageï¼Œæ­¤åè¿™æ¡æ¶ˆæ¯å°†ä¸ä¼šå†é‡è¯• 12345678910111213public class MessageListenerImpl implements MessageListener &#123; @Override public Action consume(Message message, ConsumeContext context) &#123; try &#123; doConsumeMessage(message); &#125; catch (Throwable e) &#123; // æ•è·æ¶ˆè´¹é€»è¾‘ä¸­çš„æ‰€æœ‰å¼‚å¸¸ï¼Œå¹¶è¿”å› Action.CommitMessage; return Action.CommitMessage; &#125; //æ¶ˆæ¯å¤„ç†æ­£å¸¸ï¼Œç›´æ¥è¿”å› Action.CommitMessage; return Action.CommitMessage; &#125;&#125; è‡ªå®šä¹‰æ¶ˆæ¯æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ŒRocketMQ å…è®¸ Consumer å¯åŠ¨çš„æ—¶å€™è®¾ç½®æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œé‡è¯•æ—¶é—´é—´éš”å°†æŒ‰ç…§å¦‚ä¸‹ç­–ç•¥ï¼š æœ€å¤§é‡è¯•æ¬¡æ•°å°äºç­‰äº 16 æ¬¡ï¼Œåˆ™é‡è¯•æ—¶é—´é—´éš”åŒä¸Šè¡¨æè¿° æœ€å¤§é‡è¯•æ¬¡æ•°å¤§äº 16 æ¬¡ï¼Œè¶…è¿‡ 16 æ¬¡çš„é‡è¯•æ—¶é—´é—´éš”å‡ä¸ºæ¯æ¬¡ 2 å°æ—¶ 1234Properties properties = new Properties();// é…ç½®å¯¹åº” Group ID çš„æœ€å¤§æ¶ˆæ¯é‡è¯•æ¬¡æ•°ä¸º 20 æ¬¡properties.put(PropertyKeyConst.MaxReconsumeTimes,&quot;20&quot;);Consumer consumer = ONSFactory.createConsumer(properties); æ³¨æ„ï¼š æ¶ˆæ¯æœ€å¤§é‡è¯•æ¬¡æ•°çš„è®¾ç½®å¯¹ç›¸åŒ Group ID ä¸‹çš„æ‰€æœ‰ Consumer å®ä¾‹æœ‰æ•ˆã€‚ä¾‹å¦‚åªå¯¹ç›¸åŒ Group ID ä¸‹ä¸¤ä¸ª Consumer å®ä¾‹ä¸­çš„å…¶ä¸­ä¸€ä¸ªè®¾ç½®äº† MaxReconsumeTimesï¼Œé‚£ä¹ˆè¯¥é…ç½®å¯¹ä¸¤ä¸ª Consumer å®ä¾‹å‡ç”Ÿæ•ˆ é…ç½®é‡‡ç”¨è¦†ç›–çš„æ–¹å¼ç”Ÿæ•ˆï¼Œå³æœ€åå¯åŠ¨çš„ Consumer å®ä¾‹ä¼šè¦†ç›–ä¹‹å‰çš„å¯åŠ¨å®ä¾‹çš„é…ç½® æ¶ˆè´¹è€…æ”¶åˆ°æ¶ˆæ¯åï¼Œå¯æŒ‰ç…§å¦‚ä¸‹æ–¹å¼è·å–æ¶ˆæ¯çš„é‡è¯•æ¬¡æ•°ï¼š 12345678public class MessageListenerImpl implements MessageListener &#123; @Override public Action consume(Message message, ConsumeContext context) &#123; // è·å–æ¶ˆæ¯çš„é‡è¯•æ¬¡æ•° System.out.println(message.getReconsumeTimes()); return Action.CommitMessage; &#125;&#125; æ­»ä¿¡é˜Ÿåˆ—æ­£å¸¸æƒ…å†µä¸‹æ— æ³•è¢«æ¶ˆè´¹çš„æ¶ˆæ¯ç§°ä¸ºæ­»ä¿¡æ¶ˆæ¯ï¼ˆDead-Letter Messageï¼‰ï¼Œå­˜å‚¨æ­»ä¿¡æ¶ˆæ¯çš„ç‰¹æ®Šé˜Ÿåˆ—ç§°ä¸ºæ­»ä¿¡é˜Ÿåˆ—ï¼ˆDead-Letter Queueï¼‰ å½“ä¸€æ¡æ¶ˆæ¯åˆæ¬¡æ¶ˆè´¹å¤±è´¥ï¼Œæ¶ˆæ¯é˜Ÿåˆ— RocketMQ ä¼šè‡ªåŠ¨è¿›è¡Œæ¶ˆæ¯é‡è¯•ï¼Œè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°åï¼Œè‹¥æ¶ˆè´¹ä¾ç„¶å¤±è´¥ï¼Œåˆ™è¡¨æ˜æ¶ˆè´¹è€…åœ¨æ­£å¸¸æƒ…å†µä¸‹æ— æ³•æ­£ç¡®åœ°æ¶ˆè´¹è¯¥æ¶ˆæ¯ï¼Œæ­¤æ—¶ RocketMQ ä¸ä¼šç«‹åˆ»å°†æ¶ˆæ¯ä¸¢å¼ƒï¼Œè€Œæ˜¯å°†å…¶å‘é€åˆ°è¯¥æ¶ˆè´¹è€…å¯¹åº”çš„æ­»ä¿¡é˜Ÿåˆ—ä¸­ æ­»ä¿¡æ¶ˆæ¯å…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š ä¸ä¼šå†è¢«æ¶ˆè´¹è€…æ­£å¸¸æ¶ˆè´¹ æœ‰æ•ˆæœŸä¸æ­£å¸¸æ¶ˆæ¯ç›¸åŒï¼Œå‡ä¸º 3 å¤©ï¼Œ3 å¤©åä¼šè¢«è‡ªåŠ¨åˆ é™¤ï¼Œæ‰€ä»¥è¯·åœ¨æ­»ä¿¡æ¶ˆæ¯äº§ç”Ÿåçš„ 3 å¤©å†…åŠæ—¶å¤„ç† æ­»ä¿¡é˜Ÿåˆ—å…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š ä¸€ä¸ªæ­»ä¿¡é˜Ÿåˆ—å¯¹åº”ä¸€ä¸ª Group IDï¼Œ è€Œä¸æ˜¯å¯¹åº”å•ä¸ªæ¶ˆè´¹è€…å®ä¾‹ å¦‚æœä¸€ä¸ª Group ID æœªäº§ç”Ÿæ­»ä¿¡æ¶ˆæ¯ï¼Œæ¶ˆæ¯é˜Ÿåˆ— RocketMQ ä¸ä¼šä¸ºå…¶åˆ›å»ºç›¸åº”çš„æ­»ä¿¡é˜Ÿåˆ— ä¸€ä¸ªæ­»ä¿¡é˜Ÿåˆ—åŒ…å«äº†å¯¹åº” Group ID äº§ç”Ÿçš„æ‰€æœ‰æ­»ä¿¡æ¶ˆæ¯ï¼Œä¸è®ºè¯¥æ¶ˆæ¯å±äºå“ªä¸ª Topic ä¸€æ¡æ¶ˆæ¯è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼Œéœ€è¦æ’æŸ¥å¯ç–‘å› ç´ å¹¶è§£å†³é—®é¢˜åï¼Œå¯ä»¥åœ¨æ¶ˆæ¯é˜Ÿåˆ— RocketMQ æ§åˆ¶å°é‡æ–°å‘é€è¯¥æ¶ˆæ¯ï¼Œè®©æ¶ˆè´¹è€…é‡æ–°æ¶ˆè´¹ä¸€æ¬¡ é«˜å¯é æ€§RocketMQ æ¶ˆæ¯ä¸¢å¤±å¯èƒ½å‘ç”Ÿåœ¨ä»¥ä¸‹ä¸‰ä¸ªé˜¶æ®µï¼š ç”Ÿäº§é˜¶æ®µï¼šæ¶ˆæ¯åœ¨ Producer å‘é€ç«¯åˆ›å»ºå‡ºæ¥ï¼Œç»è¿‡ç½‘ç»œä¼ è¾“å‘é€åˆ° Broker å­˜å‚¨ç«¯ ç”Ÿäº§è€…å¾—åˆ°ä¸€ä¸ªæˆåŠŸçš„å“åº”ï¼Œå°±å¯ä»¥è®¤ä¸ºæ¶ˆæ¯çš„å­˜å‚¨å’Œæ¶ˆæ¯çš„æ¶ˆè´¹éƒ½æ˜¯å¯é çš„ æ¶ˆæ¯é‡æŠ•æœºåˆ¶ å­˜å‚¨é˜¶æ®µï¼šæ¶ˆæ¯åœ¨ Broker ç«¯å­˜å‚¨ï¼Œå¦‚æœæ˜¯ä¸»å¤‡æˆ–è€…å¤šå‰¯æœ¬ï¼Œæ¶ˆæ¯ä¼šåœ¨è¿™ä¸ªé˜¶æ®µè¢«å¤åˆ¶åˆ°å…¶ä»–çš„èŠ‚ç‚¹æˆ–è€…å‰¯æœ¬ä¸Š å•ç‚¹ï¼šåˆ·ç›˜æœºåˆ¶ï¼ˆåŒæ­¥æˆ–å¼‚æ­¥ï¼‰ ä¸»ä»ï¼šæ¶ˆæ¯åŒæ­¥æœºåˆ¶ï¼ˆå¼‚æ­¥å¤åˆ¶æˆ–åŒæ­¥åŒå†™ï¼Œä¸»ä»å¤åˆ¶ç« èŠ‚è¯¦è§£ï¼‰ è¿‡æœŸåˆ é™¤ï¼šæ“ä½œ CommitLogã€ConsumeQueue æ–‡ä»¶æ˜¯åŸºäºæ–‡ä»¶å†…å­˜æ˜ å°„æœºåˆ¶ï¼Œå¹¶ä¸”åœ¨å¯åŠ¨çš„æ—¶å€™ä¼šå°†æ‰€æœ‰çš„æ–‡ä»¶åŠ è½½ï¼Œä¸ºäº†é¿å…å†…å­˜ä¸ç£ç›˜çš„æµªè´¹ï¼Œè®©ç£ç›˜èƒ½å¤Ÿå¾ªç¯åˆ©ç”¨ï¼Œé˜²æ­¢ç£ç›˜ä¸è¶³å¯¼è‡´æ¶ˆæ¯æ— æ³•å†™å…¥ç­‰å¼•å…¥äº†æ–‡ä»¶è¿‡æœŸåˆ é™¤æœºåˆ¶ã€‚æœ€ç»ˆä½¿å¾—ç£ç›˜æ°´ä½ä¿æŒåœ¨ä¸€å®šæ°´å¹³ï¼Œæœ€ç»ˆä¿è¯æ–°å†™å…¥æ¶ˆæ¯çš„å¯é å­˜å‚¨ æ¶ˆè´¹é˜¶æ®µï¼šConsumer æ¶ˆè´¹ç«¯ä» Brokerå­˜å‚¨ç«¯æ‹‰å–æ¶ˆæ¯ï¼Œç»è¿‡ç½‘ç»œä¼ è¾“å‘é€åˆ° Consumer æ¶ˆè´¹ç«¯ä¸Š æ¶ˆæ¯é‡è¯•æœºåˆ¶æ¥æœ€å¤§é™åº¦çš„ä¿è¯æ¶ˆæ¯çš„æ¶ˆè´¹ æ¶ˆè´¹å¤±è´¥çš„è¿›è¡Œæ¶ˆæ¯å›é€€ï¼Œé‡è¯•æ¬¡æ•°è¿‡å¤šçš„æ¶ˆæ¯æ”¾å…¥æ­»ä¿¡é˜Ÿåˆ— æ¨èæ–‡ç« ï¼šhttps://cdn.modb.pro/db/394751 å¹‚ç­‰æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ— RocketMQ æ¶ˆè´¹è€…åœ¨æ¥æ”¶åˆ°æ¶ˆæ¯ä»¥åï¼Œéœ€è¦æ ¹æ®ä¸šåŠ¡ä¸Šçš„å”¯ä¸€ Key å¯¹æ¶ˆæ¯åšå¹‚ç­‰å¤„ç† At least Once æœºåˆ¶ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Œä½†æ˜¯å¯èƒ½ä¼šé€ æˆæ¶ˆæ¯é‡å¤ï¼ŒRocketMQ ä¸­æ— æ³•é¿å…æ¶ˆæ¯é‡å¤ï¼ˆExactly-Onceï¼‰ï¼Œåœ¨äº’è”ç½‘åº”ç”¨ä¸­ï¼Œå°¤å…¶åœ¨ç½‘ç»œä¸ç¨³å®šçš„æƒ…å†µä¸‹ï¼Œå‡ ç§æƒ…å†µï¼š å‘é€æ—¶æ¶ˆæ¯é‡å¤ï¼šå½“ä¸€æ¡æ¶ˆæ¯å·²è¢«æˆåŠŸå‘é€åˆ°æœåŠ¡ç«¯å¹¶å®ŒæˆæŒä¹…åŒ–ï¼Œæ­¤æ—¶å‡ºç°äº†ç½‘ç»œé—ªæ–­æˆ–å®¢æˆ·ç«¯å®•æœºï¼Œå¯¼è‡´æœåŠ¡ç«¯å¯¹å®¢æˆ·ç«¯åº”ç­”å¤±è´¥ã€‚æ­¤æ—¶ç”Ÿäº§è€…æ„è¯†åˆ°æ¶ˆæ¯å‘é€å¤±è´¥å¹¶å°è¯•å†æ¬¡å‘é€æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…åç»­ä¼šæ”¶åˆ°ä¸¤æ¡å†…å®¹ç›¸åŒå¹¶ä¸” Message ID ä¹Ÿç›¸åŒçš„æ¶ˆæ¯ æŠ•é€’æ—¶æ¶ˆæ¯é‡å¤ï¼šæ¶ˆæ¯æ¶ˆè´¹çš„åœºæ™¯ä¸‹ï¼Œæ¶ˆæ¯å·²æŠ•é€’åˆ°æ¶ˆè´¹è€…å¹¶å®Œæˆä¸šåŠ¡å¤„ç†ï¼Œå½“å®¢æˆ·ç«¯ç»™æœåŠ¡ç«¯åé¦ˆåº”ç­”çš„æ—¶å€™ç½‘ç»œé—ªæ–­ã€‚ä¸ºäº†ä¿è¯æ¶ˆæ¯è‡³å°‘è¢«æ¶ˆè´¹ä¸€æ¬¡ï¼Œæ¶ˆæ¯é˜Ÿåˆ— RocketMQ çš„æœåŠ¡ç«¯å°†åœ¨ç½‘ç»œæ¢å¤åå†æ¬¡å°è¯•æŠ•é€’ä¹‹å‰å·²è¢«å¤„ç†è¿‡çš„æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…åç»­ä¼šæ”¶åˆ°ä¸¤æ¡å†…å®¹ç›¸åŒå¹¶ä¸” Message ID ä¹Ÿç›¸åŒçš„æ¶ˆæ¯ è´Ÿè½½å‡è¡¡æ—¶æ¶ˆæ¯é‡å¤ï¼šå½“æ¶ˆæ¯é˜Ÿåˆ— RocketMQ çš„ Broker æˆ–å®¢æˆ·ç«¯é‡å¯ã€æ‰©å®¹æˆ–ç¼©å®¹æ—¶ï¼Œä¼šè§¦å‘ Rebalanceï¼Œæ­¤æ—¶æ¶ˆè´¹è€…å¯èƒ½ä¼šæ”¶åˆ°é‡å¤æ¶ˆæ¯ å¤„ç†æ–¹å¼ï¼š å› ä¸º Message ID æœ‰å¯èƒ½å‡ºç°å†²çªï¼ˆé‡å¤ï¼‰çš„æƒ…å†µï¼Œæ‰€ä»¥çœŸæ­£å®‰å…¨çš„å¹‚ç­‰å¤„ç†ï¼Œä¸å»ºè®®ä»¥ Message ID ä½œä¸ºå¤„ç†ä¾æ®ï¼Œæœ€å¥½çš„æ–¹å¼æ˜¯ä»¥ä¸šåŠ¡å”¯ä¸€æ ‡è¯†ä½œä¸ºå¹‚ç­‰å¤„ç†çš„å…³é”®ä¾æ®ï¼Œè€Œä¸šåŠ¡çš„å”¯ä¸€æ ‡è¯†å¯ä»¥é€šè¿‡æ¶ˆæ¯ Key è¿›è¡Œè®¾ç½®ï¼š 123Message message = new Message();message.setKey(&quot;ORDERID_100&quot;);SendResult sendResult = producer.send(message); è®¢é˜…æ–¹æ”¶åˆ°æ¶ˆæ¯æ—¶å¯ä»¥æ ¹æ®æ¶ˆæ¯çš„ Key è¿›è¡Œå¹‚ç­‰å¤„ç†ï¼š 123456consumer.subscribe(&quot;ons_test&quot;, &quot;*&quot;, new MessageListener() &#123; public Action consume(Message message, ConsumeContext context) &#123; String key = message.getKey() // æ ¹æ®ä¸šåŠ¡å”¯ä¸€æ ‡è¯†çš„ key åšå¹‚ç­‰å¤„ç† &#125;&#125;); æµé‡æ§åˆ¶ç”Ÿäº§è€…æµæ§ï¼Œå› ä¸º Broker å¤„ç†èƒ½åŠ›è¾¾åˆ°ç“¶é¢ˆï¼›æ¶ˆè´¹è€…æµæ§ï¼Œå› ä¸ºæ¶ˆè´¹èƒ½åŠ›è¾¾åˆ°ç“¶é¢ˆ ç”Ÿäº§è€…æµæ§ï¼š CommitLog æ–‡ä»¶è¢«é”æ—¶é—´è¶…è¿‡ osPageCacheBusyTimeOutMills æ—¶ï¼Œå‚æ•°é»˜è®¤ä¸º 1000msï¼Œè¿”å›æµæ§ å¦‚æœå¼€å¯ transientStorePoolEnable &#x3D;&#x3D; trueï¼Œä¸” Broker ä¸ºå¼‚æ­¥åˆ·ç›˜çš„ä¸»æœºï¼Œä¸” transientStorePool ä¸­èµ„æºä¸è¶³ï¼Œæ‹’ç»å½“å‰ send è¯·æ±‚ï¼Œè¿”å›æµæ§ Broker æ¯éš” 10ms æ£€æŸ¥ send è¯·æ±‚é˜Ÿåˆ—å¤´éƒ¨è¯·æ±‚çš„ç­‰å¾…æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡ waitTimeMillsInSendQueueï¼Œé»˜è®¤ 200msï¼Œæ‹’ç»å½“å‰ send è¯·æ±‚ï¼Œè¿”å›æµæ§ã€‚ Broker é€šè¿‡æ‹’ç» send è¯·æ±‚æ–¹å¼å®ç°æµé‡æ§åˆ¶ æ³¨æ„ï¼šç”Ÿäº§è€…æµæ§ï¼Œä¸ä¼šå°è¯•æ¶ˆæ¯é‡æŠ• æ¶ˆè´¹è€…æµæ§ï¼š æ¶ˆè´¹è€…æœ¬åœ°ç¼“å­˜æ¶ˆæ¯æ•°è¶…è¿‡ pullThresholdForQueue æ—¶ï¼Œé»˜è®¤ 1000 æ¶ˆè´¹è€…æœ¬åœ°ç¼“å­˜æ¶ˆæ¯å¤§å°è¶…è¿‡ pullThresholdSizeForQueue æ—¶ï¼Œé»˜è®¤ 100MB æ¶ˆè´¹è€…æœ¬åœ°ç¼“å­˜æ¶ˆæ¯è·¨åº¦è¶…è¿‡ consumeConcurrentlyMaxSpan æ—¶ï¼Œé»˜è®¤ 2000 æ¶ˆè´¹è€…æµæ§çš„ç»“æœæ˜¯é™ä½æ‹‰å–é¢‘ç‡ åŸç†è§£æNamesrvæœåŠ¡å¯åŠ¨å¯åŠ¨æ–¹æ³•NamesrvStartup ç±»ä¸­æœ‰ Namesrv æœåŠ¡çš„å¯åŠ¨æ–¹æ³•ï¼š 123456789101112131415161718public static void main(String[] args) &#123; // å¦‚æœå¯åŠ¨æ—¶ ä½¿ç”¨ -c -p è®¾ç½®å‚æ•°äº†ï¼Œè¿™äº›å‚æ•°å­˜å‚¨åœ¨ args ä¸­ main0(args);&#125;public static NamesrvController main0(String[] args) &#123; try &#123; // åˆ›å»º namesrv æ§åˆ¶å™¨ï¼Œç”¨æ¥åˆå§‹åŒ– namesrv å¯åŠ¨ namesrv å…³é—­ namesrv NamesrvController controller = createNamesrvController(args); // å¯åŠ¨ controller start(controller); return controller; &#125; catch (Throwable e) &#123; // å‡ºç°å¼‚å¸¸ï¼Œåœæ­¢ç³»ç»Ÿ System.exit(-1); &#125; return null;&#125; NamesrvStartup#createNamesrvControllerï¼šè¯»å–é…ç½®ä¿¡æ¯ï¼Œåˆå§‹åŒ– Namesrv æ§åˆ¶å™¨ ServerUtil.parseCmdLine(&quot;mqnamesrv&quot;, args, buildCommandlineOptions(options)ï¼Œ..)ï¼šè§£æå¯åŠ¨æ—¶çš„å‚æ•°ä¿¡æ¯ namesrvConfig = new NamesrvConfig()ï¼šåˆ›å»º Namesrv é…ç½®å¯¹è±¡ private String rocketmqHomeï¼šè·å– ROCKETMQ_HOME å€¼ private boolean orderMessageEnable = falseï¼šé¡ºåºæ¶ˆæ¯åŠŸèƒ½æ˜¯å¦å¼€å¯ nettyServerConfig = new NettyServerConfig()ï¼šNetty çš„æœåŠ¡å™¨é…ç½®å¯¹è±¡ nettyServerConfig.setListenPort(9876)ï¼šNamesrv æœåŠ¡å™¨çš„ç›‘å¬ç«¯å£è®¾ç½®ä¸º 9876 if (commandLine.hasOption(&#39;c&#39;))ï¼šè¯»å–å‘½ä»¤è¡Œ -c çš„å‚æ•°å€¼ in = new BufferedInputStream(new FileInputStream(file))ï¼šè¯»å–æŒ‡å®šç›®å½•çš„é…ç½®æ–‡ä»¶ properties.load(in)ï¼šå°†é…ç½®æ–‡ä»¶ä¿¡æ¯åŠ è½½åˆ° properties å¯¹è±¡ï¼Œç›¸å…³å±æ€§ä¼šå¤å†™åˆ° Namesrv é…ç½®å’Œ Netty é…ç½®å¯¹è±¡ namesrvConfig.setConfigStorePath(file)ï¼šå°†é…ç½®æ–‡ä»¶çš„è·¯å¾„ä¿å­˜åˆ°é…ç½®ä¿å­˜å­—æ®µ if (null == namesrvConfig.getRocketmqHome())ï¼šæ£€æŸ¥ ROCKETMQ_HOME é…ç½®æ˜¯å¦æ˜¯ç©ºï¼Œæ˜¯ç©ºå°±æŠ¥é”™ lc = (LoggerContext) LoggerFactory.getILoggerFactory()ï¼šåˆ›å»ºæ—¥å¿—å¯¹è±¡ controller = new NamesrvController(namesrvConfig, nettyServerConfig)ï¼šåˆ›å»º Namesrv æ§åˆ¶å™¨ NamesrvStartup#startï¼šå¯åŠ¨ Namesrv æ§åˆ¶å™¨ boolean initResult = controller.initialize()ï¼šåˆå§‹åŒ–æ–¹æ³• Runtime.getRuntime().addShutdownHook(new ShutdownHookThread())ï¼šJVM HOOK å¹³æ»‘å…³é—­çš„é€»è¾‘ï¼Œ å½“ JVM è¢«å…³é—­æ—¶ï¼Œä¸»åŠ¨è°ƒç”¨ controller.shutdown() æ–¹æ³•ï¼Œè®©æœåŠ¡å™¨å¹³æ»‘å…³æœº controller.start()ï¼šå¯åŠ¨æœåŠ¡å™¨ æºç è§£æå‚è€ƒè§†é¢‘ï¼šhttps://space.bilibili.com/457326371 æ§åˆ¶å™¨ç±»NamesrvController ç”¨æ¥åˆå§‹åŒ–å’Œå¯åŠ¨ Namesrv æœåŠ¡å™¨ æˆå‘˜å˜é‡ï¼š 1234private final ScheduledExecutorService scheduledExecutorService; // è°ƒåº¦çº¿ç¨‹æ± ï¼Œç”¨æ¥æ‰§è¡Œå®šæ—¶ä»»åŠ¡private final RouteInfoManager routeInfoManager; // ç®¡ç†ã€è·¯ç”±ä¿¡æ¯ã€‘çš„å¯¹è±¡private RemotingServer remotingServer; // ã€ç½‘ç»œå±‚ã€‘å°è£…å¯¹è±¡private BrokerHousekeepingService brokerHousekeepingService; // ç”¨äºç›‘å¬ channel çŠ¶æ€ private ExecutorService remotingExecutorï¼šä¸šåŠ¡çº¿ç¨‹æ± ï¼Œnetty çº¿ç¨‹è§£ææŠ¥æ–‡æˆ RemotingCommand å¯¹è±¡ï¼Œç„¶åå°†è¯¥å¯¹è±¡äº¤ç»™ä¸šåŠ¡çº¿ç¨‹æ± å†ç»§ç»­å¤„ç† åˆå§‹åŒ–ï¼š 1234567891011121314151617181920212223242526272829303132public boolean initialize() &#123; // åŠ è½½æœ¬åœ°kvé…ç½®ï¼ˆæˆ‘è¿˜ä¸æ˜ç™½ kv é…ç½®æ˜¯å•¥ï¼‰ this.kvConfigManager.load(); // åˆ›å»ºç½‘ç»œæœåŠ¡å™¨å¯¹è±¡ï¼Œã€å°† netty çš„é…ç½®å’Œç›‘å¬å™¨ä¼ å…¥ã€‘ // ç›‘å¬å™¨ç›‘å¬ channel çŠ¶æ€çš„æ”¹å˜ï¼Œä¼šå‘äº‹ä»¶é˜Ÿåˆ—å‘èµ·äº‹ä»¶ï¼Œæœ€åäº¤ç”± service å¤„ç† this.remotingServer = new NettyRemotingServer(this.nettyServerConfig, this.brokerHousekeepingService); // ã€åˆ›å»ºä¸šåŠ¡çº¿ç¨‹æ± ï¼Œé»˜è®¤çº¿ç¨‹æ•° 8ã€‘ this.remotingExecutor = Executors.newFixedThreadPool(nettyServerConfig.getServerWorkerThreads().); // æ³¨å†Œåè®®å¤„ç†å™¨ï¼ˆç¼ºçœåè®®å¤„ç†å™¨ï¼‰ï¼Œã€å¤„ç†å™¨æ˜¯ DefaultRequestProcessorã€‘ï¼Œçº¿ç¨‹ä½¿ç”¨çš„æ˜¯åˆšåˆ›å»ºçš„ä¸šåŠ¡çš„çº¿ç¨‹æ±  this.registerProcessor(); // å®šæ—¶ä»»åŠ¡1ï¼šæ¯ 10 ç§’é’Ÿæ£€æŸ¥ broker å­˜æ´»çŠ¶æ€ï¼Œå°† IDLE çŠ¶æ€çš„ broker ç§»é™¤ã€æ‰«ææœºåˆ¶ï¼Œå¿ƒè·³æ£€æµ‹ã€‘ this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() &#123; @Override public void run() &#123; // æ‰«æ brokerLiveTable è¡¨ï¼Œå°†ä¸¤å°æ—¶æ²¡æœ‰æ´»åŠ¨çš„ broker å…³é—­ï¼Œ // é€šè¿‡ next.getKey() è·å– broker çš„åœ°å€ï¼Œç„¶åã€å…³é—­æœåŠ¡å™¨ä¸brokerç‰©ç†èŠ‚ç‚¹çš„ channelã€‘ NamesrvController.this.routeInfoManager.scanNotActiveBroker(); &#125; &#125;, 5, 10, TimeUnit.SECONDS); // å®šæ—¶ä»»åŠ¡2ï¼šæ¯ 10 åˆ†é’Ÿæ‰“å°ä¸€é kv é…ç½®ã€‚ this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() &#123; @Override public void run() &#123; NamesrvController.this.kvConfigManager.printAllPeriodically(); &#125; &#125;, 1, 10, TimeUnit.MINUTES); return true;&#125; å¯åŠ¨æ–¹æ³•ï¼š 12345678public void start() throws Exception &#123; // æœåŠ¡å™¨ç½‘ç»œå±‚å¯åŠ¨ã€‚ this.remotingServer.start(); if (this.fileWatchService != null) &#123; this.fileWatchService.start(); &#125;&#125; ç½‘ç»œé€šä¿¡é€šä¿¡åŸç†RocketMQ çš„ RPC é€šä¿¡é‡‡ç”¨ Netty ç»„ä»¶ä½œä¸ºåº•å±‚é€šä¿¡åº“ï¼ŒåŒæ ·ä¹Ÿéµå¾ªäº† Reactor å¤šçº¿ç¨‹æ¨¡å‹ï¼ŒNettyRemotingServer ç±»è´Ÿè´£æ¡†æ¶çš„é€šä¿¡æœåŠ¡ï¼ŒåŒæ—¶åˆåœ¨è¿™ä¹‹ä¸Šåšäº†ä¸€äº›æ‰©å±•å’Œä¼˜åŒ– RocketMQ åŸºäº NettyRemotingServer çš„ Reactor å¤šçº¿ç¨‹æ¨¡å‹ï¼š ä¸€ä¸ª Reactor ä¸»çº¿ç¨‹ï¼ˆeventLoopGroupBossï¼‰è´Ÿè´£ç›‘å¬ TCP ç½‘ç»œè¿æ¥è¯·æ±‚ï¼Œå»ºç«‹å¥½è¿æ¥åˆ›å»º SocketChannelï¼ˆRocketMQ ä¼šè‡ªåŠ¨æ ¹æ® OS çš„ç±»å‹é€‰æ‹© NIO å’Œ Epollï¼Œä¹Ÿå¯ä»¥é€šè¿‡å‚æ•°é…ç½®ï¼‰ï¼Œå¹¶æ³¨å†Œåˆ° Selector ä¸Šï¼Œç„¶åç›‘å¬çœŸæ­£çš„ç½‘ç»œæ•°æ® æ‹¿åˆ°ç½‘ç»œæ•°æ®äº¤ç»™ Worker çº¿ç¨‹æ± ï¼ˆeventLoopGroupSelectorï¼Œé»˜è®¤è®¾ç½®ä¸º 3ï¼‰ï¼Œåœ¨çœŸæ­£æ‰§è¡Œä¸šåŠ¡é€»è¾‘ä¹‹å‰éœ€è¦è¿›è¡Œ SSL éªŒè¯ã€ç¼–è§£ç ã€ç©ºé—²æ£€æŸ¥ã€ç½‘ç»œè¿æ¥ç®¡ç†ï¼Œè¿™äº›å·¥ä½œäº¤ç»™ defaultEventExecutorGroupï¼ˆé»˜è®¤è®¾ç½®ä¸º 8ï¼‰å»åš å¤„ç†ä¸šåŠ¡æ“ä½œæ”¾åœ¨ä¸šåŠ¡çº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼Œæ ¹æ® RomotingCommand çš„ä¸šåŠ¡è¯·æ±‚ç  code å» processorTable è¿™ä¸ªæœ¬åœ°ç¼“å­˜å˜é‡ä¸­æ‰¾åˆ°å¯¹åº”çš„ processorï¼Œå°è£…æˆ task ä»»åŠ¡æäº¤ç»™å¯¹åº”çš„ processor å¤„ç†çº¿ç¨‹æ± æ¥æ‰§è¡Œï¼ˆsendMessageExecutorï¼Œä»¥å‘é€æ¶ˆæ¯ä¸ºä¾‹ï¼‰ ä»å…¥å£åˆ°ä¸šåŠ¡é€»è¾‘çš„å‡ ä¸ªæ­¥éª¤ä¸­çº¿ç¨‹æ± ä¸€ç›´å†å¢åŠ ï¼Œè¿™è·Ÿæ¯ä¸€æ­¥é€»è¾‘å¤æ‚æ€§ç›¸å…³ï¼Œè¶Šå¤æ‚ï¼Œéœ€è¦çš„å¹¶å‘é€šé“è¶Šå®½ çº¿ç¨‹æ•° çº¿ç¨‹å çº¿ç¨‹å…·ä½“è¯´æ˜ 1 NettyBoss_%d Reactor ä¸»çº¿ç¨‹ N NettyServerEPOLLSelector_%d_%d Reactor çº¿ç¨‹æ±  M1 NettyServerCodecThread_%d Worker çº¿ç¨‹æ±  M2 RemotingExecutorThread_%d ä¸šåŠ¡ processor å¤„ç†çº¿ç¨‹æ±  RocketMQ çš„å¼‚æ­¥é€šä¿¡æµç¨‹ï¼š &#x3D;&#x3D;todoï¼šåæœŸå¯¹ Netty æœ‰äº†æ›´æ·±çš„è®¤çŸ¥åä¼šè¿›è¡Œæ‰©å……ï¼Œç°åœ¨æš‚æ—¶ copy å®˜æ–¹æ–‡æ¡£&#x3D;&#x3D; å®˜æ–¹æ–‡æ¡£ï¼šhttps://github.com/apache/rocketmq/blob/master/docs/cn/design.md#2-%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6 æˆå‘˜å±æ€§NettyRemotingServer ç±»æˆå‘˜å˜é‡ï¼š æœåŠ¡å™¨ç›¸å…³å±æ€§ï¼š 12345private final ServerBootstrap serverBootstrap; // netty æœåŠ¡ç«¯å¯åŠ¨å¯¹è±¡private final EventLoopGroup eventLoopGroupSelector; // netty worker ç»„çº¿ç¨‹æ± ï¼Œã€é»˜è®¤ 3 ä¸ªçº¿ç¨‹ã€‘private final EventLoopGroup eventLoopGroupBoss; // netty boss ç»„çº¿ç¨‹æ± ï¼Œã€ä¸€èˆ¬æ˜¯ 1 ä¸ªçº¿ç¨‹ã€‘private final NettyServerConfig nettyServerConfig; // netty æœåŠ¡ç«¯ç½‘ç»œé…ç½®private int port = 0; // æœåŠ¡å™¨ç»‘å®šçš„ç«¯å£ å…¬å…±çº¿ç¨‹æ± ï¼šæ³¨å†Œå¤„ç†å™¨æ—¶å¦‚æœæœªæŒ‡å®šçº¿ç¨‹æ± ï¼Œåˆ™ä¸šåŠ¡å¤„ç†ä½¿ç”¨å…¬å…±çº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ•°é‡é»˜è®¤æ˜¯ 4 1private final ExecutorService publicExecutor; äº‹ä»¶ç›‘å¬å™¨ï¼šNameserver ä½¿ç”¨ BrokerHouseKeepingServiceï¼ŒBroker ä½¿ç”¨ ClientHouseKeepingService 1private final ChannelEventListener channelEventListener; äº‹ä»¶å¤„ç†çº¿ç¨‹æ± ï¼šé»˜è®¤æ˜¯ 8 1private DefaultEventExecutorGroup defaultEventExecutorGroup; å®šæ—¶å™¨ï¼šæ‰§è¡Œå¾ªç¯ä»»åŠ¡ï¼Œå¹¶ä¸”å°†å®šæ—¶å™¨çº¿ç¨‹è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹ 1private final Timer timer = new Timer(&quot;ServerHouseKeepingService&quot;, true); å¤„ç†å™¨ï¼šå¤šä¸ª Channel å…±äº«çš„å¤„ç†å™¨ Handlerï¼Œå¤šä¸ªé€šé“ä½¿ç”¨åŒä¸€ä¸ªå¯¹è±¡ Netty é…ç½®å¯¹è±¡ï¼š 12345678910111213141516171819202122232425public class NettyServerConfig implements Cloneable &#123; // æœåŠ¡ç«¯å¯åŠ¨æ—¶ç›‘å¬çš„ç«¯å£å· private int listenPort = 8888; // ã€ä¸šåŠ¡çº¿ç¨‹æ± ã€‘ çº¿ç¨‹æ•°é‡ private int serverWorkerThreads = 8; // æ ¹æ®è¯¥å€¼åˆ›å»º remotingServer å†…éƒ¨çš„ä¸€ä¸ª publicExecutor private int serverCallbackExecutorThreads = 0; // netty ã€workerã€‘çº¿ç¨‹æ•° private int serverSelectorThreads = 3; // ã€å•å‘è®¿é—®ã€‘æ—¶çš„å¹¶å‘é™åˆ¶ private int serverOnewaySemaphoreValue = 256; // ã€å¼‚æ­¥è®¿é—®ã€‘æ—¶çš„å¹¶å‘é™åˆ¶ private int serverAsyncSemaphoreValue = 64; // channel æœ€å¤§çš„ç©ºé—²å­˜æ´»æ—¶é—´ é»˜è®¤æ˜¯ 2min private int serverChannelMaxIdleTimeSeconds = 120; // å‘é€ç¼“å†²åŒºå¤§å° 65535 private int serverSocketSndBufSize = NettySystemConfig.socketSndbufSize; // æ¥æ”¶ç¼“å†²åŒºå¤§å° 65535 private int serverSocketRcvBufSize = NettySystemConfig.socketRcvbufSize; // æ˜¯å¦å¯ç”¨ netty å†…å­˜æ±  é»˜è®¤å¼€å¯ private boolean serverPooledByteBufAllocatorEnable = true; // é»˜è®¤ linux ä¼šå¯ç”¨ ã€epollã€‘ private boolean useEpollNativeSelector = false;&#125; æ„é€ æ–¹æ³•ï¼š æ— ç›‘å¬å™¨æ„é€ ï¼š 123public NettyRemotingServer(final NettyServerConfig nettyServerConfig) &#123; this(nettyServerConfig, null);&#125; æœ‰å‚æ„é€ æ–¹æ³•ï¼š 1234567891011121314151617181920212223public NettyRemotingServer(final NettyServerConfig nettyServerConfig, final ChannelEventListener channelEventListener) &#123; // æœåŠ¡å™¨å¯¹å®¢æˆ·ç«¯ä¸»åŠ¨å‘èµ·è¯·æ±‚æ—¶å¹¶å‘é™åˆ¶ã€‚ã€å•å‘è¯·æ±‚å’Œå¼‚æ­¥è¯·æ±‚ã€‘çš„å¹¶å‘é™åˆ¶ super(nettyServerConfig.getServerOnewaySemaphoreValue(), nettyServerConfig.getServerAsyncSemaphoreValue()); // Netty çš„å¯åŠ¨å™¨ï¼Œè´Ÿè´£ç»„è£… netty ç»„ä»¶ this.serverBootstrap = new ServerBootstrap(); // æˆå‘˜å˜é‡çš„èµ‹å€¼ this.nettyServerConfig = nettyServerConfig; this.channelEventListener = channelEventListener; // å…¬å…±çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡ï¼Œé»˜è®¤ç»™çš„0ï¼Œè¿™é‡Œæœ€ç»ˆä¿®æ”¹ä¸º4. int publicThreadNums = nettyServerConfig.getServerCallbackExecutorThreads(); if (publicThreadNums &lt;= 0) &#123; publicThreadNums = 4; &#125; // åˆ›å»ºå…¬å…±çº¿ç¨‹æ± ï¼ŒæŒ‡å®šçº¿ç¨‹å·¥å‚ï¼Œè®¾ç½®çº¿ç¨‹åç§°å‰ç¼€ï¼šNettyServerPublicExecutor_[æ•°å­—] this.publicExecutor = Executors.newFixedThreadPool(publicThreadNums, new ThreadFactory()&#123;.&#125;); // åˆ›å»ºä¸¤ä¸ª netty çš„çº¿ç¨‹ç»„ï¼Œä¸€ä¸ªæ˜¯bossç»„ï¼Œä¸€ä¸ªæ˜¯workerç»„ï¼Œã€linux ç³»ç»Ÿé»˜è®¤å¯ç”¨ epollã€‘ if (useEpoll()) &#123;...&#125; else &#123;...&#125; // SSL ç›¸å…³ loadSslContext();&#125; å¯åŠ¨æ–¹æ³•æ ¸å¿ƒæ–¹æ³•çš„è§£æï¼š start()ï¼šå¯åŠ¨æ–¹æ³•ï¼Œåˆ›å»º BootStrapï¼Œå¹¶æ·»åŠ  NettyServerHandler å¤„ç†å™¨ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849public void start() &#123; // Channel Pipeline å†…çš„ handler ä½¿ç”¨çš„çº¿ç¨‹èµ„æºï¼Œã€çº¿ç¨‹åˆ†é…ç»™ handler å¤„ç†äº‹ä»¶ã€‘ this.defaultEventExecutorGroup = new DefaultEventExecutorGroup(...); // åˆ›å»ºé€šç”¨å…±äº«çš„å¤„ç†å™¨ handlerï¼Œã€éå¸¸é‡è¦çš„ NettyServerHandlerã€‘ prepareSharableHandlers(); ServerBootstrap childHandler = // é…ç½®å·¥ä½œç»„ bossï¼ˆæ•°é‡1ï¼‰ å’Œ workerï¼ˆæ•°é‡3ï¼‰ ç»„ this.serverBootstrap.group(this.eventLoopGroupBoss, this.eventLoopGroupSelector) // è®¾ç½®æœåŠ¡ç«¯ ServerSocketChannel ç±»å‹ï¼Œ Linux ç”¨ epoll .channel(useEpoll() ? EpollServerSocketChannel.class : NioServerSocketChannel.class) // è®¾ç½®æœåŠ¡ç«¯ channel é€‰é¡¹ .option(ChannelOption.SO_BACKLOG, 1024) // å®¢æˆ·ç«¯ channel é€‰é¡¹ .childOption(ChannelOption.TCP_NODELAY, true) // è®¾ç½®æœåŠ¡å™¨ç«¯å£ .localAddress(new InetSocketAddress(this.nettyServerConfig.getListenPort())) // å‘ channel pipeline æ·»åŠ äº†å¾ˆå¤š handlerï¼Œã€åŒ…æ‹¬ NettyServerHandlerã€‘ .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() &#123;&#125;); // å®¢æˆ·ç«¯å¼€å¯ å†…å­˜æ± ï¼Œä½¿ç”¨çš„å†…å­˜æ± æ˜¯ PooledByteBufAllocator.DEFAULT if (nettyServerConfig.isServerPooledByteBufAllocatorEnable()) &#123; childHandler.childOption(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT); &#125; try &#123; // åŒæ­¥ç­‰å¾…å»ºç«‹è¿æ¥ï¼Œå¹¶ç»‘å®šç«¯å£ã€‚ ChannelFuture sync = this.serverBootstrap.bind().sync(); InetSocketAddress addr = (InetSocketAddress) sync.channel().localAddress(); // å°†æœåŠ¡å™¨æˆåŠŸç»‘å®šçš„ç«¯å£å·èµ‹å€¼ç»™å­—æ®µ portã€‚ this.port = addr.getPort(); &#125; catch (InterruptedException e1) &#123;&#125; // housekeepingService ä¸ä¸ºç©ºï¼Œåˆ™åˆ›å»ºã€ç½‘ç»œå¼‚å¸¸äº‹ä»¶å¤„ç†å™¨ã€‘ if (this.channelEventListener != null) &#123; // çº¿ç¨‹ä¸€ç›´è½®è¯¢ nettyEvent çŠ¶æ€ï¼Œæ ¹æ® CONNECT,CLOSE,IDLE,EXCEPTION å››ç§äº‹ä»¶ç±»å‹ // CONNECT ä¸åšæ“ä½œï¼Œå…¶ä½™éƒ½æ˜¯å›è°ƒ onChannelDestroy ã€å…³é—­æœåŠ¡å™¨ä¸ Broker ç‰©ç†èŠ‚ç‚¹çš„ Channelã€‘ this.nettyEventExecutor.start(); &#125; // æäº¤å®šæ—¶ä»»åŠ¡ï¼Œæ¯ä¸€ç§’ æ‰§è¡Œä¸€æ¬¡ã€‚æ‰«æ responseTable è¡¨ï¼Œå°†è¿‡æœŸçš„æ•°æ®ç§»é™¤ this.timer.scheduleAtFixedRate(new TimerTask() &#123; @Override public void run() &#123; NettyRemotingServer.this.scanResponseTable(); &#125; &#125;, 1000 * 3, 1000);&#125; registerProcessor()ï¼šæ³¨å†Œä¸šåŠ¡å¤„ç†å™¨ 123456789101112public void registerProcessor(int requestCode, NettyRequestProcessor processor, ExecutorService executor) &#123; ExecutorService executorThis = executor; if (null == executor) &#123; // æœªæŒ‡å®šçº¿ç¨‹æ± èµ„æºï¼Œå°†å…¬å…±çº¿ç¨‹æ± èµ‹å€¼ executorThis = this.publicExecutor; &#125; // pair å¯¹è±¡ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä»£è¡¨çš„æ˜¯å¤„ç†å™¨ï¼Œ ç¬¬äºŒä¸ªå‚æ•°æ˜¯çº¿ç¨‹æ± ï¼Œé»˜è®¤æ˜¯å…¬å…±çš„çº¿ç¨‹æ±  Pair&lt;NettyRequestProcessor, ExecutorService&gt; pair = new Pair&lt;NettyRequestProcessor, ExecutorService&gt;(processor, executorThis); // key æ˜¯è¯·æ±‚ç ï¼Œvalue æ˜¯ Pair å¯¹è±¡ this.processorTable.put(requestCode, pair);&#125; getProcessorPair()ï¼šæ ¹æ®è¯·æ±‚ç è·å–å¯¹åº”çš„å¤„ç†å™¨å’Œçº¿ç¨‹æ± èµ„æº 123public Pair&lt;NettyRequestProcessor, ExecutorService&gt; getProcessorPair(int requestCode) &#123; return processorTable.get(requestCode);&#125; è¯·æ±‚æ–¹æ³•åœ¨ RocketMQ æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ”¯æŒé€šä¿¡çš„æ–¹å¼ä¸»è¦æœ‰åŒæ­¥ï¼ˆsyncï¼‰ã€å¼‚æ­¥ï¼ˆasyncï¼‰ã€å•å‘ï¼ˆonewayï¼‰ä¸‰ç§ï¼Œå…¶ä¸­å•å‘é€šä¿¡æ¨¡å¼ç›¸å¯¹ç®€å•ï¼Œä¸€èˆ¬ç”¨åœ¨å‘é€å¿ƒè·³åŒ…åœºæ™¯ä¸‹ï¼Œæ— éœ€å…³æ³¨å…¶ Response æœåŠ¡å™¨ä¸»åŠ¨å‘å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚æ—¶ï¼Œä½¿ç”¨ä¸‰ç§æ–¹æ³• invokeSync()ï¼š åŒæ­¥è°ƒç”¨ï¼ŒæœåŠ¡å™¨éœ€è¦é˜»å¡ç­‰å¾…è°ƒç”¨çš„è¿”å›ç»“æœ int opaque = request.getOpaque()ï¼šè·å–è¯·æ±‚ IDï¼ˆä¸è¯·æ±‚ç ä¸åŒï¼‰ responseFuture = new ResponseFuture(...)ï¼šåˆ›å»ºå“åº”å¯¹è±¡ï¼Œæ²¡æœ‰å›è°ƒå‡½æ•°å’Œ Once this.responseTable.put(opaque, responseFuture)ï¼šåŠ å…¥åˆ°å“åº”æ˜ å°„è¡¨ä¸­ï¼Œkey ä¸ºè¯·æ±‚ ID SocketAddress addr = channel.remoteAddress()ï¼šè·å–å®¢æˆ·ç«¯çš„åœ°å€ä¿¡æ¯ channel.writeAndFlush(request).addListener(...)ï¼šå°†ä¸šåŠ¡ Command ä¿¡æ¯å†™å…¥é€šé“ï¼Œä¸šåŠ¡çº¿ç¨‹å°†æ•°æ®äº¤ç»™ Netty ï¼ŒNetty çš„ IO çº¿ç¨‹æ¥ç®¡å†™åˆ·æ•°æ®çš„æ“ä½œï¼Œç›‘å¬å™¨ç”± IO çº¿ç¨‹åœ¨å†™åˆ·åå›è°ƒ if (f.isSuccess())ï¼šå†™å…¥æˆåŠŸä¼šå°†å“åº”å¯¹è±¡è®¾ç½®ä¸ºæˆåŠŸçŠ¶æ€ç›´æ¥ returnï¼Œå†™å…¥å¤±è´¥è®¾ç½®ä¸ºå¤±è´¥çŠ¶æ€ responseTable.remove(opaque)ï¼šå°†å½“å‰è¯·æ±‚çš„ responseFuture ä»æ˜ å°„è¡¨ç§»é™¤ responseFuture.setCause(f.cause())ï¼šè®¾ç½®é”™è¯¯çš„ä¿¡æ¯ responseFuture.putResponse(null)ï¼šå“åº” Command è®¾ç½®ä¸º null responseCommand = responseFuture.waitResponse(timeoutMillis)ï¼šå½“å‰çº¿ç¨‹è®¾ç½®è¶…æ—¶æ—¶é—´æŒ‚èµ·ï¼ŒåŒæ­¥ç­‰å¾…å“åº” if (null == responseCommand)ï¼šè¶…æ—¶æˆ–è€…å‡ºç°å¼‚å¸¸ï¼Œç›´æ¥æŠ¥é”™ return responseCommandï¼šè¿”å›å“åº” Command ä¿¡æ¯ invokeAsync()ï¼šå¼‚æ­¥è°ƒç”¨ï¼Œæœ‰å›è°ƒå¯¹è±¡ï¼Œæ— è¿”å›å€¼ boolean acquired = this.semaphoreAsync.tryAcquire(timeoutMillis, TimeUnit.MILLISECONDS)ï¼šè·å–ä¿¡å·é‡çš„è®¸å¯è¯ï¼Œä¿¡å·é‡ç”¨æ¥é™åˆ¶å¼‚æ­¥è¯·æ±‚çš„æ•°é‡ if (acquired)ï¼šè®¸å¯è¯è·å–å¤±è´¥è¯´æ˜å¹¶å‘è¾ƒé«˜ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ once = new SemaphoreReleaseOnlyOnce(this.semaphoreAsync)ï¼šOnce å¯¹è±¡å°è£…äº†é‡Šæ”¾ä¿¡å·é‡çš„æ“ä½œ costTime = System.currentTimeMillis() - beginStartTimeï¼šè®¡ç®—ä¸€ä¸‹è€—è´¹çš„æ—¶é—´ï¼Œè¶…æ—¶ä¸å†å‘èµ·è¯·æ±‚ responseFuture = new ResponseFuture()ï¼šåˆ›å»ºå“åº”å¯¹è±¡ï¼ŒåŒ…è£…äº†å›è°ƒå‡½æ•°å’Œ Once å¯¹è±¡ this.responseTable.put(opaque, responseFuture)ï¼šåŠ å…¥åˆ°å“åº”æ˜ å°„è¡¨ä¸­ï¼Œkey ä¸ºè¯·æ±‚ ID channel.writeAndFlush(request).addListener(...)ï¼šå†™åˆ·æ•°æ® if (f.isSuccess())ï¼šå†™åˆ·æˆåŠŸï¼Œè®¾ç½® responseFuture å‘ç”ŸçŠ¶æ€ä¸º true requestFail(opaque)ï¼šå†™å…¥å¤±è´¥ï¼Œä½¿ç”¨ publicExecutor å…¬å…±çº¿ç¨‹æ± å¼‚æ­¥æ‰§è¡Œå›è°ƒå¯¹è±¡çš„å‡½æ•° responseFuture.release()ï¼šå‡ºç°å¼‚å¸¸ä¼šé‡Šæ”¾ä¿¡å·é‡ invokeOneway()ï¼šå•å‘è°ƒç”¨ï¼Œä¸å…³æ³¨å“åº”ç»“æœ request.markOnewayRPC()ï¼šè®¾ç½®å•å‘æ ‡è®°ï¼Œå¯¹ç«¯æ£€æŸ¥æ ‡è®°å¯çŸ¥è¯¥è¯·æ˜¯å•å‘è¯·æ±‚ boolean acquired = this.semaphoreOneway.tryAcquire(timeoutMillis, TimeUnit.MILLISECONDS)ï¼šè·å–ä¿¡å·é‡çš„è®¸å¯è¯ï¼Œä¿¡å·é‡ç”¨æ¥é™åˆ¶å•å‘è¯·æ±‚çš„æ•°é‡ å¤„ç†å™¨ç±»åè®®è®¾è®¡åœ¨ Client å’Œ Server ä¹‹é—´å®Œæˆä¸€æ¬¡æ¶ˆæ¯å‘é€æ—¶ï¼Œéœ€è¦å¯¹å‘é€çš„æ¶ˆæ¯è¿›è¡Œä¸€ä¸ªåè®®çº¦å®šï¼Œæ‰€ä»¥è‡ªå®šä¹‰ RocketMQ çš„æ¶ˆæ¯åè®®ã€‚åœ¨ RocketMQ ä¸­ï¼Œä¸ºäº†é«˜æ•ˆåœ°åœ¨ç½‘ç»œä¸­ä¼ è¾“æ¶ˆæ¯å’Œå¯¹æ”¶åˆ°çš„æ¶ˆæ¯è¯»å–ï¼Œå°±éœ€è¦å¯¹æ¶ˆæ¯è¿›è¡Œç¼–è§£ç ï¼ŒRemotingCommand è¿™ä¸ªç±»åœ¨æ¶ˆæ¯ä¼ è¾“è¿‡ç¨‹ä¸­å¯¹æ‰€æœ‰æ•°æ®å†…å®¹çš„å°è£…ï¼Œä¸ä½†åŒ…å«äº†æ‰€æœ‰çš„æ•°æ®ç»“æ„ï¼Œè¿˜åŒ…å«äº†ç¼–ç è§£ç æ“ä½œ Headerå­—æ®µ ç±»å‹ Request è¯´æ˜ Response è¯´æ˜ code int è¯·æ±‚æ“ä½œç ï¼Œåº”ç­”æ–¹æ ¹æ®ä¸åŒçš„è¯·æ±‚ç è¿›è¡Œä¸åŒçš„å¤„ç† åº”ç­”å“åº”ç ï¼Œ0 è¡¨ç¤ºæˆåŠŸï¼Œé 0 åˆ™è¡¨ç¤ºå„ç§é”™è¯¯ language LanguageCode è¯·æ±‚æ–¹å®ç°çš„è¯­è¨€ åº”ç­”æ–¹å®ç°çš„è¯­è¨€ version int è¯·æ±‚æ–¹ç¨‹åºçš„ç‰ˆæœ¬ åº”ç­”æ–¹ç¨‹åºçš„ç‰ˆæœ¬ opaque int ç›¸å½“äº requestIdï¼Œåœ¨åŒä¸€ä¸ªè¿æ¥ä¸Šçš„ä¸åŒè¯·æ±‚æ ‡è¯†ç ï¼Œä¸å“åº”æ¶ˆæ¯ä¸­çš„ç›¸å¯¹åº” åº”ç­”ä¸åšä¿®æ”¹ç›´æ¥è¿”å› flag int åŒºåˆ†æ˜¯æ™®é€š RPC è¿˜æ˜¯ onewayRPC çš„æ ‡å¿— åŒºåˆ†æ˜¯æ™®é€š RPC è¿˜æ˜¯ onewayRPCçš„æ ‡å¿— remark String ä¼ è¾“è‡ªå®šä¹‰æ–‡æœ¬ä¿¡æ¯ ä¼ è¾“è‡ªå®šä¹‰æ–‡æœ¬ä¿¡æ¯ extFields HashMap&lt;String, String&gt; è¯·æ±‚è‡ªå®šä¹‰æ‰©å±•ä¿¡æ¯ å“åº”è‡ªå®šä¹‰æ‰©å±•ä¿¡æ¯ ä¼ è¾“å†…å®¹ä¸»è¦å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å››éƒ¨åˆ†ï¼š æ¶ˆæ¯é•¿åº¦ï¼šæ€»é•¿åº¦ï¼Œå››ä¸ªå­—èŠ‚å­˜å‚¨ï¼Œå ç”¨ä¸€ä¸ª int ç±»å‹ åºåˆ—åŒ–ç±»å‹&amp;æ¶ˆæ¯å¤´é•¿åº¦ï¼šåŒæ ·å ç”¨ä¸€ä¸ª int ç±»å‹ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºåºåˆ—åŒ–ç±»å‹ï¼Œåé¢ä¸‰ä¸ªå­—èŠ‚è¡¨ç¤ºæ¶ˆæ¯å¤´é•¿åº¦ æ¶ˆæ¯å¤´æ•°æ®ï¼šç»è¿‡åºåˆ—åŒ–åçš„æ¶ˆæ¯å¤´æ•°æ® æ¶ˆæ¯ä¸»ä½“æ•°æ®ï¼šæ¶ˆæ¯ä¸»ä½“çš„äºŒè¿›åˆ¶å­—èŠ‚æ•°æ®å†…å®¹ å®˜æ–¹æ–‡æ¡£ï¼šhttps://github.com/apache/rocketmq/blob/master/docs/cn/design.md å¤„ç†æ–¹æ³•NettyServerHandler ç±»ç”¨æ¥å¤„ç† Channel ä¸Šçš„äº‹ä»¶ï¼Œåœ¨ NettyRemotingServer å¯åŠ¨æ—¶æ³¨å†Œåˆ° Netty ä¸­ï¼Œå¯ä»¥å¤„ç† RemotingCommand ç›¸å…³çš„æ•°æ®ï¼Œé’ˆå¯¹æŸä¸€ç§ç±»å‹çš„è¯·æ±‚å¤„ç† 1234567891011121314151617181920212223class NettyServerHandler extends SimpleChannelInboundHandler&lt;RemotingCommand&gt; &#123; @Override protected void channelRead0(ChannelHandlerContext ctx, RemotingCommand msg) throws Exception &#123; // æœåŠ¡å™¨å¤„ç†æ¥å—åˆ°çš„è¯·æ±‚ä¿¡æ¯ processMessageReceived(ctx, msg); &#125;&#125;public void processMessageReceived(ChannelHandlerContext ctx, RemotingCommand msg) throws Exception &#123; final RemotingCommand cmd = msg; if (cmd != null) &#123; // æ ¹æ®è¯·æ±‚çš„ç±»å‹è¿›è¡Œå¤„ç† switch (cmd.getType()) &#123; case REQUEST_COMMAND:// å®¢æˆ·ç«¯å‘èµ·çš„è¯·æ±‚ï¼Œèµ°è¿™é‡Œ processRequestCommand(ctx, cmd); break; case RESPONSE_COMMAND:// å®¢æˆ·ç«¯å“åº”çš„æ•°æ®ï¼Œèµ°è¿™é‡Œã€å½“å‰ç±»æœ¬èº«æ˜¯æœåŠ¡å™¨ç±»ä¹Ÿæ˜¯å®¢æˆ·ç«¯ç±»ã€‘ processResponseCommand(ctx, cmd); break; default: break; &#125; &#125;&#125; NettyRemotingAbstract#processRequestCommandï¼šå¤„ç†è¯·æ±‚çš„æ•°æ® matched = this.processorTable.get(cmd.getCode())ï¼šæ ¹æ®ä¸šåŠ¡è¯·æ±‚ç è·å– Pair å¯¹è±¡ï¼ŒåŒ…å«å¤„ç†å™¨å’Œçº¿ç¨‹æ± èµ„æº pair = null == matched ? this.defaultRequestProcessor : matchedï¼šæœªæ‰¾åˆ°å¤„ç†å™¨åˆ™ä½¿ç”¨ç¼ºçœå¤„ç†å™¨ int opaque = cmd.getOpaque()ï¼šè·å–è¯·æ±‚ ID Runnable run = new Runnable()ï¼šåˆ›å»ºä»»åŠ¡å¯¹è±¡ï¼Œä»»åŠ¡åœ¨æäº¤åˆ°çº¿ç¨‹æ± åå¼€å§‹æ‰§è¡Œ doBeforeRpcHooks()ï¼šRPC HOOK å‰ç½®å¤„ç† callback = new RemotingResponseCallback()ï¼šå°è£…å“åº”å®¢æˆ·ç«¯çš„é€»è¾‘ doAfterRpcHooks()ï¼šRPC HOOK åç½®å¤„ç† if (!cmd.isOnewayRPC())ï¼šæ¡ä»¶æˆç«‹è¯´æ˜ä¸æ˜¯å•å‘è¯·æ±‚ï¼Œéœ€è¦ç»“æœ response.setOpaque(opaque)ï¼šå°†è¯·æ±‚ ID è®¾ç½®åˆ° response response.markResponseType()ï¼šè®¾ç½®å½“å‰è¯·æ±‚æ˜¯å“åº” ctx.writeAndFlush(response)ï¼š å°†å“åº”æ•°æ®äº¤ç»™ Netty IO çº¿ç¨‹ï¼Œå®Œæˆæ•°æ®å†™å’Œåˆ· if (pair.getObject1() instanceof AsyncNettyRequestProcessor)ï¼šNameserver é»˜è®¤ä½¿ç”¨ DefaultRequestProcessor å¤„ç†å™¨ï¼Œæ˜¯ä¸€ä¸ª AsyncNettyRequestProcessor å­ç±» processor = (AsyncNettyRequestProcessor)pair.getObject1()ï¼šè·å–å¤„ç†å™¨ processor.asyncProcessRequest(ctx, cmd, callback)ï¼šå¼‚æ­¥è°ƒç”¨ï¼Œé¦–å…ˆ processRequestï¼Œç„¶å callback å“åº”å®¢æˆ·ç«¯ DefaultRequestProcessor.processRequestï¼šæ ¹æ®ä¸šåŠ¡ç å¤„ç†è¯·æ±‚ï¼Œæ‰§è¡Œå¯¹åº”çš„æ“ä½œ ClientRemotingProcessor.processRequestï¼šå¤„ç†äº‹åŠ¡å›æŸ¥æ¶ˆæ¯ï¼Œæˆ–è€…å›æ‰§æ¶ˆæ¯ï¼Œéœ€è¦æ¶ˆè´¹è€…å›æ‰§ä¸€æ¡æ¶ˆæ¯ç»™ç”Ÿäº§è€… requestTask = new RequestTask(run, ctx.channel(), cmd)ï¼šå°†ä»»åŠ¡å¯¹è±¡ã€é€šé“ã€è¯·æ±‚å°è£…æˆ RequestTask å¯¹è±¡ pair.getObject2().submit(requestTask)ï¼šè·å–å¤„ç†å™¨å¯¹åº”çš„çº¿ç¨‹æ± ï¼Œå°† task æäº¤ï¼Œä» IO çº¿ç¨‹åˆ‡æ¢åˆ°ä¸šåŠ¡çº¿ç¨‹ NettyRemotingAbstract#processResponseCommandï¼šå¤„ç†å“åº”çš„æ•°æ® int opaque = cmd.getOpaque()ï¼šè·å–è¯·æ±‚ ID responseFuture = responseTable.get(opaque)ï¼šä»å“åº”æ˜ å°„è¡¨ä¸­è·å–å¯¹åº”çš„å¯¹è±¡ responseFuture.setResponseCommand(cmd)ï¼šè®¾ç½®å“åº”çš„ Command å¯¹è±¡ responseTable.remove(opaque)ï¼šä»æ˜ å°„è¡¨ä¸­ç§»é™¤å¯¹è±¡ï¼Œä»£è¡¨å¤„ç†å®Œæˆ if (responseFuture.getInvokeCallback() != null)ï¼šåŒ…å«å›è°ƒå¯¹è±¡ï¼Œå¼‚æ­¥æ‰§è¡Œå›è°ƒå¯¹è±¡ responseFuture.putResponse(cmd)ï¼šä¸åŒ…å«å›è°ƒå¯¹è±¡ï¼ŒåŒæ­¥è°ƒç”¨æ—¶ï¼Œå”¤é†’ç­‰å¾…çš„ä¸šåŠ¡çº¿ç¨‹ æµç¨‹ï¼šå®¢æˆ·ç«¯ invokeSync â†’ æœåŠ¡å™¨çš„ processRequestCommand â†’ å®¢æˆ·ç«¯çš„ processResponseCommand â†’ ç»“æŸ è·¯ç”±ä¿¡æ¯ä¿¡æ¯ç®¡ç†RouteInfoManager ç±»è´Ÿè´£ç®¡ç†è·¯ç”±ä¿¡æ¯ï¼ŒNamesrvController çš„æ„é€ æ–¹æ³•ä¸­åˆ›å»ºè¯¥ç±»çš„å®ä¾‹å¯¹è±¡ï¼Œç®¡ç†æœåŠ¡ç«¯çš„è·¯ç”±æ•°æ® 12345678910111213141516public class RouteInfoManager &#123; // Broker ä¸¤ä¸ªå°æ—¶ä¸æ´»è·ƒï¼Œè§†ä¸ºç¦»çº¿ï¼Œè¢«å®šæ—¶ä»»åŠ¡åˆ é™¤ private final static long BROKER_CHANNEL_EXPIRED_TIME = 1000 * 60 * 2; // è¯»å†™é”ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨ private final ReadWriteLock lock = new ReentrantReadWriteLock(); // ä¸»é¢˜é˜Ÿåˆ—æ•°æ®ï¼Œä¸€ä¸ªä¸»é¢˜å¯¹åº”å¤šä¸ªé˜Ÿåˆ— private final HashMap&lt;String/* topic */, List&lt;QueueData&gt;&gt; topicQueueTable; // Broker æ•°æ®åˆ—è¡¨ private final HashMap&lt;String/* brokerName */, BrokerData&gt; brokerAddrTable; // é›†ç¾¤ private final HashMap&lt;String/* clusterName */, Set&lt;String/* brokerName */&gt;&gt; clusterAddrTable; // Broker å­˜æ´»ä¿¡æ¯ private final HashMap&lt;String/* brokerAddr */, BrokerLiveInfo&gt; brokerLiveTable; // æœåŠ¡è¿‡æ»¤ private final HashMap&lt;String/* brokerAddr */, List&lt;String&gt;/* Filter Server */&gt; filterServerTable;&#125; è·¯ç”±æ³¨å†ŒDefaultRequestProcessor REGISTER_BROKER æ–¹æ³•è§£æï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546public RemotingCommand registerBroker(ChannelHandlerContext ctx, RemotingCommand request) &#123; // åˆ›å»ºå“åº”è¯·æ±‚çš„å¯¹è±¡ï¼Œè®¾ç½®ä¸ºå“åº”ç±»å‹ï¼Œã€å…ˆè®¾ç½®å“åº”çš„çŠ¶æ€ç æ—¶ç³»ç»Ÿé”™è¯¯ç ã€‘ // åå°„åˆ›å»º RegisterBrokerResponseHeader å¯¹è±¡è®¾ç½®åˆ° response.customHeader å±æ€§ä¸­ final RemotingCommand response = RemotingCommand.createResponseCommand(RegisterBrokerResponseHeader.class); // è·å–å‡ºåå°„åˆ›å»ºçš„ RegisterBrokerResponseHeader ç”¨æˆ·è‡ªå®šä¹‰headerå¯¹è±¡ã€‚ final RegisterBrokerResponseHeader responseHeader = (RegisterBrokerResponseHeader) response.readCustomHeader(); // åå°„åˆ›å»º RegisterBrokerRequestHeader å¯¹è±¡ï¼Œå¹¶ä¸”å°† request.extFields ä¸­çš„æ•°æ®å†™å…¥åˆ°è¯¥å¯¹è±¡ä¸­ final RegisterBrokerRequestHeader requestHeader = request.decodeCommandCustomHeader(RegisterBrokerRequestHeader.class); // CRC æ ¡éªŒï¼Œè®¡ç®—è¯·æ±‚ä¸­çš„ CRC å€¼å’Œè¯·æ±‚å¤´ä¸­åŒ…å«çš„æ˜¯å¦ä¸€è‡´ if (!checksum(ctx, request, requestHeader)) &#123; response.setCode(ResponseCode.SYSTEM_ERROR); response.setRemark(&quot;crc32 not match&quot;); return response; &#125; TopicConfigSerializeWrapper topicConfigWrapper; if (request.getBody() != null) &#123; // ã€è§£æè¯·æ±‚ä½“ bodyã€‘ï¼Œè§£ç å‡ºæ¥çš„æ•°æ®å°±æ˜¯å½“å‰æœºå™¨çš„ä¸»é¢˜ä¿¡æ¯ topicConfigWrapper = TopicConfigSerializeWrapper.decode(request.getBody(), TopicConfigSerializeWrapper.class); &#125; else &#123; topicConfigWrapper = new TopicConfigSerializeWrapper(); topicConfigWrapper.getDataVersion().setCounter(new AtomicLong(0)); topicConfigWrapper.getDataVersion().setTimestamp(0); &#125; // æ³¨å†Œæ–¹æ³• // å‚æ•°1 é›†ç¾¤ã€å‚æ•°2ï¼šèŠ‚ç‚¹ipåœ°å€ã€å‚æ•°3ï¼šbrokerNameã€å‚æ•°4ï¼šbrokerId æ³¨æ„brokerId=0çš„èŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹ // å‚æ•°5ï¼šhaèŠ‚ç‚¹ipåœ°å€ã€å‚æ•°6å½“å‰èŠ‚ç‚¹ä¸»é¢˜ä¿¡æ¯ã€å‚æ•°7ï¼šè¿‡æ»¤æœåŠ¡å™¨åˆ—è¡¨ã€å‚æ•°8ï¼šå½“å‰æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯é€šä¿¡çš„channel RegisterBrokerResult result = this.namesrvController.getRouteInfoManager().registerBroker(..); // å°†ç»“æœä¿¡æ¯ å†™åˆ° responseHeader ä¸­ responseHeader.setHaServerAddr(result.getHaServerAddr()); responseHeader.setMasterAddr(result.getMasterAddr()); // è·å– kvé…ç½®ï¼Œå†™å…¥ response body ä¸­ï¼Œã€kv é…ç½®æ˜¯é¡ºåºæ¶ˆæ¯ç›¸å…³çš„ã€‘ byte[] jsonValue = this.namesrvController.getKvConfigManager().getKVListByNamespace(NamesrvUtil.NAMESPACE_ORDER_TOPIC); response.setBody(jsonValue); // code è®¾ç½®ä¸º SUCCESS response.setCode(ResponseCode.SUCCESS); response.setRemark(null); // è¿”å› response ï¼Œã€è¿”å›çš„ response ç”± callback å¯¹è±¡å¤„ç†ã€‘ return response;&#125; RouteInfoManager#registerBrokerï¼šæ³¨å†Œ Broker çš„ä¿¡æ¯ RegisterBrokerResult result = new RegisterBrokerResult()ï¼šè¿”å›ç»“æœçš„å°è£…å¯¹è±¡ this.lock.writeLock().lockInterruptibly()ï¼šåŠ å†™é”ååŒæ­¥æ‰§è¡Œ brokerNames = this.clusterAddrTable.get(clusterName)ï¼šè·å–å½“å‰é›†ç¾¤ä¸Šçš„ Broker åç§°åˆ—è¡¨ï¼Œæ˜¯ç©ºå°±æ–°å»ºåˆ—è¡¨ brokerNames.add(brokerName)ï¼šå°†å½“å‰ Broker åå­—åŠ å…¥åˆ°é›†ç¾¤åˆ—è¡¨ brokerData = this.brokerAddrTable.get(brokerName)ï¼šè·å–å½“å‰ Broker çš„ brokerDataï¼Œæ˜¯ç©ºå°±æ–°å»ºæ”¾å…¥æ˜ å°„è¡¨ brokerAddrsMap = brokerData.getBrokerAddrs()ï¼šè·å–å½“å‰ Broker çš„ç‰©ç†èŠ‚ç‚¹ map è¡¨ï¼Œè¿›è¡Œéå†ï¼Œå¦‚æœç‰©ç†èŠ‚ç‚¹è§’è‰²å‘ç”Ÿå˜åŒ–ï¼ˆslave â†’ masterï¼‰ï¼Œå…ˆå°†æ—§æ•°æ®ä»ç‰©ç†èŠ‚ç‚¹ map ä¸­ç§»é™¤ï¼Œç„¶åé‡å†™æ”¾å…¥ï¼Œä¿è¯èŠ‚ç‚¹çš„å”¯ä¸€æ€§ if (null != topicConfigWrapper &amp;&amp; MixAll.MASTER_ID == brokerId)ï¼šBroker ä¸Šçš„ Topic ä¸ä¸º nullï¼Œå¹¶ä¸”å½“å‰ç‰©ç†èŠ‚ç‚¹æ˜¯ Broker ä¸Šçš„ master èŠ‚ç‚¹ tcTable = topicConfigWrapper.getTopicConfigTable()ï¼šè·å–å½“å‰ Broker ä¿¡æ¯ä¸­çš„ä¸»é¢˜æ˜ å°„è¡¨ if (tcTable != null)ï¼šæ˜ å°„è¡¨ä¸ç©ºå°±åŠ å…¥æˆ–è€…æ›´æ–°åˆ° Namesrv å†… prevBrokerLiveInfo = this.brokerLiveTable.put(brokerAddr)ï¼šæ·»åŠ å½“å‰èŠ‚ç‚¹çš„ BrokerLiveInfo ï¼Œè¿”å›ä¸Šä¸€æ¬¡å¿ƒè·³æ—¶å½“å‰ Broker èŠ‚ç‚¹çš„å­˜æ´»å¯¹è±¡æ•°æ®ã€‚NamesrvController ä¸­çš„å®šæ—¶ä»»åŠ¡ä¼šæ‰«ææ˜ å°„è¡¨ brokerLiveTable 12BrokerLiveInfo prevBrokerLiveInfo = this.brokerLiveTable.put(brokerAddr, new BrokerLiveInfo( System.currentTimeMillis(),topicConfigWrapper.getDataVersion(), channel,haServerAddr)); if (MixAll.MASTER_ID != brokerId)ï¼šå½“å‰ Broker ä¸æ˜¯ master èŠ‚ç‚¹ï¼Œè·å–ä¸»èŠ‚ç‚¹çš„ä¿¡æ¯è®¾ç½®åˆ°ç»“æœå¯¹è±¡ this.lock.writeLock().unlock()ï¼šé‡Šæ”¾å†™é” BrokerMappedFileæˆå‘˜å±æ€§MappedFile ç±»æ˜¯æœ€åŸºç¡€çš„å­˜å‚¨ç±»ï¼Œç»§æ‰¿è‡ª ReferenceResource ç±»ï¼Œç”¨æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ MappedFile ç±»æˆå‘˜å˜é‡ï¼š å†…å­˜ç›¸å…³ï¼š 123public static final int OS_PAGE_SIZE = 1024 * 4;// å†…å­˜é¡µå¤§å°ï¼šé»˜è®¤æ˜¯ 4kprivate AtomicLong TOTAL_MAPPED_VIRTUAL_MEMORY; // å½“å‰è¿›ç¨‹ä¸‹æ‰€æœ‰çš„ mappedFile å ç”¨çš„æ€»è™šæ‹Ÿå†…å­˜å¤§å°private AtomicInteger TOTAL_MAPPED_FILES; // å½“å‰è¿›ç¨‹ä¸‹æ‰€æœ‰çš„ mappedFile ä¸ªæ•° æ•°æ®ä½ç‚¹ï¼š 1234protected final AtomicInteger wrotePosition; // å½“å‰ mappedFile çš„æ•°æ®å†™å…¥ç‚¹protected final AtomicInteger committedPosition;// å½“å‰ mappedFile çš„æ•°æ®æäº¤ç‚¹private final AtomicInteger flushedPosition; // æ•°æ®è½ç›˜ä½ç‚¹ï¼Œåœ¨è¿™ä¹‹å‰çš„æ•°æ®æ˜¯æŒä¹…åŒ–çš„å®‰å…¨æ•°æ® // flushedPosition-wrotePosition ä¹‹é—´çš„æ•°æ®å±äºè„é¡µ æ–‡ä»¶ç›¸å…³ï¼šCL æ˜¯ CommitLogï¼ŒCQ æ˜¯ ConsumeQueue 123private String fileName; // æ–‡ä»¶åç§°ï¼ŒCLå’ŒCQæ–‡ä»¶åæ˜¯ã€ç¬¬ä¸€æ¡æ¶ˆæ¯çš„ç‰©ç†åç§»é‡ã€‘ï¼Œç´¢å¼•æ–‡ä»¶æ˜¯ã€å¹´æœˆæ—¥æ—¶åˆ†ç§’ã€‘private long fileFromOffset;// æ–‡ä»¶åè½¬longï¼Œä»£è¡¨è¯¥å¯¹è±¡çš„ã€èµ·å§‹åç§»é‡ã€‘ private File file; // æ–‡ä»¶å¯¹è±¡ MF ä¸­ä»¥ç‰©ç†åç§»é‡ä½œä¸ºæ–‡ä»¶åï¼Œå¯ä»¥æ›´å¥½çš„å¯»å€å’Œè¿›è¡Œåˆ¤æ–­ å†…å­˜æ˜ å°„ï¼š 12protected FileChannel fileChannel; // æ–‡ä»¶é€šé“private MappedByteBuffer mappedByteBuffer; // å†…å­˜æ˜ å°„ç¼“å†²åŒºï¼Œè®¿é—®è™šæ‹Ÿå†…å­˜ ReferenceResource ç±»æˆå‘˜å˜é‡ï¼š å¼•ç”¨æ•°é‡ï¼šå½“ refCount &lt;= 0 æ—¶ï¼Œè¡¨ç¤ºè¯¥èµ„æºå¯ä»¥é‡Šæ”¾äº†ï¼Œæ²¡æœ‰ä»»ä½•å…¶ä»–ç¨‹åºä¾èµ–å®ƒäº†ï¼Œç”¨åŸå­ç±»ä¿è¯çº¿ç¨‹å®‰å…¨ 1protected final AtomicLong refCount = new AtomicLong(1); // åˆå§‹å€¼ä¸º 1 å­˜æ´»çŠ¶æ€ï¼šè¡¨ç¤ºèµ„æºçš„å­˜æ´»çŠ¶æ€ 1protected volatile boolean available = true; æ˜¯å¦æ¸…ç†ï¼šé»˜è®¤å€¼ falseï¼Œå½“æ‰§è¡Œå®Œå­ç±»å¯¹è±¡çš„ cleanup() æ¸…ç†æ–¹æ³•åï¼Œè¯¥å€¼ç½®ä¸º true ï¼Œè¡¨ç¤ºèµ„æºå·²ç»å…¨éƒ¨é‡Šæ”¾ 1protected volatile boolean cleanupOver = false; ç¬¬ä¸€æ¬¡å…³é—­èµ„æºçš„æ—¶é—´ï¼šç”¨æ¥è®°å½•è¶…æ—¶æ—¶é—´ 1private volatile long firstShutdownTimestamp = 0; æˆå‘˜æ–¹æ³•MappedFile ç±»æ ¸å¿ƒæ–¹æ³•ï¼š appendMessage()ï¼šæä¾›ä¸Šå±‚å‘å†…å­˜æ˜ å°„ä¸­è¿½åŠ æ¶ˆæ¯çš„æ–¹æ³•ï¼Œæ¶ˆæ¯å¦‚ä½•è¿½åŠ ç”± AppendMessageCallback æ§åˆ¶ 12// å‚æ•°ä¸€ï¼šæ¶ˆæ¯ å‚æ•°äºŒï¼šè¿½åŠ æ¶ˆæ¯å›è°ƒpublic AppendMessageResult appendMessage(MessageExtBrokerInner msg, AppendMessageCallback cb) 12// å°†å­—èŠ‚æ•°ç»„å†™å…¥åˆ°æ–‡ä»¶é€šé“public boolean appendMessage(final byte[] data) flush()ï¼šåˆ·ç›˜æ¥å£ï¼Œå‚æ•° flushLeastPages ä»£è¡¨åˆ·ç›˜çš„æœ€å°é¡µæ•° ï¼Œç­‰äº 0 æ—¶å±äºå¼ºåˆ¶åˆ·ç›˜ï¼›&gt; 0 æ—¶éœ€è¦è„é¡µï¼ˆè®¡ç®—æ–¹æ³•åœ¨æ•°æ®ä½ç‚¹ï¼‰è¾¾åˆ°è¯¥å€¼æ‰è¿›è¡Œç‰©ç†åˆ·ç›˜ï¼›æ–‡ä»¶å†™æ»¡æ—¶å¼ºåˆ¶åˆ·ç›˜ 1public int flush(final int flushLeastPages) selectMappedBuffer()ï¼šè¯¥æ–¹æ³•ä»¥ pos ä¸ºå¼€å§‹ä½ç‚¹ ï¼Œåˆ°æœ‰æ•ˆæ•°æ®ä¸ºæ­¢ï¼Œåˆ›å»ºä¸€ä¸ªåˆ‡ç‰‡ ByteBuffer ä½œä¸ºæ•°æ®å‰¯æœ¬ï¼Œä¾›ä¸šåŠ¡è®¿é—®æ•°æ® 1public SelectMappedBufferResult selectMappedBuffer(int pos) destroy()ï¼šé”€æ¯æ˜ å°„æ–‡ä»¶å¯¹è±¡ï¼Œå¹¶åˆ é™¤å…³è”çš„ç³»ç»Ÿæ–‡ä»¶ï¼Œå‚æ•°æ˜¯å¼ºåˆ¶å…³é—­èµ„æºçš„æ—¶é—´ 1public boolean destroy(final long intervalForcibly) cleanup()ï¼šé‡Šæ”¾å †å¤–å†…å­˜ï¼Œæ›´æ–°æ€»è™šæ‹Ÿå†…å­˜å’Œæ€»å†…å­˜æ˜ å°„æ–‡ä»¶æ•° 1public boolean cleanup(final long currentRef) warmMappedFile()ï¼šå†…å­˜é¢„çƒ­ï¼Œå½“è¦æ–°å»ºçš„ MappedFile å¯¹è±¡å¤§äº 1g æ—¶æ‰§è¡Œè¯¥æ–¹æ³•ã€‚mappedByteBuffer å·²ç»é€šè¿‡mmapæ˜ å°„ï¼Œæ­¤æ—¶æ“ä½œç³»ç»Ÿä¸­åªæ˜¯è®°å½•äº†è¯¥æ–‡ä»¶å’Œè¯¥ Buffer çš„æ˜ å°„å…³ç³»ï¼Œè€Œå¹¶æ²¡æœ‰æ˜ å°„åˆ°ç‰©ç†å†…å­˜ä¸­ï¼Œå¯¹è¯¥ MappedFile çš„æ¯ä¸ª Page Cache è¿›è¡Œå†™å…¥ä¸€ä¸ªå­—èŠ‚åˆ†é…å†…å­˜ï¼Œå°†æ˜ å°„æ–‡ä»¶å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ 1public void warmMappedFile(FlushDiskType type, int pages) mlock()ï¼šé”ä½æŒ‡å®šçš„å†…å­˜åŒºåŸŸé¿å…è¢«æ“ä½œç³»ç»Ÿè°ƒåˆ° swap ç©ºé—´ï¼Œå‡å°‘äº†ç¼ºé¡µå¼‚å¸¸çš„äº§ç”Ÿ 1public void mlock() swap space æ˜¯ç£ç›˜ä¸Šçš„ä¸€å—åŒºåŸŸï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªåˆ†åŒºæˆ–è€…ä¸€ä¸ªæ–‡ä»¶æˆ–è€…æ˜¯ç»„åˆã€‚å½“ç³»ç»Ÿç‰©ç†å†…å­˜ä¸è¶³æ—¶ï¼ŒLinux ä¼šå°†å†…å­˜ä¸­ä¸å¸¸è®¿é—®çš„æ•°æ®ä¿å­˜åˆ° swap åŒºåŸŸä¸Šï¼Œè¿™æ ·ç³»ç»Ÿå°±å¯ä»¥æœ‰æ›´å¤šçš„ç‰©ç†å†…å­˜ä¸ºå„ä¸ªè¿›ç¨‹æœåŠ¡ï¼Œè€Œå½“ç³»ç»Ÿéœ€è¦è®¿é—® swap ä¸Šå­˜å‚¨çš„å†…å®¹æ—¶ï¼Œéœ€è¦é€šè¿‡ç¼ºé¡µä¸­æ–­å°† swap ä¸Šçš„æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ ReferenceResource ç±»æ ¸å¿ƒæ–¹æ³•ï¼š hold()ï¼šå¢åŠ å¼•ç”¨è®°æ•° refCountï¼Œæ–¹æ³•åŠ é” 1public synchronized boolean hold() shutdown()ï¼šå…³é—­èµ„æºï¼Œå‚æ•°ä»£è¡¨å¼ºåˆ¶å…³é—­èµ„æºçš„æ—¶é—´é—´éš” 12// ç³»ç»Ÿå½“å‰æ—¶é—´ - firstShutdownTimestamp æ—¶é—´ &gt; intervalForcibly è¿›è¡Œã€å¼ºåˆ¶å…³é—­ã€‘public void shutdown(final long intervalForcibly) release()ï¼šå¼•ç”¨è®¡æ•°å‡ 1ï¼Œå½“ refCount ä¸º 0 æ—¶ï¼Œè°ƒç”¨å­ç±»çš„ cleanup æ–¹æ³• 1public void release() MapQueueæˆå‘˜å±æ€§MappedFileQueue ç”¨æ¥ç®¡ç† MappedFile æ–‡ä»¶ æˆå‘˜å˜é‡ï¼š ç®¡ç†ç›®å½•ï¼šCommitLog æ˜¯ ../store/commitlogï¼Œ ConsumeQueue æ˜¯ ../store/xxx_topic/0 1private final String storePath; æ–‡ä»¶å±æ€§ï¼š 12private final int mappedFileSize; // ç›®å½•ä¸‹æ¯ä¸ªæ–‡ä»¶å¤§å°ï¼ŒCLæ–‡ä»¶é»˜è®¤ 1gï¼ŒCQæ–‡ä»¶ é»˜è®¤ 600wå­—èŠ‚private final CopyOnWriteArrayList&lt;MappedFile&gt; mappedFiles; //ç›®å½•ä¸‹çš„æ¯ä¸ª mappedFile éƒ½åŠ å…¥è¯¥é›†åˆ æ•°æ®ä½ç‚¹ï¼š 12private long flushedWhere = 0; // ç›®å½•çš„åˆ·ç›˜ä½ç‚¹ï¼Œå€¼ä¸º mf.fileName + mf.wrotePositionprivate long committedWhere = 0; // ç›®å½•çš„æäº¤ä½ç‚¹ æ¶ˆæ¯å­˜å‚¨ï¼š 1private volatile long storeTimestamp = 0; // å½“å‰ç›®å½•ä¸‹æœ€åä¸€æ¡ msg çš„å­˜å‚¨æ—¶é—´ åˆ›å»ºæœåŠ¡ï¼šæ–°å»º MappedFile å®ä¾‹ï¼Œç»§æ‰¿è‡ª ServiceThread æ˜¯ä¸€ä¸ªä»»åŠ¡å¯¹è±¡ï¼Œrun æ–¹æ³•ç”¨æ¥åˆ›å»ºå®ä¾‹ 1private final AllocateMappedFileService allocateMappedFileService; æˆå‘˜æ–¹æ³•æ ¸å¿ƒæ–¹æ³•ï¼š load()ï¼šBroker å¯åŠ¨æ—¶ï¼ŒåŠ è½½æœ¬åœ°ç£ç›˜æ•°æ®ï¼Œè¯¥æ–¹æ³•è¯»å– storePath ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œåˆ›å»º MappedFile å¯¹è±¡æ”¾å…¥é›†åˆå†… 1public boolean load() getLastMappedFile()ï¼šè·å–å½“å‰æ­£åœ¨é¡ºåºå†™å…¥çš„ MappedFile å¯¹è±¡ï¼Œå¦‚æœæœ€åä¸€ä¸ª MappedFile å†™æ»¡äº†ï¼Œæˆ–è€…ä¸å­˜åœ¨ MappedFile å¯¹è±¡ï¼Œåˆ™åˆ›å»ºæ–°çš„ MappedFile 12// å‚æ•°ä¸€ï¼šæ–‡ä»¶èµ·å§‹åç§»é‡ï¼›å‚æ•°äºŒï¼šå½“listä¸ºç©ºæ—¶ï¼Œæ˜¯å¦æ–°å»º MappedFilepublic MappedFile getLastMappedFile(final long startOffset, boolean needCreate) flush()ï¼šæ ¹æ® flushedWhere å±æ€§æŸ¥æ‰¾åˆé€‚çš„ MappedFileï¼Œè°ƒç”¨è¯¥ MappedFile çš„è½ç›˜æ–¹æ³•ï¼Œå¹¶æ›´æ–°å…¨å±€çš„ flushedWhere 12//å‚æ•°ï¼š0 è¡¨ç¤ºå¼ºåˆ¶åˆ·æ–°ï¼Œ &gt; 0 è„é¡µæ•°æ®å¿…é¡»è¾¾åˆ° flushLeastPages æ‰åˆ·æ–°public boolean flush(final int flushLeastPages) findMappedFileByOffset()ï¼šæ ¹æ®åç§»é‡æŸ¥è¯¢å¯¹è±¡ 1public MappedFile findMappedFileByOffset(final long offset, final boolean returnFirstOnNotFound) deleteExpiredFileByTime()ï¼šCL åˆ é™¤è¿‡æœŸæ–‡ä»¶ï¼Œæ ¹æ®æ–‡ä»¶çš„ä¿ç•™æ—¶é•¿å†³å®šæ˜¯å¦åˆ é™¤ 12// å‚æ•°ä¸€ï¼šè¿‡æœŸæ—¶é—´ï¼› å‚æ•°äºŒï¼šåˆ é™¤ä¸¤ä¸ªæ–‡ä»¶ä¹‹é—´çš„æ—¶é—´é—´éš”ï¼› å‚æ•°ä¸‰ï¼šmf.destoryä¼ é€’çš„å‚æ•°ï¼› å‚æ•°å››ï¼štrue å¼ºåˆ¶åˆ é™¤public int deleteExpiredFileByTime(final long expiredTime,final int deleteFilesInterval, final long intervalForcibly, final boolean cleanImmediately) deleteExpiredFileByOffset()ï¼šCQ åˆ é™¤è¿‡æœŸæ–‡ä»¶ï¼Œéå†æ¯ä¸ª MF æ–‡ä»¶ï¼Œè·å–å½“å‰æ–‡ä»¶æœ€åä¸€ä¸ªæ•°æ®å•å…ƒçš„ç‰©ç†åç§»é‡ï¼Œå°äº offset è¯´æ˜å½“å‰ MF æ–‡ä»¶å†…éƒ½æ˜¯è¿‡æœŸæ•°æ® 123// å‚æ•°ä¸€ï¼šconsumeLog ç›®å½•ä¸‹æœ€å°ç‰©ç†åç§»é‡ï¼Œå°±æ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯çš„ offsetï¼› // å‚æ•°äºŒï¼šConsumerQueue æ–‡ä»¶å†…æ¯ä¸ªæ•°æ®å•å…ƒå›ºå®šå¤§å°public int deleteExpiredFileByOffset(long offset, int unitSize) CommitLogæˆå‘˜å±æ€§æˆå‘˜å˜é‡ï¼š é­”æ•°ï¼š 12public final static int MESSAGE_MAGIC_CODE = -626843481; // æ¶ˆæ¯çš„ç¬¬ä¸€ä¸ªå­—æ®µæ˜¯å¤§å°ï¼Œç¬¬äºŒä¸ªå­—æ®µå°±æ˜¯é­”æ•° protected final static int BLANK_MAGIC_CODE = -875286124; // æ–‡ä»¶å°¾æ¶ˆæ¯çš„é­”æ³•å€¼ MappedFileQueueï¼šç”¨äºç®¡ç† ../store/commitlog ç›®å½•ä¸‹çš„æ–‡ä»¶ 1protected final MappedFileQueue mappedFileQueue; å­˜å‚¨æœåŠ¡ï¼š 12protected final DefaultMessageStore defaultMessageStore; // å­˜å‚¨æ¨¡å—å¯¹è±¡ï¼Œä¸Šå±‚æœåŠ¡private final FlushCommitLogService flushCommitLogService; // åˆ·ç›˜æœåŠ¡ï¼Œé»˜è®¤å®ç°æ˜¯å¼‚æ­¥åˆ·ç›˜ å›è°ƒå™¨ï¼šæ§åˆ¶æ¶ˆæ¯çš„å“ªäº›å­—æ®µæ·»åŠ åˆ° MappedFile 1private final AppendMessageCallback appendMessageCallback; é˜Ÿåˆ—åç§»é‡å­—å…¸è¡¨ï¼škey æ˜¯ä¸»é¢˜é˜Ÿåˆ— idï¼Œvalue æ˜¯åç§»é‡ 1protected HashMap&lt;String, Long&gt; topicQueueTable = new HashMap&lt;String, Long&gt;(1024); é”ç›¸å…³ï¼š 12private volatile long beginTimeInLock = 0; // å†™æ•°æ®æ—¶åŠ é”çš„å¼€å§‹æ—¶é—´protected final PutMessageLock putMessageLock; // å†™é”ï¼Œä¸¤ä¸ªå®ç°ç±»ï¼šè‡ªæ—‹é”å’Œé‡å…¥é” å› ä¸ºå‘é€æ¶ˆæ¯æ˜¯éœ€è¦æŒä¹…åŒ–çš„ï¼Œåœ¨ Broker ç«¯æŒä¹…åŒ–æ—¶ä¼šè·å–è¯¥é”ï¼Œä¿è¯å‘é€çš„æ¶ˆæ¯çš„çº¿ç¨‹å®‰å…¨ æ„é€ æ–¹æ³•ï¼š æœ‰å‚æ„é€ ï¼š 1234567891011public CommitLog(final DefaultMessageStore defaultMessageStore) &#123; // åˆ›å»º MappedFileQueue å¯¹è±¡ // å‚æ•°1ï¼š../store/commitlogï¼› å‚æ•°2ï¼šã€1gã€‘ï¼› å‚æ•°3ï¼šallocateMappedFileService this.mappedFileQueue = new MappedFileQueue(...); // é»˜è®¤ å¼‚æ­¥åˆ·ç›˜ï¼Œåˆ›å»ºè¿™ä¸ªå¯¹è±¡ this.flushCommitLogService = new FlushRealTimeService(); // æ§åˆ¶æ¶ˆæ¯å“ªäº›å­—æ®µè¿½åŠ åˆ° mappedFileï¼Œã€æ¶ˆæ¯æœ€å¤§æ˜¯ 4Mã€‘ this.appendMessageCallback = new DefaultAppendMessageCallback(...); // é»˜è®¤ä½¿ç”¨è‡ªæ—‹é” this.putMessageLock = ...;&#125; æˆå‘˜æ–¹æ³•CommitLog ç±»æ ¸å¿ƒæ–¹æ³•ï¼š start()ï¼šä¼šå¯åŠ¨åˆ·ç›˜æœåŠ¡ 1public void start() shutdown()ï¼šå…³é—­åˆ·ç›˜æœåŠ¡ 1public void shutdown() load()ï¼šåŠ è½½ CommitLog ç›®å½•ä¸‹çš„æ–‡ä»¶ 1public boolean load() getMessage()ï¼šæ ¹æ® offset æŸ¥è¯¢å•æ¡ä¿¡æ¯ï¼Œè¿”å›çš„ç»“æœå¯¹è±¡å†…éƒ¨å°è£…äº†ä¸€ä¸ª ByteBufferï¼Œè¯¥ Buffer è¡¨ç¤º [offset, offset + size] åŒºé—´çš„ MappedFile çš„æ•°æ® 1public SelectMappedBufferResult getMessage(final long offset, final int size) deleteExpiredFile()ï¼šåˆ é™¤è¿‡æœŸæ–‡ä»¶ï¼Œæ–¹æ³•ç”± DefaultMessageStore çš„å®šæ—¶ä»»åŠ¡è°ƒç”¨ 1public int deleteExpiredFile() asyncPutMessage()ï¼šå­˜å‚¨æ¶ˆæ¯ 1public CompletableFuture&lt;PutMessageResult&gt; asyncPutMessage(final MessageExtBrokerInner msg) msg.setStoreTimestamp(System.currentTimeMillis())ï¼šè®¾ç½®å­˜å‚¨æ—¶é—´ï¼Œåé¢è·å–åˆ°å†™é”åè¿™ä¸ªäº‹ä»¶ä¼šé‡å†™ msg.setBodyCRC(UtilAll.crc32(msg.getBody()))ï¼šè·å–æ¶ˆæ¯çš„ CRC å€¼ topicã€queueIdï¼šè·å–ä¸»é¢˜å’Œé˜Ÿåˆ— ID if (msg.getDelayTimeLevel() &gt; 0) ï¼šè·å–æ¶ˆæ¯çš„å»¶è¿Ÿçº§åˆ«ï¼Œè¿™é‡Œæ˜¯å»¶è¿Ÿæ¶ˆæ¯å®ç°çš„å…³é”® topic = TopicValidator.RMQ_SYS_SCHEDULE_TOPICï¼šä¿®æ”¹æ¶ˆæ¯çš„ä¸»é¢˜ä¸º SCHEDULE_TOPIC_XXXX queueId = ScheduleMessageService.delayLevel2QueueId()ï¼šé˜Ÿåˆ— ID ä¸ºå»¶è¿Ÿçº§åˆ« -1 MessageAccessor.putPropertyï¼šå°†åŸæ¥çš„æ¶ˆæ¯ä¸»é¢˜å’Œ ID å­˜å…¥æ¶ˆæ¯çš„å±æ€§ REAL_TOPIC ä¸­ mappedFile = this.mappedFileQueue.getLastMappedFile()ï¼šè·å–å½“å‰é¡ºåºå†™çš„ MappedFile å¯¹è±¡ putMessageLock.lock()ï¼šè·å–å†™é” msg.setStoreTimestamp(beginLockTimestamp)ï¼šè®¾ç½®æ¶ˆæ¯çš„å­˜å‚¨æ—¶é—´ä¸ºè·å–é”çš„æ—¶é—´ if (null == mappedFile || mappedFile.isFull())ï¼šæ–‡ä»¶å†™æ»¡äº†åˆ›å»ºæ–°çš„ MF å¯¹è±¡ result = mappedFile.appendMessage(msg, this.appendMessageCallback)ï¼šæ¶ˆæ¯è¿½åŠ ï¼Œæ ¸å¿ƒé€»è¾‘åœ¨å›è°ƒå™¨ç±» putMessageLock.unlock()ï¼šé‡Šæ”¾å†™é” this.defaultMessageStore.unlockMappedFile(..)ï¼šå°† MappedByteBuffer ä» lock åˆ‡æ¢ä¸º unlock çŠ¶æ€ putMessageResult = new PutMessageResult(PutMessageStatus.PUT_OK, result)ï¼šç»“æœå°è£… flushResultFuture = submitFlushRequest(result, msg)ï¼šå”¤é†’åˆ·ç›˜çº¿ç¨‹ replicaResultFuture = submitReplicaRequest(result, msg)ï¼šHA æ¶ˆæ¯åŒæ­¥ recoverNormally()ï¼šæ­£å¸¸å…³æœºæ—¶çš„æ¢å¤æ–¹æ³•ï¼Œå­˜å‚¨æ¨¡å—å¯åŠ¨æ—¶å…ˆæ¢å¤æ‰€æœ‰çš„ ConsumeQueue æ•°æ®ï¼Œå†æ¢å¤ CommitLog æ•°æ® 12// å‚æ•°è¡¨ç¤ºæ¢å¤é˜¶æ®µ ConsumeQueue ä¸­å·²çŸ¥çš„æœ€å¤§çš„æ¶ˆæ¯ offsetpublic void recoverNormally(long maxPhyOffsetOfConsumeQueue) int index = mappedFiles.size() - 3ï¼šä»å€’æ•°ç¬¬ä¸‰ä¸ª file å¼€å§‹å‘åæ¢å¤ dispatchRequest = this.checkMessageAndReturnSize()ï¼šæ¯æ¬¡ä»åˆ‡ç‰‡å†…è§£æå‡ºä¸€æ¡ msg å°è£…æˆ DispatchRequest å¯¹è±¡ size = dispatchRequest.getMsgSize()ï¼šè·å–æ¶ˆæ¯çš„å¤§å°ï¼Œæ£€æŸ¥ DispatchRequest å¯¹è±¡çš„çŠ¶æ€ æƒ…å†µ 1ï¼šæ­£å¸¸æ•°æ®ï¼Œåˆ™ mappedFileOffset += size æƒ…å†µ 2ï¼šæ–‡ä»¶å°¾æ•°æ®ï¼Œå¤„ç†ä¸‹ä¸€ä¸ªæ–‡ä»¶ï¼ŒmappedFileOffset ç½®ä¸º 0ï¼Œmagic_code è¡¨ç¤ºæ–‡ä»¶å°¾ processOffset += mappedFileOffsetï¼šè®¡ç®—å‡ºæ­£ç¡®çš„æ•°æ®å­˜å‚¨ä½ç‚¹ï¼Œå¹¶è®¾ç½® MappedFileQueue çš„ç›®å½•åˆ·ç›˜ä½ç‚¹ this.mappedFileQueue.truncateDirtyFiles(processOffset)ï¼šè°ƒæ•´ MFQ ä¸­æ–‡ä»¶çš„åˆ·ç›˜ä½ç‚¹ if (maxPhyOffsetOfConsumeQueue &gt;= processOffset)ï¼šåˆ é™¤å†—ä½™æ•°æ®ï¼Œå°†è¶…è¿‡å…¨å±€ä½ç‚¹çš„ CQ ä¸‹çš„æ–‡ä»¶åˆ é™¤ï¼Œå°†åŒ…å«å…¨å±€ä½ç‚¹çš„ CQ ä¸‹çš„æ–‡ä»¶é‡æ–°å®šä½ recoverAbnormally()ï¼šå¼‚å¸¸å…³æœºæ—¶çš„æ¢å¤æ–¹æ³• 1public void recoverAbnormally(long maxPhyOffsetOfConsumeQueue) int index = mappedFiles.size() - 1ï¼šä»å°¾éƒ¨å¼€å§‹éå† MFQï¼ŒéªŒè¯ MF çš„ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªéªŒè¯é€šè¿‡çš„æ–‡ä»¶å¯¹è±¡ dispatchRequest = this.checkMessageAndReturnSize()ï¼šæ¯æ¬¡è§£æå‡ºä¸€æ¡ msg å°è£…æˆ DispatchRequest å¯¹è±¡ this.defaultMessageStore.doDispatch(dispatchRequest)ï¼šé‡å»º ConsumerQueue å’Œ Indexï¼Œé¿å…ä¸Šæ¬¡å¼‚å¸¸åœæœºå¯¼è‡´ CQ å’Œ Index ä¸ CommitLog ä¸å¯¹é½ å‰©ä½™é€»è¾‘ä¸æ­£å¸¸å…³æœºçš„æ¢å¤æ–¹æ³•ç›¸ä¼¼ æœåŠ¡çº¿ç¨‹AppendMessageCallback æ¶ˆæ¯è¿½åŠ æœåŠ¡å®ç°ç±»ä¸º DefaultAppendMessageCallback doAppend()ï¼š 1public AppendMessageResult doAppend() long wroteOffset = fileFromOffset + byteBuffer.position()ï¼šæ¶ˆæ¯å†™å…¥çš„ä½ç½®ï¼Œç‰©ç†åç§»é‡ phyOffset String msgIdï¼šæ¶ˆæ¯ IDï¼Œè§„åˆ™æ˜¯å®¢æˆ·ç«¯ IP + æ¶ˆæ¯åç§»é‡ phyOffset byte[] topicDataï¼šåºåˆ—åŒ–æ¶ˆæ¯ï¼Œå°†æ¶ˆæ¯çš„å­—æ®µå‹å…¥åˆ° msgStoreItemMemory è¿™ä¸ª Buffer ä¸­ byteBuffer.put(this.msgStoreItemMemory.array(), 0, msgLen)ï¼šå°† msgStoreItemMemory ä¸­çš„æ•°æ®å†™å…¥ MF å¯¹è±¡çš„å†…å­˜æ˜ å°„çš„ Buffer ä¸­ï¼Œæ•°æ®è¿˜æ²¡è½ç›˜ AppendMessageResult resultï¼šæ„é€ ç»“æœå¯¹è±¡ï¼ŒåŒ…æ‹¬å­˜å‚¨ä½ç‚¹ã€æ˜¯å¦æˆåŠŸã€é˜Ÿåˆ—åç§»é‡ç­‰ä¿¡æ¯ CommitLog.this.topicQueueTable.put(key, ++queueOffset)ï¼šæ›´æ–°é˜Ÿåˆ—åç§»é‡ FlushRealTimeService åˆ·ç›˜ CL æ•°æ®ï¼Œé»˜è®¤æ˜¯å¼‚æ­¥åˆ·ç›˜ç±» FlushRealTimeService run()ï¼šè¿è¡Œæ–¹æ³• 1public void run() while (!this.isStopped())ï¼šstoppedä¸º true æ‰è·³å‡ºå¾ªç¯ boolean flushCommitLogTimedï¼šæ§åˆ¶çº¿ç¨‹çš„ä¼‘çœ æ–¹å¼ï¼Œé»˜è®¤æ˜¯ falseï¼Œä½¿ç”¨ CountDownLatch.await() ä¼‘çœ ï¼Œè®¾ç½®ä¸º true æ—¶ä½¿ç”¨ Thread.sleep() ä¼‘çœ  int intervalï¼šè·å–é…ç½®ä¸­çš„åˆ·ç›˜æ—¶é—´é—´éš” int flushPhysicQueueLeastPagesï¼šè·å–æœ€å°åˆ·ç›˜é¡µæ•°ï¼Œé»˜è®¤æ˜¯ 4 é¡µï¼Œè„é¡µè¾¾åˆ°æŒ‡å®šé¡µæ•°æ‰åˆ·ç›˜ int flushPhysicQueueThoroughIntervalï¼šè·å–å¼ºåˆ¶åˆ·ç›˜å‘¨æœŸï¼Œé»˜è®¤æ˜¯ 10 ç§’ï¼Œè¾¾åˆ°å‘¨æœŸåå¼ºåˆ¶åˆ·ç›˜ï¼Œä¸è€ƒè™‘è„é¡µ if (flushCommitLogTimed)ï¼šä¼‘çœ é€»è¾‘ï¼Œé¿å… CPU å ç”¨å¤ªé•¿æ—¶é—´ï¼Œå¯¼è‡´æ— æ³•æ‰§è¡Œå…¶ä»–æ›´ç´§æ€¥çš„ä»»åŠ¡ CommitLog.this.mappedFileQueue.flush(flushPhysicQueueLeastPages)ï¼šåˆ·ç›˜ for (int i = 0; i &lt; RETRY_TIMES_OVER &amp;&amp; !result; i++)ï¼šstopped åœæ­¢æ ‡è®°ä¸º true æ—¶ï¼Œéœ€è¦ç¡®ä¿æ‰€æœ‰çš„æ•°æ®éƒ½å·²ç»åˆ·ç›˜ï¼Œæ‰€ä»¥æ­¤å¤„å°è¯• 10 æ¬¡å¼ºåˆ¶åˆ·ç›˜ï¼Œ result = CommitLog.this.mappedFileQueue.flush(0)ï¼šå¼ºåˆ¶åˆ·ç›˜ åŒæ­¥åˆ·ç›˜ç±» GroupCommitService run()ï¼šè¿è¡Œæ–¹æ³• 1public void run() while (!this.isStopped())ï¼šstoppedä¸º true æ‰è·³å‡ºå¾ªç¯ this.waitForRunning(10)ï¼šçº¿ç¨‹ä¼‘çœ  10 æ¯«ç§’ï¼Œæœ€åè°ƒç”¨ onWaitEnd() è¿›è¡Œè¯·æ±‚çš„äº¤æ¢ swapRequests() this.doCommit()ï¼šåšæäº¤é€»è¾‘ if (!this.requestsRead.isEmpty()) ï¼šè¯»è¯·æ±‚é›†åˆä¸ä¸ºç©º for (GroupCommitRequest req : this.requestsRead)ï¼šéå†æ‰€æœ‰çš„è¯»è¯·æ±‚ï¼Œè¯·æ±‚ä¸­çš„å±æ€§ï¼š private final long nextOffsetï¼šæœ¬æ¡æ¶ˆæ¯å­˜å‚¨ä¹‹åï¼Œä¸‹ä¸€æ¡æ¶ˆæ¯å¼€å§‹çš„ offset private CompletableFuture&lt;PutMessageStatus&gt; flushOKFutureï¼šFuture å¯¹è±¡ boolean flushOK = ...ï¼šå½“å‰è¯·æ±‚å…³æ³¨çš„æ•°æ®æ˜¯å¦å…¨éƒ¨è½ç›˜ï¼Œè½ç›˜æˆåŠŸå”¤é†’æ¶ˆè´¹è€…çº¿ç¨‹ for (int i = 0; i &lt; 2 &amp;&amp; !flushOK; i++)ï¼šå°è¯•è¿›è¡Œä¸¤æ¬¡å¼ºåˆ¶åˆ·ç›˜ï¼Œä¿è¯åˆ·ç›˜æˆåŠŸ CommitLog.this.mappedFileQueue.flush(0)ï¼šå¼ºåˆ¶åˆ·ç›˜ req.wakeupCustomer(flushOK ? ...)ï¼šè®¾ç½® Future ç»“æœï¼Œåœ¨ Future é˜»å¡çš„çº¿ç¨‹åœ¨è¿™é‡Œä¼šè¢«å”¤é†’ this.requestsRead.clear()ï¼šæ¸…ç† reqeustsRead åˆ—è¡¨ï¼Œæ–¹ä¾¿äº¤æ¢æ—¶æˆä¸º requestsWrite ä½¿ç”¨ elseï¼šè¯»è¯·æ±‚é›†åˆä¸ºç©º CommitLog.this.mappedFileQueue.flush(0)ï¼šå¼ºåˆ¶åˆ·ç›˜ this.swapRequests()ï¼šäº¤æ¢è¯»å†™è¯·æ±‚ this.doCommit()ï¼šäº¤æ¢ååšä¸€æ¬¡æäº¤ ConsQueueæˆå‘˜å±æ€§ConsumerQueue æ˜¯æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ï¼Œå­˜å‚¨æ¶ˆæ¯åœ¨ CommitLog çš„ç´¢å¼•ï¼Œä¾¿äºå¿«é€Ÿå®šä½æ¶ˆæ¯ æˆå‘˜å˜é‡ï¼š æ•°æ®å•å…ƒï¼šConsumerQueueData æ•°æ®å•å…ƒçš„å›ºå®šå¤§å°æ˜¯ 20 å­—èŠ‚ï¼Œé»˜è®¤ç”³è¯· 20 å­—èŠ‚çš„ç¼“å†²åŒº 1public static final int CQ_STORE_UNIT_SIZE = 20; æ–‡ä»¶ç®¡ç†ï¼š 123private final MappedFileQueue mappedFileQueue; // æ–‡ä»¶ç®¡ç†å™¨ï¼Œç®¡ç† CQ ç›®å½•ä¸‹çš„æ–‡ä»¶private final String storePath; // ç›®å½•ï¼Œæ¯”å¦‚../store/consumequeue/xxx_topic/0private final int mappedFileSize; // æ¯ä¸€ä¸ª CQ å­˜å‚¨æ–‡ä»¶å¤§å°ï¼Œé»˜è®¤ 20 * 30w = 600w byte å­˜å‚¨ä¸»æ¨¡å—ï¼šä¸Šå±‚çš„å¯¹è±¡ 1private final DefaultMessageStore defaultMessageStore; æ¶ˆæ¯å±æ€§ï¼š 12345private final String topic; // CQ ä¸»é¢˜private final int queueId; // CQ é˜Ÿåˆ—ï¼Œæ¯ä¸€ä¸ªé˜Ÿåˆ—éƒ½æœ‰ä¸€ä¸ª ConsumeQueue å¯¹è±¡è¿›è¡Œç®¡ç†private final ByteBuffer byteBufferIndex; // ä¸´æ—¶ç¼“å†²åŒºï¼Œæ’æ–°çš„ CQData æ—¶ä½¿ç”¨private long maxPhysicOffset = -1; // å½“å‰ConsumeQueueå†…å­˜å‚¨çš„æœ€å¤§æ¶ˆæ¯ç‰©ç†åç§»é‡private volatile long minLogicOffset = 0; // å½“å‰ConsumeQueueå†…å­˜å‚¨çš„æœ€å°æ¶ˆæ¯ç‰©ç†åç§»é‡ æ„é€ æ–¹æ³•ï¼š æœ‰å‚æ„é€ ï¼š 1234public ConsumeQueue() &#123; // ç”³è¯·äº†ä¸€ä¸ª 20 å­—èŠ‚å¤§å°çš„ ä¸´æ—¶ç¼“å†²åŒº this.byteBufferIndex = ByteBuffer.allocate(CQ_STORE_UNIT_SIZE);&#125; æˆå‘˜æ–¹æ³•ConsumeQueue å¯åŠ¨é˜¶æ®µæ–¹æ³•ï¼š load()ï¼šç¬¬ä¸€æ­¥ï¼ŒåŠ è½½ storePath ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œåˆå§‹åŒ– MappedFileQueue recover()ï¼šç¬¬äºŒæ­¥ï¼Œæ¢å¤ ConsumeQueue æ•°æ® ä»å€’æ•°ç¬¬ä¸‰ä¸ª MF æ–‡ä»¶å¼€å§‹å‘åéå†ï¼Œä¾æ¬¡è¯»å– MF ä¸­ 20 ä¸ªå­—èŠ‚çš„ CQData æ•°æ®ï¼Œæ£€æŸ¥ offset å’Œ size æ˜¯å¦æ˜¯æœ‰æ•ˆæ•°æ® æ‰¾åˆ°æ— æ•ˆçš„ CQData çš„ä½ç‚¹ï¼Œè¯¥ä½ç‚¹å°±æ˜¯ CQ çš„åˆ·ç›˜ç‚¹å’Œæ•°æ®é¡ºåºå†™å…¥ç‚¹ åˆ é™¤æ— æ•ˆçš„ MF æ–‡ä»¶ï¼Œè°ƒæ•´å½“å‰é¡ºåºå†™çš„ MF æ–‡ä»¶çš„æ•°æ®ä½ç‚¹ å…¶ä»–æ–¹æ³•ï¼š truncateDirtyLogicFiles()ï¼šCommitLog æ¢å¤é˜¶æ®µè°ƒç”¨ï¼Œå°† ConsumeQueue æœ‰æ•ˆæ•°æ®æ–‡ä»¶ä¸ CommitLog å¯¹é½ï¼Œå°†è¶…å‡ºéƒ¨åˆ†çš„æ•°æ®æ–‡åˆ é™¤æ‰ï¼Œå¹¶è°ƒæ•´å½“å‰æ–‡ä»¶çš„æ•°æ®ä½ç‚¹ã€‚Broker å¯åŠ¨é˜¶æ®µå…ˆæ¢å¤ CQ çš„æ•°æ®ï¼Œå†æ¢å¤ CL æ•°æ®ï¼Œä½†æ˜¯æ•°æ®è¦ä»¥ CL ä¸ºåŸºå‡† 12// å‚æ•°æ˜¯æœ€å¤§æ¶ˆæ¯ç‰©ç†åç§»é‡public void truncateDirtyLogicFiles(long phyOffet) flush()ï¼šåˆ·ç›˜ï¼Œè°ƒç”¨ MFQ çš„åˆ·ç›˜æ–¹æ³• 1public boolean flush(final int flushLeastPages) deleteExpiredFile()ï¼šåˆ é™¤è¿‡æœŸæ–‡ä»¶ï¼Œå°†å°äº offset çš„æ‰€æœ‰ MF æ–‡ä»¶åˆ é™¤ï¼Œoffset æ˜¯ CommitLog ç›®å½•ä¸‹æœ€å°çš„ç‰©ç†åç§»é‡ï¼Œå°äºè¯¥å€¼çš„ CL æ–‡ä»¶å·²ç»æ²¡æœ‰äº†ï¼Œæ‰€ä»¥ CQ ä¹Ÿæ²¡æœ‰å­˜åœ¨çš„å¿…è¦ 1public int deleteExpiredFile(long offset) putMessagePositionInfoWrapper()ï¼šå‘ CQ ä¸­è¿½åŠ  CQData æ•°æ®ï¼Œç”±å­˜å‚¨ä¸»æ¨¡å— DefaultMessageStore å†…éƒ¨çš„å¼‚æ­¥çº¿ç¨‹è°ƒç”¨ï¼Œè´Ÿè´£æ„å»º ConsumeQueue æ–‡ä»¶å’Œ Index æ–‡ä»¶çš„ï¼Œè¯¥çº¿ç¨‹ä¼šæŒç»­å…³æ³¨ CommitLog æ–‡ä»¶ï¼Œå½“ CommitLog æ–‡ä»¶å†…æœ‰æ–°æ•°æ®å†™å…¥ï¼Œå°±è¯»å‡ºæ¥å°è£…æˆ DispatchRequest å¯¹è±¡ï¼Œè½¬å‘ç»™ ConsumeQueue æˆ–è€… IndexService 1public void putMessagePositionInfoWrapper(DispatchRequest request) getIndexBuffer()ï¼šè½¬æ¢ startIndex ä¸º offsetï¼Œè·å–åŒ…å«è¯¥ offset çš„ MappedFile æ–‡ä»¶ï¼Œè¯»å– [offset%maxSize, mfPos] èŒƒå›´çš„æ•°æ®ï¼ŒåŒ…è£…æˆç»“æœå¯¹è±¡è¿”å› 1public SelectMappedBufferResult getIndexBuffer(final long startIndex) IndexFileæˆå‘˜å±æ€§IndexFile ç±»æˆå‘˜å±æ€§ å“ˆå¸Œï¼š 12private static int hashSlotSize = 4; // æ¯ä¸ª hash æ¡¶çš„å¤§å°æ˜¯ 4 å­—èŠ‚ï¼Œã€ç”¨æ¥å­˜æ”¾ç´¢å¼•çš„ç¼–å·ã€‘private final int hashSlotNum; // hash æ¡¶çš„ä¸ªæ•°ï¼Œé»˜è®¤ 500 ä¸‡ ç´¢å¼•ï¼š 1234private static int indexSize = 20; // æ¯ä¸ª index æ¡ç›®çš„å¤§å°æ˜¯ 20 å­—èŠ‚private static int invalidIndex = 0; // æ— æ•ˆç´¢å¼•ç¼–å·ï¼š0 ç‰¹æ®Šå€¼private final int indexNum; // é»˜è®¤å€¼ï¼š2000wprivate final IndexHeader indexHeader; // ç´¢å¼•å¤´ æ˜ å°„ï¼š 123private final MappedFile mappedFile; // ã€ç´¢å¼•æ–‡ä»¶ä½¿ç”¨çš„ MF æ–‡ä»¶ã€‘private final FileChannel fileChannel; // æ–‡ä»¶é€šé“private final MappedByteBuffer mappedByteBuffer;// ä» MF ä¸­è·å–çš„å†…å­˜æ˜ å°„ç¼“å†²åŒº æ„é€ æ–¹æ³•ï¼š æœ‰å‚æ„é€  12345678910111213// endPhyOffset ä¸Šä¸ªç´¢å¼•æ–‡ä»¶ æœ€åä¸€æ¡æ¶ˆæ¯çš„ ç‰©ç†åç§»é‡// endTimestamp ä¸Šä¸ªç´¢å¼•æ–‡ä»¶ æœ€åä¸€æ¡æ¶ˆæ¯çš„ å­˜å‚¨æ—¶é—´public IndexFile(final String fileName, final int hashSlotNum, final int indexNum, final long endPhyOffset, final long endTimestamp) throws IOException &#123; // æ–‡ä»¶å¤§å° 40 + 500w * 4 + 2000w * 20 int fileTotalSize = IndexHeader.INDEX_HEADER_SIZE + (hashSlotNum * hashSlotSize) + (indexNum * indexSize); // åˆ›å»º mf å¯¹è±¡ï¼Œä¼šåœ¨diskä¸Šåˆ›å»ºæ–‡ä»¶ this.mappedFile = new MappedFile(fileName, fileTotalSize); // åˆ›å»º ç´¢å¼•å¤´å¯¹è±¡ï¼Œä¼ é€’ ç´¢å¼•æ–‡ä»¶mf çš„åˆ‡ç‰‡æ•°æ® this.indexHeader = new IndexHeader(byteBuffer); //...&#125; æˆå‘˜æ–¹æ³•IndexFile ç±»æ–¹æ³• load()ï¼šåŠ è½½ IndexHeader 1public void load() flush()ï¼šMappedByteBuffer å†…çš„æ•°æ®å¼ºåˆ¶è½ç›˜ 1public void flush() isWriteFull()ï¼šæ£€æŸ¥å½“å‰çš„ IndexFile å·²å†™ç´¢å¼•æ•°æ˜¯å¦ &gt;&#x3D; indexNumï¼Œè¾¾åˆ°è¯¥å€¼åˆ™å½“å‰ IndexFile ä¸èƒ½ç»§ç»­è¿½åŠ  IndexData äº† 1public boolean isWriteFull() destroy()ï¼šåˆ é™¤æ–‡ä»¶æ—¶ä½¿ç”¨çš„æ–¹æ³• 1public boolean destroy(final long intervalForcibly) putKey()ï¼šæ·»åŠ ç´¢å¼•æ•°æ®ï¼Œè§£å†³å“ˆå¸Œå†²çªä½¿ç”¨å¤´æ’æ³• 123// å‚æ•°ä¸€ï¼šæ¶ˆæ¯çš„ keyï¼Œuniq_key æˆ–è€… keys=&quot;aaa bbb ccc&quot; ä¼šåˆ†åˆ«ä¸º aaa bbb ccc åˆ›å»ºç´¢å¼•// å‚æ•°äºŒï¼šæ¶ˆæ¯çš„ç‰©ç†åç§»é‡ï¼› å‚æ•°ä¸‰ï¼šæ¶ˆæ¯å­˜å‚¨æ—¶é—´public boolean putKey(final String key, final long phyOffset, final long storeTimestamp) int slotPos = keyHash % this.hashSlotNumï¼šå¯¹ key è®¡ç®—å“ˆå¸Œåï¼Œå–æ¨¡å¾—åˆ°å¯¹åº”çš„å“ˆå¸Œæ§½ slot ä¸‹æ ‡ï¼Œç„¶åè®¡ç®—å‡ºå“ˆå¸Œæ§½çš„å­˜å‚¨ä½ç½® absSlotPos int slotValue = this.mappedByteBuffer.getInt(absSlotPos)ï¼šè·å–æ§½ä¸­çš„å€¼ï¼Œå¦‚æœæ˜¯æ— æ•ˆå€¼è¯´æ˜æ²¡æœ‰å“ˆå¸Œå†²çª timeDiff = timeDiff / 1000ï¼šè®¡ç®—å½“å‰ msg å­˜å‚¨æ—¶é—´å‡å»ç´¢å¼•æ–‡ä»¶å†…ç¬¬ä¸€æ¡æ¶ˆæ¯å­˜å‚¨æ—¶é—´çš„å·®å€¼ï¼Œè½¬åŒ–ä¸ºç§’è¿›è¡Œå­˜å‚¨ int absIndexPosï¼šè®¡ç®—å½“å‰ç´¢å¼•æ•°æ®å­˜å‚¨çš„ä½ç½®ï¼Œå¼€å§‹å¡«å……ç´¢å¼•æ•°æ®åˆ°å¯¹åº”çš„ä½ç½® this.mappedByteBuffer.putInt(absIndexPos + 4 + 8 + 4, slotValue)ï¼šhash æ¡¶çš„åŸå€¼ï¼Œå¤´æ’æ³• this.mappedByteBuffer.putInt(absSlotPos, this.indexHeader...)ï¼šåœ¨ slot æ”¾å…¥å½“å‰ç´¢å¼•çš„ç´¢å¼•ç¼–å· if (this.indexHeader.getIndexCount() &lt;= 1)ï¼šç´¢å¼•æ–‡ä»¶æ’å…¥çš„ç¬¬ä¸€æ¡æ•°æ®ï¼Œéœ€è¦è®¾ç½®èµ·å§‹åç§»é‡å’Œå­˜å‚¨æ—¶é—´ if (invalidIndex == slotValue)ï¼šæ²¡æœ‰å“ˆå¸Œå†²çªï¼Œè¯´æ˜å ç”¨äº†ä¸€ä¸ªæ–°çš„ hash slot this.indexHeaderï¼šè®¾ç½®ç´¢å¼•å¤´çš„ç›¸å…³å±æ€§ selectPhyOffset()ï¼šä»ç´¢å¼•æ–‡ä»¶æŸ¥è¯¢æ¶ˆæ¯çš„ç‰©ç†åç§»é‡ 12// å‚æ•°ä¸€ï¼šæŸ¥è¯¢ç»“æœå…¨éƒ¨æ”¾åˆ°è¯¥listå†…ï¼› å‚æ•°äºŒï¼šæŸ¥è¯¢keyï¼› å‚æ•°ä¸‰ï¼šç»“æœæœ€å¤§æ•°é™åˆ¶ï¼› å‚æ•°å››äº”ï¼šæ—¶é—´èŒƒå›´public void selectPhyOffset(final List&lt;Long&gt; phyOffsets, final String key, final int maxNum,final long begin, final long end, boolean lock) if (this.mappedFile.hold())ï¼š MF çš„å¼•ç”¨è®°æ•° +1ï¼ŒæŸ¥è¯¢æœŸé—´ MF èµ„æºä¸èƒ½è¢«é‡Šæ”¾ int slotValue = this.mappedByteBuffer.getInt(absSlotPos)ï¼šè·å–æ§½ä¸­çš„å€¼ï¼Œå¯èƒ½æ˜¯æ— æ•ˆå€¼æˆ–è€…ç´¢å¼•ç¼–å·ï¼Œå¦‚æœæ˜¯æ— æ•ˆå€¼è¯´æ˜æŸ¥è¯¢æœªå‘½ä¸­ int absIndexPosï¼šè®¡ç®—å‡ºç´¢å¼•ç¼–å·å¯¹åº”ç´¢å¼•æ•°æ®çš„å¼€å§‹ä½ç‚¹ this.mappedByteBufferï¼šè¯»å–ç´¢å¼•æ•°æ® long timeRead = this.indexHeader.getBeginTimestamp() + timeDiffï¼šè®¡ç®—å‡ºå‡†ç¡®çš„å­˜å‚¨æ—¶é—´ boolean timeMatched = (timeRead &gt;= begin) &amp;&amp; (timeRead &lt;= end)ï¼šæ—¶é—´èŒƒå›´çš„åŒ¹é… phyOffsets.add(phyOffsetRead)ï¼šå°†å‘½ä¸­çš„æ¶ˆæ¯ç´¢å¼•çš„æ¶ˆæ¯åç§»é‡åŠ å…¥åˆ° list é›†åˆä¸­ nextIndexToRead = prevIndexReadï¼šéå†å‰é©±èŠ‚ç‚¹ IndexServæˆå‘˜å±æ€§IndexService ç±»ç”¨æ¥ç®¡ç† IndexFile æ–‡ä»¶ æˆå‘˜å˜é‡ï¼š å­˜å‚¨ä¸»æ¨¡å—ï¼š 1private final DefaultMessageStore defaultMessageStore; ç´¢å¼•æ–‡ä»¶å­˜å‚¨ç›®å½•ï¼š../store/index 1private final String storePath; ç´¢å¼•å¯¹è±¡é›†åˆï¼šç›®å½•ä¸‹çš„æ¯ä¸ªæ–‡ä»¶éƒ½æœ‰ä¸€ä¸ª IndexFile å¯¹è±¡ 1private final ArrayList&lt;IndexFile&gt; indexFileList = new ArrayList&lt;IndexFile&gt;(); ç´¢å¼•æ–‡ä»¶ï¼š 12private final int hashSlotNum; // æ¯ä¸ªç´¢å¼•æ–‡ä»¶åŒ…å«çš„ å“ˆå¸Œæ¡¶æ•°é‡ ï¼š500wprivate final int indexNum; // æ¯ä¸ªç´¢å¼•æ–‡ä»¶åŒ…å«çš„ ç´¢å¼•æ¡ç›®æ•°é‡ ï¼š2000w æˆå‘˜æ–¹æ³• load()ï¼šåŠ è½½ storePath ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œä¸ºæ¯ä¸ªæ–‡ä»¶åˆ›å»ºä¸€ä¸ª IndexFile å®ä¾‹å¯¹è±¡ï¼Œå¹¶åŠ è½½ IndexHeader ä¿¡æ¯ 1public boolean load(final boolean lastExitOK) deleteExpiredFile()ï¼šåˆ é™¤è¿‡æœŸç´¢å¼•æ–‡ä»¶ 12// å‚æ•° offset è¡¨ç¤º CommitLog å†…æœ€æ—©çš„æ¶ˆæ¯çš„ phyOffsetpublic void deleteExpiredFile(long offset) this.readWriteLock.readLock().lock()ï¼šåŠ é”åˆ¤æ–­ long endPhyOffset = this.indexFileList.get(0).getEndPhyOffset()ï¼šè·å–ç›®å½•ä¸­ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„ç»“æŸåç§»é‡ if (endPhyOffset &lt; offset)ï¼šç´¢å¼•ç›®å½•å†…å­˜åœ¨è¿‡æœŸçš„ç´¢å¼•æ–‡ä»¶ï¼Œå¹¶ä¸”å½“å‰çš„ IndexFile éƒ½æ˜¯è¿‡æœŸçš„æ•°æ® for (int i = 0; i &lt; (files.length - 1); i++)ï¼šéå†æ–‡ä»¶åˆ—è¡¨ï¼Œåˆ é™¤è¿‡æœŸçš„æ–‡ä»¶ buildIndex()ï¼šå­˜å‚¨ä¸»æ¨¡å— DefaultMessageStore å†…éƒ¨çš„å¼‚æ­¥çº¿ç¨‹è°ƒç”¨ï¼Œæ„å»º Index æ•°æ® 1public void buildIndex(DispatchRequest req) indexFile = retryGetAndCreateIndexFile()ï¼šè·å–æˆ–è€…åˆ›å»ºé¡ºåºå†™çš„ç´¢å¼•æ–‡ä»¶å¯¹è±¡ buildKey(topic, req.getUniqKey())ï¼šæ„å»ºç´¢å¼• keyï¼Œtopic + # + uniqKey indexFile = putKey()ï¼šæ’å…¥ç´¢å¼•æ–‡ä»¶ if (keys != null &amp;&amp; keys.length() &gt; 0)ï¼šæ¶ˆæ¯å­˜åœ¨è‡ªå®šä¹‰ç´¢å¼• keys for (int i = 0; i &lt; keyset.length; i++)ï¼šéå†æ¯ä¸ªç´¢å¼•ï¼Œä¸ºæ¯ä¸ª key è°ƒç”¨ä¸€æ¬¡ putKey getAndCreateLastIndexFile()ï¼šè·å–å½“å‰é¡ºåºå†™çš„ IndexFileï¼Œæ²¡æœ‰å°±åˆ›å»º 1public IndexFile getAndCreateLastIndexFile() HAServiceHAServiceServiceHAService ç±»æˆå‘˜å˜é‡ï¼š ä¸»èŠ‚ç‚¹å±æ€§ï¼š 123456// master èŠ‚ç‚¹å½“å‰æœ‰å¤šå°‘ä¸ª slave èŠ‚ç‚¹ä¸å…¶è¿›è¡Œæ•°æ®åŒæ­¥private final AtomicInteger connectionCount = new AtomicInteger(0);// master èŠ‚ç‚¹ä¼šç»™æ¯ä¸ªå‘èµ·è¿æ¥çš„ slave èŠ‚ç‚¹çš„é€šé“åˆ›å»ºä¸€ä¸ª HAConnectionï¼Œã€æ§åˆ¶ master ç«¯å‘ slave ç«¯ä¼ è¾“æ•°æ®ã€‘private final List&lt;HAConnection&gt; connectionList = new LinkedList&lt;&gt;();// master å‘ slave èŠ‚ç‚¹æ¨é€çš„æœ€å¤§çš„ offsetï¼Œè¡¨ç¤ºæ•°æ®åŒæ­¥çš„è¿›åº¦private final AtomicLong push2SlaveMaxOffset = new AtomicLong(0) å†…éƒ¨ç±»å±æ€§ï¼š 123456// å°è£…äº†ç»‘å®šæœåŠ¡å™¨æŒ‡å®šç«¯å£ï¼Œç›‘å¬ slave çš„è¿æ¥çš„é€»è¾‘ï¼Œæ²¡æœ‰ä½¿ç”¨ Nettyï¼Œä½¿ç”¨äº†åŸç”Ÿæ€çš„ NIO å»åšprivate final AcceptSocketService acceptSocketService;// æ§åˆ¶ç”Ÿäº§è€…çº¿ç¨‹é˜»å¡ç­‰å¾…çš„é€»è¾‘private final GroupTransferService groupTransferService;// slave èŠ‚ç‚¹çš„å®¢æˆ·ç«¯å¯¹è±¡ï¼Œã€slave ç«¯æ‰ä¼šæ­£å¸¸è¿è¡Œè¯¥å®ä¾‹ã€‘private final HAClient haClient; çº¿ç¨‹é€šä¿¡å¯¹è±¡ï¼š 1private final WaitNotifyObject waitNotifyObject = new WaitNotifyObject() æˆå‘˜æ–¹æ³•ï¼š start()ï¼šå¯åŠ¨é«˜å¯ç”¨æœåŠ¡ 12345678910public void start() throws Exception &#123; // ç›‘å¬ä»èŠ‚ç‚¹ this.acceptSocketService.beginAccept(); // å¯åŠ¨ç›‘å¬æœåŠ¡ this.acceptSocketService.start(); // å¯åŠ¨è½¬ç§»æœåŠ¡ this.groupTransferService.start(); // å¯åŠ¨ä»èŠ‚ç‚¹å®¢æˆ·ç«¯å®ä¾‹ this.haClient.start();&#125; AcceptAcceptSocketService ç±»ç”¨äºç›‘å¬ä»èŠ‚ç‚¹çš„è¿æ¥ï¼Œåˆ›å»º HAConnection è¿æ¥å¯¹è±¡ æˆå‘˜å˜é‡ï¼š ç«¯å£ä¿¡æ¯ï¼šMaster ç»‘å®šç›‘å¬çš„ç«¯å£ä¿¡æ¯ 1private final SocketAddress socketAddressListen; æœåŠ¡ç«¯é€šé“ï¼š 1private ServerSocketChannel serverSocketChannel; å¤šè·¯å¤ç”¨å™¨ï¼š 1private Selector selector; æˆå‘˜æ–¹æ³•ï¼š beginAccept()ï¼šå¼€å§‹ç›‘å¬è¿æ¥ï¼ŒNIO æ ‡å‡†æ¨¡æ¿ 1public void beginAccept() run()ï¼šæœåŠ¡å¯åŠ¨ 1public void run() this.selector.select(1000)ï¼šå¤šè·¯å¤ç”¨å™¨é˜»å¡è·å–å°±ç»ªçš„é€šé“ï¼Œæœ€å¤šç­‰å¾… 1 ç§’é’Ÿ Set&lt;SelectionKey&gt; selected = this.selector.selectedKeys()ï¼šè·å–é€‰æ‹©å™¨ä¸­æ‰€æœ‰æ³¨å†Œçš„é€šé“ä¸­å·²ç»å°±ç»ªå¥½çš„äº‹ä»¶ for (SelectionKey k : selected)ï¼šéå†æ‰€æœ‰å°±ç»ªçš„äº‹ä»¶ if ((k.readyOps() &amp; SelectionKey.OP_ACCEPT) != 0)ï¼šè¯´æ˜ OP_ACCEPT äº‹ä»¶å°±ç»ª SocketChannel sc = ((ServerSocketChannel) k.channel()).accept()ï¼šè·å–åˆ°å®¢æˆ·ç«¯è¿æ¥çš„é€šé“ HAConnection conn = new HAConnection(HAService.this, sc)ï¼šä¸ºæ¯ä¸ªè¿æ¥ master æœåŠ¡å™¨çš„ slave åˆ›å»ºè¿æ¥å¯¹è±¡ conn.start()ï¼šå¯åŠ¨ HAConnection å¯¹è±¡ï¼Œå†…éƒ¨å¯åŠ¨ä¸¤ä¸ªæœåŠ¡ä¸ºè¯»æ•°æ®æœåŠ¡ã€å†™æ•°æ®æœåŠ¡ HAService.this.addConnection(conn)ï¼šåŠ å…¥åˆ° HAConnection é›†åˆå†… GroupGroupTransferService ç”¨æ¥æ§åˆ¶æ•°æ®åŒæ­¥ æˆå‘˜æ–¹æ³•ï¼š doWaitTransfer()ï¼šç­‰å¾…ä¸»ä»æ•°æ®åŒæ­¥ 1private void doWaitTransfer() if (!this.requestsRead.isEmpty())ï¼šè¯»è¯·æ±‚ä¸ä¸ºç©º boolean transferOK = HAService.this.push2SlaveMaxOffset... &gt;= req.getNextOffset()ï¼šä¸»ä»åŒæ­¥æ˜¯å¦å®Œæˆ req.wakeupCustomer(transferOK ? ...)ï¼šå”¤é†’æ¶ˆè´¹è€… this.requestsRead.clear()ï¼šæ¸…ç©ºè¯»è¯·æ±‚ swapRequests()ï¼šäº¤æ¢è¯»å†™è¯·æ±‚ 1private void swapRequests() HAClientæˆå‘˜å±æ€§HAClient æ˜¯ slave ç«¯è¿è¡Œçš„ä»£ç ï¼Œç”¨äºå’Œ master æœåŠ¡å™¨å»ºç«‹é•¿è¿æ¥ï¼Œä¸ŠæŠ¥æœ¬åœ°åŒæ­¥è¿›åº¦ï¼Œæ¶ˆè´¹æœåŠ¡å™¨å‘æ¥çš„ msg æ•°æ® æˆå‘˜å˜é‡ï¼š ç¼“å†²åŒºï¼š 123private static final int READ_MAX_BUFFER_SIZE = 1024 * 1024 * 4; // é»˜è®¤å¤§å°ï¼š4 MBprivate ByteBuffer byteBufferRead = ByteBuffer.allocate(READ_MAX_BUFFER_SIZE);private ByteBuffer byteBufferBackup = ByteBuffer.allocate(READ_MAX_BUFFER_SIZE); ä¸»èŠ‚ç‚¹åœ°å€ï¼šæ ¼å¼ä¸º ip:port 1private final AtomicReference&lt;String&gt; masterAddress = new AtomicReference&lt;&gt;() NIO å±æ€§ï¼š 123private final ByteBuffer reportOffset; // é€šä¿¡ä½¿ç”¨NIOï¼Œæ‰€ä»¥æ¶ˆæ¯ä½¿ç”¨å—ä¼ è¾“ï¼Œä¸ŠæŠ¥ slave offset ä½¿ç”¨private SocketChannel socketChannel; // å®¢æˆ·ç«¯ä¸ master çš„ä¼šè¯é€šé“ private Selector selector; // å¤šè·¯å¤ç”¨å™¨ é€šä¿¡æ—¶é—´ï¼šä¸Šæ¬¡ä¼šè¯é€šä¿¡æ—¶é—´ï¼Œç”¨äºæ§åˆ¶ socketChannel æ˜¯å¦å…³é—­çš„ 1private long lastWriteTimestamp = System.currentTimeMillis(); è¿›åº¦ä¿¡æ¯ï¼š 12private long currentReportedOffset = 0; // slave å½“å‰çš„è¿›åº¦ä¿¡æ¯private int dispatchPosition = 0; // æ§åˆ¶ byteBufferRead position æŒ‡é’ˆ æˆå‘˜æ–¹æ³• run()ï¼šå¯åŠ¨æ–¹æ³• 1public void run() if (this.connectMaster())ï¼šè¿æ¥ä¸»èŠ‚ç‚¹ï¼Œè¿æ¥å¤±è´¥ä¼šä¼‘çœ  5 ç§’ String addr = this.masterAddress.get()ï¼šè·å– master æš´éœ²çš„ HA åœ°å€ç«¯å£ä¿¡æ¯ this.socketChannel = RemotingUtil.connect(socketAddress)ï¼šå»ºç«‹è¿æ¥ this.socketChannel.register(this.selector, SelectionKey.OP_READ)ï¼šæ³¨å†Œåˆ°å¤šè·¯å¤ç”¨å™¨ï¼Œå…³æ³¨è¯»äº‹ä»¶ this.currentReportedOffsetï¼š åˆå§‹åŒ–ä¸ŠæŠ¥è¿›åº¦å­—æ®µä¸º slave çš„ maxPhyOffset if (this.isTimeToReportOffset())ï¼šslave æ¯ 5 ç§’ä¼šä¸ŠæŠ¥ä¸€æ¬¡ slave ç«¯çš„åŒæ­¥è¿›åº¦ä¿¡æ¯ç»™ master boolean result = this.reportSlaveMaxOffset()ï¼šä¸ŠæŠ¥åŒæ­¥ä¿¡æ¯ï¼Œä¸ŠæŠ¥å¤±è´¥å…³é—­è¿æ¥ this.selector.select(1000)ï¼šå¤šè·¯å¤ç”¨å™¨é˜»å¡è·å–å°±ç»ªçš„é€šé“ï¼Œæœ€å¤šç­‰å¾… 1 ç§’é’Ÿï¼Œè·å–åˆ°å°±ç»ªäº‹ä»¶æˆ–è€…è¶…æ—¶åç»“æŸ boolean ok = this.processReadEvent()ï¼šå¤„ç†è¯»äº‹ä»¶ if (!reportSlaveMaxOffsetPlus())ï¼šæ£€æŸ¥æ˜¯å¦é‡æ–°ä¸ŠæŠ¥åŒæ­¥è¿›åº¦ reportSlaveMaxOffset()ï¼šä¸ŠæŠ¥ slave åŒæ­¥è¿›åº¦ 1private boolean reportSlaveMaxOffset(final long maxOffset) é¦–å…ˆå‘ç¼“å†²åŒºå†™å…¥ slave ç«¯æœ€å¤§åç§»é‡ï¼Œå†™å®Œä»¥ååˆ‡æ¢ä¸ºæŒ‡å®šç½®ä¸ºåˆå§‹çŠ¶æ€ for (int i = 0; i &lt; 3 &amp;&amp; this.reportOffset.hasRemaining(); i++)ï¼šå°è¯•ä¸‰æ¬¡å†™æ•°æ® this.socketChannel.write(this.reportOffset)ï¼šå†™æ•°æ® return !this.reportOffset.hasRemaining()ï¼šå†™æˆåŠŸä¹‹å pos &#x3D; limit processReadEvent()ï¼šå¤„ç† master å‘é€ç»™ slave æ•°æ®ï¼Œè¿”å› true è¡¨ç¤ºå¤„ç†æˆåŠŸ false è¡¨ç¤º Socket å¤„äºåŠå…³é—­çŠ¶æ€ï¼Œéœ€è¦ä¸Šå±‚é‡å»º haClient 1private boolean processReadEvent() int readSizeZeroTimes = 0ï¼šæ§åˆ¶ while å¾ªç¯çš„ä¸€ä¸ªæ¡ä»¶å˜é‡ï¼Œå½“å€¼ä¸º 3 æ—¶è·³å‡ºå¾ªç¯ while (this.byteBufferRead.hasRemaining())ï¼šbyteBufferRead æœ‰ç©ºé—´å¯ä»¥å» Socket è¯»ç¼“å†²åŒºåŠ è½½æ•°æ® int readSize = this.socketChannel.read(this.byteBufferRead)ï¼šä»é€šé“è¯»æ•°æ® if (readSize &gt; 0)ï¼šåŠ è½½æˆåŠŸï¼Œæœ‰æ–°æ•°æ® readSizeZeroTimes = 0ï¼šç½®ä¸º 0 boolean result = this.dispatchReadRequest()ï¼šå¤„ç†æ•°æ®çš„æ ¸å¿ƒé€»è¾‘ else if (readSize == 0) ï¼šè¿ç»­æ— æ–°æ•°æ® 3 æ¬¡ï¼Œè·³å‡ºå¾ªç¯ elseï¼šreadSize &#x3D; -1 å°±è¡¨ç¤º Socket å¤„äºåŠå…³é—­çŠ¶æ€ï¼Œå¯¹ç«¯å·²ç»å…³é—­äº† dispatchReadRequest()ï¼šå¤„ç†æ•°æ®çš„æ ¸å¿ƒé€»è¾‘ï¼Œmaster ä¸ slave ä¼ è¾“çš„æ•°æ®æ ¼å¼ &#123;[phyOffset][size][data...]&#125;ï¼ŒphyOffset è¡¨ç¤ºæ•°æ®åŒºé—´çš„å¼€å§‹åç§»é‡ï¼Œdata ä»£è¡¨æ•°æ®å—ï¼Œæœ€å¤§ 32kbï¼Œå¯èƒ½åŒ…å«å¤šæ¡æ¶ˆæ¯çš„æ•°æ® 1private boolean dispatchReadRequest() final int msgHeaderSize = 8 + 4ï¼šåè®®å¤´å¤§å° 12 int readSocketPos = this.byteBufferRead.position()ï¼šè®°å½•ç¼“å†²åŒºå¤„ç†æ•°æ®å‰çš„ pos ä½ç‚¹ï¼Œç”¨äºæ¢å¤æŒ‡é’ˆ int diff = ...ï¼šå½“å‰ byteBufferRead è¿˜å‰©å¤šå°‘ byte æœªå¤„ç†ï¼Œæ¯å¤„ç†ä¸€æ¡å¸§æ•°æ®éƒ½ä¼šæ›´æ–° dispatchPosition if (diff &gt;= msgHeaderSize)ï¼šç¼“å†²åŒºè¿˜æœ‰å®Œæ•´çš„åè®®å¤´ header æ•°æ® if (diff &gt;= (msgHeaderSize + bodySize))ï¼šè¯´æ˜ç¼“å†²åŒºå†…æ˜¯åŒ…å«å½“å‰å¸§çš„å…¨éƒ¨æ•°æ®çš„ï¼Œå¼€å§‹å¤„ç†å¸§æ•°æ® HAService...appendToCommitLog(masterPhyOffset, bodyData)ï¼šå­˜å‚¨æ•°æ®åˆ° CommitLogï¼Œå¹¶æ„å»º Index å’Œ CQ this.byteBufferRead.position(readSocketPos)ï¼šæ¢å¤ byteBufferRead çš„ pos æŒ‡é’ˆ this.dispatchPosition += msgHeaderSize + bodySizeï¼šåŠ ä¸€å¸§æ•°æ®é•¿åº¦ï¼Œå¤„ç†ä¸‹ä¸€æ¡æ•°æ®ä½¿ç”¨ if (!reportSlaveMaxOffsetPlus())ï¼šä¸ŠæŠ¥ slave åŒæ­¥ä¿¡æ¯ if (!this.byteBufferRead.hasRemaining())ï¼šç¼“å†²åŒºå†™æ»¡äº†ï¼Œé‡æ–°åˆ†é…ç¼“å†²åŒº reallocateByteBuffer()ï¼šé‡æ–°åˆ†é…ç¼“å†²åŒº 1private void reallocateByteBuffer() int remain = READ_MAX_BUFFER_SIZE - this.dispatchPositionï¼šè¡¨ç¤ºç¼“å†²åŒºå°šæœªå¤„ç†è¿‡çš„å­—èŠ‚æ•°é‡ if (remain &gt; 0)ï¼šæ¡ä»¶æˆç«‹ï¼Œè¯´æ˜ç¼“å†²åŒºæœ€åä¸€å¸§æ•°æ®æ˜¯åŠåŒ…æ•°æ®ï¼Œä½†æ˜¯ä¸èƒ½ä¸¢å¤±æ•°æ® this.byteBufferBackup.put(this.byteBufferRead)ï¼šå°†åŠåŒ…æ•°æ®æ‹·è´åˆ° backup ç¼“å†²åŒº this.swapByteBuffer()ï¼šäº¤æ¢ backup æˆä¸º read this.byteBufferRead.position(remain)ï¼šè®¾ç½® pos ä¸º remain ï¼Œåç»­åŠ è½½æ•°æ® pos ä»remain å¼€å§‹å‘åç§»åŠ¨ this.dispatchPosition = 0ï¼šå½“å‰ç¼“å†²åŒºäº¤æ¢ä¹‹åï¼Œç›¸å½“äºæ˜¯ä¸€ä¸ªå…¨æ–°çš„ byteBufferï¼Œæ‰€ä»¥åˆ†é…æŒ‡é’ˆå½’é›¶ HAConnConnectionHAConnection ç±»æˆå‘˜å˜é‡ï¼š ä¼šè¯é€šé“ï¼šmaster å’Œ slave ä¹‹é—´é€šä¿¡çš„ SocketChannel 1private final SocketChannel socketChannel; å®¢æˆ·ç«¯åœ°å€ï¼š 1private final String clientAddr; æœåŠ¡ç±»ï¼š 12private WriteSocketService writeSocketService; // å†™æ•°æ®æœåŠ¡private ReadSocketService readSocketService; // è¯»æ•°æ®æœåŠ¡ è¯·æ±‚ä½ç‚¹ï¼šåœ¨ slave ä¸ŠæŠ¥æœ¬åœ°çš„è¿›åº¦ä¹‹åè¢«èµ‹å€¼ï¼Œè¯¥å€¼å¤§äº 0 ååŒæ­¥é€»è¾‘æ‰ä¼šè¿è¡Œï¼Œmaster å¦‚æœä¸çŸ¥é“ slave èŠ‚ç‚¹å½“å‰æ¶ˆæ¯çš„å­˜å‚¨è¿›åº¦ï¼Œå°±æ— æ³•ç»™ slave æ¨é€æ•°æ® 1private volatile long slaveRequestOffset = -1; åº”ç­”ä½ç‚¹ï¼š ä¿å­˜æœ€æ–°çš„ slave ä¸ŠæŠ¥çš„ offset ä¿¡æ¯ï¼ŒslaveAckOffset ä¹‹å‰çš„æ•°æ®éƒ½å¯ä»¥è®¤ä¸º slave å·²ç»åŒæ­¥å®Œæˆ 1private volatile long slaveAckOffset = -1; æ ¸å¿ƒæ–¹æ³•ï¼š æ„é€ æ–¹æ³•ï¼š 1234567891011public HAConnection(final HAService haService, final SocketChannel socketChannel) &#123; // åˆå§‹åŒ–ä¸€äº›ä¸œè¥¿ // è®¾ç½® socket è¯»å†™ç¼“å†²åŒºä¸º 64kb å¤§å° this.socketChannel.socket().setReceiveBufferSize(1024 * 64); this.socketChannel.socket().setSendBufferSize(1024 * 64); // åˆ›å»ºè¯»å†™æœåŠ¡ this.writeSocketService = new WriteSocketService(this.socketChannel); this.readSocketService = new ReadSocketService(this.socketChannel); // è‡ªå¢ this.haService.getConnectionCount().incrementAndGet();&#125; å¯åŠ¨æ–¹æ³•ï¼š 1234public void start() &#123; this.readSocketService.start(); this.writeSocketService.start();&#125; ReadSocketReadSocketService ç±»æ˜¯ä¸€ä¸ªä»»åŠ¡å¯¹è±¡ï¼Œslave å‘ master ä¼ è¾“çš„å¸§æ ¼å¼ä¸º [long][long][long]ï¼Œä¸ŠæŠ¥çš„æ˜¯ slave æœ¬åœ°çš„åŒæ­¥è¿›åº¦ï¼ŒåŒæ­¥è¿›åº¦æ˜¯ä¸€ä¸ª long å€¼ æˆå‘˜å˜é‡ï¼š è¯»ç¼“å†²ï¼š 12private static final int READ_MAX_BUFFER_SIZE = 1024 * 1024; // é»˜è®¤å¤§å° 1MBprivate final ByteBuffer byteBufferRead = ByteBuffer.allocate(READ_MAX_BUFFER_SIZE); NIO å±æ€§ï¼š 12private final Selector selector; // å¤šè·¯å¤ç”¨å™¨private final SocketChannel socketChannel; // master ä¸ slave ä¹‹é—´çš„ä¼šè¯ SocketChannel å¤„ç†ä½ç‚¹ï¼šç¼“å†²åŒºå¤„ç†ä½ç‚¹ 1private int processPosition = 0; ä¸Šæ¬¡è¯»æ“ä½œçš„æ—¶é—´ï¼š 1private volatile long lastReadTimestamp = System.currentTimeMillis(); æ ¸å¿ƒæ–¹æ³•ï¼š æ„é€ æ–¹æ³•ï¼š 1public ReadSocketService(final SocketChannel socketChannel) this.socketChannel.register(this.selector, SelectionKey.OP_READ)ï¼šé€šé“æ³¨å†Œåˆ°å¤šè·¯å¤ç”¨å™¨ï¼Œå…³æ³¨è¯»äº‹ä»¶ this.setDaemon(true)ï¼šè®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹ è¿è¡Œæ–¹æ³•ï¼š 1public void run() this.selector.select(1000)ï¼šå¤šè·¯å¤ç”¨å™¨é˜»å¡è·å–å°±ç»ªçš„é€šé“ï¼Œæœ€å¤šç­‰å¾… 1 ç§’é’Ÿï¼Œè·å–åˆ°å°±ç»ªäº‹ä»¶æˆ–è€…è¶…æ—¶åç»“æŸ boolean ok = this.processReadEvent()ï¼šè¯»æ•°æ®çš„æ ¸å¿ƒæ–¹æ³•ï¼Œè¿”å› true è¡¨ç¤ºå¤„ç†æˆåŠŸ false è¡¨ç¤º Socket å¤„äºåŠå…³é—­çŠ¶æ€ï¼Œéœ€è¦ä¸Šå±‚é‡å»º HAConnection å¯¹è±¡ int readSizeZeroTimes = 0ï¼šæ§åˆ¶ while å¾ªç¯ï¼Œå½“è¿ç»­ä» Socket è¯»å–å¤±è´¥ 3 æ¬¡ï¼ˆæœªåŠ è½½åˆ°æ•°æ®ï¼‰è·³å‡ºå¾ªç¯ if (!this.byteBufferRead.hasRemaining())ï¼šbyteBufferRead å·²ç»å…¨éƒ¨ä½¿ç”¨å®Œï¼Œéœ€è¦æ¸…ç†æ•°æ®å¹¶æ›´æ–°ä½ç‚¹ while (this.byteBufferRead.hasRemaining())ï¼šbyteBufferRead æœ‰ç©ºé—´å¯ä»¥å» Socket è¯»ç¼“å†²åŒºåŠ è½½æ•°æ® int readSize = this.socketChannel.read(this.byteBufferRead)ï¼šä»é€šé“è¯»æ•°æ® if (readSize &gt; 0)ï¼šåŠ è½½æˆåŠŸï¼Œæœ‰æ–°æ•°æ® if ((byteBufferRead.position() - processPosition) &gt;= 8)ï¼šç¼“å†²åŒºçš„å¯è¯»æ•°æ®æœ€å°‘åŒ…å«ä¸€ä¸ªæ•°æ®å¸§ int pos = ...ï¼šè·å–å¯è¯»å¸§æ•°æ®ä¸­æœ€åä¸€ä¸ªå®Œæ•´çš„å¸§æ•°æ®çš„ä½ç‚¹ï¼Œåé¢çš„æ•°æ®ä¸¢å¼ƒ long readOffset = ...byteBufferRead.getLong(pos - 8)ï¼šè¯»å–æœ€åä¸€å¸§æ•°æ®ï¼Œslave ç«¯å½“å‰çš„åŒæ­¥è¿›åº¦ä¿¡æ¯ this.processPosition = posï¼šæ›´æ–°å¤„ç†ä½ç‚¹ HAConnection.this.slaveAckOffset = readOffsetï¼šæ›´æ–°åº”ç­”ä½ç‚¹ if (HAConnection.this.slaveRequestOffset &lt; 0)ï¼šæ¡ä»¶æˆç«‹ç»™ slaveRequestOffset èµ‹å€¼ HAConnection...notifyTransferSome(slaveAckOffset)ï¼šå”¤é†’é˜»å¡çš„ç”Ÿäº§è€…çº¿ç¨‹ else if (readSize == 0) ï¼šè¯»å– 3 æ¬¡æ— æ–°æ•°æ®è·³å‡ºå¾ªç¯ elseï¼šreadSize &#x3D; -1 å°±è¡¨ç¤º Socket å¤„äºåŠå…³é—­çŠ¶æ€ï¼Œå¯¹ç«¯å·²ç»å…³é—­äº† if (interval &gt; 20)ï¼šè¶…è¿‡ 20 ç§’æœªå‘ç”Ÿé€šä¿¡ï¼Œç›´æ¥ç»“æŸå¾ªç¯ WriteSocketWriteSocketService ç±»æ˜¯ä¸€ä¸ªä»»åŠ¡å¯¹è±¡ï¼Œmaster å‘ slave ä¼ è¾“çš„æ•°æ®å¸§æ ¼å¼ä¸º &#123;[phyOffset][size][data...]&#125;&#123;[phyOffset][size][data...]&#125; phyOffsetï¼šæ•°æ®åŒºé—´çš„å¼€å§‹åç§»é‡ï¼Œå¹¶ä¸è¡¨ç¤ºæŸä¸€æ¡å…·ä½“çš„æ¶ˆæ¯ï¼Œè¡¨ç¤ºçš„æ•°æ®å—å¼€å§‹çš„åç§»é‡ä½ç½® sizeï¼šåŒæ­¥çš„æ•°æ®å—çš„å¤§å° dataï¼šæ•°æ®å—ï¼Œæœ€å¤§ 32kbï¼Œå¯èƒ½åŒ…å«å¤šæ¡æ¶ˆæ¯çš„æ•°æ® æˆå‘˜å˜é‡ï¼š åè®®å¤´ï¼š 12private final int headerSize = 8 + 4; // åè®®å¤´å¤§å°ï¼š12private final ByteBuffer byteBufferHeader; // å¸§å¤´ç¼“å†²åŒº NIO å±æ€§ï¼š 12private final Selector selector; // å¤šè·¯å¤ç”¨å™¨private final SocketChannel socketChannel; // master ä¸ slave ä¹‹é—´çš„ä¼šè¯ SocketChannel å¤„ç†ä½ç‚¹ï¼šä¸‹ä¸€æ¬¡ä¼ è¾“åŒæ­¥æ•°æ®çš„ä½ç½®ä¿¡æ¯ï¼Œmaster ç»™å½“å‰ slave åŒæ­¥çš„ä½ç‚¹ 1private long nextTransferFromWhere = -1; ä¸Šæ¬¡å†™æ“ä½œï¼š 12private boolean lastWriteOver = true; // ä¸Šä¸€è½®æ•°æ®æ˜¯å¦ä¼ è¾“å®Œæ¯•private long lastWriteTimestamp = System.currentTimeMillis(); // ä¸Šæ¬¡å†™æ“ä½œçš„æ—¶é—´ æ ¸å¿ƒæ–¹æ³•ï¼š æ„é€ æ–¹æ³•ï¼š 1public WriteSocketService(final SocketChannel socketChannel) this.socketChannel.register(this.selector, SelectionKey.OP_WRITE)ï¼šé€šé“æ³¨å†Œåˆ°å¤šè·¯å¤ç”¨å™¨ï¼Œå…³æ³¨å†™äº‹ä»¶ this.setDaemon(true)ï¼šè®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹ è¿è¡Œæ–¹æ³•ï¼š 1public void run() this.selector.select(1000)ï¼šå¤šè·¯å¤ç”¨å™¨é˜»å¡è·å–å°±ç»ªçš„é€šé“ï¼Œæœ€å¤šç­‰å¾… 1 ç§’é’Ÿï¼Œè·å–åˆ°å°±ç»ªäº‹ä»¶æˆ–è€…è¶…æ—¶åç»“æŸ if (-1 == HAConnection.this.slaveRequestOffset)ï¼šç­‰å¾… slave åŒæ­¥å®Œæ•°æ® if (-1 == this.nextTransferFromWhere)ï¼šæ¡ä»¶æˆç«‹ï¼Œéœ€è¦åˆå§‹åŒ–è¯¥å˜é‡ if (0 == HAConnection.this.slaveRequestOffset)ï¼šslave æ˜¯ä¸€ä¸ªå…¨æ–°èŠ‚ç‚¹ï¼Œä»æ­£åœ¨é¡ºåºå†™çš„ MF å¼€å§‹åŒæ­¥æ•°æ® long masterOffset = ...ï¼šè·å– master æœ€å¤§çš„ offsetï¼Œå¹¶è®¡ç®—å½’å±çš„ mappedFile æ–‡ä»¶çš„å¼€å§‹ offset this.nextTransferFromWhere = masterOffsetï¼šèµ‹å€¼ç»™ä¸‹ä¸€æ¬¡ä¼ è¾“åŒæ­¥æ•°æ®çš„ä½ç½®ä¿¡æ¯ this.nextTransferFromWhere = HAConnection.this.slaveRequestOffsetï¼šå¤§éƒ¨åˆ†æƒ…å†µèµ°è¿™ä¸ªèµ‹å€¼é€»è¾‘ if (this.lastWriteOver)ï¼šä¸Šä¸€æ¬¡å¾…å‘é€æ•°æ®å…¨éƒ¨å‘é€å®Œæˆ if (interval &gt; 5)ï¼šè¶…è¿‡ 5 ç§’æœªåŒæ­¥æ•°æ®ï¼Œå‘é€ä¸€ä¸ª header å¿ƒè·³æ•°æ®åŒ…ï¼Œç»´æŒé•¿è¿æ¥ elseï¼šä¸Šä¸€è½®çš„å¾…å‘é€æ•°æ®æœªå…¨éƒ¨å‘é€ï¼Œéœ€è¦åŒæ­¥æ•°æ®åˆ° slave èŠ‚ç‚¹ SelectMappedBufferResult selectResultï¼šåˆ° CommitLog ä¸­æŸ¥è¯¢ nextTransferFromWhere å¼€å§‹ä½ç½®çš„æ•°æ® if (size &gt; 32k)ï¼šä¸€æ¬¡æœ€å¤šåŒæ­¥ 32k æ•°æ® this.nextTransferFromWhere += sizeï¼šå¢åŠ  sizeï¼Œä¸‹ä¸€è½®ä¼ è¾“è·³è¿‡æœ¬å¸§æ•°æ® selectResult.getByteBuffer().limit(size)ï¼šè®¾ç½® byteBuffer å¯è®¿é—®æ•°æ®åŒºé—´ä¸º [pos, size] this.selectMappedBufferResult = selectResultï¼šå¾…å‘é€çš„æ•°æ® this.byteBufferHeader.putï¼šæ„å»ºå¸§å¤´æ•°æ® this.lastWriteOver = this.transferData()ï¼šå¤„ç†æ•°æ®ï¼Œè¿”å›æ˜¯å¦å¤„ç†å®Œæˆ åŒæ­¥æ–¹æ³•ï¼šåŒæ­¥æ•°æ®åˆ° slave èŠ‚ç‚¹ï¼Œè¿”å› true è¡¨ç¤ºæœ¬è½®æ•°æ®å…¨éƒ¨åŒæ­¥å®Œæˆï¼Œfalse è¡¨ç¤ºæœ¬è½®åŒæ­¥æœªå®Œæˆï¼ˆHeader å’Œ Body å…¶ä¸­ä¸€ä¸ªæœªåŒæ­¥å®Œæˆéƒ½ä¼šè¿”å› falseï¼‰ 1private boolean transferData() int writeSizeZeroTimes= 0ï¼šæ§åˆ¶ while å¾ªç¯ï¼Œå½“å†™å¤±è´¥è¿ç»­ 3 æ¬¡æ—¶ï¼Œè·³å‡ºå¾ªç¯ï¼‰è·³å‡ºå¾ªç¯ while (this.byteBufferHeader.hasRemaining())ï¼šå¸§å¤´æ•°æ®ç¼“å†²åŒºæœ‰å¾…å‘é€çš„æ•°æ® int writeSize = this.socketChannel.write(this.byteBufferHeader)ï¼šå‘é€šé“å†™å¸§å¤´æ•°æ® if (null == this.selectMappedBufferResult)ï¼šè¯´æ˜æ˜¯å¿ƒè·³æ•°æ®ï¼Œè¿”å›å¿ƒè·³æ•°æ®æ˜¯å¦å‘é€å®Œæˆ if (!this.byteBufferHeader.hasRemaining())ï¼šHeaderå†™æˆåŠŸä¹‹åï¼Œæ‰è¿›è¡Œå†™ Body while (this.selectMappedBufferResult.getByteBuffer().hasRemaining())ï¼šæ•°æ®ç¼“å†²åŒºæœ‰å¾…å‘é€çš„æ•°æ® int writeSize = this.socketChannel.write(this.selectMappedBufferResult...)ï¼šå‘é€šé“å†™å¸§å¤´æ•°æ® if (writeSize &gt; 0)ï¼šå†™æ•°æ®æˆåŠŸï¼Œä½†æ˜¯ä¸ä»£è¡¨ SMBR ä¸­çš„æ•°æ®å…¨éƒ¨å†™å®Œæˆ boolean resultï¼šåˆ¤æ–­æ˜¯å¦å‘é€å®Œæˆï¼Œè¿”å›è¯¥å€¼ MesStoreç”Ÿå‘½å‘¨æœŸDefaultMessageStore ç±»æ ¸å¿ƒæ˜¯æ•´ä¸ªå­˜å‚¨æœåŠ¡çš„è°ƒåº¦ç±» æ„é€ æ–¹æ³•ï¼š 1public DefaultMessageStore() this.allocateMappedFileService.start()ï¼šå¯åŠ¨åˆ›å»º MappedFile æ–‡ä»¶æœåŠ¡ this.indexService.start()ï¼šå¯åŠ¨ç´¢å¼•æœåŠ¡ load()ï¼šå…ˆåŠ è½½ CommitLogï¼Œå†åŠ è½½ ConsumeQueueï¼Œæœ€ååŠ è½½ IndexFileï¼ŒåŠ è½½å®Œè¿›å…¥æ¢å¤é˜¶æ®µï¼Œå…ˆæ¢å¤ CQï¼Œåœ¨æ¢å¤ CL 1public boolean load() start()ï¼šæ ¸å¿ƒå¯åŠ¨æ–¹æ³• 1public void start() lock = lockFile.getChannel().tryLock(0, 1, false)ï¼šè·å–æ–‡ä»¶é”ï¼Œè·å–å¤±è´¥è¯´æ˜å½“å‰ç›®å½•å·²ç»å¯åŠ¨è¿‡ Broker long maxPhysicalPosInLogicQueue = commitLog.getMinOffset()ï¼šéå†å…¨éƒ¨çš„ CQ å¯¹è±¡ï¼Œè·å– CQ ä¸­æ¶ˆæ¯çš„æœ€å¤§åç§»é‡ this.reputMessageService.start()ï¼šè®¾ç½®åˆ†å‘æœåŠ¡çš„åˆ†å‘ä½ç‚¹ï¼Œå¯åŠ¨åˆ†å‘æœåŠ¡ï¼Œæ„å»º ConsumerQueue å’Œ IndexFile if (dispatchBehindBytes() &lt;= 0)ï¼šçº¿ç¨‹ç­‰å¾…åˆ†å‘æœåŠ¡å°†åˆ†å‘æ•°æ®å…¨éƒ¨å¤„ç†å®Œæ¯• this.recoverTopicQueueTable()ï¼šå› ä¸ºä¿®æ”¹äº† CQ æ•°æ®ï¼Œæ‰€ä»¥å†æ¬¡æ„å»ºé˜Ÿåˆ—åç§»é‡å­—æ®µè¡¨ this.haService.start()ï¼šå¯åŠ¨ HA æœåŠ¡ this.handleScheduleMessageService()ï¼šå¯åŠ¨æ¶ˆæ¯è°ƒåº¦æœåŠ¡ this.flushConsumeQueueService.start()ï¼šå¯åŠ¨ CQ æ¶ˆè´¹é˜Ÿåˆ—åˆ·ç›˜æœåŠ¡ this.commitLog.start()ï¼šå¯åŠ¨ CL åˆ·ç›˜æœåŠ¡ this.storeStatsService.start()ï¼šå¯åŠ¨çŠ¶æ€å­˜å‚¨æœåŠ¡ this.createTempFile()ï¼šåˆ›å»º AbortFileï¼Œæ­£å¸¸å…³æœºæ—¶ JVM HOOK ä¼šåˆ é™¤è¯¥æ–‡ä»¶ï¼Œå¼‚å¸¸å®•æœºæ—¶è¯¥æ–‡ä»¶ä¸ä¼šåˆ é™¤ï¼Œå¼€æœºæ•°æ®æ¢å¤é˜¶æ®µæ ¹æ®æ˜¯å¦å­˜åœ¨è¯¥æ–‡ä»¶ï¼Œæ‰§è¡Œä¸åŒçš„æ¢å¤ç­–ç•¥ this.addScheduleTask()ï¼šæ·»åŠ å®šæ—¶ä»»åŠ¡ DefaultMessageStore.this.cleanFilesPeriodically()ï¼šå®šæ—¶æ¸…ç†è¿‡æœŸæ–‡ä»¶ï¼Œå‘¨æœŸæ˜¯ 10 ç§’ this.cleanCommitLogService.run()ï¼šå¯åŠ¨æ¸…ç†è¿‡æœŸçš„ CL æ–‡ä»¶æœåŠ¡ this.cleanConsumeQueueService.run()ï¼šå¯åŠ¨æ¸…ç†è¿‡æœŸçš„ CQ æ–‡ä»¶æœåŠ¡ DefaultMessageStore.this.checkSelf()ï¼šæ¯ 10 åˆ†ç§è¿›è¡Œå¥åº·æ£€æŸ¥ DefaultMessageStore.this.cleanCommitLogService.isSpaceFull()ï¼šç£ç›˜é¢„è­¦å®šæ—¶ä»»åŠ¡ï¼Œæ¯ 10 ç§’ä¸€æ¬¡ if (physicRatio &gt; this.diskSpaceWarningLevelRatio)ï¼šæ£€æŸ¥ç£ç›˜æ˜¯å¦åˆ°è¾¾ waring é˜ˆå€¼ï¼Œé»˜è®¤ 90% boolean diskok = ...runningFlags.getAndMakeDiskFull()ï¼šè®¾ç½®ç£ç›˜å†™æ»¡æ ‡è®° boolean diskok = ...this.runningFlags.getAndMakeDiskOK()ï¼šè®¾ç½®ç£ç›˜å¯å†™æ ‡è®° this.shutdown = falseï¼šåˆšå¯åŠ¨ï¼Œè®¾ç½®ä¸º false shutdown()ï¼šå…³é—­å„ç§æœåŠ¡å’Œçº¿ç¨‹èµ„æºï¼Œè®¾ç½®å­˜å‚¨æ¨¡å—çŠ¶æ€ä¸ºå…³é—­çŠ¶æ€ 1public void shutdown() destroy()ï¼šé”€æ¯ Broker çš„å·¥ä½œç›®å½• 1public void destroy() æœåŠ¡çº¿ç¨‹ServiceThread ç±»è¢«å¾ˆå¤šæœåŠ¡ç»§æ‰¿ï¼Œæœ¬èº«æ˜¯ä¸€ä¸ª Runnable ä»»åŠ¡å¯¹è±¡ï¼Œç»§æ‰¿è€…é€šè¿‡é‡å†™ run æ–¹æ³•æ¥å®ç°æœåŠ¡çš„é€»è¾‘ run()ï¼šä¸€èˆ¬å®ç°æ–¹å¼ 12345public void run() &#123; while (!this.isStopped()) &#123; // ä¸šåŠ¡é€»è¾‘ &#125;&#125; é€šè¿‡å‚æ•° stopped æ§åˆ¶æœåŠ¡çš„åœæ­¢ï¼Œä½¿ç”¨ volatile ä¿®é¥°ä¿è¯å¯è§æ€§ 1protected volatile boolean stopped = false shutdown()ï¼šåœæ­¢çº¿ç¨‹ï¼Œé¦–å…ˆè®¾ç½® stopped ä¸º trueï¼Œç„¶åè¿›è¡Œå”¤é†’ï¼Œé»˜è®¤ä¸ç›´æ¥æ‰“æ–­çº¿ç¨‹ 1public void shutdown() waitForRunning()ï¼šæŒ‚èµ·çº¿ç¨‹ï¼Œè®¾ç½®å”¤é†’æ ‡è®° hasNotified ä¸º false 1protected void waitForRunning(long interval) wakeup()ï¼šå”¤é†’çº¿ç¨‹ï¼Œè®¾ç½® hasNotified ä¸º true 1public void wakeup() æ„å»ºæœåŠ¡AllocateMappedFileService åˆ›å»º MappedFile æœåŠ¡ mmapOperation()ï¼šæ ¸å¿ƒæœåŠ¡ 1private boolean mmapOperation() req = this.requestQueue.take()ï¼š ä» requestQueue é˜»å¡é˜Ÿåˆ—ï¼ˆä¼˜å…ˆçº§ï¼‰ä¸­è·å– AllocateRequest ä»»åŠ¡ if (...isTransientStorePoolEnable())ï¼šæ¡ä»¶æˆç«‹ä½¿ç”¨ç›´æ¥å†…å­˜å†™å…¥æ•°æ®ï¼Œ ä»ç›´æ¥å†…å­˜ä¸­ commit åˆ° FileChannel ä¸­ mappedFile = new MappedFile(req.getFilePath(), req.getFileSize())ï¼šæ ¹æ®è¯·æ±‚çš„è·¯å¾„å’Œå¤§å°åˆ›å»ºå¯¹è±¡ mappedFile.warmMappedFile()ï¼šåˆ¤æ–­ mappedFile å¤§å°ï¼Œåªæœ‰ CommitLog æ‰è¿›è¡Œæ–‡ä»¶é¢„çƒ­ req.setMappedFile(mappedFile)ï¼šå°†åˆ›å»ºå¥½çš„ MF å¯¹è±¡çš„èµ‹å€¼ç»™è¯·æ±‚å¯¹è±¡çš„æˆå‘˜å±æ€§ req.getCountDownLatch().countDown()ï¼šå”¤é†’è¯·æ±‚çš„é˜»å¡çº¿ç¨‹ putRequestAndReturnMappedFile()ï¼šMappedFileQueue ä¸­ç”¨æ¥åˆ›å»º MF å¯¹è±¡çš„æ–¹æ³• 1public MappedFile putRequestAndReturnMappedFile(String nextFilePath, String nextNextFilePath, int fileSize) AllocateRequest nextReq = new AllocateRequest(...)ï¼šåˆ›å»º nextFilePath çš„ AllocateRequest å¯¹è±¡ï¼Œæ”¾å…¥è¯·æ±‚åˆ—è¡¨å’Œé˜»å¡é˜Ÿåˆ—ï¼Œç„¶ååˆ›å»º nextNextFilePath çš„ AllocateRequest å¯¹è±¡ï¼Œæ”¾å…¥è¯·æ±‚åˆ—è¡¨å’Œé˜»å¡é˜Ÿåˆ— AllocateRequest result = this.requestTable.get(nextFilePath)ï¼šä»è¯·æ±‚åˆ—è¡¨è·å– nextFilePath çš„è¯·æ±‚å¯¹è±¡ result.getCountDownLatch().await(...)ï¼šçº¿ç¨‹æŒ‚èµ·ï¼Œç›´åˆ°è¶…æ—¶æˆ–è€… nextFilePath å¯¹åº”çš„ MF æ–‡ä»¶åˆ›å»ºå®Œæˆ return result.getMappedFile()ï¼šè¿”å›åˆ›å»ºå¥½çš„ MF æ–‡ä»¶å¯¹è±¡ ReputMessageService æ¶ˆæ¯åˆ†å‘æœåŠ¡ï¼Œç”¨äºæ„å»º ConsumerQueue å’Œ IndexFile æ–‡ä»¶ run()ï¼šå¾ªç¯æ‰§è¡Œ doReput æ–¹æ³•ï¼Œæ‰€ä»¥å‘é€çš„æ¶ˆæ¯å­˜å‚¨è¿› CL å°±å¯ä»¥äº§ç”Ÿå¯¹åº”çš„ CQï¼Œæ¯æ‰§è¡Œä¸€æ¬¡çº¿ç¨‹ä¼‘çœ  1 æ¯«ç§’ 1public void run() doReput()ï¼šå®ç°åˆ†å‘çš„æ ¸å¿ƒé€»è¾‘ 1private void doReput() for (boolean doNext = true; this.isCommitLogAvailable() &amp;&amp; doNext; )ï¼šå¾ªç¯éå† SelectMappedBufferResult resultï¼š ä» CommitLog æ‹‰å–æ•°æ®ï¼Œæ•°æ®èŒƒå›´ [reputFromOffset, åŒ…å«è¯¥åç§»é‡çš„ MF çš„æœ€å¤§ Pos]ï¼Œå°è£…æˆç»“æœå¯¹è±¡ DispatchRequest dispatchRequestï¼šä»ç»“æœå¯¹è±¡è¯»å–å‡ºä¸€æ¡ DispatchRequest æ•°æ® DefaultMessageStore.this.doDispatch(dispatchRequest)ï¼šå°†æ•°æ®äº¤ç»™åˆ†å‘å™¨è¿›è¡Œåˆ†å‘ï¼Œç”¨äºæ„å»º CQ å’Œç´¢å¼•æ–‡ä»¶ this.reputFromOffset += sizeï¼šæ›´æ–°æ•°æ®èŒƒå›´ åˆ·ç›˜æœåŠ¡FlushConsumeQueueService åˆ·ç›˜ CQ æ•°æ® run()ï¼šæ¯éš” 1 ç§’æ‰§è¡Œä¸€æ¬¡åˆ·ç›˜æœåŠ¡ï¼Œè·³å‡ºå¾ªç¯åè¿˜ä¼šæ‰§è¡Œä¸€æ¬¡å¼ºåˆ¶åˆ·ç›˜ 1public void run() doFlush()ï¼šåˆ·ç›˜ 1private void doFlush(int retryTimes) int flushConsumeQueueLeastPagesï¼šè„é¡µé˜ˆå€¼ï¼Œé»˜è®¤æ˜¯ 2 if (retryTimes == RETRY_TIMES_OVER)ï¼šé‡è¯•æ¬¡æ•°æ˜¯ 3 æ—¶è®¾ç½®å¼ºåˆ¶åˆ·ç›˜ï¼Œè®¾ç½®è„é¡µé˜ˆå€¼ä¸º 0 int flushConsumeQueueThoroughIntervalï¼šä¸¤æ¬¡åˆ·æ–°çš„æ—¶é—´é—´éš”è¶…è¿‡ 60 ç§’ä¼šå¼ºåˆ¶åˆ·ç›˜ for (ConsumeQueue cq : maps.values())ï¼šéå†æ‰€æœ‰çš„ CQï¼Œè¿›è¡Œåˆ·ç›˜ DefaultMessageStore.this.getStoreCheckpoint().flush()ï¼šå¼ºåˆ¶åˆ·ç›˜æ—¶å°† StoreCheckpoint ç¬æ—¶æ•°æ®åˆ·ç›˜ FlushCommitLogService åˆ·ç›˜ CL æ•°æ®ï¼Œé»˜è®¤æ˜¯å¼‚æ­¥åˆ·ç›˜ run()ï¼šè¿è¡Œæ–¹æ³• 1public void run() while (!this.isStopped())ï¼šstoppedä¸º true æ‰è·³å‡ºå¾ªç¯ boolean flushCommitLogTimedï¼šæ§åˆ¶çº¿ç¨‹çš„ä¼‘çœ æ–¹å¼ï¼Œé»˜è®¤æ˜¯ falseï¼Œä½¿ç”¨ CountDownLatch.await() ä¼‘çœ ï¼Œè®¾ç½®ä¸º true æ—¶ä½¿ç”¨ Thread.sleep() ä¼‘çœ  int intervalï¼šè·å–é…ç½®ä¸­çš„åˆ·ç›˜æ—¶é—´é—´éš” int flushPhysicQueueLeastPagesï¼šè·å–æœ€å°åˆ·ç›˜é¡µæ•°ï¼Œé»˜è®¤æ˜¯ 4 é¡µï¼Œè„é¡µè¾¾åˆ°æŒ‡å®šé¡µæ•°æ‰åˆ·ç›˜ int flushPhysicQueueThoroughIntervalï¼šè·å–å¼ºåˆ¶åˆ·ç›˜å‘¨æœŸï¼Œé»˜è®¤æ˜¯ 10 ç§’ï¼Œè¾¾åˆ°å‘¨æœŸåå¼ºåˆ¶åˆ·ç›˜ï¼Œä¸è€ƒè™‘è„é¡µ if (flushCommitLogTimed)ï¼šä¼‘çœ é€»è¾‘ï¼Œé¿å… CPU å ç”¨å¤ªé•¿æ—¶é—´ï¼Œå¯¼è‡´æ— æ³•æ‰§è¡Œå…¶ä»–æ›´ç´§æ€¥çš„ä»»åŠ¡ CommitLog.this.mappedFileQueue.flush(flushPhysicQueueLeastPages)ï¼šåˆ·ç›˜ for (int i = 0; i &lt; RETRY_TIMES_OVER &amp;&amp; !result; i++)ï¼šstopped åœæ­¢æ ‡è®°ä¸º true æ—¶ï¼Œéœ€è¦ç¡®ä¿æ‰€æœ‰çš„æ•°æ®éƒ½å·²ç»åˆ·ç›˜ï¼Œæ‰€ä»¥æ­¤å¤„å°è¯• 10 æ¬¡å¼ºåˆ¶åˆ·ç›˜ï¼Œ result = CommitLog.this.mappedFileQueue.flush(0)ï¼šå¼ºåˆ¶åˆ·ç›˜ æ¸…ç†æœåŠ¡CleanCommitLogService æ¸…ç†è¿‡æœŸçš„ CL æ•°æ®ï¼Œå®šæ—¶ä»»åŠ¡ 10 ç§’è°ƒç”¨ä¸€æ¬¡ï¼Œå…ˆæ¸…ç† CLï¼Œå†æ¸…ç† CQï¼Œå› ä¸º CQ ä¾èµ–äº CL çš„æ•°æ® run()ï¼šè¿è¡Œæ–¹æ³• 1public void run() deleteExpiredFiles()ï¼šåˆ é™¤è¿‡æœŸ CL æ–‡ä»¶ 1private void deleteExpiredFiles() long fileReservedTimeï¼šé»˜è®¤ 72ï¼Œä»£è¡¨æ–‡ä»¶çš„ä¿ç•™æ—¶é—´ boolean timeup = this.isTimeToDelete()ï¼šå½“å‰æ—¶é—´æ˜¯å¦æ˜¯å‡Œæ™¨ 4 ç‚¹ boolean spacefull = this.isSpaceToDelete()ï¼šCL æˆ–è€… CQ çš„ç›®å½•ç£ç›˜ä½¿ç”¨ç‡è¾¾åˆ°é˜ˆå€¼æ ‡å‡† 85% boolean manualDelete = this.manualDeleteFileSeveralTimes &gt; 0ï¼šæ‰‹åŠ¨åˆ é™¤æ–‡ä»¶ fileReservedTime *= 60 * 60 * 1000ï¼šé»˜è®¤ä¿ç•™ 72 å°æ—¶ deleteCount = DefaultMessageStore.this.commitLog.deleteExpiredFile()ï¼šè°ƒç”¨ MFQ å¯¹è±¡çš„åˆ é™¤æ–¹æ³• CleanConsumeQueueService æ¸…ç†è¿‡æœŸçš„ CQ æ•°æ® run()ï¼šè¿è¡Œæ–¹æ³• 1public void run() deleteExpiredFiles()ï¼šåˆ é™¤è¿‡æœŸ CQ æ–‡ä»¶ 1private void deleteExpiredFiles() int deleteLogicsFilesIntervalï¼šæ¸…ç† CQ çš„æ—¶é—´é—´éš”ï¼Œé»˜è®¤ 100 æ¯«ç§’ long minOffset = DefaultMessageStore.this.commitLog.getMinOffset()ï¼šè·å– CL æ–‡ä»¶ä¸­æœ€å°çš„ç‰©ç†åç§»é‡ if (minOffset &gt; this.lastPhysicalMinOffset)ï¼šCL æœ€å°çš„åç§»é‡å¤§äº CQ æœ€å°çš„ï¼Œè¯´æ˜æœ‰è¿‡æœŸæ•°æ® this.lastPhysicalMinOffset = minOffsetï¼šæ›´æ–° CQ çš„æœ€å°åç§»é‡ for (ConsumeQueue logic : maps.values())ï¼šéå†æ‰€æœ‰çš„ CQ æ–‡ä»¶ logic.deleteExpiredFile(minOffset)ï¼šè°ƒç”¨ MFQ å¯¹è±¡çš„åˆ é™¤æ–¹æ³• DefaultMessageStore.this.indexService.deleteExpiredFile(minOffset)ï¼šåˆ é™¤è¿‡æœŸçš„ç´¢å¼•æ–‡ä»¶ è·å–æ¶ˆæ¯DefaultMessageStore#getMessage ç”¨äºè·å–æ¶ˆæ¯ï¼Œåœ¨ PullMessageProcessor#processRequest æ–¹æ³•ä¸­è¢«è°ƒç”¨ ï¼ˆæç¤ºï¼šå»ºè®®å­¦ä¹ æ¶ˆè´¹è€…æºç æ—¶å†é˜…è¯»ï¼‰ 12// offset: å®¢æˆ·ç«¯æ‹‰æ¶ˆæ¯ä½¿ç”¨ä½ç‚¹ï¼› maxMsgNums: 32ï¼› messageFilter: ä¸€èˆ¬è¿™é‡Œæ˜¯ tagCode è¿‡æ»¤ public GetMessageResult getMessage(final String group, final String topic, final int queueId, final long offset, final int maxMsgNums, final MessageFilter messageFilter) if (this.shutdown)ï¼šæ£€æŸ¥è¿è¡ŒçŠ¶æ€ GetMessageResult getResultï¼šåˆ›å»ºæŸ¥è¯¢ç»“æœå¯¹è±¡ final long maxOffsetPy = this.commitLog.getMaxOffset()ï¼šè·å– CommitLog æœ€å¤§ç‰©ç†åç§»é‡ ConsumeQueue consumeQueue = findConsumeQueue(topic, queueId)ï¼šæ ¹æ®ä¸»é¢˜å’Œé˜Ÿåˆ— ID è·å– ConsumeQueueå¯¹è±¡ minOffset, maxOffsetï¼šè·å–å½“å‰ ConsumeQueue çš„æœ€å° offset å’Œ æœ€å¤§ offsetï¼Œåˆ¤æ–­æ˜¯å¦æ»¡è¶³æœ¬æ¬¡ Pull çš„ offset if (maxOffset == 0)ï¼šè¯´æ˜é˜Ÿåˆ—å†…æ— æ•°æ®ï¼Œè®¾ç½®çŠ¶æ€ä¸º NO_MESSAGE_IN_QUEUEï¼Œå¤–å±‚è¿›è¡Œé•¿è½®è¯¢ else if (offset &lt; minOffset)ï¼šè¯´æ˜ offset å¤ªå°äº†ï¼Œè®¾ç½®çŠ¶æ€ä¸º OFFSET_TOO_SMALL else if (offset == maxOffset)ï¼šæ¶ˆè´¹è¿›åº¦æŒå¹³ï¼Œè®¾ç½®çŠ¶æ€ä¸º OFFSET_OVERFLOW_ONEï¼Œå¤–å±‚è¿›è¡Œé•¿è½®è¯¢ else if (offset &gt; maxOffset)ï¼šè¯´æ˜ offset è¶Šç•Œäº†ï¼Œè®¾ç½®çŠ¶æ€ä¸º OFFSET_OVERFLOW_BADLY SelectMappedBufferResult bufferConsumeQueueï¼šæŸ¥è¯¢ CQData è·å–åŒ…å«è¯¥ offset çš„ MappedFile æ–‡ä»¶ï¼Œå¦‚æœè¯¥æ–‡ä»¶ä¸æ˜¯é¡ºåºå†™çš„æ–‡ä»¶ï¼Œå°±è¯»å– [offset%maxSize, æ–‡ä»¶å°¾] èŒƒå›´çš„æ•°æ®ï¼Œåä¹‹è¯»å– [offset%maxSize, æ–‡ä»¶å+wrotePositionå°¾] å…ˆæŸ¥ CQ çš„åŸå› ï¼šå› ä¸º CQ æ—¶ CL çš„ç´¢å¼•ï¼Œé€šè¿‡ CQ æŸ¥è¯¢ CL æ›´åŠ å¿«æ· if (bufferConsumeQueue != null)ï¼šåªæœ‰å† CQ åˆ é™¤è¿‡æœŸæ•°æ®çš„é€»è¾‘æ‰§è¡Œæ—¶ï¼Œæ¡ä»¶æ‰ä¸æˆç«‹ï¼Œä¸€èˆ¬éƒ½æ˜¯æˆç«‹çš„ long nextPhyFileStartOffset = Long.MIN_VALUEï¼šä¸‹ä¸€ä¸ª commitLog ç‰©ç†æ–‡ä»¶åï¼Œåˆå§‹å€¼ä¸ºæœ€å°å€¼ long maxPhyOffsetPulling = 0ï¼šæœ¬æ¬¡æ‹‰æ¶ˆæ¯æœ€åä¸€æ¡æ¶ˆæ¯çš„ç‰©ç†åç§»é‡ for ()ï¼šå¤„ç†æ•°æ®ï¼Œæ¯æ¬¡å¤„ç† 20 å­—èŠ‚å¤„ç†å­—èŠ‚æ•°å¤§äº 16000 æ—¶è·³å‡ºå¾ªç¯ offsetPy, sizePy, tagsCodeï¼šè¯»å– 20 ä¸ªå­—èŠ‚åï¼Œè·å–æ¶ˆæ¯ç‰©ç†åç§»é‡ã€æ¶ˆæ¯å¤§å°ã€æ¶ˆæ¯ tagCode boolean isInDisk = checkInDiskByCommitOffset(...)ï¼šæ£€æŸ¥æ¶ˆæ¯æ˜¯çƒ­æ•°æ®è¿˜æ˜¯å†·æ•°æ®ï¼Œfalse ä¸ºçƒ­æ•°æ® long memoryï¼šBroker ç³»ç»Ÿ 40% å†…å­˜çš„å­—èŠ‚æ•°ï¼Œå†™æ•°æ®æ—¶å†…å­˜ä¸å¤Ÿä¼šä½¿ç”¨ LRU ç®—æ³•æ·˜æ±°æ•°æ®ï¼Œå°†æ·˜æ±°æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ return (maxOffsetPy - offsetPy) &gt; memoryï¼šè¿”å› true è¯´æ˜æ•°æ®å·²ç»æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œä¸ºå†·æ•°æ® if (this.isTheBatchFull())ï¼šæ§åˆ¶æ˜¯å¦è·³å‡ºå¾ªç¯ if (0 == bufferTotal || 0 == messageTotal)ï¼šæœ¬æ¬¡ pull æ¶ˆæ¯æœªæ‹‰å–åˆ°ä»»ä½•ä¸œè¥¿ï¼Œéœ€è¦å¤–å±‚ for å¾ªç¯ç»§ç»­ï¼Œè¿”å› false if (maxMsgNums &lt;= messageTotal)ï¼šç»“æœå¯¹è±¡å†…æ¶ˆæ¯æ•°å·²ç»è¶…è¿‡äº†æœ€å¤§æ¶ˆæ¯æ•°é‡ï¼Œå¯ä»¥ç»“æŸå¾ªç¯äº† if (isInDisk)ï¼šå†·æ•°æ® if ((bufferTotal + sizePy) &gt; ...)ï¼šå†·æ•°æ®ä¸€æ¬¡ pull è¯·æ±‚æœ€å¤§å…è®¸è·å– 64kb çš„æ¶ˆæ¯ if (messageTotal &gt; ...)ï¼šå†·æ•°æ®ä¸€æ¬¡ pull è¯·æ±‚æœ€å¤§å…è®¸è·å–8 æ¡æ¶ˆæ¯ elseï¼šçƒ­æ•°æ® if ((bufferTotal + sizePy) &gt; ...)ï¼šçƒ­æ•°æ®ä¸€æ¬¡ pull è¯·æ±‚æœ€å¤§å…è®¸è·å– 256kb çš„æ¶ˆæ¯ if (messageTotal &gt; ...)ï¼šå†·æ•°æ®ä¸€æ¬¡ pull è¯·æ±‚æœ€å¤§å…è®¸è·å– 32 æ¡æ¶ˆæ¯ if (messageFilter != null)ï¼šæŒ‰ç…§æ¶ˆæ¯ tagCode è¿›è¡Œè¿‡æ»¤ selectResult = this.commitLog.getMessage(offsetPy, sizePy)ï¼šæ ¹æ® CQ æ¶ˆæ¯ç‰©ç†åç§»é‡å’Œæ¶ˆæ¯å¤§å°åˆ° commitLog ä¸­æŸ¥è¯¢è¿™æ¡ msg if (null == selectResult)ï¼šæ¡ä»¶æˆç«‹è¯´æ˜ commitLog æ‰§è¡Œäº†åˆ é™¤è¿‡æœŸæ–‡ä»¶çš„å®šæ—¶ä»»åŠ¡ï¼Œå› ä¸ºæ˜¯å…ˆæ¸…ç†çš„ CLï¼Œæ‰€ä»¥ CQ è¿˜æœ‰è¯¥ç´¢å¼•æ•°æ® nextPhyFileStartOffset = this.commitLog.rollNextFile(offsetPy)ï¼šè·å–åŒ…å«è¯¥ offsetPy çš„ä¸‹ä¸€ä¸ªæ•°æ®æ–‡ä»¶çš„æ–‡ä»¶å getResult.addMessage(selectResult)ï¼šå°†æœ¬æ¬¡å¾ªç¯æŸ¥è¯¢å‡ºæ¥çš„ msg åŠ å…¥åˆ° getResult å†… status = GetMessageStatus.FOUNDï¼šæŸ¥è¯¢çŠ¶æ€è®¾ç½®ä¸º FOUND nextPhyFileStartOffset = Long.MIN_VALUEï¼šè®¾ç½®ä¸ºæœ€å°å€¼ï¼Œè·³è¿‡æœŸ CQData æ•°æ®çš„é€»è¾‘ nextBeginOffset = offset + (i / ConsumeQueue.CQ_STORE_UNIT_SIZE)ï¼šè®¡ç®—å®¢æˆ·ç«¯ä¸‹ä¸€æ¬¡ pull æ—¶ä½¿ç”¨çš„ä½ç‚¹ä¿¡æ¯ getResult.setSuggestPullingFromSlave(diff &gt; memory)ï¼šé€‰æ‹©ä¸»ä»èŠ‚ç‚¹çš„å»ºè®® diff &gt; memory =&gt; trueï¼šè¡¨ç¤ºæœ¬è½®æŸ¥è¯¢æœ€åä¸€æ¡æ¶ˆæ¯ä¸ºå†·æ•°æ®ï¼ŒBroker å»ºè®®å®¢æˆ·ç«¯ä¸‹ä¸€æ¬¡ pull æ—¶åˆ° slave èŠ‚ç‚¹ diff &gt; memory =&gt; falseï¼šè¡¨ç¤ºæœ¬è½®æŸ¥è¯¢æœ€åä¸€æ¡æ¶ˆæ¯ä¸ºçƒ­æ•°æ®ï¼ŒBroker å»ºè®®å®¢æˆ·ç«¯ä¸‹ä¸€æ¬¡ pull æ—¶åˆ° master èŠ‚ç‚¹ getResult.setStatus(status)ï¼šè®¾ç½®ç»“æœçŠ¶æ€ getResult.setNextBeginOffset(nextBeginOffset)ï¼šè®¾ç½®å®¢æˆ·ç«¯ä¸‹ä¸€æ¬¡ pull æ—¶çš„ offset getResult.setMaxOffset(maxOffset)ï¼šè®¾ç½® queue çš„æœ€å¤§ offset å’Œæœ€å° offset return getResultï¼šè¿”å›ç»“æœå¯¹è±¡ BrokerBrokerStartup å¯åŠ¨æ–¹æ³• 123456public static void main(String[] args) &#123; start(createBrokerController(args));&#125;public static BrokerController start(BrokerController controller) &#123; controller.start(); // å¯åŠ¨&#125; BrokerStartup#createBrokerControllerï¼šæ„é€ æ§åˆ¶å™¨ï¼Œå¹¶åˆå§‹åŒ– final BrokerController controller()ï¼šåˆ›å»ºå®ä¾‹å¯¹è±¡ boolean initResult = controller.initialize()ï¼šæ§åˆ¶å™¨åˆå§‹åŒ– this.registerProcessor()ï¼šæ³¨å†Œäº†å¤„ç†å™¨ï¼ŒåŒ…æ‹¬å‘é€æ¶ˆæ¯ã€æ‹‰å–æ¶ˆæ¯ã€æŸ¥è¯¢æ¶ˆæ¯ç­‰æ ¸å¿ƒå¤„ç†å™¨ initialTransaction()ï¼šåˆå§‹åŒ–äº†äº‹åŠ¡æœåŠ¡ï¼Œç”¨äºè¿›è¡Œäº‹åŠ¡å›æŸ¥ BrokerController#startï¼šæ ¸å¿ƒå¯åŠ¨æ–¹æ³• this.messageStore.start()ï¼šå¯åŠ¨å­˜å‚¨æœåŠ¡ this.remotingServer.start()ï¼šå¯åŠ¨ Netty é€šä¿¡æœåŠ¡ this.fileWatchService.start()ï¼šå¯åŠ¨æ–‡ä»¶ç›‘å¬æœåŠ¡ startProcessorByHa(messageStoreConfig.getBrokerRole())ï¼šå¯åŠ¨äº‹åŠ¡å›æŸ¥ this.scheduledExecutorService.scheduleAtFixedRate()ï¼šæ¯éš” 30s å‘ NameServer ä¸ŠæŠ¥ Topic è·¯ç”±ä¿¡æ¯ï¼Œå¿ƒè·³æœºåˆ¶ BrokerController.this.registerBrokerAll(true, false, brokerConfig.isForceRegister()) Producerç”Ÿäº§è€…ç±»ç”Ÿäº§è€…ç±»DefaultMQProducer æ˜¯ç”Ÿäº§è€…çš„é»˜è®¤å®ç°ç±» æˆå‘˜å˜é‡ï¼š ç”Ÿäº§è€…å®ç°ç±»ï¼š 1protected final transient DefaultMQProducerImpl defaultMQProducerImpl ç”Ÿäº§è€…ç»„ï¼šå‘é€äº‹åŠ¡æ¶ˆæ¯ï¼ŒBroker ç«¯è¿›è¡Œäº‹åŠ¡å›æŸ¥ï¼ˆè¡¥å¿æœºåˆ¶ï¼‰æ—¶ï¼Œé€‰æ‹©å½“å‰ç”Ÿäº§è€…ç»„çš„ä¸‹ä¸€ä¸ªç”Ÿäº§è€…è¿›è¡Œäº‹åŠ¡å›æŸ¥ 1private String producerGroup; é»˜è®¤ä¸»é¢˜ï¼šisAutoCreateTopicEnable å¼€å¯æ—¶ï¼Œå½“å‘é€æ¶ˆæ¯æŒ‡å®šçš„ Topic åœ¨ Namesrv æœªæ‰¾åˆ°è·¯ç”±ä¿¡æ¯ï¼Œä½¿ç”¨è¯¥å€¼åˆ›å»º Topic ä¿¡æ¯ 12private String createTopicKey = TopicValidator.AUTO_CREATE_TOPIC_KEY_TOPIC;// å€¼ä¸ºã€TBW102ã€‘ï¼ŒJust for testing or demo program æ¶ˆæ¯é‡æŠ•ï¼šç³»ç»Ÿç‰¹æ€§æ¶ˆæ¯é‡è¯•éƒ¨åˆ†è¯¦è§£äº†ä¸‰ä¸ªå‚æ•°çš„ä½œç”¨ 123private int retryTimesWhenSendFailed = 2; // åŒæ­¥å‘é€å¤±è´¥åé‡è¯•çš„å‘é€æ¬¡æ•°ï¼ŒåŠ ä¸Šç¬¬ä¸€æ¬¡å‘é€ï¼Œä¸€å…±ä¸‰æ¬¡private int retryTimesWhenSendAsyncFailed = 2; // å¼‚æ­¥private boolean retryAnotherBrokerWhenNotStoreOK = false; // æ¶ˆæ¯æœªå­˜å‚¨æˆåŠŸï¼Œé€‰æ‹©å…¶ä»– Broker é‡è¯• æ¶ˆæ¯é˜Ÿåˆ—ï¼š 1private volatile int defaultTopicQueueNums = 4; // é»˜è®¤ Broker åˆ›å»ºçš„é˜Ÿåˆ—æ•° æ¶ˆæ¯å±æ€§ï¼š 12345678910111213141516 private int sendMsgTimeout = 3000; // å‘é€æ¶ˆæ¯çš„è¶…æ—¶é™åˆ¶ private int compressMsgBodyOverHowmuch = 1024 * 4; // å‹ç¼©é˜ˆå€¼ï¼Œå½“ msg body è¶…è¿‡ 4k åä½¿ç”¨å‹ç¼© private int maxMessageSize = 1024 * 1024 * 4; // æ¶ˆæ¯ä½“çš„æœ€å¤§é™åˆ¶ï¼Œé»˜è®¤ 4M private TraceDispatcher traceDispatcher = null; // æ¶ˆæ¯è½¨è¿¹æ„é€ æ–¹æ³•ï¼š* æ„é€ æ–¹æ³•ï¼š ```java public DefaultMQProducer(final String namespace, final String producerGroup, RPCHook rpcHook) &#123; this.namespace = namespace; this.producerGroup = producerGroup; // åˆ›å»ºç”Ÿäº§è€…å®ç°å¯¹è±¡ defaultMQProducerImpl = new DefaultMQProducerImpl(this, rpcHook); &#125; æˆå‘˜æ–¹æ³•ï¼š start()ï¼šå¯åŠ¨æ–¹æ³• 12345678910public void start() throws MQClientException &#123; // é‡ç½®ç”Ÿäº§è€…ç»„åï¼Œå¦‚æœä¼ é€’äº†å‘½åç©ºé—´ï¼Œåˆ™ ã€namespace%groupã€‘ this.setProducerGroup(withNamespace(this.producerGroup)); // ç”Ÿäº§è€…å®ç°å¯¹è±¡å¯åŠ¨ this.defaultMQProducerImpl.start(); if (null != traceDispatcher) &#123; // æ¶ˆæ¯è½¨è¿¹çš„é€»è¾‘ traceDispatcher.start(this.getNamesrvAddr(), this.getAccessChannel()); &#125;&#125; send()ï¼šå‘é€æ¶ˆæ¯ï¼š 1234567public SendResult send(Message msg)&#123; // æ ¡éªŒæ¶ˆæ¯ Validators.checkMessage(msg, this); // è®¾ç½®æ¶ˆæ¯ Topic msg.setTopic(withNamespace(msg.getTopic())); return this.defaultMQProducerImpl.send(msg);&#125; request()ï¼šè¯·æ±‚æ–¹æ³•ï¼Œéœ€è¦æ¶ˆè´¹è€…å›æ‰§æ¶ˆæ¯ 1234public Message request(final Message msg, final MessageQueue mq, final long timeout) &#123; msg.setTopic(withNamespace(msg.getTopic())); return this.defaultMQProducerImpl.request(msg, mq, timeout);&#125; å®ç°è€…ç±»DefaultMQProducerImpl ç±»æ˜¯é»˜è®¤çš„ç”Ÿäº§è€…å®ç°ç±» æˆå‘˜å˜é‡ï¼š å®ä¾‹å¯¹è±¡ï¼š 12private final DefaultMQProducer defaultMQProducer; // æŒæœ‰é»˜è®¤ç”Ÿäº§è€…å¯¹è±¡ï¼Œç”¨æ¥è·å–å¯¹è±¡ä¸­çš„é…ç½®ä¿¡æ¯private MQClientInstance mQClientFactory; // å®¢æˆ·ç«¯å®ä¾‹å¯¹è±¡ï¼Œç”Ÿäº§è€…å¯åŠ¨åéœ€è¦æ³¨å†Œåˆ°è¯¥å®¢æˆ·ç«¯å¯¹è±¡å†… ä¸»é¢˜å‘å¸ƒä¿¡æ¯æ˜ å°„è¡¨ï¼škey æ˜¯ Topicï¼Œvalue æ˜¯å‘å¸ƒä¿¡æ¯ 1private final ConcurrentMap&lt;String, TopicPublishInfo&gt; topicPublishInfoTable = new ConcurrentHashMap&lt;String, TopicPublishInfo&gt;(); å¼‚æ­¥å‘é€æ¶ˆæ¯ï¼šç›¸å…³ä¿¡æ¯ 123private final BlockingQueue&lt;Runnable&gt; asyncSenderThreadPoolQueue;// å¼‚æ­¥å‘é€æ¶ˆæ¯ï¼Œå¼‚æ­¥çº¿ç¨‹æ± ä½¿ç”¨çš„é˜Ÿåˆ—private final ExecutorService defaultAsyncSenderExecutor; // å¼‚æ­¥å‘é€æ¶ˆæ¯é»˜è®¤ä½¿ç”¨çš„çº¿ç¨‹æ± private ExecutorService asyncSenderExecutor; // å¼‚æ­¥æ¶ˆæ¯å‘é€çº¿ç¨‹æ± ï¼ŒæŒ‡å®šåå°±ä¸ä½¿ç”¨é»˜è®¤çº¿ç¨‹æ± äº† å®šæ—¶å™¨ï¼šæ‰§è¡Œå®šæ—¶ä»»åŠ¡ 1private final Timer timer = new Timer(&quot;RequestHouseKeepingService&quot;, true); // å®ˆæŠ¤çº¿ç¨‹ çŠ¶æ€ä¿¡æ¯ï¼šæœåŠ¡çš„çŠ¶æ€ï¼Œé»˜è®¤åˆ›å»ºçŠ¶æ€ 1private ServiceState serviceState = ServiceState.CREATE_JUST; å‹ç¼©ç­‰çº§ï¼šZIP å‹ç¼©ç®—æ³•çš„ç­‰çº§ï¼Œé»˜è®¤æ˜¯ 5ï¼Œè¶Šé«˜å‹ç¼©æ•ˆæœå¥½ï¼Œä½†æ˜¯å‹ç¼©çš„æ›´æ…¢ 1private int zipCompressLevel = Integer.parseInt(System.getProperty..., &quot;5&quot;)); å®¹é”™ç­–ç•¥ï¼šé€‰æ‹©é˜Ÿåˆ—çš„å®¹é”™ç­–ç•¥ 1private MQFaultStrategy mqFaultStrategy = new MQFaultStrategy(); é’©å­ï¼šç”¨æ¥è¿›è¡Œå‰ç½®æˆ–è€…åç½®å¤„ç† 123ArrayList&lt;SendMessageHook&gt; sendMessageHookList; // å‘é€æ¶ˆæ¯çš„é’©å­ï¼Œç•™ç»™ç”¨æˆ·æ‰©å±•ä½¿ç”¨ArrayList&lt;CheckForbiddenHook&gt; checkForbiddenHookList; // å¯¹æ¯”ä¸Šé¢çš„é’©å­ï¼Œå¯ä»¥æŠ›å¼‚å¸¸ï¼Œæ§åˆ¶æ¶ˆæ¯æ˜¯å¦å¯ä»¥å‘é€private final RPCHook rpcHook; // ä¼ é€’ç»™ NettyRemotingClient æ„é€ æ–¹æ³•ï¼š é»˜è®¤æ„é€ ï¼š 1234public DefaultMQProducerImpl(final DefaultMQProducer defaultMQProducer) &#123; // é»˜è®¤ RPC HOOK æ˜¯ç©º this(defaultMQProducer, null);&#125; æœ‰å‚æ„é€ ï¼š 1234567891011public DefaultMQProducerImpl(final DefaultMQProducer defaultMQProducer, RPCHook rpcHook) &#123; // å±æ€§èµ‹å€¼ this.defaultMQProducer = defaultMQProducer; this.rpcHook = rpcHook; // åˆ›å»ºã€å¼‚æ­¥æ¶ˆæ¯çº¿ç¨‹æ± ä»»åŠ¡é˜Ÿåˆ—ã€‘ï¼Œé•¿åº¦æ˜¯ 5w this.asyncSenderThreadPoolQueue = new LinkedBlockingQueue&lt;Runnable&gt;(50000); // åˆ›å»ºé»˜è®¤çš„å¼‚æ­¥æ¶ˆæ¯ä»»åŠ¡çº¿ç¨‹æ±  this.defaultAsyncSenderExecutor = new ThreadPoolExecutor( // æ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°éƒ½æ˜¯ ç³»ç»Ÿå¯ç”¨çš„è®¡ç®—èµ„æºï¼ˆ8æ ¸16çº¿ç¨‹çš„ç³»ç»Ÿå°±æ˜¯ 16ï¼‰...&#125; å®ç°æ–¹æ³• start()ï¼šå¯åŠ¨æ–¹æ³•ï¼Œå‚æ•°é»˜è®¤æ˜¯ trueï¼Œä»£è¡¨æ­£å¸¸çš„å¯åŠ¨è·¯å¾„ 1public void start(final boolean startFactory) this.serviceState = ServiceState.START_FAILEDï¼šå…ˆä¿®æ”¹ä¸ºå¯åŠ¨å¤±è´¥ï¼ŒæˆåŠŸåå†ä¿®æ”¹ï¼Œè¿™ç§æ€æƒ³å¾ˆå¸¸è§ this.checkConfig()ï¼šåˆ¤æ–­ç”Ÿäº§è€…ç»„åä¸èƒ½æ˜¯ç©ºï¼Œä¹Ÿä¸èƒ½æ˜¯ default_PRODUCER if (!getProducerGroup().equals(MixAll.CLIENT_INNER_PRODUCER_GROUP))ï¼šæ¡ä»¶æˆç«‹è¯´æ˜å½“å‰ç”Ÿäº§è€…ä¸æ˜¯å†…éƒ¨äº§ç”Ÿè€…ï¼Œå†…éƒ¨ç”Ÿäº§è€…æ˜¯å¤„ç†æ¶ˆæ¯å›é€€çš„è¿™ç§æƒ…å†µä½¿ç”¨çš„ç”Ÿäº§è€… this.defaultMQProducer.changeInstanceNameToPID()ï¼šä¿®æ”¹ç”Ÿäº§è€…å®ä¾‹åç§°ä¸ºå½“å‰è¿›ç¨‹çš„ PID this.mQClientFactory = ...ï¼šè·å–å½“å‰è¿›ç¨‹çš„ MQ å®¢æˆ·ç«¯å®ä¾‹å¯¹è±¡ï¼Œä» factoryTable ä¸­è·å– key ä¸º å®¢æˆ·ç«¯ IDï¼Œæ ¼å¼æ˜¯ip@pidï¼Œä¸€ä¸ª JVM è¿›ç¨‹åªæœ‰ä¸€ä¸ª PIDï¼Œä¹Ÿåªæœ‰ä¸€ä¸ª MQClientInstance boolean registerOK = mQClientFactory.registerProducer(...)ï¼šå°†ç”Ÿäº§è€…æ³¨å†Œåˆ° RocketMQ å®¢æˆ·ç«¯å®ä¾‹å†… this.topicPublishInfoTable.put(...)ï¼šæ·»åŠ ä¸€ä¸ªä¸»é¢˜å‘å¸ƒä¿¡æ¯ï¼Œkey æ˜¯ TBW102 ï¼Œvalue æ˜¯ä¸€ä¸ªç©ºå¯¹è±¡ mQClientFactory.start()ï¼šå¯åŠ¨ RocketMQ å®¢æˆ·ç«¯å®ä¾‹å¯¹è±¡ this.mQClientFactory.sendHeartbeatToAllBrokerWithLock()ï¼šRocketMQ å®¢æˆ·ç«¯å®ä¾‹å‘å·²çŸ¥çš„ Broker èŠ‚ç‚¹å‘é€ä¸€æ¬¡å¿ƒè·³ï¼ˆä¹Ÿæ˜¯å®šæ—¶ä»»åŠ¡ï¼‰ this.timer.scheduleAtFixedRate()ï¼š request å‘é€çš„æ¶ˆæ¯éœ€è¦æ¶ˆè´¹ç€å›æ‰§ä¿¡æ¯ï¼Œå¯åŠ¨å®šæ—¶ä»»åŠ¡æ¯ç§’ä¸€æ¬¡åˆ é™¤è¶…æ—¶è¯·æ±‚ ç”Ÿäº§è€… msg æ·»åŠ ä¿¡æ¯å…³è” ID å‘é€åˆ° Broker æ¶ˆè´¹è€…ä» Broker æ‹¿åˆ°æ¶ˆæ¯åä¼šæ£€æŸ¥ msg ç±»å‹æ˜¯ä¸€ä¸ªéœ€è¦å›æ‰§çš„æ¶ˆæ¯ï¼Œå¤„ç†å®Œæ¶ˆæ¯åä¼šæ ¹æ® msg å…³è” ID å’Œå®¢æˆ·ç«¯ ID ç”Ÿæˆä¸€æ¡å“åº”ç»“æœæ¶ˆæ¯å‘é€åˆ° Brokerï¼ŒBroker åˆ¤æ–­ä¸ºå›æ‰§æ¶ˆæ¯ï¼Œä¼šæ ¹æ®å®¢æˆ·ç«¯ID æ‰¾åˆ° channel æ¨é€ç»™ç”Ÿäº§è€… ç”Ÿäº§è€…æ‹¿åˆ°å›æ‰§æ¶ˆæ¯åï¼Œè¯»å–å‡ºæ¥å…³è” ID æ‰¾åˆ°å¯¹åº”çš„ RequestFutureï¼Œå°†é˜»å¡çº¿ç¨‹å”¤é†’ sendDefaultImpl()ï¼šå‘é€æ¶ˆæ¯ 12//å‚æ•°1ï¼šæ¶ˆæ¯ï¼›å‚æ•°2ï¼šå‘é€æ¨¡å¼ï¼ˆåŒæ­¥å¼‚æ­¥å•å‘ï¼‰ï¼›å‚æ•°3ï¼šå›è°ƒå‡½æ•°ï¼Œå¼‚æ­¥å‘é€æ—¶éœ€è¦ï¼›å‚æ•°4ï¼šå‘é€è¶…æ—¶æ—¶é—´, é»˜è®¤ 3 ç§’private SendResult sendDefaultImpl(msg, communicationMode, sendCallback,timeout) &#123;&#125; this.makeSureStateOK()ï¼šæ ¡éªŒç”Ÿäº§è€…çŠ¶æ€æ˜¯è¿è¡Œä¸­ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ topicPublishInfo = this.tryToFindTopicPublishInfo(msg.getTopic())ï¼šè·å–å½“å‰æ¶ˆæ¯ä¸»é¢˜çš„å‘å¸ƒä¿¡æ¯ this.topicPublishInfoTable.get(topic)ï¼šå…ˆå°è¯•ä»æœ¬åœ°ä¸»é¢˜å‘å¸ƒä¿¡æ¯æ˜ å°„è¡¨è·å–ä¿¡æ¯ï¼Œè·å–ä¸åˆ°ç»§ç»­æ‰§è¡Œ this.mQClientFactory.update...FromNameServer(topic)ï¼šç„¶åä» Namesrv æ›´æ–°è¯¥ Topic çš„è·¯ç”±æ•°æ® this.mQClientFactory.update...FromNameServer(...)ï¼šè·¯ç”±æ•°æ®æ˜¯ç©ºï¼Œè·å–é»˜è®¤ TBW102 çš„æ•°æ® return topicPublishInfoï¼šè¿”å› TBW102 ä¸»é¢˜çš„å‘å¸ƒä¿¡æ¯ String[] brokersSent = new String[timesTotal]ï¼šä¸‹æ ‡ç´¢å¼•ä»£è¡¨ç¬¬å‡ æ¬¡å‘é€ï¼Œå€¼ä»£è¡¨è¿™æ¬¡å‘é€é€‰æ‹© Broker name for (; times &lt; timesTotal; times++)ï¼šå¾ªç¯å‘é€ï¼Œå‘é€æˆåŠŸæˆ–è€…å‘é€å°è¯•æ¬¡æ•°è¾¾åˆ°ä¸Šé™ï¼Œç»“æŸå¾ªç¯ String lastBrokerName = null == mq ? null : mq.getBrokerName()ï¼šè·å–ä¸Šæ¬¡å‘é€å¤±è´¥çš„ BrokerName mqSelected = this.selectOneMessageQueue(topicPublishInfo, lastBrokerName)ï¼šä»å‘å¸ƒä¿¡æ¯ä¸­é€‰æ‹©ä¸€ä¸ªé˜Ÿåˆ—ï¼Œç”Ÿäº§è€…çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œå‚è€ƒç³»ç»Ÿç‰¹æ€§ç« èŠ‚ brokersSent[times] = mq.getBrokerName()ï¼šå°†æœ¬æ¬¡é€‰æ‹©çš„ BrokerName å­˜å…¥æ•°ç»„ msg.setTopic(this.defaultMQProducer.withNamespace(msg.getTopic()))ï¼šäº§ç”Ÿé‡æŠ•ï¼Œé‡æŠ•æ¶ˆæ¯éœ€è¦åŠ ä¸Šæ ‡è®° sendResult = this.sendKernelImplï¼šæ ¸å¿ƒå‘é€æ–¹æ³• switch (communicationMode)ï¼šå¼‚æ­¥æˆ–è€…å•å‘æ¶ˆæ¯ç›´æ¥è¿”å› nullï¼Œå¼‚æ­¥é€šè¿‡å›è°ƒå‡½æ•°å¤„ç†ï¼ŒåŒæ­¥å‘é€è¿›å…¥é€»è¾‘åˆ¤æ–­ if (sendResult.getSendStatus() != SendStatus.SEND_OK)ï¼šæœåŠ¡ç«¯ Broker å­˜å‚¨å¤±è´¥ï¼Œéœ€è¦é‡è¯•å…¶ä»– Broker throw new MQClientException()ï¼šæœªæ‰¾åˆ°å½“å‰ä¸»é¢˜çš„è·¯ç”±æ•°æ®ï¼Œæ— æ³•å‘é€æ¶ˆæ¯ï¼ŒæŠ›å‡ºå¼‚å¸¸ sendKernelImpl()ï¼šæ ¸å¿ƒå‘é€æ–¹æ³• 12//å‚æ•°1ï¼šæ¶ˆæ¯ï¼›å‚æ•°2ï¼šé€‰æ‹©çš„é˜Ÿåˆ—ï¼›å‚æ•°3ï¼šå‘é€æ¨¡å¼ï¼ˆåŒæ­¥å¼‚æ­¥å•å‘ï¼‰ï¼›å‚æ•°4ï¼šå›è°ƒå‡½æ•°ï¼Œå¼‚æ­¥å‘é€æ—¶éœ€è¦ï¼›å‚æ•°5ï¼šä¸»é¢˜å‘å¸ƒä¿¡æ¯ï¼›å‚æ•°6ï¼šå‰©ä½™è¶…æ—¶æ—¶é—´é™åˆ¶private SendResult sendKernelImpl(msg, mq, communicationMode, sendCallback, topicPublishInfo, timeout) brokerAddr = this.mQClientFactory(...)ï¼šè·å–æŒ‡å®š BrokerName å¯¹åº”çš„ mater èŠ‚ç‚¹çš„åœ°å€ï¼Œmaster èŠ‚ç‚¹çš„ ID ä¸º 0ï¼Œé›†ç¾¤æ¨¡å¼ä¸‹ï¼Œå‘é€æ¶ˆæ¯è¦å‘åˆ°ä¸»èŠ‚ç‚¹ brokerAddr = MixAll.brokerVIPChannel()ï¼šBroker å¯åŠ¨æ—¶ä¼šç»‘å®šä¸¤ä¸ªæœåŠ¡å™¨ç«¯å£ï¼Œä¸€ä¸ªæ˜¯æ™®é€šç«¯å£ï¼Œä¸€ä¸ªæ˜¯ VIP ç«¯å£ï¼ŒæœåŠ¡å™¨ç«¯æ ¹æ®ä¸åŒç«¯å£åˆ›å»ºä¸åŒçš„çš„ NioSocketChannel byte[] prevBody = msg.getBody()ï¼šè·å–æ¶ˆæ¯ä½“ if (!(msg instanceof MessageBatch))ï¼šéæ‰¹é‡æ¶ˆæ¯ï¼Œéœ€è¦é‡æ–°è®¾ç½®æ¶ˆæ¯ ID MessageClientIDSetter.setUniqID(msg)ï¼šmsg id ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€éƒ¨åˆ†æ˜¯ ip åœ°å€ã€è¿›ç¨‹å·ã€Classloader çš„ hashcodeï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯æ—¶é—´å·®ï¼ˆå½“å‰æ—¶é—´å‡å»å½“æœˆä¸€å·çš„æ—¶é—´ï¼‰å’Œè®¡æ•°å™¨çš„å€¼ if (this.tryToCompressMessage(msg))ï¼šåˆ¤æ–­æ¶ˆæ¯æ˜¯å¦å‹ç¼©ï¼Œå‹ç¼©éœ€è¦è®¾ç½®å‹ç¼©æ ‡è®° hasCheckForbiddenHookã€hasSendMessageHookï¼šæ‰§è¡Œé’©å­æ–¹æ³• requestHeader = new SendMessageRequestHeader()ï¼šè®¾ç½®å‘é€æ¶ˆæ¯çš„æ¶ˆæ¯å¤´ if (requestHeader.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX))ï¼šé‡æŠ•çš„å‘é€æ¶ˆæ¯ switch (communicationMode)ï¼šå¼‚æ­¥å‘é€ä¸€ç§å¤„ç†æ–¹å¼ï¼Œå•å‘å’ŒåŒæ­¥åŒæ ·çš„å¤„ç†é€»è¾‘ sendResult = this.mQClientFactory.getMQClientAPIImpl().sendMessage()ï¼šå‘é€æ¶ˆæ¯ request = RemotingCommand.createRequestCommand()ï¼šåˆ›å»ºä¸€ä¸ª RequestCommand å¯¹è±¡ request.setBody(msg.getBody())ï¼šå°†æ¶ˆæ¯æ”¾å…¥è¯·æ±‚ä½“ switch (communicationMode)ï¼šæ ¹æ®ä¸åŒçš„æ¨¡å¼ invoke ä¸åŒçš„æ–¹æ³• request()ï¼šè¯·æ±‚æ–¹æ³•ï¼Œæ¶ˆè´¹è€…å›æ‰§æ¶ˆæ¯ï¼Œè¿™ç§æ¶ˆæ¯æ˜¯å¼‚æ­¥æ¶ˆæ¯ requestResponseFuture = new RequestResponseFuture(correlationId, timeout, null)ï¼šåˆ›å»ºè¯·æ±‚å“åº”å¯¹è±¡ getRequestFutureTable().put(correlationId, requestResponseFuture)ï¼šæ”¾å…¥RequestFutureTable æ˜ å°„è¡¨ä¸­ this.sendDefaultImpl(msg, CommunicationMode.ASYNC, new SendCallback())ï¼šå‘é€å¼‚æ­¥æ¶ˆæ¯ï¼Œæœ‰å›è°ƒå‡½æ•° return waitResponse(msg, timeout, requestResponseFuture, cost)ï¼šç”¨æ¥æŒ‚èµ·è¯·æ±‚çš„æ–¹æ³• 12345678910111213 public Message waitResponseMessage(final long timeout) throws InterruptedException &#123; // è¯·æ±‚æŒ‚èµ· this.countDownLatch.await(timeout, TimeUnit.MILLISECONDS); return this.responseMsg; &#125;* å½“æ¶ˆæ¯è¢«æ¶ˆè´¹åï¼Œå®¢æˆ·ç«¯å¤„ç†å“åº”æ—¶é€šè¿‡æ¶ˆæ¯çš„å…³è” IDï¼Œä»æ˜ å°„è¡¨ä¸­è·å–æ¶ˆæ¯çš„ RequestResponseFutureï¼Œæ‰§è¡Œä¸‹é¢çš„æ–¹æ³•å”¤é†’æŒ‚èµ·çº¿ç¨‹ ```java public void putResponseMessage(final Message responseMsg) &#123; this.responseMsg = responseMsg; this.countDownLatch.countDown(); &#125; è·¯ç”±ä¿¡æ¯TopicPublishInfo ç±»ç”¨æ¥å­˜å‚¨è·¯ç”±ä¿¡æ¯ æˆå‘˜å˜é‡ï¼š é¡ºåºæ¶ˆæ¯ï¼š 1private boolean orderTopic = false; æ¶ˆæ¯é˜Ÿåˆ—ï¼š 12private List&lt;MessageQueue&gt; messageQueueList = new ArrayList&lt;&gt;(); // ä¸»é¢˜å…¨éƒ¨çš„æ¶ˆæ¯é˜Ÿåˆ—private volatile ThreadLocalIndex sendWhichQueue = new ThreadLocalIndex(); // æ¶ˆæ¯é˜Ÿåˆ—ç´¢å¼• 123456// ã€æ¶ˆæ¯é˜Ÿåˆ—ç±»ã€‘public class MessageQueue implements Comparable&lt;MessageQueue&gt;, Serializable &#123; private String topic; private String brokerName; private int queueId;// é˜Ÿåˆ— ID&#125; è·¯ç”±æ•°æ®ï¼šä¸»é¢˜å¯¹åº”çš„è·¯ç”±æ•°æ® 1private TopicRouteData topicRouteData; 123456public class TopicRouteData extends RemotingSerializable &#123; private String orderTopicConf; private List&lt;QueueData&gt; queueDatas; // é˜Ÿåˆ—æ•°æ® private List&lt;BrokerData&gt; brokerDatas; // Broker æ•°æ® private HashMap&lt;String/* brokerAddr */, List&lt;String&gt;/* Filter Server */&gt; filterServerTable;&#125; 1234567public class QueueData implements Comparable&lt;QueueData&gt; &#123; private String brokerName; // èŠ‚ç‚¹åç§° private int readQueueNums; // è¯»é˜Ÿåˆ—æ•° private int writeQueueNums; // å†™é˜Ÿåˆ—æ•° private int perm; // æƒé™ private int topicSynFlag;&#125; 12345public class BrokerData implements Comparable&lt;BrokerData&gt; &#123; private String cluster; // é›†ç¾¤å private String brokerName; // BrokerèŠ‚ç‚¹åç§° private HashMap&lt;Long/* brokerId */, String/* broker address */&gt; brokerAddrs;&#125; æ ¸å¿ƒæ–¹æ³•ï¼š selectOneMessageQueue()ï¼šé€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—ä½¿ç”¨ 1234567891011121314151617181920212223// å‚æ•°æ˜¯ä¸Šæ¬¡å¤±è´¥æ—¶çš„ brokerNameï¼Œå¯ä»¥ä¸º nullpublic MessageQueue selectOneMessageQueue(final String lastBrokerName) &#123; if (lastBrokerName == null) &#123; return selectOneMessageQueue(); &#125; else &#123; // éå†æ¶ˆæ¯é˜Ÿåˆ— for (int i = 0; i &lt; this.messageQueueList.size(); i++) &#123; // ã€è·å–é˜Ÿåˆ—çš„ç´¢å¼•ï¼Œ+1ã€‘ int index = this.sendWhichQueue.getAndIncrement(); // è·å–é˜Ÿåˆ—çš„ä¸‹æ ‡ä½ç½® int pos = Math.abs(index) % this.messageQueueList.size(); if (pos &lt; 0) pos = 0; // è·å–æ¶ˆæ¯é˜Ÿåˆ— MessageQueue mq = this.messageQueueList.get(pos); // ä¸ä¸Šæ¬¡é€‰æ‹©çš„ä¸åŒå°±å¯ä»¥è¿”å› if (!mq.getBrokerName().equals(lastBrokerName)) &#123; return mq; &#125; &#125; return selectOneMessageQueue(); &#125;&#125; å…¬å…±é…ç½®å…¬å…±çš„é…ç½®ä¿¡æ¯ç±» ClientConfig ç±» 123456789101112131415161718192021222324252627public class ClientConfig &#123; // Namesrv åœ°å€é…ç½® private String namesrvAddr = NameServerAddressUtils.getNameServerAddresses(); // å®¢æˆ·ç«¯çš„ IP åœ°å€ private String clientIP = RemotingUtil.getLocalAddress(); // å®¢æˆ·ç«¯å®ä¾‹åç§° private String instanceName = System.getProperty(&quot;rocketmq.client.name&quot;, &quot;DEFAULT&quot;); // å®¢æˆ·ç«¯å›è°ƒçº¿ç¨‹æ± çš„æ•°é‡ï¼Œå¹³å°æ ¸å¿ƒæ•°ï¼Œ8æ ¸16çº¿ç¨‹çš„ç”µè„‘è¿”å›16 private int clientCallbackExecutorThreads = Runtime.getRuntime().availableProcessors(); // å‘½åç©ºé—´ protected String namespace; protected AccessChannel accessChannel = AccessChannel.LOCAL; // è·å–è·¯ç”±ä¿¡æ¯çš„é—´éš”æ—¶é—´ 30s private int pollNameServerInterval = 1000 * 30; // å®¢æˆ·ç«¯ä¸ broker ä¹‹é—´çš„å¿ƒè·³å‘¨æœŸ 30s private int heartbeatBrokerInterval = 1000 * 30; // æ¶ˆè´¹è€…æŒä¹…åŒ–æ¶ˆè´¹çš„å‘¨æœŸ 5s private int persistConsumerOffsetInterval = 1000 * 5; private long pullTimeDelayMillsWhenException = 1000; private boolean unitMode = false; private String unitName; // vip é€šé“ï¼Œbroker å¯åŠ¨æ—¶ç»‘å®šä¸¤ä¸ªç«¯å£ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯ vip é€šé“ private boolean vipChannelEnabled = Boolean.parseBoolean(); // è¯­è¨€ï¼Œé»˜è®¤æ˜¯ Java private LanguageCode language = LanguageCode.JAVA;&#125; NettyClientConfig 123456789101112131415161718192021222324public class NettyClientConfig &#123; // å®¢æˆ·ç«¯å·¥ä½œçº¿ç¨‹æ•° private int clientWorkerThreads = 4; // å›è°ƒå¤„ç†çº¿ç¨‹æ±  çº¿ç¨‹æ•°ï¼šå¹³å°æ ¸å¿ƒæ•° private int clientCallbackExecutorThreads = Runtime.getRuntime().availableProcessors(); // å•å‘è¯·æ±‚å¹¶å‘æ•°ï¼Œé»˜è®¤ 65535 private int clientOnewaySemaphoreValue = NettySystemConfig.CLIENT_ONEWAY_SEMAPHORE_VALUE; // å¼‚æ­¥è¯·æ±‚å¹¶å‘æ•°ï¼Œé»˜è®¤ 65535 private int clientAsyncSemaphoreValue = NettySystemConfig.CLIENT_ASYNC_SEMAPHORE_VALUE; // å®¢æˆ·ç«¯è¿æ¥æœåŠ¡å™¨çš„è¶…æ—¶æ—¶é—´é™åˆ¶ 3ç§’ private int connectTimeoutMillis = 3000; // å®¢æˆ·ç«¯æœªæ¿€æ´»å‘¨æœŸï¼Œ60sï¼ˆæŒ‡å®šæ—¶é—´å†… ch æœªæ¿€æ´»ï¼Œéœ€è¦å…³é—­ï¼‰ private long channelNotActiveInterval = 1000 * 60; // å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ ch æœ€å¤§ç©ºé—²æ—¶é—´ 2åˆ†é’Ÿ private int clientChannelMaxIdleTimeSeconds = 120; // åº•å±‚ Socket å†™å’Œæ”¶ ç¼“å†²åŒºçš„å¤§å° 65535 64k private int clientSocketSndBufSize = NettySystemConfig.socketSndbufSize; private int clientSocketRcvBufSize = NettySystemConfig.socketRcvbufSize; // å®¢æˆ·ç«¯ netty æ˜¯å¦å¯åŠ¨å†…å­˜æ±  private boolean clientPooledByteBufAllocatorEnable = false; // å®¢æˆ·ç«¯æ˜¯å¦è¶…æ—¶å…³é—­ Socket è¿æ¥ private boolean clientCloseSocketIfTimeout = false;&#125; å®¢æˆ·ç«¯ç±»æˆå‘˜å±æ€§MQClientInstance æ˜¯ RocketMQ å®¢æˆ·ç«¯å®ä¾‹ï¼Œåœ¨ä¸€ä¸ª JVM è¿›ç¨‹ä¸­åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯å®ä¾‹ï¼Œæ—¢æœåŠ¡äºç”Ÿäº§è€…ï¼Œä¹ŸæœåŠ¡äºæ¶ˆè´¹è€… æˆå‘˜å˜é‡ï¼š é…ç½®ä¿¡æ¯ï¼š 1234private final int instanceIndex; // ç´¢å¼•ä¸€èˆ¬æ˜¯ 0ï¼Œå› ä¸ºå®¢æˆ·ç«¯å®ä¾‹ä¸€èˆ¬éƒ½æ˜¯ä¸€ä¸ªè¿›ç¨‹åªæœ‰ä¸€ä¸ªprivate final String clientId; // å®¢æˆ·ç«¯ ID ip@pidprivate final long bootTimestamp; // å®¢æˆ·ç«¯çš„å¯åŠ¨æ—¶é—´private ServiceState serviceState; // å®¢æˆ·ç«¯çŠ¶æ€ ç”Ÿäº§è€…æ¶ˆè´¹è€…çš„æ˜ å°„è¡¨ï¼škey æ˜¯ç»„å 123private final ConcurrentMap&lt;String, MQProducerInner&gt; producerTableprivate final ConcurrentMap&lt;String, MQConsumerInner&gt; consumerTableprivate final ConcurrentMap&lt;String, MQAdminExtInner&gt; adminExtTable ç½‘ç»œå±‚é…ç½®ï¼š 1private final NettyClientConfig nettyClientConfig; æ ¸å¿ƒåŠŸèƒ½çš„å®ç°ï¼šè´Ÿè´£å°† MQ ä¸šåŠ¡å±‚çš„æ•°æ®è½¬æ¢ä¸ºç½‘ç»œå±‚çš„ RemotingCommand å¯¹è±¡ï¼Œä½¿ç”¨å†…éƒ¨æŒæœ‰çš„ NettyRemotingClient å¯¹è±¡çš„ invoke ç³»åˆ—æ–¹æ³•ï¼Œå®Œæˆç½‘ç»œ IOï¼ˆåŒæ­¥ã€å¼‚æ­¥ã€å•å‘ï¼‰ 1private final MQClientAPIImpl mQClientAPIImpl; æœ¬åœ°è·¯ç”±æ•°æ®ï¼škey æ˜¯ä¸»é¢˜åç§°ï¼Œvalue è·¯ç”±ä¿¡æ¯ 1private final ConcurrentMap&lt;String, TopicRouteData&gt; topicRouteTable = new ConcurrentHashMap&lt;&gt;(); é”ä¿¡æ¯ï¼šä¸¤æŠŠé”ï¼Œé”ä¸åŒçš„æ•°æ® 12private final Lock lockNamesrv = new ReentrantLock();private final Lock lockHeartbeat = new ReentrantLock(); è°ƒåº¦çº¿ç¨‹æ± ï¼šå•çº¿ç¨‹ï¼Œæ‰§è¡Œå®šæ—¶ä»»åŠ¡ 1private final ScheduledExecutorService scheduledExecutorService; Broker æ˜ å°„è¡¨ï¼škey æ˜¯ BrokerName 1234// ç‰©ç†èŠ‚ç‚¹æ˜ å°„è¡¨ï¼Œvalueï¼šLong æ˜¯ brokerIDï¼Œã€ID=0 çš„æ˜¯ä¸»èŠ‚ç‚¹ï¼Œå…¶ä»–æ˜¯ä»èŠ‚ç‚¹ã€‘ï¼ŒString æ˜¯åœ°å€ ip:portprivate final ConcurrentMap&lt;String, HashMap&lt;Long, String&gt;&gt; brokerAddrTable;// ç‰©ç†èŠ‚ç‚¹ç‰ˆæœ¬æ˜ å°„è¡¨ï¼ŒString æ˜¯åœ°å€ ip:portï¼ŒInteger æ˜¯ç‰ˆæœ¬ConcurrentMap&lt;String, HashMap&lt;String, Integer&gt;&gt; brokerVersionTable; å®¢æˆ·ç«¯çš„åè®®å¤„ç†å™¨ï¼šç”¨äºå¤„ç† IO äº‹ä»¶ 1private final ClientRemotingProcessor clientRemotingProcessor; æ¶ˆæ¯æœåŠ¡ï¼š 123private final PullMessageService pullMessageService; // æ‹‰æ¶ˆæ¯æœåŠ¡private final RebalanceService rebalanceService; // æ¶ˆè´¹è€…è´Ÿè½½å‡è¡¡æœåŠ¡private final ConsumerStatsManager consumerStatsManager; // æ¶ˆè´¹è€…çŠ¶æ€ç®¡ç† å†…éƒ¨ç”Ÿäº§è€…å®ä¾‹ï¼šå¤„ç†æ¶ˆè´¹ç«¯æ¶ˆæ¯å›é€€ï¼Œç”¨è¯¥ç”Ÿäº§è€…å‘é€å›é€€æ¶ˆæ¯ 1private final DefaultMQProducer defaultMQProducer; å¿ƒè·³æ¬¡æ•°ç»Ÿè®¡ï¼š 1private final AtomicLong sendHeartbeatTimesTotal = new AtomicLong(0) æ„é€ æ–¹æ³•ï¼š MQClientInstance æœ‰å‚æ„é€ ï¼š 123456789101112131415161718192021public MQClientInstance(ClientConfig clientConfig, int instanceIndex, String clientId, RPCHook rpcHook) &#123; this.clientConfig = clientConfig; this.instanceIndex = instanceIndex; // Netty ç›¸å…³çš„é…ç½®ä¿¡æ¯ this.nettyClientConfig = new NettyClientConfig(); // å¹³å°æ ¸å¿ƒæ•° this.nettyClientConfig.setClientCallbackExecutorThreads(...); this.nettyClientConfig.setUseTLS(clientConfig.isUseTLS()); // ã€åˆ›å»ºå®¢æˆ·ç«¯åè®®å¤„ç†å™¨ã€‘ this.clientRemotingProcessor = new ClientRemotingProcessor(this); // åˆ›å»º API å®ç°å¯¹è±¡ // å‚æ•°ä¸€ï¼šå®¢æˆ·ç«¯ç½‘ç»œé…ç½® // å‚æ•°äºŒï¼šå®¢æˆ·ç«¯åè®®å¤„ç†å™¨ï¼Œæ³¨å†Œåˆ°å®¢æˆ·ç«¯ç½‘ç»œå±‚ // å‚æ•°ä¸‰ï¼šrpcHookï¼Œæ³¨å†Œåˆ°å®¢æˆ·ç«¯ç½‘ç»œå±‚ // å‚æ•°å››ï¼šå®¢æˆ·ç«¯é…ç½® this.mQClientAPIImpl = new MQClientAPIImpl(this.nettyClientConfig, this.clientRemotingProcessor, rpcHook, clientConfig); //... // å†…éƒ¨ç”Ÿäº§è€…ï¼ŒæŒ‡å®šå†…éƒ¨ç”Ÿäº§è€…çš„ç»„ this.defaultMQProducer = new DefaultMQProducer(MixAll.CLIENT_INNER_PRODUCER_GROUP);&#125; MQClientAPIImpl æœ‰å‚æ„é€ ï¼š 12345678910111213public MQClientAPIImpl(nettyClientConfig, clientRemotingProcessor, rpcHook, clientConfig) &#123; this.clientConfig = clientConfig; topAddressing = new TopAddressing(MixAll.getWSAddr(), clientConfig.getUnitName()); // åˆ›å»ºç½‘ç»œå±‚å¯¹è±¡ï¼Œå‚æ•°äºŒä¸º null è¯´æ˜å®¢æˆ·ç«¯å¹¶ä¸å…³å¿ƒ channel event this.remotingClient = new NettyRemotingClient(nettyClientConfig, null); // ä¸šåŠ¡å¤„ç†å™¨ this.clientRemotingProcessor = clientRemotingProcessor; // æ³¨å†Œ RpcHook this.remotingClient.registerRPCHook(rpcHook); // ... // æ³¨å†Œå›é€€æ¶ˆæ¯çš„è¯·æ±‚ç  this.remotingClient.registerProcessor(RequestCode.PUSH_REPLY_MESSAGE_TO_CLIENT, this.clientRemotingProcessor, null);&#125; æˆå‘˜æ–¹æ³• start()ï¼šå¯åŠ¨æ–¹æ³• synchronized (this)ï¼šåŠ é”ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä¿è¯åªæœ‰ä¸€ä¸ªå®ä¾‹å¯¹è±¡å¯åŠ¨ this.mQClientAPIImpl.start()ï¼šå¯åŠ¨å®¢æˆ·ç«¯ç½‘ç»œå±‚ï¼Œåº•å±‚è°ƒç”¨ RemotingClient ç±» this.startScheduledTask()ï¼šå¯åŠ¨å®šæ—¶ä»»åŠ¡ this.pullMessageService.start()ï¼šå¯åŠ¨æ‹‰å–æ¶ˆæ¯æœåŠ¡ this.rebalanceService.start()ï¼šå¯åŠ¨è´Ÿè½½å‡è¡¡æœåŠ¡ this.defaultMQProducer...start(false)ï¼šå¯åŠ¨å†…éƒ¨ç”Ÿäº§è€…ï¼Œå‚æ•°ä¸º false ä»£è¡¨ä¸å¯åŠ¨å®ä¾‹ startScheduledTask()ï¼šå¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼Œè°ƒåº¦çº¿ç¨‹æ± æ˜¯å•çº¿ç¨‹ if (null == this.clientConfig.getNamesrvAddr())ï¼šNamesrv åœ°å€æ˜¯ç©ºï¼Œéœ€è¦ä¸¤åˆ†é’Ÿæ‹‰å–ä¸€æ¬¡ Namesrv åœ°å€ å®šæ—¶ä»»åŠ¡ 1ï¼šä» Namesrv æ›´æ–°å®¢æˆ·ç«¯æœ¬åœ°çš„è·¯ç”±æ•°æ®ï¼Œå‘¨æœŸ 30 ç§’ä¸€æ¬¡ 12// è·å–ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…è®¢é˜…çš„ä¸»é¢˜é›†åˆï¼Œéå†é›†åˆï¼Œå¯¹æ¯”ä» namesrv æ‹‰å–æœ€æ–°çš„ä¸»é¢˜è·¯ç”±æ•°æ®å’Œæœ¬åœ°æ•°æ®ï¼Œæ˜¯å¦éœ€è¦æ›´æ–°MQClientInstance.this.updateTopicRouteInfoFromNameServer(); å®šæ—¶ä»»åŠ¡ 2ï¼šå‘¨æœŸ 30 ç§’ä¸€æ¬¡ï¼Œä¸¤ä¸ªä»»åŠ¡ æ¸…ç†ä¸‹çº¿çš„ Broker èŠ‚ç‚¹ï¼Œéå†å®¢æˆ·ç«¯çš„ Broker ç‰©ç†èŠ‚ç‚¹æ˜ å°„è¡¨ï¼Œå°†æ‰€æœ‰ä¸»é¢˜æ•°æ®éƒ½ä¸åŒ…å«çš„ Broker ç‰©ç†èŠ‚ç‚¹æ¸…ç†æ‰ï¼Œå¦‚æœè¢«æ¸…ç†çš„ Broker ä¸‹æ‰€æœ‰çš„ç‰©ç†èŠ‚ç‚¹éƒ½æ²¡æœ‰äº†ï¼Œå°±å°†è¯¥ Broker çš„æ˜ å°„æ•°æ®åˆ é™¤æ‰ å‘åœ¨çº¿çš„æ‰€æœ‰çš„ Broker å‘é€å¿ƒè·³æ•°æ®ï¼ŒåŒæ­¥å‘é€çš„æ–¹å¼ï¼Œè¿”å›å€¼æ˜¯ Broker ç‰©ç†èŠ‚ç‚¹çš„ç‰ˆæœ¬å·ï¼Œæ›´æ–°ç‰ˆæœ¬æ˜ å°„è¡¨ 12MQClientInstance.this.cleanOfflineBroker();MQClientInstance.this.sendHeartbeatToAllBrokerWithLock(); 123456789// å¿ƒè·³æ•°æ®public class HeartbeatData extends RemotingSerializable &#123; // å®¢æˆ·ç«¯ ID ip@pid private String clientID; // å­˜å‚¨å®¢æˆ·ç«¯æ‰€æœ‰ç”Ÿäº§è€…æ•°æ® private Set&lt;ProducerData&gt; producerDataSet = new HashSet&lt;ProducerData&gt;(); // å­˜å‚¨å®¢æˆ·ç«¯æ‰€æœ‰æ¶ˆè´¹è€…æ•°æ® private Set&lt;ConsumerData&gt; consumerDataSet = new HashSet&lt;ConsumerData&gt;();&#125; å®šæ—¶ä»»åŠ¡ 3ï¼šæ¶ˆè´¹è€…æŒä¹…åŒ–æ¶ˆè´¹æ•°æ®ï¼Œå‘¨æœŸ 5 ç§’ä¸€æ¬¡ 1MQClientInstance.this.persistAllConsumerOffset(); å®šæ—¶ä»»åŠ¡ 4ï¼šåŠ¨æ€è°ƒæ•´æ¶ˆè´¹è€…çº¿ç¨‹æ± ï¼Œå‘¨æœŸ 1 åˆ†é’Ÿä¸€æ¬¡ 1MQClientInstance.this.adjustThreadPool(); updateTopicRouteInfoFromNameServer()ï¼šæ›´æ–°è·¯ç”±æ•°æ®ï¼Œé€šè¿‡åŠ é”ä¿è¯å½“å‰å®ä¾‹åªæœ‰ä¸€ä¸ªçº¿ç¨‹å»æ›´æ–° if (isDefault &amp;&amp; defaultMQProducer != null)ï¼šéœ€è¦é»˜è®¤æ•°æ® topicRouteData = ...getDefaultTopicRouteInfoFromNameServer()ï¼šä» Namesrv è·å–é»˜è®¤çš„ TBW102 çš„è·¯ç”±æ•°æ® topicRouteData = ...getTopicRouteInfoFromNameServer(topic)ï¼šéœ€è¦ä» Namesrv è·å–è·¯ç”±æ•°æ®ï¼ˆåŒæ­¥ï¼‰ old = this.topicRouteTable.get(topic)ï¼šè·å–å®¢æˆ·ç«¯å®ä¾‹æœ¬åœ°çš„è¯¥ä¸»é¢˜çš„è·¯ç”±æ•°æ® boolean changed = topicRouteDataIsChange(old, topicRouteData)ï¼šå¯¹æ¯”æœ¬åœ°å’Œæœ€æ–°ä¸‹æ‹‰çš„æ•°æ®æ˜¯å¦ä¸€è‡´ if (changed)ï¼šä¸ä¸€è‡´è¿›å…¥æ›´æ–°é€»è¾‘ this.brokerAddrTable.put(...)ï¼šæ›´æ–°å®¢æˆ·ç«¯ broker ç‰©ç†èŠ‚ç‚¹æ˜ å°„è¡¨ Update Pub infoï¼šæ›´æ–°ç”Ÿäº§è€…ä¿¡æ¯ publishInfo = topicRouteData2TopicPublishInfo(topic, topicRouteData)ï¼šå°†ä¸»é¢˜è·¯ç”±æ•°æ®è½¬åŒ–ä¸ºå‘å¸ƒæ•°æ®ï¼Œä¼šåˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ— MQï¼Œæ”¾å…¥å‘å¸ƒæ•°æ®å¯¹è±¡çš„é›†åˆä¸­ impl.updateTopicPublishInfo(topic, publishInfo)ï¼šç”Ÿäº§è€…å°†ä¸»é¢˜çš„å‘å¸ƒæ•°æ®ä¿å­˜åˆ°å®ƒæœ¬åœ°ï¼Œæ–¹ä¾¿å‘é€æ¶ˆæ¯ä½¿ç”¨ Update sub infoï¼šæ›´æ–°æ¶ˆè´¹è€…ä¿¡æ¯ï¼Œåˆ›å»º MQ é˜Ÿåˆ—ï¼Œæ›´æ–°è®¢é˜…ä¿¡æ¯ï¼Œç”¨äºè´Ÿè½½å‡è¡¡ this.topicRouteTable.put(topic, cloneTopicRouteData)ï¼šå°†æ•°æ®æ”¾å…¥æœ¬åœ°è·¯ç”±è¡¨ ç½‘ç»œé€šä¿¡æˆå‘˜å±æ€§NettyRemotingClient ç±»è´Ÿè´£å®¢æˆ·ç«¯çš„ç½‘ç»œé€šä¿¡ æˆå‘˜å˜é‡ï¼š Netty æœåŠ¡ç›¸å…³å±æ€§ï¼š 123private final NettyClientConfig nettyClientConfig; // å®¢æˆ·ç«¯çš„ç½‘ç»œå±‚é…ç½®private final Bootstrap bootstrap = new Bootstrap(); // å®¢æˆ·ç«¯ç½‘ç»œå±‚å¯åŠ¨å¯¹è±¡private final EventLoopGroup eventLoopGroupWorker; // å®¢æˆ·ç«¯ç½‘ç»œå±‚ Netty IO çº¿ç¨‹ç»„ Channel æ˜ å°„è¡¨ï¼š 12private final ConcurrentMap&lt;String, ChannelWrapper&gt; channelTables;// key æ˜¯æœåŠ¡å™¨çš„åœ°å€ï¼Œvalue æ˜¯é€šé“å¯¹è±¡private final Lock lockChannelTables = new ReentrantLock(); // é”ï¼Œæ§åˆ¶å¹¶å‘å®‰å…¨ å®šæ—¶å™¨ï¼šå¯åŠ¨å®šæ—¶ä»»åŠ¡ 1private final Timer timer = new Timer(&quot;ClientHouseKeepingService&quot;, true) çº¿ç¨‹æ± ï¼š 12private ExecutorService publicExecutor; // å…¬å…±çº¿ç¨‹æ± private ExecutorService callbackExecutor; // å›è°ƒçº¿ç¨‹æ± ï¼Œå®¢æˆ·ç«¯å‘èµ·å¼‚æ­¥è¯·æ±‚ï¼ŒæœåŠ¡å™¨çš„å“åº”æ•°æ®ç”±å›è°ƒçº¿ç¨‹æ± å¤„ç† äº‹ä»¶ç›‘å¬å™¨ï¼šå®¢æˆ·ç«¯è¿™é‡Œæ˜¯ null 1private final ChannelEventListener channelEventListener; æ„é€ æ–¹æ³• æ— å‚æ„é€ ï¼š 123public NettyRemotingClient(final NettyClientConfig nettyClientConfig) &#123; this(nettyClientConfig, null);&#125; æœ‰å‚æ„é€ ï¼š 1234567891011121314151617181920public NettyRemotingClient(nettyClientConfig, channelEventListener) &#123; // çˆ¶ç±»åˆ›å»ºäº†2ä¸ªä¿¡å·é‡ï¼Œ1ã€æ§åˆ¶å•å‘è¯·æ±‚çš„å¹¶å‘åº¦ï¼Œ2ã€æ§åˆ¶å¼‚æ­¥è¯·æ±‚çš„å¹¶å‘åº¦ super(nettyClientConfig.getClientOnewaySemaphoreValue(), nettyClientConfig.getClientAsyncSemaphoreValue()); this.nettyClientConfig = nettyClientConfig; this.channelEventListener = channelEventListener; // åˆ›å»ºå…¬å…±çº¿ç¨‹æ±  int publicThreadNums = nettyClientConfig.getClientCallbackExecutorThreads(); if (publicThreadNums &lt;= 0) &#123; publicThreadNums = 4; &#125; this.publicExecutor = Executors.newFixedThreadPool(publicThreadNums,); // åˆ›å»º Netty IO çº¿ç¨‹ï¼Œ1ä¸ªçº¿ç¨‹ this.eventLoopGroupWorker = new NioEventLoopGroup(1, ); if (nettyClientConfig.isUseTLS()) &#123; sslContext = TlsHelper.buildSslContext(true); &#125;&#125; æˆå‘˜æ–¹æ³• start()ï¼šå¯åŠ¨æ–¹æ³• 1234567891011121314151617181920212223242526public void start() &#123; // channel pipeline å†…çš„ handler ä½¿ç”¨çš„çº¿ç¨‹èµ„æºï¼Œé»˜è®¤ 4 ä¸ª this.defaultEventExecutorGroup = new DefaultEventExecutorGroup(); // é…ç½® netty å®¢æˆ·ç«¯å¯åŠ¨ç±»å¯¹è±¡ Bootstrap handler = this.bootstrap.group(this.eventLoopGroupWorker).channel(NioSocketChannel.class) //... .handler(new ChannelInitializer&lt;SocketChannel&gt;() &#123; @Override public void initChannel(SocketChannel ch) throws Exception &#123; ChannelPipeline pipeline = ch.pipeline(); // åŠ å‡ ä¸ªhandler pipeline.addLast( // æœåŠ¡ç«¯çš„æ•°æ®ï¼Œéƒ½ä¼šæ¥åˆ°è¿™ä¸ª new NettyClientHandler()); &#125; &#125;); // æ³¨æ„ Bootstrap åªæ˜¯é…ç½®å¥½å®¢æˆ·ç«¯çš„å…ƒæ•°æ®äº†ï¼Œã€åœ¨è¿™é‡Œå¹¶æ²¡æœ‰åˆ›å»ºä»»ä½• channel å¯¹è±¡ã€‘ // å®šæ—¶ä»»åŠ¡ æ‰«æ responseTable ä¸­è¶…æ—¶çš„ ResponseFutureï¼Œé¿å…å®¢æˆ·ç«¯çº¿ç¨‹é•¿æ—¶é—´é˜»å¡ this.timer.scheduleAtFixedRate(() -&gt; &#123; NettyRemotingClient.this.scanResponseTable(); &#125;, 1000 * 3, 1000); // è¿™é‡Œæ˜¯ nullï¼Œä¸å¯åŠ¨ if (this.channelEventListener != null) &#123; this.nettyEventExecutor.start(); &#125;&#125; å•å‘é€šä¿¡ï¼š 1234567891011121314151617181920212223242526272829public RemotingCommand invokeSync(String addr, final RemotingCommand request, long timeoutMillis) &#123; // å¼€å§‹æ—¶é—´ long beginStartTime = System.currentTimeMillis(); // è·å–æˆ–è€…åˆ›å»ºå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ï¼ˆaddrï¼‰çš„é€šé“ channel final Channel channel = this.getAndCreateChannel(addr); // æ¡ä»¶æˆç«‹è¯´æ˜å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ channel é€šé“æ­£å¸¸ï¼Œå¯ä»¥é€šä¿¡ if (channel != null &amp;&amp; channel.isActive()) &#123; try &#123; // æ‰§è¡Œ rpcHook æ‹“å±•ç‚¹ doBeforeRpcHooks(addr, request); // è®¡ç®—è€—æ—¶ï¼Œå¦‚æœå½“å‰è€—æ—¶å·²ç»è¶…è¿‡ timeoutMillis é™åˆ¶ï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œä¸å†è¿›è¡Œç³»ç»Ÿé€šä¿¡ long costTime = System.currentTimeMillis() - beginStartTime; if (timeoutMillis &lt; costTime) &#123; throw new RemotingTimeoutException(&quot;invokeSync call timeout&quot;); &#125; // å‚æ•°1ï¼šå®¢æˆ·ç«¯-æœåŠ¡ç«¯é€šé“channel // å‚æ•°äºŒï¼šç½‘ç»œå±‚ä¼ è¾“å¯¹è±¡ï¼Œå°è£…ç€è¯·æ±‚æ•°æ® // å‚æ•°ä¸‰ï¼šå‰©ä½™çš„è¶…æ—¶é™åˆ¶ RemotingCommand response = this.invokeSyncImpl(channel, request, ...); // åç½®å¤„ç† doAfterRpcHooks(RemotingHelper.parseChannelRemoteAddr(channel), request, response); // è¿”å›å“åº”æ•°æ® return response; &#125; catch (RemotingSendRequestException e) &#123;&#125; &#125; else &#123; this.closeChannel(addr, channel); throw new RemotingConnectException(addr); &#125;&#125; å»¶è¿Ÿæ¶ˆæ¯æ¶ˆæ¯å¤„ç†BrokerStartup åˆå§‹åŒ– BrokerController è°ƒç”¨ registerProcessor() æ–¹æ³•å°† SendMessageProcessor æ³¨å†Œåˆ° NettyRemotingServer ä¸­ï¼Œå¯¹åº”çš„è¯·æ±‚ ID ä¸º SEND_MESSAGE = 10ï¼ŒNettyServerHandler åœ¨å¤„ç†è¯·æ±‚æ—¶é€šè¿‡ CMD ä¼šè·å–å¤„ç†å™¨æ‰§è¡Œ processRequest 123456// å‚æ•°ä¸€ï¼šå¤„ç†é€šé“çš„äº‹ä»¶ï¼› å‚æ•°äºŒï¼šå®¢æˆ·ç«¯public RemotingCommand processRequest(ChannelHandlerContext ctx, RemotingCommand request) &#123; RemotingCommand response = null; response = asyncProcessRequest(ctx, request).get(); return response;&#125; SendMessageProcessor#asyncConsumerSendMsgBackï¼šå¼‚æ­¥å‘é€æ¶ˆè´¹è€…çš„å›è°ƒæ¶ˆæ¯ final RemotingCommand responseï¼šåˆ›å»ºä¸€ä¸ªæœåŠ¡å™¨å“åº”å¯¹è±¡ final ConsumerSendMsgBackRequestHeader requestHeaderï¼šè§£æå‡ºå®¢æˆ·ç«¯è¯·æ±‚å¤´ä¿¡æ¯ï¼Œå‡ ä¸ªæ ¸å¿ƒå­—æ®µï¼š private Long offsetï¼šå›é€€æ¶ˆæ¯çš„ CommitLog offset private Integer delayLevelï¼šå»¶è¿Ÿçº§åˆ«ï¼Œä¸€èˆ¬æ˜¯ 0 private String originMsgId, originTopicï¼šåŸå§‹çš„æ¶ˆæ¯ IDï¼Œä¸»é¢˜ private Integer maxReconsumeTimesï¼šæœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤æ˜¯ 16 æ¬¡ if ()ï¼šé‰´æƒï¼Œæ˜¯å¦æ‰¾åˆ°è®¢é˜…ç»„é…ç½®ã€Broker æ˜¯å¦æ”¯æŒå†™è¯·æ±‚ã€è®¢é˜…ç»„æ˜¯å¦æ”¯æŒæ¶ˆæ¯é‡è¯• String newTopic = MixAll.getRetryTopic(...)ï¼šè·å–æ¶ˆè´¹è€…ç»„çš„é‡è¯•ä¸»é¢˜ï¼Œè§„åˆ™æ˜¯ %RETRY%GroupName int queueIdInt = Math.abs()ï¼šé‡è¯•ä¸»é¢˜ä¸‹çš„é˜Ÿåˆ— ID æ˜¯ 0 TopicConfig topicConfigï¼šè·å–é‡è¯•ä¸»é¢˜çš„é…ç½®ä¿¡æ¯ MessageExt msgExtï¼šæ ¹æ®æ¶ˆæ¯çš„ç‰©ç† offset åˆ°å­˜å‚¨æ¨¡å—æŸ¥è¯¢ï¼Œå†…éƒ¨å…ˆæŸ¥è¯¢å‡ºè¿™æ¡æ¶ˆæ¯çš„ sizeï¼Œç„¶åå†æ ¹æ® offset å’Œ size æŸ¥è¯¢å‡ºæ•´æ¡ msg final String retryTopicï¼šè·å–æ¶ˆæ¯çš„åŸå§‹ä¸»é¢˜ if (null == retryTopic)ï¼šæ¡ä»¶æˆç«‹è¯´æ˜å½“å‰æ¶ˆæ¯æ˜¯ç¬¬ä¸€æ¬¡è¢«å›é€€ï¼Œ æ·»åŠ  RETRY_TOPIC å±æ€§ msgExt.setWaitStoreMsgOK(false)ï¼šå¼‚æ­¥åˆ·ç›˜ if (msgExt...() &gt;= maxReconsumeTimes || delayLevel &lt; 0)ï¼šæ¶ˆæ¯é‡è¯•æ¬¡æ•°è¶…è¿‡æœ€å¤§æ¬¡æ•°ï¼Œä¸æ”¯æŒé‡è¯• newTopic = MixAll.getDLQTopic()ï¼šè·å–æ¶ˆè´¹è€…çš„æ­»ä¿¡é˜Ÿåˆ—ï¼Œè§„åˆ™æ˜¯ %DLQ%GroupName queueIdInt, topicConfigï¼šæ­»ä¿¡é˜Ÿåˆ— ID ä¸º 0ï¼Œåˆ›å»ºæ­»ä¿¡é˜Ÿåˆ—çš„é…ç½® if (0 == delayLevel)ï¼šè¯´æ˜å»¶è¿Ÿçº§åˆ«ç”± Broker æ§åˆ¶ delayLevel = 3 + msgExt.getReconsumeTimes()ï¼šå»¶è¿Ÿçº§åˆ«é»˜è®¤ä» 3 çº§å¼€å§‹ï¼Œæ¯é‡è¯•ä¸€æ¬¡ï¼Œå»¶è¿Ÿçº§åˆ« +1 msgExt.setDelayTimeLevel(delayLevel)ï¼šå°†å»¶è¿Ÿçº§åˆ«è®¾ç½®è¿›æ¶ˆæ¯å±æ€§ï¼Œå­˜å‚¨æ—¶ä¼šæ£€æŸ¥è¯¥å±æ€§ï¼Œè¯¥å±æ€§å€¼ &gt; 0 ä¼šå°†æ¶ˆæ¯çš„ä¸»é¢˜å’Œé˜Ÿåˆ—ä¿®æ”¹ä¸ºè°ƒåº¦ä¸»é¢˜å’Œè°ƒåº¦é˜Ÿåˆ— ID MessageExtBrokerInner msgInnerï¼šåˆ›å»ºä¸€æ¡ç©ºæ¶ˆæ¯ï¼Œæ¶ˆæ¯å±æ€§ä» offset æŸ¥è¯¢å‡ºæ¥çš„ msg ä¸­æ‹·è´ msgInner.setReconsumeTimes)ï¼šé‡è¯•æ¬¡æ•°è®¾ç½®ä¸ºåŸ msg çš„æ¬¡æ•° +1 UtilAll.isBlank(originMsgId)ï¼šåˆ¤æ–­æ¶ˆæ¯æ˜¯å¦æ˜¯åˆæ¬¡è¿”å›åˆ°æœåŠ¡å™¨ trueï¼šè¯´æ˜ msgExt æ¶ˆæ¯æ˜¯ç¬¬ä¸€æ¬¡è¢«è¿”å›åˆ°æœåŠ¡å™¨ï¼Œæ­¤æ—¶ä½¿ç”¨è¯¥ msg çš„ id ä½œä¸º originMessageId falseï¼šè¯´æ˜åŸå§‹æ¶ˆæ¯å·²ç»è¢«é‡è¯•ä¸æ­¢ 1 æ¬¡ï¼Œæ­¤æ—¶ä½¿ç”¨ offset æŸ¥è¯¢å‡ºæ¥çš„ msg ä¸­çš„ originMessageId CompletableFuture putMessageResult = ..asyncPutMessage(msgInner)ï¼šè°ƒç”¨å­˜å‚¨æ¨¡å—å­˜å‚¨æ¶ˆæ¯ DefaultMessageStore#asyncPutMessageï¼š PutMessageResult result = this.commitLog.asyncPutMessage(msg)ï¼šå°†æ–°æ¶ˆæ¯å­˜å‚¨åˆ° CommitLog ä¸­ è°ƒåº¦æœåŠ¡DefaultMessageStore ä¸­æœ‰æˆå‘˜å±æ€§ ScheduleMessageServiceï¼Œåœ¨ start æ–¹æ³•ä¸­ä¼šå¯åŠ¨è¯¥è°ƒåº¦æœåŠ¡ æˆå‘˜å˜é‡ï¼š å»¶è¿Ÿçº§åˆ«å±æ€§è¡¨ï¼š 1234// å­˜å‚¨å»¶è¿Ÿçº§åˆ«å¯¹åº”çš„ å»¶è¿Ÿæ—¶é—´é•¿åº¦ ï¼ˆå•ä½ï¼šæ¯«ç§’ï¼‰private final ConcurrentMap&lt;Integer /* level */, Long/* delay timeMillis */&gt; delayLevelTable;// å­˜å‚¨å»¶è¿Ÿçº§åˆ« queue çš„æ¶ˆè´¹è¿›åº¦ offsetï¼Œè¯¥ table æ¯ 10 ç§’é’Ÿï¼Œä¼šæŒä¹…åŒ–ä¸€æ¬¡ï¼ŒæŒä¹…åŒ–åˆ°æœ¬åœ°ç£ç›˜private final ConcurrentMap&lt;Integer /* level */, Long/* offset */&gt; offsetTable; æœ€å¤§å»¶è¿Ÿçº§åˆ«ï¼š 1private int maxDelayLevel; æ¨¡å—å¯åŠ¨çŠ¶æ€ï¼š 1private final AtomicBoolean started = new AtomicBoolean(false); å®šæ—¶å™¨ï¼šå†…éƒ¨æœ‰çº¿ç¨‹èµ„æºï¼Œå¯æ‰§è¡Œè°ƒåº¦ä»»åŠ¡ 1private Timer timer; æˆå‘˜æ–¹æ³•ï¼š load()ï¼šåŠ è½½è°ƒåº¦æ¶ˆæ¯ï¼Œåˆå§‹åŒ– delayLevelTable å’Œ offsetTable 1public boolean load() start()ï¼šå¯åŠ¨æ¶ˆæ¯è°ƒåº¦æœåŠ¡ 1public void start() if (started.compareAndSet(false, true))ï¼šå°†å¯åŠ¨çŠ¶æ€è®¾ä¸º true this.timerï¼šåˆ›å»ºå®šæ—¶å™¨å¯¹è±¡ for (... : this.delayLevelTable.entrySet())ï¼šä¸ºæ¯ä¸ªå»¶è¿Ÿçº§åˆ«åˆ›å»ºä¸€ä¸ªå»¶è¿Ÿä»»åŠ¡æäº¤åˆ° timer ï¼Œå‘¨æœŸæ‰§è¡Œï¼Œè¿™æ ·å°±å¯ä»¥å°†å»¶è¿Ÿæ¶ˆæ¯å¾—åˆ°åŠæ—¶çš„æ¶ˆè´¹ this.timer.scheduleAtFixedRate()ï¼šæäº¤å‘¨æœŸå‹ä»»åŠ¡ï¼Œå»¶è¿Ÿ 10 ç§’æ‰§è¡Œï¼Œå‘¨æœŸä¸º 10 ç§’ï¼ŒæŒä¹…åŒ–å»¶è¿Ÿé˜Ÿåˆ—æ¶ˆè´¹è¿›åº¦ä»»åŠ¡ ScheduleMessageService.this.persist()ï¼šæŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦ è°ƒåº¦ä»»åŠ¡DeliverDelayedMessageTimerTask æ˜¯ä¸€ä¸ªä»»åŠ¡ç±» æˆå‘˜å˜é‡ï¼š å»¶è¿Ÿçº§åˆ«ï¼šå»¶è¿Ÿé˜Ÿåˆ—ä»»åŠ¡å¤„ç†çš„å»¶è¿Ÿçº§åˆ« 1private final int delayLevel; æ¶ˆè´¹è¿›åº¦ï¼šå»¶è¿Ÿé˜Ÿåˆ—ä»»åŠ¡å¤„ç†çš„å»¶è¿Ÿé˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ 1private final long offset; æˆå‘˜æ–¹æ³•ï¼š run()ï¼šæ‰§è¡Œä»»åŠ¡ 1234public void run() &#123; if (isStarted()) &#123; this.executeOnTimeup();&#125; executeOnTimeup()ï¼šæ‰§è¡Œä»»åŠ¡ 1public void executeOnTimeup() ConsumeQueue cqï¼šè·å–å‡ºè¯¥å»¶è¿Ÿé˜Ÿåˆ—ä»»åŠ¡å¤„ç†çš„å»¶è¿Ÿé˜Ÿåˆ— ConsumeQueue SelectMappedBufferResult bufferCQï¼šæ ¹æ®æ¶ˆè´¹è¿›åº¦æŸ¥è¯¢å‡º SMBR å¯¹è±¡ for (; i &lt; bufferCQ.getSize(); i += ConsumeQueue.CQ_STORE_UNIT_SIZE)ï¼šæ¯æ¬¡è¯»å– 20 å„å­—èŠ‚çš„æ•°æ® offsetPy, sizePyï¼šå»¶è¿Ÿæ¶ˆæ¯çš„ç‰©ç†åç§»é‡å’Œæ¶ˆæ¯å¤§å° long tagsCodeï¼šå»¶è¿Ÿæ¶ˆæ¯çš„äº¤ä»˜æ—¶é—´ï¼Œåœ¨ ReputMessageService è½¬å‘æ—¶æ ¹æ®æ¶ˆæ¯çš„ DELAY å±æ€§æ˜¯å¦ &gt;0 ï¼Œä¼šåœ¨ tagsCode å­—æ®µå­˜å‚¨äº¤ä»˜æ—¶é—´ long deliver... = this.correctDeliverTimestamp(..)ï¼šæ ¡å‡†äº¤ä»˜æ—¶é—´ï¼Œå»¶è¿Ÿæ—¶é—´è¿‡é•¿ä¼šè°ƒæ•´ä¸ºå½“å‰æ—¶é—´ç«‹åˆ»æ‰§è¡Œ long countdown = deliverTimestamp - nowï¼šè®¡ç®—å·®å€¼ if (countdown &lt;= 0)ï¼šæ¶ˆæ¯å·²ç»åˆ°è¾¾äº¤ä»˜æ—¶é—´äº† MessageExt msgExtï¼šæ ¹æ®ç‰©ç†åç§»é‡å’Œæ¶ˆæ¯å¤§å°è·å–è¿™æ¡æ¶ˆæ¯ MessageExtBrokerInner msgInnerï¼šæ„å»ºä¸€æ¡æ–°æ¶ˆæ¯ï¼Œå°†åŸæ¶ˆæ¯çš„å±æ€§æ‹·è´è¿‡æ¥ long tagsCodeValueï¼šä¸å†æ˜¯äº¤ä»˜æ—¶é—´äº† MessageAccessor.clearProperty(msgInner, DELAY..)ï¼šæ¸…ç†æ–°æ¶ˆæ¯çš„ DELAY å±æ€§ï¼Œé¿å…å­˜å‚¨æ—¶é‡å®šå‘åˆ°å»¶è¿Ÿé˜Ÿåˆ— msgInner.setTopic()ï¼šä¿®æ”¹ä¸»é¢˜ä¸ºåŸå§‹çš„ä¸»é¢˜ %RETRY%GroupName String queueIdStrï¼šä¿®æ”¹é˜Ÿåˆ— ID ä¸ºåŸå§‹çš„ ID PutMessageResult putMessageResultï¼šå°†æ–°æ¶ˆæ¯å­˜å‚¨åˆ° CommitLogï¼Œæ¶ˆè´¹è€…è®¢é˜…çš„æ˜¯ç›®æ ‡ä¸»é¢˜ï¼Œä¼šå†æ¬¡æ¶ˆè´¹è¯¥æ¶ˆæ¯ elseï¼šæ¶ˆæ¯è¿˜æœªåˆ°è¾¾äº¤ä»˜æ—¶é—´ ScheduleMessageService.this.timer.schedule()ï¼šåˆ›å»ºè¯¥å»¶è¿Ÿçº§åˆ«çš„ä»»åŠ¡ï¼Œå»¶è¿Ÿ countDown æ¯«ç§’ä¹‹åå†æ‰§è¡Œ ScheduleMessageService.this.updateOffset()ï¼šæ›´æ–°å»¶è¿Ÿçº§åˆ«é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ PutMessageResult putMessageResult bufferCQ == nullï¼šè¯´æ˜é€šè¿‡æ¶ˆè´¹è¿›åº¦æ²¡æœ‰è·å–åˆ°æ•°æ® if (offset &lt; cqMinOffset)ï¼šå¦‚æœæ¶ˆè´¹è¿›åº¦æ¯”æœ€å°ä½ç‚¹éƒ½å°ï¼Œè¯´æ˜æ˜¯è¿‡æœŸæ•°æ®ï¼Œé‡ç½®ä¸ºæœ€å°ä½ç‚¹ ScheduleMessageService.this.timer.schedule()ï¼šé‡æ–°æäº¤è¯¥å»¶è¿Ÿçº§åˆ«å¯¹åº”çš„å»¶è¿Ÿé˜Ÿåˆ—ä»»åŠ¡ï¼Œå»¶è¿Ÿ 100 æ¯«ç§’åæ‰§è¡Œ äº‹åŠ¡æ¶ˆæ¯ç”Ÿäº§è€…ç±»TransactionMQProducer ç±»å‘é€äº‹åŠ¡æ¶ˆæ¯æ—¶ä½¿ç”¨ æˆå‘˜å˜é‡ï¼š äº‹åŠ¡å›æŸ¥çº¿ç¨‹æ± èµ„æºï¼š 123456 private ExecutorService executorService;* äº‹åŠ¡ç›‘å¬å™¨ï¼š ```java private TransactionListener transactionListener; æ ¸å¿ƒæ–¹æ³•ï¼š start()ï¼šå¯åŠ¨æ–¹æ³• 1public void start() this.defaultMQProducerImpl.initTransactionEnv()ï¼šåˆå§‹åŒ–ç”Ÿäº§è€…å®ä¾‹å’Œå›æŸ¥çº¿ç¨‹æ± èµ„æº super.start()ï¼šå¯åŠ¨ç”Ÿäº§è€…å®ä¾‹ sendMessageInTransaction()ï¼šå‘é€äº‹åŠ¡æ¶ˆæ¯ 12345public TransactionSendResult sendMessageInTransaction(final Message msg, final Object arg) &#123; msg.setTopic(NamespaceUtil.wrapNamespace(this.getNamespace(), msg.getTopic())); // è°ƒç”¨å®ç°ç±»çš„å‘é€æ–¹æ³• return this.defaultMQProducerImpl.sendMessageInTransaction(msg, null, arg);&#125; TransactionListener transactionListener = getCheckListener()ï¼šè·å–ç›‘å¬å™¨ if (null == localTransactionExecuter &amp;&amp; null == transactionListener)ï¼šä¸¤è€…éƒ½ä¸º null æŠ›å‡ºå¼‚å¸¸ MessageAccessor.putProperty(msg, MessageConst.PROPERTY_TRANSACTION_PREPARED, &quot;true&quot;)ï¼šè®¾ç½®äº‹åŠ¡æ ‡å¿— sendResult = this.send(msg)ï¼šå‘é€æ¶ˆæ¯ï¼ŒåŒæ­¥å‘é€ switch (sendResult.getSendStatus())ï¼šåˆ¤æ–­å‘é€æ¶ˆæ¯çš„ç»“æœçŠ¶æ€ case SEND_OKï¼šæ¶ˆæ¯å‘é€æˆåŠŸ msg.setTransactionId(transactionId)ï¼šè®¾ç½®äº‹åŠ¡ ID ä¸ºæ¶ˆæ¯çš„ UNIQ_KEY å±æ€§ localTransactionState = ...executeLocalTransactionBranch(msg, arg)ï¼šæ‰§è¡Œæœ¬åœ°äº‹åŠ¡ case SLAVE_NOT_AVAILABLEï¼šå…¶ä»–æƒ…å†µéƒ½éœ€è¦å›æ»šäº‹åŠ¡ localTransactionState = LocalTransactionState.ROLLBACK_MESSAGEï¼šäº‹åŠ¡çŠ¶æ€è®¾ç½®ä¸ºå›æ»š this.endTransaction(sendResult, ...)ï¼šç»“æŸäº‹åŠ¡ EndTransactionRequestHeader requestHeaderï¼šæ„å»ºäº‹åŠ¡ç»“æŸå¤´å¯¹è±¡ this.mQClientFactory.getMQClientAPIImpl().endTransactionOneway()ï¼šå‘ Broker å‘èµ·äº‹åŠ¡ç»“æŸçš„å•å‘è¯·æ±‚ æ¥å—æ¶ˆæ¯SendMessageProcessor æ˜¯æœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯å‘é€æ¥çš„æ¶ˆæ¯çš„å¤„ç†å™¨ï¼ŒprocessRequest() æ–¹æ³•å¤„ç†è¯·æ±‚ æ ¸å¿ƒæ–¹æ³•ï¼š asyncProcessRequest()ï¼šå¤„ç†è¯·æ±‚ 12345678910111213141516171819202122232425public CompletableFuture&lt;RemotingCommand&gt; asyncProcessRequest(ChannelHandlerContext ctx, RemotingCommand request) &#123; final SendMessageContext mqtraceContext; switch (request.getCode()) &#123; // å›è°ƒæ¶ˆæ¯å›é€€ case RequestCode.CONSUMER_SEND_MSG_BACK: return this.asyncConsumerSendMsgBack(ctx, request); default: // è§£æå‡ºè¯·æ±‚å¤´å¯¹è±¡ SendMessageRequestHeader requestHeader = parseRequestHeader(request); if (requestHeader == null) &#123; return CompletableFuture.completedFuture(null); &#125; // åˆ›å»ºä¸Šä¸‹æ–‡å¯¹è±¡ mqtraceContext = buildMsgContext(ctx, requestHeader); // å‰ç½®å¤„ç†å™¨ this.executeSendMessageHookBefore(ctx, request, mqtraceContext); // åˆ¤æ–­æ˜¯å¦æ˜¯æ‰¹é‡æ¶ˆæ¯ if (requestHeader.isBatch()) &#123; return this.asyncSendBatchMessage(ctx, request, mqtraceContext, requestHeader); &#125; else &#123; return this.asyncSendMessage(ctx, request, mqtraceContext, requestHeader); &#125; &#125;&#125; asyncSendMessage()ï¼šå¼‚æ­¥å¤„ç†å‘é€æ¶ˆæ¯ 1private CompletableFuture&lt;RemotingCommand&gt; asyncSendMessage(ChannelHandlerContext ctx, RemotingCommand request, SendMessageContext mqtraceContext, SendMessageRequestHeader requestHeader) RemotingCommand responseï¼šåˆ›å»ºå“åº”å¯¹è±¡ MessageExtBrokerInner msgInner = new MessageExtBrokerInner()ï¼šåˆ›å»º msgInner å¯¹è±¡ï¼Œå¹¶èµ‹å€¼ç›¸å…³çš„å±æ€§ï¼Œä¸»é¢˜å’Œé˜Ÿåˆ— ID éƒ½æ˜¯è¯·æ±‚å¤´ä¸­çš„ String transFlagï¼šè·å–äº‹åŠ¡å±æ€§ if (transFlag != null &amp;&amp; Boolean.parseBoolean(transFlag))ï¼šåˆ¤æ–­äº‹åŠ¡å±æ€§æ˜¯å¦æ˜¯ trueï¼Œèµ°äº‹åŠ¡æ¶ˆæ¯çš„å­˜å‚¨æµç¨‹ putMessageResult = ...asyncPrepareMessage(msgInner)ï¼šäº‹åŠ¡æ¶ˆæ¯å¤„ç†æµç¨‹ 1234public CompletableFuture&lt;PutMessageResult&gt; asyncPutHalfMessage(MessageExtBrokerInner messageInner) &#123; // è°ƒç”¨å­˜å‚¨æ¨¡å—ï¼Œå°†ä¿®æ”¹åçš„ msg å­˜å‚¨è¿› Broker(CommitLog) return store.asyncPutMessage(parseHalfMessageInner(messageInner));&#125; TransactionalMessageBridge#parseHalfMessageInnerï¼š MessageAccessor.putProperty(...)ï¼šå°†æ¶ˆæ¯çš„åŸä¸»é¢˜å’Œé˜Ÿåˆ— ID æ”¾å…¥æ¶ˆæ¯çš„å±æ€§ä¸­ msgInner.setSysFlag(...)ï¼šæ¶ˆæ¯è®¾ç½®ä¸ºéäº‹åŠ¡çŠ¶æ€ msgInner.setTopic(TransactionalMessageUtil.buildHalfTopic())ï¼šæ¶ˆæ¯ä¸»é¢˜è®¾ç½®ä¸ºåŠæ¶ˆæ¯ä¸»é¢˜ msgInner.setQueueId(0)ï¼šé˜Ÿåˆ— ID è®¾ç½®ä¸º 0 elseï¼šæ™®é€šæ¶ˆæ¯å­˜å‚¨ å›æŸ¥å¤„ç†ClientRemotingProcessor æ˜¯å®¢æˆ·ç«¯ç”¨äºå¤„ç†è¯·æ±‚ï¼Œåˆ›å»º MQClientAPIImpl æ—¶å°†è¯¥å¤„ç†å™¨æ³¨å†Œåˆ° Netty ä¸­ï¼ŒprocessRequest() æ–¹æ³•æ ¹æ®è¯·æ±‚çš„å‘½ä»¤ç ï¼Œè¿›è¡Œä¸åŒçš„å¤„ç†ï¼Œäº‹åŠ¡å›æŸ¥çš„å¤„ç†å‘½ä»¤ç ä¸º CHECK_TRANSACTION_STATE Broker ç«¯æœ‰å®šæ—¶ä»»åŠ¡å‘é€å›æŸ¥è¯·æ±‚ æˆå‘˜æ–¹æ³•ï¼š checkTransactionState()ï¼šæ£€æŸ¥äº‹åŠ¡çŠ¶æ€ 1public RemotingCommand checkTransactionState(ChannelHandlerContext ctx, RemotingCommand request) final CheckTransactionStateRequestHeader requestHeaderï¼šè§£æå‡ºè¯·æ±‚å¤´å¯¹è±¡ final MessageExt messageExtï¼šä»è¯·æ±‚ body ä¸­è§£æå‡ºæœåŠ¡å™¨å›æŸ¥çš„äº‹åŠ¡æ¶ˆæ¯ String transactionIdï¼šæå– UNIQ_KEY å­—æ®µå±æ€§å€¼èµ‹å€¼ç»™äº‹åŠ¡ ID final String groupï¼šæå–ç”Ÿäº§è€…ç»„å MQProducerInner producer = this...selectProducer(group)ï¼šæ ¹æ®ç”Ÿäº§è€…ç»„è·å–ç”Ÿäº§è€…å¯¹è±¡ String addr = RemotingHelper.parseChannelRemoteAddr()ï¼šè§£æå‡ºè¦å›æŸ¥çš„ Broker æœåŠ¡å™¨çš„åœ°å€ producer.checkTransactionState(addr, messageExt, requestHeader)ï¼šç”Ÿäº§è€…çš„äº‹åŠ¡å›æŸ¥ Runnable request = new Runnable()ï¼šåˆ›å»ºå›æŸ¥äº‹åŠ¡çŠ¶æ€ä»»åŠ¡å¯¹è±¡ è·å–ç”Ÿäº§è€…çš„ TransactionCheckListener å’Œ TransactionListenerï¼Œé€‰æ‹©ä¸€ä¸ªä¸ä¸º null çš„ç›‘å¬å™¨è¿›è¡Œäº‹åŠ¡çŠ¶æ€å›æŸ¥ this.processTransactionState()ï¼šå¤„ç†å›æŸ¥çŠ¶æ€ EndTransactionRequestHeader thisHeaderï¼šæ„å»º EndTransactionRequestHeader å¯¹è±¡ DefaultMQProducerImpl...endTransactionOneway()ï¼šå‘ Broker å‘èµ·ç»“æŸäº‹åŠ¡å•å‘è¯·æ±‚ï¼ŒäºŒé˜¶æ®µæäº¤ this.checkExecutor.submit(request)ï¼šæäº¤åˆ°çº¿ç¨‹æ± è¿è¡Œ å‚è€ƒå›¾ï¼šhttps://www.processon.com/view/link/61c8257e0e3e7474fb9dcbc0 å‚è€ƒè§†é¢‘ï¼šhttps://space.bilibili.com/457326371 äº‹åŠ¡æäº¤EndTransactionProcessor ç±»æ˜¯æœåŠ¡ç«¯ç”¨æ¥å¤„ç†å®¢æˆ·ç«¯å‘æ¥çš„æäº¤æˆ–è€…å›æ»šè¯·æ±‚ processRequest()ï¼šå¤„ç†è¯·æ±‚ 1public RemotingCommand processRequest(ChannelHandlerContext ctx, RemotingCommand request) EndTransactionRequestHeader requestHeaderï¼šä»è¯·æ±‚ä¸­è§£æå‡º EndTransactionRequestHeader if (MessageSysFlag.TRANSACTION_COMMIT_TYPE)ï¼šäº‹åŠ¡æäº¤ result = this.brokerController...commitMessage(requestHeader)ï¼šæ ¹æ® commitLogOffset æå–å‡º halfMsg æ¶ˆæ¯ MessageExtBrokerInner msgInnerï¼šæ ¹æ® result å…‹éš†å‡ºä¸€æ¡æ–°æ¶ˆæ¯ msgInner.setTopic(msgExt.getUserProperty(...))ï¼šè®¾ç½®å›åŸä¸»é¢˜ msgInner.setQueueId(Integer.parseInt(msgExt.getUserProperty(..)))ï¼šè®¾ç½®å›åŸé˜Ÿåˆ— ID MessageAccessor.clearProperty()ï¼šæ¸…ç†ä¸Šé¢çš„ä¸¤ä¸ªå±æ€§ MessageAccessor.clearProperty(msgInner, ...)ï¼šæ¸…ç†äº‹åŠ¡å±æ€§ RemotingCommand sendResult = sendFinalMessage(msgInner)ï¼šè°ƒç”¨å­˜å‚¨æ¨¡å—å­˜å‚¨è‡³ Broker this.brokerController...deletePrepareMessage(result.getPrepareMessage())ï¼šå‘åˆ é™¤ï¼ˆOPï¼‰é˜Ÿåˆ—æ·»åŠ æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä½“çš„æ•°æ®æ˜¯ halfMsg çš„ queueOffsetï¼Œè¡¨ç¤ºåŠæ¶ˆæ¯é˜Ÿåˆ—æŒ‡å®šçš„ offset çš„æ¶ˆæ¯å·²è¢«åˆ é™¤ if (this...putOpMessage(msgExt, TransactionalMessageUtil.REMOVETAG))ï¼šæ·»åŠ ä¸€æ¡ OP æ•°æ® MessageQueue messageQueueï¼šæ–°å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼ŒOP é˜Ÿåˆ— return addRemoveTagInTransactionOp(messageExt, messageQueue)ï¼šæ·»åŠ æ•°æ® Message messageï¼šåˆ›å»º OP æ¶ˆæ¯ writeOp(message, messageQueue)ï¼šå†™å…¥ OP æ¶ˆæ¯ else if (MessageSysFlag.TRANSACTION_ROLLBACK_TYPE)ï¼šäº‹åŠ¡å›æ»š this.brokerController...deletePrepareMessage(result.getPrepareMessage())ï¼šä¹Ÿéœ€è¦å‘ OP é˜Ÿåˆ—æ·»åŠ æ¶ˆæ¯ Consumeræ¶ˆè´¹è€…ç±»é»˜è®¤æ¶ˆè´¹DefaultMQPushConsumer ç±»æ˜¯é»˜è®¤çš„æ¶ˆè´¹è€…ç±» æˆå‘˜å˜é‡ï¼š æ¶ˆè´¹è€…å®ç°ç±»ï¼š 1protected final transient DefaultMQPushConsumerImpl defaultMQPushConsumerImpl; æ¶ˆè´¹å±æ€§ï¼š 12private String consumerGroup; // æ¶ˆè´¹è€…ç»„private MessageModel messageModel = MessageModel.CLUSTERING; // æ¶ˆè´¹æ¨¡å¼ï¼Œé»˜è®¤é›†ç¾¤æ¨¡å¼ è®¢é˜…ä¿¡æ¯ï¼škey æ˜¯ä¸»é¢˜ï¼Œvalue æ˜¯è¿‡æ»¤è¡¨è¾¾å¼ï¼Œä¸€èˆ¬æ˜¯ tag 1private Map&lt;String, String &gt; subscription = new HashMap&lt;String, String&gt;() æ¶ˆæ¯ç›‘å¬å™¨ï¼šæ¶ˆæ¯å¤„ç†é€»è¾‘ï¼Œå¹¶å‘æ¶ˆè´¹ MessageListenerConcurrentlyï¼Œé¡ºåºï¼ˆåˆ†åŒºï¼‰æ¶ˆè´¹ MessageListenerOrderly 1private MessageListener messageListener; æ¶ˆè´¹ä½ç‚¹ï¼šå½“ä» Broker è·å–å½“å‰ç»„å†…è¯¥ queue çš„ offset ä¸å­˜åœ¨æ—¶ï¼ŒconsumeFromWhere æ‰æœ‰æ•ˆï¼Œé»˜è®¤å€¼ä»£è¡¨ä»é˜Ÿåˆ—çš„æœ€å offset å¼€å§‹æ¶ˆè´¹ï¼Œå½“é˜Ÿåˆ—å†…å†æœ‰ä¸€æ¡æ–°çš„ msg åŠ å…¥æ—¶ï¼Œæ¶ˆè´¹è€…æ‰ä¼šå»æ¶ˆè´¹ 1private ConsumeFromWhere consumeFromWhere = ConsumeFromWhere.CONSUME_FROM_LAST_OFFSET; æ¶ˆè´¹æ—¶é—´æˆ³ï¼šå½“æ¶ˆè´¹ä½ç‚¹é…ç½®çš„æ˜¯ CONSUME_FROM_TIMESTAMP æ—¶ï¼Œå¹¶ä¸”æœåŠ¡å™¨ Group å†…ä¸å­˜åœ¨è¯¥ queue çš„ offset æ—¶ï¼Œä¼šä½¿ç”¨è¯¥æ—¶é—´æˆ³è¿›è¡Œæ¶ˆè´¹ 1private String consumeTimestamp = UtilAll.timeMillisToHumanString3(System.currentTimeMillis() - (1000 * 60 * 30));// æ¶ˆè´¹è€…åˆ›å»ºæ—¶é—´ - 30ç§’ï¼Œè½¬æ¢æˆ æ ¼å¼ï¼š å¹´æœˆæ—¥å°æ—¶åˆ†é’Ÿç§’ï¼Œæ¯”å¦‚ 20220203171201 é˜Ÿåˆ—åˆ†é…ç­–ç•¥ï¼šä¸»é¢˜ä¸‹çš„é˜Ÿåˆ—åˆ†é…ç­–ç•¥ï¼ŒRebalanceImpl å¯¹è±¡ä¾èµ–è¯¥ç®—æ³• 1private AllocateMessageQueueStrategy allocateMessageQueueStrategy; æ¶ˆè´¹è¿›åº¦å­˜å‚¨å™¨ï¼š 1private OffsetStore offsetStore; æ ¸å¿ƒæ–¹æ³•ï¼š start()ï¼šå¯åŠ¨æ¶ˆè´¹è€… 1public void start() shutdown()ï¼šå…³é—­æ¶ˆè´¹è€… 1public void shutdown() registerMessageListener()ï¼šæ³¨å†Œæ¶ˆæ¯ç›‘å¬å™¨ 1public void registerMessageListener(MessageListener messageListener) subscribe()ï¼šæ·»åŠ è®¢é˜…ä¿¡æ¯ï¼Œå°†è®¢é˜…ä¿¡æ¯æ”¾å…¥è´Ÿè½½å‡è¡¡å¯¹è±¡çš„ subscriptionInner ä¸­ 1public void subscribe(String topic, String subExpression) unsubscribe()ï¼šåˆ é™¤è®¢é˜…æŒ‡å®šä¸»é¢˜çš„ä¿¡æ¯ 1public void unsubscribe(String topic) suspend()ï¼šåœæ­¢æ¶ˆè´¹ 1public void suspend() resume()ï¼šæ¢å¤æ¶ˆè´¹ 1public void resume() é»˜è®¤å®ç°DefaultMQPushConsumerImpl æ˜¯é»˜è®¤æ¶ˆè´¹è€…çš„å®ç°ç±» æˆå‘˜å˜é‡ï¼š å®¢æˆ·ç«¯å®ä¾‹ï¼šæ•´ä¸ªè¿›ç¨‹å†…åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯å®ä¾‹å¯¹è±¡ 1private MQClientInstance mQClientFactory; æ¶ˆè´¹è€…å®ä¾‹ï¼šé—¨é¢å¯¹è±¡ 1private final DefaultMQPushConsumer defaultMQPushConsumer; è´Ÿè½½å‡è¡¡ï¼šåˆ†é…è®¢é˜…ä¸»é¢˜çš„é˜Ÿåˆ—ç»™å½“å‰æ¶ˆè´¹è€…ï¼Œ20 ç§’é’Ÿä¸€ä¸ªå‘¨æœŸæ‰§è¡Œ Rebalance ç®—æ³•ï¼ˆå®¢æˆ·ç«¯å®ä¾‹è§¦å‘ï¼‰ 1private final RebalanceImpl rebalanceImpl = new RebalancePushImpl(this); æ¶ˆè´¹è€…ä¿¡æ¯ï¼š 1234private final long consumerStartTimestamp; // æ¶ˆè´¹è€…å¯åŠ¨æ—¶é—´private volatile ServiceState serviceState; // æ¶ˆè´¹è€…çŠ¶æ€private volatile boolean pause = false; // æ˜¯å¦æš‚åœprivate boolean consumeOrderly = false; // æ˜¯å¦é¡ºåºæ¶ˆè´¹ æ‹‰å–æ¶ˆæ¯ï¼šå°è£…æ‹‰æ¶ˆæ¯çš„ APIï¼ŒæœåŠ¡å™¨ Broker è¿”å›ç»“æœä¸­åŒ…å«ä¸‹æ¬¡ Pull æ—¶æ¨èçš„ BrokerIdï¼Œæ ¹æ®æœ¬æ¬¡è¯·æ±‚æ•°æ®çš„å†·çƒ­ç¨‹åº¦è¿›è¡Œæ¨è 1private PullAPIWrapper pullAPIWrapper; æ¶ˆæ¯æ¶ˆè´¹æœåŠ¡ï¼šå¹¶å‘æ¶ˆè´¹å’Œé¡ºåºæ¶ˆè´¹ 1private ConsumeMessageService consumeMessageService; æµæ§ï¼š 12private long queueFlowControlTimes = 0; // é˜Ÿåˆ—æµæ§æ¬¡æ•°ï¼Œé»˜è®¤æ¯1000æ¬¡æµæ§ï¼Œè¿›è¡Œä¸€æ¬¡æ—¥å¿—æ‰“å°private long queueMaxSpanFlowControlTimes = 0; // æµæ§ä½¿ç”¨ï¼Œæ§åˆ¶æ‰“å°æ—¥å¿— HOOKï¼šé’©å­æ–¹æ³• 1234// è¿‡æ»¤æ¶ˆæ¯ hookprivate final ArrayList&lt;FilterMessageHook&gt; filterMessageHookList;// æ¶ˆæ¯æ‰§è¡Œhookï¼Œåœ¨æ¶ˆæ¯å¤„ç†å‰å’Œå¤„ç†ååˆ†åˆ«æ‰§è¡Œ hook.before hook.after ç³»åˆ—æ–¹æ³•private final ArrayList&lt;ConsumeMessageHook&gt; consumeMessageHookList; æ ¸å¿ƒæ–¹æ³•ï¼š start()ï¼šåŠ é”ä¿è¯çº¿ç¨‹å®‰å…¨ 1public synchronized void start() this.checkConfig()ï¼šæ£€æŸ¥é…ç½®ï¼ŒåŒ…æ‹¬ç»„åã€æ¶ˆè´¹æ¨¡å¼ã€è®¢é˜…ä¿¡æ¯ã€æ¶ˆæ¯ç›‘å¬å™¨ç­‰ this.copySubscription()ï¼šæ‹·è´è®¢é˜…ä¿¡æ¯åˆ° RebalanceImpl å¯¹è±¡ this.rebalanceImpl.getSubscriptionInner().put(topic, subscriptionData)ï¼šå°†è®¢é˜…ä¿¡æ¯åŠ å…¥ rbl çš„ map ä¸­ this.messageListenerInner = ...getMessageListener()ï¼šå°†æ¶ˆæ¯ç›‘å¬å™¨ä¿å­˜åˆ°å®ä¾‹å¯¹è±¡ switch (this.defaultMQPushConsumer.getMessageModel())ï¼šåˆ¤æ–­æ¶ˆè´¹æ¨¡å¼ï¼Œå¹¿æ’­æ¨¡å¼ä¸‹ç›´æ¥è¿”å› final String retryTopicï¼šåˆ›å»ºå½“å‰æ¶ˆè´¹è€…ç»„é‡è¯•çš„ä¸»é¢˜åï¼Œè§„åˆ™ %RETRY%ConsumerGroup SubscriptionData subscriptionData = FilterAPI.buildSubscriptionData()ï¼šåˆ›å»ºé‡è¯•ä¸»é¢˜çš„è®¢é˜…æ•°æ®å¯¹è±¡ this.rebalanceImpl.getSubscriptionInner().put(retryTopic, subscriptionData)ï¼šå°†åˆ›å»ºçš„é‡è¯•ä¸»é¢˜åŠ å…¥åˆ° rbl å¯¹è±¡çš„ map ä¸­ï¼Œæ¶ˆæ¯é‡è¯•æ—¶ä¼šåŠ å…¥åˆ°è¯¥ä¸»é¢˜ï¼Œæ¶ˆè´¹è€…è®¢é˜…è¿™ä¸ªä¸»é¢˜ä¹‹åï¼Œå°±æœ‰æœºä¼šå†æ¬¡æ‹¿åˆ°è¯¥æ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹å¤„ç† this.mQClientFactory = ...getOrCreateMQClientInstance()ï¼šè·å–å®¢æˆ·ç«¯å®ä¾‹å¯¹è±¡ this.rebalanceImpl.ï¼šåˆå§‹åŒ–è´Ÿè½½å‡è¡¡å¯¹è±¡ï¼Œè®¾ç½®é˜Ÿåˆ—åˆ†é…ç­–ç•¥å¯¹è±¡åˆ°å±æ€§ä¸­ this.pullAPIWrapper = new PullAPIWrapper()ï¼šåˆ›å»ºæ‹‰æ¶ˆæ¯ API å¯¹è±¡ï¼Œå†…éƒ¨å°è£…äº†æŸ¥è¯¢æ¨èä¸»æœºç®—æ³• this.pullAPIWrapper.registerFilterMessageHook(filterMessageHookList)ï¼šå°†è¿‡æ»¤ Hook åˆ—è¡¨æ³¨å†Œåˆ°è¯¥å¯¹è±¡å†…ï¼Œæ¶ˆæ¯æ‹‰å–ä¸‹æ¥ä¹‹åä¼šæ‰§è¡Œè¯¥ Hookï¼Œå†è¿›è¡Œä¸€æ¬¡è‡ªå®šä¹‰çš„æ¶ˆæ¯è¿‡æ»¤ this.offsetStore = new RemoteBrokerOffsetStore()ï¼šé»˜è®¤é›†ç¾¤æ¨¡å¼ä¸‹åˆ›å»ºæ¶ˆæ¯è¿›åº¦å­˜å‚¨å™¨ this.consumeMessageService = ...ï¼šæ ¹æ®æ¶ˆæ¯ç›‘å¬å™¨çš„ç±»å‹åˆ›å»ºæ¶ˆè´¹æœåŠ¡ this.consumeMessageService.start()ï¼šå¯åŠ¨æ¶ˆè´¹æœåŠ¡ boolean registerOK = mQClientFactory.registerConsumer()ï¼šå°†æ¶ˆè´¹è€…æ³¨å†Œåˆ°å®¢æˆ·ç«¯å®ä¾‹ä¸­ï¼Œå®¢æˆ·ç«¯æä¾›çš„æœåŠ¡ï¼š å¿ƒè·³æœåŠ¡ï¼šæŠŠè®¢é˜…æ•°æ®åŒæ­¥åˆ°è®¢é˜…ä¸»é¢˜çš„ Broker æ‹‰æ¶ˆæ¯æœåŠ¡ï¼šå†…éƒ¨ PullMessageService å¯åŠ¨çº¿ç¨‹ï¼ŒåŸºäº PullRequestQueue å·¥ä½œï¼Œæ¶ˆè´¹è€…è´Ÿè½½å‡è¡¡åˆ†é…åˆ°é˜Ÿåˆ—åä¼šå‘è¯¥é˜Ÿåˆ—æäº¤ PullRequest é˜Ÿåˆ—è´Ÿè½½æœåŠ¡ï¼šæ¯ 20 ç§’è°ƒç”¨ä¸€æ¬¡ consumer.doRebalance() æ¥å£ æ¶ˆæ¯è¿›åº¦æŒä¹…åŒ– åŠ¨æ€è°ƒæ•´æ¶ˆè´¹è€…ã€æ¶ˆè´¹æœåŠ¡çº¿ç¨‹æ±  mQClientFactory.start()ï¼šå¯åŠ¨å®¢æˆ·ç«¯å®ä¾‹ this.updateTopicï¼šä» nameserver è·å–ä¸»é¢˜è·¯ç”±æ•°æ®ï¼Œç”Ÿæˆä¸»é¢˜é›†åˆæ”¾å…¥ rbl å¯¹è±¡çš„ table this.mQClientFactory.checkClientInBroker()ï¼šæ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ”¯æŒæ¶ˆæ¯è¿‡æ»¤æ¨¡å¼ï¼Œä¸€èˆ¬ä½¿ç”¨ tag è¿‡æ»¤ï¼ŒæœåŠ¡å™¨é»˜è®¤æ”¯æŒ this.mQClientFactory.sendHeartbeatToAllBrokerWithLock()ï¼šå‘æ‰€æœ‰å·²çŸ¥çš„ Broker èŠ‚ç‚¹ï¼Œå‘é€å¿ƒè·³æ•°æ® this.mQClientFactory.rebalanceImmediately()ï¼šå”¤é†’ rbl çº¿ç¨‹ï¼Œè§¦å‘è´Ÿè½½å‡è¡¡æ‰§è¡Œ è´Ÿè½½å‡è¡¡å®ç°æ–¹å¼MQClientInstance#start ä¸­ä¼šå¯åŠ¨è´Ÿè½½å‡è¡¡æœåŠ¡ RebalanceServiceï¼š 123456789public void run() &#123; // æ£€æŸ¥åœæ­¢æ ‡è®° while (!this.isStopped()) &#123; // ä¼‘çœ  20 ç§’ï¼Œé˜²æ­¢å…¶ä»–çº¿ç¨‹é¥¥é¥¿ï¼Œæ‰€ä»¥ã€æ¯ 20 ç§’è´Ÿè½½å‡è¡¡ä¸€æ¬¡ã€‘ this.waitForRunning(waitInterval); // è°ƒç”¨å®¢æˆ·ç«¯å®ä¾‹çš„è´Ÿè½½å‡è¡¡æ–¹æ³•ï¼Œåº•å±‚ã€ä¼šéå†æ‰€æœ‰æ¶ˆè´¹è€…ï¼Œè°ƒç”¨æ¶ˆè´¹è€…çš„è´Ÿè½½å‡è¡¡ã€‘ this.mqClientFactory.doRebalance(); &#125; &#125; RebalanceImpl ç±»æˆå‘˜å˜é‡ï¼š åˆ†é…ç»™å½“å‰æ¶ˆè´¹è€…çš„å¤„ç†é˜Ÿåˆ—ï¼šå¤„ç†æ¶ˆæ¯é˜Ÿåˆ—é›†åˆï¼ŒProcessQueue æ˜¯ MQ é˜Ÿåˆ—åœ¨æ¶ˆè´¹è€…ç«¯çš„å¿«ç…§ 1protected final ConcurrentMap&lt;MessageQueue, ProcessQueue&gt; processQueueTable; æ¶ˆè´¹è€…è®¢é˜…ä¸»é¢˜çš„é˜Ÿåˆ—ä¿¡æ¯ï¼š 1protected final ConcurrentMap&lt;String/* topic */, Set&lt;MessageQueue&gt;&gt; topicSubscribeInfoTable; è®¢é˜…æ•°æ®ï¼š 1protected final ConcurrentMap&lt;String/* topic */, SubscriptionData&gt; subscriptionInner; é˜Ÿåˆ—åˆ†é…ç­–ç•¥ï¼š 1protected AllocateMessageQueueStrategy allocateMessageQueueStrategy; æˆå‘˜æ–¹æ³•ï¼š doRebalance()ï¼šè´Ÿè½½å‡è¡¡æ–¹æ³•ï¼Œä»¥æ¯ä¸ªæ¶ˆè´¹è€…å®ä¾‹ä¸ºç²’åº¦è¿›è¡Œè´Ÿè½½å‡è¡¡ 123456789101112131415public void doRebalance(final boolean isOrder) &#123; // è·å–å½“å‰æ¶ˆè´¹è€…çš„è®¢é˜…æ•°æ® Map&lt;String, SubscriptionData&gt; subTable = this.getSubscriptionInner(); if (subTable != null) &#123; // éå†æ‰€æœ‰çš„è®¢é˜…ä¸»é¢˜ for (final Entry&lt;String, SubscriptionData&gt; entry : subTable.entrySet()) &#123; // è·å–è®¢é˜…çš„ä¸»é¢˜ final String topic = entry.getKey(); // æŒ‰ç…§ä¸»é¢˜è¿›è¡Œè´Ÿè½½å‡è¡¡ this.rebalanceByTopic(topic, isOrder); &#125; &#125; // å°†åˆ†é…åˆ°å½“å‰æ¶ˆè´¹è€…çš„é˜Ÿåˆ—è¿›è¡Œè¿‡æ»¤ï¼Œä¸å±äºå½“å‰æ¶ˆè´¹è€…è®¢é˜…ä¸»é¢˜çš„ç›´æ¥ç§»é™¤ this.truncateMessageQueueNotMyTopic();&#125; é›†ç¾¤æ¨¡å¼ä¸‹ï¼š Set&lt;MessageQueue&gt; mqSet = this.topicSubscribeInfoTable.get(topic)ï¼šè®¢é˜…çš„ä¸»é¢˜ä¸‹çš„å…¨éƒ¨é˜Ÿåˆ—ä¿¡æ¯ cidAll = this...findConsumerIdList(topic, consumerGroup)ï¼šä»æœåŠ¡å™¨è·å–æ¶ˆè´¹è€…ç»„ä¸‹çš„å…¨éƒ¨æ¶ˆè´¹è€… ID Collections.sort(mqAll)ï¼šä¸»é¢˜ MQ é˜Ÿåˆ—å’Œæ¶ˆè´¹è€… ID éƒ½è¿›è¡Œæ’åºï¼Œä¿è¯æ¯ä¸ªæ¶ˆè´¹è€…çš„è§†å›¾ä¸€è‡´æ€§ allocateResult = strategy.allocate()ï¼š è°ƒç”¨é˜Ÿåˆ—åˆ†é…ç­–ç•¥ï¼Œç»™å½“å‰æ¶ˆè´¹è€…è¿›è¡Œåˆ†é… MessageQueueï¼ˆä¸‹ä¸€èŠ‚ï¼‰ boolean changed = this.updateProcessQueueTableInRebalance(...)ï¼šæ›´æ–°é˜Ÿåˆ—å¤„ç†é›†åˆï¼ŒmqSet æ˜¯ rbl ç®—æ³•åˆ†é…åˆ°å½“å‰æ¶ˆè´¹è€…çš„ MQ é›†åˆ while (it.hasNext())ï¼šéå†å½“å‰æ¶ˆè´¹è€…çš„æ‰€æœ‰å¤„ç†é˜Ÿåˆ— if (mq.getTopic().equals(topic))ï¼šè¯¥ MQ æ˜¯ æœ¬æ¬¡ rbl åˆ†é…ç®—æ³•è®¡ç®—çš„ä¸»é¢˜ if (!mqSet.contains(mq))ï¼šè¯¥ MQ ç»è¿‡ rbl è®¡ç®—ä¹‹åï¼Œè¢«åˆ†é…åˆ°å…¶å®ƒ Consumer èŠ‚ç‚¹ pq.setDropped(true)ï¼šå°†åˆ é™¤çŠ¶æ€è®¾ç½®ä¸º true if (this.removeUnnecessaryMessageQueue(mq, pq))ï¼šåˆ é™¤ä¸éœ€è¦çš„ MQ é˜Ÿåˆ— this...getOffsetStore().persist(mq)ï¼šåœ¨ MQ å½’å±çš„ Broker èŠ‚ç‚¹æŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦ this...getOffsetStore().removeOffset(mq)ï¼šåˆ é™¤è¯¥ MQ åœ¨æœ¬åœ°çš„æ¶ˆè´¹è¿›åº¦ if (this.defaultMQPushConsumerImpl.isConsumeOrderly() &amp;&amp;)ï¼šæ˜¯å¦æ˜¯é¡ºåºæ¶ˆè´¹å’Œé›†ç¾¤æ¨¡å¼ if (pq.getLockConsume().tryLock(1000, ..))ï¼š è·å–é”æˆåŠŸï¼Œè¯´æ˜é¡ºåºæ¶ˆè´¹ä»»åŠ¡å·²ç»åœæ­¢æ¶ˆè´¹å·¥ä½œ return this.unlockDelay(mq, pq)ï¼šé‡Šæ”¾é” Broker ç«¯çš„é˜Ÿåˆ—é”ï¼Œå‘æœåŠ¡å™¨å‘èµ· oneway çš„è§£é”è¯·æ±‚ if (pq.hasTempMessage())ï¼šé˜Ÿåˆ—ä¸­æœ‰æ¶ˆæ¯ï¼Œå»¶è¿Ÿ 20 ç§’é‡Šæ”¾é˜Ÿåˆ—åˆ†å¸ƒå¼é”ï¼Œç¡®ä¿å…¨å±€èŒƒå›´å†…åªæœ‰ä¸€ä¸ªæ¶ˆè´¹ä»»åŠ¡ è¿è¡Œä¸­ elseï¼šå½“å‰æ¶ˆè´¹è€…æœ¬åœ°è¯¥æ¶ˆè´¹ä»»åŠ¡å·²ç»é€€å‡ºï¼Œç›´æ¥é‡Šæ”¾é” elseï¼šé¡ºåºæ¶ˆè´¹ä»»åŠ¡æ­£åœ¨æ¶ˆè´¹ä¸€æ‰¹æ¶ˆæ¯ï¼Œä¸å¯æ‰“æ–­ï¼Œå¢åŠ å°è¯•è·å–é”çš„æ¬¡æ•° it.remove()ï¼šä» processQueueTable ç§»é™¤è¯¥ MQ else if (pq.isPullExpired())ï¼šè¯´æ˜å½“å‰ MQ è¿˜æ˜¯è¢«å½“å‰ Consumer æ¶ˆè´¹ï¼Œæ­¤æ—¶åˆ¤æ–­ä¸€ä¸‹æ˜¯å¦è¶…è¿‡ 2 åˆ†é’Ÿæœªåˆ°æœåŠ¡å™¨ æ‹‰æ¶ˆæ¯ï¼Œå¦‚æœæ¡ä»¶æˆç«‹è¿›è¡Œä¸Šè¿°ç›¸åŒçš„é€»è¾‘ for (MessageQueue mq : mqSet)ï¼šå¼€å§‹å¤„ç†å½“å‰ä¸»é¢˜æ–°åˆ†é…åˆ°å½“å‰èŠ‚ç‚¹çš„é˜Ÿåˆ— if (isOrder &amp;&amp; !this.lock(mq))ï¼šé¡ºåºæ¶ˆæ¯ä¸ºäº†ä¿è¯æœ‰åºæ€§ï¼Œéœ€è¦è·å–é˜Ÿåˆ—é” ProcessQueue pq = new ProcessQueue()ï¼šä¸ºæ¯ä¸ªæ–°åˆ†é…çš„æ¶ˆæ¯é˜Ÿåˆ—åˆ›å»ºå¿«ç…§é˜Ÿåˆ— long nextOffset = this.computePullFromWhere(mq)ï¼šä»æœåŠ¡ç«¯è·å–æ–°åˆ†é…çš„ MQ çš„æ¶ˆè´¹è¿›åº¦ ProcessQueue pre = this.processQueueTable.putIfAbsent(mq, pq)ï¼šä¿å­˜åˆ°å¤„ç†é˜Ÿåˆ—é›†åˆ PullRequest pullRequest = new PullRequest()ï¼šåˆ›å»ºæ‹‰å–è¯·æ±‚å¯¹è±¡ this.dispatchPullRequest(pullRequestList)ï¼šæ”¾å…¥ PullMessageService çš„æœ¬åœ°é˜»å¡é˜Ÿåˆ—å†…ï¼Œç”¨äºæ‹‰å–æ¶ˆæ¯å·¥ä½œ lockAll()ï¼šç»­çº¦é”ï¼Œå¯¹æ¶ˆè´¹è€…çš„æ‰€æœ‰é˜Ÿåˆ—è¿›è¡Œç»­çº¦ 1public void lockAll() HashMap&lt;String, Set&lt;MessageQueue&gt;&gt; brokerMqsï¼šå°†åˆ†é…ç»™å½“å‰æ¶ˆè´¹è€…çš„å…¨éƒ¨ MQ æŒ‰ç…§ BrokerName åˆ†ç»„ while (it.hasNext())ï¼šéå†æ‰€æœ‰çš„åˆ†ç»„ final Set&lt;MessageQueue&gt; mqsï¼šè·å–è¯¥ Broker ä¸Šåˆ†é…ç»™å½“å‰æ¶ˆè´¹è€…çš„ queue é›†åˆ FindBrokerResult findBrokerResultï¼šæŸ¥è¯¢ Broker ä¸»èŠ‚ç‚¹ä¿¡æ¯ LockBatchRequestBody requestBodyï¼šåˆ›å»ºè¯·æ±‚å¯¹è±¡ï¼Œå¡«å……å±æ€§ Set&lt;MessageQueue&gt; lockOKMQSetï¼šä»¥ç»„ä¸ºå•ä½å‘ Broker å‘èµ·æ‰¹é‡ç»­çº¦é”çš„åŒæ­¥è¯·æ±‚ï¼Œè¿”å›æˆåŠŸçš„é˜Ÿåˆ—é›†åˆ for (MessageQueue mq : lockOKMQSet)ï¼šéå†ç»­çº¦é”æˆåŠŸçš„ MQ processQueue.setLocked(true)ï¼šåˆ†å¸ƒå¼é”çŠ¶æ€è®¾ç½®ä¸º trueï¼Œè¡¨ç¤ºå…è®¸é¡ºåºæ¶ˆè´¹ processQueue.setLastLockTimestamp(System.currentTimeMillis())ï¼šè®¾ç½®ä¸Šæ¬¡è·å–é”çš„æ—¶é—´ä¸ºå½“å‰æ—¶é—´ for (MessageQueue mq : mqs)ï¼šéå†å½“å‰ Broker ä¸Šçš„æ‰€æœ‰é˜Ÿåˆ—é›†åˆ if (!lockOKMQSet.contains(mq))ï¼šæ¡ä»¶æˆç«‹è¯´æ˜ç»­çº¦é”å¤±è´¥ processQueue.setLocked(false)ï¼šåˆ†å¸ƒå¼é”çŠ¶æ€è®¾ç½®ä¸º falseï¼Œè¡¨ç¤ºä¸å…è®¸é¡ºåºæ¶ˆè´¹ é˜Ÿåˆ—åˆ†é…AllocateMessageQueueStrategy ç±»æ˜¯é˜Ÿåˆ—çš„åˆ†é…ç­–ç•¥ å¹³å‡åˆ†é…ï¼šAllocateMessageQueueAveragely ç±» 123456789101112131415161718192021// å‚æ•°ä¸€ï¼šæ¶ˆè´¹è€…ç»„ å‚æ•°äºŒï¼šå½“å‰æ¶ˆè´¹è€…id // å‚æ•°ä¸‰ï¼šä¸»é¢˜çš„å…¨éƒ¨é˜Ÿåˆ—ï¼ŒåŒ…æ‹¬æ‰€æœ‰ broker ä¸Šè¯¥ä¸»é¢˜çš„ mq å‚æ•°å››ï¼šå…¨éƒ¨æ¶ˆè´¹è€…idé›†åˆpublic List&lt;MessageQueue&gt; allocate(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll, List&lt;String&gt; cidAll) &#123; // è·å–å½“å‰æ¶ˆè´¹è€…åœ¨å…¨éƒ¨æ¶ˆè´¹è€…ä¸­çš„ä½ç½®ï¼Œã€å…¨éƒ¨æ¶ˆè´¹è€…æ˜¯å·²ç»æ’åºå¥½çš„ï¼Œæ’åœ¨å‰é¢çš„ä¼˜å…ˆåˆ†é…æ›´å¤šçš„é˜Ÿåˆ—ã€‘ int index = cidAll.indexOf(currentCID); // å¹³å‡åˆ†é…å®Œä»¥åï¼Œè¿˜å‰©ä½™çš„å¾…åˆ†é…çš„ mq çš„æ•°é‡ int mod = mqAll.size() % cidAll.size(); // é¦–å…ˆåˆ¤æ–­æ•´ä½“çš„ mq çš„æ•°é‡æ˜¯å¦å°äºæ¶ˆè´¹è€…çš„æ•°é‡ï¼Œå°äºæ¶ˆè´¹è€…çš„æ•°é‡å°±è¯´æ˜ä¸å¤Ÿåˆ†çš„ï¼Œå…ˆåˆ†ä¸€ä¸ª int averageSize = mqAll.size() &lt;= cidAll.size() ? 1 : // æˆç«‹éœ€è¦å¤šåˆ†é…ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå› ä¸ºæ›´é å‰ (mod &gt; 0 &amp;&amp; index &lt; mod ? mqAll.size() / cidAll.size() + 1 : mqAll.size() / cidAll.size()); // è·å–èµ·å§‹çš„åˆ†é…ä½ç½® int startIndex = (mod &gt; 0 &amp;&amp; index &lt; mod) ? index * averageSize : index * averageSize + mod; // é˜²æ­¢ç´¢å¼•è¶Šç•Œ int range = Math.min(averageSize, mqAll.size() - startIndex); // å¼€å§‹åˆ†é…ï¼Œã€æŒ¨ç€åˆ†é…ï¼Œæ˜¯ç›´æ¥å°±æŠŠå½“å‰çš„ æ¶ˆè´¹è€…åˆ†é…å®Œæˆã€‘ for (int i = 0; i &lt; range; i++) &#123; result.add(mqAll.get((startIndex + i) % mqAll.size())); &#125; return result;&#125; é˜Ÿåˆ—æ’åºåï¼šQ1 â†’ Q2 â†’ Q3ï¼Œæ¶ˆè´¹è€…æ’åºå C1 â†’ C2 â†’ C3 è½®æµåˆ†é…ï¼šAllocateMessageQueueAveragelyByCircle æŒ‡å®šæœºæˆ¿å¹³å‡åˆ†é…ï¼šAllocateMessageQueueByMachineRoomï¼Œå‰ææ˜¯ Broker çš„å‘½åè§„åˆ™ä¸º æœºæˆ¿å@BrokerName æ‹‰å–æœåŠ¡å®ç°æ–¹å¼MQClientInstance#start ä¸­ä¼šå¯åŠ¨æ¶ˆæ¯æ‹‰å–æœåŠ¡ï¼šPullMessageService 12345678910111213public void run() &#123; // æ£€æŸ¥åœæ­¢æ ‡è®°ï¼Œã€å¾ªç¯æ‹‰å–ã€‘ while (!this.isStopped()) &#123; try &#123; // ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–æ‹‰æ¶ˆæ¯è¯·æ±‚ PullRequest pullRequest = this.pullRequestQueue.take(); // æ‹‰å–æ¶ˆæ¯ï¼Œè·å–è¯·æ±‚å¯¹åº”çš„ä½¿ç”¨å½“å‰æ¶ˆè´¹è€…ç»„ä¸­çš„å“ªä¸ªæ¶ˆè´¹è€…ï¼Œè°ƒç”¨æ¶ˆè´¹è€…çš„ pullMessage æ–¹æ³• this.pullMessage(pullRequest); &#125; catch (Exception e) &#123; log.error(&quot;Pull Message Service Run Method exception&quot;, e); &#125; &#125;&#125; DefaultMQPushConsumerImpl#pullMessageï¼š ProcessQueue processQueue = pullRequest.getProcessQueue()ï¼šè·å–è¯·æ±‚å¯¹åº”çš„å¿«ç…§é˜Ÿåˆ—ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦æ˜¯åˆ é™¤çŠ¶æ€ this.executePullRequestLater()ï¼šå¦‚æœå½“å‰æ¶ˆè´¹è€…ä¸æ˜¯è¿è¡ŒçŠ¶æ€ï¼Œåˆ™æ‹‰æ¶ˆæ¯ä»»åŠ¡å»¶è¿Ÿ 3 ç§’åæ‰§è¡Œï¼Œå¦‚æœæ˜¯æš‚åœçŠ¶æ€å»¶è¿Ÿ 1 ç§’ æµæ§çš„é€»è¾‘ï¼š long cachedMessageCount = processQueue.getMsgCount().get()ï¼šè·å–æ¶ˆè´¹è€…æœ¬åœ°è¯¥ queue å¿«ç…§å†…ç¼“å­˜çš„æ¶ˆæ¯æ•°é‡ï¼Œå¦‚æœå¤§äº 1000 æ¡ï¼Œè¿›è¡Œæµæ§ï¼Œå»¶è¿Ÿ 50 æ¯«ç§’ long cachedMessageSizeInMiBï¼š æ¶ˆè´¹è€…æœ¬åœ°è¯¥ queue å¿«ç…§å†…ç¼“å­˜çš„æ¶ˆæ¯å®¹é‡ sizeï¼Œè¶…è¿‡ 100m æ¶ˆæ¯æœªè¢«æ¶ˆè´¹è¿›è¡Œæµæ§ if(processQueue.getMaxSpan() &gt; 2000)ï¼šæ¶ˆè´¹è€…æœ¬åœ°ç¼“å­˜æ¶ˆæ¯ç¬¬ä¸€æ¡æ¶ˆæ¯æœ€åä¸€æ¡æ¶ˆæ¯è·¨åº¦è¶…è¿‡ 2000 è¿›è¡Œæµæ§ SubscriptionData subscriptionDataï¼šæœ¬æ¬¡æ‹‰æ¶ˆæ¯è¯·æ±‚è®¢é˜…çš„ä¸»é¢˜æ•°æ®ï¼Œå¦‚æœè°ƒç”¨äº† unsubscribe(ä¸»é¢˜) å°†ä¼šè·å–ä¸º null PullCallback pullCallback = new PullCallback()ï¼šæ‹‰æ¶ˆæ¯å¤„ç†å›è°ƒå¯¹è±¡ pullResult = ...processPullResult()ï¼šé¢„å¤„ç† PullResult ç»“æœï¼Œå°†æœåŠ¡å™¨ç«¯æŒ‡å®š MQ çš„æ‹‰æ¶ˆæ¯ä¸‹ä¸€æ¬¡çš„æ¨èèŠ‚ç‚¹ä¿å­˜åˆ° pullFromWhichNodeTable ä¸­ï¼Œå¹¶è¿›è¡Œæ¶ˆæ¯è¿‡æ»¤ case FOUNDï¼šæ­£å¸¸æ‹‰å–åˆ°æ¶ˆæ¯ pullRequest.setNextOffset(pullResult.getNextBeginOffset())ï¼šæ›´æ–° pullRequest å¯¹è±¡ä¸‹ä¸€æ¬¡æ‹‰å–æ¶ˆæ¯çš„ä½ç‚¹ if (pullResult.getMsgFoundList() == null...)ï¼šæ¶ˆæ¯è¿‡æ»¤å¯¼è‡´æ¶ˆæ¯å…¨éƒ¨è¢«è¿‡æ»¤æ‰ï¼Œéœ€è¦ç«‹é©¬å‘èµ·ä¸‹ä¸€æ¬¡æ‹‰æ¶ˆæ¯ boolean .. = processQueue.putMessage()ï¼šå°†æœåŠ¡å™¨æ‹‰å–çš„æ¶ˆæ¯é›†åˆåŠ å…¥åˆ°æ¶ˆè´¹è€…æœ¬åœ°çš„ processQueue å†… DefaultMQPushConsumerImpl...submitConsumeRequest()ï¼šæäº¤æ¶ˆè´¹ä»»åŠ¡ï¼Œåˆ†ä¸ºé¡ºåºæ¶ˆè´¹å’Œå¹¶å‘æ¶ˆè´¹ Defaul..executePullRequestImmediately(pullRequest)ï¼šå°†æ›´æ–°è¿‡ nextOffset å­—æ®µçš„ PullRequest å¯¹è±¡ï¼Œå†æ¬¡æ”¾åˆ° pullMessageService çš„é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œå½¢æˆé—­ç¯ case NO_NEW_MSG ||NO_MATCHED_MSGï¼šè¡¨ç¤ºæœ¬æ¬¡ pull æ²¡æœ‰æ–°çš„å¯æ¶ˆè´¹çš„ä¿¡æ¯ pullRequest.setNextOffset()ï¼šæ›´æ–°æ›´æ–° pullRequest å¯¹è±¡ä¸‹ä¸€æ¬¡æ‹‰å–æ¶ˆæ¯çš„ä½ç‚¹ Defaul..executePullRequestImmediately(pullRequest)ï¼šå†æ¬¡æ‹‰å–è¯·æ±‚ case OFFSET_ILLEGALï¼šæœ¬æ¬¡ pull æ—¶ä½¿ç”¨çš„ offset æ˜¯æ— æ•ˆçš„ï¼Œå³ offset &gt; maxOffset || offset &lt; minOffset pullRequest.setNextOffset()ï¼šè°ƒæ•´ pullRequest.nextOffset ä¸ºæ­£ç¡®çš„ offset pullRequest.getProcessQueue().setDropped(true)ï¼šè®¾ç½®è¯¥ processQueue ä¸ºåˆ é™¤çŠ¶æ€ï¼Œå¦‚æœæœ‰è¯¥ queue çš„æ¶ˆè´¹ä»»åŠ¡ï¼Œæ¶ˆè´¹ä»»åŠ¡ä¼šé©¬ä¸Šåœæ­¢ DefaultMQPushConsumerImpl.this.executeTaskLater()ï¼šæäº¤å¼‚æ­¥ä»»åŠ¡ï¼Œ10 ç§’åå»æ‰§è¡Œ DefaultMQPushConsumerImpl...updateOffset()ï¼šæ›´æ–° offsetStore è¯¥ MQ çš„ offset ä¸ºæ­£ç¡®å€¼ï¼Œå†…éƒ¨ç›´æ¥æ›¿æ¢ DefaultMQPushConsumerImpl...persist()ï¼šæŒä¹…åŒ–è¯¥ messageQueue çš„ offset åˆ° Broker ç«¯ DefaultMQPushConsumerImpl...removeProcessQueue()ï¼š åˆ é™¤è¯¥æ¶ˆè´¹è€…è¯¥ messageQueue å¯¹åº”çš„ processQueue è¿™é‡Œæ²¡æœ‰å†æ¬¡æäº¤ pullRequest åˆ° pullMessageService çš„é˜Ÿåˆ—ï¼Œé‚£è¯¥é˜Ÿåˆ—ä¸å†æ‹‰æ¶ˆæ¯äº†å—ï¼Ÿ è´Ÿè½½å‡è¡¡ rbl ç¨‹åºä¼šé‡å»ºè¯¥é˜Ÿåˆ—çš„ processQueueï¼Œé‡å»ºå®Œä¹‹åä¼šä¸ºè¯¥é˜Ÿåˆ—åˆ›å»ºæ–°çš„ PullRequest å¯¹è±¡ int sysFlag = PullSysFlag.buildSysFlag()ï¼šæ„å»ºæ ‡å¿—å¯¹è±¡ï¼ŒsysFlag é«˜ 4 ä½æœªä½¿ç”¨ï¼Œä½ 4 ä½ä½¿ç”¨ï¼Œä»å·¦åˆ°å³ 0000 0011 ç¬¬ä¸€ä½ï¼šè¡¨ç¤ºæ˜¯å¦æäº¤æ¶ˆè´¹è€…æœ¬åœ°è¯¥é˜Ÿåˆ—çš„ offsetï¼Œä¸€èˆ¬æ˜¯ 1 ç¬¬äºŒä½ï¼šè¡¨ç¤ºæ˜¯å¦å…è®¸æœåŠ¡å™¨ç«¯è¿›è¡Œé•¿è½®è¯¢ï¼Œä¸€èˆ¬æ˜¯ 1 ç¬¬ä¸‰ä½ï¼šè¡¨ç¤ºæ˜¯å¦æäº¤æ¶ˆè´¹è€…æœ¬åœ°è¯¥ä¸»é¢˜çš„è®¢é˜…æ•°æ®ï¼Œä¸€èˆ¬æ˜¯ 0 ç¬¬å››ä½ï¼šè¡¨ç¤ºæ˜¯å¦ä¸ºç±»è¿‡æ»¤ï¼Œä¸€èˆ¬æ˜¯ 0 this.pullAPIWrapper.pullKernelImpl()ï¼šæ‹‰å–æ¶ˆæ¯çš„æ ¸å¿ƒæ–¹æ³• å°è£…å¯¹è±¡PullAPIWrapper ç±»å°è£…äº†æ‹‰å–æ¶ˆæ¯çš„ API æˆå‘˜å˜é‡ï¼š æ¨èæ‹‰æ¶ˆæ¯ä½¿ç”¨çš„ä¸»æœº IDï¼š 1private ConcurrentMap&lt;MessageQueue, AtomicLong/* brokerId */&gt; pullFromWhichNodeTable æˆå‘˜æ–¹æ³•ï¼š pullKernelImpl()ï¼šæ‹‰æ¶ˆæ¯ FindBrokerResult findBrokerResultï¼šæœ¬åœ°æŸ¥è¯¢æŒ‡å®š BrokerName çš„åœ°å€ä¿¡æ¯ï¼Œæ¨èèŠ‚ç‚¹æˆ–è€…ä¸»èŠ‚ç‚¹ if (null == findBrokerResult)ï¼šæŸ¥è¯¢ä¸åˆ°ï¼Œå°±åˆ° Namesrv è·å–æŒ‡å®š topic çš„è·¯ç”±æ•°æ® if (findBrokerResult.isSlave())ï¼šæˆç«‹è¯´æ˜ findBrokerResult è¡¨ç¤ºçš„ä¸»æœºä¸º slave èŠ‚ç‚¹ï¼Œslave ä¸å­˜å‚¨ offset ä¿¡æ¯ sysFlagInner = PullSysFlag.clearCommitOffsetFlag(sysFlagInner)ï¼šå°† sysFlag æ ‡è®°ä½ä¸­ CommitOffset çš„ä½ç½®ä¸º 0 PullMessageRequestHeader requestHeaderï¼šåˆ›å»ºè¯·æ±‚å¤´å¯¹è±¡ï¼Œå°è£…æ‰€æœ‰çš„å‚æ•° PullResult pullResult = this.mQClientFactory.getMQClientAPIImpl().pullMessage()ï¼šè°ƒç”¨å®¢æˆ·ç«¯å®ä¾‹çš„æ–¹æ³•ï¼Œæ ¸å¿ƒé€»è¾‘å°±æ˜¯å°†ä¸šåŠ¡æ•°æ®è½¬åŒ–ä¸º RemotingCommand é€šè¿‡ NettyRemotingClient çš„ IO è¿›è¡Œé€šä¿¡ RemotingCommand requestï¼šåˆ›å»ºç½‘ç»œå±‚ä¼ è¾“å¯¹è±¡ RemotingCommand å¯¹è±¡ï¼Œè¯·æ±‚ ID ä¸º PULL_MESSAGE = 11 return this.pullMessageSync(...)ï¼šæ­¤å¤„æ˜¯å¼‚æ­¥è°ƒç”¨ï¼Œå¤„ç†ç»“æœæ”¾å…¥ ResponseFuture ä¸­ï¼Œå‚è€ƒæœåŠ¡ç«¯å°èŠ‚çš„å¤„ç†å™¨ç±» NettyServerHandler#processMessageReceived æ–¹æ³• RemotingCommand response = responseFuture.getResponseCommand()ï¼šè·å–æœåŠ¡å™¨ç«¯å“åº”æ•°æ® response PullResult pullResultï¼šä» response å†…æå–å‡ºæ¥æ‹‰æ¶ˆæ¯ç»“æœå¯¹è±¡ï¼Œå°†å“åº”å¤´ PullMessageResponseHeader å¯¹è±¡ä¸­ä¿¡æ¯å¡«å……åˆ° PullResult ä¸­ï¼Œåˆ—å‡ºä¸¤ä¸ªé‡è¦çš„å­—æ®µï¼š private Long suggestWhichBrokerIdï¼šæœåŠ¡ç«¯å»ºè®®å®¢æˆ·ç«¯ä¸‹æ¬¡ Pull æ—¶é€‰æ‹©çš„ BrokerID private Long nextBeginOffsetï¼šå®¢æˆ·ç«¯ä¸‹æ¬¡ Pull æ—¶ä½¿ç”¨çš„ offset ä¿¡æ¯ pullCallback.onSuccess(pullResult)ï¼šå°† PullResult äº¤ç»™æ‹‰æ¶ˆæ¯ç»“æœå¤„ç†å›è°ƒå¯¹è±¡ï¼Œè°ƒç”¨ onSuccess æ–¹æ³• æ‹‰å–å¤„ç†å¤„ç†å™¨BrokerStartup#createBrokerController æ–¹æ³•ä¸­åˆ›å»ºäº† BrokerController å¹¶è¿›è¡Œåˆå§‹åŒ–ï¼Œè°ƒç”¨ registerProcessor() æ–¹æ³•å°†å¤„ç†å™¨ PullMessageProcessor æ³¨å†Œåˆ° NettyRemotingServer ä¸­ï¼Œå¯¹åº”çš„è¯·æ±‚ ID ä¸º PULL_MESSAGE = 11ï¼ŒNettyServerHandler åœ¨å¤„ç†è¯·æ±‚æ—¶é€šè¿‡è¯·æ±‚ ID ä¼šè·å–å¤„ç†å™¨æ‰§è¡Œ processRequest æ–¹æ³• 12// å‚æ•°ä¸€ï¼šæœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ netty é€šé“ï¼› å‚æ•°äºŒï¼šå®¢æˆ·ç«¯è¯·æ±‚ï¼› å‚æ•°ä¸‰ï¼šæ˜¯å¦å…è®¸æœåŠ¡å™¨ç«¯é•¿è½®è¯¢ï¼Œé»˜è®¤ trueprivate RemotingCommand processRequest(final Channel channel, RemotingCommand request, boolean brokerAllowSuspend) RemotingCommand responseï¼šåˆ›å»ºå“åº”å¯¹è±¡ï¼Œè®¾ç½®ä¸ºå“åº”ç±»å‹çš„è¯·æ±‚ï¼Œå“åº”å¤´æ˜¯ PullMessageResponseHeader final PullMessageResponseHeader responseHeaderï¼šè·å–å“åº”å¯¹è±¡çš„ header final PullMessageRequestHeader requestHeaderï¼šè§£æå‡ºè¯·æ±‚å¤´ PullMessageRequestHeader response.setOpaque(request.getOpaque())ï¼šè®¾ç½® opaque å±æ€§ï¼Œå®¢æˆ·ç«¯æ ¹æ®è¯¥å­—æ®µè·å– ResponseFuture è¿›è¡Œå¤„ç† è¿›è¡Œä¸€äº›é‰´æƒçš„é€»è¾‘ï¼šæ˜¯å¦å…è®¸é•¿è½®è¯¢ã€æäº¤ offsetã€topicConfig æ˜¯å¦æ˜¯ç©ºã€é˜Ÿåˆ— ID æ˜¯å¦åˆç† ConsumerGroupInfo consumerGroupInfoï¼šè·å–æ¶ˆè´¹è€…ç»„ä¿¡æ¯ï¼ŒåŒ…å«å…¨éƒ¨çš„æ¶ˆè´¹è€…å’Œè®¢é˜…æ•°æ® subscriptionData = consumerGroupInfo.findSubscriptionData()ï¼šè·å–æŒ‡å®šä¸»é¢˜çš„è®¢é˜…æ•°æ® if (!ExpressionType.isTagType()ï¼šè¡¨è¾¾å¼åŒ¹é… MessageFilter messageFilterï¼šåˆ›å»ºæ¶ˆæ¯è¿‡æ»¤å™¨ï¼Œä¸€èˆ¬æ˜¯é€šè¿‡ tagCode è¿›è¡Œè¿‡æ»¤ DefaultMessageStore.getMessage()ï¼šæŸ¥è¯¢æ¶ˆæ¯çš„æ ¸å¿ƒé€»è¾‘ï¼Œåœ¨ Broker ç«¯æŸ¥è¯¢æ¶ˆæ¯ï¼ˆå­˜å‚¨ç«¯ç¬”è®°è¯¦è§£äº†è¯¥æºç ï¼‰ response.setRemark()ï¼šè®¾ç½®æ­¤æ¬¡å“åº”çš„çŠ¶æ€ responseHeader.set..ï¼šè®¾ç½®å“åº”å¤´å¯¹è±¡çš„ä¸€äº›å­—æ®µ switch (this.brokerController.getMessageStoreConfig().getBrokerRole())ï¼šå¦‚æœå½“å‰ä¸»æœºèŠ‚ç‚¹è§’è‰²ä¸º slave å¹¶ä¸”ä»èŠ‚ç‚¹è¯»å¹¶æœªå¼€å¯çš„è¯ï¼Œç›´æ¥ç»™å®¢æˆ·ç«¯ ä¸€ä¸ªçŠ¶æ€ PULL_RETRY_IMMEDIATELYï¼Œå¹¶è®¾ç½®ä¸ºä¸‹æ¬¡ä»ä¸»èŠ‚ç‚¹è¯» if (this.brokerController.getBrokerConfig().isSlaveReadEnable())ï¼šæ¶ˆè´¹å¤ªæ…¢ï¼Œä¸‹æ¬¡ä»å¦ä¸€å°æœºå™¨æ‹‰å– switch (getMessageResult.getStatus())ï¼šæ ¹æ® getMessageResult çš„çŠ¶æ€è®¾ç½® response çš„ code 1234567891011public enum GetMessageStatus &#123; FOUND, // æŸ¥è¯¢æˆåŠŸ NO_MATCHED_MESSAGE, // æœªæŸ¥è¯¢åˆ°åˆ°æ¶ˆæ¯ï¼ŒæœåŠ¡ç«¯è¿‡æ»¤ tagCode MESSAGE_WAS_REMOVING, // æŸ¥è¯¢æ—¶èµ¶ä¸Š CommitLog æ¸…ç†è¿‡æœŸæ–‡ä»¶ï¼Œå¯¼è‡´æŸ¥è¯¢å¤±è´¥ï¼Œç«‹åˆ»å°è¯• OFFSET_FOUND_NULL, // æŸ¥è¯¢æ—¶èµ¶ä¸Š ConsumerQueue æ¸…ç†è¿‡æœŸæ–‡ä»¶ï¼Œå¯¼è‡´æŸ¥è¯¢å¤±è´¥ï¼Œã€è¿›è¡Œé•¿è½®è¯¢ã€‘ OFFSET_OVERFLOW_BADLY, // pullRequest.offset è¶Šç•Œ maxOffset OFFSET_OVERFLOW_ONE, // pullRequest.offset == CQ.maxOffsetï¼Œã€è¿›è¡Œé•¿è½®è¯¢ã€‘ OFFSET_TOO_SMALL, // pullRequest.offset è¶Šç•Œ minOffset NO_MATCHED_LOGIC_QUEUE, // æ²¡æœ‰åŒ¹é…åˆ°é€»è¾‘é˜Ÿåˆ— NO_MESSAGE_IN_QUEUE, // ç©ºé˜Ÿåˆ—ï¼Œåˆ›å»ºé˜Ÿåˆ—ä¹Ÿæ˜¯å› ä¸ºæŸ¥è¯¢å¯¼è‡´ï¼Œã€è¿›è¡Œé•¿è½®è¯¢ã€‘&#125; switch (response.getCode())ï¼šæ ¹æ® response çŠ¶æ€åšå¯¹åº”çš„ä¸šåŠ¡å¤„ç† case ResponseCode.SUCCESSï¼šæŸ¥è¯¢æˆåŠŸ final byte[] r = this.readGetMessageResult()ï¼šæœ¬æ¬¡ pull å‡ºæ¥çš„å…¨éƒ¨æ¶ˆæ¯å¯¼å…¥ byte æ•°ç»„ response.setBody(r)ï¼šå°†æ¶ˆæ¯çš„ byte æ•°ç»„ä¿å­˜åˆ° response body å­—æ®µ case ResponseCode.PULL_NOT_FOUNDï¼šäº§ç”Ÿè¿™ç§æƒ…å†µå¤§éƒ¨åˆ†åŸå› æ˜¯ pullRequest.offset == queue.maxOffsetï¼Œè¯´æ˜å·²ç»æ²¡æœ‰éœ€è¦è·å–çš„æ¶ˆæ¯ï¼Œæ­¤æ—¶å¦‚æœç›´æ¥è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯ä¼šç«‹åˆ»é‡æ–°è¯·æ±‚ï¼Œè¿˜æ˜¯ç»§ç»­è¿”å›è¯¥çŠ¶æ€ï¼Œé¢‘ç¹æ‹‰å–æœåŠ¡å™¨å¯¼è‡´æœåŠ¡å™¨å‹åŠ›å¤§ï¼Œæ‰€ä»¥æ­¤å¤„éœ€è¦é•¿è½®è¯¢ if (brokerAllowSuspend &amp;&amp; hasSuspendFlag)ï¼šbrokerAllowSuspend &#x3D; trueï¼Œå½“é•¿è½®è¯¢ç»“æŸå†æ¬¡æ‰§è¡Œ processRequest æ—¶è¯¥å‚æ•°ä¸º falseï¼Œæ‰€ä»¥æ¯æ¬¡ Pull è¯·æ±‚è‡³å¤šåœ¨æœåŠ¡å™¨ç«¯é•¿è½®è¯¢æ§åˆ¶ä¸€æ¬¡ PullRequest pullRequest = new PullRequest()ï¼šåˆ›å»ºé•¿è½®è¯¢ PullRequest å¯¹è±¡ this.brokerController...suspendPullRequest(topic, queueId, pullRequest)ï¼šå°†é•¿è½®è¯¢è¯·æ±‚å¯¹è±¡äº¤ç»™é•¿è½®è¯¢æœåŠ¡ String key = this.buildKey(topic, queueId)ï¼šæ„å»ºä¸€ä¸ª topic@queueId çš„ key ManyPullRequest mpr = this.pullRequestTable.get(key)ï¼šä»æ‹‰è¯·æ±‚è¡¨ä¸­è·å–å¯¹è±¡ mpr.addPullRequest(pullRequest)ï¼šå°† PullRequest å¯¹è±¡æ”¾å…¥åˆ°é•¿è½®è¯¢çš„è¯·æ±‚é›†åˆä¸­ response = nullï¼šå“åº”è®¾ç½®ä¸º null å†…éƒ¨çš„ callBack å°±ä¸ä¼šç»™å®¢æˆ·ç«¯å‘é€ä»»ä½•æ•°æ®ï¼Œä¸è¿›è¡Œé€šä¿¡ï¼Œå¦åˆ™å°±åˆå¼€å§‹é‡æ–°è¯·æ±‚ boolean storeOffsetEnableï¼šå…è®¸é•¿è½®è¯¢ã€sysFlag è¡¨ç¤ºæäº¤æ¶ˆè´¹è€…æœ¬åœ°è¯¥é˜Ÿåˆ—çš„offsetã€å½“å‰ broker èŠ‚ç‚¹è§’è‰²ä¸º master èŠ‚ç‚¹ä¸‰ä¸ªæ¡ä»¶æˆç«‹ï¼Œæ‰åœ¨ Broker ç«¯å­˜å‚¨æ¶ˆè´¹è€…ç»„å†…è¯¥ä¸»é¢˜çš„æŒ‡å®š queue çš„æ¶ˆè´¹è¿›åº¦ return responseï¼šè¿”å› responseï¼Œä¸ä¸º null æ—¶å¤–å±‚ processRequestCommand çš„ callback ä¼šå°†æ•°æ®å†™ç»™å®¢æˆ·ç«¯ é•¿è½®è¯¢PullRequestHoldService ç±»è´Ÿè´£é•¿è½®è¯¢ï¼ŒBrokerController#start æ–¹æ³•ä¸­è°ƒç”¨äº† this.pullRequestHoldService.start() å¯åŠ¨è¯¥æœåŠ¡ æ ¸å¿ƒæ–¹æ³•ï¼š run()ï¼šæ ¸å¿ƒè¿è¡Œæ–¹æ³• 123456789101112131415public void run() &#123; // å¾ªç¯è¿è¡Œ while (!this.isStopped()) &#123; if (this.brokerController.getBrokerConfig().isLongPollingEnable()) &#123; // æœåŠ¡å™¨å¼€å¯é•¿è½®è¯¢å¼€å…³ï¼šæ¯æ¬¡å¾ªç¯ä¼‘çœ 5ç§’ this.waitForRunning(5 * 1000); &#125; else &#123; // æœåŠ¡å™¨å…³é—­é•¿è½®è¯¢å¼€å…³ï¼šæ¯æ¬¡å¾ªç¯ä¼‘çœ 1ç§’ this.waitForRunning(...); &#125; // æ£€æŸ¥æŒæœ‰çš„è¯·æ±‚ this.checkHoldRequest(); // ..... &#125;&#125; checkHoldRequest()ï¼šæ£€æŸ¥æ‰€æœ‰çš„è¯·æ±‚ for (String key : this.pullRequestTable.keySet())ï¼šå¤„ç†æ‰€æœ‰çš„ topic@queueId çš„é€»è¾‘ String[] kArray = key.split(TOPIC_QUEUEID_SEPARATOR)ï¼škey æŒ‰ç…§ @ æ‹†åˆ†ï¼Œå¾—åˆ° topic å’Œ queueId long offset = this...getMaxOffsetInQueue(topic, queueId)ï¼š åˆ°å­˜å‚¨æ¨¡å—æŸ¥è¯¢è¯¥ ConsumeQueue çš„æœ€å¤§ offset this.notifyMessageArriving(topic, queueId, offset)ï¼šé€šçŸ¥æ¶ˆæ¯åˆ°è¾¾ notifyMessageArriving()ï¼šé€šçŸ¥æ¶ˆæ¯åˆ°è¾¾çš„é€»è¾‘ï¼ŒReputMessageService æ¶ˆæ¯åˆ†å‘æœåŠ¡ä¹Ÿä¼šè°ƒç”¨è¯¥æ–¹æ³• ManyPullRequest mpr = this.pullRequestTable.get(key)ï¼šè·å–å¯¹åº”çš„çš„ manyPullRequest å¯¹è±¡ List&lt;PullRequest&gt; requestListï¼šè·å–è¯¥é˜Ÿåˆ—ä¸‹çš„æ‰€æœ‰ PullRequestï¼Œå¹¶è¿›è¡Œéå† List&lt;PullRequest&gt; replayListï¼šå½“æŸä¸ª pullRequest ä¸è¶…æ—¶ï¼Œå¹¶ä¸”å¯¹åº”çš„ CQ.maxOffset &lt;= pullRequest.offsetï¼Œå°±å°†è¯¥ PullRequest å†æ”¾å…¥è¯¥åˆ—è¡¨ long newestOffsetï¼šè¯¥å€¼ä¸º CQ çš„ maxOffset if (newestOffset &gt; request.getPullFromThisOffset())ï¼šè¯·æ±‚å¯¹åº”çš„é˜Ÿåˆ—å†…å¯ä»¥ pull æ¶ˆæ¯äº†ï¼Œç»“æŸé•¿è½®è¯¢ boolean matchï¼šè¿›è¡Œè¿‡æ»¤åŒ¹é… this.brokerController...executeRequestWhenWakeup()ï¼šå°†æ»¡è¶³æ¡ä»¶çš„ pullRequest å†æ¬¡æäº¤åˆ°çº¿ç¨‹æ± å†…æ‰§è¡Œ final RemotingCommand responseï¼šæ‰§è¡Œ processRequest æ–¹æ³•ï¼Œå¹¶ä¸”ä¸ä¼šè§¦å‘é•¿è½®è¯¢ channel.writeAndFlush(response).addListene()ï¼šå°†ç»“æœæ•°æ®å‘é€ç»™å®¢æˆ·ç«¯ if (System.currentTimeMillis() &gt;= ...)ï¼šåˆ¤æ–­è¯¥ pullRequest æ˜¯å¦è¶…æ—¶ï¼Œè¶…æ—¶åçš„ä¹Ÿæ˜¯é‡æ–°æäº¤åˆ°çº¿ç¨‹æ± ï¼Œå¹¶ä¸”ä¸è¿›è¡Œé•¿è½®è¯¢ mpr.addPullRequest(replayList)ï¼šå°†æœªæ»¡è¶³æ¡ä»¶çš„ PullRequest å¯¹è±¡å†æ¬¡æ·»åŠ åˆ° ManyPullRequest å±æ€§ä¸­ ç»“æœç±»GetMessageResult ç±»æˆå‘˜ä¿¡æ¯ï¼š 123456789101112131415161718192021public class GetMessageResult &#123; // æŸ¥è¯¢æ¶ˆæ¯æ—¶ï¼Œæœ€åº•å±‚éƒ½æ˜¯ mappedFile æ”¯æŒçš„æŸ¥è¯¢ï¼ŒæŸ¥è¯¢æ—¶è¿”å›ç»™å¤–å±‚ä¸€ä¸ª SelectMappedBufferResultï¼Œ // mappedFile æ¯æŸ¥è¯¢ä¸€æ¬¡éƒ½ä¼š refCount++ ï¼Œé€šè¿‡SelectMappedBufferResultæŒæœ‰mappedFileï¼Œå®Œæˆèµ„æºé‡Šæ”¾çš„å¥æŸ„ private final List&lt;SelectMappedBufferResult&gt; messageMapedList = new ArrayList&lt;SelectMappedBufferResult&gt;(100); // è¯¥Listå†…å­˜å‚¨æ¶ˆæ¯ï¼Œæ¯ä¸€æ¡æ¶ˆæ¯éƒ½è¢«è½¬æˆ ByteBuffer è¡¨ç¤ºäº† private final List&lt;ByteBuffer&gt; messageBufferList = new ArrayList&lt;ByteBuffer&gt;(100); // æŸ¥è¯¢ç»“æœçŠ¶æ€ private GetMessageStatus status; // å®¢æˆ·ç«¯ä¸‹æ¬¡å†å‘å½“å‰Queueæ‹‰æ¶ˆæ¯æ—¶ï¼Œä½¿ç”¨çš„ offset private long nextBeginOffset; // å½“å‰queueæœ€å°offset private long minOffset; // å½“å‰queueæœ€å¤§offset private long maxOffset; // æ¶ˆæ¯æ€»byteå¤§å° private int bufferTotalSize = 0; // æœåŠ¡å™¨å»ºè®®å®¢æˆ·ç«¯ä¸‹æ¬¡åˆ°è¯¥ queue æ‹‰æ¶ˆæ¯æ—¶æ˜¯å¦ä½¿ç”¨ ã€ä»èŠ‚ç‚¹ã€‘ private boolean suggestPullingFromSlave = false;&#125; é˜Ÿåˆ—å¿«ç…§æˆå‘˜å±æ€§ProcessQueue ç±»æ˜¯æ¶ˆè´¹é˜Ÿåˆ—çš„å¿«ç…§ æˆå‘˜å˜é‡ï¼š å±æ€§å­—æ®µï¼š 1234567private final AtomicLong msgCount = new AtomicLong(); // é˜Ÿåˆ—ä¸­æ¶ˆæ¯æ•°é‡private final AtomicLong msgSize = new AtomicLong(); // æ¶ˆæ¯æ€»å¤§å°private volatile long queueOffsetMax = 0L; // å¿«ç…§ä¸­æœ€å¤§ offsetprivate volatile boolean dropped = false; // å¿«ç…§æ˜¯å¦ç§»é™¤private volatile long lastPullTimestamp = current; // ä¸Šä¸€æ¬¡æ‹‰æ¶ˆæ¯çš„æ—¶é—´private volatile long lastConsumeTimestamp = current; // ä¸Šä¸€æ¬¡æ¶ˆè´¹æ¶ˆæ¯çš„æ—¶é—´private volatile long lastLockTimestamp = current; // ä¸Šä¸€æ¬¡è·å–é”çš„æ—¶é—´ æ¶ˆæ¯å®¹å™¨ï¼škey æ˜¯æ¶ˆæ¯åç§»é‡ï¼Œval æ˜¯æ¶ˆæ¯ 1private final TreeMap&lt;Long, MessageExt&gt; msgTreeMap = new TreeMap&lt;Long, MessageExt&gt;(); é¡ºåºæ¶ˆè´¹ä¸´æ—¶å®¹å™¨ï¼š 1private final TreeMap&lt;Long, MessageExt&gt; consumingMsgOrderlyTreeMap = new TreeMap&lt;Long, MessageExt&gt;(); é”ï¼š 12private final ReadWriteLock lockTreeMap; // è¯»å†™é”private final Lock lockConsume; // é‡å…¥é”ï¼Œã€é¡ºåºæ¶ˆè´¹ä½¿ç”¨ã€‘ é¡ºåºæ¶ˆè´¹çŠ¶æ€ï¼š 12private volatile boolean locked = false; // æ˜¯å¦æ˜¯é”å®šçŠ¶æ€private volatile boolean consuming = false; // æ˜¯å¦æ˜¯æ¶ˆè´¹ä¸­ æˆå‘˜æ–¹æ³•æ ¸å¿ƒæˆå‘˜æ–¹æ³• putMessage()ï¼šå°† Broker æ‹‰å–ä¸‹æ¥çš„ msgs å­˜å‚¨åˆ°å¿«ç…§é˜Ÿåˆ—å†…ï¼Œè¿”å›ä¸º true è¡¨ç¤ºæäº¤é¡ºåºæ¶ˆè´¹ä»»åŠ¡ï¼Œfalse è¡¨ç¤ºä¸æäº¤ 1public boolean putMessage(final List&lt;MessageExt&gt; msgs) this.lockTreeMap.writeLock().lockInterruptibly()ï¼šè·å–å†™é” for (MessageExt msg : msgs)ï¼šéå† msgs å…¨éƒ¨åŠ å…¥ msgTreeMapï¼Œkey æ˜¯æ¶ˆæ¯çš„ queueOffset if (!msgTreeMap.isEmpty() &amp;&amp; !this.consuming)ï¼šæ¶ˆæ¯å®¹å™¨ä¸­å­˜åœ¨æœªå¤„ç†çš„æ¶ˆæ¯ï¼Œå¹¶ä¸”ä¸æ˜¯æ¶ˆè´¹ä¸­çš„çŠ¶æ€ dispatchToConsume = trueï¼šä»£è¡¨éœ€è¦æäº¤é¡ºåºæ¶ˆè´¹ä»»åŠ¡ this.consuming = trueï¼šè®¾ç½®ä¸ºé¡ºåºæ¶ˆè´¹æ‰§è¡Œä¸­çš„çŠ¶æ€ this.lockTreeMap.writeLock().unlock()ï¼šé‡Šæ”¾å†™é” removeMessage()ï¼šç§»é™¤å·²ç»æ¶ˆè´¹çš„æ¶ˆæ¯ï¼Œå‚æ•°æ˜¯å·²ç»æ¶ˆè´¹çš„æ¶ˆæ¯é›†åˆï¼Œå¹¶å‘æ¶ˆè´¹ä½¿ç”¨ 1public long removeMessage(final List&lt;MessageExt&gt; msgs) long result = -1ï¼šç»“æœåˆå§‹åŒ–ä¸º -1 this.lockTreeMap.writeLock().lockInterruptibly()ï¼šè·å–å†™é” this.lastConsumeTimestamp = nowï¼šæ›´æ–°ä¸Šä¸€æ¬¡æ¶ˆè´¹æ¶ˆæ¯çš„æ—¶é—´ä¸ºç°åœ¨ if (!msgTreeMap.isEmpty())ï¼šåˆ¤æ–­æ¶ˆæ¯å®¹å™¨æ˜¯å¦æ˜¯ç©ºï¼Œæ˜¯ç©ºç›´æ¥è¿”å› -1 result = this.queueOffsetMax + 1ï¼šè®¾ç½®ç»“æœï¼Œåˆ é™¤å®Œåæ¶ˆæ¯å®¹å™¨ä¸ºç©ºæ—¶è¿”å› for (MessageExt msg : msgs)ï¼šå°†å·²ç»æ¶ˆè´¹çš„æ¶ˆæ¯å…¨éƒ¨ä» msgTreeMap ç§»é™¤ if (!msgTreeMap.isEmpty())ï¼šç§»é™¤åå®¹å™¨å†…è¿˜æœ‰å¾…æ¶ˆè´¹çš„æ¶ˆæ¯ï¼Œè·å–ç¬¬ä¸€æ¡æ¶ˆæ¯ offset è¿”å› this.lockTreeMap.writeLock().unlock()ï¼šé‡Šæ”¾å†™é” takeMessages()ï¼šè·å–ä¸€æ‰¹æ¶ˆæ¯ï¼Œé¡ºåºæ¶ˆè´¹ä½¿ç”¨ 1public List&lt;MessageExt&gt; takeMessages(final int batchSize) this.lockTreeMap.writeLock().lockInterruptibly()ï¼šè·å–å†™é” this.lastConsumeTimestamp = nowï¼šæ›´æ–°ä¸Šä¸€æ¬¡æ¶ˆè´¹æ¶ˆæ¯çš„æ—¶é—´ä¸ºç°åœ¨ for (int i = 0; i &lt; batchSize; i++)ï¼šä»å¤´èŠ‚ç‚¹å¼€å§‹è·å–æ¶ˆæ¯ result.add(entry.getValue())ï¼šå°†æ¶ˆæ¯æ”¾å…¥ç»“æœé›†åˆ consumingMsgOrderlyTreeMap.put()ï¼šå°†æ¶ˆæ¯åŠ å…¥é¡ºåºæ¶ˆè´¹å®¹å™¨ä¸­ if (result.isEmpty())ï¼šæ¡ä»¶æˆç«‹è¯´æ˜é¡ºåºæ¶ˆè´¹å®¹å™¨æœ¬åœ°å¿«ç…§å†…çš„æ¶ˆæ¯å…¨éƒ¨å¤„ç†å®Œäº†ï¼Œå½“å‰é¡ºåºæ¶ˆè´¹ä»»åŠ¡éœ€è¦åœæ­¢ consuming = falseï¼šæ¶ˆè´¹çŠ¶æ€ç½®ä¸º false this.lockTreeMap.writeLock().unlock()ï¼šé‡Šæ”¾å†™é” commit()ï¼šå¤„ç†å®Œä¸€æ‰¹æ¶ˆæ¯åè°ƒç”¨ï¼Œé¡ºåºæ¶ˆè´¹ä½¿ç”¨ 1public long commit() this.lockTreeMap.writeLock().lockInterruptibly()ï¼šè·å–å†™é” Long offset = this.consumingMsgOrderlyTreeMap.lastKey()ï¼šè·å–é¡ºåºæ¶ˆè´¹ä¸´æ—¶å®¹å™¨æœ€åä¸€æ¡æ•°æ®çš„ key msgCount, msgSizeï¼šæ›´æ–°é¡ºåºæ¶ˆè´¹ç›¸å…³çš„å­—æ®µ this.consumingMsgOrderlyTreeMap.clear()ï¼šæ¸…ç©ºé¡ºåºæ¶ˆè´¹å®¹å™¨çš„æ•°æ® return offset + 1ï¼šæ¶ˆè´¹è€…ä¸‹ä¸€æ¡æ¶ˆè´¹çš„ä½ç‚¹ this.lockTreeMap.writeLock().unlock()ï¼šé‡Šæ”¾å†™é” cleanExpiredMsg()ï¼šæ¸…é™¤è¿‡æœŸæ¶ˆæ¯ 1public void cleanExpiredMsg(DefaultMQPushConsumer pushConsumer) if (pushConsumer.getDefaultMQPushConsumerImpl().isConsumeOrderly()) ï¼šé¡ºåºæ¶ˆè´¹ä¸æ‰§è¡Œè¿‡æœŸæ¸…ç†é€»è¾‘ int loop = msgTreeMap.size() &lt; 16 ? msgTreeMap.size() : 16ï¼šæœ€å¤šå¾ªç¯ 16 æ¬¡ if (!msgTreeMap.isEmpty() &amp;&amp;)ï¼šå¦‚æœå®¹å™¨ä¸­ç¬¬ä¸€æ¡æ¶ˆæ¯çš„æ¶ˆè´¹å¼€å§‹æ—¶é—´ä¸å½“å‰ç³»ç»Ÿæ—¶é—´å·®å€¼ &gt; 15minï¼Œåˆ™å–å‡ºè¯¥æ¶ˆæ¯ elseï¼šç›´æ¥è·³å‡ºå¾ªç¯ï¼Œå› ä¸ºå¿«ç…§é˜Ÿåˆ—å†…çš„æ¶ˆæ¯æ˜¯æœ‰é¡ºåºçš„ï¼Œç¬¬ä¸€æ¡æ¶ˆæ¯ä¸è¿‡æœŸï¼Œå…¶ä»–æ¶ˆæ¯éƒ½ä¸è¿‡æœŸ pushConsumer.sendMessageBack(msg, 3)ï¼šæ¶ˆæ¯å›é€€åˆ°æœåŠ¡å™¨ï¼Œè®¾ç½®è¯¥æ¶ˆæ¯çš„å»¶è¿Ÿçº§åˆ«ä¸º 3 if (!msgTreeMap.isEmpty() &amp;&amp; msg.getQueueOffset() == msgTreeMap.firstKey())ï¼šæ¡ä»¶æˆç«‹è¯´æ˜æ¶ˆæ¯å›é€€æœŸé—´ï¼Œè¯¥ç›®æ ‡æ¶ˆæ¯å¹¶æ²¡æœ‰è¢«æ¶ˆè´¹ä»»åŠ¡æˆåŠŸæ¶ˆè´¹ removeMessage(Collections.singletonList(msg))ï¼šä» treeMap å°†è¯¥å›é€€æˆåŠŸçš„ msg åˆ é™¤ å¹¶å‘æ¶ˆè´¹æˆå‘˜å±æ€§ConsumeMessageConcurrentlyService è´Ÿè´£å¹¶å‘æ¶ˆè´¹æœåŠ¡ æˆå‘˜å˜é‡ï¼š æ¶ˆæ¯ç›‘å¬å™¨ï¼šå°è£…å¤„ç†æ¶ˆæ¯çš„é€»è¾‘ï¼Œè¯¥ç›‘å¬å™¨ç”±å¼€å‘è€…å®ç°ï¼Œå¹¶æ³¨å†Œåˆ° defaultMQPushConsumer 1private final MessageListenerConcurrently messageListener; æ¶ˆè´¹å±æ€§ï¼š 12private final BlockingQueue&lt;Runnable&gt; consumeRequestQueue; // æ¶ˆè´¹ä»»åŠ¡é˜Ÿåˆ—private final String consumerGroup; // æ¶ˆè´¹è€…ç»„ çº¿ç¨‹æ± ï¼š 123private final ThreadPoolExecutor consumeExecutor; // æ¶ˆè´¹ä»»åŠ¡çº¿ç¨‹æ± ï¼Œé»˜è®¤ 20private final ScheduledExecutorService scheduledExecutorService;// è°ƒåº¦çº¿ç¨‹æ± ï¼Œå»¶è¿Ÿæäº¤æ¶ˆè´¹ä»»åŠ¡private final ScheduledExecutorService cleanExpireMsgExecutors; // æ¸…ç†è¿‡æœŸæ¶ˆæ¯ä»»åŠ¡çº¿ç¨‹æ± ï¼Œ15min ä¸€æ¬¡ æˆå‘˜æ–¹æ³•ConsumeMessageConcurrentlyService å¹¶å‘æ¶ˆè´¹æ ¸å¿ƒæ–¹æ³• start()ï¼šå¯åŠ¨æ¶ˆè´¹æœåŠ¡ï¼ŒDefaultMQPushConsumerImpl å¯åŠ¨æ—¶ä¼šè°ƒç”¨è¯¥æ–¹æ³• 12345public void start() &#123; // æäº¤â€œæ¸…ç†è¿‡æœŸæ¶ˆæ¯ä»»åŠ¡â€ä»»åŠ¡ï¼Œå»¶è¿Ÿ15minä¹‹åæ‰§è¡Œï¼Œä¹‹åæ¯15minæ‰§è¡Œä¸€æ¬¡ this.cleanExpireMsgExecutors.scheduleAtFixedRate(() -&gt; cleanExpireMsg()&#125;, 15, 15, TimeUnit.MINUTES);&#125; cleanExpireMsg()ï¼šæ¸…ç†è¿‡æœŸæ¶ˆæ¯ä»»åŠ¡ 1private void cleanExpireMsg() Iterator&lt;Map.Entry&lt;MessageQueue, ProcessQueue&gt;&gt; it ï¼šè·å–åˆ†é…ç»™å½“å‰æ¶ˆè´¹è€…çš„é˜Ÿåˆ— while (it.hasNext())ï¼šéå†æ‰€æœ‰çš„é˜Ÿåˆ— pq.cleanExpiredMsg(this.defaultMQPushConsumer)ï¼šè°ƒç”¨é˜Ÿåˆ—å¿«ç…§ ProcessQueue æ¸…ç†è¿‡æœŸæ¶ˆæ¯çš„æ–¹æ³• submitConsumeRequest()ï¼šæäº¤æ¶ˆè´¹è¯·æ±‚ 12345// å‚æ•°ä¸€ï¼šä»æœåŠ¡å™¨ pull ä¸‹æ¥çš„è¿™æ‰¹æ¶ˆæ¯// å‚æ•°äºŒï¼šæ¶ˆæ¯å½’å± mq åœ¨æ¶ˆè´¹è€…ç«¯çš„ processQueueï¼Œæäº¤æ¶ˆè´¹ä»»åŠ¡ä¹‹å‰ï¼Œmsgså·²ç»åŠ å…¥åˆ°è¯¥pqå†…äº†// å‚æ•°ä¸‰ï¼šæ¶ˆæ¯å½’å±é˜Ÿåˆ—// å‚æ•°å››ï¼šå¹¶å‘æ¶ˆæ¯æ­¤å‚æ•°æ— æ•ˆpublic void submitConsumeRequest(List&lt;MessageExt&gt; msgs, ProcessQueue processQueue, MessageQueue messageQueue, boolean dispatchToConsume) final int consumeBatchSizeï¼šä¸€ä¸ªæ¶ˆè´¹ä»»åŠ¡å¯æ¶ˆè´¹çš„æ¶ˆæ¯æ•°é‡ï¼Œé»˜è®¤ä¸º 1 if (msgs.size() &lt;= consumeBatchSize)ï¼šåˆ¤æ–­ä¸€ä¸ªæ¶ˆè´¹ä»»åŠ¡æ˜¯å¦å¯ä»¥æäº¤ ConsumeRequest consumeRequestï¼šå°è£…ä¸ºæ¶ˆè´¹è¯·æ±‚ this.consumeExecutor.submit(consumeRequest)ï¼šæäº¤æ¶ˆè´¹ä»»åŠ¡ï¼Œå¼‚æ­¥æ‰§è¡Œæ¶ˆæ¯çš„å¤„ç† elseï¼šè¯´æ˜æ¶ˆæ¯è¾ƒå¤šï¼Œéœ€è¦å¤šä¸ªæ¶ˆè´¹ä»»åŠ¡ for (int total = 0; total &lt; msgs.size(); )ï¼šå°†æ¶ˆæ¯æ‹†åˆ†æˆå¤šä¸ªæ¶ˆè´¹ä»»åŠ¡ processConsumeResult()ï¼šå¤„ç†æ¶ˆè´¹ç»“æœ 12// å‚æ•°ä¸€ï¼šæ¶ˆè´¹ç»“æœçŠ¶æ€ï¼› å‚æ•°äºŒï¼šæ¶ˆè´¹ä¸Šä¸‹æ–‡ï¼› å‚æ•°ä¸‰ï¼šå½“å‰æ¶ˆè´¹ä»»åŠ¡public void processConsumeResult(status, context, consumeRequest) switch (status)ï¼šæ ¹æ®æ¶ˆè´¹ç»“æœçŠ¶æ€è¿›è¡Œå¤„ç† case CONSUME_SUCCESSï¼šæ¶ˆè´¹æˆåŠŸ if (ackIndex &gt;= consumeRequest.getMsgs().size())ï¼šæ¶ˆè´¹æˆåŠŸçš„è¯ï¼ŒackIndex è®¾ç½®æˆ æ¶ˆè´¹æ¶ˆæ¯æ•° - 1 çš„å€¼ï¼Œæ¯”å¦‚æœ‰ 5 æ¡æ¶ˆæ¯ï¼Œè¿™é‡Œå°±è®¾ç½®ä¸º 4 ok, failedï¼šok è®¾ç½®ä¸ºæ¶ˆæ¯æ•°é‡ï¼Œfailed è®¾ç½®ä¸º 0 case RECONSUME_LATERï¼šæ¶ˆè´¹å¤±è´¥ ackIndex = -1ï¼šè®¾ç½®ä¸º -1 switch (this.defaultMQPushConsumer.getMessageModel())ï¼šåˆ¤æ–­æ¶ˆè´¹æ¨¡å¼ï¼Œé»˜è®¤æ˜¯é›†ç¾¤æ¨¡å¼ for (int i = ackIndex + 1; i &lt; msgs.size(); i++)ï¼šå½“æ¶ˆè´¹å¤±è´¥æ—¶ ackIndex ä¸º -1ï¼Œi çš„èµ·å§‹å€¼ä¸º 0ï¼Œè¯¥æ¶ˆè´¹ä»»åŠ¡å†…çš„å…¨éƒ¨æ¶ˆæ¯éƒ½ä¼šå°è¯•å›é€€ç»™æœåŠ¡å™¨ MessageExt msgï¼šæå–ä¸€æ¡æ¶ˆæ¯ boolean result = this.sendMessageBack(msg, context)ï¼šå‘é€æ¶ˆæ¯å›é€€ï¼ŒåŒæ­¥å‘é€ if (!result)ï¼šå›é€€å¤±è´¥çš„æ¶ˆæ¯ï¼Œå°†æ¶ˆæ¯çš„é‡è¯•å±æ€§åŠ  1ï¼Œå¹¶åŠ å…¥åˆ°å›é€€å¤±è´¥çš„é›†åˆ if (!msgBackFailed.isEmpty())ï¼šå›é€€å¤±è´¥é›†åˆä¸ä¸ºç©º consumeRequest.getMsgs().removeAll(msgBackFailed)ï¼šå°†å›é€€å¤±è´¥çš„æ¶ˆæ¯ä»å½“å‰æ¶ˆè´¹ä»»åŠ¡çš„ msgs é›†åˆå†…ç§»é™¤ this.submitConsumeRequestLater()ï¼šå›é€€å¤±è´¥çš„æ¶ˆæ¯ä¼šå†æ¬¡æäº¤æ¶ˆè´¹ä»»åŠ¡ï¼Œå»¶è¿Ÿ 5 ç§’é’Ÿåå†æ¬¡å°è¯•æ¶ˆè´¹ long offset = ...removeMessage(msgs)ï¼šä» pq ä¸­åˆ é™¤å·²ç»æ¶ˆè´¹æˆåŠŸçš„æ¶ˆæ¯ï¼Œè¿”å› offset this...getOffsetStore().updateOffset()ï¼šæ›´æ–°æ¶ˆè´¹è€…æœ¬åœ°è¯¥ mq çš„æ¶ˆè´¹è¿›åº¦ æ¶ˆè´¹è¯·æ±‚ConsumeRequest æ˜¯ ConsumeMessageConcurrentlyService çš„å†…éƒ¨ç±»ï¼Œæ˜¯ä¸€ä¸ª Runnable ä»»åŠ¡å¯¹è±¡ æˆå‘˜å˜é‡ï¼š åˆ†é…åˆ°è¯¥æ¶ˆè´¹ä»»åŠ¡çš„æ¶ˆæ¯ï¼š 1private final List&lt;MessageExt&gt; msgs; æ¶ˆæ¯é˜Ÿåˆ—ï¼š 12private final ProcessQueue processQueue; // æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—private final MessageQueue messageQueue; // æ¶ˆæ¯é˜Ÿåˆ— æ ¸å¿ƒæ–¹æ³•ï¼š run()ï¼šæ‰§è¡Œä»»åŠ¡ 1public void run() if (this.processQueue.isDropped())ï¼šæ¡ä»¶æˆç«‹è¯´æ˜è¯¥ queue ç»è¿‡ rbl ç®—æ³•åˆ†é…åˆ°å…¶ä»–çš„ consumer MessageListenerConcurrently listenerï¼šè·å–æ¶ˆæ¯ç›‘å¬å™¨ ConsumeConcurrentlyContext contextï¼šåˆ›å»ºæ¶ˆè´¹ä¸Šä¸‹æ–‡å¯¹è±¡ defaultMQPushConsumerImpl.resetRetryAndNamespace()ï¼šé‡ç½®é‡è¯•æ ‡è®° final String groupTopicï¼šè·å–å½“å‰æ¶ˆè´¹è€…ç»„çš„é‡è¯•ä¸»é¢˜ %RETRY%GroupName for (MessageExt msg : msgs)ï¼šéå†æ‰€æœ‰çš„æ¶ˆæ¯ String retryTopic = msg.getProperty(...)ï¼šåŸä¸»é¢˜ï¼Œä¸€èˆ¬æ¶ˆæ¯æ²¡æœ‰è¯¥å±æ€§ï¼Œåªæœ‰è¢«é‡å¤æ¶ˆè´¹çš„æ¶ˆæ¯æ‰æœ‰ if (retryTopic != null &amp;&amp; groupTopic.equals(...))ï¼šæ¡ä»¶æˆç«‹è¯´æ˜è¯¥æ¶ˆæ¯æ˜¯è¢«é‡å¤æ¶ˆè´¹çš„æ¶ˆæ¯ msg.setTopic(retryTopic)ï¼šå°†è¢«é‡å¤æ¶ˆè´¹çš„æ¶ˆæ¯ä¸»é¢˜ä¿®æ”¹å›åŸä¸»é¢˜ if (ConsumeMessageConcurrentlyService...hasHook())ï¼šå‰ç½®å¤„ç† boolean hasException = falseï¼šæ¶ˆè´¹è¿‡ç¨‹ä¸­ï¼Œæ˜¯å¦å‘å¤–æŠ›å‡ºå¼‚å¸¸ MessageAccessor.setConsumeStartTimeStamp()ï¼šç»™æ¯æ¡æ¶ˆæ¯è®¾ç½®æ¶ˆè´¹å¼€å§‹æ—¶é—´ status = listener.consumeMessage(Collections.unmodifiableList(msgs), context)ï¼šæ¶ˆè´¹æ¶ˆæ¯ if (ConsumeMessageConcurrentlyService...hasHook())ï¼šåç½®å¤„ç† ...processConsumeResult(status, context, this)ï¼šå¤„ç†æ¶ˆè´¹ç»“æœ é¡ºåºæ¶ˆè´¹æˆå‘˜å±æ€§ConsumeMessageOrderlyService è´Ÿè´£é¡ºåºæ¶ˆè´¹æœåŠ¡ æˆå‘˜å˜é‡ï¼š æ¶ˆæ¯ç›‘å¬å™¨ï¼šå°è£…å¤„ç†æ¶ˆæ¯çš„é€»è¾‘ï¼Œè¯¥ç›‘å¬å™¨ç”±å¼€å‘è€…å®ç°ï¼Œå¹¶æ³¨å†Œåˆ° defaultMQPushConsumer 1private final MessageListenerOrderly messageListener; æ¶ˆè´¹å±æ€§ï¼š 123private final BlockingQueue&lt;Runnable&gt; consumeRequestQueue; // æ¶ˆè´¹ä»»åŠ¡é˜Ÿåˆ—private final String consumerGroup; // æ¶ˆè´¹è€…ç»„private volatile boolean stopped = false; // æ¶ˆè´¹åœæ­¢çŠ¶æ€ çº¿ç¨‹æ± ï¼š 12private final ThreadPoolExecutor consumeExecutor; // æ¶ˆè´¹ä»»åŠ¡çº¿ç¨‹æ± private final ScheduledExecutorService scheduledExecutorService;// è°ƒåº¦çº¿ç¨‹æ± ï¼Œå»¶è¿Ÿæäº¤æ¶ˆè´¹ä»»åŠ¡ é˜Ÿåˆ—é”ï¼šæ¶ˆè´¹è€…æœ¬åœ° MQ é”ï¼Œç¡®ä¿æœ¬åœ°å¯¹äºéœ€è¦é¡ºåºæ¶ˆè´¹çš„ MQ åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªä»»åŠ¡åœ¨æ‰§è¡Œ 1private final MessageQueueLock messageQueueLock = new MessageQueueLock(); 123456789101112131415public class MessageQueueLock &#123; private ConcurrentMap&lt;MessageQueue, Object&gt; mqLockTable = new ConcurrentHashMap&lt;MessageQueue, Object&gt;(); // è·å–æœ¬åœ°é˜Ÿåˆ—é”å¯¹è±¡ public Object fetchLockObject(final MessageQueue mq) &#123; Object objLock = this.mqLockTable.get(mq); if (null == objLock) &#123; objLock = new Object(); Object prevLock = this.mqLockTable.putIfAbsent(mq, objLock); if (prevLock != null) &#123; objLock = prevLock; &#125; &#125; return objLock; &#125;&#125; å·²ç»è·å–äº† Broker ç«¯è¯¥ Queue çš„ç‹¬å é”ï¼Œä¸ºä»€ä¹ˆè¿˜è¦è·å–æœ¬åœ°é˜Ÿåˆ—é”å¯¹è±¡ï¼Ÿï¼ˆè¿™é‡Œæˆ‘ä¹Ÿæ²¡å¤ªæ‡‚ï¼Œå…ˆè®°å½•ä¸‹æ¥ï¼Œæœ¬åœ°å¤šçº¿ç¨‹ï¼Ÿï¼‰ Broker queue å ç”¨é”çš„è§’åº¦æ˜¯ Client å ç”¨ï¼ŒClient ä» Broker çš„æŸä¸ªå ç”¨äº†é”çš„ queue æ‹‰å–ä¸‹æ¥æ¶ˆæ¯ä»¥åï¼Œå°†æ¶ˆæ¯å­˜å‚¨åˆ°æ¶ˆè´¹è€…æœ¬åœ°çš„ ProcessQueue ä¸­ï¼Œå¿«ç…§å¯¹è±¡çš„ consuming å±æ€§ç½®ä¸º trueï¼Œè¡¨ç¤ºæœ¬åœ°çš„é˜Ÿåˆ—æ­£åœ¨æ¶ˆè´¹å¤„ç†ä¸­ ProcessQueue è°ƒç”¨ takeMessages æ–¹æ³•æ—¶ä¼šè·å–ä¸‹ä¸€æ‰¹å¾…å¤„ç†çš„æ¶ˆæ¯ï¼Œè·å–ä¸åˆ°ä¼šä¿®æ”¹ consuming = falseï¼Œæœ¬æ¶ˆè´¹ä»»åŠ¡é©¬ä¸Šåœæ­¢ã€‚ å¦‚æœæ­¤æ—¶ Pull å†æ¬¡æ‹‰å–ä¸€æ‰¹å½“å‰ ProcessQueue çš„ msgï¼Œä¼šå†æ¬¡å‘é¡ºåºæ¶ˆè´¹æœåŠ¡æäº¤æ¶ˆè´¹ä»»åŠ¡ï¼Œæ­¤æ—¶éœ€è¦æœ¬åœ°é˜Ÿåˆ—é”å¯¹è±¡åŒæ­¥æœ¬åœ°çº¿ç¨‹ æˆå‘˜æ–¹æ³• start()ï¼šå¯åŠ¨æ¶ˆè´¹æœåŠ¡ï¼ŒDefaultMQPushConsumerImpl å¯åŠ¨æ—¶ä¼šè°ƒç”¨è¯¥æ–¹æ³• 1public void start() this.scheduledExecutorService.scheduleAtFixedRate()ï¼šæäº¤é”ç»­çº¦ä»»åŠ¡ï¼Œå»¶è¿Ÿ 1 ç§’æ‰§è¡Œï¼Œå‘¨æœŸä¸º 20 ç§’é’Ÿ ConsumeMessageOrderlyService.this.lockMQPeriodically()ï¼šé”ç»­çº¦ä»»åŠ¡ this.defaultMQPushConsumerImpl.getRebalanceImpl().lockAll()ï¼šå¯¹æ¶ˆè´¹è€…çš„æ‰€æœ‰é˜Ÿåˆ—è¿›è¡Œç»­çº¦ submitConsumeRequest()ï¼šæäº¤æ¶ˆè´¹ä»»åŠ¡è¯·æ±‚ 12345678// å‚æ•°ï¼štrue è¡¨ç¤ºåˆ›å»ºæ¶ˆè´¹ä»»åŠ¡å¹¶æäº¤ï¼Œfalseä¸åˆ›å»ºæ¶ˆè´¹ä»»åŠ¡ï¼Œè¯´æ˜æ¶ˆè´¹è€…æœ¬åœ°å·²ç»æœ‰æ¶ˆè´¹ä»»åŠ¡åœ¨æ‰§è¡Œäº†public void submitConsumeRequest(...., final boolean dispathToConsume) &#123; if (dispathToConsume) &#123; // å½“å‰è¿›ç¨‹å†…ä¸å­˜åœ¨ é¡ºåºæ¶ˆè´¹ä»»åŠ¡ï¼Œåˆ›å»ºæ–°çš„æ¶ˆè´¹ä»»åŠ¡ï¼Œã€æäº¤åˆ°æ¶ˆè´¹ä»»åŠ¡çº¿ç¨‹æ± ã€‘ ConsumeRequest consumeRequest = new ConsumeRequest(processQueue, messageQueue); this.consumeExecutor.submit(consumeRequest); &#125;&#125; processConsumeResult()ï¼šæ¶ˆè´¹ç»“æœå¤„ç† 1234// å‚æ•°1ï¼šmsgs æœ¬è½®å¾ªç¯æ¶ˆè´¹çš„æ¶ˆæ¯é›†åˆ å‚æ•°2ï¼šstatus æ¶ˆè´¹çŠ¶æ€// å‚æ•°3ï¼šcontext æ¶ˆè´¹ä¸Šä¸‹æ–‡ å‚æ•°4ï¼šæ¶ˆè´¹ä»»åŠ¡// è¿”å›å€¼ï¼šboolean å†³å®šæ˜¯å¦ç»§ç»­å¾ªç¯å¤„ç†pqå†…çš„æ¶ˆæ¯public boolean processConsumeResult(final List&lt;MessageExt&gt; msgs, final ConsumeOrderlyStatus status, final ConsumeOrderlyContext context, final ConsumeRequest consumeRequest) if (context.isAutoCommit()) ï¼šé»˜è®¤è‡ªåŠ¨æäº¤ switch (status)ï¼šæ ¹æ®æ¶ˆè´¹çŠ¶æ€è¿›è¡Œä¸åŒçš„å¤„ç† case SUCCESSï¼šæ¶ˆè´¹æˆåŠŸ commitOffset = ...commit()ï¼šè°ƒç”¨ pq æäº¤æ–¹æ³•ï¼Œä¼šå°†æœ¬æ¬¡å¾ªç¯å¤„ç†çš„æ¶ˆæ¯ä»é¡ºåºæ¶ˆè´¹ map åˆ é™¤ï¼Œå¹¶ä¸”è¿”å›æ¶ˆæ¯è¿›åº¦ case SUSPEND_CURRENT_QUEUE_A_MOMENTï¼šæŒ‚èµ·å½“å‰é˜Ÿåˆ— consumeRequest.getProcessQueue().makeMessageToConsumeAgain(msgs)ï¼šå›æ»šæ¶ˆæ¯ for (MessageExt msg : msgs)ï¼šéå†æ‰€æœ‰çš„æ¶ˆæ¯ this.consumingMsgOrderlyTreeMap.remove(msg.getQueueOffset())ï¼šä»é¡ºåºæ¶ˆè´¹ä¸´æ—¶å®¹å™¨ä¸­ç§»é™¤ this.msgTreeMap.put(msg.getQueueOffset(), msg)ï¼šæ·»åŠ åˆ°æ¶ˆæ¯å®¹å™¨ this.submitConsumeRequestLater()ï¼šå†æ¬¡æäº¤æ¶ˆè´¹ä»»åŠ¡ï¼Œ1 ç§’åæ‰§è¡Œ continueConsume = falseï¼šè®¾ç½®ä¸º falseï¼Œå¤–å±‚ä¼šé€€å‡ºæœ¬æ¬¡çš„æ¶ˆè´¹ä»»åŠ¡ this.defaultMQPushConsumerImpl.getOffsetStore().updateOffset(...)ï¼šæ›´æ–°æœ¬åœ°æ¶ˆè´¹è¿›åº¦ æ¶ˆè´¹è¯·æ±‚ConsumeRequest æ˜¯ ConsumeMessageOrderlyService çš„å†…éƒ¨ç±»ï¼Œæ˜¯ä¸€ä¸ª Runnable ä»»åŠ¡å¯¹è±¡ æ ¸å¿ƒæ–¹æ³•ï¼š run()ï¼šæ‰§è¡Œä»»åŠ¡ 1public void run() final Object objLockï¼šè·å–æœ¬åœ°é”å¯¹è±¡ synchronized (objLock)ï¼šæœ¬åœ°é˜Ÿåˆ—é”ï¼Œç¡®ä¿æ¯ä¸ª MQ çš„æ¶ˆè´¹ä»»åŠ¡åªæœ‰ä¸€ä¸ªåœ¨æ‰§è¡Œï¼Œç¡®ä¿é¡ºåºæ¶ˆè´¹ if(.. || (this.processQueue.isLocked() &amp;&amp; !this.processQueue.isLockExpired())))ï¼šå½“å‰é˜Ÿåˆ—æŒæœ‰åˆ†å¸ƒå¼é”ï¼Œå¹¶ä¸”é”æœªè¿‡æœŸï¼ŒæŒé”æ—¶é—´è¶…è¿‡ 30 ç§’ç®—è¿‡æœŸ final long beginTimeï¼šæ¶ˆè´¹å¼€å§‹æ—¶é—´ for (boolean continueConsume = true; continueConsume; )ï¼šæ ¹æ®æ˜¯å¦ç»§ç»­æ¶ˆè´¹çš„æ ‡è®°åˆ¤æ–­æ˜¯å¦ç»§ç»­ final int consumeBatchSizeï¼šè·å–æ¯æ¬¡å¾ªç¯å¤„ç†çš„æ¶ˆæ¯æ•°é‡ï¼Œä¸€èˆ¬æ˜¯ 1 List&lt;MessageExt&gt; msgs = this...takeMessages(consumeBatchSize)ï¼šåˆ°å¤„ç†é˜Ÿåˆ—è·å–ä¸€æ‰¹æ¶ˆæ¯ if (!msgs.isEmpty())ï¼šè·å–åˆ°äº†å¾…æ¶ˆè´¹çš„æ¶ˆæ¯ final ConsumeOrderlyContext contextï¼šåˆ›å»ºæ¶ˆè´¹ä¸Šä¸‹æ–‡å¯¹è±¡ this.processQueue.getLockConsume().lock()ï¼šè·å– lockConsume é”ï¼Œä¸ RBL çº¿ç¨‹åŒæ­¥ä½¿ç”¨ status = messageListener.consumeMessage(...)ï¼šç›‘å¬å™¨å¤„ç†æ¶ˆæ¯ this.processQueue.getLockConsume().unlock()ï¼šé‡Šæ”¾ lockConsume é” if (null == status)ï¼šå¤„ç†æ¶ˆæ¯çŠ¶æ€è¿”å› nullï¼Œè®¾ç½®çŠ¶æ€ä¸ºæŒ‚èµ·å½“å‰é˜Ÿåˆ— continueConsume = ...processConsumeResult()ï¼šæ¶ˆè´¹ç»“æœå¤„ç† elseï¼šè·å–åˆ°çš„æ¶ˆæ¯æ˜¯ç©º continueConsume = falseï¼šç»“æŸä»»åŠ¡å¾ªç¯ elseï¼šå½“å‰é˜Ÿåˆ—æœªæŒæœ‰åˆ†å¸ƒå¼é”ï¼Œæˆ–è€…é”è¿‡æœŸ ConsumeMessageOrderlyService.this.tryLockLaterAndReconsume()ï¼šé‡æ–°æäº¤ä»»åŠ¡ï¼Œæ ¹æ®æ˜¯å¦è·å–åˆ°é˜Ÿåˆ—é”ï¼Œé€‰æ‹©å»¶è¿Ÿ 10 æ¯«ç§’æˆ–è€… 300 æ¯«ç§’ ç”Ÿäº§æ¶ˆè´¹ç”Ÿäº§æµç¨‹ï¼š é¦–å…ˆè·å–å½“å‰æ¶ˆæ¯ä¸»é¢˜çš„å‘å¸ƒä¿¡æ¯ï¼Œè·å–ä¸åˆ°å» Namesrv è·å–ï¼ˆé»˜è®¤æœ‰ TBW102ï¼‰ï¼Œå¹¶å°†è·å–çš„åˆ°çš„è·¯ç”±æ•°æ®è½¬åŒ–ä¸ºå‘å¸ƒæ•°æ®ï¼Œåˆ›å»º MQ é˜Ÿåˆ—åœ¨å¤šä¸ª Broker ç»„ï¼ˆä¸€ç»„ä»£è¡¨ä¸€ä¸»å¤šä»çš„ Broker æ¶æ„ï¼‰ï¼Œå®¢æˆ·ç«¯å®ä¾‹åŒæ ·æ›´æ–°è®¢é˜…æ•°æ®ï¼Œåˆ›å»º MQ é˜Ÿåˆ—ï¼Œæ”¾å…¥è´Ÿè½½å‡è¡¡æœåŠ¡ topicSubscribeInfoTable ä¸­ ç„¶åä»å‘å¸ƒæ•°æ®ä¸­é€‰æ‹©ä¸€ä¸ª MQ é˜Ÿåˆ—å‘é€æ¶ˆæ¯ Broker ç«¯é€šè¿‡ SendMessageProcessor å¯¹å‘é€çš„æ¶ˆæ¯è¿›è¡ŒæŒä¹…åŒ–å¤„ç†ï¼Œå­˜å‚¨åˆ° CommitLogã€‚å°†é‡è¯•æ¬¡æ•°è¿‡å¤šçš„æ¶ˆæ¯åŠ å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼Œå°†å»¶è¿Ÿæ¶ˆæ¯çš„ä¸»é¢˜å’Œé˜Ÿåˆ—ä¿®æ”¹ä¸ºè°ƒåº¦ä¸»é¢˜å’Œè°ƒåº¦é˜Ÿåˆ— ID Broker å¯åŠ¨ ScheduleMessageService æœåŠ¡ä¼šä¸ºæ¯ä¸ªå»¶è¿Ÿçº§åˆ«åˆ›å»ºä¸€ä¸ªå»¶è¿Ÿä»»åŠ¡ï¼Œè®©å»¶è¿Ÿæ¶ˆæ¯å¾—åˆ°æœ‰æ•ˆçš„å¤„ç†ï¼Œå°†åˆ°è¾¾äº¤ä»˜æ—¶é—´çš„æ¶ˆæ¯ä¿®æ”¹ä¸ºåŸå§‹ä¸»é¢˜çš„åŸå§‹ ID å­˜å…¥ CommitLogï¼Œæ¶ˆè´¹è€…å°±å¯ä»¥è¿›è¡Œæ¶ˆè´¹äº† æ¶ˆè´¹æµç¨‹ï¼š æ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ— ConsumerQueue å­˜å‚¨æ¶ˆæ¯åœ¨ CommitLog çš„ç´¢å¼•ï¼Œæ¶ˆè´¹è€…é€šè¿‡è¯¥é˜Ÿåˆ—æ¥è¯»å–æ¶ˆæ¯å®ä½“å†…å®¹ï¼Œä¸€ä¸ª MQ å°±å¯¹åº”ä¸€ä¸ª CQ é¦–å…ˆé€šè¿‡è´Ÿè½½å‡è¡¡æœåŠ¡ï¼Œå°†åˆ†é…åˆ°å½“å‰æ¶ˆè´¹è€…å®ä¾‹çš„ MQ åˆ›å»º PullRequestï¼Œå¹¶æ”¾å…¥ PullMessageService çš„æœ¬åœ°é˜»å¡é˜Ÿåˆ—å†… PullMessageService å¾ªç¯ä»é˜»å¡é˜Ÿåˆ—è·å–è¯·æ±‚å¯¹è±¡ï¼Œå‘èµ·æ‹‰æ¶ˆæ¯è¯·æ±‚ï¼Œå¹¶åˆ›å»º PullCallback å›è°ƒå¯¹è±¡ï¼Œå°†æ­£å¸¸æ‹‰å–çš„æ¶ˆæ¯æäº¤åˆ°æ¶ˆè´¹ä»»åŠ¡çº¿ç¨‹æ± ï¼Œå¹¶è®¾ç½®è¯·æ±‚çš„ä¸‹ä¸€æ¬¡æ‹‰å–ä½ç‚¹ï¼Œé‡æ–°æ”¾å…¥é˜»å¡é˜Ÿåˆ—ï¼Œå½¢æˆé—­ç¯ æ¶ˆè´¹ä»»åŠ¡æœåŠ¡å¯¹æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯è¿›è¡Œå›é€€ï¼Œé€šè¿‡å†…éƒ¨ç”Ÿäº§è€…å®ä¾‹å‘é€å›é€€æ¶ˆæ¯ï¼Œå›é€€å¤±è´¥çš„æ¶ˆæ¯ä¼šå†æ¬¡æäº¤æ¶ˆè´¹ä»»åŠ¡é‡æ–°æ¶ˆè´¹ Broker ç«¯å¯¹æ‹‰å–æ¶ˆæ¯çš„è¯·æ±‚è¿›è¡Œå¤„ç†ï¼ˆprocessRequestCommandï¼‰ï¼ŒæŸ¥è¯¢æˆåŠŸå°†æ¶ˆæ¯æ”¾å…¥å“åº”ä½“ï¼Œé€šè¿‡ Netty å†™å›å®¢æˆ·ç«¯ï¼Œå½“ pullRequest.offset == queue.maxOffset è¯´æ˜è¯¥é˜Ÿåˆ—å·²ç»æ²¡æœ‰éœ€è¦è·å–çš„æ¶ˆæ¯ï¼Œå°†è¯·æ±‚æ”¾å…¥é•¿è½®è¯¢é›†åˆç­‰å¾…æœ‰æ–°æ¶ˆæ¯ PullRequestHoldService è´Ÿè´£é•¿è½®è¯¢ï¼Œæ¯ 5 ç§’éå†ä¸€æ¬¡é•¿è½®è¯¢é›†åˆï¼Œå°†æ»¡è¶³æ¡ä»¶çš„ PullRequest å†æ¬¡æäº¤åˆ°çº¿ç¨‹æ± å†…å¤„ç† ZookeeperåŸºæœ¬ä»‹ç»æ¡†æ¶ç‰¹å¾Zookeeper æ˜¯ Apache Hadoop é¡¹ç›®å­é¡¹ç›®ï¼Œä¸ºåˆ†å¸ƒå¼æ¡†æ¶æä¾›åè°ƒæœåŠ¡ï¼Œæ˜¯ä¸€ä¸ªæ ‘å½¢ç›®å½•æœåŠ¡ Zookeeper æ˜¯åŸºäºè§‚å¯Ÿè€…æ¨¡å¼è®¾è®¡çš„åˆ†å¸ƒå¼æœåŠ¡ç®¡ç†æ¡†æ¶ï¼Œè´Ÿè´£å­˜å‚¨å’Œç®¡ç†å…±äº«æ•°æ®ï¼Œæ¥å—è§‚å¯Ÿè€…çš„æ³¨å†Œç›‘æ§ï¼Œä¸€æ—¦è¿™äº›æ•°æ®çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼ŒZookeeper ä¼šé€šçŸ¥è§‚å¯Ÿè€… Zookeeper æ˜¯ä¸€ä¸ªé¢†å¯¼è€…ï¼ˆLeaderï¼‰ï¼Œå¤šä¸ªè·Ÿéšè€…ï¼ˆFollowerï¼‰ç»„æˆçš„é›†ç¾¤ é›†ç¾¤ä¸­åªè¦æœ‰åŠæ•°ä»¥ä¸ŠèŠ‚ç‚¹å­˜æ´»å°±èƒ½æ­£å¸¸æœåŠ¡ï¼Œæ‰€ä»¥ Zookeeper é€‚åˆéƒ¨ç½²å¥‡æ•°å°æœåŠ¡å™¨ å…¨å±€æ•°æ®ä¸€è‡´ï¼Œæ¯ä¸ª Server ä¿å­˜ä¸€ä»½ç›¸åŒçš„æ•°æ®å‰¯æœ¬ï¼ŒClient æ— è®ºè¿æ¥åˆ°å“ªä¸ª Serverï¼Œæ•°æ®éƒ½æ˜¯ä¸€è‡´ æ›´æ–°çš„è¯·æ±‚é¡ºåºæ‰§è¡Œï¼Œæ¥è‡ªåŒä¸€ä¸ª Client çš„è¯·æ±‚æŒ‰å…¶å‘é€é¡ºåºä¾æ¬¡æ‰§è¡Œ æ•°æ®æ›´æ–°åŸå­æ€§ï¼Œä¸€æ¬¡æ•°æ®æ›´æ–°è¦ä¹ˆæˆåŠŸï¼Œè¦ä¹ˆå¤±è´¥ å®æ—¶æ€§ï¼Œåœ¨ä¸€å®šçš„æ—¶é—´èŒƒå›´å†…ï¼ŒClient èƒ½è¯»åˆ°æœ€æ–°æ•°æ® å¿ƒè·³æ£€æµ‹ï¼Œä¼šå®šæ—¶å‘å„ä¸ªæœåŠ¡æä¾›è€…å‘é€ä¸€ä¸ªè¯·æ±‚ï¼ˆå®é™…ä¸Šå»ºç«‹çš„æ˜¯ä¸€ä¸ª Socket é•¿è¿æ¥ï¼‰ å‚è€ƒè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV1to4y1C7gw åº”ç”¨åœºæ™¯Zookeeper æä¾›çš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼šç»Ÿä¸€å‘½åæœåŠ¡ã€ç»Ÿä¸€é…ç½®ç®¡ç†ã€ç»Ÿä¸€é›†ç¾¤ç®¡ç†ã€æœåŠ¡å™¨èŠ‚ç‚¹åŠ¨æ€ä¸Šä¸‹çº¿ã€è½¯è´Ÿè½½å‡è¡¡ã€åˆ†å¸ƒå¼é”ç­‰ åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œç»å¸¸å¯¹åº”ç”¨&#x2F;æœåŠ¡è¿›è¡Œç»Ÿä¸€å‘½åï¼Œä¾¿äºè¯†åˆ«ï¼Œä¾‹å¦‚åŸŸåç›¸å¯¹äº IP åœ°å€æ›´å®¹æ˜“è¢«æ¥æ”¶ 12/service/www.baidu.com # èŠ‚ç‚¹è·¯å¾„192.168.1.1 192.168.1.2 # èŠ‚ç‚¹å€¼ å¦‚æœåœ¨èŠ‚ç‚¹ä¸­è®°å½•æ¯å°æœåŠ¡å™¨çš„è®¿é—®æ•°ï¼Œè®©è®¿é—®æ•°æœ€å°‘çš„æœåŠ¡å™¨å»å¤„ç†æœ€æ–°çš„å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå¯ä»¥å®ç°è´Ÿè½½å‡è¡¡ 12192.168.1.1 10 # æ¬¡æ•°192.168.1.1 15 é…ç½®æ–‡ä»¶åŒæ­¥å¯ä»¥é€šè¿‡ Zookeeper å®ç°ï¼Œå°†é…ç½®ä¿¡æ¯å†™å…¥æŸä¸ª ZNodeï¼Œå…¶ä»–å®¢æˆ·ç«¯ç›‘è§†è¯¥èŠ‚ç‚¹ï¼Œå½“èŠ‚ç‚¹æ•°æ®è¢«ä¿®æ”¹ï¼Œé€šçŸ¥å„ä¸ªå®¢æˆ·ç«¯æœåŠ¡å™¨ é›†ç¾¤ç¯å¢ƒä¸­ï¼Œéœ€è¦å®æ—¶æŒæ¡æ¯ä¸ªé›†ç¾¤èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œå¯ä»¥å°†è¿™äº›ä¿¡æ¯æ”¾å…¥ ZNodeï¼Œé€šè¿‡ç›‘æ§é€šçŸ¥çš„æœºåˆ¶å®ç° å®ç°å®¢æˆ·ç«¯å®æ—¶è§‚å¯ŸæœåŠ¡å™¨ä¸Šä¸‹çº¿çš„å˜åŒ–ï¼Œé€šè¿‡å¿ƒè·³æ£€æµ‹å®ç° åŸºæœ¬æ“ä½œå®‰è£…æ­å»ºå®‰è£…æ­¥éª¤ï¼š å®‰è£… JDK æ‹·è´ apache-zookeeper-3.5.7-bin.tar.gz å®‰è£…åŒ…åˆ° Linux ç³»ç»Ÿä¸‹ï¼Œå¹¶è§£å‹åˆ°æŒ‡å®šç›®å½• conf ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶é‡å‘½åï¼š 1mv zoo_sample.cfg zoo.cfg ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š 123vim zoo.cfg# ä¿®æ”¹å†…å®¹dataDir=/home/seazean/SoftWare/zookeeper-3.5.7/zkData åœ¨å¯¹åº”ç›®å½•åˆ›å»º zkData æ–‡ä»¶å¤¹ï¼š 1mkdir zkData Zookeeper ä¸­çš„é…ç½®æ–‡ä»¶ zoo.cfg ä¸­å‚æ•°å«ä¹‰è§£è¯»ï¼š tickTime &#x3D; 2000ï¼šé€šä¿¡å¿ƒè·³æ—¶é—´ï¼ŒZookeeper æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯å¿ƒè·³æ—¶é—´ï¼Œå•ä½æ¯«ç§’ initLimit &#x3D; 10ï¼šLeader ä¸ Follower åˆå§‹é€šä¿¡æ—¶é™ï¼Œåˆå§‹è¿æ¥æ—¶èƒ½å®¹å¿çš„æœ€å¤šå¿ƒè·³æ¬¡æ•° syncLimit &#x3D; 5ï¼šLeader ä¸ Follower åŒæ­¥é€šä¿¡æ—¶é™ï¼ŒLF é€šä¿¡æ—¶é—´è¶…è¿‡ syncLimit * tickTimeï¼ŒLeader è®¤ä¸º Follwer ä¸‹çº¿ dataDirï¼šä¿å­˜ Zookeeper ä¸­çš„æ•°æ®ç›®å½•ï¼Œé»˜è®¤æ˜¯ tmpç›®å½•ï¼Œå®¹æ˜“è¢« Linux ç³»ç»Ÿå®šæœŸåˆ é™¤ï¼Œæ‰€ä»¥å»ºè®®ä¿®æ”¹ clientPort &#x3D; 2181ï¼šå®¢æˆ·ç«¯è¿æ¥ç«¯å£ï¼Œé€šå¸¸ä¸åšä¿®æ”¹ æ“ä½œå‘½ä»¤æœåŠ¡ç«¯Linux å‘½ä»¤ï¼š å¯åŠ¨ ZooKeeper æœåŠ¡ï¼š./zkServer.sh start æŸ¥çœ‹ ZooKeeper æœåŠ¡ï¼š./zkServer.sh status åœæ­¢ ZooKeeper æœåŠ¡ï¼š./zkServer.sh stop é‡å¯ ZooKeeper æœåŠ¡ï¼š./zkServer.sh restart æŸ¥çœ‹è¿›ç¨‹æ˜¯å¦å¯åŠ¨ï¼šjps å®¢æˆ·ç«¯Linux å‘½ä»¤ï¼š è¿æ¥ ZooKeeper æœåŠ¡ç«¯ï¼š 12./zkCli.sh # ç›´æ¥å¯åŠ¨./zkCli.sh â€“server ip:port # æŒ‡å®š host å¯åŠ¨ å®¢æˆ·ç«¯å‘½ä»¤ï¼š åŸºç¡€æ“ä½œï¼š 12quit # åœæ­¢è¿æ¥help # æŸ¥çœ‹å‘½ä»¤å¸®åŠ© åˆ›å»ºå‘½ä»¤ï¼š**/ ä»£è¡¨æ ¹ç›®å½•** 1234create /path value # åˆ›å»ºèŠ‚ç‚¹ï¼Œvalue å¯é€‰create -e /path value # åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹create -s /path value # åˆ›å»ºé¡ºåºèŠ‚ç‚¹create -es /path value # åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼Œæ¯”å¦‚node10000012 åˆ é™¤12åä¹Ÿä¼šç»§ç»­ä»13å¼€å§‹ï¼Œåªä¼šå¢åŠ  æŸ¥è¯¢å‘½ä»¤ï¼š 123456ls /path # æ˜¾ç¤ºæŒ‡å®šç›®å½•ä¸‹å­èŠ‚ç‚¹ls â€“s /path # æŸ¥è¯¢èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯ls â€“w /path # ç›‘å¬å­èŠ‚ç‚¹æ•°é‡çš„å˜åŒ–stat /path # æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€get â€“s /path # æŸ¥è¯¢èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯get â€“w /path # ç›‘å¬èŠ‚ç‚¹æ•°æ®çš„å˜åŒ– 123456789101112# å±æ€§ï¼Œåˆ†ä¸ºå½“å‰èŠ‚ç‚¹çš„å±æ€§å’Œå­èŠ‚ç‚¹å±æ€§czxid: èŠ‚ç‚¹è¢«åˆ›å»ºçš„äº‹åŠ¡ID, æ˜¯ZooKeeperä¸­æ‰€æœ‰ä¿®æ”¹æ€»çš„æ¬¡åºï¼Œæ¯æ¬¡ä¿®æ”¹éƒ½æœ‰å”¯ä¸€çš„ zxidï¼Œè°å°è°å…ˆå‘ç”Ÿctime: è¢«åˆ›å»ºçš„æ—¶é—´æˆ³mzxid: æœ€åä¸€æ¬¡è¢«æ›´æ–°çš„äº‹åŠ¡ID mtime: æœ€åä¿®æ”¹çš„æ—¶é—´æˆ³pzxid: å­èŠ‚ç‚¹åˆ—è¡¨æœ€åä¸€æ¬¡è¢«æ›´æ–°çš„äº‹åŠ¡IDcversion: å­èŠ‚ç‚¹çš„å˜åŒ–å·ï¼Œä¿®æ”¹æ¬¡æ•°dataversion: èŠ‚ç‚¹çš„æ•°æ®å˜åŒ–å·ï¼Œæ•°æ®çš„å˜åŒ–æ¬¡æ•°aclversion: èŠ‚ç‚¹çš„è®¿é—®æ§åˆ¶åˆ—è¡¨å˜åŒ–å·ephemeralOwner: ç”¨äºä¸´æ—¶èŠ‚ç‚¹ï¼Œä»£è¡¨èŠ‚ç‚¹æ‹¥æœ‰è€…çš„ session idï¼Œå¦‚æœä¸ºæŒä¹…èŠ‚ç‚¹åˆ™ä¸º0 dataLength: èŠ‚ç‚¹å­˜å‚¨çš„æ•°æ®çš„é•¿åº¦ numChildren: å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹æ•°é‡ åˆ é™¤å‘½ä»¤ï¼š 12delete /path # åˆ é™¤èŠ‚ç‚¹deleteall /path # é€’å½’åˆ é™¤èŠ‚ç‚¹ æ•°æ®ç»“æ„ZooKeeper æ˜¯ä¸€ä¸ªæ ‘å½¢ç›®å½•æœåŠ¡ï¼Œç±»ä¼¼ Unix çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½è¢«ç§°ä¸º ZNodeï¼Œæ¯ä¸ª ZNode é»˜è®¤å­˜å‚¨ 1MB çš„æ•°æ®ï¼ŒèŠ‚ç‚¹ä¸Šä¼šä¿å­˜æ•°æ®å’ŒèŠ‚ç‚¹ä¿¡æ¯ï¼Œæ¯ä¸ª ZNode éƒ½å¯ä»¥é€šè¿‡å…¶è·¯å¾„å”¯ä¸€æ ‡è¯† èŠ‚ç‚¹å¯ä»¥åˆ†ä¸ºå››å¤§ç±»ï¼š PERSISTENTï¼šæŒä¹…åŒ–èŠ‚ç‚¹ EPHEMERALï¼šä¸´æ—¶èŠ‚ç‚¹ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯æ–­å¼€è¿æ¥åï¼Œåˆ›å»ºçš„èŠ‚ç‚¹åˆ é™¤ PERSISTENT_SEQUENTIALï¼šæŒä¹…åŒ–é¡ºåºèŠ‚ç‚¹ï¼Œåˆ›å»º znode æ—¶è®¾ç½®é¡ºåºæ ‡è¯†ï¼ŒèŠ‚ç‚¹åç§°åä¼šé™„åŠ ä¸€ä¸ªå€¼ï¼Œé¡ºåºå·æ˜¯ä¸€ä¸ªå•è°ƒé€’å¢çš„è®¡æ•°å™¨ï¼Œç”±çˆ¶èŠ‚ç‚¹ç»´æŠ¤ EPHEMERAL_SEQUENTIALï¼šä¸´æ—¶é¡ºåºèŠ‚ç‚¹ æ³¨æ„ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œé¡ºåºå·å¯ä»¥è¢«ç”¨äºä¸ºæ‰€æœ‰çš„äº‹ä»¶è¿›è¡Œå…¨å±€æ’åºï¼Œè¿™æ ·å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡é¡ºåºå·æ¨æ–­äº‹ä»¶çš„é¡ºåº ä»£ç å®ç°æ·»åŠ  Maven ä¾èµ–ï¼š 12345&lt;dependency&gt; &lt;groupId&gt;org.apache.zookeeper&lt;/groupId&gt; &lt;artifactId&gt;zookeeper&lt;/artifactId&gt; &lt;version&gt;3.5.7&lt;/version&gt;&lt;/dependency&gt; å®ç°ä»£ç ï¼š 1234567891011public static void main(String[] args) &#123; // å‚æ•°ä¸€ï¼šè¿æ¥åœ°å€ // å‚æ•°äºŒï¼šä¼šè¯è¶…æ—¶æ—¶é—´ // å‚æ•°ä¸‰ï¼šç›‘å¬å™¨ ZooKeeper zkClient = new ZooKeeper(&quot;192.168.3.128:2181&quot;, 20000, new Watcher() &#123; @Override public void process(WatchedEvent event) &#123; System.out.println(&quot;ç›‘å¬å¤„ç†å‡½æ•°&quot;); &#125; &#125;);&#125; é›†ç¾¤ä»‹ç»ç›¸å…³æ¦‚å¿µZookeepe é›†ç¾¤ä¸‰ä¸ªè§’è‰²ï¼š Leader é¢†å¯¼è€…ï¼šå¤„ç†å®¢æˆ·ç«¯äº‹åŠ¡è¯·æ±‚ï¼Œè´Ÿè´£é›†ç¾¤å†…éƒ¨å„æœåŠ¡å™¨çš„è°ƒåº¦ Follower è·Ÿéšè€…ï¼šå¤„ç†å®¢æˆ·ç«¯éäº‹åŠ¡è¯·æ±‚ï¼Œè½¬å‘äº‹åŠ¡è¯·æ±‚ç»™ Leader æœåŠ¡å™¨ï¼Œå‚ä¸ Leader é€‰ä¸¾æŠ•ç¥¨ Observer è§‚å¯Ÿè€…ï¼šè§‚å¯Ÿé›†ç¾¤çš„æœ€æ–°çŠ¶æ€çš„å˜åŒ–ï¼Œå¹¶å°†è¿™äº›çŠ¶æ€è¿›è¡ŒåŒæ­¥ï¼›å¤„ç†éäº‹åŠ¡æ€§è¯·æ±‚ï¼Œäº‹åŠ¡æ€§è¯·æ±‚ä¼šè½¬å‘ç»™ Leader æœåŠ¡å™¨è¿›è¡Œå¤„ç†ï¼›ä¸ä¼šå‚ä¸ä»»ä½•å½¢å¼çš„æŠ•ç¥¨ã€‚åªæä¾›éäº‹åŠ¡æ€§çš„æœåŠ¡ï¼Œé€šå¸¸ç”¨äºåœ¨ä¸å½±å“é›†ç¾¤äº‹åŠ¡å¤„ç†èƒ½åŠ›çš„å‰æä¸‹ï¼Œæå‡é›†ç¾¤çš„éäº‹åŠ¡å¤„ç†èƒ½åŠ›ï¼ˆæé«˜é›†ç¾¤è¯»çš„èƒ½åŠ›ï¼Œä½†æ˜¯ä¹Ÿé™ä½äº†é›†ç¾¤é€‰ä¸»çš„å¤æ‚ç¨‹åº¦ï¼‰ ç›¸å…³å±æ€§ï¼š SIDï¼šæœåŠ¡å™¨ IDï¼Œç”¨æ¥å”¯ä¸€æ ‡è¯†ä¸€å°é›†ç¾¤ä¸­çš„æœºå™¨ï¼Œå’Œ myid ä¸€è‡´ ZXIDï¼šäº‹åŠ¡ IDï¼Œç”¨æ¥æ ‡è¯†ä¸€æ¬¡æœåŠ¡å™¨çŠ¶æ€çš„å˜æ›´ï¼Œåœ¨æŸä¸€æ—¶åˆ»é›†ç¾¤ä¸­æ¯å°æœºå™¨çš„ ZXID å€¼ä¸ä¸€å®šå®Œå…¨ä¸€è‡´ï¼Œè¿™å’Œ ZooKeeper æœåŠ¡å™¨å¯¹äºå®¢æˆ·ç«¯æ›´æ–°è¯·æ±‚çš„å¤„ç†é€»è¾‘æœ‰å…³ Epochï¼šæ¯ä¸ª Leader ä»»æœŸçš„ä»£å·ï¼ŒåŒä¸€è½®é€‰ä¸¾æŠ•ç¥¨è¿‡ç¨‹ä¸­çš„è¯¥å€¼æ˜¯ç›¸åŒçš„ï¼ŒæŠ•å®Œä¸€æ¬¡ç¥¨å°±å¢åŠ  é€‰ä¸¾æœºåˆ¶ï¼šåŠæ•°æœºåˆ¶ï¼Œè¶…è¿‡åŠæ•°çš„æŠ•ç¥¨å°±é€šè¿‡ ç¬¬ä¸€æ¬¡å¯åŠ¨é€‰ä¸¾è§„åˆ™ï¼šæŠ•ç¥¨è¿‡åŠæ•°æ—¶ï¼ŒæœåŠ¡å™¨ ID å¤§çš„èƒœå‡º ç¬¬äºŒæ¬¡å¯åŠ¨é€‰ä¸¾è§„åˆ™ï¼š EPOCH å¤§çš„ç›´æ¥èƒœå‡º EPOCH ç›¸åŒï¼Œäº‹åŠ¡ ID å¤§çš„èƒœå‡ºï¼ˆäº‹åŠ¡ ID è¶Šå¤§ï¼Œæ•°æ®è¶Šæ–°ï¼‰ äº‹åŠ¡ ID ç›¸åŒï¼ŒæœåŠ¡å™¨ ID å¤§çš„èƒœå‡º åˆæ¬¡é€‰ä¸¾é€‰ä¸¾è¿‡ç¨‹ï¼š æœåŠ¡å™¨ 1 å¯åŠ¨ï¼Œå‘èµ·ä¸€æ¬¡é€‰ä¸¾ï¼ŒæœåŠ¡å™¨ 1 æŠ•è‡ªå·±ä¸€ç¥¨ï¼Œç¥¨æ•°ä¸è¶…è¿‡åŠæ•°ï¼Œé€‰ä¸¾æ— æ³•å®Œæˆï¼ŒæœåŠ¡å™¨ 1 çŠ¶æ€ä¿æŒä¸º LOOKING æœåŠ¡å™¨ 2 å¯åŠ¨ï¼Œå†å‘èµ·ä¸€æ¬¡é€‰ä¸¾ï¼ŒæœåŠ¡å™¨ 1 å’Œ 2 åˆ†åˆ«æŠ•è‡ªå·±ä¸€ç¥¨å¹¶äº¤æ¢é€‰ç¥¨ä¿¡æ¯ï¼Œæ­¤æ—¶æœåŠ¡å™¨ 1 ä¼šå‘ç°æœåŠ¡å™¨ 2 çš„ SID æ¯”è‡ªå·±æŠ•ç¥¨æ¨ä¸¾çš„ï¼ˆæœåŠ¡å™¨ 1ï¼‰å¤§ï¼Œæ›´æ”¹é€‰ç¥¨ä¸ºæ¨ä¸¾æœåŠ¡å™¨ 2ã€‚æŠ•ç¥¨ç»“æœä¸ºæœåŠ¡å™¨ 1 ç¥¨æ•° 0 ç¥¨ï¼ŒæœåŠ¡å™¨ 2 ç¥¨æ•° 2 ç¥¨ï¼Œç¥¨æ•°ä¸è¶…è¿‡åŠæ•°ï¼Œé€‰ä¸¾æ— æ³•å®Œæˆï¼ŒæœåŠ¡å™¨ 1ã€2 çŠ¶æ€ä¿æŒ LOOKING æœåŠ¡å™¨ 3 å¯åŠ¨ï¼Œå‘èµ·ä¸€æ¬¡é€‰ä¸¾ï¼Œæ­¤æ—¶æœåŠ¡å™¨ 1 å’Œ 2 éƒ½ä¼šæ›´æ”¹é€‰ç¥¨ä¸ºæœåŠ¡å™¨ 3ï¼ŒæŠ•ç¥¨ç»“æœä¸ºæœåŠ¡å™¨ 3 ç¥¨æ•° 3 ç¥¨ï¼Œæ­¤æ—¶æœåŠ¡å™¨ 3 çš„ç¥¨æ•°å·²ç»è¶…è¿‡åŠæ•°ï¼ŒæœåŠ¡å™¨ 3 å½“é€‰ Leaderï¼ŒæœåŠ¡å™¨ 1ã€2 æ›´æ”¹çŠ¶æ€ä¸º FOLLOWINGï¼ŒæœåŠ¡å™¨ 3 æ›´æ”¹çŠ¶æ€ä¸º LEADING æœåŠ¡å™¨ 4 å¯åŠ¨ï¼Œå‘èµ·ä¸€æ¬¡é€‰ä¸¾ï¼Œæ­¤æ—¶æœåŠ¡å™¨ 1ã€2ã€3 å·²ç»ä¸æ˜¯ LOOKING çŠ¶æ€ï¼Œä¸ä¼šæ›´æ”¹é€‰ç¥¨ä¿¡æ¯ï¼Œäº¤æ¢é€‰ç¥¨ä¿¡æ¯ç»“æœåæœåŠ¡å™¨ 3 ä¸º 3 ç¥¨ï¼ŒæœåŠ¡å™¨ 4 ä¸º 1 ç¥¨ï¼Œæ­¤æ—¶æœåŠ¡å™¨ 4 æ›´æ”¹é€‰ç¥¨ä¿¡æ¯ä¸ºæœåŠ¡å™¨ 3ï¼Œå¹¶æ›´æ”¹çŠ¶æ€ä¸º FOLLOWING æœåŠ¡å™¨ 5 å¯åŠ¨ï¼ŒåŒ 4 ä¸€æ · å†æ¬¡é€‰ä¸¾ZooKeeper é›†ç¾¤ä¸­çš„ä¸€å°æœåŠ¡å™¨å‡ºç°ä»¥ä¸‹æƒ…å†µä¹‹ä¸€æ—¶ï¼Œå°±ä¼šå¼€å§‹è¿›å…¥ Leader é€‰ä¸¾ï¼š æœåŠ¡å™¨åˆå§‹åŒ–å¯åŠ¨ æœåŠ¡å™¨è¿è¡ŒæœŸé—´æ— æ³•å’Œ Leader ä¿æŒè¿æ¥ å½“ä¸€å°æœåŠ¡å™¨è¿›å…¥ Leader é€‰ä¸¾æµç¨‹æ—¶ï¼Œå½“å‰é›†ç¾¤å¯èƒ½ä¼šå¤„äºä»¥ä¸‹ä¸¤ç§çŠ¶æ€ï¼š é›†ç¾¤ä¸­æœ¬æ¥å°±å·²ç»å­˜åœ¨ä¸€ä¸ª Leaderï¼ŒæœåŠ¡å™¨è¯•å›¾å»é€‰ä¸¾ Leader æ—¶ä¼šè¢«å‘ŠçŸ¥å½“å‰æœåŠ¡å™¨çš„ Leader ä¿¡æ¯ï¼Œå¯¹äºè¯¥æœåŠ¡å™¨æ¥è¯´ï¼Œåªéœ€è¦å’Œ Leader æœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼Œå¹¶è¿›è¡ŒçŠ¶æ€åŒæ­¥å³å¯ é›†ç¾¤ä¸­ç¡®å®ä¸å­˜åœ¨ Leaderï¼Œå‡è®¾æœåŠ¡å™¨ 3 å’Œ 5 å‡ºç°æ•…éšœï¼Œå¼€å§‹è¿›è¡Œ Leader é€‰ä¸¾ï¼ŒSID ä¸º 1ã€2ã€4 çš„æœºå™¨æŠ•ç¥¨æƒ…å†µ 1(EPOCHï¼ŒZXIDï¼ŒSID): (1, 8, 1), (1, 8, 2), (1, 7, 4) æ ¹æ®é€‰ä¸¾è§„åˆ™ï¼ŒæœåŠ¡å™¨ 2 èƒœå‡º æ•°æ®å†™å…¥å†™æ“ä½œå°±æ˜¯äº‹åŠ¡è¯·æ±‚ï¼Œå†™å…¥è¯·æ±‚ç›´æ¥å‘é€ç»™ Leader èŠ‚ç‚¹ï¼šLeader ä¼šå…ˆå°†æ•°æ®å†™å…¥è‡ªèº«ï¼ŒåŒæ—¶é€šçŸ¥å…¶ä»– Follower å†™å…¥ï¼Œå½“é›†ç¾¤ä¸­æœ‰åŠæ•°ä»¥ä¸ŠèŠ‚ç‚¹å†™å…¥å®Œæˆï¼ŒLeader èŠ‚ç‚¹å°±ä¼šå“åº”å®¢æˆ·ç«¯æ•°æ®å†™å…¥å®Œæˆ å†™å…¥è¯·æ±‚ç›´æ¥å‘é€ç»™ Follower èŠ‚ç‚¹ï¼šFollower æ²¡æœ‰å†™å…¥æƒé™ï¼Œä¼šå°†å†™è¯·æ±‚è½¬å‘ç»™ Leaderï¼ŒLeader å°†æ•°æ®å†™å…¥è‡ªèº«ï¼Œé€šçŸ¥å…¶ä»– Follower å†™å…¥ï¼Œå½“é›†ç¾¤ä¸­æœ‰åŠæ•°ä»¥ä¸ŠèŠ‚ç‚¹å†™å…¥å®Œæˆï¼ŒLeader ä¼šé€šçŸ¥ Follower å†™å…¥å®Œæˆï¼Œç”± Follower å“åº”å®¢æˆ·ç«¯æ•°æ®å†™å…¥å®Œæˆ åº•å±‚åè®®PaxosPaxos ç®—æ³•ï¼šåŸºäºæ¶ˆæ¯ä¼ é€’ä¸”å…·æœ‰é«˜åº¦å®¹é”™ç‰¹æ€§çš„ä¸€è‡´æ€§ç®—æ³• ä¼˜ç‚¹ï¼šå¿«é€Ÿæ­£ç¡®çš„åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¯¹æŸä¸ªæ•°æ®å€¼è¾¾æˆä¸€è‡´ï¼Œå¹¶ä¸”ä¿è¯ä¸è®ºå‘ç”Ÿä»»ä½•å¼‚å¸¸ï¼Œéƒ½ä¸ä¼šç ´åæ•´ä¸ªç³»ç»Ÿçš„ä¸€è‡´æ€§ ç¼ºé™·ï¼šåœ¨ç½‘ç»œå¤æ‚çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½å¾ˆä¹…æ— æ³•æ”¶æ•›ï¼Œç”šè‡³é™·å…¥æ´»é”çš„æƒ…å†µ ZABç®—æ³•ä»‹ç»ZAB åè®®å€Ÿé‰´äº† Paxos ç®—æ³•ï¼Œæ˜¯ä¸º Zookeeper è®¾è®¡çš„æ”¯æŒå´©æºƒæ¢å¤çš„åŸå­å¹¿æ’­åè®®ï¼ŒåŸºäºè¯¥åè®® Zookeeper è®¾è®¡ä¸ºåªæœ‰ä¸€å°å®¢æˆ·ç«¯ï¼ˆLeaderï¼‰è´Ÿè´£å¤„ç†å¤–éƒ¨çš„å†™äº‹åŠ¡è¯·æ±‚ï¼Œç„¶å Leader å°†æ•°æ®åŒæ­¥åˆ°å…¶ä»– Follower èŠ‚ç‚¹ Zab åè®®åŒ…æ‹¬ä¸¤ç§åŸºæœ¬çš„æ¨¡å¼ï¼šæ¶ˆæ¯å¹¿æ’­ã€å´©æºƒæ¢å¤ æ¶ˆæ¯å¹¿æ’­ZAB åè®®é’ˆå¯¹äº‹åŠ¡è¯·æ±‚çš„å¤„ç†è¿‡ç¨‹ç±»ä¼¼äºä¸€ä¸ªä¸¤é˜¶æ®µæäº¤è¿‡ç¨‹ï¼šå¹¿æ’­äº‹åŠ¡é˜¶æ®µã€å¹¿æ’­æäº¤æ“ä½œ å®¢æˆ·ç«¯å‘èµ·å†™æ“ä½œè¯·æ±‚ï¼ŒLeader æœåŠ¡å™¨å°†è¯·æ±‚è½¬åŒ–ä¸ºäº‹åŠ¡ Proposal ææ¡ˆï¼ŒåŒæ—¶ä¸º Proposal åˆ†é…ä¸€ä¸ªå…¨å±€çš„ IDï¼Œå³ ZXID Leader æœåŠ¡å™¨ä¸ºæ¯ä¸ª Follower åˆ†é…ä¸€ä¸ªå•ç‹¬çš„é˜Ÿåˆ—ï¼Œå°†å¹¿æ’­çš„ Proposal ä¾æ¬¡æ”¾åˆ°é˜Ÿåˆ—ä¸­å»ï¼Œæ ¹æ® FIFO ç­–ç•¥è¿›è¡Œæ¶ˆæ¯å‘é€ Follower æ¥æ”¶åˆ° Proposal åï¼Œå°†å…¶ä»¥äº‹åŠ¡æ—¥å¿—çš„æ–¹å¼å†™å…¥æœ¬åœ°ç£ç›˜ä¸­ï¼Œå†™å…¥æˆåŠŸåå‘ Leader åé¦ˆä¸€ä¸ª ACK å“åº”æ¶ˆæ¯ Leader æ¥æ”¶åˆ°è¶…è¿‡åŠæ•°ä»¥ä¸Š Follower çš„ ACK å“åº”æ¶ˆæ¯åï¼Œå³è®¤ä¸ºæ¶ˆæ¯å‘é€æˆåŠŸï¼Œå¯ä»¥å‘é€ Commit æ¶ˆæ¯ Leader å‘æ‰€æœ‰ Follower å¹¿æ’­ commit æ¶ˆæ¯ï¼ŒåŒæ—¶è‡ªèº«ä¹Ÿä¼šå®Œæˆäº‹åŠ¡æäº¤ï¼ŒFollower æ¥æ”¶åˆ° Commit åï¼Œå°†ä¸Šä¸€æ¡äº‹åŠ¡æäº¤ ä¸¤é˜¶æ®µæäº¤æ¨¡å‹å¯èƒ½å› ä¸º Leader å®•æœºå¸¦æ¥æ•°æ®ä¸ä¸€è‡´ï¼š Leader å‘èµ·ä¸€ä¸ªäº‹åŠ¡ Proposal åå°±å®•æœºï¼ŒFollower éƒ½æ²¡æœ‰ Proposal Leader æ”¶åˆ°åŠæ•° ACK å®•æœºï¼Œæ²¡æ¥å¾—åŠå‘ Follower å‘é€ Commit å´©æºƒæ¢å¤Leader æœåŠ¡å™¨å‡ºç°å´©æºƒæˆ–è€…ç”±äºç½‘ç»œåŸå› å¯¼è‡´ Leader æœåŠ¡å™¨å¤±å»äº†ä¸è¿‡åŠ Followerçš„è”ç³»ï¼Œé‚£ä¹ˆå°±ä¼šè¿›å…¥å´©æºƒæ¢å¤æ¨¡å¼ï¼Œå´©æºƒæ¢å¤ä¸»è¦åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼šLeader é€‰ä¸¾å’Œæ•°æ®æ¢å¤ Zab åè®®å´©æºƒæ¢å¤è¦æ±‚æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªè¦æ±‚ï¼š å·²ç»è¢« Leader æäº¤çš„ææ¡ˆ Proposalï¼Œå¿…é¡»æœ€ç»ˆè¢«æ‰€æœ‰çš„ Follower æœåŠ¡å™¨æ­£ç¡®æäº¤ ä¸¢å¼ƒå·²ç»è¢« Leader æå‡ºçš„ï¼Œä½†æ˜¯æ²¡æœ‰è¢«æäº¤çš„ Proposal Zab åè®®éœ€è¦ä¿è¯é€‰ä¸¾å‡ºæ¥çš„ Leader éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š æ–°é€‰ä¸¾çš„ Leader ä¸èƒ½åŒ…å«æœªæäº¤çš„ Proposalï¼Œå³æ–° Leader å¿…é¡»éƒ½æ˜¯å·²ç»æäº¤äº† Proposal çš„ Follower èŠ‚ç‚¹ æ–°é€‰ä¸¾çš„ Leader èŠ‚ç‚¹å«æœ‰æœ€å¤§çš„ ZXIDï¼Œå¯ä»¥é¿å… Leader æœåŠ¡å™¨æ£€æŸ¥ Proposal çš„æäº¤å’Œä¸¢å¼ƒå·¥ä½œ æ•°æ®æ¢å¤é˜¶æ®µï¼š å®Œæˆ Leader é€‰ä¸¾åï¼Œåœ¨æ­£å¼å¼€å§‹å·¥ä½œä¹‹å‰ï¼ˆæ¥æ”¶äº‹åŠ¡è¯·æ±‚æå‡ºæ–°çš„ Proposalï¼‰ï¼ŒLeader æœåŠ¡å™¨ä¼šé¦–å…ˆç¡®è®¤äº‹åŠ¡æ—¥å¿—ä¸­çš„æ‰€æœ‰ Proposal æ˜¯å¦å·²ç»è¢«é›†ç¾¤ä¸­è¿‡åŠçš„æœåŠ¡å™¨ Commit Leader æœåŠ¡å™¨éœ€è¦ç¡®ä¿æ‰€æœ‰çš„ Follower æœåŠ¡å™¨èƒ½å¤Ÿæ¥æ”¶åˆ°æ¯ä¸€æ¡äº‹åŠ¡çš„ Proposalï¼Œå¹¶ä¸”èƒ½å°†æ‰€æœ‰å·²ç»æäº¤çš„äº‹åŠ¡ Proposal åº”ç”¨åˆ°å†…å­˜æ•°æ®ä¸­ï¼Œæ‰€ä»¥åªæœ‰å½“ Follower å°†æ‰€æœ‰å°šæœªåŒæ­¥çš„äº‹åŠ¡ Proposal éƒ½ä» Leader æœåŠ¡å™¨ä¸ŠåŒæ­¥ï¼Œå¹¶ä¸”åº”ç”¨åˆ°å†…å­˜æ•°æ®åï¼ŒLeader æ‰ä¼šæŠŠè¯¥ Follower åŠ å…¥åˆ°çœŸæ­£å¯ç”¨çš„ Follower åˆ—è¡¨ä¸­ å¼‚å¸¸å¤„ç†Zab çš„äº‹åŠ¡ç¼–å· zxid è®¾è®¡ï¼š zxid æ˜¯ä¸€ä¸ª 64 ä½çš„æ•°å­—ï¼Œä½ 32 ä½æ˜¯ä¸€ä¸ªç®€å•çš„å•å¢è®¡æ•°å™¨ï¼Œé’ˆå¯¹å®¢æˆ·ç«¯æ¯ä¸€ä¸ªäº‹åŠ¡è¯·æ±‚ï¼ŒLeader åœ¨äº§ç”Ÿæ–°çš„ Proposal äº‹åŠ¡æ—¶ï¼Œéƒ½ä¼šå¯¹è¯¥è®¡æ•°å™¨åŠ  1ï¼Œè€Œé«˜ 32 ä½åˆ™ä»£è¡¨äº† Leader å‘¨æœŸçš„ epoch ç¼–å· epoch ä¸ºå½“å‰é›†ç¾¤æ‰€å¤„çš„ä»£æˆ–è€…å‘¨æœŸï¼Œæ¯æ¬¡ Leader å˜æ›´åéƒ½ä¼šåœ¨ epoch çš„åŸºç¡€ä¸ŠåŠ  1ï¼ŒFollower åªæœä» epoch æœ€é«˜çš„ Leader å‘½ä»¤ï¼Œæ‰€ä»¥æ—§çš„ Leader å´©æºƒæ¢å¤ä¹‹åï¼Œå…¶ä»– Follower å°±ä¸ä¼šç»§ç»­è¿½éš æ¯æ¬¡é€‰ä¸¾äº§ç”Ÿä¸€ä¸ªæ–°çš„ Leaderï¼Œå°±ä¼šä»æ–° Leader æœåŠ¡å™¨ä¸Šå–å‡ºæœ¬åœ°äº‹åŠ¡æ—¥å¿—ä¸­æœ€å¤§ç¼–å· Proposal çš„ zxidï¼Œä» zxid ä¸­è§£æå¾—åˆ°å¯¹åº”çš„ epoch ç¼–å·ï¼Œç„¶åå†å¯¹å…¶åŠ  1 åä½œä¸ºæ–°çš„ epoch å€¼ï¼Œå¹¶å°†ä½ 32 ä½æ•°å­—å½’é›¶ï¼Œç”± 0 å¼€å§‹é‡æ–°ç”Ÿæˆ zxid Zab åè®®é€šè¿‡ epoch ç¼–å·æ¥åŒºåˆ† Leader å˜åŒ–å‘¨æœŸï¼Œèƒ½å¤Ÿæœ‰æ•ˆé¿å…ä¸åŒçš„ Leader é”™è¯¯çš„ä½¿ç”¨äº†ç›¸åŒçš„ zxid ç¼–å·æå‡ºäº†ä¸ä¸€æ ·çš„ Proposal çš„å¼‚å¸¸æƒ…å†µ Zab æ•°æ®åŒæ­¥è¿‡ç¨‹ï¼šæ•°æ®åŒæ­¥é˜¶æ®µè¦ä»¥ Leader æœåŠ¡å™¨ä¸ºå‡† ä¸€ä¸ªåŒ…å«äº†ä¸Šä¸ª Leader å‘¨æœŸä¸­å°šæœªæäº¤è¿‡çš„äº‹åŠ¡ Proposal çš„æœåŠ¡å™¨å¯åŠ¨æ—¶ï¼Œè¿™å°æœºå™¨åŠ å…¥é›†ç¾¤ä¸­ä¼šä»¥ Follower è§’è‰²è¿ä¸Š Leader Leader ä¼šæ ¹æ®è‡ªå·±æœåŠ¡å™¨ä¸Šæœ€åæäº¤çš„ Proposal å’Œ Follower æœåŠ¡å™¨çš„ Proposal è¿›è¡Œæ¯”å¯¹ï¼Œè®© Follower è¿›è¡Œä¸€ä¸ªå›é€€æˆ–è€…å‰è¿›æ“ä½œï¼Œåˆ°ä¸€ä¸ªå·²ç»è¢«é›†ç¾¤ä¸­è¿‡åŠæœºå™¨ Commit çš„æœ€æ–° Proposalï¼ˆæºç è§£æéƒ¨åˆ†è¯¦è§£ï¼‰ CAPCAP ç†è®ºæŒ‡çš„æ˜¯åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼ŒConsistencyï¼ˆä¸€è‡´æ€§ï¼‰ã€Availabilityï¼ˆå¯ç”¨æ€§ï¼‰ã€Partition Toleranceï¼ˆåˆ†åŒºå®¹é”™æ€§ï¼‰ä¸èƒ½åŒæ—¶æˆç«‹ï¼ŒZooKeeper ä¿è¯çš„æ˜¯ CP ZooKeeper ä¸èƒ½ä¿è¯æ¯æ¬¡æœåŠ¡è¯·æ±‚çš„å¯ç”¨æ€§ï¼Œåœ¨æç«¯ç¯å¢ƒä¸‹å¯èƒ½ä¼šä¸¢å¼ƒä¸€äº›è¯·æ±‚ï¼Œæ¶ˆè´¹è€…ç¨‹åºéœ€è¦é‡æ–°è¯·æ±‚æ‰èƒ½è·å¾—ç»“æœ è¿›è¡Œ Leader é€‰ä¸¾æ—¶é›†ç¾¤éƒ½æ˜¯ä¸å¯ç”¨ CAP ä¸‰ä¸ªåŸºæœ¬éœ€æ±‚ï¼Œå› ä¸º P æ˜¯å¿…é¡»çš„ï¼Œå› æ­¤åˆ†å¸ƒå¼ç³»ç»Ÿé€‰æ‹©å°±åœ¨ CP æˆ–è€… AP ä¸­ï¼š ä¸€è‡´æ€§ï¼šæŒ‡æ•°æ®åœ¨å¤šä¸ªå‰¯æœ¬ä¹‹é—´æ˜¯å¦èƒ½å¤Ÿä¿æŒæ•°æ®ä¸€è‡´çš„ç‰¹æ€§ï¼Œå½“ä¸€ä¸ªç³»ç»Ÿåœ¨æ•°æ®ä¸€è‡´çš„çŠ¶æ€ä¸‹æ‰§è¡Œæ›´æ–°æ“ä½œåï¼Œä¹Ÿèƒ½ä¿è¯ç³»ç»Ÿçš„æ•°æ®ä»ç„¶å¤„äºä¸€è‡´çš„çŠ¶æ€ å¯ç”¨æ€§ï¼šæŒ‡ç³»ç»Ÿæä¾›çš„æœåŠ¡å¿…é¡»ä¸€ç›´å¤„äºå¯ç”¨çš„çŠ¶æ€ï¼Œå³ä½¿é›†ç¾¤ä¸­ä¸€éƒ¨åˆ†èŠ‚ç‚¹æ•…éšœï¼Œå¯¹äºç”¨æˆ·çš„æ¯ä¸€ä¸ªæ“ä½œè¯·æ±‚æ€»æ˜¯èƒ½å¤Ÿåœ¨æœ‰é™çš„æ—¶é—´å†…è¿”å›ç»“æœ åˆ†åŒºå®¹é”™æ€§ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿåœ¨é‡åˆ°ä»»ä½•ç½‘ç»œåˆ†åŒºæ•…éšœæ—¶ï¼Œä»ç„¶èƒ½å¤Ÿä¿è¯å¯¹å¤–æä¾›æœåŠ¡ï¼Œä¸ä¼šå®•æœºï¼Œé™¤éæ˜¯æ•´ä¸ªç½‘ç»œç¯å¢ƒéƒ½å‘ç”Ÿäº†æ•…éšœ ç›‘å¬æœºåˆ¶å®ç°åŸç†ZooKeeper ä¸­å¼•å…¥äº† Watcher æœºåˆ¶æ¥å®ç°äº†å‘å¸ƒ&#x2F;è®¢é˜…åŠŸèƒ½ï¼Œå®¢æˆ·ç«¯æ³¨å†Œç›‘å¬ç›®å½•èŠ‚ç‚¹ï¼Œåœ¨ç‰¹å®šäº‹ä»¶è§¦å‘æ—¶ï¼ŒZooKeeper ä¼šé€šçŸ¥æ‰€æœ‰å…³æ³¨è¯¥äº‹ä»¶çš„å®¢æˆ·ç«¯ï¼Œä¿è¯ ZooKeeper ä¿å­˜çš„ä»»ä½•çš„æ•°æ®çš„ä»»ä½•æ”¹å˜éƒ½èƒ½å¿«é€Ÿçš„å“åº”åˆ°ç›‘å¬åº”ç”¨ç¨‹åº ç›‘å¬å‘½ä»¤ï¼šåªèƒ½ç”Ÿæ•ˆä¸€æ¬¡ï¼Œæ¥æ”¶ä¸€æ¬¡é€šçŸ¥ï¼Œå†æ¬¡ç›‘å¬éœ€è¦é‡æ–°æ³¨å†Œ 12ls â€“w /path # ç›‘å¬ã€å­èŠ‚ç‚¹æ•°é‡ã€‘çš„å˜åŒ–get â€“w /path # ç›‘å¬ã€èŠ‚ç‚¹æ•°æ®ã€‘çš„å˜åŒ– å·¥ä½œæµç¨‹ï¼š åœ¨ä¸»çº¿ç¨‹ä¸­åˆ›å»º Zookeeper å®¢æˆ·ç«¯ï¼Œè¿™æ—¶å°±ä¼šåˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªè´Ÿè´£ç½‘ç»œè¿æ¥é€šä¿¡ï¼ˆconnetï¼‰ï¼Œä¸€ä¸ªè´Ÿè´£ç›‘å¬ï¼ˆlistenerï¼‰ é€šè¿‡ connect çº¿ç¨‹å°†æ³¨å†Œçš„ç›‘å¬äº‹ä»¶å‘é€ç»™ Zookeeper åœ¨ Zookeeper çš„æ³¨å†Œç›‘å¬å™¨åˆ—è¡¨ä¸­å°†æ³¨å†Œçš„ç›‘å¬äº‹ä»¶æ·»åŠ åˆ°åˆ—è¡¨ä¸­ Zookeeper ç›‘å¬åˆ°æœ‰æ•°æ®æˆ–è·¯å¾„å˜åŒ–ï¼Œå°†æ¶ˆæ¯å‘é€ç»™ listener çº¿ç¨‹ listener çº¿ç¨‹å†…éƒ¨è°ƒç”¨ process() æ–¹æ³• Curator æ¡†æ¶å¼•å…¥äº† Cache æ¥å®ç°å¯¹ ZooKeeper æœåŠ¡ç«¯äº‹ä»¶çš„ç›‘å¬ï¼Œä¸‰ç§ Watcherï¼š NodeCacheï¼šåªæ˜¯ç›‘å¬æŸä¸€ä¸ªç‰¹å®šçš„èŠ‚ç‚¹ PathChildrenCacheï¼šç›‘æ§ä¸€ä¸ª ZNode çš„å­èŠ‚ç‚¹ TreeCacheï¼šå¯ä»¥ç›‘æ§æ•´ä¸ªæ ‘ä¸Šçš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œç±»ä¼¼äº PathChildrenCache å’Œ NodeCache çš„ç»„åˆ ç›‘å¬æ¡ˆä¾‹æ•´ä½“æ¶æ„å®¢æˆ·ç«¯å®æ—¶ç›‘å¬æœåŠ¡å™¨åŠ¨æ€ä¸Šä¸‹çº¿ ä»£ç å®ç°å®¢æˆ·ç«¯ï¼šå…ˆå¯åŠ¨å®¢æˆ·ç«¯è¿›è¡Œç›‘å¬ 1234567891011121314151617181920212223242526272829303132333435363738394041424344public class DistributeClient &#123; private String connectString = &quot;192.168.3.128:2181&quot;; private int sessionTimeout = 20000; private ZooKeeper zk; public static void main(String[] args) throws Exception &#123; DistributeClient client = new DistributeClient(); // 1 è·å–zkè¿æ¥ client.getConnect(); // 2 ç›‘å¬/serversä¸‹é¢å­èŠ‚ç‚¹çš„å¢åŠ å’Œåˆ é™¤ client.getServerList(); // 3 ä¸šåŠ¡é€»è¾‘ client.business(); &#125; private void business() throws InterruptedException &#123; Thread.sleep(Long.MAX_VALUE); &#125; private void getServerList() throws KeeperException, InterruptedException &#123; ArrayList&lt;String&gt; servers = new ArrayList&lt;&gt;(); // è·å–æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œtrue ä»£è¡¨è§¦å‘ç›‘å¬æ“ä½œ List&lt;String&gt; children = zk.getChildren(&quot;/servers&quot;, true); for (String child : children) &#123; // è·å–å­èŠ‚ç‚¹çš„æ•°æ® byte[] data = zk.getData(&quot;/servers/&quot; + child, false, null); servers.add(new String(data)); &#125; System.out.println(servers); &#125; private void getConnect() throws IOException &#123; zk = new ZooKeeper(connectString, sessionTimeout, new Watcher() &#123; @Override public void process(WatchedEvent event) &#123; getServerList(); &#125; &#125;); &#125;&#125; æœåŠ¡ç«¯ï¼šå¯åŠ¨æ—¶éœ€è¦ Program arguments 1234567891011121314151617181920212223242526272829303132333435363738public class DistributeServer &#123; private String connectString = &quot;192.168.3.128:2181&quot;; private int sessionTimeout = 20000; private ZooKeeper zk; public static void main(String[] args) throws Exception &#123; DistributeServer server = new DistributeServer(); // 1 è·å– zookeeper è¿æ¥ server.getConnect(); // 2 æ³¨å†ŒæœåŠ¡å™¨åˆ° zk é›†ç¾¤ï¼Œæ³¨æ„å‚æ•° server.register(args[0]); // 3 å¯åŠ¨ä¸šåŠ¡é€»è¾‘ server.business(); &#125; private void business() throws InterruptedException &#123; Thread.sleep(Long.MAX_VALUE); &#125; private void register(String hostname) throws KeeperException, InterruptedException &#123; // OPEN_ACL_UNSAFE: ACL å¼€æ”¾ // EPHEMERAL_SEQUENTIAL: ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ String create = zk.create(&quot;/servers/&quot; + hostname, hostname.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL); System.out.println(hostname + &quot; is online&quot;); &#125; private void getConnect() throws IOException &#123; zk = new ZooKeeper(connectString, sessionTimeout, new Watcher() &#123; @Override public void process(WatchedEvent event) &#123; &#125; &#125;); &#125;&#125; åˆ†å¸ƒå¼é”å®ç°åŸç†åˆ†å¸ƒå¼é”å¯ä»¥å®ç°åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¤šä¸ªè¿›ç¨‹æœ‰åºçš„è®¿é—®è¯¥ä¸´ç•Œèµ„æºï¼Œå¤šä¸ªè¿›ç¨‹ä¹‹é—´ä¸ä¼šç›¸äº’å¹²æ‰° æ ¸å¿ƒæ€æƒ³ï¼šå½“å®¢æˆ·ç«¯è¦è·å–é”ï¼Œåˆ™åˆ›å»ºèŠ‚ç‚¹ï¼Œä½¿ç”¨å®Œé”ï¼Œåˆ™åˆ é™¤è¯¥èŠ‚ç‚¹ å®¢æˆ·ç«¯è·å–é”æ—¶ï¼Œåœ¨ &#x2F;locks èŠ‚ç‚¹ä¸‹åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹ ä½¿ç”¨ä¸´æ—¶èŠ‚ç‚¹æ˜¯ä¸ºäº†é˜²æ­¢å½“æœåŠ¡å™¨æˆ–å®¢æˆ·ç«¯å®•æœºä»¥åèŠ‚ç‚¹æ— æ³•åˆ é™¤ï¼ˆæŒä¹…èŠ‚ç‚¹ï¼‰ï¼Œå¯¼è‡´é”æ— æ³•é‡Šæ”¾ ä½¿ç”¨é¡ºåºèŠ‚ç‚¹æ˜¯ä¸ºäº†ç³»ç»Ÿè‡ªåŠ¨ç¼–å·æ’åºï¼Œæ‰¾æœ€å°çš„èŠ‚ç‚¹ï¼Œé˜²æ­¢å®¢æˆ·ç«¯é¥¥é¥¿ç°è±¡ï¼Œä¿è¯å…¬å¹³ è·å– &#x2F;locks ç›®å½•çš„æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œåˆ¤æ–­è‡ªå·±çš„å­èŠ‚ç‚¹åºå·æ˜¯å¦æœ€å°ï¼Œæˆç«‹åˆ™å®¢æˆ·ç«¯è·å–åˆ°é”ï¼Œä½¿ç”¨å®Œé”åå°†è¯¥èŠ‚ç‚¹åˆ é™¤ åä¹‹å®¢æˆ·ç«¯éœ€è¦æ‰¾åˆ°æ¯”è‡ªå·±å°çš„èŠ‚ç‚¹ï¼Œå¯¹å…¶æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ï¼Œç›‘å¬åˆ é™¤äº‹ä»¶ å®¢æˆ·ç«¯çš„ Watcher æ”¶åˆ°åˆ é™¤äº‹ä»¶é€šçŸ¥ï¼Œå°±ä¼šé‡æ–°åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦æ˜¯å­èŠ‚ç‚¹ä¸­åºå·æœ€å°ï¼Œå¦‚æœæ˜¯åˆ™è·å–åˆ°äº†é”ï¼Œ å¦‚æœä¸æ˜¯åˆ™é‡å¤ä»¥ä¸Šæ­¥éª¤ç»§ç»­è·å–åˆ°æ¯”è‡ªå·±å°çš„ä¸€ä¸ªèŠ‚ç‚¹å¹¶æ³¨å†Œç›‘å¬ CuratorCurator å®ç°åˆ†å¸ƒå¼é” APIï¼Œåœ¨ Curator ä¸­æœ‰äº”ç§é”æ–¹æ¡ˆï¼š InterProcessSemaphoreMutexï¼šåˆ†å¸ƒå¼æ’å®ƒé”ï¼ˆéå¯é‡å…¥é”ï¼‰ InterProcessMutexï¼šåˆ†å¸ƒå¼å¯é‡å…¥æ’å®ƒé” InterProcessReadWriteLockï¼šåˆ†å¸ƒå¼è¯»å†™é” InterProcessMultiLockï¼šå°†å¤šä¸ªé”ä½œä¸ºå•ä¸ªå®ä½“ç®¡ç†çš„å®¹å™¨ InterProcessSemaphoreV2ï¼šå…±äº«ä¿¡å·é‡ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354public class CuratorLock &#123; public static CuratorFramework getCuratorFramework() &#123; // é‡è¯•ç­–ç•¥å¯¹è±¡ ExponentialBackoffRetry policy = new ExponentialBackoffRetry(3000, 3); // æ„å»ºå®¢æˆ·ç«¯ CuratorFramework client = CuratorFrameworkFactory.builder() .connectString(&quot;192.168.3.128:2181&quot;) .connectionTimeoutMs(2000) // è¿æ¥è¶…æ—¶æ—¶é—´ .sessionTimeoutMs(20000) // ä¼šè¯è¶…æ—¶æ—¶é—´ å•ä½ms .retryPolicy(policy) // é‡è¯•ç­–ç•¥ .build(); // å¯åŠ¨å®¢æˆ·ç«¯ client.start(); System.out.println(&quot;zookeeper å¯åŠ¨æˆåŠŸ&quot;); return client; &#125; public static void main(String[] args) &#123; // åˆ›å»ºåˆ†å¸ƒå¼é”1 InterProcessMutex lock1 = new InterProcessMutex(getCuratorFramework(), &quot;/locks&quot;); // åˆ›å»ºåˆ†å¸ƒå¼é”2 InterProcessMutex lock2 = new InterProcessMutex(getCuratorFramework(), &quot;/locks&quot;); new Thread(new Runnable() &#123; @Override public void run() &#123; lock1.acquire(); System.out.println(&quot;çº¿ç¨‹1 è·å–åˆ°é”&quot;); Thread.sleep(5 * 1000); lock1.release(); System.out.println(&quot;çº¿ç¨‹1 é‡Šæ”¾é”&quot;); &#125; &#125;).start(); new Thread(new Runnable() &#123; @Override public void run() &#123; lock2.acquire(); System.out.println(&quot;çº¿ç¨‹2 è·å–åˆ°é”&quot;); Thread.sleep(5 * 1000); lock2.release(); System.out.println(&quot;çº¿ç¨‹2 é‡Šæ”¾é”&quot;); &#125; &#125;).start(); &#125;&#125; 1234567891011121314&lt;dependency&gt; &lt;groupId&gt;org.apache.curator&lt;/groupId&gt; &lt;artifactId&gt;curator-framework&lt;/artifactId&gt; &lt;version&gt;4.3.0&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.apache.curator&lt;/groupId&gt; &lt;artifactId&gt;curator-recipes&lt;/artifactId&gt; &lt;version&gt;4.3.0&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.apache.curator&lt;/groupId&gt; &lt;artifactId&gt;curator-client&lt;/artifactId&gt; &lt;version&gt;4.3.0&lt;/version&gt; æºç è§£ææœåŠ¡ç«¯æœåŠ¡ç«¯ç¨‹åºçš„å…¥å£ QuorumPeerMain 1234public static void main(String[] args) &#123; QuorumPeerMain main = new QuorumPeerMain(); main.initializeAndRun(args);&#125; initializeAndRun çš„å·¥ä½œï¼š è§£æå¯åŠ¨å‚æ•° æäº¤å‘¨æœŸä»»åŠ¡ï¼Œå®šæ—¶åˆ é™¤è¿‡æœŸçš„å¿«ç…§ åˆå§‹åŒ–é€šä¿¡æ¨¡å‹ï¼Œé»˜è®¤æ˜¯ NIO é€šä¿¡ 123456789// QuorumPeerMain#runFromConfigpublic void runFromConfig(QuorumPeerConfig config) &#123; // é€šä¿¡ä¿¡ç»„ä»¶åˆå§‹åŒ–ï¼Œé»˜è®¤æ˜¯ NIO é€šä¿¡ ServerCnxnFactory cnxnFactory = ServerCnxnFactory.createFactory(); // åˆå§‹åŒ–NIO æœåŠ¡ç«¯socketï¼Œç»‘å®š2181 ç«¯å£ï¼Œå¯ä»¥æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ cnxnFactory.configure(config.getClientPortAddress(), config.getMaxClientCnxns(), false); // å¯åŠ¨ zk quorumPeer.start();&#125; å¯åŠ¨ zookeeper 1234567891011121314151617181920// QuorumPeer#startpublic synchronized void start() &#123; if (!getView().containsKey(myid)) &#123; throw new RuntimeException(&quot;My id &quot; + myid + &quot; not in the peer list&quot;); &#125; // å†·å¯åŠ¨æ•°æ®æ¢å¤ï¼Œå°†å¿«ç…§ä¸­æ•°æ®æ¢å¤åˆ° DataTree loadDataBase(); // å¯åŠ¨é€šä¿¡å·¥å‚å®ä¾‹å¯¹è±¡ startServerCnxnFactory(); try &#123; adminServer.start(); &#125; catch (AdminServerException e) &#123; LOG.warn(&quot;Problem starting AdminServer&quot;, e); System.out.println(e); &#125; // å‡†å¤‡é€‰ä¸¾ç¯å¢ƒ startLeaderElection(); // æ‰§è¡Œé€‰ä¸¾ super.start();&#125; é€‰ä¸¾æœºåˆ¶ç¯å¢ƒå‡†å¤‡QuorumPeer#startLeaderElection åˆå§‹åŒ–é€‰ä¸¾ç¯å¢ƒï¼š 12345678910111213141516171819202122synchronized public void startLeaderElection() &#123; try &#123; // Looking çŠ¶æ€ï¼Œéœ€è¦é€‰ä¸¾ if (getPeerState() == ServerState.LOOKING) &#123; // é€‰ç¥¨ç»„ä»¶: myid (serverid), zxid, epoch // å¼€å§‹é€‰ç¥¨æ—¶ï¼Œserverid æ˜¯è‡ªå·±ï¼Œã€å…ˆæŠ•è‡ªå·±ã€‘ currentVote = new Vote(myid, getLastLoggedZxid(), getCurrentEpoch()); &#125; &#125; if (electionType == 0) &#123; try &#123; udpSocket = new DatagramSocket(getQuorumAddress().getPort()); // å“åº”æŠ•ç¥¨ç»“æœçº¿ç¨‹ responder = new ResponderThread(); responder.start(); &#125; catch (SocketException e) &#123; throw new RuntimeException(e); &#125; &#125; // åˆ›å»ºé€‰ä¸¾ç®—æ³•å®ä¾‹ this.electionAlg = createElectionAlgorithm(electionType);&#125; 123456789101112131415// zkæ€»çš„å‘é€å’Œæ¥æ”¶é˜Ÿåˆ—å‡†å¤‡å¥½protected Election createElectionAlgorithm(int electionAlgorithm)&#123; // è´Ÿè´£é€‰ä¸¾è¿‡ç¨‹ä¸­çš„æ‰€æœ‰ç½‘ç»œé€šä¿¡ï¼Œåˆ›å»ºå„ç§é˜Ÿåˆ—å’Œé›†åˆ QuorumCnxManager qcm = createCnxnManager(); QuorumCnxManager.Listener listener = qcm.listener; if(listener != null)&#123; // å¯åŠ¨ç›‘å¬çº¿ç¨‹, è°ƒç”¨ client = ss.accept()é˜»å¡ï¼Œç­‰å¾…å¤„ç†è¯·æ±‚ listener.start(); // å‡†å¤‡å¥½å‘é€å’Œæ¥æ”¶é˜Ÿåˆ—å‡†å¤‡ FastLeaderElection fle = new FastLeaderElection(this, qcm); // å¯åŠ¨é€‰ä¸¾çº¿ç¨‹ï¼Œã€WorkerSender å’Œ WorkerReceiverã€‘ fle.start(); le = fle; &#125;&#125; é€‰ä¸¾æºç å½“ Zookeeper å¯åŠ¨åï¼Œé¦–å…ˆéƒ½æ˜¯ Looking çŠ¶æ€ï¼Œé€šè¿‡é€‰ä¸¾è®©å…¶ä¸­ä¸€å°æœåŠ¡å™¨æˆä¸º Leader æ‰§è¡Œ super.start() ç›¸å½“äºæ‰§è¡Œ QuorumPeer#run() æ–¹æ³• 12345public void run() &#123; case LOOKING: // è¿›è¡Œé€‰ä¸¾ï¼Œé€‰ä¸¾ç»“æŸè¿”å›æœ€ç»ˆæˆä¸º Leader èƒœé€‰çš„é‚£å¼ é€‰ç¥¨ setCurrentVote(makeLEStrategy().lookForLeader());&#125; FastLeaderElection ç±»ï¼š lookForLeaderï¼šé€‰ä¸¾ 12345678910111213141516171819public Vote lookForLeader() &#123; // æ­£å¸¸å¯åŠ¨ä¸­å…¶ä»–æœåŠ¡å™¨éƒ½ä¼šå‘æˆ‘å‘é€ä¸€ä¸ªæŠ•ç¥¨ï¼Œä¿å­˜æ¯ä¸ªæœåŠ¡å™¨çš„æœ€æ–°åˆæ³•æœ‰æ•ˆçš„æŠ•ç¥¨ HashMap&lt;Long, Vote&gt; recvset = new HashMap&lt;Long, Vote&gt;(); // å­˜å‚¨åˆæ³•é€‰ä¸¾ä¹‹å¤–çš„æŠ•ç¥¨ç»“æœ HashMap&lt;Long, Vote&gt; outofelection = new HashMap&lt;Long, Vote&gt;(); // ä¸€æ¬¡é€‰ä¸¾çš„æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œé»˜è®¤å€¼æ˜¯0.2s int notTimeout = finalizeWait; // æ¯å‘èµ·ä¸€è½®é€‰ä¸¾ï¼Œlogicalclock++,åœ¨æ²¡æœ‰åˆæ³•çš„epoch æ•°æ®ä¹‹å‰ï¼Œéƒ½ä½¿ç”¨é€»è¾‘æ—¶é’Ÿä»£æ›¿ synchronized(this)&#123; // æ›´æ–°é€»è¾‘æ—¶é’Ÿï¼Œæ¯è¿›è¡Œä¸€æ¬¡é€‰ä¸¾ï¼Œéƒ½éœ€è¦æ›´æ–°é€»è¾‘æ—¶é’Ÿ logicalclock.incrementAndGet(); // æ›´æ–°é€‰ç¥¨(serveridï¼Œ zxid, epochï¼‰ updateProposal(getInitId(), getInitLastLoggedZxid(), getPeerEpoch()); &#125; // å¹¿æ’­é€‰ç¥¨ï¼ŒæŠŠè‡ªå·±çš„é€‰ç¥¨å‘ç»™å…¶ä»–æœåŠ¡å™¨ sendNotifications(); // ä¸€è½®ä¸€è½®çš„é€‰ä¸¾ç›´åˆ°é€‰ä¸¾æˆåŠŸ while ((self.getPeerState() == ServerState.LOOKING) &amp;&amp; (!stop))&#123; &#125;&#125; sendNotificationsï¼šå¹¿æ’­é€‰ç¥¨ 123456789private void sendNotifications() &#123; // éå†æŠ•ç¥¨å‚ä¸è€…ï¼Œç»™æ¯å°æœåŠ¡å™¨å‘é€é€‰ç¥¨ for (long sid : self.getCurrentAndNextConfigVoters()) &#123; // åˆ›å»ºå‘é€é€‰ç¥¨ ToSend notmsg = new ToSend(...); // æŠŠå‘é€é€‰ç¥¨æ”¾å…¥å‘é€é˜Ÿåˆ— sendqueue.offer(notmsg); &#125;&#125; FastLeaderElection ä¸­æœ‰ WorkerSender çº¿ç¨‹ï¼š ToSend m = sendqueue.poll(3000, TimeUnit.MILLISECONDS)ï¼šé˜»å¡è·å–è¦å‘é€çš„é€‰ç¥¨ process(m)ï¼šå¤„ç†è¦å‘é€çš„é€‰ç¥¨ manager.toSend(m.sid, requestBuffer)ï¼šå‘é€é€‰ç¥¨ if (this.mySid == sid)ï¼šå¦‚æœæ¶ˆæ¯çš„æ¥æ”¶è€… sid æ˜¯è‡ªå·±ï¼Œç›´æ¥è¿›å…¥è‡ªå·±çš„ RecvQueueï¼ˆè‡ªå·±æŠ•è‡ªå·±ï¼‰ elseï¼šå¦‚æœæ¥æ”¶è€…æ˜¯å…¶ä»–æœåŠ¡å™¨ï¼Œåˆ›å»ºå¯¹åº”çš„å‘é€é˜Ÿåˆ—æˆ–è€…å¤ç”¨å·²ç»å­˜åœ¨çš„å‘é€é˜Ÿåˆ—ï¼ŒæŠŠæ¶ˆæ¯æ”¾å…¥è¯¥é˜Ÿåˆ— connectOne(sid)ï¼šå»ºç«‹è¿æ¥ sock.connect(electionAddr, cnxTO)ï¼šå»ºç«‹ä¸ sid æœåŠ¡å™¨çš„è¿æ¥ initiateConnection(sock, sid)ï¼šåˆå§‹åŒ–è¿æ¥ startConnection(sock, sid)ï¼šåˆ›å»ºå¹¶å¯åŠ¨å‘é€å™¨çº¿ç¨‹å’Œæ¥æ”¶å™¨çº¿ç¨‹ dout = new DataOutputStream(buf)ï¼šè·å– Socket è¾“å‡ºæµï¼Œå‘æœåŠ¡å™¨å‘é€æ•°æ® din = new DataInputStream(new BIS(sock.getInputStream())))ï¼šé€šè¿‡è¾“å…¥æµè¯»å–å¯¹æ–¹å‘é€è¿‡æ¥çš„é€‰ç¥¨ if (sid &gt; self.getId())ï¼šæ¥æ”¶è€… sid æ¯”æˆ‘çš„å¤§ï¼Œæ²¡æœ‰èµ„æ ¼ç»™å¯¹æ–¹å‘é€è¿æ¥è¯·æ±‚çš„ï¼Œç›´æ¥å…³é—­è‡ªå·±çš„å®¢æˆ·ç«¯ SendWorker swï¼šåˆå§‹åŒ–å‘é€å™¨ï¼Œå¹¶å¯åŠ¨å‘é€å™¨çº¿ç¨‹ï¼Œçº¿ç¨‹ run æ–¹æ³• while (running &amp;&amp; !shutdown &amp;&amp; sock != null)ï¼šè¿æ¥æ²¡æœ‰æ–­å¼€å°±ä¸€ç›´è¿è¡Œ ByteBuffer b = pollSendQueue()ï¼šä»å‘é€é˜Ÿåˆ— SendQueue ä¸­è·å–å‘é€æ¶ˆæ¯ lastMessageSent.put(sid, b)ï¼šæ›´æ–°å¯¹äº sid è¿™å°æœåŠ¡å™¨çš„æœ€è¿‘ä¸€æ¡æ¶ˆæ¯ send(b)ï¼šæ‰§è¡Œå‘é€ RecvWorker rwï¼šåˆå§‹åŒ–æ¥æ”¶å™¨ï¼Œå¹¶å¯åŠ¨æ¥æ”¶å™¨çº¿ç¨‹ din.readFully(msgArray, 0, length)ï¼šè¾“å…¥æµæ¥æ”¶æ¶ˆæ¯ addToRecvQueue(new Message(messagg, sid))ï¼šå°†æ¶ˆæ¯æ”¾å…¥æ¥æ”¶æ¶ˆæ¯ recvQueue é˜Ÿåˆ— FastLeaderElection ä¸­æœ‰ WorkerReceiver çº¿ç¨‹ response = manager.pollRecvQueue()ï¼šä» RecvQueue ä¸­é˜»å¡è·å–å‡ºé€‰ä¸¾æŠ•ç¥¨æ¶ˆæ¯ï¼ˆå…¶ä»–æœåŠ¡å™¨å‘é€è¿‡æ¥çš„ï¼‰ çŠ¶æ€åŒæ­¥é€‰ä¸¾ç»“æŸåï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ ¹æ®è§’è‰²æ›´æ–°è‡ªå·±çš„çŠ¶æ€ï¼ŒLeader æ›´æ–°çŠ¶æ€ä¸º Leaderï¼Œå…¶ä»–èŠ‚ç‚¹æ›´æ–°çŠ¶æ€ä¸º Followerï¼Œæ•´ä½“æµç¨‹ï¼š Follower éœ€è¦è®© Leader çŸ¥é“è‡ªå·±çš„çŠ¶æ€ (sid, epoch, zxid) Leader æ¥æ”¶åˆ°ä¿¡æ¯ï¼Œæ ¹æ®ä¿¡æ¯æ„å»ºæ–°çš„ epochï¼Œè¦è¿”å›å¯¹åº”çš„ä¿¡æ¯ç»™ Followerï¼ŒFollower æ›´æ–°è‡ªå·±çš„ epoch Leader éœ€è¦æ ¹æ® Follower çš„çŠ¶æ€ï¼Œç¡®å®šä½•ç§æ–¹å¼çš„æ•°æ®åŒæ­¥ DIFFã€TRUNCã€SNAPï¼Œå°±æ˜¯è¦ä»¥ Leader æœåŠ¡å™¨æ•°æ®ä¸ºå‡† DIFFï¼šLeader æäº¤çš„ zxid æ¯” Follower çš„ zxid å¤§ï¼Œå‘é€ Proposal ç»™ Follower æäº¤æ‰§è¡Œ TRUNCï¼šFollower çš„ zxid æ¯”leader çš„ zxid å¤§ï¼ŒFollower è¦è¿›è¡Œå›æ»š SNAPï¼šFollower æ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œç›´æ¥å…¨é‡åŒæ­¥ æ‰§è¡Œæ•°æ®åŒæ­¥ï¼Œå½“ Leader æ¥æ”¶åˆ°è¶…è¿‡åŠæ•° Follower çš„ Ack ä¹‹åï¼Œè¿›å…¥æ­£å¸¸å·¥ä½œçŠ¶æ€ï¼Œé›†ç¾¤å¯åŠ¨å®Œæˆ æ ¸å¿ƒå‡½æ•°è§£æï¼š Leader æ›´æ–°çŠ¶æ€å…¥å£ï¼šLeader.lead() zk.loadData()ï¼šæ¢å¤æ•°æ®åˆ°å†…å­˜ cnxAcceptor = new LearnerCnxAcceptor()ï¼šå¯åŠ¨é€šä¿¡ç»„ä»¶ s = ss.accept()ï¼šç­‰å¾…å…¶ä»– Follower èŠ‚ç‚¹å‘ Leader èŠ‚ç‚¹å‘é€åŒæ­¥çŠ¶æ€ LearnerHandler fh ï¼šæ¥æ”¶åˆ° Follower çš„è¯·æ±‚ï¼Œå°±åˆ›å»º LearnerHandler å¯¹è±¡ fh.start()ï¼šå¯åŠ¨çº¿ç¨‹ï¼Œé€šè¿‡ switch-case è¯­æ³•åˆ¤æ–­æ¥æ”¶çš„å‘½ä»¤ï¼Œæ‰§è¡Œç›¸åº”çš„æ“ä½œ Follower æ›´æ–°çŠ¶æ€å…¥å£ï¼šFollower.followerLeader() QuorumServer leaderServer = findLeader()ï¼šæŸ¥æ‰¾ Leader connectToLeader(addr, hostname) ï¼šä¸ Leader å»ºç«‹è¿æ¥ long newEpochZxid = registerWithLeader(Leader.FOLLOWERINFO)ï¼šå‘ Leader æ³¨å†Œ ä¸»ä»å·¥ä½œLeaderï¼šä¸»æœåŠ¡çš„å·¥ä½œæµç¨‹ Followerï¼šä»æœåŠ¡çš„å·¥ä½œæµç¨‹ï¼Œæ ¸å¿ƒå‡½æ•°ä¸º Follower#followLeader() readPacket(qp)ï¼šè¯»å–ä¿¡æ¯ processPacket(qp)ï¼šå¤„ç†ä¿¡æ¯ 1234567891011121314151617181920protected void processPacket(QuorumPacket qp) throws Exception&#123; switch (qp.getType()) &#123; case Leader.PING: break; case Leader.PROPOSAL: break; case Leader.COMMIT: break; case Leader.COMMITANDACTIVATE: break; case Leader.UPTODATE: break; case Leader.REVALIDATE: break; case Leader.SYNC: break; default: break; &#125;&#125; å®¢æˆ·ç«¯","categories":[],"tags":[]},{"title":"","slug":"DB","date":"2025-05-20T16:25:06.344Z","updated":"2023-04-07T03:39:44.000Z","comments":true,"path":"2025/05/21/DB/","link":"","permalink":"https://dddwah11.github.io/2025/05/21/DB/","excerpt":"","text":"MySQLç®€ä»‹æ•°æ®åº“æ•°æ®åº“ï¼šDataBaseï¼Œç®€ç§° DBï¼Œå­˜å‚¨å’Œç®¡ç†æ•°æ®çš„ä»“åº“ æ•°æ®åº“çš„ä¼˜åŠ¿ï¼š å¯ä»¥æŒä¹…åŒ–å­˜å‚¨æ•°æ® æ–¹ä¾¿å­˜å‚¨å’Œç®¡ç†æ•°æ® ä½¿ç”¨äº†ç»Ÿä¸€çš„æ–¹å¼æ“ä½œæ•°æ®åº“ SQL æ•°æ®åº“ã€æ•°æ®è¡¨ã€æ•°æ®çš„å…³ç³»ä»‹ç»ï¼š æ•°æ®åº“ ç”¨äºå­˜å‚¨å’Œç®¡ç†æ•°æ®çš„ä»“åº“ ä¸€ä¸ªåº“ä¸­å¯ä»¥åŒ…å«å¤šä¸ªæ•°æ®è¡¨ æ•°æ®è¡¨ æ•°æ®åº“æœ€é‡è¦çš„ç»„æˆéƒ¨åˆ†ä¹‹ä¸€ ç”±çºµå‘çš„åˆ—å’Œæ¨ªå‘çš„è¡Œç»„æˆï¼ˆç±»ä¼¼ excel è¡¨æ ¼ï¼‰ å¯ä»¥æŒ‡å®šåˆ—åã€æ•°æ®ç±»å‹ã€çº¦æŸç­‰ ä¸€ä¸ªè¡¨ä¸­å¯ä»¥å­˜å‚¨å¤šæ¡æ•°æ® æ•°æ®ï¼šæƒ³è¦æ°¸ä¹…åŒ–å­˜å‚¨çš„æ•°æ® å‚è€ƒè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV1zJ411M7TB å‚è€ƒä¸“æ ï¼šhttps://time.geekbang.org/column/intro/139 å‚è€ƒä¹¦ç±ï¼šhttps://book.douban.com/subject/35231266/ MySQLMySQL æ•°æ®åº“æ˜¯ä¸€ä¸ªæœ€æµè¡Œçš„å…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿä¹‹ä¸€ï¼Œå…³ç³»å‹æ•°æ®åº“æ˜¯å°†æ•°æ®ä¿å­˜åœ¨ä¸åŒçš„æ•°æ®è¡¨ä¸­ï¼Œè€Œä¸”è¡¨ä¸è¡¨ä¹‹é—´å¯ä»¥æœ‰å…³è”å…³ç³»ï¼Œæé«˜äº†çµæ´»æ€§ ç¼ºç‚¹ï¼šæ•°æ®å­˜å‚¨åœ¨ç£ç›˜ä¸­ï¼Œå¯¼è‡´è¯»å†™æ€§èƒ½å·®ï¼Œè€Œä¸”æ•°æ®å…³ç³»å¤æ‚ï¼Œæ‰©å±•æ€§å·® MySQL æ‰€ä½¿ç”¨çš„ SQL è¯­å¥æ˜¯ç”¨äºè®¿é—®æ•°æ®åº“æœ€å¸¸ç”¨çš„æ ‡å‡†åŒ–è¯­è¨€ MySQL é…ç½®ï¼š MySQL å®‰è£…ï¼šhttps://www.jianshu.com/p/ba48f1e386f0 MySQL é…ç½®ï¼š ä¿®æ”¹ MySQL é»˜è®¤å­—ç¬¦é›†ï¼šå®‰è£… MySQL ä¹‹åç¬¬ä¸€ä»¶äº‹å°±æ˜¯ä¿®æ”¹å­—ç¬¦é›†ç¼–ç  123456789vim /etc/mysql/my.cnfæ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š[mysqld]character-set-server=utf8collation-server=utf8_general_ci[client]default-character-set=utf8 å¯åŠ¨ MySQL æœåŠ¡ï¼š 1systemctl start/restart mysql ç™»å½• MySQLï¼š 123mysql -u root -p æ•²å›è½¦ï¼Œè¾“å…¥å¯†ç åˆå§‹å¯†ç æŸ¥çœ‹ï¼šcat /var/log/mysqld.logåœ¨root@localhost: åé¢çš„å°±æ˜¯åˆå§‹å¯†ç  æŸ¥çœ‹é»˜è®¤å­—ç¬¦é›†å‘½ä»¤ï¼š 1SHOW VARIABLES LIKE &#x27;char%&#x27;; ä¿®æ”¹MySQLç™»å½•å¯†ç ï¼š 1234set global validate_password_policy=0;set global validate_password_length=1; set password=password(&#x27;å¯†ç &#x27;); æˆäºˆè¿œç¨‹è¿æ¥æƒé™ï¼ˆMySQL å†…è¾“å…¥ï¼‰ï¼š 1234-- æˆæƒgrant all privileges on *.* to &#x27;root&#x27; @&#x27;%&#x27; identified by &#x27;å¯†ç &#x27;;-- åˆ·æ–°flush privileges; ä¿®æ”¹ MySQL ç»‘å®š IPï¼š 1234cd /etc/mysql/mysql.conf.dsudo chmod 666 mysqld.cnf vim mysqld.cnf # bind-address = 127.0.0.1æ³¨é‡Šè¯¥è¡Œ å…³é—­ Linux é˜²ç«å¢™ 12systemctl stop firewalld.service# æ”¾è¡Œ3306ç«¯å£ ä½“ç³»æ¶æ„æ•´ä½“æ¶æ„ä½“ç³»ç»“æ„è¯¦è§£ï¼š ç¬¬ä¸€å±‚ï¼šç½‘ç»œè¿æ¥å±‚ ä¸€äº›å®¢æˆ·ç«¯å’Œé“¾æ¥æœåŠ¡ï¼ŒåŒ…å«æœ¬åœ° Socket é€šä¿¡å’Œå¤§å¤šæ•°åŸºäºå®¢æˆ·ç«¯&#x2F;æœåŠ¡ç«¯å·¥å…·å®ç°çš„ TCP&#x2F;IP é€šä¿¡ï¼Œä¸»è¦å®Œæˆä¸€äº›ç±»ä¼¼äºè¿æ¥å¤„ç†ã€æˆæƒè®¤è¯ã€åŠç›¸å…³çš„å®‰å…¨æ–¹æ¡ˆ åœ¨è¯¥å±‚ä¸Šå¼•å…¥äº†è¿æ¥æ±  Connection Pool çš„æ¦‚å¿µï¼Œç®¡ç†ç¼“å†²ç”¨æˆ·è¿æ¥ï¼Œçº¿ç¨‹å¤„ç†ç­‰éœ€è¦ç¼“å­˜çš„éœ€æ±‚ åœ¨è¯¥å±‚ä¸Šå®ç°åŸºäº SSL çš„å®‰å…¨é“¾æ¥ï¼ŒæœåŠ¡å™¨ä¹Ÿä¼šä¸ºå®‰å…¨æ¥å…¥çš„æ¯ä¸ªå®¢æˆ·ç«¯éªŒè¯å®ƒæ‰€å…·æœ‰çš„æ“ä½œæƒé™ ç¬¬äºŒå±‚ï¼šæ ¸å¿ƒæœåŠ¡å±‚ æŸ¥è¯¢ç¼“å­˜ã€åˆ†æå™¨ã€ä¼˜åŒ–å™¨ã€æ‰§è¡Œå™¨ç­‰ï¼Œæ¶µç›– MySQL çš„å¤§å¤šæ•°æ ¸å¿ƒæœåŠ¡åŠŸèƒ½ï¼Œæ‰€æœ‰çš„å†…ç½®å‡½æ•°ï¼ˆæ—¥æœŸã€æ•°å­¦ã€åŠ å¯†å‡½æ•°ç­‰ï¼‰ Management Serveices &amp; Utilitiesï¼šç³»ç»Ÿç®¡ç†å’Œæ§åˆ¶å·¥å…·ï¼Œå¤‡ä»½ã€å®‰å…¨ã€å¤åˆ¶ã€é›†ç¾¤ç­‰ SQL Interfaceï¼šæ¥å—ç”¨æˆ·çš„ SQL å‘½ä»¤ï¼Œå¹¶ä¸”è¿”å›ç”¨æˆ·éœ€è¦æŸ¥è¯¢çš„ç»“æœ Parserï¼šSQL è¯­å¥åˆ†æå™¨ Optimizerï¼šæŸ¥è¯¢ä¼˜åŒ–å™¨ Caches &amp; Buffersï¼šæŸ¥è¯¢ç¼“å­˜ï¼ŒæœåŠ¡å™¨ä¼šæŸ¥è¯¢å†…éƒ¨çš„ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜ç©ºé—´è¶³å¤Ÿå¤§ï¼Œå¯ä»¥åœ¨å¤§é‡è¯»æ“ä½œçš„ç¯å¢ƒä¸­æå‡ç³»ç»Ÿæ€§èƒ½ æ‰€æœ‰è·¨å­˜å‚¨å¼•æ“çš„åŠŸèƒ½åœ¨è¿™ä¸€å±‚å®ç°ï¼Œå¦‚å­˜å‚¨è¿‡ç¨‹ã€è§¦å‘å™¨ã€è§†å›¾ç­‰ åœ¨è¯¥å±‚æœåŠ¡å™¨ä¼šè§£ææŸ¥è¯¢å¹¶åˆ›å»ºç›¸åº”çš„å†…éƒ¨è§£ææ ‘ï¼Œå¹¶å¯¹å…¶å®Œæˆç›¸åº”çš„ä¼˜åŒ–å¦‚ç¡®å®šè¡¨çš„æŸ¥è¯¢é¡ºåºï¼Œæ˜¯å¦åˆ©ç”¨ç´¢å¼•ç­‰ï¼Œ æœ€åç”Ÿæˆç›¸åº”çš„æ‰§è¡Œæ“ä½œ MySQL ä¸­æœåŠ¡å™¨å±‚ä¸ç®¡ç†äº‹åŠ¡ï¼Œäº‹åŠ¡æ˜¯ç”±å­˜å‚¨å¼•æ“å®ç°çš„ ç¬¬ä¸‰å±‚ï¼šå­˜å‚¨å¼•æ“å±‚ Pluggable Storage Enginesï¼šå­˜å‚¨å¼•æ“æ¥å£ï¼ŒMySQL åŒºåˆ«äºå…¶ä»–æ•°æ®åº“çš„é‡è¦ç‰¹ç‚¹å°±æ˜¯å…¶å­˜å‚¨å¼•æ“çš„æ¶æ„æ¨¡å¼æ˜¯æ’ä»¶å¼çš„ï¼ˆå­˜å‚¨å¼•æ“æ˜¯åŸºäºè¡¨çš„ï¼Œè€Œä¸æ˜¯æ•°æ®åº“ï¼‰ å­˜å‚¨å¼•æ“çœŸæ­£çš„è´Ÿè´£äº† MySQL ä¸­æ•°æ®çš„å­˜å‚¨å’Œæå–ï¼ŒæœåŠ¡å™¨é€šè¿‡ API å’Œå­˜å‚¨å¼•æ“è¿›è¡Œé€šä¿¡ ä¸åŒçš„å­˜å‚¨å¼•æ“å…·æœ‰ä¸åŒçš„åŠŸèƒ½ï¼Œå…±ç”¨ä¸€ä¸ª Server å±‚ï¼Œå¯ä»¥æ ¹æ®å¼€å‘çš„éœ€è¦ï¼Œæ¥é€‰å–åˆé€‚çš„å­˜å‚¨å¼•æ“ ç¬¬å››å±‚ï¼šç³»ç»Ÿæ–‡ä»¶å±‚ æ•°æ®å­˜å‚¨å±‚ï¼Œä¸»è¦æ˜¯å°†æ•°æ®å­˜å‚¨åœ¨æ–‡ä»¶ç³»ç»Ÿä¹‹ä¸Šï¼Œå¹¶å®Œæˆä¸å­˜å‚¨å¼•æ“çš„äº¤äº’ File Systemï¼šæ–‡ä»¶ç³»ç»Ÿï¼Œä¿å­˜é…ç½®æ–‡ä»¶ã€æ•°æ®æ–‡ä»¶ã€æ—¥å¿—æ–‡ä»¶ã€é”™è¯¯æ–‡ä»¶ã€äºŒè¿›åˆ¶æ–‡ä»¶ç­‰ å»ºç«‹è¿æ¥è¿æ¥å™¨æ± åŒ–æŠ€æœ¯ï¼šå¯¹äºè®¿é—®æ•°æ®åº“æ¥è¯´ï¼Œå»ºç«‹è¿æ¥çš„ä»£ä»·æ˜¯æ¯”è¾ƒæ˜‚è´µçš„ï¼Œå› ä¸ºæ¯ä¸ªè¿æ¥å¯¹åº”ä¸€ä¸ªç”¨æ¥äº¤äº’çš„çº¿ç¨‹ï¼Œé¢‘ç¹çš„åˆ›å»ºå…³é—­è¿æ¥æ¯”è¾ƒè€—è´¹èµ„æºï¼Œæœ‰å¿…è¦å»ºç«‹æ•°æ®åº“è¿æ¥æ± ï¼Œä»¥æé«˜è®¿é—®çš„æ€§èƒ½ è¿æ¥å»ºç«‹ TCP ä»¥åéœ€è¦åšæƒé™éªŒè¯ï¼ŒéªŒè¯æˆåŠŸåå¯ä»¥è¿›è¡Œæ‰§è¡Œ SQLã€‚å¦‚æœè¿™æ—¶ç®¡ç†å‘˜è´¦å·å¯¹è¿™ä¸ªç”¨æˆ·çš„æƒé™åšäº†ä¿®æ”¹ï¼Œä¹Ÿä¸ä¼šå½±å“å·²ç»å­˜åœ¨è¿æ¥çš„æƒé™ï¼Œåªæœ‰å†æ–°å»ºçš„è¿æ¥æ‰ä¼šä½¿ç”¨æ–°çš„æƒé™è®¾ç½® MySQL æœåŠ¡å™¨å¯ä»¥åŒæ—¶å’Œå¤šä¸ªå®¢æˆ·ç«¯è¿›è¡Œäº¤äº’ï¼Œæ‰€ä»¥è¦ä¿è¯æ¯ä¸ªè¿æ¥ä¼šè¯çš„éš”ç¦»æ€§ï¼ˆäº‹åŠ¡æœºåˆ¶éƒ¨åˆ†è¯¦è§£ï¼‰ æ•´ä½“çš„æ‰§è¡Œæµç¨‹ï¼š æƒé™ä¿¡æ¯grant è¯­å¥ä¼šåŒæ—¶ä¿®æ”¹æ•°æ®è¡¨å’Œå†…å­˜ï¼Œåˆ¤æ–­æƒé™çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯å†…å­˜æ•°æ® flush privileges è¯­å¥æœ¬èº«ä¼šç”¨æ•°æ®è¡¨ï¼ˆç£ç›˜ï¼‰çš„æ•°æ®é‡å»ºä¸€ä»½å†…å­˜æƒé™æ•°æ®ï¼Œæ‰€ä»¥åœ¨æƒé™æ•°æ®å¯èƒ½å­˜åœ¨ä¸ä¸€è‡´çš„æƒ…å†µä¸‹ä½¿ç”¨ï¼Œè¿™ç§ä¸ä¸€è‡´å¾€å¾€æ˜¯ç”±äºç›´æ¥ç”¨ DML è¯­å¥æ“ä½œç³»ç»Ÿæƒé™è¡¨å¯¼è‡´çš„ï¼Œæ‰€ä»¥å°½é‡ä¸è¦ä½¿ç”¨è¿™ç±»è¯­å¥ è¿æ¥çŠ¶æ€å®¢æˆ·ç«¯å¦‚æœé•¿æ—¶é—´æ²¡æœ‰æ“ä½œï¼Œè¿æ¥å™¨å°±ä¼šè‡ªåŠ¨æ–­å¼€ï¼Œæ—¶é—´æ˜¯ç”±å‚æ•° wait_timeout æ§åˆ¶çš„ï¼Œé»˜è®¤å€¼æ˜¯ 8 å°æ—¶ã€‚å¦‚æœåœ¨è¿æ¥è¢«æ–­å¼€ä¹‹åï¼Œå®¢æˆ·ç«¯å†æ¬¡å‘é€è¯·æ±‚çš„è¯ï¼Œå°±ä¼šæ”¶åˆ°ä¸€ä¸ªé”™è¯¯æé†’ï¼šLost connection to MySQL server during query æ•°æ®åº“é‡Œé¢ï¼Œé•¿è¿æ¥æ˜¯æŒ‡è¿æ¥æˆåŠŸåï¼Œå¦‚æœå®¢æˆ·ç«¯æŒç»­æœ‰è¯·æ±‚ï¼Œåˆ™ä¸€ç›´ä½¿ç”¨åŒä¸€ä¸ªè¿æ¥ï¼›çŸ­è¿æ¥åˆ™æ˜¯æŒ‡æ¯æ¬¡æ‰§è¡Œå®Œå¾ˆå°‘çš„å‡ æ¬¡æŸ¥è¯¢å°±æ–­å¼€è¿æ¥ï¼Œä¸‹æ¬¡æŸ¥è¯¢å†é‡æ–°å»ºç«‹ä¸€ä¸ª ä¸ºäº†å‡å°‘è¿æ¥çš„åˆ›å»ºï¼Œæ¨èä½¿ç”¨é•¿è¿æ¥ï¼Œä½†æ˜¯è¿‡å¤šçš„é•¿è¿æ¥ä¼šé€ æˆ OOMï¼Œè§£å†³æ–¹æ¡ˆï¼š å®šæœŸæ–­å¼€é•¿è¿æ¥ï¼Œä½¿ç”¨ä¸€æ®µæ—¶é—´ï¼Œæˆ–è€…ç¨‹åºé‡Œé¢åˆ¤æ–­æ‰§è¡Œè¿‡ä¸€ä¸ªå ç”¨å†…å­˜çš„å¤§æŸ¥è¯¢åï¼Œæ–­å¼€è¿æ¥ï¼Œä¹‹åè¦æŸ¥è¯¢å†é‡è¿ 1KILL CONNECTION id MySQL 5.7 ç‰ˆæœ¬ï¼Œå¯ä»¥åœ¨æ¯æ¬¡æ‰§è¡Œä¸€ä¸ªæ¯”è¾ƒå¤§çš„æ“ä½œåï¼Œé€šè¿‡æ‰§è¡Œ mysql_reset_connection æ¥é‡æ–°åˆå§‹åŒ–è¿æ¥èµ„æºï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸éœ€è¦é‡è¿å’Œé‡æ–°åšæƒé™éªŒè¯ï¼Œä½†æ˜¯ä¼šå°†è¿æ¥æ¢å¤åˆ°åˆšåˆšåˆ›å»ºå®Œæ—¶çš„çŠ¶æ€ SHOW PROCESSLISTï¼šæŸ¥çœ‹å½“å‰ MySQL åœ¨è¿›è¡Œçš„çº¿ç¨‹ï¼Œå¯ä»¥å®æ—¶åœ°æŸ¥çœ‹ SQL çš„æ‰§è¡Œæƒ…å†µï¼Œå…¶ä¸­çš„ Command åˆ—æ˜¾ç¤ºä¸º Sleep çš„è¿™ä¸€è¡Œï¼Œå°±è¡¨ç¤ºç°åœ¨ç³»ç»Ÿé‡Œé¢æœ‰ä¸€ä¸ªç©ºé—²è¿æ¥ å‚æ•° å«ä¹‰ ID ç”¨æˆ·ç™»å½• mysql æ—¶ç³»ç»Ÿåˆ†é…çš„ connection_idï¼Œå¯ä»¥ä½¿ç”¨å‡½æ•° connection_id() æŸ¥çœ‹ User æ˜¾ç¤ºå½“å‰ç”¨æˆ·ï¼Œå¦‚æœä¸æ˜¯ rootï¼Œè¿™ä¸ªå‘½ä»¤å°±åªæ˜¾ç¤ºç”¨æˆ·æƒé™èŒƒå›´çš„ sql è¯­å¥ Host æ˜¾ç¤ºè¿™ä¸ªè¯­å¥æ˜¯ä»å“ªä¸ª ip çš„å“ªä¸ªç«¯å£ä¸Šå‘çš„ï¼Œå¯ä»¥ç”¨æ¥è·Ÿè¸ªå‡ºç°é—®é¢˜è¯­å¥çš„ç”¨æˆ· db æ˜¾ç¤ºè¿™ä¸ªè¿›ç¨‹ç›®å‰è¿æ¥çš„æ˜¯å“ªä¸ªæ•°æ®åº“ Command æ˜¾ç¤ºå½“å‰è¿æ¥çš„æ‰§è¡Œçš„å‘½ä»¤ï¼Œä¸€èˆ¬å–å€¼ä¸ºä¼‘çœ  Sleepã€æŸ¥è¯¢ Queryã€è¿æ¥ Connect ç­‰ Time æ˜¾ç¤ºè¿™ä¸ªçŠ¶æ€æŒç»­çš„æ—¶é—´ï¼Œå•ä½æ˜¯ç§’ State æ˜¾ç¤ºä½¿ç”¨å½“å‰è¿æ¥çš„ sql è¯­å¥çš„çŠ¶æ€ï¼Œä»¥æŸ¥è¯¢ä¸ºä¾‹ï¼Œéœ€è¦ç»è¿‡ copying to tmp tableã€sorting resultã€sending dataç­‰çŠ¶æ€æ‰å¯ä»¥å®Œæˆ Info æ˜¾ç¤ºæ‰§è¡Œçš„ sql è¯­å¥ï¼Œæ˜¯åˆ¤æ–­é—®é¢˜è¯­å¥çš„ä¸€ä¸ªé‡è¦ä¾æ® Sending data çŠ¶æ€è¡¨ç¤º MySQL çº¿ç¨‹å¼€å§‹è®¿é—®æ•°æ®è¡Œå¹¶æŠŠç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œè€Œä¸ä»…ä»…åªæ˜¯è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œæ˜¯å¤„äºæ‰§è¡Œå™¨è¿‡ç¨‹ä¸­çš„ä»»æ„é˜¶æ®µã€‚ç”±äºåœ¨ Sending data çŠ¶æ€ä¸‹ï¼ŒMySQL çº¿ç¨‹éœ€è¦åšå¤§é‡ç£ç›˜è¯»å–æ“ä½œï¼Œæ‰€ä»¥æ˜¯æ•´ä¸ªæŸ¥è¯¢ä¸­è€—æ—¶æœ€é•¿çš„çŠ¶æ€ æ‰§è¡Œæµç¨‹æŸ¥è¯¢ç¼“å­˜å·¥ä½œæµç¨‹å½“æ‰§è¡Œå®Œå…¨ç›¸åŒçš„ SQL è¯­å¥çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨å°±ä¼šç›´æ¥ä»ç¼“å­˜ä¸­è¯»å–ç»“æœï¼Œå½“æ•°æ®è¢«ä¿®æ”¹ï¼Œä¹‹å‰çš„ç¼“å­˜ä¼šå¤±æ•ˆï¼Œä¿®æ”¹æ¯”è¾ƒé¢‘ç¹çš„è¡¨ä¸é€‚åˆåšæŸ¥è¯¢ç¼“å­˜ æŸ¥è¯¢è¿‡ç¨‹ï¼š å®¢æˆ·ç«¯å‘é€ä¸€æ¡æŸ¥è¯¢ç»™æœåŠ¡å™¨ æœåŠ¡å™¨å…ˆä¼šæ£€æŸ¥æŸ¥è¯¢ç¼“å­˜ï¼Œå¦‚æœå‘½ä¸­äº†ç¼“å­˜ï¼Œåˆ™ç«‹å³è¿”å›å­˜å‚¨åœ¨ç¼“å­˜ä¸­çš„ç»“æœï¼ˆä¸€èˆ¬æ˜¯ K-V é”®å€¼å¯¹ï¼‰ï¼Œå¦åˆ™è¿›å…¥ä¸‹ä¸€é˜¶æ®µ åˆ†æå™¨è¿›è¡Œ SQL åˆ†æï¼Œå†ç”±ä¼˜åŒ–å™¨ç”Ÿæˆå¯¹åº”çš„æ‰§è¡Œè®¡åˆ’ æ‰§è¡Œå™¨æ ¹æ®ä¼˜åŒ–å™¨ç”Ÿæˆçš„æ‰§è¡Œè®¡åˆ’ï¼Œè°ƒç”¨å­˜å‚¨å¼•æ“çš„ API æ¥æ‰§è¡ŒæŸ¥è¯¢ å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ å¤§å¤šæ•°æƒ…å†µä¸‹ä¸å»ºè®®ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜ï¼Œå› ä¸ºæŸ¥è¯¢ç¼“å­˜å¾€å¾€å¼Šå¤§äºåˆ© æŸ¥è¯¢ç¼“å­˜çš„å¤±æ•ˆéå¸¸é¢‘ç¹ï¼Œåªè¦æœ‰å¯¹ä¸€ä¸ªè¡¨çš„æ›´æ–°ï¼Œè¿™ä¸ªè¡¨ä¸Šæ‰€æœ‰çš„æŸ¥è¯¢ç¼“å­˜éƒ½ä¼šè¢«æ¸…ç©ºã€‚å› æ­¤å¾ˆå¯èƒ½è´¹åŠ›åœ°æŠŠç»“æœå­˜èµ·æ¥ï¼Œè¿˜æ²¡ä½¿ç”¨å°±è¢«ä¸€ä¸ªæ›´æ–°å…¨æ¸…ç©ºäº†ï¼Œå¯¹äºæ›´æ–°å‹åŠ›å¤§çš„æ•°æ®åº“æ¥è¯´ï¼ŒæŸ¥è¯¢ç¼“å­˜çš„å‘½ä¸­ç‡ä¼šéå¸¸ä½ é™¤éä¸šåŠ¡å°±æ˜¯æœ‰ä¸€å¼ é™æ€è¡¨ï¼Œå¾ˆé•¿æ—¶é—´æ‰ä¼šæ›´æ–°ä¸€æ¬¡ï¼Œæ¯”å¦‚ä¸€ä¸ªç³»ç»Ÿé…ç½®è¡¨ï¼Œé‚£è¿™å¼ è¡¨ä¸Šçš„æŸ¥è¯¢æ‰é€‚åˆä½¿ç”¨æŸ¥è¯¢ç¼“å­˜ ç¼“å­˜é…ç½® æŸ¥çœ‹å½“å‰ MySQL æ•°æ®åº“æ˜¯å¦æ”¯æŒæŸ¥è¯¢ç¼“å­˜ï¼š 1SHOW VARIABLES LIKE &#x27;have_query_cache&#x27;; -- YES æŸ¥çœ‹å½“å‰ MySQL æ˜¯å¦å¼€å¯äº†æŸ¥è¯¢ç¼“å­˜ï¼š 1SHOW VARIABLES LIKE &#x27;query_cache_type&#x27;; -- OFF å‚æ•°è¯´æ˜ï¼š OFF æˆ– 0ï¼šæŸ¥è¯¢ç¼“å­˜åŠŸèƒ½å…³é—­ ON æˆ– 1ï¼šæŸ¥è¯¢ç¼“å­˜åŠŸèƒ½æ‰“å¼€ï¼ŒæŸ¥è¯¢ç»“æœç¬¦åˆç¼“å­˜æ¡ä»¶å³ä¼šç¼“å­˜ï¼Œå¦åˆ™ä¸äºˆç¼“å­˜ï¼›å¯ä»¥æ˜¾å¼æŒ‡å®š SQL_NO_CACHE ä¸äºˆç¼“å­˜ DEMAND æˆ– 2ï¼šæŸ¥è¯¢ç¼“å­˜åŠŸèƒ½æŒ‰éœ€è¿›è¡Œï¼Œæ˜¾å¼æŒ‡å®š SQL_CACHE çš„ SELECT è¯­å¥æ‰ç¼“å­˜ï¼Œå…¶å®ƒä¸äºˆç¼“å­˜ 12SELECT SQL_CACHE id, name FROM customer; -- SQL_CACHE:æŸ¥è¯¢ç»“æœå¯ç¼“å­˜SELECT SQL_NO_CACHE id, name FROM customer;-- SQL_NO_CACHE:ä¸ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜ æŸ¥çœ‹æŸ¥è¯¢ç¼“å­˜çš„å ç”¨å¤§å°ï¼š 1SHOW VARIABLES LIKE &#x27;query_cache_size&#x27;;-- å•ä½æ˜¯å­—èŠ‚ 1048576 / 1024 = 1024 = 1KB æŸ¥çœ‹æŸ¥è¯¢ç¼“å­˜çš„çŠ¶æ€å˜é‡ï¼š 1SHOW STATUS LIKE &#x27;Qcache%&#x27;; å‚æ•° å«ä¹‰ Qcache_free_blocks æŸ¥è¯¢ç¼“å­˜ä¸­çš„å¯ç”¨å†…å­˜å—æ•° Qcache_free_memory æŸ¥è¯¢ç¼“å­˜çš„å¯ç”¨å†…å­˜é‡ Qcache_hits æŸ¥è¯¢ç¼“å­˜å‘½ä¸­æ•° Qcache_inserts æ·»åŠ åˆ°æŸ¥è¯¢ç¼“å­˜çš„æŸ¥è¯¢æ•° Qcache_lowmen_prunes ç”±äºå†…å­˜ä¸è¶³è€Œä»æŸ¥è¯¢ç¼“å­˜ä¸­åˆ é™¤çš„æŸ¥è¯¢æ•° Qcache_not_cached éç¼“å­˜æŸ¥è¯¢çš„æ•°é‡ï¼ˆç”±äº query_cache_type è®¾ç½®è€Œæ— æ³•ç¼“å­˜æˆ–æœªç¼“å­˜ï¼‰ Qcache_queries_in_cache æŸ¥è¯¢ç¼“å­˜ä¸­æ³¨å†Œçš„æŸ¥è¯¢æ•° Qcache_total_blocks æŸ¥è¯¢ç¼“å­˜ä¸­çš„å—æ€»æ•° é…ç½® my.cnfï¼š 1234sudo chmod 666 /etc/mysql/my.cnfvim my.cnf# mysqldä¸­é…ç½®ç¼“å­˜query_cache_type=1 é‡å¯æœåŠ¡æ—¢å¯ç”Ÿæ•ˆï¼Œæ‰§è¡Œ SQL è¯­å¥è¿›è¡ŒéªŒè¯ ï¼Œæ‰§è¡Œä¸€æ¡æ¯”è¾ƒè€—æ—¶çš„ SQL è¯­å¥ï¼Œç„¶åå†å¤šæ‰§è¡Œå‡ æ¬¡ï¼ŒæŸ¥çœ‹åé¢å‡ æ¬¡çš„æ‰§è¡Œæ—¶é—´ï¼›è·å–é€šè¿‡æŸ¥çœ‹æŸ¥è¯¢ç¼“å­˜çš„ç¼“å­˜å‘½ä¸­æ•°ï¼Œæ¥åˆ¤å®šæ˜¯å¦èµ°æŸ¥è¯¢ç¼“å­˜ ç¼“å­˜å¤±æ•ˆæŸ¥è¯¢ç¼“å­˜å¤±æ•ˆçš„æƒ…å†µï¼š SQL è¯­å¥ä¸ä¸€è‡´ï¼Œè¦æƒ³å‘½ä¸­æŸ¥è¯¢ç¼“å­˜ï¼ŒæŸ¥è¯¢çš„ SQL è¯­å¥å¿…é¡»ä¸€è‡´ï¼Œå› ä¸ºç¼“å­˜ä¸­ key æ˜¯æŸ¥è¯¢çš„è¯­å¥ï¼Œvalue æ˜¯æŸ¥è¯¢ç»“æ„ 12select count(*) from tb_item;Select count(*) from tb_item; -- ä¸èµ°ç¼“å­˜ï¼Œé¦–å­—æ¯ä¸ä¸€è‡´ å½“æŸ¥è¯¢è¯­å¥ä¸­æœ‰ä¸€äº›ä¸ç¡®å®šæŸ¥è¯¢æ—¶ï¼Œåˆ™ä¸ä¼šç¼“å­˜ï¼Œæ¯”å¦‚ï¼šnow()ã€current_date()ã€curdate()ã€curtime()ã€rand()ã€uuid()ã€user()ã€database() 123SELECT * FROM tb_item WHERE updatetime &lt; NOW() LIMIT 1;SELECT USER();SELECT DATABASE(); ä¸ä½¿ç”¨ä»»ä½•è¡¨æŸ¥è¯¢è¯­å¥ï¼š 1SELECT &#x27;A&#x27;; æŸ¥è¯¢ mysqlã€information_schemaã€performance_schema ç­‰ç³»ç»Ÿè¡¨æ—¶ï¼Œä¸èµ°æŸ¥è¯¢ç¼“å­˜ï¼š 1SELECT * FROM information_schema.engines; åœ¨è·¨å­˜å‚¨å¼•æ“çš„å­˜å‚¨è¿‡ç¨‹ã€è§¦å‘å™¨æˆ–å­˜å‚¨å‡½æ•°çš„ä¸»ä½“å†…æ‰§è¡Œçš„æŸ¥è¯¢ï¼Œç¼“å­˜å¤±æ•ˆ å¦‚æœè¡¨æ›´æ”¹ï¼Œåˆ™ä½¿ç”¨è¯¥è¡¨çš„æ‰€æœ‰é«˜é€Ÿç¼“å­˜æŸ¥è¯¢éƒ½å°†å˜ä¸ºæ— æ•ˆå¹¶ä»é«˜é€Ÿç¼“å­˜ä¸­åˆ é™¤ï¼ŒåŒ…æ‹¬ä½¿ç”¨ MERGE æ˜ å°„åˆ°å·²æ›´æ”¹è¡¨çš„è¡¨çš„æŸ¥è¯¢ï¼Œæ¯”å¦‚ï¼šINSERTã€UPDATEã€DELETEã€ALTER TABLEã€DROP TABLEã€DROP DATABASE åˆ†æå™¨æ²¡æœ‰å‘½ä¸­æŸ¥è¯¢ç¼“å­˜ï¼Œå°±å¼€å§‹äº† SQL çš„çœŸæ­£æ‰§è¡Œï¼Œåˆ†æå™¨ä¼šå¯¹ SQL è¯­å¥åšè§£æ 1SELECT * FROM t WHERE id = 1; è§£æå™¨ï¼šå¤„ç†è¯­æ³•å’Œè§£ææŸ¥è¯¢ï¼Œç”Ÿæˆä¸€è¯¾å¯¹åº”çš„è§£ææ ‘ å…ˆåšè¯æ³•åˆ†æï¼Œè¾“å…¥çš„æ˜¯ç”±å¤šä¸ªå­—ç¬¦ä¸²å’Œç©ºæ ¼ç»„æˆçš„ä¸€æ¡ SQL è¯­å¥ï¼ŒMySQL éœ€è¦è¯†åˆ«å‡ºé‡Œé¢çš„å­—ç¬¦ä¸²åˆ†åˆ«æ˜¯ä»€ä¹ˆä»£è¡¨ä»€ä¹ˆã€‚ä»è¾“å…¥çš„ select è¿™ä¸ªå…³é”®å­—è¯†åˆ«å‡ºæ¥è¿™æ˜¯ä¸€ä¸ªæŸ¥è¯¢è¯­å¥ï¼›æŠŠå­—ç¬¦ä¸² t è¯†åˆ«æˆ è¡¨å tï¼ŒæŠŠå­—ç¬¦ä¸² id è¯†åˆ«æˆåˆ— id ç„¶ååšè¯­æ³•åˆ†æï¼Œæ ¹æ®è¯æ³•åˆ†æçš„ç»“æœï¼Œè¯­æ³•åˆ†æå™¨ä¼šæ ¹æ®è¯­æ³•è§„åˆ™ï¼Œåˆ¤æ–­ä½ è¾“å…¥çš„è¿™ä¸ª SQL è¯­å¥æ˜¯å¦æ»¡è¶³ MySQL è¯­æ³•ã€‚å¦‚æœè¯­å¥ä¸å¯¹ï¼Œå°±ä¼šæ”¶åˆ° You have an error in your SQL syntax çš„é”™è¯¯æé†’ é¢„å¤„ç†å™¨ï¼šè¿›ä¸€æ­¥æ£€æŸ¥è§£ææ ‘çš„åˆæ³•æ€§ï¼Œæ¯”å¦‚æ•°æ®è¡¨å’Œæ•°æ®åˆ—æ˜¯å¦å­˜åœ¨ã€åˆ«åæ˜¯å¦æœ‰æ­§ä¹‰ç­‰ ä¼˜åŒ–å™¨æˆæœ¬åˆ†æä¼˜åŒ–å™¨æ˜¯åœ¨è¡¨é‡Œé¢æœ‰å¤šä¸ªç´¢å¼•çš„æ—¶å€™ï¼Œå†³å®šä½¿ç”¨å“ªä¸ªç´¢å¼•ï¼›æˆ–è€…åœ¨ä¸€ä¸ªè¯­å¥æœ‰å¤šè¡¨å…³è”ï¼ˆjoinï¼‰çš„æ—¶å€™ï¼Œå†³å®šå„ä¸ªè¡¨çš„è¿æ¥é¡ºåº æ ¹æ®æœç´¢æ¡ä»¶æ‰¾å‡ºæ‰€æœ‰å¯èƒ½çš„ä½¿ç”¨çš„ç´¢å¼• æˆæœ¬åˆ†æï¼Œæ‰§è¡Œæˆæœ¬ç”± I&#x2F;O æˆæœ¬å’Œ CPU æˆæœ¬ç»„æˆï¼Œè®¡ç®—å…¨è¡¨æ‰«æå’Œä½¿ç”¨ä¸åŒç´¢å¼•æ‰§è¡Œ SQL çš„ä»£ä»· æ‰¾åˆ°ä¸€ä¸ªæœ€ä¼˜çš„æ‰§è¡Œæ–¹æ¡ˆï¼Œç”¨æœ€å°çš„ä»£ä»·å»æ‰§è¡Œè¯­å¥ åœ¨æ•°æ®åº“é‡Œé¢ï¼Œæ‰«æè¡Œæ•°æ˜¯å½±å“æ‰§è¡Œä»£ä»·çš„å› ç´ ä¹‹ä¸€ï¼Œæ‰«æçš„è¡Œæ•°è¶Šå°‘æ„å‘³ç€è®¿é—®ç£ç›˜çš„æ¬¡æ•°è¶Šå°‘ï¼Œæ¶ˆè€—çš„ CPU èµ„æºè¶Šå°‘ï¼Œä¼˜åŒ–å™¨è¿˜ä¼šç»“åˆæ˜¯å¦ä½¿ç”¨ä¸´æ—¶è¡¨ã€æ˜¯å¦æ’åºç­‰å› ç´ è¿›è¡Œç»¼åˆåˆ¤æ–­ ç»Ÿè®¡æ•°æ®MySQL ä¸­ä¿å­˜ç€ä¸¤ç§ç»Ÿè®¡æ•°æ®ï¼š innodb_table_stats å­˜å‚¨äº†è¡¨çš„ç»Ÿè®¡æ•°æ®ï¼Œæ¯ä¸€æ¡è®°å½•å¯¹åº”ç€ä¸€ä¸ªè¡¨çš„ç»Ÿè®¡æ•°æ® innodb_index_stats å­˜å‚¨äº†ç´¢å¼•çš„ç»Ÿè®¡æ•°æ®ï¼Œæ¯ä¸€æ¡è®°å½•å¯¹åº”ç€ä¸€ä¸ªç´¢å¼•çš„ä¸€ä¸ªç»Ÿè®¡é¡¹çš„æ•°æ® MySQL åœ¨çœŸæ­£æ‰§è¡Œè¯­å¥ä¹‹å‰ï¼Œå¹¶ä¸èƒ½ç²¾ç¡®åœ°çŸ¥é“æ»¡è¶³æ¡ä»¶çš„è®°å½•æœ‰å¤šå°‘æ¡ï¼Œåªèƒ½æ ¹æ®ç»Ÿè®¡ä¿¡æ¯æ¥ä¼°ç®—è®°å½•ï¼Œç»Ÿè®¡ä¿¡æ¯å°±æ˜¯ç´¢å¼•çš„åŒºåˆ†åº¦ï¼Œä¸€ä¸ªç´¢å¼•ä¸Šä¸åŒçš„å€¼çš„ä¸ªæ•°ï¼ˆæ¯”å¦‚æ€§åˆ«åªèƒ½æ˜¯ç”·å¥³ï¼Œå°±æ˜¯ 2 ï¼‰ï¼Œç§°ä¹‹ä¸ºåŸºæ•°ï¼ˆcardinalityï¼‰ï¼ŒåŸºæ•°è¶Šå¤§è¯´æ˜åŒºåˆ†åº¦è¶Šå¥½ é€šè¿‡é‡‡æ ·ç»Ÿè®¡æ¥è·å–åŸºæ•°ï¼ŒInnoDB é»˜è®¤ä¼šé€‰æ‹© N ä¸ªæ•°æ®é¡µï¼Œç»Ÿè®¡è¿™äº›é¡µé¢ä¸Šçš„ä¸åŒå€¼å¾—åˆ°ä¸€ä¸ªå¹³å‡å€¼ï¼Œç„¶åä¹˜ä»¥è¿™ä¸ªç´¢å¼•çš„é¡µé¢æ•°ï¼Œå°±å¾—åˆ°äº†è¿™ä¸ªç´¢å¼•çš„åŸºæ•° åœ¨ MySQL ä¸­ï¼Œæœ‰ä¸¤ç§å­˜å‚¨ç»Ÿè®¡æ•°æ®çš„æ–¹å¼ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®å‚æ•° innodb_stats_persistent çš„å€¼æ¥é€‰æ‹©ï¼š ONï¼šè¡¨ç¤ºç»Ÿè®¡ä¿¡æ¯ä¼šæŒä¹…åŒ–å­˜å‚¨ï¼ˆé»˜è®¤ï¼‰ï¼Œé‡‡æ ·é¡µæ•° N é»˜è®¤ä¸º 20ï¼Œå¯ä»¥é€šè¿‡ innodb_stats_persistent_sample_pages æŒ‡å®šï¼Œé¡µæ•°è¶Šå¤šç»Ÿè®¡çš„æ•°æ®è¶Šå‡†ç¡®ï¼Œä½†æ¶ˆè€—çš„èµ„æºæ›´å¤§ OFFï¼šè¡¨ç¤ºç»Ÿè®¡ä¿¡æ¯åªå­˜å‚¨åœ¨å†…å­˜ï¼Œé‡‡æ ·é¡µæ•° N é»˜è®¤ä¸º 8ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç³»ç»Ÿå˜é‡è®¾ç½®ï¼ˆä¸æ¨èï¼Œæ¯æ¬¡é‡æ–°è®¡ç®—æµªè´¹èµ„æºï¼‰ æ•°æ®è¡¨æ˜¯ä¼šæŒç»­æ›´æ–°çš„ï¼Œä¸¤ç§ç»Ÿè®¡ä¿¡æ¯çš„æ›´æ–°æ–¹å¼ï¼š è®¾ç½® innodb_stats_auto_recalc ä¸º 1ï¼Œå½“å‘ç”Ÿå˜åŠ¨çš„è®°å½•æ•°é‡è¶…è¿‡è¡¨å¤§å°çš„ 10% æ—¶ï¼Œè‡ªåŠ¨è§¦å‘é‡æ–°è®¡ç®—ï¼Œä¸è¿‡æ˜¯å¼‚æ­¥è¿›è¡Œ è°ƒç”¨ ANALYZE TABLE t æ‰‹åŠ¨æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼Œåªå¯¹ä¿¡æ¯åšé‡æ–°ç»Ÿè®¡ï¼ˆä¸æ˜¯é‡å»ºè¡¨ï¼‰ï¼Œæ²¡æœ‰ä¿®æ”¹æ•°æ®ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­åŠ äº† MDL è¯»é”å¹¶ä¸”æ˜¯åŒæ­¥è¿›è¡Œï¼Œæ‰€ä»¥ä¼šæš‚æ—¶é˜»å¡ç³»ç»Ÿ EXPLAIN æ‰§è¡Œè®¡åˆ’åœ¨ä¼˜åŒ–å™¨é˜¶æ®µç”Ÿæˆï¼Œå¦‚æœ explain çš„ç»“æœé¢„ä¼°çš„ rows å€¼è·Ÿå®é™…æƒ…å†µå·®è·æ¯”è¾ƒå¤§ï¼Œå¯ä»¥æ‰§è¡Œ analyze å‘½ä»¤é‡æ–°ä¿®æ­£ä¿¡æ¯ é”™é€‰ç´¢å¼•é‡‡æ ·ç»Ÿè®¡æœ¬èº«æ˜¯ä¼°ç®—æ•°æ®ï¼Œæˆ–è€… SQL è¯­å¥ä¸­çš„å­—æ®µé€‰æ‹©æœ‰é—®é¢˜æ—¶ï¼Œå¯èƒ½å¯¼è‡´ MySQL æ²¡æœ‰é€‰æ‹©æ­£ç¡®çš„æ‰§è¡Œç´¢å¼• è§£å†³æ–¹æ³•ï¼š é‡‡ç”¨ force index å¼ºè¡Œé€‰æ‹©ä¸€ä¸ªç´¢å¼• 1SELECT * FROM user FORCE INDEX(name) WHERE NAME=&#x27;seazean&#x27;; å¯ä»¥è€ƒè™‘ä¿®æ”¹ SQL è¯­å¥ï¼Œå¼•å¯¼ MySQL ä½¿ç”¨æœŸæœ›çš„ç´¢å¼• æ–°å»ºä¸€ä¸ªæ›´åˆé€‚çš„ç´¢å¼•ï¼Œæ¥æä¾›ç»™ä¼˜åŒ–å™¨åšé€‰æ‹©ï¼Œæˆ–åˆ æ‰è¯¯ç”¨çš„ç´¢å¼• æ‰§è¡Œå™¨å¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œè¦å…ˆåˆ¤æ–­ä¸€ä¸‹å½“å‰è¿æ¥å¯¹è¡¨æœ‰æ²¡æœ‰æ‰§è¡ŒæŸ¥è¯¢çš„æƒé™ï¼Œå¦‚æœæ²¡æœ‰å°±ä¼šè¿”å›æ²¡æœ‰æƒé™çš„é”™è¯¯ï¼Œåœ¨å·¥ç¨‹å®ç°ä¸Šï¼Œå¦‚æœå‘½ä¸­æŸ¥è¯¢ç¼“å­˜ï¼Œä¼šåœ¨æŸ¥è¯¢ç¼“å­˜è¿”å›ç»“æœçš„æ—¶å€™ï¼Œåšæƒé™éªŒè¯ã€‚å¦‚æœæœ‰æƒé™ï¼Œå°±æ‰“å¼€è¡¨ç»§ç»­æ‰§è¡Œï¼Œæ‰§è¡Œå™¨å°±ä¼šæ ¹æ®è¡¨çš„å¼•æ“å®šä¹‰ï¼Œå»ä½¿ç”¨è¿™ä¸ªå¼•æ“æä¾›çš„æ¥å£ å¼•æ“å±‚Server å±‚å’Œå­˜å‚¨å¼•æ“å±‚çš„äº¤äº’æ˜¯ä»¥è®°å½•ä¸ºå•ä½çš„ï¼Œå­˜å‚¨å¼•æ“ä¼šå°†å•æ¡è®°å½•è¿”å›ç»™ Server å±‚åšè¿›ä¸€æ­¥å¤„ç†ï¼Œå¹¶ä¸æ˜¯ç›´æ¥è¿”å›æ‰€æœ‰çš„è®°å½• å·¥ä½œæµç¨‹ï¼š é¦–å…ˆæ ¹æ®äºŒçº§ç´¢å¼•é€‰æ‹©æ‰«æèŒƒå›´ï¼Œè·å–ç¬¬ä¸€æ¡ç¬¦åˆäºŒçº§ç´¢å¼•æ¡ä»¶çš„è®°å½•ï¼Œè¿›è¡Œå›è¡¨æŸ¥è¯¢ï¼Œå°†èšç°‡ç´¢å¼•çš„è®°å½•è¿”å› Server å±‚ï¼Œç”± Server åˆ¤æ–­è®°å½•æ˜¯å¦ç¬¦åˆè¦æ±‚ ç„¶ååœ¨äºŒçº§ç´¢å¼•ä¸Šç»§ç»­æ‰«æä¸‹ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„è®°å½• æ¨èé˜…è¯»ï¼šhttps://mp.weixin.qq.com/s/YZ-LckObephrP1f15mzHpA ç»ˆæ­¢æµç¨‹ç»ˆæ­¢è¯­å¥ç»ˆæ­¢çº¿ç¨‹ä¸­æ­£åœ¨æ‰§è¡Œçš„è¯­å¥ï¼š 1KILL QUERY thread_id KILL ä¸æ˜¯é©¬ä¸Šç»ˆæ­¢çš„æ„æ€ï¼Œè€Œæ˜¯å‘Šè¯‰æ‰§è¡Œçº¿ç¨‹è¿™æ¡è¯­å¥å·²ç»ä¸éœ€è¦ç»§ç»­æ‰§è¡Œï¼Œå¯ä»¥å¼€å§‹æ‰§è¡Œåœæ­¢çš„é€»è¾‘ï¼ˆç±»ä¼¼äºæ‰“æ–­ï¼‰ã€‚å› ä¸ºå¯¹è¡¨åšå¢åˆ æ”¹æŸ¥æ“ä½œï¼Œä¼šåœ¨è¡¨ä¸ŠåŠ  MDL è¯»é”ï¼Œå¦‚æœçº¿ç¨‹è¢« KILL æ—¶å°±ç›´æ¥ç»ˆæ­¢ï¼Œé‚£è¿™ä¸ª MDL è¯»é”å°±æ²¡æœºä¼šè¢«é‡Šæ”¾äº† å‘½ä»¤ KILL QUERYthread_id_A çš„æ‰§è¡Œæµç¨‹ï¼š æŠŠ session A çš„è¿è¡ŒçŠ¶æ€æ”¹æˆ THD::KILL_QUERYï¼ˆå°†å˜é‡ killed èµ‹å€¼ä¸º THD::KILL_QUERYï¼‰ ç»™ session A çš„æ‰§è¡Œçº¿ç¨‹å‘ä¸€ä¸ªä¿¡å·ï¼Œè®© session A æ¥å¤„ç†è¿™ä¸ª THD::KILL_QUERY çŠ¶æ€ ä¼šè¯å¤„äºç­‰å¾…çŠ¶æ€ï¼ˆé”é˜»å¡ï¼‰ï¼Œå¿…é¡»æ»¡è¶³æ˜¯ä¸€ä¸ªå¯ä»¥è¢«å”¤é†’çš„ç­‰å¾…ï¼Œå¿…é¡»æœ‰æœºä¼šå»åˆ¤æ–­çº¿ç¨‹çš„çŠ¶æ€ï¼Œå¦‚æœä¸æ»¡è¶³å°±ä¼šé€ æˆ KILL å¤±è´¥ å…¸å‹åœºæ™¯ï¼šinnodb_thread_concurrency ä¸º 2ï¼Œä»£è¡¨å¹¶å‘çº¿ç¨‹ä¸Šé™æ•°è®¾ç½®ä¸º 2 session A æ‰§è¡Œäº‹åŠ¡ï¼Œsession B æ‰§è¡Œäº‹åŠ¡ï¼Œè¾¾åˆ°çº¿ç¨‹ä¸Šé™ï¼›æ­¤æ—¶ session C æ‰§è¡Œäº‹åŠ¡ä¼šé˜»å¡ç­‰å¾…ï¼Œsession D æ‰§è¡Œ kill query C æ— æ•ˆ C çš„é€»è¾‘æ˜¯æ¯ 10 æ¯«ç§’åˆ¤æ–­æ˜¯å¦å¯ä»¥è¿›å…¥ InnoDB æ‰§è¡Œï¼Œå¦‚æœä¸è¡Œå°±è°ƒç”¨ nanosleep å‡½æ•°è¿›å…¥ sleep çŠ¶æ€ï¼Œæ²¡æœ‰å»åˆ¤æ–­çº¿ç¨‹çŠ¶æ€ è¡¥å……ï¼šæ‰§è¡Œ Ctrl+C çš„æ—¶å€™ï¼Œæ˜¯ MySQL å®¢æˆ·ç«¯å¦å¤–å¯åŠ¨ä¸€ä¸ªè¿æ¥ï¼Œç„¶åå‘é€ä¸€ä¸ª KILL QUERY å‘½ä»¤ ç»ˆæ­¢è¿æ¥æ–­å¼€çº¿ç¨‹çš„è¿æ¥ï¼š 1KILL CONNECTION id æ–­å¼€è¿æ¥åæ‰§è¡Œ SHOW PROCESSLIST å‘½ä»¤ï¼Œå¦‚æœè¿™æ¡è¯­å¥çš„ Command åˆ—æ˜¾ç¤º Killedï¼Œä»£è¡¨çº¿ç¨‹çš„çŠ¶æ€æ˜¯ KILL_CONNECTIONï¼Œè¯´æ˜è¿™ä¸ªçº¿ç¨‹æœ‰è¯­å¥æ­£åœ¨æ‰§è¡Œï¼Œå½“å‰çŠ¶æ€æ˜¯åœæ­¢è¯­å¥æ‰§è¡Œä¸­ï¼Œç»ˆæ­¢é€»è¾‘è€—æ—¶è¾ƒé•¿ è¶…å¤§äº‹åŠ¡æ‰§è¡ŒæœŸé—´è¢« KILLï¼Œè¿™æ—¶å›æ»šæ“ä½œéœ€è¦å¯¹äº‹åŠ¡æ‰§è¡ŒæœŸé—´ç”Ÿæˆçš„æ‰€æœ‰æ–°æ•°æ®ç‰ˆæœ¬åšå›æ”¶æ“ä½œï¼Œè€—æ—¶å¾ˆé•¿ å¤§æŸ¥è¯¢å›æ»šï¼Œå¦‚æœæŸ¥è¯¢è¿‡ç¨‹ä¸­ç”Ÿæˆäº†æ¯”è¾ƒå¤§çš„ä¸´æ—¶æ–‡ä»¶ï¼Œåˆ é™¤ä¸´æ—¶æ–‡ä»¶å¯èƒ½éœ€è¦ç­‰å¾… IO èµ„æºï¼Œå¯¼è‡´è€—æ—¶è¾ƒé•¿ DDL å‘½ä»¤æ‰§è¡Œåˆ°æœ€åé˜¶æ®µè¢« KILLï¼Œéœ€è¦åˆ é™¤ä¸­é—´è¿‡ç¨‹çš„ä¸´æ—¶æ–‡ä»¶ï¼Œä¹Ÿå¯èƒ½å— IO èµ„æºå½±å“è€—æ—¶è¾ƒä¹… æ€»ç»“ï¼šKILL CONNECTION æœ¬è´¨ä¸Šåªæ˜¯æŠŠå®¢æˆ·ç«¯çš„ SQL è¿æ¥æ–­å¼€ï¼Œåé¢çš„ç»ˆæ­¢æµç¨‹è¿˜æ˜¯è¦èµ° KILL QUERY ä¸€ä¸ªäº‹åŠ¡è¢« KILL ä¹‹åï¼ŒæŒç»­å¤„äºå›æ»šçŠ¶æ€ï¼Œä¸åº”è¯¥å¼ºè¡Œé‡å¯æ•´ä¸ª MySQL è¿›ç¨‹ï¼Œåº”è¯¥ç­‰å¾…äº‹åŠ¡è‡ªå·±æ‰§è¡Œå®Œæˆï¼Œå› ä¸ºé‡å¯åä¾ç„¶ç»§ç»­åšå›æ»šæ“ä½œçš„é€»è¾‘ å¸¸ç”¨å·¥å…·mysqlmysql ä¸æ˜¯æŒ‡ mysql æœåŠ¡ï¼Œè€Œæ˜¯æŒ‡ mysql çš„å®¢æˆ·ç«¯å·¥å…· 1mysql [options] [database] -u â€“user&#x3D;nameï¼šæŒ‡å®šç”¨æˆ·å -p â€“password[&#x3D;name]ï¼šæŒ‡å®šå¯†ç  -h â€“host&#x3D;nameï¼šæŒ‡å®šæœåŠ¡å™¨IPæˆ–åŸŸå -P â€“port&#x3D;#ï¼šæŒ‡å®šè¿æ¥ç«¯å£ -e â€“execute&#x3D;nameï¼šæ‰§è¡ŒSQLè¯­å¥å¹¶é€€å‡ºï¼Œåœ¨æ§åˆ¶å°æ‰§è¡ŒSQLè¯­å¥ï¼Œè€Œä¸ç”¨è¿æ¥åˆ°æ•°æ®åº“æ‰§è¡Œ ç¤ºä¾‹ï¼š 12mysql -h 127.0.0.1 -P 3306 -u root -pmysql -uroot -p2143 db01 -e &quot;select * from tb_book&quot;; adminmysqladmin æ˜¯ä¸€ä¸ªæ‰§è¡Œç®¡ç†æ“ä½œçš„å®¢æˆ·ç«¯ç¨‹åºï¼Œç”¨æ¥æ£€æŸ¥æœåŠ¡å™¨çš„é…ç½®å’Œå½“å‰çŠ¶æ€ã€åˆ›å»ºå¹¶åˆ é™¤æ•°æ®åº“ç­‰ é€šè¿‡ mysqladmin --help æŒ‡ä»¤æŸ¥çœ‹å¸®åŠ©æ–‡æ¡£ 1mysqladmin -uroot -p2143 create &#x27;test01&#x27;; binlogæœåŠ¡å™¨ç”Ÿæˆçš„æ—¥å¿—æ–‡ä»¶ä»¥äºŒè¿›åˆ¶æ ¼å¼ä¿å­˜ï¼Œå¦‚æœéœ€è¦æ£€æŸ¥è¿™äº›æ–‡æœ¬ï¼Œå°±è¦ä½¿ç”¨ mysqlbinlog æ—¥å¿—ç®¡ç†å·¥å…· 1mysqlbinlog [options] log-files1 log-files2 ... -d â€“database&#x3D;nameï¼šæŒ‡å®šæ•°æ®åº“åç§°ï¼Œåªåˆ—å‡ºæŒ‡å®šçš„æ•°æ®åº“ç›¸å…³æ“ä½œ -o â€“offset&#x3D;#ï¼šå¿½ç•¥æ‰æ—¥å¿—ä¸­çš„å‰ n è¡Œå‘½ä»¤ã€‚ -r â€“result-file&#x3D;nameï¼šå°†è¾“å‡ºçš„æ–‡æœ¬æ ¼å¼æ—¥å¿—è¾“å‡ºåˆ°æŒ‡å®šæ–‡ä»¶ã€‚ -s â€“short-formï¼šæ˜¾ç¤ºç®€å•æ ¼å¼ï¼Œçœç•¥æ‰ä¸€äº›ä¿¡æ¯ã€‚ â€“start-datatime&#x3D;date1 â€“stop-datetime&#x3D;date2ï¼šæŒ‡å®šæ—¥æœŸé—´éš”å†…çš„æ‰€æœ‰æ—¥å¿— â€“start-position&#x3D;pos1 â€“stop-position&#x3D;pos2ï¼šæŒ‡å®šä½ç½®é—´éš”å†…çš„æ‰€æœ‰æ—¥å¿— dumpå‘½ä»¤ä»‹ç»mysqldump å®¢æˆ·ç«¯å·¥å…·ç”¨æ¥å¤‡ä»½æ•°æ®åº“æˆ–åœ¨ä¸åŒæ•°æ®åº“ä¹‹é—´è¿›è¡Œæ•°æ®è¿ç§»ï¼Œå¤‡ä»½å†…å®¹åŒ…å«åˆ›å»ºè¡¨ï¼ŒåŠæ’å…¥è¡¨çš„ SQL è¯­å¥ 123mysqldump [options] db_name [tables]mysqldump [options] --database/-B db1 [db2 db3...]mysqldump [options] --all-databases/-A è¿æ¥é€‰é¡¹ï¼š -u â€“user&#x3D;nameï¼šæŒ‡å®šç”¨æˆ·å -p â€“password[&#x3D;name]ï¼šæŒ‡å®šå¯†ç  -h â€“host&#x3D;nameï¼šæŒ‡å®šæœåŠ¡å™¨ IP æˆ–åŸŸå -P â€“port&#x3D;#ï¼šæŒ‡å®šè¿æ¥ç«¯å£ è¾“å‡ºå†…å®¹é€‰é¡¹ï¼š â€“add-drop-databaseï¼šåœ¨æ¯ä¸ªæ•°æ®åº“åˆ›å»ºè¯­å¥å‰åŠ ä¸Š Drop database è¯­å¥ â€“add-drop-tableï¼šåœ¨æ¯ä¸ªè¡¨åˆ›å»ºè¯­å¥å‰åŠ ä¸Š Drop table è¯­å¥ , é»˜è®¤å¼€å¯ï¼Œä¸å¼€å¯ (â€“skip-add-drop-table) -n â€“no-create-dbï¼šä¸åŒ…å«æ•°æ®åº“çš„åˆ›å»ºè¯­å¥ -t â€“no-create-infoï¼šä¸åŒ…å«æ•°æ®è¡¨çš„åˆ›å»ºè¯­å¥ -d â€“no-dataï¼šä¸åŒ…å«æ•°æ® -T, â€“tab&#x3D;nameï¼šè‡ªåŠ¨ç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶ï¼šä¸€ä¸ª .sql æ–‡ä»¶ï¼Œåˆ›å»ºè¡¨ç»“æ„çš„è¯­å¥ï¼›ä¸€ä¸ª .txt æ–‡ä»¶ï¼Œæ•°æ®æ–‡ä»¶ï¼Œç›¸å½“äº select into outfile ç¤ºä¾‹ï¼š 12mysqldump -uroot -p2143 db01 tb_book --add-drop-database --add-drop-table &gt; amysqldump -uroot -p2143 -T /tmp test city æ•°æ®å¤‡ä»½å‘½ä»¤è¡Œæ–¹å¼ï¼š å¤‡ä»½å‘½ä»¤ï¼šmysqldump -u root -p æ•°æ®åº“åç§° &gt; æ–‡ä»¶ä¿å­˜è·¯å¾„ æ¢å¤ ç™»å½•MySQLæ•°æ®åº“ï¼šmysql -u root p åˆ é™¤å·²ç»å¤‡ä»½çš„æ•°æ®åº“ é‡æ–°åˆ›å»ºä¸å¤‡ä»½æ•°æ®åº“åç§°ç›¸åŒçš„æ•°æ®åº“ ä½¿ç”¨è¯¥æ•°æ®åº“ å¯¼å…¥æ–‡ä»¶æ‰§è¡Œï¼šsource å¤‡ä»½æ–‡ä»¶å…¨è·¯å¾„ æ›´å¤šæ–¹å¼å‚è€ƒï¼šhttps://time.geekbang.org/column/article/81925 å›¾å½¢åŒ–ç•Œé¢ï¼š å¤‡ä»½ æ¢å¤ importmysqlimport æ˜¯å®¢æˆ·ç«¯æ•°æ®å¯¼å…¥å·¥å…·ï¼Œç”¨æ¥å¯¼å…¥mysqldump åŠ  -T å‚æ•°åå¯¼å‡ºçš„æ–‡æœ¬æ–‡ä»¶ 1mysqlimport [options] db_name textfile1 [textfile2...] ç¤ºä¾‹ï¼š 1mysqlimport -uroot -p2143 test /tmp/city.txt å¯¼å…¥ sql æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ MySQL ä¸­çš„ source æŒ‡ä»¤ : 1source æ–‡ä»¶å…¨è·¯å¾„ showmysqlshow å®¢æˆ·ç«¯å¯¹è±¡æŸ¥æ‰¾å·¥å…·ï¼Œç”¨æ¥å¾ˆå¿«åœ°æŸ¥æ‰¾å­˜åœ¨å“ªäº›æ•°æ®åº“ã€æ•°æ®åº“ä¸­çš„è¡¨ã€è¡¨ä¸­çš„åˆ—æˆ–è€…ç´¢å¼• 1mysqlshow [options] [db_name [table_name [col_name]]] â€“countï¼šæ˜¾ç¤ºæ•°æ®åº“åŠè¡¨çš„ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ•°æ®åº“ï¼Œè¡¨ å‡å¯ä»¥ä¸æŒ‡å®šï¼‰ -iï¼šæ˜¾ç¤ºæŒ‡å®šæ•°æ®åº“æˆ–è€…æŒ‡å®šè¡¨çš„çŠ¶æ€ä¿¡æ¯ ç¤ºä¾‹ï¼š 123456#æŸ¥è¯¢æ¯ä¸ªæ•°æ®åº“çš„è¡¨çš„æ•°é‡åŠè¡¨ä¸­è®°å½•çš„æ•°é‡mysqlshow -uroot -p1234 --count#æŸ¥è¯¢teståº“ä¸­æ¯ä¸ªè¡¨ä¸­çš„å­—æ®µä¹¦ï¼ŒåŠè¡Œæ•°mysqlshow -uroot -p1234 test --count#æŸ¥è¯¢teståº“ä¸­bookè¡¨çš„è¯¦ç»†æƒ…å†µmysqlshow -uroot -p1234 test book --count å•è¡¨æ“ä½œSQL SQL Structured Query Languageï¼šç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€ å®šä¹‰äº†æ“ä½œæ‰€æœ‰å…³ç³»å‹æ•°æ®åº“çš„è§„åˆ™ï¼Œæ¯ç§æ•°æ®åº“æ“ä½œçš„æ–¹å¼å¯èƒ½ä¼šå­˜åœ¨ä¸ä¸€æ ·çš„åœ°æ–¹ï¼Œç§°ä¸ºâ€œæ–¹è¨€â€ SQL é€šç”¨è¯­æ³• SQL è¯­å¥å¯ä»¥å•è¡Œæˆ–å¤šè¡Œä¹¦å†™ï¼Œä»¥åˆ†å·ç»“å°¾ã€‚ å¯ä½¿ç”¨ç©ºæ ¼å’Œç¼©è¿›æ¥å¢å¼ºè¯­å¥çš„å¯è¯»æ€§ã€‚ MySQL æ•°æ®åº“çš„ SQL è¯­å¥ä¸åŒºåˆ†å¤§å°å†™ï¼Œå…³é”®å­—å»ºè®®ä½¿ç”¨å¤§å†™ã€‚ æ•°æ®åº“çš„æ³¨é‡Šï¼š å•è¡Œæ³¨é‡Šï¼šâ€“ æ³¨é‡Šå†…å®¹ #æ³¨é‡Šå†…å®¹ï¼ˆMySQL ç‰¹æœ‰ï¼‰ å¤šè¡Œæ³¨é‡Šï¼š&#x2F;* æ³¨é‡Šå†…å®¹ *&#x2F; SQL åˆ†ç±» DDLï¼ˆData Definition Languageï¼‰æ•°æ®å®šä¹‰è¯­è¨€ ç”¨æ¥å®šä¹‰æ•°æ®åº“å¯¹è±¡ï¼šæ•°æ®åº“ï¼Œè¡¨ï¼Œåˆ—ç­‰ã€‚å…³é”®å­—ï¼šcreateã€drop,ã€alter ç­‰ DMLï¼ˆData Manipulation Languageï¼‰æ•°æ®æ“ä½œè¯­è¨€ ç”¨æ¥å¯¹æ•°æ®åº“ä¸­è¡¨çš„æ•°æ®è¿›è¡Œå¢åˆ æ”¹ã€‚å…³é”®å­—ï¼šinsertã€deleteã€update ç­‰ DQLï¼ˆData Query Languageï¼‰æ•°æ®æŸ¥è¯¢è¯­è¨€ ç”¨æ¥æŸ¥è¯¢æ•°æ®åº“ä¸­è¡¨çš„è®°å½•(æ•°æ®)ã€‚å…³é”®å­—ï¼šselectã€where ç­‰ DCLï¼ˆData Control Languageï¼‰æ•°æ®æ§åˆ¶è¯­è¨€ ç”¨æ¥å®šä¹‰æ•°æ®åº“çš„è®¿é—®æƒé™å’Œå®‰å…¨çº§åˆ«ï¼ŒåŠåˆ›å»ºç”¨æˆ·ã€‚å…³é”®å­—ï¼šgrantï¼Œ revokeç­‰ DDLæ•°æ®åº“ R(Retrieve)ï¼šæŸ¥è¯¢ æŸ¥è¯¢æ‰€æœ‰æ•°æ®åº“ï¼š 1SHOW DATABASES; æŸ¥è¯¢æŸä¸ªæ•°æ®åº“çš„åˆ›å»ºè¯­å¥ 123SHOW CREATE DATABASE æ•°æ®åº“åç§°; -- æ ‡å‡†è¯­æ³•SHOW CREATE DATABASE mysql; -- æŸ¥çœ‹mysqlæ•°æ®åº“çš„åˆ›å»ºæ ¼å¼ C(Create)ï¼šåˆ›å»º åˆ›å»ºæ•°æ®åº“ 123CREATE DATABASE æ•°æ®åº“åç§°;-- æ ‡å‡†è¯­æ³•CREATE DATABASE db1; -- åˆ›å»ºdb1æ•°æ®åº“ åˆ›å»ºæ•°æ®åº“ï¼ˆåˆ¤æ–­ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰ 1CREATE DATABASE IF NOT EXISTS æ•°æ®åº“åç§°; åˆ›å»ºæ•°æ®åº“ï¼Œå¹¶æŒ‡å®šå­—ç¬¦é›† 1CREATE DATABASE æ•°æ®åº“åç§° CHARACTER SET å­—ç¬¦é›†åç§°; ä¾‹å¦‚ï¼šåˆ›å»ºdb4æ•°æ®åº“ã€å¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼ŒæŒ‡å®šå­—ç¬¦é›†ä¸ºgbk 12345-- åˆ›å»ºdb4æ•°æ®åº“ã€å¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼ŒæŒ‡å®šå­—ç¬¦é›†ä¸ºgbkCREATE DATABASE IF NOT EXISTS db4 CHARACTER SET gbk;-- æŸ¥çœ‹db4æ•°æ®åº“çš„å­—ç¬¦é›†SHOW CREATE DATABASE db4; U(Update)ï¼šä¿®æ”¹ ä¿®æ”¹æ•°æ®åº“çš„å­—ç¬¦é›† 1ALTER DATABASE æ•°æ®åº“åç§° CHARACTER SET å­—ç¬¦é›†åç§°; å¸¸ç”¨å­—ç¬¦é›†ï¼š 1234567--æŸ¥è¯¢æ‰€æœ‰æ”¯æŒçš„å­—ç¬¦é›†SHOW CHARSET;--æŸ¥çœ‹æ‰€æœ‰æ”¯æŒçš„æ ¡å¯¹è§„åˆ™SHOW COLLATION;-- å­—ç¬¦é›†: utf8,latinI,GBK,,GBKæ˜¯utf8çš„å­é›†-- æ ¡å¯¹è§„åˆ™: ci å¤§å°å®šä¸æ•æ„Ÿï¼Œcsæˆ–binå¤§å°å†™æ•æ„Ÿ D(Delete)ï¼šåˆ é™¤ åˆ é™¤æ•°æ®åº“ï¼š 1DROP DATABASE æ•°æ®åº“åç§°; åˆ é™¤æ•°æ®åº“(åˆ¤æ–­ï¼Œå¦‚æœå­˜åœ¨åˆ™åˆ é™¤)ï¼š 1DROP DATABASE IF EXISTS æ•°æ®åº“åç§°; ä½¿ç”¨æ•°æ®åº“ï¼š æŸ¥è¯¢å½“å‰æ­£åœ¨ä½¿ç”¨çš„æ•°æ®åº“åç§° 1SELECT DATABASE(); ä½¿ç”¨æ•°æ®åº“ 12USE æ•°æ®åº“åç§°ï¼› -- æ ‡å‡†è¯­æ³•USE db4; -- ä½¿ç”¨db4æ•°æ®åº“ æ•°æ®è¡¨ R(Retrieve)ï¼šæŸ¥è¯¢ æŸ¥è¯¢æ•°æ®åº“ä¸­æ‰€æœ‰çš„æ•°æ®è¡¨ 123USE mysql;-- ä½¿ç”¨mysqlæ•°æ®åº“SHOW TABLES;-- æŸ¥è¯¢åº“ä¸­æ‰€æœ‰çš„è¡¨ æŸ¥è¯¢è¡¨ç»“æ„ 1DESC è¡¨å; æŸ¥è¯¢è¡¨å­—ç¬¦é›† 1SHOW TABLE STATUS FROM åº“å LIKE &#x27;è¡¨å&#x27;; C(Create)ï¼šåˆ›å»º åˆ›å»ºæ•°æ®è¡¨ 1234567CREATE TABLE è¡¨å( åˆ—å1 æ•°æ®ç±»å‹1, åˆ—å2 æ•°æ®ç±»å‹2, .... åˆ—ån æ•°æ®ç±»å‹n);-- æ³¨æ„ï¼šæœ€åä¸€åˆ—ï¼Œä¸éœ€è¦åŠ é€—å· å¤åˆ¶è¡¨ 123CREATE TABLE è¡¨å LIKE è¢«å¤åˆ¶çš„è¡¨å; -- æ ‡å‡†è¯­æ³•CREATE TABLE product2 LIKE product; -- å¤åˆ¶productè¡¨åˆ°product2è¡¨ æ•°æ®ç±»å‹ æ•°æ®ç±»å‹ è¯´æ˜ INT æ•´æ•°ç±»å‹ DOUBLE å°æ•°ç±»å‹ DATE æ—¥æœŸï¼ŒåªåŒ…å«å¹´æœˆæ—¥ï¼šyyyy-MM-dd DATETIME æ—¥æœŸï¼ŒåŒ…å«å¹´æœˆæ—¥æ—¶åˆ†ç§’ï¼šyyyy-MM-dd HH:mm:ss TIMESTAMP æ—¶é—´æˆ³ç±»å‹ï¼ŒåŒ…å«å¹´æœˆæ—¥æ—¶åˆ†ç§’ï¼šyyyy-MM-dd HH:mm:sså¦‚æœä¸ç»™è¿™ä¸ªå­—æ®µèµ‹å€¼æˆ–èµ‹å€¼ä¸º NULLï¼Œåˆ™é»˜è®¤ä½¿ç”¨å½“å‰çš„ç³»ç»Ÿæ—¶é—´ CHAR å­—ç¬¦ä¸²ï¼Œå®šé•¿ç±»å‹ VARCHAR å­—ç¬¦ä¸²ï¼Œå˜é•¿ç±»å‹name varchar(20) ä»£è¡¨å§“åæœ€å¤§ 20 ä¸ªå­—ç¬¦ï¼šzhangsan 8 ä¸ªå­—ç¬¦ï¼Œå¼ ä¸‰ 2 ä¸ªå­—ç¬¦ INT(n)ï¼šn ä»£è¡¨ä½æ•° 3ï¼šintï¼ˆ9ï¼‰æ˜¾ç¤ºç»“æœä¸º 000000010 3ï¼šintï¼ˆ3ï¼‰æ˜¾ç¤ºç»“æœä¸º 010 varchar(n)ï¼šn è¡¨ç¤ºçš„æ˜¯å­—ç¬¦æ•° ä¾‹å¦‚ï¼š 1234567891011-- ä½¿ç”¨db3æ•°æ®åº“USE db3;-- åˆ›å»ºä¸€ä¸ªproductå•†å“è¡¨CREATE TABLE product( id INT, -- å•†å“ç¼–å· NAME VARCHAR(30), -- å•†å“åç§° price DOUBLE, -- å•†å“ä»·æ ¼ stock INT, -- å•†å“åº“å­˜ insert_time DATE -- ä¸Šæ¶æ—¶é—´); â€‹ U(Update)ï¼šä¿®æ”¹ ä¿®æ”¹è¡¨å 1ALTER TABLE è¡¨å RENAME TO æ–°çš„è¡¨å; ä¿®æ”¹è¡¨çš„å­—ç¬¦é›† 1ALTER TABLE è¡¨å CHARACTER SET å­—ç¬¦é›†åç§°; æ·»åŠ ä¸€åˆ— 1ALTER TABLE è¡¨å ADD åˆ—å æ•°æ®ç±»å‹; ä¿®æ”¹åˆ—æ•°æ®ç±»å‹ 1ALTER TABLE è¡¨å MODIFY åˆ—å æ–°æ•°æ®ç±»å‹; ä¿®æ”¹åˆ—åç§°å’Œæ•°æ®ç±»å‹ 1ALTER TABLE è¡¨å CHANGE åˆ—å æ–°åˆ—å æ–°æ•°æ®ç±»å‹; åˆ é™¤åˆ— 1ALTER TABLE è¡¨å DROP åˆ—å; D(Delete)ï¼šåˆ é™¤ åˆ é™¤æ•°æ®è¡¨ 1DROP TABLE è¡¨å; åˆ é™¤æ•°æ®è¡¨(åˆ¤æ–­ï¼Œå¦‚æœå­˜åœ¨åˆ™åˆ é™¤) 1DROP TABLE IF EXISTS è¡¨å; DMLINSERT æ–°å¢è¡¨æ•°æ® æ–°å¢æ ¼å¼ 1ï¼šç»™æŒ‡å®šåˆ—æ·»åŠ æ•°æ® 1INSERT INTO è¡¨å(åˆ—å1,åˆ—å2...) VALUES (å€¼1,å€¼2...); æ–°å¢æ ¼å¼ 2ï¼šé»˜è®¤ç»™å…¨éƒ¨åˆ—æ·»åŠ æ•°æ® 1INSERT INTO è¡¨å VALUES (å€¼1,å€¼2,å€¼3,...); æ–°å¢æ ¼å¼ 3ï¼šæ‰¹é‡æ·»åŠ æ•°æ® 12345-- ç»™æŒ‡å®šåˆ—æ‰¹é‡æ·»åŠ æ•°æ®INSERT INTO è¡¨å(åˆ—å1,åˆ—å2,...) VALUES (å€¼1,å€¼2,...),(å€¼1,å€¼2,...)...;-- é»˜è®¤ç»™æ‰€æœ‰åˆ—æ‰¹é‡æ·»åŠ æ•°æ® INSERT INTO è¡¨å VALUES (å€¼1,å€¼2,å€¼3,...),(å€¼1,å€¼2,å€¼3,...)...; å­—ç¬¦ä¸²æ‹¼æ¥ 1CONCAT(string1,string2,&#x27;&#x27;,...) æ³¨æ„äº‹é¡¹ åˆ—åå’Œå€¼çš„æ•°é‡ä»¥åŠæ•°æ®ç±»å‹è¦å¯¹åº” é™¤äº†æ•°å­—ç±»å‹ï¼Œå…¶ä»–æ•°æ®ç±»å‹çš„æ•°æ®éƒ½éœ€è¦åŠ å¼•å·(å•å¼•åŒå¼•éƒ½å¯ä»¥ï¼Œæ¨èå•å¼•) UPDATE ä¿®æ”¹è¡¨æ•°æ®è¯­æ³• æ ‡å‡†è¯­æ³• 1UPDATE è¡¨å SET åˆ—å1 = å€¼1,åˆ—å2 = å€¼2,... [where æ¡ä»¶]; ä¿®æ”¹ç”µè§†çš„ä»·æ ¼ä¸º1800ã€åº“å­˜ä¸º36 12UPDATE product SET price=1800,stock=36 WHERE NAME=&#x27;ç”µè§†&#x27;;SELECT * FROM product;-- æŸ¥çœ‹æ‰€æœ‰å•†å“ä¿¡æ¯ æ³¨æ„äº‹é¡¹ ä¿®æ”¹è¯­å¥ä¸­å¿…é¡»åŠ æ¡ä»¶ å¦‚æœä¸åŠ æ¡ä»¶ï¼Œåˆ™å°†æ‰€æœ‰æ•°æ®éƒ½ä¿®æ”¹ DELETE åˆ é™¤è¡¨æ•°æ®è¯­æ³• 1DELETE FROM è¡¨å [WHERE æ¡ä»¶]; æ³¨æ„äº‹é¡¹ åˆ é™¤è¯­å¥ä¸­å¿…é¡»åŠ æ¡ä»¶ å¦‚æœä¸åŠ æ¡ä»¶ï¼Œåˆ™å°†æ‰€æœ‰æ•°æ®åˆ é™¤ â€‹ DQLæŸ¥è¯¢è¯­æ³•æ•°æ®åº“æŸ¥è¯¢éµå¾ªæ¡ä»¶åœ¨å‰çš„åŸåˆ™ 12345678910111213141516SELECT DISTINCT &lt;select list&gt;FROM &lt;left_table&gt; &lt;join_type&gt;JOIN &lt;right_table&gt; ON &lt;join_condition&gt; -- è¿æ¥æŸ¥è¯¢åœ¨å¤šè¡¨æŸ¥è¯¢éƒ¨åˆ†è¯¦è§£WHERE &lt;where_condition&gt;GROUP BY &lt;group_by_list&gt;HAVING &lt;having_condition&gt;ORDER BY &lt;order_by_condition&gt;LIMIT &lt;limit_params&gt; æ‰§è¡Œé¡ºåºï¼š 1234567891011121314151617FROM &lt;left_table&gt;ON &lt;join_condition&gt;&lt;join_type&gt; JOIN &lt;right_table&gt;WHERE &lt;where_condition&gt;GROUP BY &lt;group_by_list&gt;HAVING &lt;having_condition&gt;SELECT DISTINCT &lt;select list&gt;ORDER BY &lt;order_by_condition&gt;LIMIT &lt;limit_params&gt; æŸ¥è¯¢å…¨éƒ¨ æŸ¥è¯¢å…¨éƒ¨çš„è¡¨æ•°æ® 12345-- æ ‡å‡†è¯­æ³•SELECT * FROM è¡¨å;-- æŸ¥è¯¢productè¡¨æ‰€æœ‰æ•°æ®(å¸¸ç”¨)SELECT * FROM product; æŸ¥è¯¢æŒ‡å®šå­—æ®µçš„è¡¨æ•°æ® 1SELECT åˆ—å1,åˆ—å2,... FROM è¡¨å; å»é™¤é‡å¤æŸ¥è¯¢ï¼šåªæœ‰å€¼å…¨éƒ¨é‡å¤çš„æ‰å¯ä»¥å»é™¤ï¼Œéœ€è¦åˆ›å»ºä¸´æ—¶è¡¨è¾…åŠ©æŸ¥è¯¢ 1SELECT DISTINCT åˆ—å1,åˆ—å2,... FROM è¡¨å; è®¡ç®—åˆ—çš„å€¼ï¼ˆå››åˆ™è¿ç®—ï¼‰ 123456SELECT åˆ—å1 è¿ç®—ç¬¦(+ - * /) åˆ—å2 FROM è¡¨å;/*å¦‚æœæŸä¸€åˆ—å€¼ä¸ºnullï¼Œå¯ä»¥è¿›è¡Œæ›¿æ¢ ifnull(è¡¨è¾¾å¼1,è¡¨è¾¾å¼2) è¡¨è¾¾å¼1ï¼šæƒ³æ›¿æ¢çš„åˆ— è¡¨è¾¾å¼2ï¼šæƒ³æ›¿æ¢çš„å€¼*/ ä¾‹å¦‚ï¼š 12345-- æŸ¥è¯¢å•†å“åç§°å’Œåº“å­˜ï¼Œåº“å­˜æ•°é‡åœ¨åŸæœ‰åŸºç¡€ä¸ŠåŠ 10SELECT NAME,stock+10 FROM product;-- æŸ¥è¯¢å•†å“åç§°å’Œåº“å­˜ï¼Œåº“å­˜æ•°é‡åœ¨åŸæœ‰åŸºç¡€ä¸ŠåŠ 10ã€‚è¿›è¡Œnullå€¼åˆ¤æ–­SELECT NAME,IFNULL(stock,0)+10 FROM product; èµ·åˆ«å 1SELECT åˆ—å1,åˆ—å2,... AS åˆ«å FROM è¡¨å; ä¾‹å¦‚ï¼š 123-- æŸ¥è¯¢å•†å“åç§°å’Œåº“å­˜ï¼Œåº“å­˜æ•°é‡åœ¨åŸæœ‰åŸºç¡€ä¸ŠåŠ 10ã€‚è¿›è¡Œnullå€¼åˆ¤æ–­ï¼Œèµ·åˆ«åä¸ºgetSum,ASå¯ä»¥çœç•¥ã€‚SELECT NAME,IFNULL(stock,0)+10 AS getsum FROM product;SELECT NAME,IFNULL(stock,0)+10 getsum FROM product; æ¡ä»¶æŸ¥è¯¢ æ¡ä»¶æŸ¥è¯¢è¯­æ³• 1SELECT åˆ—å FROM è¡¨å WHERE æ¡ä»¶; æ¡ä»¶åˆ†ç±» ç¬¦å· åŠŸèƒ½ &gt; å¤§äº &lt; å°äº &gt;&#x3D; å¤§äºç­‰äº &lt;&#x3D; å°äºç­‰äº &#x3D; ç­‰äº &lt;&gt; æˆ– !&#x3D; ä¸ç­‰äº BETWEEN â€¦ AND â€¦ åœ¨æŸä¸ªèŒƒå›´ä¹‹å†…(éƒ½åŒ…å«) IN(â€¦) å¤šé€‰ä¸€ LIKE æ¨¡ç³ŠæŸ¥è¯¢ï¼š_å•ä¸ªä»»æ„å­—ç¬¦ã€%ä»»æ„ä¸ªå­—ç¬¦ã€[] åŒ¹é…é›†åˆå†…çš„å­—ç¬¦LIKE &#39;[^AB]%&#39; ï¼šä¸ä»¥ A å’Œ B å¼€å¤´çš„ä»»æ„æ–‡æœ¬ IS NULL æ˜¯NULL IS NOT NULL ä¸æ˜¯NULL AND æˆ– &amp;&amp; å¹¶ä¸” OR æˆ– || æˆ–è€… NOT æˆ– ! éï¼Œä¸æ˜¯ UNION å¯¹ä¸¤ä¸ªç»“æœé›†è¿›è¡Œå¹¶é›†æ“ä½œå¹¶è¿›è¡Œå»é‡ï¼ŒåŒæ—¶è¿›è¡Œé»˜è®¤è§„åˆ™çš„æ’åº UNION ALL å¯¹ä¸¤ä¸ªç»“æœé›†è¿›è¡Œå¹¶é›†æ“ä½œä¸è¿›è¡Œå»é‡ï¼Œä¸è¿›è¡Œæ’åº ä¾‹å¦‚ï¼š 123456789101112131415161718192021222324252627282930-- æŸ¥è¯¢åº“å­˜å¤§äº20çš„å•†å“ä¿¡æ¯SELECT * FROM product WHERE stock &gt; 20;-- æŸ¥è¯¢å“ç‰Œä¸ºåä¸ºçš„å•†å“ä¿¡æ¯SELECT * FROM product WHERE brand=&#x27;åä¸º&#x27;;-- æŸ¥è¯¢é‡‘é¢åœ¨4000 ~ 6000ä¹‹é—´çš„å•†å“ä¿¡æ¯SELECT * FROM product WHERE price &gt;= 4000 AND price &lt;= 6000;SELECT * FROM product WHERE price BETWEEN 4000 AND 6000;-- æŸ¥è¯¢åº“å­˜ä¸º14ã€30ã€23çš„å•†å“ä¿¡æ¯SELECT * FROM product WHERE stock=14 OR stock=30 OR stock=23;SELECT * FROM product WHERE stock IN(14,30,23);-- æŸ¥è¯¢åº“å­˜ä¸ºnullçš„å•†å“ä¿¡æ¯SELECT * FROM product WHERE stock IS NULL;-- æŸ¥è¯¢åº“å­˜ä¸ä¸ºnullçš„å•†å“ä¿¡æ¯SELECT * FROM product WHERE stock IS NOT NULL;-- æŸ¥è¯¢åç§°ä»¥&#x27;å°ç±³&#x27;ä¸ºå¼€å¤´çš„å•†å“ä¿¡æ¯SELECT * FROM product WHERE NAME LIKE &#x27;å°ç±³%&#x27;;-- æŸ¥è¯¢åç§°ç¬¬äºŒä¸ªå­—æ˜¯&#x27;ä¸º&#x27;çš„å•†å“ä¿¡æ¯SELECT * FROM product WHERE NAME LIKE &#x27;_ä¸º%&#x27;;-- æŸ¥è¯¢åç§°ä¸ºå››ä¸ªå­—ç¬¦çš„å•†å“ä¿¡æ¯ 4ä¸ªä¸‹åˆ’çº¿SELECT * FROM product WHERE NAME LIKE &#x27;____&#x27;;-- æŸ¥è¯¢åç§°ä¸­åŒ…å«ç”µè„‘çš„å•†å“ä¿¡æ¯SELECT * FROM product WHERE NAME LIKE &#x27;%ç”µè„‘%&#x27;; å‡½æ•°æŸ¥è¯¢èšåˆå‡½æ•°èšåˆå‡½æ•°ï¼šå°†ä¸€åˆ—æ•°æ®ä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼Œè¿›è¡Œçºµå‘çš„è®¡ç®— èšåˆå‡½æ•°è¯­æ³• 1SELECT å‡½æ•°å(åˆ—å) FROM è¡¨å [WHERE æ¡ä»¶] èšåˆå‡½æ•°åˆ†ç±» å‡½æ•°å åŠŸèƒ½ COUNT(åˆ—å) ç»Ÿè®¡æ•°é‡ï¼ˆä¸€èˆ¬é€‰ç”¨ä¸ä¸º null çš„åˆ—ï¼‰ MAX(åˆ—å) æœ€å¤§å€¼ MIN(åˆ—å) æœ€å°å€¼ SUM(åˆ—å) æ±‚å’Œ AVG(åˆ—å) å¹³å‡å€¼ï¼ˆä¼šå¿½ç•¥ null è¡Œï¼‰ ä¾‹å¦‚ 1234567891011121314151617-- è®¡ç®—productè¡¨ä¸­æ€»è®°å½•æ¡æ•° 7SELECT COUNT(*) FROM product;-- è·å–æœ€é«˜ä»·æ ¼SELECT MAX(price) FROM product;-- è·å–æœ€é«˜ä»·æ ¼çš„å•†å“åç§°SELECT NAME,price FROM product WHERE price = (SELECT MAX(price) FROM product);-- è·å–æœ€ä½åº“å­˜SELECT MIN(stock) FROM product;-- è·å–æœ€ä½åº“å­˜çš„å•†å“åç§°SELECT NAME,stock FROM product WHERE stock = (SELECT MIN(stock) FROM product);-- è·å–æ€»åº“å­˜æ•°é‡SELECT SUM(stock) FROM product;-- è·å–å“ç‰Œä¸ºå°ç±³çš„å¹³å‡å•†å“ä»·æ ¼SELECT AVG(price) FROM product WHERE brand=&#x27;å°ç±³&#x27;; æ–‡æœ¬å‡½æ•°CONCAT()ï¼šç”¨äºè¿æ¥ä¸¤ä¸ªå­—æ®µ 12SELECT CONCAT(TRIM(col1), &#x27;(&#x27;, TRIM(col2), &#x27;)&#x27;) AS concat_col FROM mytable-- è®¸å¤šæ•°æ®åº“ä¼šä½¿ç”¨ç©ºæ ¼æŠŠä¸€ä¸ªå€¼å¡«å……ä¸ºåˆ—å®½ï¼Œè¿æ¥çš„ç»“æœå‡ºç°ä¸€äº›ä¸å¿…è¦çš„ç©ºæ ¼ï¼Œä½¿ç”¨TRIM()å¯ä»¥å»é™¤é¦–å°¾ç©ºæ ¼ å‡½æ•°åç§° ä½œ ç”¨ LENGTH è®¡ç®—å­—ç¬¦ä¸²é•¿åº¦å‡½æ•°ï¼Œè¿”å›å­—ç¬¦ä¸²çš„å­—èŠ‚é•¿åº¦ CONCAT åˆå¹¶å­—ç¬¦ä¸²å‡½æ•°ï¼Œè¿”å›ç»“æœä¸ºè¿æ¥å‚æ•°äº§ç”Ÿçš„å­—ç¬¦ä¸²ï¼Œå‚æ•°å¯ä»¥ä½¿ä¸€ä¸ªæˆ–å¤šä¸ª INSERT æ›¿æ¢å­—ç¬¦ä¸²å‡½æ•° LOWER å°†å­—ç¬¦ä¸²ä¸­çš„å­—æ¯è½¬æ¢ä¸ºå°å†™ UPPER å°†å­—ç¬¦ä¸²ä¸­çš„å­—æ¯è½¬æ¢ä¸ºå¤§å†™ LEFT ä»å·¦ä¾§å­—æˆªå–ç¬¦ä¸²ï¼Œè¿”å›å­—ç¬¦ä¸²å·¦è¾¹çš„è‹¥å¹²ä¸ªå­—ç¬¦ RIGHT ä»å³ä¾§å­—æˆªå–ç¬¦ä¸²ï¼Œè¿”å›å­—ç¬¦ä¸²å³è¾¹çš„è‹¥å¹²ä¸ªå­—ç¬¦ TRIM åˆ é™¤å­—ç¬¦ä¸²å·¦å³ä¸¤ä¾§çš„ç©ºæ ¼ REPLACE å­—ç¬¦ä¸²æ›¿æ¢å‡½æ•°ï¼Œè¿”å›æ›¿æ¢åçš„æ–°å­—ç¬¦ä¸² SUBSTRING æˆªå–å­—ç¬¦ä¸²ï¼Œè¿”å›ä»æŒ‡å®šä½ç½®å¼€å§‹çš„æŒ‡å®šé•¿åº¦çš„å­—ç¬¦æ¢ REVERSE å­—ç¬¦ä¸²åè½¬ï¼ˆé€†åºï¼‰å‡½æ•°ï¼Œè¿”å›ä¸åŸå§‹å­—ç¬¦ä¸²é¡ºåºç›¸åçš„å­—ç¬¦ä¸² æ•°å­—å‡½æ•° å‡½æ•°åç§° ä½œ ç”¨ ABS æ±‚ç»å¯¹å€¼ SQRT æ±‚äºŒæ¬¡æ–¹æ ¹ MOD æ±‚ä½™æ•° CEIL å’Œ CEILING ä¸¤ä¸ªå‡½æ•°åŠŸèƒ½ç›¸åŒï¼Œéƒ½æ˜¯è¿”å›ä¸å°äºå‚æ•°çš„æœ€å°æ•´æ•°ï¼Œå³å‘ä¸Šå–æ•´ FLOOR å‘ä¸‹å–æ•´ï¼Œè¿”å›å€¼è½¬åŒ–ä¸ºä¸€ä¸ªBIGINT RAND ç”Ÿæˆä¸€ä¸ª0~1ä¹‹é—´çš„éšæœºæ•°ï¼Œä¼ å…¥æ•´æ•°å‚æ•°æ˜¯ï¼Œç”¨æ¥äº§ç”Ÿé‡å¤åºåˆ— ROUND å¯¹æ‰€ä¼ å‚æ•°è¿›è¡Œå››èˆäº”å…¥ SIGN è¿”å›å‚æ•°çš„ç¬¦å· POW å’Œ POWER ä¸¤ä¸ªå‡½æ•°çš„åŠŸèƒ½ç›¸åŒï¼Œéƒ½æ˜¯æ‰€ä¼ å‚æ•°çš„æ¬¡æ–¹çš„ç»“æœå€¼ SIN æ±‚æ­£å¼¦å€¼ ASIN æ±‚åæ­£å¼¦å€¼ï¼Œä¸å‡½æ•° SIN äº’ä¸ºåå‡½æ•° COS æ±‚ä½™å¼¦å€¼ ACOS æ±‚åä½™å¼¦å€¼ï¼Œä¸å‡½æ•° COS äº’ä¸ºåå‡½æ•° TAN æ±‚æ­£åˆ‡å€¼ ATAN æ±‚åæ­£åˆ‡å€¼ï¼Œä¸å‡½æ•° TAN äº’ä¸ºåå‡½æ•° COT æ±‚ä½™åˆ‡å€¼ æ—¥æœŸå‡½æ•° å‡½æ•°åç§° ä½œ ç”¨ CURDATE å’Œ CURRENT_DATE ä¸¤ä¸ªå‡½æ•°ä½œç”¨ç›¸åŒï¼Œè¿”å›å½“å‰ç³»ç»Ÿçš„æ—¥æœŸå€¼ CURTIME å’Œ CURRENT_TIME ä¸¤ä¸ªå‡½æ•°ä½œç”¨ç›¸åŒï¼Œè¿”å›å½“å‰ç³»ç»Ÿçš„æ—¶é—´å€¼ NOW å’Œ SYSDATE ä¸¤ä¸ªå‡½æ•°ä½œç”¨ç›¸åŒï¼Œè¿”å›å½“å‰ç³»ç»Ÿçš„æ—¥æœŸå’Œæ—¶é—´å€¼ MONTH è·å–æŒ‡å®šæ—¥æœŸä¸­çš„æœˆä»½ MONTHNAME è·å–æŒ‡å®šæ—¥æœŸä¸­çš„æœˆä»½è‹±æ–‡åç§° DAYNAME è·å–æŒ‡å®šæ›°æœŸå¯¹åº”çš„æ˜ŸæœŸå‡ çš„è‹±æ–‡åç§° DAYOFWEEK è·å–æŒ‡å®šæ—¥æœŸå¯¹åº”çš„ä¸€å‘¨çš„ç´¢å¼•ä½ç½®å€¼ WEEK è·å–æŒ‡å®šæ—¥æœŸæ˜¯ä¸€å¹´ä¸­çš„ç¬¬å‡ å‘¨ï¼Œè¿”å›å€¼çš„èŒƒå›´æ˜¯å¦ä¸º 0ã€œ52 æˆ– 1ã€œ53 DAYOFYEAR è·å–æŒ‡å®šæ›°æœŸæ˜¯ä¸€å¹´ä¸­çš„ç¬¬å‡ å¤©ï¼Œè¿”å›å€¼èŒƒå›´æ˜¯1~366 DAYOFMONTH è·å–æŒ‡å®šæ—¥æœŸæ˜¯ä¸€ä¸ªæœˆä¸­æ˜¯ç¬¬å‡ å¤©ï¼Œè¿”å›å€¼èŒƒå›´æ˜¯1~31 YEAR è·å–å¹´ä»½ï¼Œè¿”å›å€¼èŒƒå›´æ˜¯ 1970ã€œ2069 TIME_TO_SEC å°†æ—¶é—´å‚æ•°è½¬æ¢ä¸ºç§’æ•° SEC_TO_TIME å°†ç§’æ•°è½¬æ¢ä¸ºæ—¶é—´ï¼Œä¸TIME_TO_SEC äº’ä¸ºåå‡½æ•° DATE_ADD å’Œ ADDDATE ä¸¤ä¸ªå‡½æ•°åŠŸèƒ½ç›¸åŒï¼Œéƒ½æ˜¯å‘æ—¥æœŸæ·»åŠ æŒ‡å®šçš„æ—¶é—´é—´éš” DATE_SUB å’Œ SUBDATE ä¸¤ä¸ªå‡½æ•°åŠŸèƒ½ç›¸åŒï¼Œéƒ½æ˜¯å‘æ—¥æœŸå‡å»æŒ‡å®šçš„æ—¶é—´é—´éš” ADDTIME æ—¶é—´åŠ æ³•è¿ç®—ï¼Œåœ¨åŸå§‹æ—¶é—´ä¸Šæ·»åŠ æŒ‡å®šçš„æ—¶é—´ SUBTIME æ—¶é—´å‡æ³•è¿ç®—ï¼Œåœ¨åŸå§‹æ—¶é—´ä¸Šå‡å»æŒ‡å®šçš„æ—¶é—´ DATEDIFF è·å–ä¸¤ä¸ªæ—¥æœŸä¹‹é—´é—´éš”ï¼Œè¿”å›å‚æ•° 1 å‡å»å‚æ•° 2 çš„å€¼ DATE_FORMAT æ ¼å¼åŒ–æŒ‡å®šçš„æ—¥æœŸï¼Œæ ¹æ®å‚æ•°è¿”å›æŒ‡å®šæ ¼å¼çš„å€¼ WEEKDAY è·å–æŒ‡å®šæ—¥æœŸåœ¨ä¸€å‘¨å†…çš„å¯¹åº”çš„å·¥ä½œæ—¥ç´¢å¼• æ­£åˆ™æŸ¥è¯¢æ­£åˆ™è¡¨è¾¾å¼ï¼ˆRegular Expressionï¼‰æ˜¯æŒ‡ä¸€ä¸ªç”¨æ¥æè¿°æˆ–è€…åŒ¹é…ä¸€ç³»åˆ—ç¬¦åˆæŸä¸ªå¥æ³•è§„åˆ™çš„å­—ç¬¦ä¸²çš„å•ä¸ªå­—ç¬¦ä¸² 123SELECT * FROM emp WHERE name REGEXP &#x27;^T&#x27;; -- åŒ¹é…ä»¥Tå¼€å¤´çš„nameå€¼SELECT * FROM emp WHERE name REGEXP &#x27;2$&#x27;; -- åŒ¹é…ä»¥2ç»“å°¾çš„nameå€¼SELECT * FROM emp WHERE name REGEXP &#x27;[uvw]&#x27;;-- åŒ¹é…åŒ…å« uvw çš„nameå€¼ ç¬¦å· å«ä¹‰ ^ åœ¨å­—ç¬¦ä¸²å¼€å§‹å¤„è¿›è¡ŒåŒ¹é… $ åœ¨å­—ç¬¦ä¸²æœ«å°¾å¤„è¿›è¡ŒåŒ¹é… . åŒ¹é…ä»»æ„å•ä¸ªå­—ç¬¦, åŒ…æ‹¬æ¢è¡Œç¬¦ [â€¦] åŒ¹é…å‡ºæ‹¬å·å†…çš„ä»»æ„å­—ç¬¦ [^â€¦] åŒ¹é…ä¸å‡ºæ‹¬å·å†…çš„ä»»æ„å­—ç¬¦ a* åŒ¹é…é›¶ä¸ªæˆ–è€…å¤šä¸ªa(åŒ…æ‹¬ç©ºä¸²) a+ åŒ¹é…ä¸€ä¸ªæˆ–è€…å¤šä¸ªa(ä¸åŒ…æ‹¬ç©ºä¸²) a? åŒ¹é…é›¶ä¸ªæˆ–è€…ä¸€ä¸ªa a1|a2 åŒ¹é…a1æˆ–a2 a(m) åŒ¹é…mä¸ªa a(m,) è‡³å°‘åŒ¹é…mä¸ªa a(m,n) åŒ¹é…mä¸ªa åˆ° nä¸ªa a(,n) åŒ¹é…0åˆ°nä¸ªa (â€¦) å°†æ¨¡å¼å…ƒç´ ç»„æˆå•ä¸€å…ƒç´  æ’åºæŸ¥è¯¢ æ’åºæŸ¥è¯¢è¯­æ³• 1SELECT åˆ—å FROM è¡¨å [WHERE æ¡ä»¶] ORDER BY åˆ—å1 æ’åºæ–¹å¼1,åˆ—å2 æ’åºæ–¹å¼2; æ’åºæ–¹å¼ 12ASC:å‡åºDESC:é™åº æ³¨æ„ï¼šå¤šä¸ªæ’åºæ¡ä»¶ï¼Œå½“å‰è¾¹çš„æ¡ä»¶å€¼ä¸€æ ·æ—¶ï¼Œæ‰ä¼šåˆ¤æ–­ç¬¬äºŒæ¡ä»¶ ä¾‹å¦‚ 12345678-- æŒ‰ç…§åº“å­˜å‡åºæ’åºSELECT * FROM product ORDER BY stock ASC;-- æŸ¥è¯¢åç§°ä¸­åŒ…å«æ‰‹æœºçš„å•†å“ä¿¡æ¯ã€‚æŒ‰ç…§é‡‘é¢é™åºæ’åºSELECT * FROM product WHERE NAME LIKE &#x27;%æ‰‹æœº%&#x27; ORDER BY price DESC;-- æŒ‰ç…§é‡‘é¢å‡åºæ’åºï¼Œå¦‚æœé‡‘é¢ç›¸åŒï¼ŒæŒ‰ç…§åº“å­˜é™åºæ’åˆ—SELECT * FROM product ORDER BY price ASC,stock DESC; åˆ†ç»„æŸ¥è¯¢åˆ†ç»„æŸ¥è¯¢ä¼šè¿›è¡Œå»é‡ åˆ†ç»„æŸ¥è¯¢è¯­æ³• 1SELECT åˆ—å FROM è¡¨å [WHERE æ¡ä»¶] GROUP BY åˆ†ç»„åˆ—å [HAVING åˆ†ç»„åæ¡ä»¶è¿‡æ»¤] [ORDER BY æ’åºåˆ—å æ’åºæ–¹å¼]; WHERE è¿‡æ»¤è¡Œï¼ŒHAVING è¿‡æ»¤åˆ†ç»„ï¼Œè¡Œè¿‡æ»¤åº”å½“å…ˆäºåˆ†ç»„è¿‡æ»¤ åˆ†ç»„è§„å®šï¼š GROUP BY å­å¥å‡ºç°åœ¨ WHERE å­å¥ä¹‹åï¼ŒORDER BY å­å¥ä¹‹å‰ NULL çš„è¡Œä¼šå•ç‹¬åˆ†ä¸ºä¸€ç»„ å¤§å¤šæ•° SQL å®ç°ä¸æ”¯æŒ GROUP BY åˆ—å…·æœ‰å¯å˜é•¿åº¦çš„æ•°æ®ç±»å‹ ä¾‹å¦‚ 1234567891011-- æŒ‰ç…§å“ç‰Œåˆ†ç»„ï¼Œè·å–æ¯ç»„å•†å“çš„æ€»é‡‘é¢SELECT brand,SUM(price) FROM product GROUP BY brand;-- å¯¹é‡‘é¢å¤§äº4000å…ƒçš„å•†å“ï¼ŒæŒ‰ç…§å“ç‰Œåˆ†ç»„,è·å–æ¯ç»„å•†å“çš„æ€»é‡‘é¢SELECT brand,SUM(price) FROM product WHERE price &gt; 4000 GROUP BY brand;-- å¯¹é‡‘é¢å¤§äº4000å…ƒçš„å•†å“ï¼ŒæŒ‰ç…§å“ç‰Œåˆ†ç»„ï¼Œè·å–æ¯ç»„å•†å“çš„æ€»é‡‘é¢ï¼Œåªæ˜¾ç¤ºæ€»é‡‘é¢å¤§äº7000å…ƒçš„SELECT brand,SUM(price) AS getSum FROM product WHERE price &gt; 4000 GROUP BY brand HAVING getSum &gt; 7000;-- å¯¹é‡‘é¢å¤§äº4000å…ƒçš„å•†å“ï¼ŒæŒ‰ç…§å“ç‰Œåˆ†ç»„ï¼Œè·å–æ¯ç»„å•†å“çš„æ€»é‡‘é¢ï¼Œåªæ˜¾ç¤ºæ€»é‡‘é¢å¤§äº7000å…ƒçš„ã€å¹¶æŒ‰ç…§æ€»é‡‘é¢çš„é™åºæ’åˆ—SELECT brand,SUM(price) AS getSum FROM product WHERE price &gt; 4000 GROUP BY brand HAVING getSum &gt; 7000 ORDER BY getSum DESC; åˆ†é¡µæŸ¥è¯¢ åˆ†é¡µæŸ¥è¯¢è¯­æ³• 1SELECT åˆ—å FROM è¡¨å [WHERE æ¡ä»¶] GROUP BY åˆ†ç»„åˆ—å [HAVING åˆ†ç»„åæ¡ä»¶è¿‡æ»¤] [ORDER BY æ’åºåˆ—å æ’åºæ–¹å¼] LIMIT å¼€å§‹ç´¢å¼•,æŸ¥è¯¢æ¡æ•°; å…¬å¼ï¼šå¼€å§‹ç´¢å¼• &#x3D; (å½“å‰é¡µç -1) * æ¯é¡µæ˜¾ç¤ºçš„æ¡æ•° ä¾‹å¦‚ 1234SELECT * FROM product LIMIT 0,2; -- ç¬¬ä¸€é¡µ å¼€å§‹ç´¢å¼•=(1-1) * 2SELECT * FROM product LIMIT 2,2; -- ç¬¬äºŒé¡µ å¼€å§‹ç´¢å¼•=(2-1) * 2SELECT * FROM product LIMIT 4,2; -- ç¬¬ä¸‰é¡µ å¼€å§‹ç´¢å¼•=(3-1) * 2SELECT * FROM product LIMIT 6,2; -- ç¬¬å››é¡µ å¼€å§‹ç´¢å¼•=(4-1) * 2 å¤šè¡¨æ“ä½œçº¦æŸåˆ†ç±»çº¦æŸä»‹ç»çº¦æŸï¼šå¯¹è¡¨ä¸­çš„æ•°æ®è¿›è¡Œé™å®šï¼Œä¿è¯æ•°æ®çš„æ­£ç¡®æ€§ã€æœ‰æ•ˆæ€§ã€å®Œæ•´æ€§ çº¦æŸçš„åˆ†ç±»ï¼š çº¦æŸ è¯´æ˜ PRIMARY KEY ä¸»é”®çº¦æŸ PRIMARY KEY AUTO_INCREMENT ä¸»é”®ã€è‡ªåŠ¨å¢é•¿ UNIQUE å”¯ä¸€çº¦æŸ NOT NULL éç©ºçº¦æŸ FOREIGN KEY å¤–é”®çº¦æŸ FOREIGN KEY ON UPDATE CASCADE å¤–é”®çº§è”æ›´æ–° FOREIGN KEY ON DELETE CASCADE å¤–é”®çº§è”åˆ é™¤ ä¸»é”®çº¦æŸ ä¸»é”®çº¦æŸç‰¹ç‚¹ï¼š ä¸»é”®çº¦æŸé»˜è®¤åŒ…å«éç©ºå’Œå”¯ä¸€ä¸¤ä¸ªåŠŸèƒ½ ä¸€å¼ è¡¨åªèƒ½æœ‰ä¸€ä¸ªä¸»é”® ä¸»é”®ä¸€èˆ¬ç”¨äºè¡¨ä¸­æ•°æ®çš„å”¯ä¸€æ ‡è¯† å»ºè¡¨æ—¶æ·»åŠ ä¸»é”®çº¦æŸ 12345CREATE TABLE è¡¨å( åˆ—å æ•°æ®ç±»å‹ PRIMARY KEY, åˆ—å æ•°æ®ç±»å‹, ...); åˆ é™¤ä¸»é”®çº¦æŸ 1ALTER TABLE è¡¨å DROP PRIMARY KEY; å»ºè¡¨åå•ç‹¬æ·»åŠ ä¸»é”®çº¦æŸ 1ALTER TABLE è¡¨å MODIFY åˆ—å æ•°æ®ç±»å‹ PRIMARY KEY; ä¾‹å¦‚ 1234567891011-- åˆ›å»ºstudentè¡¨CREATE TABLE student( id INT PRIMARY KEY -- ç»™idæ·»åŠ ä¸»é”®çº¦æŸ);-- æ·»åŠ æ•°æ®INSERT INTO student VALUES (1),(2);-- ä¸»é”®é»˜è®¤å”¯ä¸€ï¼Œæ·»åŠ é‡å¤æ•°æ®ï¼Œä¼šæŠ¥é”™INSERT INTO student VALUES (2);-- ä¸»é”®é»˜è®¤éç©ºï¼Œä¸èƒ½æ·»åŠ nullçš„æ•°æ®INSERT INTO student VALUES (NULL); ä¸»é”®è‡ªå¢ä¸»é”®è‡ªå¢çº¦æŸå¯ä»¥ä¸ºç©ºï¼Œå¹¶è‡ªåŠ¨å¢é•¿ã€‚åˆ é™¤æŸæ¡æ•°æ®ä¸å½±å“è‡ªå¢çš„ä¸‹ä¸€ä¸ªæ•°å€¼ï¼Œä¾ç„¶æŒ‰ç…§å‰ä¸€ä¸ªå€¼è‡ªå¢ å»ºè¡¨æ—¶æ·»åŠ ä¸»é”®è‡ªå¢çº¦æŸ 12345CREATE TABLE è¡¨å( åˆ—å æ•°æ®ç±»å‹ PRIMARY KEY AUTO_INCREMENT, åˆ—å æ•°æ®ç±»å‹, ...); åˆ é™¤ä¸»é”®è‡ªå¢çº¦æŸ 1ALTER TABLE è¡¨å MODIFY åˆ—å æ•°æ®ç±»å‹; å»ºè¡¨åå•ç‹¬æ·»åŠ ä¸»é”®è‡ªå¢çº¦æŸ 1ALTER TABLE è¡¨å MODIFY åˆ—å æ•°æ®ç±»å‹ AUTO_INCREMENT; ä¾‹å¦‚ 123456789-- åˆ›å»ºstudent2è¡¨CREATE TABLE student2( id INT PRIMARY KEY AUTO_INCREMENT -- ç»™idæ·»åŠ ä¸»é”®è‡ªå¢çº¦æŸ);-- æ·»åŠ æ•°æ®INSERT INTO student2 VALUES (1),(2);-- æ·»åŠ nullå€¼ï¼Œä¼šè‡ªåŠ¨å¢é•¿INSERT INTO student2 VALUES (NULL),(NULL);-- 3ï¼Œ4 å”¯ä¸€çº¦æŸå”¯ä¸€çº¦æŸï¼šçº¦æŸä¸èƒ½æœ‰é‡å¤çš„æ•°æ® å»ºè¡¨æ—¶æ·»åŠ å”¯ä¸€çº¦æŸ 12345CREATE TABLE è¡¨å( åˆ—å æ•°æ®ç±»å‹ UNIQUE, åˆ—å æ•°æ®ç±»å‹, ...); åˆ é™¤å”¯ä¸€çº¦æŸ 1ALTER TABLE è¡¨å DROP INDEX åˆ—å; å»ºè¡¨åå•ç‹¬æ·»åŠ å”¯ä¸€çº¦æŸ 1ALTER TABLE è¡¨å MODIFY åˆ—å æ•°æ®ç±»å‹ UNIQUE; éç©ºçº¦æŸ å»ºè¡¨æ—¶æ·»åŠ éç©ºçº¦æŸ 12345CREATE TABLE è¡¨å( åˆ—å æ•°æ®ç±»å‹ NOT NULL, åˆ—å æ•°æ®ç±»å‹, ...); åˆ é™¤éç©ºçº¦æŸ 1ALTER TABLE è¡¨å MODIFY åˆ—å æ•°æ®ç±»å‹; å»ºè¡¨åå•ç‹¬æ·»åŠ éç©ºçº¦æŸ 1ALTER TABLE è¡¨å MODIFY åˆ—å æ•°æ®ç±»å‹ NOT NULL; å¤–é”®çº¦æŸ å¤–é”®çº¦æŸï¼šè®©è¡¨å’Œè¡¨ä¹‹é—´äº§ç”Ÿå…³ç³»ï¼Œä»è€Œä¿è¯æ•°æ®çš„å‡†ç¡®æ€§ å»ºè¡¨æ—¶æ·»åŠ å¤–é”®çº¦æŸ 12345CREATE TABLE è¡¨å( åˆ—å æ•°æ®ç±»å‹ çº¦æŸ, ... CONSTRAINT å¤–é”®å FOREIGN KEY (æœ¬è¡¨å¤–é”®åˆ—å) REFERENCES ä¸»è¡¨å(ä¸»è¡¨ä¸»é”®åˆ—å)); åˆ é™¤å¤–é”®çº¦æŸ 1ALTER TABLE è¡¨å DROP FOREIGN KEY å¤–é”®å; å»ºè¡¨åå•ç‹¬æ·»åŠ å¤–é”®çº¦æŸ 1ALTER TABLE è¡¨å ADD CONSTRAINT å¤–é”®å FOREIGN KEY (æœ¬è¡¨å¤–é”®åˆ—å) REFERENCES ä¸»è¡¨å(ä¸»è¡¨ä¸»é”®åˆ—å); ä¾‹å¦‚ 123456789101112131415161718192021222324-- åˆ›å»ºuserç”¨æˆ·è¡¨CREATE TABLE USER( id INT PRIMARY KEY AUTO_INCREMENT, -- id name VARCHAR(20) NOT NULL -- å§“å);-- æ·»åŠ ç”¨æˆ·æ•°æ®INSERT INTO USER VALUES (NULL,&#x27;å¼ ä¸‰&#x27;),(NULL,&#x27;æå››&#x27;),(NULL,&#x27;ç‹äº”&#x27;);-- åˆ›å»ºorderlistè®¢å•è¡¨CREATE TABLE orderlist( id INT PRIMARY KEY AUTO_INCREMENT, -- id number VARCHAR(20) NOT NULL, -- è®¢å•ç¼–å· uid INT, -- è®¢å•æ‰€å±ç”¨æˆ· CONSTRAINT ou_fk1 FOREIGN KEY (uid) REFERENCES USER(id) -- æ·»åŠ å¤–é”®çº¦æŸ);-- æ·»åŠ è®¢å•æ•°æ®INSERT INTO orderlist VALUES (NULL,&#x27;hm001&#x27;,1),(NULL,&#x27;hm002&#x27;,1),(NULL,&#x27;hm003&#x27;,2),(NULL,&#x27;hm004&#x27;,2),(NULL,&#x27;hm005&#x27;,3),(NULL,&#x27;hm006&#x27;,3);-- æ·»åŠ ä¸€ä¸ªè®¢å•ï¼Œä½†æ˜¯æ²¡æœ‰æ‰€å±ç”¨æˆ·ã€‚æ— æ³•æ·»åŠ INSERT INTO orderlist VALUES (NULL,&#x27;hm007&#x27;,8);-- åˆ é™¤ç‹äº”è¿™ä¸ªç”¨æˆ·ï¼Œä½†æ˜¯è®¢å•è¡¨ä¸­ç‹äº”è¿˜æœ‰å¾ˆå¤šä¸ªè®¢å•å‘¢ã€‚æ— æ³•åˆ é™¤DELETE FROM USER WHERE NAME=&#x27;ç‹äº”&#x27;; å¤–é”®çº§è”çº§è”æ“ä½œï¼šå½“æŠŠä¸»è¡¨ä¸­çš„æ•°æ®è¿›è¡Œåˆ é™¤æˆ–æ›´æ–°æ—¶ï¼Œä»è¡¨ä¸­æœ‰å…³è”çš„æ•°æ®çš„ç›¸åº”æ“ä½œï¼ŒåŒ…æ‹¬ RESTRICTã€CASCADEã€SET NULL å’Œ NO ACTION RESTRICT å’Œ NO ACTIONç›¸åŒï¼Œ æ˜¯æŒ‡é™åˆ¶åœ¨å­è¡¨æœ‰å…³è”è®°å½•çš„æƒ…å†µä¸‹ï¼Œ çˆ¶è¡¨ä¸èƒ½æ›´æ–° CASCADE è¡¨ç¤ºçˆ¶è¡¨åœ¨æ›´æ–°æˆ–è€…åˆ é™¤æ—¶ï¼Œæ›´æ–°æˆ–è€…åˆ é™¤å­è¡¨å¯¹åº”çš„è®°å½• SET NULL åˆ™è¡¨ç¤ºçˆ¶è¡¨åœ¨æ›´æ–°æˆ–è€…åˆ é™¤çš„æ—¶å€™ï¼Œå­è¡¨çš„å¯¹åº”å­—æ®µè¢«SET NULL çº§è”æ“ä½œï¼š æ·»åŠ çº§è”æ›´æ–° 1ALTER TABLE è¡¨å ADD CONSTRAINT å¤–é”®å FOREIGN KEY (æœ¬è¡¨å¤–é”®åˆ—å) REFERENCES ä¸»è¡¨å(ä¸»è¡¨ä¸»é”®åˆ—å) ON UPDATE [CASCADE | RESTRICT | SET NULL]; æ·»åŠ çº§è”åˆ é™¤ 1ALTER TABLE è¡¨å ADD CONSTRAINT å¤–é”®å FOREIGN KEY (æœ¬è¡¨å¤–é”®åˆ—å) REFERENCES ä¸»è¡¨å(ä¸»è¡¨ä¸»é”®åˆ—å) ON DELETE CASCADE; åŒæ—¶æ·»åŠ çº§è”æ›´æ–°å’Œçº§è”åˆ é™¤ 1ALTER TABLE è¡¨å ADD CONSTRAINT å¤–é”®å FOREIGN KEY (æœ¬è¡¨å¤–é”®åˆ—å) REFERENCES ä¸»è¡¨å(ä¸»è¡¨ä¸»é”®åˆ—å) ON UPDATE CASCADE ON DELETE CASCADE; å¤šè¡¨è®¾è®¡ä¸€å¯¹ä¸€å¤šè¡¨ï¼šæœ‰å¤šå¼ æ•°æ®è¡¨ï¼Œè€Œè¡¨ä¸è¡¨ä¹‹é—´æœ‰ä¸€å®šçš„å…³è”å…³ç³»ï¼Œé€šè¿‡å¤–é”®çº¦æŸå®ç°ï¼Œåˆ†ä¸ºä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šã€å¤šå¯¹å¤šä¸‰ç±» ä¸¾ä¾‹ï¼šäººå’Œèº«ä»½è¯ å®ç°åŸåˆ™ï¼šåœ¨ä»»æ„ä¸€ä¸ªè¡¨å»ºç«‹å¤–é”®ï¼Œå»å…³è”å¦å¤–ä¸€ä¸ªè¡¨çš„ä¸»é”® 1234567891011121314151617-- åˆ›å»ºpersonè¡¨CREATE TABLE person( id INT PRIMARY KEY AUTO_INCREMENT, -- ä¸»é”®id NAME VARCHAR(20) -- å§“å);-- æ·»åŠ æ•°æ®INSERT INTO person VALUES (NULL,&#x27;å¼ ä¸‰&#x27;),(NULL,&#x27;æå››&#x27;);-- åˆ›å»ºcardè¡¨CREATE TABLE card( id INT PRIMARY KEY AUTO_INCREMENT, -- ä¸»é”®id number VARCHAR(20) UNIQUE NOT NULL, -- èº«ä»½è¯å· pid INT UNIQUE, -- å¤–é”®åˆ— CONSTRAINT cp_fk1 FOREIGN KEY (pid) REFERENCES person(id));-- æ·»åŠ æ•°æ®INSERT INTO card VALUES (NULL,&#x27;12345&#x27;,1),(NULL,&#x27;56789&#x27;,2); ä¸€å¯¹å¤šä¸¾ä¾‹ï¼šç”¨æˆ·å’Œè®¢å•ã€å•†å“åˆ†ç±»å’Œå•†å“ å®ç°åŸåˆ™ï¼šåœ¨å¤šçš„ä¸€æ–¹ï¼Œå»ºç«‹å¤–é”®çº¦æŸï¼Œæ¥å…³è”ä¸€çš„ä¸€æ–¹ä¸»é”® 1234567891011121314151617-- åˆ›å»ºuserè¡¨CREATE TABLE USER( id INT PRIMARY KEY AUTO_INCREMENT, -- ä¸»é”®id NAME VARCHAR(20) -- å§“å);-- æ·»åŠ æ•°æ®INSERT INTO USER VALUES (NULL,&#x27;å¼ ä¸‰&#x27;),(NULL,&#x27;æå››&#x27;);-- åˆ›å»ºorderlistè¡¨CREATE TABLE orderlist( id INT PRIMARY KEY AUTO_INCREMENT, -- ä¸»é”®id number VARCHAR(20), -- è®¢å•ç¼–å· uid INT, -- å¤–é”®åˆ— CONSTRAINT ou_fk1 FOREIGN KEY (uid) REFERENCES USER(id));-- æ·»åŠ æ•°æ®INSERT INTO orderlist VALUES (NULL,&#x27;hm001&#x27;,1),(NULL,&#x27;hm002&#x27;,1),(NULL,&#x27;hm003&#x27;,2),(NULL,&#x27;hm004&#x27;,2); å¤šå¯¹å¤šä¸¾ä¾‹ï¼šå­¦ç”Ÿå’Œè¯¾ç¨‹ã€‚ä¸€ä¸ªå­¦ç”Ÿå¯ä»¥é€‰æ‹©å¤šä¸ªè¯¾ç¨‹ï¼Œä¸€ä¸ªè¯¾ç¨‹ä¹Ÿå¯ä»¥è¢«å¤šä¸ªå­¦ç”Ÿé€‰æ‹© å®ç°åŸåˆ™ï¼šå€ŸåŠ©ç¬¬ä¸‰å¼ è¡¨ä¸­é—´è¡¨ï¼Œä¸­é—´è¡¨è‡³å°‘åŒ…å«ä¸¤ä¸ªåˆ—ï¼Œè¿™ä¸¤ä¸ªåˆ—ä½œä¸ºä¸­é—´è¡¨çš„å¤–é”®ï¼Œåˆ†åˆ«å…³è”ä¸¤å¼ è¡¨çš„ä¸»é”® 1234567891011121314151617181920212223242526-- åˆ›å»ºstudentè¡¨CREATE TABLE student( id INT PRIMARY KEY AUTO_INCREMENT, -- ä¸»é”®id NAME VARCHAR(20) -- å­¦ç”Ÿå§“å);-- æ·»åŠ æ•°æ®INSERT INTO student VALUES (NULL,&#x27;å¼ ä¸‰&#x27;),(NULL,&#x27;æå››&#x27;);-- åˆ›å»ºcourseè¡¨CREATE TABLE course( id INT PRIMARY KEY AUTO_INCREMENT, -- ä¸»é”®id NAME VARCHAR(10) -- è¯¾ç¨‹åç§°);-- æ·»åŠ æ•°æ®INSERT INTO course VALUES (NULL,&#x27;è¯­æ–‡&#x27;),(NULL,&#x27;æ•°å­¦&#x27;);-- åˆ›å»ºä¸­é—´è¡¨CREATE TABLE stu_course( id INT PRIMARY KEY AUTO_INCREMENT, -- ä¸»é”®id sid INT, -- ç”¨äºå’Œstudentè¡¨ä¸­çš„idè¿›è¡Œå¤–é”®å…³è” cid INT, -- ç”¨äºå’Œcourseè¡¨ä¸­çš„idè¿›è¡Œå¤–é”®å…³è” CONSTRAINT sc_fk1 FOREIGN KEY (sid) REFERENCES student(id), -- æ·»åŠ å¤–é”®çº¦æŸ CONSTRAINT sc_fk2 FOREIGN KEY (cid) REFERENCES course(id) -- æ·»åŠ å¤–é”®çº¦æŸ);-- æ·»åŠ æ•°æ®INSERT INTO stu_course VALUES (NULL,1,1),(NULL,1,2),(NULL,2,1),(NULL,2,2); è¿æ¥æŸ¥è¯¢å†…å¤–è¿æ¥å†…è¿æ¥è¿æ¥æŸ¥è¯¢çš„æ˜¯ä¸¤å¼ è¡¨æœ‰äº¤é›†çš„éƒ¨åˆ†æ•°æ®ï¼Œä¸¤å¼ è¡¨åˆ†ä¸ºé©±åŠ¨è¡¨å’Œè¢«é©±åŠ¨è¡¨ï¼Œå¦‚æœç»“æœé›†ä¸­çš„æ¯æ¡è®°å½•éƒ½æ˜¯ä¸¤ä¸ªè¡¨ç›¸äº’åŒ¹é…çš„ç»„åˆï¼Œåˆ™ç§°è¿™æ ·çš„ç»“æœé›†ä¸ºç¬›å¡å°”ç§¯ å†…è¿æ¥æŸ¥è¯¢ï¼Œè‹¥é©±åŠ¨è¡¨ä¸­çš„è®°å½•åœ¨è¢«é©±åŠ¨è¡¨ä¸­æ‰¾ä¸åˆ°åŒ¹é…çš„è®°å½•æ—¶ï¼Œåˆ™è¯¥è®°å½•ä¸ä¼šåŠ åˆ°æœ€åçš„ç»“æœé›† æ˜¾å¼å†…è¿æ¥ï¼š 1SELECT åˆ—å FROM è¡¨å1 [INNER] JOIN è¡¨å2 ON æ¡ä»¶; éšå¼å†…è¿æ¥ï¼šå†…è¿æ¥ä¸­ WHERE å­å¥å’Œ ON å­å¥æ˜¯ç­‰ä»·çš„ 1SELECT åˆ—å FROM è¡¨å1,è¡¨å2 WHERE æ¡ä»¶; STRAIGHT_JOINä¸ JOIN ç±»ä¼¼ï¼Œåªä¸è¿‡å·¦è¡¨å§‹ç»ˆåœ¨å³è¡¨ä¹‹å‰è¯»å–ï¼Œåªé€‚ç”¨äºå†…è¿æ¥ å¤–è¿æ¥å¤–è¿æ¥æŸ¥è¯¢ï¼Œè‹¥é©±åŠ¨è¡¨ä¸­çš„è®°å½•åœ¨è¢«é©±åŠ¨è¡¨ä¸­æ‰¾ä¸åˆ°åŒ¹é…çš„è®°å½•æ—¶ï¼Œåˆ™è¯¥è®°å½•ä¹Ÿä¼šåŠ åˆ°æœ€åçš„ç»“æœé›†ï¼Œåªæ˜¯å¯¹äºè¢«é©±åŠ¨è¡¨ä¸­ä¸åŒ¹é…è¿‡æ»¤æ¡ä»¶çš„è®°å½•ï¼Œå„ä¸ªå­—æ®µä½¿ç”¨ NULL å¡«å…… åº”ç”¨å®ä¾‹ï¼šæŸ¥å­¦ç”Ÿæˆç»©ï¼Œä¹Ÿæƒ³å±•ç¤ºå‡ºç¼ºè€ƒçš„äººçš„æˆç»© å·¦å¤–è¿æ¥ï¼šé€‰æ‹©å·¦ä¾§çš„è¡¨ä¸ºé©±åŠ¨è¡¨ï¼ŒæŸ¥è¯¢å·¦è¡¨çš„å…¨éƒ¨æ•°æ®ï¼Œå’Œå·¦å³ä¸¤å¼ è¡¨æœ‰äº¤é›†éƒ¨åˆ†çš„æ•°æ® 1SELECT åˆ—å FROM è¡¨å1 LEFT [OUTER] JOIN è¡¨å2 ON æ¡ä»¶; å³å¤–è¿æ¥ï¼šé€‰æ‹©å³ä¾§çš„è¡¨ä¸ºé©±åŠ¨è¡¨ï¼ŒæŸ¥è¯¢å³è¡¨çš„å…¨éƒ¨æ•°æ®ï¼Œå’Œå·¦å³ä¸¤å¼ è¡¨æœ‰äº¤é›†éƒ¨åˆ†çš„æ•°æ® 1SELECT åˆ—å FROM è¡¨å1 RIGHT [OUTER] JOIN è¡¨å2 ON æ¡ä»¶; å…³è”æŸ¥è¯¢è‡ªå…³è”æŸ¥è¯¢ï¼šåŒä¸€å¼ è¡¨ä¸­æœ‰æ•°æ®å…³è”ï¼Œå¯ä»¥å¤šæ¬¡æŸ¥è¯¢è¿™åŒä¸€ä¸ªè¡¨ æ•°æ®å‡†å¤‡ 123456789-- åˆ›å»ºå‘˜å·¥è¡¨CREATE TABLE employee( id INT PRIMARY KEY AUTO_INCREMENT, -- å‘˜å·¥ç¼–å· NAME VARCHAR(20), -- å‘˜å·¥å§“å mgr INT, -- ä¸Šçº§ç¼–å· salary DOUBLE -- å‘˜å·¥å·¥èµ„);-- æ·»åŠ æ•°æ®INSERT INTO employee VALUES (1001,&#x27;å­™æ‚Ÿç©º&#x27;,1005,9000.00),..,(1009,&#x27;å®‹æ±Ÿ&#x27;,NULL,16000.00); æ•°æ®æŸ¥è¯¢ 12345678910111213141516171819-- æŸ¥è¯¢æ‰€æœ‰å‘˜å·¥çš„å§“ååŠå…¶ç›´æ¥ä¸Šçº§çš„å§“åï¼Œæ²¡æœ‰ä¸Šçº§çš„å‘˜å·¥ä¹Ÿéœ€è¦æŸ¥è¯¢/*åˆ†æ å‘˜å·¥ä¿¡æ¯ employeeè¡¨ æ¡ä»¶ï¼šemployee.mgr = employee.id æŸ¥è¯¢å·¦è¡¨çš„å…¨éƒ¨æ•°æ®ï¼Œå’Œå·¦å³ä¸¤å¼ è¡¨æœ‰äº¤é›†éƒ¨åˆ†æ•°æ®ï¼Œå·¦å¤–è¿æ¥*/SELECT e1.id, e1.name, e1.mgr, e2.id, e2.nameFROM employee e1LEFT OUTER JOIN employee e2ON e1.mgr = e2.id; æŸ¥è¯¢ç»“æœ 12345678910id name mgr id name1001 å­™æ‚Ÿç©º 1005 1005 å”åƒ§1002 çŒªå…«æˆ’ 1005 1005 å”åƒ§1003 æ²™å’Œå°š 1005 1005 å”åƒ§1004 å°ç™½é¾™ 1005 1005 å”åƒ§1005 å”åƒ§ NULL NULL NULL1006 æ­¦æ¾ 1009 1009 å®‹æ±Ÿ1007 æé€µ 1009 1009 å®‹æ±Ÿ1008 æ—å†² 1009 1009 å®‹æ±Ÿ1009 å®‹æ±Ÿ NULL NULL NULL è¿æ¥åŸç†Index Nested-Loop Join ç®—æ³•ï¼šæŸ¥è¯¢é©±åŠ¨è¡¨å¾—åˆ°æ•°æ®é›†ï¼Œç„¶åæ ¹æ®æ•°æ®é›†ä¸­çš„æ¯ä¸€æ¡è®°å½•çš„å…³è”å­—æ®µå†åˆ†åˆ«åˆ°è¢«é©±åŠ¨è¡¨ä¸­æŸ¥æ‰¾åŒ¹é…ï¼ˆèµ°ç´¢å¼•ï¼‰ï¼Œæ‰€ä»¥é©±åŠ¨è¡¨åªéœ€è¦è®¿é—®ä¸€æ¬¡ï¼Œè¢«é©±åŠ¨è¡¨è¦è®¿é—®å¤šæ¬¡ MySQL å°†æŸ¥è¯¢é©±åŠ¨è¡¨åå¾—åˆ°çš„è®°å½•æˆä¸ºé©±åŠ¨è¡¨çš„æ‰‡å‡ºï¼Œè¿æ¥æŸ¥è¯¢çš„æˆæœ¬ï¼šå•æ¬¡è®¿é—®é©±åŠ¨è¡¨çš„æˆæœ¬ + æ‰‡å‡ºå€¼ * å•æ¬¡è®¿é—®è¢«é©±åŠ¨è¡¨çš„æˆæœ¬ï¼Œä¼˜åŒ–å™¨ä¼šé€‰æ‹©æˆæœ¬æœ€å°çš„è¡¨è¿æ¥é¡ºåºï¼ˆç¡®å®šè°æ˜¯é©±åŠ¨è¡¨ï¼Œè°æ˜¯è¢«é©±åŠ¨è¡¨ï¼‰ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼Œè¿›è¡Œè¿æ¥æŸ¥è¯¢ï¼Œä¼˜åŒ–æ–¹å¼ï¼š å‡å°‘é©±åŠ¨è¡¨çš„æ‰‡å‡ºï¼ˆè®©æ•°æ®é‡å°çš„è¡¨æ¥åšé©±åŠ¨è¡¨ï¼‰ é™ä½è®¿é—®è¢«é©±åŠ¨è¡¨çš„æˆæœ¬ è¯´æ˜ï¼šSTRAIGHT_JOIN æ˜¯æŸ¥ä¸€æ¡é©±åŠ¨è¡¨ï¼Œç„¶åæ ¹æ®å…³è”å­—æ®µå»æŸ¥è¢«é©±åŠ¨è¡¨ï¼Œè¦è®¿é—®å¤šæ¬¡é©±åŠ¨è¡¨ï¼Œæ‰€ä»¥éœ€è¦ä¼˜åŒ–ä¸º INL ç®—æ³• Block Nested-Loop Join ç®—æ³•ï¼šä¸€ç§ç©ºé—´æ¢æ—¶é—´çš„ä¼˜åŒ–æ–¹å¼ï¼ŒåŸºäºå—çš„å¾ªç¯è¿æ¥ï¼Œæ‰§è¡Œè¿æ¥æŸ¥è¯¢å‰ç”³è¯·ä¸€å—å›ºå®šå¤§å°çš„å†…å­˜ä½œä¸ºè¿æ¥ç¼“å†²åŒº Join Bufferï¼Œå…ˆæŠŠè‹¥å¹²æ¡é©±åŠ¨è¡¨ä¸­çš„æ‰‡å‡ºæš‚å­˜åœ¨ç¼“å†²åŒºï¼Œæ¯ä¸€æ¡è¢«é©±åŠ¨è¡¨ä¸­çš„è®°å½•ä¸€æ¬¡æ€§çš„ä¸ Buffer ä¸­å¤šæ¡è®°å½•è¿›è¡ŒåŒ¹é…ï¼ˆæ‰«æå…¨éƒ¨æ•°æ®ï¼Œä¸€æ¡ä¸€æ¡çš„åŒ¹é…ï¼‰ï¼Œå› ä¸ºæ˜¯åœ¨å†…å­˜ä¸­å®Œæˆï¼Œæ‰€ä»¥é€Ÿåº¦å¿«ï¼Œå¹¶ä¸”é™ä½äº† I&#x2F;O æˆæœ¬ Join Buffer å¯ä»¥é€šè¿‡å‚æ•° join_buffer_size è¿›è¡Œé…ç½®ï¼Œé»˜è®¤å¤§å°æ˜¯ 256 KB åœ¨æˆæœ¬åˆ†ææ—¶ï¼Œå¯¹äºå¾ˆå¤šå¼ è¡¨çš„è¿æ¥æŸ¥è¯¢ï¼Œè¿æ¥é¡ºåºæœ‰éå¸¸å¤šï¼ŒMySQL å¦‚æœæŒ¨ç€è¿›è¡Œéå†è®¡ç®—æˆæœ¬ï¼Œä¼šæ¶ˆè€—å¾ˆå¤šèµ„æº æå‰ç»“æŸæŸç§è¿æ¥é¡ºåºçš„æˆæœ¬è¯„ä¼°ï¼šç»´æŠ¤ä¸€ä¸ªå…¨å±€å˜é‡è®°å½•å½“å‰æˆæœ¬æœ€å°çš„è¿æ¥æ–¹å¼ï¼Œå¦‚æœä¸€ç§é¡ºåºåªè®¡ç®—äº†ä¸€éƒ¨åˆ†å°±å·²ç»è¶…è¿‡äº†æœ€å°æˆæœ¬ï¼Œå¯ä»¥æå‰ç»“æŸè®¡ç®— ç³»ç»Ÿå˜é‡ optimizer_search_depthï¼šå¦‚æœè¿æ¥è¡¨çš„ä¸ªæ•°å°äºè¯¥å˜é‡ï¼Œå°±ç»§ç»­ç©·ä¸¾åˆ†ææ¯ä¸€ç§è¿æ¥æ•°é‡ï¼Œåä¹‹åªå¯¹æ•°é‡ä¸ depth å€¼ç›¸åŒçš„è¡¨è¿›è¡Œåˆ†æï¼Œè¯¥å€¼è¶Šå¤§æˆæœ¬åˆ†æçš„è¶Šç²¾ç¡® ç³»ç»Ÿå˜é‡ optimizer_prune_levelï¼šæ§åˆ¶å¯å‘å¼è§„åˆ™çš„å¯ç”¨ï¼Œè¿™äº›è§„åˆ™å°±æ˜¯æ ¹æ®ä»¥å¾€ç»éªŒæŒ‡å®šçš„ï¼Œä¸æ»¡è¶³è§„åˆ™çš„è¿æ¥é¡ºåºä¸åˆ†ææˆæœ¬ è¿æ¥ä¼˜åŒ–BKABatched Key Access ç®—æ³•æ˜¯å¯¹ NLJ ç®—æ³•çš„ä¼˜åŒ–ï¼Œåœ¨è¯»å–è¢«é©±åŠ¨è¡¨çš„è®°å½•æ—¶ä½¿ç”¨é¡ºåº IOï¼ŒExtra ä¿¡æ¯ä¸­ä¼šæœ‰ Batched Key Access ä¿¡æ¯ ä½¿ç”¨ BKA çš„è¡¨çš„ JOIN è¿‡ç¨‹å¦‚ä¸‹ï¼š è¿æ¥é©±åŠ¨è¡¨å°†æ»¡è¶³æ¡ä»¶çš„è®°å½•æ”¾å…¥ Join Bufferï¼Œå¹¶å°†ä¸¤è¡¨è¿æ¥çš„å­—æ®µæ”¾å…¥ä¸€ä¸ª DYNAMIC_ARRAY ranges ä¸­ åœ¨è¿›è¡Œè¡¨çš„è¿‡æ¥è¿‡ç¨‹ä¸­ï¼Œä¼šå°† ranges ç›¸å…³çš„ä¿¡æ¯ä¼ å…¥ Buffer ä¸­ï¼Œè¿›è¡Œè¢«é©±åŠ¨è¡¨ä¸»å»ºçš„æŸ¥æ‰¾åŠæ’åºæ“ä½œ è°ƒç”¨æ­¥éª¤ 2 ä¸­äº§ç”Ÿçš„æœ‰åºä¸»å»ºï¼Œé¡ºåºè¯»å–è¢«é©±åŠ¨è¡¨çš„æ•°æ® å½“ç¼“å†²åŒºçš„æ•°æ®è¢«è¯»å®Œåï¼Œä¼šé‡å¤è¿›è¡Œæ­¥éª¤ 2ã€3ï¼Œç›´åˆ°è®°å½•è¢«è¯»å–å®Œ ä½¿ç”¨ BKA ä¼˜åŒ–éœ€è¦è®¾è¿›è¡Œè®¾ç½®ï¼š 1SET optimizer_switch=&#x27;mrr=on,mrr_cost_based=off,batched_key_access=on&#x27;; è¯´æ˜ï¼šå‰ä¸¤ä¸ªå‚æ•°çš„ä½œç”¨æ˜¯å¯ç”¨ MRRï¼Œå› ä¸º BKA ç®—æ³•çš„ä¼˜åŒ–è¦ä¾èµ–äº MRRï¼ˆç³»ç»Ÿä¼˜åŒ– â†’ å†…å­˜ä¼˜åŒ– â†’ Read è¯¦è§£ï¼‰ BNLé—®é¢˜BNL å³ Block Nested-Loop Join ç®—æ³•ï¼Œç”±äºè¦è®¿é—®å¤šæ¬¡è¢«é©±åŠ¨è¡¨ï¼Œä¼šäº§ç”Ÿä¸¤ä¸ªé—®é¢˜ï¼š Join è¯­å¥å¤šæ¬¡æ‰«æä¸€ä¸ªå†·è¡¨ï¼Œå¹¶ä¸”è¯­å¥æ‰§è¡Œæ—¶é—´å°äº 1 ç§’ï¼Œå°±ä¼šåœ¨å†æ¬¡æ‰«æå†·è¡¨æ—¶ï¼ŒæŠŠå†·è¡¨çš„æ•°æ®é¡µç§»åˆ° LRU é“¾è¡¨å¤´éƒ¨ï¼Œå¯¼è‡´çƒ­æ•°æ®è¢«æ·˜æ±°ï¼Œå½±å“ä¸šåŠ¡çš„æ­£å¸¸è¿è¡Œ è¿™ç§æƒ…å†µå†·è¡¨çš„æ•°æ®é‡è¦å°äºæ•´ä¸ª Buffer Pool çš„ old åŒºåŸŸï¼Œèƒ½å¤Ÿå®Œå…¨æ”¾å…¥ old åŒºï¼Œæ‰ä¼šå†æ¬¡è¢«è¯»æ—¶åŠ åˆ° youngï¼Œå¦åˆ™è¯»å–ä¸‹ä¸€æ®µæ—¶å°±å·²ç»æŠŠä¸Šä¸€æ®µæ·˜æ±° Join è¯­å¥åœ¨å¾ªç¯è¯»ç£ç›˜å’Œæ·˜æ±°å†…å­˜é¡µï¼Œè¿›å…¥ old åŒºåŸŸçš„æ•°æ®é¡µå¾ˆå¯èƒ½åœ¨ 1 ç§’ä¹‹å†…å°±è¢«æ·˜æ±°ï¼Œå°±ä¼šå¯¼è‡´ MySQL å®ä¾‹çš„ Buffer Pool åœ¨è¿™æ®µæ—¶é—´å†… young åŒºåŸŸçš„æ•°æ®é¡µæ²¡æœ‰è¢«åˆç†åœ°æ·˜æ±° å¤§è¡¨ Join æ“ä½œè™½ç„¶å¯¹ IO æœ‰å½±å“ï¼Œä½†æ˜¯åœ¨è¯­å¥æ‰§è¡Œç»“æŸåå¯¹ IO çš„å½±å“éšä¹‹ç»“æŸã€‚ä½†æ˜¯å¯¹ Buffer Pool çš„å½±å“å°±æ˜¯æŒç»­æ€§çš„ï¼Œéœ€è¦ä¾é åç»­çš„æŸ¥è¯¢è¯·æ±‚æ…¢æ…¢æ¢å¤å†…å­˜å‘½ä¸­ç‡ ä¼˜åŒ–å°† BNL ç®—æ³•è½¬æˆ BKA ç®—æ³•ï¼Œä¼˜åŒ–æ–¹å‘ï¼š åœ¨è¢«é©±åŠ¨è¡¨ä¸Šå»ºç´¢å¼•ï¼Œè¿™æ ·å°±å¯ä»¥æ ¹æ®ç´¢å¼•è¿›è¡Œé¡ºåº IO ä½¿ç”¨ä¸´æ—¶è¡¨ï¼Œåœ¨ä¸´æ—¶è¡¨ä¸Šå»ºç«‹ç´¢å¼•ï¼Œå°†è¢«é©±åŠ¨è¡¨å’Œä¸´æ—¶è¡¨è¿›è¡Œè¿æ¥æŸ¥è¯¢ é©±åŠ¨è¡¨ t1ï¼Œè¢«é©±åŠ¨è¡¨ t2ï¼Œä½¿ç”¨ä¸´æ—¶è¡¨çš„å·¥ä½œæµç¨‹ï¼š æŠŠè¡¨ t1 ä¸­æ»¡è¶³æ¡ä»¶çš„æ•°æ®æ”¾åœ¨ä¸´æ—¶è¡¨ tmp_t ä¸­ ç»™ä¸´æ—¶è¡¨ tmp_t çš„å…³è”å­—æ®µåŠ ä¸Šç´¢å¼•ï¼Œä½¿ç”¨ BKA ç®—æ³• è®©è¡¨ t2 å’Œ tmp_t åš Join æ“ä½œï¼ˆä¸´æ—¶è¡¨æ˜¯è¢«é©±åŠ¨è¡¨ï¼‰ è¡¥å……ï¼šMySQL 8.0 æ”¯æŒ hash joinï¼Œjoin_buffer ç»´æŠ¤çš„ä¸å†æ˜¯ä¸€ä¸ªæ— åºæ•°ç»„ï¼Œè€Œæ˜¯ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼ŒæŸ¥è¯¢æ•ˆç‡æ›´é«˜ï¼Œæ‰§è¡Œæ•ˆç‡æ¯”ä¸´æ—¶è¡¨æ›´é«˜ åµŒå¥—æŸ¥è¯¢æŸ¥è¯¢åˆ†ç±»æŸ¥è¯¢è¯­å¥ä¸­åµŒå¥—äº†æŸ¥è¯¢è¯­å¥ï¼Œå°†åµŒå¥—æŸ¥è¯¢ç§°ä¸ºå­æŸ¥è¯¢ï¼ŒFROM å­å¥åé¢çš„å­æŸ¥è¯¢çš„ç»“æœé›†ç§°ä¸ºæ´¾ç”Ÿè¡¨ æ ¹æ®ç»“æœåˆ†ç±»ï¼š ç»“æœæ˜¯å•è¡Œå•åˆ—ï¼šå¯ä»¥å°†æŸ¥è¯¢çš„ç»“æœä½œä¸ºå¦ä¸€æ¡è¯­å¥çš„æŸ¥è¯¢æ¡ä»¶ï¼Œä½¿ç”¨è¿ç®—ç¬¦åˆ¤æ–­ 1SELECT åˆ—å FROM è¡¨å WHERE åˆ—å=(SELECT åˆ—å/èšåˆå‡½æ•°(åˆ—å) FROM è¡¨å [WHERE æ¡ä»¶]); ç»“æœæ˜¯å¤šè¡Œå•åˆ—ï¼šå¯ä»¥ä½œä¸ºæ¡ä»¶ï¼Œä½¿ç”¨è¿ç®—ç¬¦ IN æˆ– NOT IN è¿›è¡Œåˆ¤æ–­ 1SELECT åˆ—å FROM è¡¨å WHERE åˆ—å [NOT] IN (SELECT åˆ—å FROM è¡¨å [WHERE æ¡ä»¶]); ç»“æœæ˜¯å¤šè¡Œå¤šåˆ—ï¼šæŸ¥è¯¢çš„ç»“æœå¯ä»¥ä½œä¸ºä¸€å¼ è™šæ‹Ÿè¡¨å‚ä¸æŸ¥è¯¢ 12345678910SELECT åˆ—å FROM è¡¨å [åˆ«å],(SELECT åˆ—å FROM è¡¨å [WHERE æ¡ä»¶]) [åˆ«å] [WHERE æ¡ä»¶];-- æŸ¥è¯¢è®¢å•è¡¨orderlistä¸­idå¤§äº4çš„è®¢å•ä¿¡æ¯å’Œæ‰€å±ç”¨æˆ·USERä¿¡æ¯SELECT * FROM USER u, (SELECT * FROM orderlist WHERE id&gt;4) o WHERE u.id=o.uid; ç›¸å…³æ€§åˆ†ç±»ï¼š ä¸ç›¸å…³å­æŸ¥è¯¢ï¼šå­æŸ¥è¯¢ä¸ä¾èµ–å¤–å±‚æŸ¥è¯¢çš„å€¼ï¼Œå¯ä»¥å•ç‹¬è¿è¡Œå‡ºç»“æœ ç›¸å…³å­æŸ¥è¯¢ï¼šå­æŸ¥è¯¢çš„æ‰§è¡Œéœ€è¦ä¾èµ–å¤–å±‚æŸ¥è¯¢çš„å€¼ æŸ¥è¯¢ä¼˜åŒ–ä¸ç›¸å…³å­æŸ¥è¯¢çš„ç»“æœé›†ä¼šè¢«å†™å…¥ä¸€ä¸ªä¸´æ—¶è¡¨ï¼Œå¹¶ä¸”åœ¨å†™å…¥æ—¶å»é‡ï¼Œè¯¥è¿‡ç¨‹ç§°ä¸ºç‰©åŒ–ï¼Œå­˜å‚¨ç»“æœé›†çš„ä¸´æ—¶è¡¨ç§°ä¸ºç‰©åŒ–è¡¨ ç³»ç»Ÿå˜é‡ tmp_table_size æˆ–è€… max_heap_table_size ä¸ºè¡¨çš„æœ€å€¼ å°äºç³»ç»Ÿå˜é‡æ—¶ï¼Œå†…å­˜ä¸­å¯ä»¥ä¿å­˜ï¼Œä¼šä¸ºå»ºç«‹åŸºäºå†…å­˜çš„ MEMORY å­˜å‚¨å¼•æ“çš„ä¸´æ—¶è¡¨ï¼Œå¹¶å»ºç«‹å“ˆå¸Œç´¢å¼• å¤§äºä»»æ„ä¸€ä¸ªç³»ç»Ÿå˜é‡æ—¶ï¼Œç‰©åŒ–è¡¨ä¼šä½¿ç”¨åŸºäºç£ç›˜çš„ InnoDB å­˜å‚¨å¼•æ“æ¥ä¿å­˜ç»“æœé›†ä¸­çš„è®°å½•ï¼Œç´¢å¼•ç±»å‹ä¸º B+ æ ‘ ç‰©åŒ–åï¼ŒåµŒå¥—æŸ¥è¯¢å°±ç›¸å½“äºå¤–å±‚æŸ¥è¯¢çš„è¡¨å’Œç‰©åŒ–è¡¨è¿›è¡Œå†…è¿æ¥æŸ¥è¯¢ï¼Œç„¶åç»è¿‡ä¼˜åŒ–å™¨é€‰æ‹©æˆæœ¬æœ€å°çš„è¡¨è¿æ¥é¡ºåºæ‰§è¡ŒæŸ¥è¯¢ å­æŸ¥è¯¢ç‰©åŒ–ä¼šäº§ç”Ÿå»ºç«‹ä¸´æ—¶è¡¨çš„æˆæœ¬ï¼Œä½†æ˜¯å°†å­æŸ¥è¯¢è½¬åŒ–ä¸ºè¿æ¥æŸ¥è¯¢å¯ä»¥å……åˆ†å‘æŒ¥ä¼˜åŒ–å™¨çš„ä½œç”¨ï¼Œæ‰€ä»¥å¼•å…¥ï¼šåŠè¿æ¥ t1 å’Œ t2 è¡¨è¿›è¡ŒåŠè¿æ¥ï¼Œå¯¹äº t1 è¡¨ä¸­çš„æŸæ¡è®°å½•ï¼Œåªéœ€è¦å…³å¿ƒåœ¨ t2 è¡¨ä¸­æ˜¯å¦å­˜åœ¨ï¼Œè€Œä¸éœ€è¦å…³å¿ƒæœ‰å¤šå°‘æ¡è®°å½•ä¸ä¹‹åŒ¹é…ï¼Œæœ€ç»ˆç»“æœé›†åªä¿ç•™ t1 çš„è®°å½• åŠè¿æ¥åªæ˜¯æ‰§è¡Œå­æŸ¥è¯¢çš„ä¸€ç§æ–¹å¼ï¼ŒMySQL å¹¶æ²¡æœ‰æä¾›é¢å‘ç”¨æˆ·çš„åŠè¿æ¥è¯­æ³• å‚è€ƒä¹¦ç±ï¼šhttps://book.douban.com/subject/35231266/ è”åˆæŸ¥è¯¢UNION æ˜¯å–è¿™ä¸¤ä¸ªå­æŸ¥è¯¢ç»“æœçš„å¹¶é›†ï¼Œå¹¶è¿›è¡Œå»é‡ï¼ŒåŒæ—¶è¿›è¡Œé»˜è®¤è§„åˆ™çš„æ’åºï¼ˆunion æ˜¯è¡ŒåŠ èµ·æ¥ï¼Œjoin æ˜¯åˆ—åŠ èµ·æ¥ï¼‰ UNION ALL æ˜¯å¯¹ä¸¤ä¸ªç»“æœé›†è¿›è¡Œå¹¶é›†æ“ä½œä¸è¿›è¡Œå»é‡ï¼Œä¸è¿›è¡Œæ’åº 1(select 1000 as f) union (select id from t1 order by id desc limit 2); #t1è¡¨ä¸­åŒ…å«id ä¸º 1-1000 çš„æ•°æ® è¯­å¥çš„æ‰§è¡Œæµç¨‹ï¼š åˆ›å»ºä¸€ä¸ªå†…å­˜ä¸´æ—¶è¡¨ï¼Œè¿™ä¸ªä¸´æ—¶è¡¨åªæœ‰ä¸€ä¸ªæ•´å‹å­—æ®µ fï¼Œå¹¶ä¸” f æ˜¯ä¸»é”®å­—æ®µ æ‰§è¡Œç¬¬ä¸€ä¸ªå­æŸ¥è¯¢ï¼Œå¾—åˆ° 1000 è¿™ä¸ªå€¼ï¼Œå¹¶å­˜å…¥ä¸´æ—¶è¡¨ä¸­ æ‰§è¡Œç¬¬äºŒä¸ªå­æŸ¥è¯¢ï¼Œæ‹¿åˆ°ç¬¬ä¸€è¡Œ id&#x3D;1000ï¼Œè¯•å›¾æ’å…¥ä¸´æ—¶è¡¨ä¸­ï¼Œä½†ç”±äº 1000 è¿™ä¸ªå€¼å·²ç»å­˜åœ¨äºä¸´æ—¶è¡¨äº†ï¼Œè¿åäº†å”¯ä¸€æ€§çº¦æŸï¼Œæ‰€ä»¥æ’å…¥å¤±è´¥ï¼Œç„¶åç»§ç»­æ‰§è¡Œ å–åˆ°ç¬¬äºŒè¡Œ id&#x3D;999ï¼Œæ’å…¥ä¸´æ—¶è¡¨æˆåŠŸ ä»ä¸´æ—¶è¡¨ä¸­æŒ‰è¡Œå–å‡ºæ•°æ®ï¼Œè¿”å›ç»“æœå¹¶åˆ é™¤ä¸´æ—¶è¡¨ï¼Œç»“æœä¸­åŒ…å«ä¸¤è¡Œæ•°æ®åˆ†åˆ«æ˜¯ 1000 å’Œ 999 æŸ¥è¯¢ç»ƒä¹ æ•°æ®å‡†å¤‡ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142-- åˆ›å»ºdb4æ•°æ®åº“CREATE DATABASE db4;-- ä½¿ç”¨db4æ•°æ®åº“USE db4;-- åˆ›å»ºuserè¡¨CREATE TABLE USER( id INT PRIMARY KEY AUTO_INCREMENT, -- ç”¨æˆ·id NAME VARCHAR(20), -- ç”¨æˆ·å§“å age INT -- ç”¨æˆ·å¹´é¾„);-- è®¢å•è¡¨CREATE TABLE orderlist( id INT PRIMARY KEY AUTO_INCREMENT, -- è®¢å•id number VARCHAR(30), -- è®¢å•ç¼–å· uid INT, -- å¤–é”®å­—æ®µ CONSTRAINT ou_fk1 FOREIGN KEY (uid) REFERENCES USER(id));-- å•†å“åˆ†ç±»è¡¨CREATE TABLE category( id INT PRIMARY KEY AUTO_INCREMENT, -- å•†å“åˆ†ç±»id NAME VARCHAR(10) -- å•†å“åˆ†ç±»åç§°);-- å•†å“è¡¨CREATE TABLE product( id INT PRIMARY KEY AUTO_INCREMENT, -- å•†å“id NAME VARCHAR(30), -- å•†å“åç§° cid INT, -- å¤–é”®å­—æ®µ CONSTRAINT cp_fk1 FOREIGN KEY (cid) REFERENCES category(id));-- ä¸­é—´è¡¨CREATE TABLE us_pro( upid INT PRIMARY KEY AUTO_INCREMENT, -- ä¸­é—´è¡¨id uid INT, -- å¤–é”®å­—æ®µã€‚éœ€è¦å’Œç”¨æˆ·è¡¨çš„ä¸»é”®äº§ç”Ÿå…³è” pid INT, -- å¤–é”®å­—æ®µã€‚éœ€è¦å’Œå•†å“è¡¨çš„ä¸»é”®äº§ç”Ÿå…³è” CONSTRAINT up_fk1 FOREIGN KEY (uid) REFERENCES USER(id), CONSTRAINT up_fk2 FOREIGN KEY (pid) REFERENCES product(id)); æ•°æ®æŸ¥è¯¢ï¼š æŸ¥è¯¢ç”¨æˆ·çš„ç¼–å·ã€å§“åã€å¹´é¾„ã€è®¢å•ç¼–å· æ•°æ®ï¼šç”¨æˆ·çš„ç¼–å·ã€å§“åã€å¹´é¾„åœ¨ user è¡¨ï¼Œè®¢å•ç¼–å·åœ¨ orderlist è¡¨ æ¡ä»¶ï¼šuser.id &#x3D; orderlist.uid 12345678SELECT u.*, o.numberFROM USER u, orderlist oWHERE u.id = o.uid; æŸ¥è¯¢æ‰€æœ‰çš„ç”¨æˆ·ï¼Œæ˜¾ç¤ºç”¨æˆ·çš„ç¼–å·ã€å§“åã€å¹´é¾„ã€è®¢å•ç¼–å·ã€‚ 123456789SELECT u.*, o.numberFROM USER uLEFT OUTER JOIN orderlist oON u.id = o.uid; æŸ¥è¯¢ç”¨æˆ·å¹´é¾„å¤§äº 23 å²çš„ä¿¡æ¯ï¼Œæ˜¾ç¤ºç”¨æˆ·çš„ç¼–å·ã€å§“åã€å¹´é¾„ã€è®¢å•ç¼–å· 12345678910SELECT u.*, o.numberFROM USER u, orderlist oWHERE u.id = o.uid AND u.age &gt; 23; 12345678SELECT u.*, o.numberFROM (SELECT * FROM USER WHERE age &gt; 23) u,-- åµŒå¥—æŸ¥è¯¢ orderlist oWHERE u.id = o.uid; æŸ¥è¯¢å¼ ä¸‰å’Œæå››ç”¨æˆ·çš„ä¿¡æ¯ï¼Œæ˜¾ç¤ºç”¨æˆ·çš„ç¼–å·ã€å§“åã€å¹´é¾„ã€è®¢å•ç¼–å·ã€‚ 12345678910SELECT u.*, o.numberFROM USER u, orderlist oWHERE u.id=o.uid AND u.name IN (&#x27;å¼ ä¸‰&#x27;,&#x27;æå››&#x27;); æŸ¥è¯¢æ‰€æœ‰çš„ç”¨æˆ·å’Œè¯¥ç”¨æˆ·èƒ½æŸ¥çœ‹çš„æ‰€æœ‰çš„å•†å“ï¼Œæ˜¾ç¤ºç”¨æˆ·çš„ç¼–å·ã€å§“åã€å¹´é¾„ã€å•†å“åç§° æ•°æ®ï¼šç”¨æˆ·çš„ç¼–å·ã€å§“åã€å¹´é¾„åœ¨ user è¡¨ï¼Œå•†å“åç§°åœ¨ product è¡¨ï¼Œä¸­é—´è¡¨ us_pro æ¡ä»¶ï¼šus_pro.uid &#x3D; user.id AND us_pro.pid &#x3D; product.id 12345678910111213SELECT u.id, u.name, u.age, p.nameFROM USER u, product p, us_pro upWHERE up.uid = u.id AND up.pid=p.id; æŸ¥è¯¢å¼ ä¸‰å’Œæå››è¿™ä¸¤ä¸ªç”¨æˆ·å¯ä»¥çœ‹åˆ°çš„å•†å“ï¼Œæ˜¾ç¤ºç”¨æˆ·çš„ç¼–å·ã€å§“åã€å¹´é¾„ã€å•†å“åç§°ã€‚ 123456789101112131415SELECT u.id, u.name, u.age, p.nameFROM USER u, product p, us_pro upWHERE up.uid=u.id AND up.pid=p.id AND u.name IN (&#x27;å¼ ä¸‰&#x27;,&#x27;æå››&#x27;); é«˜çº§ç»“æ„è§†å›¾åŸºæœ¬ä»‹ç»è§†å›¾æ¦‚å¿µï¼šè§†å›¾æ˜¯ä¸€ç§è™šæ‹Ÿå­˜åœ¨çš„æ•°æ®è¡¨ï¼Œè¿™ä¸ªè™šæ‹Ÿçš„è¡¨å¹¶ä¸åœ¨æ•°æ®åº“ä¸­å®é™…å­˜åœ¨ æœ¬è´¨ï¼šå°†ä¸€æ¡ SELECT æŸ¥è¯¢è¯­å¥çš„ç»“æœå°è£…åˆ°äº†ä¸€ä¸ªè™šæ‹Ÿè¡¨ä¸­ï¼Œæ‰€ä»¥åœ¨åˆ›å»ºè§†å›¾çš„æ—¶å€™ï¼Œå·¥ä½œé‡å¿ƒè¦æ”¾åœ¨è¿™æ¡ SELECT æŸ¥è¯¢è¯­å¥ä¸Š ä½œç”¨ï¼šå°†ä¸€äº›æ¯”è¾ƒå¤æ‚çš„æŸ¥è¯¢è¯­å¥çš„ç»“æœï¼Œå°è£…åˆ°ä¸€ä¸ªè™šæ‹Ÿè¡¨ä¸­ï¼Œå†æœ‰ç›¸åŒæŸ¥è¯¢éœ€æ±‚æ—¶ï¼Œç›´æ¥æŸ¥è¯¢è¯¥è™šæ‹Ÿè¡¨ ä¼˜ç‚¹ï¼š ç®€å•ï¼šä½¿ç”¨è§†å›¾çš„ç”¨æˆ·ä¸éœ€è¦å…³å¿ƒè¡¨çš„ç»“æ„ã€å…³è”æ¡ä»¶å’Œç­›é€‰æ¡ä»¶ï¼Œå› ä¸ºè™šæ‹Ÿè¡¨ä¸­å·²ç»æ˜¯è¿‡æ»¤å¥½çš„ç»“æœé›† å®‰å…¨ï¼šä½¿ç”¨è§†å›¾çš„ç”¨æˆ·åªèƒ½è®¿é—®æŸ¥è¯¢çš„ç»“æœé›†ï¼Œå¯¹è¡¨çš„æƒé™ç®¡ç†å¹¶ä¸èƒ½é™åˆ¶åˆ°æŸä¸ªè¡ŒæŸä¸ªåˆ— æ•°æ®ç‹¬ç«‹ï¼Œä¸€æ—¦è§†å›¾çš„ç»“æ„ç¡®å®šï¼Œå¯ä»¥å±è”½è¡¨ç»“æ„å˜åŒ–å¯¹ç”¨æˆ·çš„å½±å“ï¼Œæºè¡¨å¢åŠ åˆ—å¯¹è§†å›¾æ²¡æœ‰å½±å“ï¼›æºè¡¨ä¿®æ”¹åˆ—åï¼Œåˆ™å¯ä»¥é€šè¿‡ä¿®æ”¹è§†å›¾æ¥è§£å†³ï¼Œä¸ä¼šé€ æˆå¯¹è®¿é—®è€…çš„å½±å“ è§†å›¾åˆ›å»º åˆ›å»ºè§†å›¾ 1234CREATE [OR REPLACE] VIEW è§†å›¾åç§° [(åˆ—ååˆ—è¡¨)] AS æŸ¥è¯¢è¯­å¥[WITH [CASCADED | LOCAL] CHECK OPTION]; WITH [CASCADED | LOCAL] CHECK OPTION å†³å®šäº†æ˜¯å¦å…è®¸æ›´æ–°æ•°æ®ä½¿è®°å½•ä¸å†æ»¡è¶³è§†å›¾çš„æ¡ä»¶ï¼š LOCALï¼šåªè¦æ»¡è¶³æœ¬è§†å›¾çš„æ¡ä»¶å°±å¯ä»¥æ›´æ–° CASCADEDï¼šå¿…é¡»æ»¡è¶³æ‰€æœ‰é’ˆå¯¹è¯¥è§†å›¾çš„æ‰€æœ‰è§†å›¾çš„æ¡ä»¶æ‰å¯ä»¥æ›´æ–°ï¼Œ é»˜è®¤å€¼ ä¾‹å¦‚ 123456789101112131415161718192021222324252627-- æ•°æ®å‡†å¤‡ cityid NAME cid1 æ·±åœ³ 12 ä¸Šæµ· 13 çº½çº¦ 24 è«æ–¯ç§‘ 3-- æ•°æ®å‡†å¤‡ countryid NAME1 ä¸­å›½2 ç¾å›½3 ä¿„ç½—æ–¯-- åˆ›å»ºcity_countryè§†å›¾ï¼Œä¿å­˜åŸå¸‚å’Œå›½å®¶çš„ä¿¡æ¯(ä½¿ç”¨æŒ‡å®šåˆ—å)CREATE VIEW city_country (city_id,city_name,country_name)AS SELECT c1.id, c1.name, c2.name FROM city c1, country c2 WHERE c1.cid=c2.id; è§†å›¾æŸ¥è¯¢ æŸ¥è¯¢æ‰€æœ‰æ•°æ®è¡¨ï¼Œè§†å›¾ä¹Ÿä¼šæŸ¥è¯¢å‡ºæ¥ 12SHOW TABLES;SHOW TABLE STATUS [\\G]; æŸ¥è¯¢è§†å›¾ 1SELECT * FROM è§†å›¾åç§°; æŸ¥è¯¢æŸä¸ªè§†å›¾åˆ›å»º 1SHOW CREATE VIEW è§†å›¾åç§°; è§†å›¾ä¿®æ”¹è§†å›¾è¡¨æ•°æ®ä¿®æ”¹ï¼Œä¼šè‡ªåŠ¨ä¿®æ”¹æºè¡¨ä¸­çš„æ•°æ®ï¼Œå› ä¸ºæ›´æ–°çš„æ˜¯è§†å›¾ä¸­çš„åŸºè¡¨ä¸­çš„æ•°æ® ä¿®æ”¹è§†å›¾è¡¨ä¸­çš„æ•°æ® 1UPDATE è§†å›¾åç§° SET åˆ—å = å€¼ WHERE æ¡ä»¶; ä¿®æ”¹è§†å›¾çš„ç»“æ„ 12345678910111213141516171819ALTER [ALGORITHM = &#123;UNDEFINED | MERGE | TEMPTABLE&#125;]VIEW è§†å›¾åç§° [(åˆ—ååˆ—è¡¨)] AS æŸ¥è¯¢è¯­å¥[WITH [CASCADED | LOCAL] CHECK OPTION]-- å°†è§†å›¾ä¸­çš„country_nameä¿®æ”¹ä¸ºnameALTER VIEW city_country (city_id,city_name,name) AS SELECT c1.id, c1.name, c2.name FROM city c1, country c2 WHERE c1.cid=c2.id; è§†å›¾åˆ é™¤ åˆ é™¤è§†å›¾ 1DROP VIEW è§†å›¾åç§°; å¦‚æœå­˜åœ¨åˆ™åˆ é™¤ 1DROP VIEW IF EXISTS è§†å›¾åç§°; å­˜å‚¨è¿‡ç¨‹åŸºæœ¬ä»‹ç»å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°ï¼šå­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°æ˜¯äº‹å…ˆç»è¿‡ç¼–è¯‘å¹¶å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„ä¸€æ®µ SQL è¯­å¥çš„é›†åˆ å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°çš„å¥½å¤„ï¼š æé«˜ä»£ç çš„å¤ç”¨æ€§ å‡å°‘æ•°æ®åœ¨æ•°æ®åº“å’Œåº”ç”¨æœåŠ¡å™¨ä¹‹é—´çš„ä¼ è¾“ï¼Œæé«˜ä¼ è¾“æ•ˆç‡ å‡å°‘ä»£ç å±‚é¢çš„ä¸šåŠ¡å¤„ç† ä¸€æ¬¡ç¼–è¯‘æ°¸ä¹…æœ‰æ•ˆ å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°çš„åŒºåˆ«ï¼š å­˜å‚¨å‡½æ•°å¿…é¡»æœ‰è¿”å›å€¼ å­˜å‚¨è¿‡ç¨‹å¯ä»¥æ²¡æœ‰è¿”å›å€¼ åŸºæœ¬æ“ä½œDELIMITERï¼š DELIMITER å…³é”®å­—ç”¨æ¥å£°æ˜ sql è¯­å¥çš„åˆ†éš”ç¬¦ï¼Œå‘Šè¯‰ MySQL è¯¥æ®µå‘½ä»¤å·²ç»ç»“æŸ MySQL è¯­å¥é»˜è®¤çš„åˆ†éš”ç¬¦æ˜¯åˆ†å·ï¼Œä½†æ˜¯æœ‰æ—¶éœ€è¦ä¸€æ¡åŠŸèƒ½ sql è¯­å¥ä¸­åŒ…å«åˆ†å·ï¼Œä½†æ˜¯å¹¶ä¸ä½œä¸ºç»“æŸæ ‡è¯†ï¼Œè¿™æ—¶ä½¿ç”¨ DELIMITER æ¥æŒ‡å®šåˆ†éš”ç¬¦ï¼š 1DELIMITER åˆ†éš”ç¬¦ å­˜å‚¨è¿‡ç¨‹çš„åˆ›å»ºè°ƒç”¨æŸ¥çœ‹å’Œåˆ é™¤ï¼š åˆ›å»ºå­˜å‚¨è¿‡ç¨‹ 1234567891011-- ä¿®æ”¹åˆ†éš”ç¬¦ä¸º$DELIMITER $-- æ ‡å‡†è¯­æ³•CREATE PROCEDURE å­˜å‚¨è¿‡ç¨‹åç§°(å‚æ•°...)BEGIN sqlè¯­å¥;END$-- ä¿®æ”¹åˆ†éš”ç¬¦ä¸ºåˆ†å·DELIMITER ; è°ƒç”¨å­˜å‚¨è¿‡ç¨‹ 1CALL å­˜å‚¨è¿‡ç¨‹åç§°(å®é™…å‚æ•°); æŸ¥çœ‹å­˜å‚¨è¿‡ç¨‹ 1SELECT * FROM mysql.proc WHERE db=&#x27;æ•°æ®åº“åç§°&#x27;; åˆ é™¤å­˜å‚¨è¿‡ç¨‹ 1DROP PROCEDURE [IF EXISTS] å­˜å‚¨è¿‡ç¨‹åç§°; ç»ƒä¹ ï¼š æ•°æ®å‡†å¤‡ 12345id NAME age gender score1 å¼ ä¸‰ 23 ç”· 952 æå›› 24 ç”· 983 ç‹äº” 25 å¥³ 1004 èµµå…­ 26 å¥³ 90 åˆ›å»º stu_group() å­˜å‚¨è¿‡ç¨‹ï¼Œå°è£…åˆ†ç»„æŸ¥è¯¢æ€»æˆç»©ï¼Œå¹¶æŒ‰ç…§æ€»æˆç»©å‡åºæ’åºçš„åŠŸèƒ½ 12345678910111213DELIMITER $CREATE PROCEDURE stu_group()BEGIN SELECT gender,SUM(score) getSum FROM student GROUP BY gender ORDER BY getSum ASC; END$DELIMITER ;-- è°ƒç”¨å­˜å‚¨è¿‡ç¨‹CALL stu_group();-- åˆ é™¤å­˜å‚¨è¿‡ç¨‹DROP PROCEDURE IF EXISTS stu_group; å­˜å‚¨è¯­æ³•å˜é‡ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹æ˜¯å¯ä»¥è¿›è¡Œç¼–ç¨‹çš„ï¼Œæ„å‘³ç€å¯ä»¥ä½¿ç”¨å˜é‡ã€è¡¨è¾¾å¼ã€æ¡ä»¶æ§åˆ¶è¯­å¥ç­‰ï¼Œæ¥å®Œæˆæ¯”è¾ƒå¤æ‚çš„åŠŸèƒ½ å®šä¹‰å˜é‡ï¼šDECLARE å®šä¹‰çš„æ˜¯å±€éƒ¨å˜é‡ï¼Œåªèƒ½ç”¨åœ¨ BEGIN END èŒƒå›´ä¹‹å†… 1DECLARE å˜é‡å æ•°æ®ç±»å‹ [DEFAULT é»˜è®¤å€¼]; å˜é‡çš„èµ‹å€¼ 12SET å˜é‡å = å˜é‡å€¼;SELECT åˆ—å INTO å˜é‡å FROM è¡¨å [WHERE æ¡ä»¶]; æ•°æ®å‡†å¤‡ï¼šè¡¨ student 12345id NAME age gender score1 å¼ ä¸‰ 23 ç”· 952 æå›› 24 ç”· 983 ç‹äº” 25 å¥³ 1004 èµµå…­ 26 å¥³ 90 å®šä¹‰ä¸¤ä¸ª int å˜é‡ï¼Œç”¨äºå­˜å‚¨ç”·å¥³åŒå­¦çš„æ€»åˆ†æ•° 123456789101112131415DELIMITER $CREATE PROCEDURE pro_test3()BEGIN -- å®šä¹‰ä¸¤ä¸ªå˜é‡ DECLARE men,women INT; -- æŸ¥è¯¢ç”·åŒå­¦çš„æ€»åˆ†æ•°ï¼Œä¸ºmenèµ‹å€¼ SELECT SUM(score) INTO men FROM student WHERE gender=&#x27;ç”·&#x27;; -- æŸ¥è¯¢å¥³åŒå­¦çš„æ€»åˆ†æ•°ï¼Œä¸ºwomenèµ‹å€¼ SELECT SUM(score) INTO women FROM student WHERE gender=&#x27;å¥³&#x27;; -- ä½¿ç”¨å˜é‡ SELECT men,women;END$DELIMITER ;-- è°ƒç”¨å­˜å‚¨è¿‡ç¨‹CALL pro_test3(); IFè¯­å¥ if è¯­å¥æ ‡å‡†è¯­æ³• 12345IF åˆ¤æ–­æ¡ä»¶1 THEN æ‰§è¡Œçš„sqlè¯­å¥1;[ELSEIF åˆ¤æ–­æ¡ä»¶2 THEN æ‰§è¡Œçš„sqlè¯­å¥2;]...[ELSE æ‰§è¡Œçš„sqlè¯­å¥n;]END IF; æ•°æ®å‡†å¤‡ï¼šè¡¨ student 12345id NAME age gender score1 å¼ ä¸‰ 23 ç”· 952 æå›› 24 ç”· 983 ç‹äº” 25 å¥³ 1004 èµµå…­ 26 å¥³ 90 æ ¹æ®æ€»æˆç»©åˆ¤æ–­ï¼šå…¨ç­ 380 åˆ†åŠä»¥ä¸Šå­¦ä¹ ä¼˜ç§€ã€320 ~ 380 å­¦ä¹ è‰¯å¥½ã€320 ä»¥ä¸‹å­¦ä¹ ä¸€èˆ¬ 123456789101112131415161718DELIMITER $CREATE PROCEDURE pro_test4()BEGIN DECLARE total INT; -- å®šä¹‰æ€»åˆ†æ•°å˜é‡ DECLARE description VARCHAR(10); -- å®šä¹‰åˆ†æ•°æè¿°å˜é‡ SELECT SUM(score) INTO total FROM student; -- ä¸ºæ€»åˆ†æ•°å˜é‡èµ‹å€¼ -- åˆ¤æ–­æ€»åˆ†æ•° IF total &gt;= 380 THEN SET description = &#x27;å­¦ä¹ ä¼˜ç§€&#x27;; ELSEIF total &gt;=320 AND total &lt; 380 THEN SET description = &#x27;å­¦ä¹ è‰¯å¥½&#x27;; ELSE SET description = &#x27;å­¦ä¹ ä¸€èˆ¬&#x27;; END IF;END$DELIMITER ;-- è°ƒç”¨pro_test4å­˜å‚¨è¿‡ç¨‹CALL pro_test4(); å‚æ•°ä¼ é€’ å‚æ•°ä¼ é€’çš„è¯­æ³• INï¼šä»£è¡¨è¾“å…¥å‚æ•°ï¼Œéœ€è¦ç”±è°ƒç”¨è€…ä¼ é€’å®é™…æ•°æ®ï¼Œé»˜è®¤çš„OUTï¼šä»£è¡¨è¾“å‡ºå‚æ•°ï¼Œè¯¥å‚æ•°å¯ä»¥ä½œä¸ºè¿”å›å€¼INOUTï¼šä»£è¡¨æ—¢å¯ä»¥ä½œä¸ºè¾“å…¥å‚æ•°ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºè¾“å‡ºå‚æ•° 123456789DELIMITER $-- æ ‡å‡†è¯­æ³•CREATE PROCEDURE å­˜å‚¨è¿‡ç¨‹åç§°([IN|OUT|INOUT] å‚æ•°å æ•°æ®ç±»å‹)BEGIN æ‰§è¡Œçš„sqlè¯­å¥;END$DELIMITER ; è¾“å…¥æ€»æˆç»©å˜é‡ï¼Œä»£è¡¨å­¦ç”Ÿæ€»æˆç»©ï¼Œè¾“å‡ºåˆ†æ•°æè¿°å˜é‡ï¼Œä»£è¡¨å­¦ç”Ÿæ€»æˆç»©çš„æè¿° 1234567891011121314151617181920DELIMITER $CREATE PROCEDURE pro_test6(IN total INT, OUT description VARCHAR(10))BEGIN -- åˆ¤æ–­æ€»åˆ†æ•° IF total &gt;= 380 THEN SET description = &#x27;å­¦ä¹ ä¼˜ç§€&#x27;; ELSEIF total &gt;= 320 AND total &lt; 380 THEN SET description = &#x27;å­¦ä¹ ä¸é”™&#x27;; ELSE SET description = &#x27;å­¦ä¹ ä¸€èˆ¬&#x27;; END IF;END$DELIMITER ;-- è°ƒç”¨pro_test6å­˜å‚¨è¿‡ç¨‹CALL pro_test6(310,@description);CALL pro_test6((SELECT SUM(score) FROM student), @description);-- æŸ¥è¯¢æ€»æˆç»©æè¿°SELECT @description; æŸ¥çœ‹å‚æ•°æ–¹æ³• @å˜é‡å : ç”¨æˆ·ä¼šè¯å˜é‡ï¼Œä»£è¡¨æ•´ä¸ªä¼šè¯è¿‡ç¨‹ä»–éƒ½æ˜¯æœ‰ä½œç”¨çš„ï¼Œç±»ä¼¼äºå…¨å±€å˜é‡ @@å˜é‡å : ç³»ç»Ÿå˜é‡ CASE æ ‡å‡†è¯­æ³• 1 123456CASE è¡¨è¾¾å¼ WHEN å€¼1 THEN æ‰§è¡Œsqlè¯­å¥1; [WHEN å€¼2 THEN æ‰§è¡Œsqlè¯­å¥2;] ... [ELSE æ‰§è¡Œsqlè¯­å¥n;]END CASE; æ ‡å‡†è¯­æ³• 2 123456sCASE WHEN åˆ¤æ–­æ¡ä»¶1 THEN æ‰§è¡Œsqlè¯­å¥1; [WHEN åˆ¤æ–­æ¡ä»¶2 THEN æ‰§è¡Œsqlè¯­å¥2;] ... [ELSE æ‰§è¡Œsqlè¯­å¥n;]END CASE; æ¼”ç¤º 12345678910111213141516171819202122DELIMITER $CREATE PROCEDURE pro_test7(IN total INT)BEGIN -- å®šä¹‰å˜é‡ DECLARE description VARCHAR(10); -- ä½¿ç”¨caseåˆ¤æ–­ CASE WHEN total &gt;= 380 THEN SET description = &#x27;å­¦ä¹ ä¼˜ç§€&#x27;; WHEN total &gt;= 320 AND total &lt; 380 THEN SET description = &#x27;å­¦ä¹ ä¸é”™&#x27;; ELSE SET description = &#x27;å­¦ä¹ ä¸€èˆ¬&#x27;; END CASE; -- æŸ¥è¯¢åˆ†æ•°æè¿°ä¿¡æ¯ SELECT description;END$DELIMITER ;-- è°ƒç”¨pro_test7å­˜å‚¨è¿‡ç¨‹CALL pro_test7(390);CALL pro_test7((SELECT SUM(score) FROM student)); WHILE while å¾ªç¯è¯­æ³• 1234WHILE æ¡ä»¶åˆ¤æ–­è¯­å¥ DO å¾ªç¯ä½“è¯­å¥; æ¡ä»¶æ§åˆ¶è¯­å¥;END WHILE; è®¡ç®— 1~100 ä¹‹é—´çš„å¶æ•°å’Œ 123456789101112131415161718192021DELIMITER $CREATE PROCEDURE pro_test6()BEGIN -- å®šä¹‰æ±‚å’Œå˜é‡ DECLARE result INT DEFAULT 0; -- å®šä¹‰åˆå§‹åŒ–å˜é‡ DECLARE num INT DEFAULT 1; -- whileå¾ªç¯ WHILE num &lt;= 100 DO IF num % 2 = 0 THEN SET result = result + num; END IF; SET num = num + 1; END WHILE; -- æŸ¥è¯¢æ±‚å’Œç»“æœ SELECT result;END$DELIMITER ;-- è°ƒç”¨pro_test6å­˜å‚¨è¿‡ç¨‹CALL pro_test6(); REPEAT repeat å¾ªç¯æ ‡å‡†è¯­æ³• 123456åˆå§‹åŒ–è¯­å¥;REPEAT å¾ªç¯ä½“è¯­å¥; æ¡ä»¶æ§åˆ¶è¯­å¥; UNTIL æ¡ä»¶åˆ¤æ–­è¯­å¥END REPEAT; è®¡ç®— 1~10 ä¹‹é—´çš„å’Œ 1234567891011121314151617181920212223DELIMITER $CREATE PROCEDURE pro_test9()BEGIN -- å®šä¹‰æ±‚å’Œå˜é‡ DECLARE result INT DEFAULT 0; -- å®šä¹‰åˆå§‹åŒ–å˜é‡ DECLARE num INT DEFAULT 1; -- repeatå¾ªç¯ REPEAT -- ç´¯åŠ  SET result = result + num; -- è®©num+1 SET num = num + 1; -- åœæ­¢å¾ªç¯ UNTIL num &gt; 10 END REPEAT; -- æŸ¥è¯¢æ±‚å’Œç»“æœ SELECT result;END$DELIMITER ;-- è°ƒç”¨pro_test9å­˜å‚¨è¿‡ç¨‹CALL pro_test9(); LOOPLOOP å®ç°ç®€å•çš„å¾ªç¯ï¼Œé€€å‡ºå¾ªç¯çš„æ¡ä»¶éœ€è¦ä½¿ç”¨å…¶ä»–çš„è¯­å¥å®šä¹‰ï¼Œé€šå¸¸å¯ä»¥ä½¿ç”¨ LEAVE è¯­å¥å®ç°ï¼Œå¦‚æœä¸åŠ é€€å‡ºå¾ªç¯çš„è¯­å¥ï¼Œé‚£ä¹ˆå°±å˜æˆäº†æ­»å¾ªç¯ loop å¾ªç¯æ ‡å‡†è¯­æ³• 123456[å¾ªç¯åç§°:] LOOP æ¡ä»¶åˆ¤æ–­è¯­å¥ [LEAVE å¾ªç¯åç§°;] å¾ªç¯ä½“è¯­å¥; æ¡ä»¶æ§åˆ¶è¯­å¥;END LOOP å¾ªç¯åç§°; è®¡ç®— 1~10 ä¹‹é—´çš„å’Œ 123456789101112131415161718192021222324DELIMITER $CREATE PROCEDURE pro_test10()BEGIN -- å®šä¹‰æ±‚å’Œå˜é‡ DECLARE result INT DEFAULT 0; -- å®šä¹‰åˆå§‹åŒ–å˜é‡ DECLARE num INT DEFAULT 1; -- loopå¾ªç¯ l:LOOP -- æ¡ä»¶æˆç«‹ï¼Œåœæ­¢å¾ªç¯ IF num &gt; 10 THEN LEAVE l; END IF; -- ç´¯åŠ  SET result = result + num; -- è®©num+1 SET num = num + 1; END LOOP l; -- æŸ¥è¯¢æ±‚å’Œç»“æœ SELECT result;END$DELIMITER ;-- è°ƒç”¨pro_test10å­˜å‚¨è¿‡ç¨‹CALL pro_test10(); æ¸¸æ ‡æ¸¸æ ‡æ˜¯ç”¨æ¥å­˜å‚¨æŸ¥è¯¢ç»“æœé›†çš„æ•°æ®ç±»å‹ï¼Œåœ¨å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°ä¸­å¯ä»¥ä½¿ç”¨å…‰æ ‡å¯¹ç»“æœé›†è¿›è¡Œå¾ªç¯çš„å¤„ç† æ¸¸æ ‡å¯ä»¥éå†è¿”å›çš„å¤šè¡Œç»“æœï¼Œæ¯æ¬¡æ‹¿åˆ°ä¸€æ•´è¡Œæ•°æ® ç®€å•æ¥è¯´æ¸¸æ ‡å°±ç±»ä¼¼äºé›†åˆçš„è¿­ä»£å™¨éå† MySQL ä¸­çš„æ¸¸æ ‡åªèƒ½ç”¨åœ¨å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°ä¸­ æ¸¸æ ‡çš„è¯­æ³• åˆ›å»ºæ¸¸æ ‡ 1DECLARE æ¸¸æ ‡åç§° CURSOR FOR æŸ¥è¯¢sqlè¯­å¥; æ‰“å¼€æ¸¸æ ‡ 1OPEN æ¸¸æ ‡åç§°; ä½¿ç”¨æ¸¸æ ‡è·å–æ•°æ® 1FETCH æ¸¸æ ‡åç§° INTO å˜é‡å1,å˜é‡å2,...; å…³é—­æ¸¸æ ‡ 1CLOSE æ¸¸æ ‡åç§°; Mysql é€šè¿‡ä¸€ä¸ª Error handler å£°æ˜æ¥åˆ¤æ–­æŒ‡é’ˆæ˜¯å¦åˆ°å°¾éƒ¨ï¼Œå¹¶ä¸”å¿…é¡»å’Œåˆ›å»ºæ¸¸æ ‡çš„ SQL è¯­å¥å£°æ˜åœ¨ä¸€èµ·ï¼š 1DECLARE EXIT HANDLER FOR NOT FOUND (do some actionï¼Œä¸€èˆ¬æ˜¯è®¾ç½®æ ‡å¿—å˜é‡) æ¸¸æ ‡çš„åŸºæœ¬ä½¿ç”¨ æ•°æ®å‡†å¤‡ï¼šè¡¨ student 12345id NAME age gender score1 å¼ ä¸‰ 23 ç”· 952 æå›› 24 ç”· 983 ç‹äº” 25 å¥³ 1004 èµµå…­ 26 å¥³ 90 åˆ›å»º stu_score è¡¨ 1234CREATE TABLE stu_score( id INT PRIMARY KEY AUTO_INCREMENT, score INT); å°†studentè¡¨ä¸­æ‰€æœ‰çš„æˆç»©ä¿å­˜åˆ°stu_scoreè¡¨ä¸­ 12345678910111213141516171819202122232425262728293031323334DELIMITER $CREATE PROCEDURE pro_test12()BEGIN -- å®šä¹‰æˆç»©å˜é‡ DECLARE s_score INT; -- å®šä¹‰æ ‡è®°å˜é‡ DECLARE flag INT DEFAULT 0; -- åˆ›å»ºæ¸¸æ ‡ï¼ŒæŸ¥è¯¢æ‰€æœ‰å­¦ç”Ÿæˆç»©æ•°æ® DECLARE stu_result CURSOR FOR SELECT score FROM student; -- æ¸¸æ ‡ç»“æŸåï¼Œå°†æ ‡è®°å˜é‡æ”¹ä¸º1 è¿™ä¸¤ä¸ªå¿…é¡»å£°æ˜åœ¨ä¸€èµ· DECLARE EXIT HANDLER FOR NOT FOUND SET flag = 1; -- å¼€å¯æ¸¸æ ‡ OPEN stu_result; -- å¾ªç¯ä½¿ç”¨æ¸¸æ ‡ REPEAT -- ä½¿ç”¨æ¸¸æ ‡ï¼Œéå†ç»“æœ,æ‹¿åˆ°æ•°æ® FETCH stu_result INTO s_score; -- å°†æ•°æ®ä¿å­˜åˆ°stu_scoreè¡¨ä¸­ INSERT INTO stu_score VALUES (NULL,s_score); UNTIL flag=1 END REPEAT; -- å…³é—­æ¸¸æ ‡ CLOSE stu_result;END$DELIMITER ;-- è°ƒç”¨pro_test12å­˜å‚¨è¿‡ç¨‹CALL pro_test12();-- æŸ¥è¯¢stu_scoreè¡¨SELECT * FROM stu_score; å­˜å‚¨å‡½æ•°å­˜å‚¨å‡½æ•°å’Œå­˜å‚¨è¿‡ç¨‹æ˜¯éå¸¸ç›¸ä¼¼çš„ï¼Œå­˜å‚¨å‡½æ•°å¯ä»¥åšçš„äº‹æƒ…ï¼Œå­˜å‚¨è¿‡ç¨‹ä¹Ÿå¯ä»¥åšåˆ° å­˜å‚¨å‡½æ•°æœ‰è¿”å›å€¼ï¼Œå­˜å‚¨è¿‡ç¨‹æ²¡æœ‰è¿”å›å€¼ï¼ˆå‚æ•°çš„ out å…¶å®ä¹Ÿç›¸å½“äºæ˜¯è¿”å›æ•°æ®äº†ï¼‰ åˆ›å»ºå­˜å‚¨å‡½æ•° 12345678910DELIMITER $-- æ ‡å‡†è¯­æ³•CREATE FUNCTION å‡½æ•°åç§°(å‚æ•° æ•°æ®ç±»å‹)RETURNS è¿”å›å€¼ç±»å‹BEGIN æ‰§è¡Œçš„sqlè¯­å¥; RETURN ç»“æœ;END$DELIMITER ; è°ƒç”¨å­˜å‚¨å‡½æ•°ï¼Œå› ä¸ºæœ‰è¿”å›å€¼ï¼Œæ‰€ä»¥ä½¿ç”¨ SELECT è°ƒç”¨ 1SELECT å‡½æ•°åç§°(å®é™…å‚æ•°); åˆ é™¤å­˜å‚¨å‡½æ•° 1DROP FUNCTION å‡½æ•°åç§°; å®šä¹‰å­˜å‚¨å‡½æ•°ï¼Œè·å–å­¦ç”Ÿè¡¨ä¸­æˆç»©å¤§äº95åˆ†çš„å­¦ç”Ÿæ•°é‡ 1234567891011121314DELIMITER $CREATE FUNCTION fun_test()RETURN INTBEGIN -- å®šä¹‰ç»Ÿè®¡å˜é‡ DECLARE result INT; -- æŸ¥è¯¢æˆç»©å¤§äº95åˆ†çš„å­¦ç”Ÿæ•°é‡ï¼Œç»™ç»Ÿè®¡å˜é‡èµ‹å€¼ SELECT COUNT(score) INTO result FROM student WHERE score &gt; 95; -- è¿”å›ç»Ÿè®¡ç»“æœ SELECT result;ENDDELIMITER ;-- è°ƒç”¨fun_testå­˜å‚¨å‡½æ•°SELECT fun_test(); è§¦å‘å™¨åŸºæœ¬ä»‹ç»è§¦å‘å™¨æ˜¯ä¸è¡¨æœ‰å…³çš„æ•°æ®åº“å¯¹è±¡ï¼Œåœ¨ insert&#x2F;update&#x2F;delete ä¹‹å‰æˆ–ä¹‹åè§¦å‘å¹¶æ‰§è¡Œè§¦å‘å™¨ä¸­å®šä¹‰çš„ SQL è¯­å¥ è§¦å‘å™¨çš„è¿™ç§ç‰¹æ€§å¯ä»¥ååŠ©åº”ç”¨åœ¨æ•°æ®åº“ç«¯ç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§ ã€æ—¥å¿—è®°å½• ã€æ•°æ®æ ¡éªŒç­‰æ“ä½œ ä½¿ç”¨åˆ«å NEW å’Œ OLD æ¥å¼•ç”¨è§¦å‘å™¨ä¸­å‘ç”Ÿå˜åŒ–çš„è®°å½•å†…å®¹ï¼Œè¿™ä¸å…¶ä»–çš„æ•°æ®åº“æ˜¯ç›¸ä¼¼çš„ ç°åœ¨è§¦å‘å™¨è¿˜åªæ”¯æŒè¡Œçº§è§¦å‘ï¼Œä¸æ”¯æŒè¯­å¥çº§è§¦å‘ è§¦å‘å™¨ç±»å‹ OLDçš„å«ä¹‰ NEWçš„å«ä¹‰ INSERT å‹è§¦å‘å™¨ æ—  (å› ä¸ºæ’å…¥å‰çŠ¶æ€æ— æ•°æ®) NEW è¡¨ç¤ºå°†è¦æˆ–è€…å·²ç»æ–°å¢çš„æ•°æ® UPDATE å‹è§¦å‘å™¨ OLD è¡¨ç¤ºä¿®æ”¹ä¹‹å‰çš„æ•°æ® NEW è¡¨ç¤ºå°†è¦æˆ–å·²ç»ä¿®æ”¹åçš„æ•°æ® DELETE å‹è§¦å‘å™¨ OLD è¡¨ç¤ºå°†è¦æˆ–è€…å·²ç»åˆ é™¤çš„æ•°æ® æ—  (å› ä¸ºåˆ é™¤åçŠ¶æ€æ— æ•°æ®) åŸºæœ¬æ“ä½œ åˆ›å»ºè§¦å‘å™¨ 1234567891011DELIMITER $CREATE TRIGGER è§¦å‘å™¨åç§°BEFORE|AFTER INSERT|UPDATE|DELETEON è¡¨å[FOR EACH ROW] -- è¡Œçº§è§¦å‘å™¨BEGIN è§¦å‘å™¨è¦æ‰§è¡Œçš„åŠŸèƒ½;END$DELIMITER ; æŸ¥çœ‹è§¦å‘å™¨çš„çŠ¶æ€ã€è¯­æ³•ç­‰ä¿¡æ¯ 1SHOW TRIGGERS; åˆ é™¤è§¦å‘å™¨ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®š schema_nameï¼Œé»˜è®¤ä¸ºå½“å‰æ•°æ®åº“ 1DROP TRIGGER [schema_name.]trigger_name; è§¦å‘æ¼”ç¤ºé€šè¿‡è§¦å‘å™¨è®°å½•è´¦æˆ·è¡¨çš„æ•°æ®å˜æ›´æ—¥å¿—ã€‚åŒ…å«ï¼šå¢åŠ ã€ä¿®æ”¹ã€åˆ é™¤ æ•°æ®å‡†å¤‡ 1234-- åˆ›å»ºdb9æ•°æ®åº“CREATE DATABASE db9;-- ä½¿ç”¨db9æ•°æ®åº“USE db9; 12345678-- åˆ›å»ºè´¦æˆ·è¡¨accountCREATE TABLE account( id INT PRIMARY KEY AUTO_INCREMENT, -- è´¦æˆ·id NAME VARCHAR(20), -- å§“å money DOUBLE -- ä½™é¢);-- æ·»åŠ æ•°æ®INSERT INTO account VALUES (NULL,&#x27;å¼ ä¸‰&#x27;,1000),(NULL,&#x27;æå››&#x27;,2000); 12345678-- åˆ›å»ºæ—¥å¿—è¡¨account_logCREATE TABLE account_log( id INT PRIMARY KEY AUTO_INCREMENT, -- æ—¥å¿—id operation VARCHAR(20), -- æ“ä½œç±»å‹ (insert update delete) operation_time DATETIME, -- æ“ä½œæ—¶é—´ operation_id INT, -- æ“ä½œè¡¨çš„id operation_params VARCHAR(200) -- æ“ä½œå‚æ•°); åˆ›å»º INSERT å‹è§¦å‘å™¨ 1234567891011DELIMITER $CREATE TRIGGER account_insertAFTER INSERTON accountFOR EACH ROWBEGIN INSERT INTO account_log VALUES (NULL,&#x27;INSERT&#x27;,NOW(),new.id,CONCAT(&#x27;æ’å…¥å&#123;id=&#x27;,new.id,&#x27;,name=&#x27;,new.name,&#x27;,money=&#x27;,new.money,&#x27;&#125;&#x27;));END$DELIMITER ; 123456789-- å‘accountè¡¨æ·»åŠ è®°å½•INSERT INTO account VALUES (NULL,&#x27;ç‹äº”&#x27;,3000);-- æŸ¥è¯¢æ—¥å¿—è¡¨SELECT * FROM account_log;/*id operation operation_time operation_id operation_params1 INSERT 2021-01-26 19:51:11 3 æ’å…¥å&#123;id=3,name=ç‹äº”money=2000&#125;*/ åˆ›å»º UPDATE å‹è§¦å‘å™¨ 1234567891011DELIMITER $CREATE TRIGGER account_updateAFTER UPDATEON accountFOR EACH ROWBEGIN INSERT INTO account_log VALUES (NULL,&#x27;UPDATE&#x27;,NOW(),new.id,CONCAT(&#x27;ä¿®æ”¹å‰&#123;id=&#x27;,old.id,&#x27;,name=&#x27;,old.name,&#x27;,money=&#x27;,old.money,&#x27;&#125;&#x27;,&#x27;ä¿®æ”¹å&#123;id=&#x27;,new.id,&#x27;,name=&#x27;,new.name,&#x27;,money=&#x27;,new.money,&#x27;&#125;&#x27;));END$DELIMITER ; 12345678910-- ä¿®æ”¹accountè¡¨UPDATE account SET money=3500 WHERE id=3;-- æŸ¥è¯¢æ—¥å¿—è¡¨SELECT * FROM account_log;/*id operation operation_time operation_id operation_params2 UPDATE 2021-01-26 19:58:54 2 æ›´æ–°å‰&#123;id=2,name=æå››money=1000&#125; æ›´æ–°å&#123;id=2,name=æå››money=200&#125;*/ åˆ›å»º DELETE å‹è§¦å‘å™¨ 1234567891011DELIMITER $CREATE TRIGGER account_deleteAFTER DELETEON accountFOR EACH ROWBEGIN INSERT INTO account_log VALUES (NULL,&#x27;DELETE&#x27;,NOW(),old.id,CONCAT(&#x27;åˆ é™¤å‰&#123;id=&#x27;,old.id,&#x27;,name=&#x27;,old.name,&#x27;,money=&#x27;,old.money,&#x27;&#125;&#x27;));END$DELIMITER ; 123456789-- åˆ é™¤accountè¡¨æ•°æ®DELETE FROM account WHERE id=3;-- æŸ¥è¯¢æ—¥å¿—è¡¨SELECT * FROM account_log;/*id operation operation_time operation_id operation_params3 DELETE 2021-01-26 20:02:48 3 åˆ é™¤å‰&#123;id=3,name=ç‹äº”money=2000&#125;*/ å­˜å‚¨å¼•æ“åŸºæœ¬ä»‹ç»å¯¹æ¯”å…¶ä»–æ•°æ®åº“ï¼ŒMySQL çš„æ¶æ„å¯ä»¥åœ¨ä¸åŒåœºæ™¯åº”ç”¨å¹¶å‘æŒ¥è‰¯å¥½ä½œç”¨ï¼Œä¸»è¦ä½“ç°åœ¨å­˜å‚¨å¼•æ“ï¼Œæ’ä»¶å¼çš„å­˜å‚¨å¼•æ“æ¶æ„å°†æŸ¥è¯¢å¤„ç†å’Œå…¶ä»–çš„ç³»ç»Ÿä»»åŠ¡ä»¥åŠæ•°æ®çš„å­˜å‚¨æå–åˆ†ç¦»ï¼Œå¯ä»¥é’ˆå¯¹ä¸åŒçš„å­˜å‚¨éœ€æ±‚å¯ä»¥é€‰æ‹©æœ€ä¼˜çš„å­˜å‚¨å¼•æ“ å­˜å‚¨å¼•æ“çš„ä»‹ç»ï¼š MySQL æ•°æ®åº“ä½¿ç”¨ä¸åŒçš„æœºåˆ¶å­˜å–è¡¨æ–‡ä»¶ , æœºåˆ¶çš„å·®åˆ«åœ¨äºä¸åŒçš„å­˜å‚¨æ–¹å¼ã€ç´¢å¼•æŠ€å·§ã€é”å®šæ°´å¹³ç­‰ä¸åŒçš„åŠŸèƒ½å’Œèƒ½åŠ›ï¼Œåœ¨ MySQL ä¸­ï¼Œå°†è¿™äº›ä¸åŒçš„æŠ€æœ¯åŠé…å¥—çš„åŠŸèƒ½ç§°ä¸ºå­˜å‚¨å¼•æ“ Oracleã€SqlServer ç­‰æ•°æ®åº“åªæœ‰ä¸€ç§å­˜å‚¨å¼•æ“ï¼ŒMySQL æä¾›äº†æ’ä»¶å¼çš„å­˜å‚¨å¼•æ“æ¶æ„ï¼Œæ‰€ä»¥ MySQL å­˜åœ¨å¤šç§å­˜å‚¨å¼•æ“ , å°±ä¼šè®©æ•°æ®åº“é‡‡å–äº†ä¸åŒçš„å¤„ç†æ•°æ®çš„æ–¹å¼å’Œæ‰©å±•åŠŸèƒ½ åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­æ•°æ®çš„å­˜å‚¨æ˜¯ä»¥è¡¨çš„å½¢å¼å­˜è¿›è¡Œï¼Œæ‰€ä»¥å­˜å‚¨å¼•æ“ä¹Ÿç§°ä¸ºè¡¨ç±»å‹ï¼ˆå­˜å‚¨å’Œæ“ä½œæ­¤è¡¨çš„ç±»å‹ï¼‰ é€šè¿‡é€‰æ‹©ä¸åŒçš„å¼•æ“ï¼Œèƒ½å¤Ÿè·å–æœ€ä½³çš„æ–¹æ¡ˆ, ä¹Ÿèƒ½å¤Ÿè·å¾—é¢å¤–çš„é€Ÿåº¦æˆ–è€…åŠŸèƒ½ï¼Œæé«˜ç¨‹åºçš„æ•´ä½“æ•ˆæœã€‚ MySQL æ”¯æŒçš„å­˜å‚¨å¼•æ“ï¼š MySQL æ”¯æŒçš„å¼•æ“åŒ…æ‹¬ï¼šInnoDBã€MyISAMã€MEMORYã€Archiveã€Federateã€CSVã€BLACKHOLE ç­‰ MySQL5.5 ä¹‹å‰çš„é»˜è®¤å­˜å‚¨å¼•æ“æ˜¯ MyISAMï¼Œ5.5 ä¹‹åå°±æ”¹ä¸ºäº† InnoDB å¼•æ“å¯¹æ¯”MyISAM å­˜å‚¨å¼•æ“ï¼š ç‰¹ç‚¹ï¼šä¸æ”¯æŒäº‹åŠ¡å’Œå¤–é”®ï¼Œè¯»å–é€Ÿåº¦å¿«ï¼ŒèŠ‚çº¦èµ„æº åº”ç”¨åœºæ™¯ï¼šé€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œå¯¹äº‹åŠ¡çš„å®Œæ•´æ€§è¦æ±‚ä¸é«˜ï¼Œæ¯”å¦‚ä¸€äº›æ•°ä»“ã€ç¦»çº¿æ•°æ®ã€æ”¯ä»˜å®çš„å¹´åº¦æ€»ç»“ä¹‹ç±»çš„åœºæ™¯ï¼Œä¸šåŠ¡è¿›è¡Œåªè¯»æ“ä½œï¼ŒæŸ¥è¯¢èµ·æ¥ä¼šæ›´å¿« å­˜å‚¨æ–¹å¼ï¼š æ¯ä¸ª MyISAM åœ¨ç£ç›˜ä¸Šå­˜å‚¨æˆ 3 ä¸ªæ–‡ä»¶ï¼Œå…¶æ–‡ä»¶åéƒ½å’Œè¡¨åç›¸åŒï¼Œæ‹“å±•åä¸åŒ è¡¨çš„å®šä¹‰ä¿å­˜åœ¨ .frm æ–‡ä»¶ï¼Œè¡¨æ•°æ®ä¿å­˜åœ¨ .MYD (MYData) æ–‡ä»¶ä¸­ï¼Œç´¢å¼•ä¿å­˜åœ¨ .MYI (MYIndex) æ–‡ä»¶ä¸­ InnoDB å­˜å‚¨å¼•æ“ï¼š(MySQL5.5 ç‰ˆæœ¬åé»˜è®¤çš„å­˜å‚¨å¼•æ“) ç‰¹ç‚¹ï¼šæ”¯æŒäº‹åŠ¡å’Œå¤–é”®æ“ä½œï¼Œæ”¯æŒå¹¶å‘æ§åˆ¶ã€‚å¯¹æ¯” MyISAM çš„å­˜å‚¨å¼•æ“ï¼ŒInnoDB å†™çš„å¤„ç†æ•ˆç‡å·®ä¸€äº›ï¼Œå¹¶ä¸”ä¼šå ç”¨æ›´å¤šçš„ç£ç›˜ç©ºé—´ä»¥ä¿ç•™æ•°æ®å’Œç´¢å¼• åº”ç”¨åœºæ™¯ï¼šå¯¹äº‹åŠ¡çš„å®Œæ•´æ€§æœ‰æ¯”è¾ƒé«˜çš„è¦æ±‚ï¼Œåœ¨å¹¶å‘æ¡ä»¶ä¸‹è¦æ±‚æ•°æ®çš„ä¸€è‡´æ€§ï¼Œè¯»å†™é¢‘ç¹çš„æ“ä½œ å­˜å‚¨æ–¹å¼ï¼š ä½¿ç”¨å…±äº«è¡¨ç©ºé—´å­˜å‚¨ï¼Œ è¿™ç§æ–¹å¼åˆ›å»ºçš„è¡¨çš„è¡¨ç»“æ„ä¿å­˜åœ¨ .frm æ–‡ä»¶ä¸­ï¼Œ æ•°æ®å’Œç´¢å¼•ä¿å­˜åœ¨ innodb_data_home_dir å’Œ innodb_data_file_path å®šä¹‰çš„è¡¨ç©ºé—´ä¸­ï¼Œå¯ä»¥æ˜¯å¤šä¸ªæ–‡ä»¶ ä½¿ç”¨å¤šè¡¨ç©ºé—´å­˜å‚¨ï¼Œåˆ›å»ºçš„è¡¨çš„è¡¨ç»“æ„å­˜åœ¨ .frm æ–‡ä»¶ä¸­ï¼Œæ¯ä¸ªè¡¨çš„æ•°æ®å’Œç´¢å¼•å•ç‹¬ä¿å­˜åœ¨ .ibd ä¸­ MEMORY å­˜å‚¨å¼•æ“ï¼š ç‰¹ç‚¹ï¼šæ¯ä¸ª MEMORY è¡¨å®é™…å¯¹åº”ä¸€ä¸ªç£ç›˜æ–‡ä»¶ ï¼Œè¯¥æ–‡ä»¶ä¸­åªå­˜å‚¨è¡¨çš„ç»“æ„ï¼Œè¡¨æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œä¸”é»˜è®¤ä½¿ç”¨ HASH ç´¢å¼•ï¼Œæ‰€ä»¥æ•°æ®é»˜è®¤å°±æ˜¯æ— åºçš„ï¼Œä½†æ˜¯åœ¨éœ€è¦å¿«é€Ÿå®šä½è®°å½•å¯ä»¥æä¾›æ›´å¿«çš„è®¿é—®ï¼ŒæœåŠ¡ä¸€æ—¦å…³é—­ï¼Œè¡¨ä¸­çš„æ•°æ®å°±ä¼šä¸¢å¤±ï¼Œå­˜å‚¨ä¸å®‰å…¨ åº”ç”¨åœºæ™¯ï¼šç¼“å­˜å‹å­˜å‚¨å¼•æ“ï¼Œé€šå¸¸ç”¨äºæ›´æ–°ä¸å¤ªé¢‘ç¹çš„å°è¡¨ï¼Œç”¨ä»¥å¿«é€Ÿå¾—åˆ°è®¿é—®ç»“æœ å­˜å‚¨æ–¹å¼ï¼šè¡¨ç»“æ„ä¿å­˜åœ¨ .frm ä¸­ MERGE å­˜å‚¨å¼•æ“ï¼š ç‰¹ç‚¹ï¼š æ˜¯ä¸€ç»„ MyISAM è¡¨çš„ç»„åˆï¼Œè¿™äº› MyISAM è¡¨å¿…é¡»ç»“æ„å®Œå…¨ç›¸åŒï¼Œé€šè¿‡å°†ä¸åŒçš„è¡¨åˆ†å¸ƒåœ¨å¤šä¸ªç£ç›˜ä¸Š MERGE è¡¨æœ¬èº«å¹¶æ²¡æœ‰å­˜å‚¨æ•°æ®ï¼Œå¯¹ MERGE ç±»å‹çš„è¡¨å¯ä»¥è¿›è¡ŒæŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤æ“ä½œï¼Œè¿™äº›æ“ä½œå®é™…ä¸Šæ˜¯å¯¹å†…éƒ¨çš„ MyISAM è¡¨è¿›è¡Œçš„ åº”ç”¨åœºæ™¯ï¼šå°†ä¸€ç³»åˆ—ç­‰åŒçš„ MyISAM è¡¨ä»¥é€»è¾‘æ–¹å¼ç»„åˆåœ¨ä¸€èµ·ï¼Œå¹¶ä½œä¸ºä¸€ä¸ªå¯¹è±¡å¼•ç”¨ä»–ä»¬ï¼Œé€‚åˆåšæ•°æ®ä»“åº“ æ“ä½œæ–¹å¼ï¼š æ’å…¥æ“ä½œæ˜¯é€šè¿‡ INSERT_METHOD å­å¥å®šä¹‰æ’å…¥çš„è¡¨ï¼Œä½¿ç”¨ FIRST æˆ– LAST å€¼ä½¿å¾—æ’å…¥æ“ä½œè¢«ç›¸åº”åœ°ä½œç”¨åœ¨ç¬¬ä¸€æˆ–è€…æœ€åä¸€ä¸ªè¡¨ä¸Šï¼›ä¸å®šä¹‰è¿™ä¸ªå­å¥æˆ–è€…å®šä¹‰ä¸º NOï¼Œè¡¨ç¤ºä¸èƒ½å¯¹ MERGE è¡¨æ‰§è¡Œæ’å…¥æ“ä½œ å¯¹ MERGE è¡¨è¿›è¡Œ DROP æ“ä½œï¼Œä½†æ˜¯è¿™ä¸ªæ“ä½œåªæ˜¯åˆ é™¤ MERGE è¡¨çš„å®šä¹‰ï¼Œå¯¹å†…éƒ¨çš„è¡¨æ˜¯æ²¡æœ‰ä»»ä½•å½±å“çš„ 123456789CREATE TABLE order_1()ENGINE = MyISAM DEFAULT CHARSET=utf8;CREATE TABLE order_2()ENGINE = MyISAM DEFAULT CHARSET=utf8;CREATE TABLE order_all( -- ç»“æ„ä¸MyISAMè¡¨ç›¸åŒ)ENGINE = MERGE UNION = (order_1,order_2) INSERT_METHOD=LAST DEFAULT CHARSET=utf8; ç‰¹æ€§ MyISAM InnoDB MEMORY å­˜å‚¨é™åˆ¶ æœ‰ï¼ˆå¹³å°å¯¹æ–‡ä»¶ç³»ç»Ÿå¤§å°çš„é™åˆ¶ï¼‰ 64TB æœ‰ï¼ˆå¹³å°çš„å†…å­˜é™åˆ¶ï¼‰ äº‹åŠ¡å®‰å…¨ ä¸æ”¯æŒ æ”¯æŒ ä¸æ”¯æŒ é”æœºåˆ¶ è¡¨é” è¡¨é”&#x2F;è¡Œé” è¡¨é” B+Tree ç´¢å¼• æ”¯æŒ æ”¯æŒ æ”¯æŒ å“ˆå¸Œç´¢å¼• ä¸æ”¯æŒ ä¸æ”¯æŒ æ”¯æŒ å…¨æ–‡ç´¢å¼• æ”¯æŒ æ”¯æŒ ä¸æ”¯æŒ é›†ç¾¤ç´¢å¼• ä¸æ”¯æŒ æ”¯æŒ ä¸æ”¯æŒ æ•°æ®ç´¢å¼• ä¸æ”¯æŒ æ”¯æŒ æ”¯æŒ æ•°æ®ç¼“å­˜ ä¸æ”¯æŒ æ”¯æŒ N&#x2F;A ç´¢å¼•ç¼“å­˜ æ”¯æŒ æ”¯æŒ N&#x2F;A æ•°æ®å¯å‹ç¼© æ”¯æŒ ä¸æ”¯æŒ ä¸æ”¯æŒ ç©ºé—´ä½¿ç”¨ ä½ é«˜ N&#x2F;A å†…å­˜ä½¿ç”¨ ä½ é«˜ ä¸­ç­‰ æ‰¹é‡æ’å…¥é€Ÿåº¦ é«˜ ä½ é«˜ å¤–é”® ä¸æ”¯æŒ æ”¯æŒ ä¸æ”¯æŒ åªè¯»åœºæ™¯ MyISAM æ¯” InnoDB æ›´å¿«ï¼š åº•å±‚å­˜å‚¨ç»“æ„æœ‰å·®åˆ«ï¼ŒMyISAM æ˜¯éèšç°‡ç´¢å¼•ï¼Œå¶å­èŠ‚ç‚¹ä¿å­˜çš„æ˜¯æ•°æ®çš„å…·ä½“åœ°å€ï¼Œä¸ç”¨å›è¡¨æŸ¥è¯¢ InnoDB æ¯æ¬¡æŸ¥è¯¢éœ€è¦ç»´æŠ¤ MVCC ç‰ˆæœ¬çŠ¶æ€ï¼Œä¿è¯å¹¶å‘çŠ¶æ€ä¸‹çš„è¯»å†™å†²çªé—®é¢˜ å¼•æ“æ“ä½œ æŸ¥è¯¢æ•°æ®åº“æ”¯æŒçš„å­˜å‚¨å¼•æ“ 12SHOW ENGINES;SHOW VARIABLES LIKE &#x27;%storage_engine%&#x27;; -- æŸ¥çœ‹Mysqlæ•°æ®åº“é»˜è®¤çš„å­˜å‚¨å¼•æ“ æŸ¥è¯¢æŸä¸ªæ•°æ®åº“ä¸­æ‰€æœ‰æ•°æ®è¡¨çš„å­˜å‚¨å¼•æ“ 1SHOW TABLE STATUS FROM æ•°æ®åº“åç§°; æŸ¥è¯¢æŸä¸ªæ•°æ®åº“ä¸­æŸä¸ªæ•°æ®è¡¨çš„å­˜å‚¨å¼•æ“ 1SHOW TABLE STATUS FROM æ•°æ®åº“åç§° WHERE NAME = &#x27;æ•°æ®è¡¨åç§°&#x27;; åˆ›å»ºæ•°æ®è¡¨ï¼ŒæŒ‡å®šå­˜å‚¨å¼•æ“ 1234CREATE TABLE è¡¨å( åˆ—å,æ•°æ®ç±»å‹, ...)ENGINE = å¼•æ“åç§°; ä¿®æ”¹æ•°æ®è¡¨çš„å­˜å‚¨å¼•æ“ 1ALTER TABLE è¡¨å ENGINE = å¼•æ“åç§°; ç´¢å¼•æœºåˆ¶ç´¢å¼•ä»‹ç»åŸºæœ¬ä»‹ç»MySQL å®˜æ–¹å¯¹ç´¢å¼•çš„å®šä¹‰ä¸ºï¼šç´¢å¼•ï¼ˆindexï¼‰æ˜¯å¸®åŠ© MySQL é«˜æ•ˆè·å–æ•°æ®çš„ä¸€ç§æ•°æ®ç»“æ„ï¼Œæœ¬è´¨æ˜¯æ’å¥½åºçš„å¿«é€ŸæŸ¥æ‰¾æ•°æ®ç»“æ„ã€‚åœ¨è¡¨æ•°æ®ä¹‹å¤–ï¼Œæ•°æ®åº“ç³»ç»Ÿè¿˜ç»´æŠ¤ç€æ»¡è¶³ç‰¹å®šæŸ¥æ‰¾ç®—æ³•çš„æ•°æ®ç»“æ„ï¼Œè¿™äº›æ•°æ®ç»“æ„ä»¥æŸç§æ–¹å¼æŒ‡å‘æ•°æ®ï¼Œ è¿™æ ·å°±å¯ä»¥åœ¨è¿™äº›æ•°æ®ç»“æ„ä¸Šå®ç°é«˜çº§æŸ¥æ‰¾ç®—æ³•ï¼Œè¿™ç§æ•°æ®ç»“æ„å°±æ˜¯ç´¢å¼• ç´¢å¼•æ˜¯åœ¨å­˜å‚¨å¼•æ“å±‚å®ç°çš„ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰ç»Ÿä¸€çš„ç´¢å¼•æ ‡å‡†ï¼Œå³ä¸åŒå­˜å‚¨å¼•æ“çš„ç´¢å¼•çš„å·¥ä½œæ–¹å¼å¹¶ä¸ä¸€æ · ç´¢å¼•ä½¿ç”¨ï¼šä¸€å¼ æ•°æ®è¡¨ï¼Œç”¨äºä¿å­˜æ•°æ®ï¼›ä¸€ä¸ªç´¢å¼•é…ç½®æ–‡ä»¶ï¼Œç”¨äºä¿å­˜ç´¢å¼•ï¼›æ¯ä¸ªç´¢å¼•éƒ½æŒ‡å‘äº†æŸä¸€ä¸ªæ•°æ® å·¦è¾¹æ˜¯æ•°æ®è¡¨ï¼Œä¸€å…±æœ‰ä¸¤åˆ—ä¸ƒæ¡è®°å½•ï¼Œæœ€å·¦è¾¹çš„æ˜¯æ•°æ®è®°å½•çš„ç‰©ç†åœ°å€ï¼ˆæ³¨æ„é€»è¾‘ä¸Šç›¸é‚»çš„è®°å½•åœ¨ç£ç›˜ä¸Šä¹Ÿå¹¶ä¸æ˜¯ä¸€å®šç‰©ç†ç›¸é‚»çš„ï¼‰ã€‚ä¸ºäº†åŠ å¿« Col2 çš„æŸ¥æ‰¾ï¼Œå¯ä»¥ç»´æŠ¤ä¸€ä¸ªå³è¾¹æ‰€ç¤ºçš„äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œæ¯ä¸ªèŠ‚ç‚¹åˆ†åˆ«åŒ…å«ç´¢å¼•é”®å€¼å’Œä¸€ä¸ªæŒ‡å‘å¯¹åº”æ•°æ®çš„ç‰©ç†åœ°å€çš„æŒ‡é’ˆï¼Œè¿™æ ·å°±å¯ä»¥è¿ç”¨äºŒå‰æŸ¥æ‰¾å¿«é€Ÿè·å–åˆ°ç›¸åº”æ•°æ® ç´¢å¼•çš„ä¼˜ç‚¹ï¼š ç±»ä¼¼äºä¹¦ç±çš„ç›®å½•ç´¢å¼•ï¼Œæé«˜æ•°æ®æ£€ç´¢çš„æ•ˆç‡ï¼Œé™ä½æ•°æ®åº“çš„ IO æˆæœ¬ é€šè¿‡ç´¢å¼•åˆ—å¯¹æ•°æ®è¿›è¡Œæ’åºï¼Œé™ä½æ•°æ®æ’åºçš„æˆæœ¬ï¼Œé™ä½ CPU çš„æ¶ˆè€— ç´¢å¼•çš„ç¼ºç‚¹ï¼š ä¸€èˆ¬æ¥è¯´ç´¢å¼•æœ¬èº«ä¹Ÿå¾ˆå¤§ï¼Œä¸å¯èƒ½å…¨éƒ¨å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå› æ­¤ç´¢å¼•å¾€å¾€ä»¥ç´¢å¼•æ–‡ä»¶çš„å½¢å¼å­˜å‚¨åœ¨ç£ç›˜ä¸Š è™½ç„¶ç´¢å¼•å¤§å¤§æé«˜äº†æŸ¥è¯¢æ•ˆç‡ï¼ŒåŒæ—¶å´ä¹Ÿé™ä½æ›´æ–°è¡¨çš„é€Ÿåº¦ã€‚å¯¹è¡¨è¿›è¡Œ INSERTã€UPDATEã€DELETE æ“ä½œï¼ŒMySQL ä¸ä»…è¦ä¿å­˜æ•°æ®ï¼Œè¿˜è¦ä¿å­˜ä¸€ä¸‹ç´¢å¼•æ–‡ä»¶æ¯æ¬¡æ›´æ–°æ·»åŠ äº†ç´¢å¼•åˆ—çš„å­—æ®µï¼Œè¿˜ä¼šè°ƒæ•´å› ä¸ºæ›´æ–°æ‰€å¸¦æ¥çš„é”®å€¼å˜åŒ–åçš„ç´¢å¼•ä¿¡æ¯ï¼Œä½†æ˜¯æ›´æ–°æ•°æ®ä¹Ÿéœ€è¦å…ˆä»æ•°æ®åº“ä¸­è·å–ï¼Œç´¢å¼•åŠ å¿«äº†è·å–é€Ÿåº¦ï¼Œæ‰€ä»¥å¯ä»¥ç›¸äº’æŠµæ¶ˆä¸€ä¸‹ã€‚ ç´¢å¼•ä¼šå½±å“åˆ° WHERE çš„æŸ¥è¯¢æ¡ä»¶å’Œæ’åº ORDER BY ä¸¤å¤§åŠŸèƒ½ ç´¢å¼•åˆ†ç±»ç´¢å¼•ä¸€èˆ¬çš„åˆ†ç±»å¦‚ä¸‹ï¼š åŠŸèƒ½åˆ†ç±» ä¸»é”®ç´¢å¼•ï¼šä¸€ç§ç‰¹æ®Šçš„å”¯ä¸€ç´¢å¼•ï¼Œä¸å…è®¸æœ‰ç©ºå€¼ï¼Œä¸€èˆ¬åœ¨å»ºè¡¨æ—¶åŒæ—¶åˆ›å»ºä¸»é”®ç´¢å¼• å•åˆ—ç´¢å¼•ï¼šä¸€ä¸ªç´¢å¼•åªåŒ…å«å•ä¸ªåˆ—ï¼Œä¸€ä¸ªè¡¨å¯ä»¥æœ‰å¤šä¸ªå•åˆ—ç´¢å¼•ï¼ˆæ™®é€šç´¢å¼•ï¼‰ è”åˆç´¢å¼•ï¼šé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å°†å•åˆ—ç´¢å¼•è¿›è¡Œç»„åˆ å”¯ä¸€ç´¢å¼•ï¼šç´¢å¼•åˆ—çš„å€¼å¿…é¡»å”¯ä¸€ï¼Œå…è®¸æœ‰ç©ºå€¼ï¼Œå¦‚æœæ˜¯è”åˆç´¢å¼•ï¼Œåˆ™åˆ—å€¼ç»„åˆå¿…é¡»å”¯ä¸€ NULL å€¼å¯ä»¥å‡ºç°å¤šæ¬¡ï¼Œå› ä¸ºä¸¤ä¸ª NULL æ¯”è¾ƒçš„ç»“æœæ—¢ä¸ç›¸ç­‰ï¼Œä¹Ÿä¸ä¸ç­‰ï¼Œç»“æœä»ç„¶æ˜¯æœªçŸ¥ å¯ä»¥å£°æ˜ä¸å…è®¸å­˜å‚¨ NULL å€¼çš„éç©ºå”¯ä¸€ç´¢å¼• å¤–é”®ç´¢å¼•ï¼šåªæœ‰ InnoDB å¼•æ“æ”¯æŒå¤–é”®ç´¢å¼•ï¼Œç”¨æ¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€å®Œæ•´æ€§å’Œå®ç°çº§è”æ“ä½œ ç»“æ„åˆ†ç±» BTree ç´¢å¼•ï¼šMySQL ä½¿ç”¨æœ€é¢‘ç¹çš„ä¸€ä¸ªç´¢å¼•æ•°æ®ç»“æ„ï¼Œæ˜¯ InnoDB å’Œ MyISAM å­˜å‚¨å¼•æ“é»˜è®¤çš„ç´¢å¼•ç±»å‹ï¼Œåº•å±‚åŸºäº B+Tree Hash ç´¢å¼•ï¼šMySQLä¸­ Memory å­˜å‚¨å¼•æ“é»˜è®¤æ”¯æŒçš„ç´¢å¼•ç±»å‹ R-tree ç´¢å¼•ï¼ˆç©ºé—´ç´¢å¼•ï¼‰ï¼šç©ºé—´ç´¢å¼•æ˜¯ MyISAM å¼•æ“çš„ä¸€ä¸ªç‰¹æ®Šç´¢å¼•ç±»å‹ï¼Œä¸»è¦ç”¨äºåœ°ç†ç©ºé—´æ•°æ®ç±»å‹ Full-text ç´¢å¼•ï¼ˆå…¨æ–‡ç´¢å¼•ï¼‰ï¼šå¿«é€ŸåŒ¹é…å…¨éƒ¨æ–‡æ¡£çš„æ–¹å¼ã€‚MyISAM æ”¯æŒï¼Œ InnoDB ä¸æ”¯æŒ FULLTEXT ç±»å‹çš„ç´¢å¼•ï¼Œä½†æ˜¯ InnoDB å¯ä»¥ä½¿ç”¨ sphinx æ’ä»¶æ”¯æŒå…¨æ–‡ç´¢å¼•ï¼ŒMEMORY å¼•æ“ä¸æ”¯æŒ ç´¢å¼• InnoDB MyISAM Memory BTREE æ”¯æŒ æ”¯æŒ æ”¯æŒ HASH ä¸æ”¯æŒ ä¸æ”¯æŒ æ”¯æŒ R-tree ä¸æ”¯æŒ æ”¯æŒ ä¸æ”¯æŒ Full-text 5.6 ç‰ˆæœ¬ä¹‹åæ”¯æŒ æ”¯æŒ ä¸æ”¯æŒ è”åˆç´¢å¼•å›¾ç¤ºï¼šæ ¹æ®èº«é«˜å¹´é¾„å»ºç«‹çš„ç»„åˆç´¢å¼•ï¼ˆheightã€ageï¼‰ ç´¢å¼•æ“ä½œç´¢å¼•åœ¨åˆ›å»ºè¡¨çš„æ—¶å€™å¯ä»¥åŒæ—¶åˆ›å»ºï¼Œ ä¹Ÿå¯ä»¥éšæ—¶å¢åŠ æ–°çš„ç´¢å¼• åˆ›å»ºç´¢å¼•ï¼šå¦‚æœä¸€ä¸ªè¡¨ä¸­æœ‰ä¸€åˆ—æ˜¯ä¸»é”®ï¼Œé‚£ä¹ˆä¼šé»˜è®¤ä¸ºå…¶åˆ›å»ºä¸»é”®ç´¢å¼•ï¼ˆä¸»é”®åˆ—ä¸éœ€è¦å•ç‹¬åˆ›å»ºç´¢å¼•ï¼‰ 12CREATE [UNIQUE|FULLTEXT] INDEX ç´¢å¼•åç§° [USING ç´¢å¼•ç±»å‹] ON è¡¨å(åˆ—å...);-- ç´¢å¼•ç±»å‹é»˜è®¤æ˜¯ B+TREE æŸ¥çœ‹ç´¢å¼• 1SHOW INDEX FROM è¡¨å; æ·»åŠ ç´¢å¼• 1234567891011121314151617-- å•åˆ—ç´¢å¼•ALTER TABLE è¡¨å ADD INDEX ç´¢å¼•åç§°(åˆ—å);-- ç»„åˆç´¢å¼•ALTER TABLE è¡¨å ADD INDEX ç´¢å¼•åç§°(åˆ—å1,åˆ—å2,...);-- ä¸»é”®ç´¢å¼•ALTER TABLE è¡¨å ADD PRIMARY KEY(ä¸»é”®åˆ—å); -- å¤–é”®ç´¢å¼•(æ·»åŠ å¤–é”®çº¦æŸï¼Œå°±æ˜¯å¤–é”®ç´¢å¼•)ALTER TABLE è¡¨å ADD CONSTRAINT å¤–é”®å FOREIGN KEY (æœ¬è¡¨å¤–é”®åˆ—å) REFERENCES ä¸»è¡¨å(ä¸»é”®åˆ—å);-- å”¯ä¸€ç´¢å¼•ALTER TABLE è¡¨å ADD UNIQUE ç´¢å¼•åç§°(åˆ—å);-- å…¨æ–‡ç´¢å¼•(mysqlåªæ”¯æŒæ–‡æœ¬ç±»å‹)ALTER TABLE è¡¨å ADD FULLTEXT ç´¢å¼•åç§°(åˆ—å); åˆ é™¤ç´¢å¼• 1DROP INDEX ç´¢å¼•åç§° ON è¡¨å; æ¡ˆä¾‹ç»ƒä¹  æ•°æ®å‡†å¤‡ï¼šstudent 12345id NAME age score1 å¼ ä¸‰ 23 992 æå›› 24 953 ç‹äº” 25 984 èµµå…­ 26 97 ç´¢å¼•æ“ä½œï¼š 12345-- ä¸ºstudentè¡¨ä¸­å§“ååˆ—åˆ›å»ºä¸€ä¸ªæ™®é€šç´¢å¼•CREATE INDEX idx_name ON student(NAME);-- ä¸ºstudentè¡¨ä¸­å¹´é¾„åˆ—åˆ›å»ºä¸€ä¸ªå”¯ä¸€ç´¢å¼•CREATE UNIQUE INDEX idx_age ON student(age); èšç°‡ç´¢å¼•ç´¢å¼•å¯¹æ¯”èšç°‡ç´¢å¼•æ˜¯ä¸€ç§æ•°æ®å­˜å‚¨æ–¹å¼ï¼Œå¹¶ä¸æ˜¯ä¸€ç§å•ç‹¬çš„ç´¢å¼•ç±»å‹ èšç°‡ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜æ”¾çš„æ˜¯ä¸»é”®å€¼å’Œæ•°æ®è¡Œï¼Œæ”¯æŒè¦†ç›–ç´¢å¼• éèšç°‡ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜æ”¾çš„æ˜¯ä¸»é”®å€¼æˆ–æŒ‡å‘æ•°æ®è¡Œçš„æŒ‡é’ˆï¼ˆç”±å­˜å‚¨å¼•æ“å†³å®šï¼‰ åœ¨ Innodb ä¸‹ä¸»é”®ç´¢å¼•æ˜¯èšç°‡ç´¢å¼•ï¼Œåœ¨ MyISAM ä¸‹ä¸»é”®ç´¢å¼•æ˜¯éèšç°‡ç´¢å¼• Innodbèšç°‡ç´¢å¼•åœ¨ Innodb å­˜å‚¨å¼•æ“ï¼ŒB+ æ ‘ç´¢å¼•å¯ä»¥åˆ†ä¸ºèšç°‡ç´¢å¼•ï¼ˆä¹Ÿç§°èšé›†ç´¢å¼•ã€clustered indexï¼‰å’Œè¾…åŠ©ç´¢å¼•ï¼ˆä¹Ÿç§°éèšç°‡ç´¢å¼•æˆ–äºŒçº§ç´¢å¼•ã€secondary indexã€non-clustered indexï¼‰ InnoDB ä¸­ï¼Œèšç°‡ç´¢å¼•æ˜¯æŒ‰ç…§æ¯å¼ è¡¨çš„ä¸»é”®æ„é€ ä¸€é¢— B+ æ ‘ï¼Œå¶å­èŠ‚ç‚¹ä¸­å­˜æ”¾çš„å°±æ˜¯æ•´å¼ è¡¨çš„æ•°æ®ï¼Œå°†èšç°‡ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ç§°ä¸ºæ•°æ®é¡µ è¿™ä¸ªç‰¹æ€§å†³å®šäº†æ•°æ®ä¹Ÿæ˜¯ç´¢å¼•çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥ä¸€å¼ è¡¨åªèƒ½æœ‰ä¸€ä¸ªèšç°‡ç´¢å¼• è¾…åŠ©ç´¢å¼•çš„å­˜åœ¨ä¸å½±å“èšç°‡ç´¢å¼•ä¸­æ•°æ®çš„ç»„ç»‡ï¼Œæ‰€ä»¥ä¸€å¼ è¡¨å¯ä»¥æœ‰å¤šä¸ªè¾…åŠ©ç´¢å¼• èšç°‡ç´¢å¼•çš„ä¼˜ç‚¹ï¼š æ•°æ®è®¿é—®æ›´å¿«ï¼Œèšç°‡ç´¢å¼•å°†ç´¢å¼•å’Œæ•°æ®ä¿å­˜åœ¨åŒä¸€ä¸ª B+ æ ‘ä¸­ï¼Œå› æ­¤ä»èšç°‡ç´¢å¼•ä¸­è·å–æ•°æ®æ¯”éèšç°‡ç´¢å¼•æ›´å¿« èšç°‡ç´¢å¼•å¯¹äºä¸»é”®çš„æ’åºæŸ¥æ‰¾å’ŒèŒƒå›´æŸ¥æ‰¾é€Ÿåº¦éå¸¸å¿« èšç°‡ç´¢å¼•çš„ç¼ºç‚¹ï¼š æ’å…¥é€Ÿåº¦ä¸¥é‡ä¾èµ–äºæ’å…¥é¡ºåºï¼ŒæŒ‰ç…§ä¸»é”®çš„é¡ºåºï¼ˆé€’å¢ï¼‰æ’å…¥æ˜¯æœ€å¿«çš„æ–¹å¼ï¼Œå¦åˆ™å°†ä¼šå‡ºç°é¡µåˆ†è£‚ï¼Œä¸¥é‡å½±å“æ€§èƒ½ï¼Œæ‰€ä»¥å¯¹äº InnoDB è¡¨ï¼Œä¸€èˆ¬éƒ½ä¼šå®šä¹‰ä¸€ä¸ªè‡ªå¢çš„ ID åˆ—ä¸ºä¸»é”® æ›´æ–°ä¸»é”®çš„ä»£ä»·å¾ˆé«˜ï¼Œå°†ä¼šå¯¼è‡´è¢«æ›´æ–°çš„è¡Œç§»åŠ¨ï¼Œæ‰€ä»¥å¯¹äº InnoDB è¡¨ï¼Œä¸€èˆ¬å®šä¹‰ä¸»é”®ä¸ºä¸å¯æ›´æ–° äºŒçº§ç´¢å¼•è®¿é—®éœ€è¦ä¸¤æ¬¡ç´¢å¼•æŸ¥æ‰¾ï¼Œç¬¬ä¸€æ¬¡æ‰¾åˆ°ä¸»é”®å€¼ï¼Œç¬¬äºŒæ¬¡æ ¹æ®ä¸»é”®å€¼æ‰¾åˆ°è¡Œæ•°æ® è¾…åŠ©ç´¢å¼•åœ¨èšç°‡ç´¢å¼•ä¹‹ä¸Šåˆ›å»ºçš„ç´¢å¼•ç§°ä¹‹ä¸ºè¾…åŠ©ç´¢å¼•ï¼Œéèšç°‡ç´¢å¼•éƒ½æ˜¯è¾…åŠ©ç´¢å¼•ï¼Œåƒå¤åˆç´¢å¼•ã€å‰ç¼€ç´¢å¼•ã€å”¯ä¸€ç´¢å¼•ç­‰ è¾…åŠ©ç´¢å¼•å¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯ä¸»é”®å€¼ï¼Œè€Œä¸æ˜¯æ•°æ®çš„ç‰©ç†åœ°å€ï¼Œæ‰€ä»¥è®¿é—®æ•°æ®éœ€è¦äºŒæ¬¡æŸ¥æ‰¾ï¼Œæ¨èä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œå¯ä»¥å‡å°‘å›è¡¨æŸ¥è¯¢ æ£€ç´¢è¿‡ç¨‹ï¼šè¾…åŠ©ç´¢å¼•æ‰¾åˆ°ä¸»é”®å€¼ï¼Œå†é€šè¿‡èšç°‡ç´¢å¼•ï¼ˆäºŒåˆ†ï¼‰æ‰¾åˆ°æ•°æ®é¡µï¼Œæœ€åé€šè¿‡æ•°æ®é¡µä¸­çš„ Page Directoryï¼ˆäºŒåˆ†ï¼‰æ‰¾åˆ°å¯¹åº”çš„æ•°æ®åˆ†ç»„ï¼Œéå†ç»„å†…æ‰€æ‰€æœ‰çš„æ•°æ®æ‰¾åˆ°æ•°æ®è¡Œ è¡¥å……ï¼šæ— ç´¢å¼•èµ°å…¨è¡¨æŸ¥è¯¢ï¼ŒæŸ¥åˆ°æ•°æ®é¡µåå’Œä¸Šè¿°æ­¥éª¤ä¸€è‡´ ç´¢å¼•å®ç°InnoDB ä½¿ç”¨ B+Tree ä½œä¸ºç´¢å¼•ç»“æ„ï¼Œå¹¶ä¸” InnoDB ä¸€å®šæœ‰ç´¢å¼• ä¸»é”®ç´¢å¼•ï¼š åœ¨ InnoDB ä¸­ï¼Œè¡¨æ•°æ®æ–‡ä»¶æœ¬èº«å°±æ˜¯æŒ‰ B+Tree ç»„ç»‡çš„ä¸€ä¸ªç´¢å¼•ç»“æ„ï¼Œè¿™ä¸ªç´¢å¼•çš„ key æ˜¯æ•°æ®è¡¨çš„ä¸»é”®ï¼Œå¶å­èŠ‚ç‚¹ data åŸŸä¿å­˜äº†å®Œæ•´çš„æ•°æ®è®°å½• InnoDB çš„è¡¨æ•°æ®æ–‡ä»¶é€šè¿‡ä¸»é”®èšé›†æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰å®šä¹‰ä¸»é”®ï¼Œä¼šé€‰æ‹©éç©ºå”¯ä¸€ç´¢å¼•ä»£æ›¿ï¼Œå¦‚æœä¹Ÿæ²¡æœ‰è¿™æ ·çš„åˆ—ï¼ŒMySQL ä¼šè‡ªåŠ¨ä¸º InnoDB è¡¨ç”Ÿæˆä¸€ä¸ªéšå«å­—æ®µ row_id ä½œä¸ºä¸»é”®ï¼Œè¿™ä¸ªå­—æ®µé•¿åº¦ä¸º 6 ä¸ªå­—èŠ‚ï¼Œç±»å‹ä¸ºé•¿æ•´å½¢ è¾…åŠ©ç´¢å¼•ï¼š InnoDB çš„æ‰€æœ‰è¾…åŠ©ç´¢å¼•ï¼ˆäºŒçº§ç´¢å¼•ï¼‰éƒ½å¼•ç”¨ä¸»é”®ä½œä¸º data åŸŸ InnoDB è¡¨æ˜¯åŸºäºèšç°‡ç´¢å¼•å»ºç«‹çš„ï¼Œå› æ­¤ InnoDB çš„ç´¢å¼•èƒ½æä¾›ä¸€ç§éå¸¸å¿«é€Ÿçš„ä¸»é”®æŸ¥æ‰¾æ€§èƒ½ã€‚ä¸è¿‡è¾…åŠ©ç´¢å¼•ä¹Ÿä¼šåŒ…å«ä¸»é”®åˆ—ï¼Œæ‰€ä»¥ä¸å»ºè®®ä½¿ç”¨è¿‡é•¿çš„å­—æ®µä½œä¸ºä¸»é”®ï¼Œè¿‡é•¿çš„ä¸»ç´¢å¼•ä¼šä»¤è¾…åŠ©ç´¢å¼•å˜å¾—è¿‡å¤§ MyISAMéèšç°‡MyISAM çš„ä¸»é”®ç´¢å¼•ä½¿ç”¨çš„æ˜¯éèšç°‡ç´¢å¼•ï¼Œç´¢å¼•æ–‡ä»¶å’Œæ•°æ®æ–‡ä»¶æ˜¯åˆ†ç¦»çš„ï¼Œç´¢å¼•æ–‡ä»¶ä»…ä¿å­˜æ•°æ®çš„åœ°å€ ä¸»é”®ç´¢å¼• B+ æ ‘çš„èŠ‚ç‚¹å­˜å‚¨äº†ä¸»é”®ï¼Œè¾…åŠ©é”®ç´¢å¼• B+ æ ‘å­˜å‚¨äº†è¾…åŠ©é”®ï¼Œè¡¨æ•°æ®å­˜å‚¨åœ¨ç‹¬ç«‹çš„åœ°æ–¹ï¼Œè¿™ä¸¤é¢— B+ æ ‘çš„å¶å­èŠ‚ç‚¹éƒ½ä½¿ç”¨ä¸€ä¸ªåœ°å€æŒ‡å‘çœŸæ­£çš„è¡¨æ•°æ®ï¼Œå¯¹äºè¡¨æ•°æ®æ¥è¯´ï¼Œè¿™ä¸¤ä¸ªé”®æ²¡æœ‰ä»»ä½•å·®åˆ« ç”±äºç´¢å¼•æ ‘æ˜¯ç‹¬ç«‹çš„ï¼Œé€šè¿‡è¾…åŠ©ç´¢å¼•æ£€ç´¢æ— éœ€å›è¡¨æŸ¥è¯¢è®¿é—®ä¸»é”®çš„ç´¢å¼•æ ‘ ç´¢å¼•å®ç°MyISAM çš„ç´¢å¼•æ–¹å¼ä¹Ÿå«åšéèšé›†çš„ï¼Œä¹‹æ‰€ä»¥è¿™ä¹ˆç§°å‘¼æ˜¯ä¸ºäº†ä¸ InnoDB çš„èšé›†ç´¢å¼•åŒºåˆ† ä¸»é”®ç´¢å¼•ï¼šMyISAM å¼•æ“ä½¿ç”¨ B+Tree ä½œä¸ºç´¢å¼•ç»“æ„ï¼Œå¶èŠ‚ç‚¹çš„ data åŸŸå­˜æ”¾çš„æ˜¯æ•°æ®è®°å½•çš„åœ°å€ è¾…åŠ©ç´¢å¼•ï¼šMyISAM ä¸­ä¸»ç´¢å¼•å’Œè¾…åŠ©ç´¢å¼•ï¼ˆSecondary keyï¼‰åœ¨ç»“æ„ä¸Šæ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œåªæ˜¯ä¸»ç´¢å¼•è¦æ±‚ key æ˜¯å”¯ä¸€çš„ï¼Œè€Œè¾…åŠ©ç´¢å¼•çš„ key å¯ä»¥é‡å¤ å‚è€ƒæ–‡ç« ï¼šhttps://blog.csdn.net/lm1060891265/article/details/81482136 ç´¢å¼•ç»“æ„æ•°æ®é¡µæ–‡ä»¶ç³»ç»Ÿçš„æœ€å°å•å…ƒæ˜¯å—ï¼ˆblockï¼‰ï¼Œä¸€ä¸ªå—çš„å¤§å°æ˜¯ 4Kï¼Œç³»ç»Ÿä»ç£ç›˜è¯»å–æ•°æ®åˆ°å†…å­˜æ—¶æ˜¯ä»¥ç£ç›˜å—ä¸ºåŸºæœ¬å•ä½çš„ï¼Œä½äºåŒä¸€ä¸ªç£ç›˜å—ä¸­çš„æ•°æ®ä¼šè¢«ä¸€æ¬¡æ€§è¯»å–å‡ºæ¥ï¼Œè€Œä¸æ˜¯éœ€è¦ä»€ä¹ˆå–ä»€ä¹ˆ InnoDB å­˜å‚¨å¼•æ“ä¸­æœ‰é¡µï¼ˆPageï¼‰çš„æ¦‚å¿µï¼Œé¡µæ˜¯ MySQL ç£ç›˜ç®¡ç†çš„æœ€å°å•ä½ InnoDB å­˜å‚¨å¼•æ“ä¸­é»˜è®¤æ¯ä¸ªé¡µçš„å¤§å°ä¸º 16KBï¼Œç´¢å¼•ä¸­ä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯ä¸€ä¸ªæ•°æ®é¡µï¼Œæ‰€ä»¥ä¼šä¸€æ¬¡æ€§è¯»å– 16KB çš„æ•°æ®åˆ°å†…å­˜ InnoDB å¼•æ“å°†è‹¥å¹²ä¸ªåœ°å€è¿æ¥ç£ç›˜å—ï¼Œä»¥æ­¤æ¥è¾¾åˆ°é¡µçš„å¤§å° 16KB åœ¨æŸ¥è¯¢æ•°æ®æ—¶å¦‚æœä¸€ä¸ªé¡µä¸­çš„æ¯æ¡æ•°æ®éƒ½èƒ½æœ‰åŠ©äºå®šä½æ•°æ®è®°å½•çš„ä½ç½®ï¼Œè¿™å°†ä¼šå‡å°‘ç£ç›˜ I&#x2F;O æ¬¡æ•°ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡ è¶…è¿‡ 16KB çš„ä¸€æ¡è®°å½•ï¼Œä¸»é”®ç´¢å¼•é¡µåªä¼šå­˜å‚¨éƒ¨åˆ†æ•°æ®å’ŒæŒ‡å‘æº¢å‡ºé¡µçš„æŒ‡é’ˆï¼Œå‰©ä½™æ•°æ®éƒ½ä¼šåˆ†æ•£å­˜å‚¨åœ¨æº¢å‡ºé¡µä¸­ æ•°æ®é¡µç‰©ç†ç»“æ„ï¼Œä»ä¸Šåˆ°ä¸‹ï¼š File Headerï¼šä¸Šä¸€é¡µå’Œä¸‹ä¸€é¡µçš„æŒ‡é’ˆã€è¯¥é¡µçš„ç±»å‹ï¼ˆç´¢å¼•é¡µã€æ•°æ®é¡µã€æ—¥å¿—é¡µç­‰ï¼‰ã€æ ¡éªŒå’Œã€LSNï¼ˆæœ€è¿‘ä¸€æ¬¡ä¿®æ”¹å½“å‰é¡µé¢æ—¶çš„ç³»ç»Ÿ lsn å€¼ï¼Œäº‹åŠ¡æŒä¹…æ€§éƒ¨åˆ†è¯¦è§£ï¼‰ç­‰ä¿¡æ¯ Page Headerï¼šè®°å½•çŠ¶æ€ä¿¡æ¯ Infimum + Supremumï¼šå½“å‰é¡µçš„æœ€å°è®°å½•å’Œæœ€å¤§è®°å½•ï¼ˆå¤´å°¾æŒ‡é’ˆï¼‰ï¼ŒInfimum æ‰€åœ¨åˆ†ç»„åªæœ‰ä¸€æ¡è®°å½•ï¼ŒSupremum æ‰€åœ¨åˆ†ç»„å¯ä»¥æœ‰ 1 ~ 8 æ¡è®°å½•ï¼Œå‰©ä½™çš„åˆ†ç»„å¯ä»¥æœ‰ 4 ~ 8 æ¡è®°å½• User Recordsï¼šå­˜å‚¨æ•°æ®çš„è®°å½• Free Spaceï¼šå°šæœªä½¿ç”¨çš„å­˜å‚¨ç©ºé—´ Page Directoryï¼šåˆ†ç»„çš„ç›®å½•ï¼Œå¯ä»¥é€šè¿‡ç›®å½•å¿«é€Ÿå®šä½ï¼ˆäºŒåˆ†æ³•ï¼‰æ•°æ®çš„åˆ†ç»„ File Trailerï¼šæ£€éªŒå’Œå­—æ®µï¼Œåœ¨åˆ·è„è¿‡ç¨‹ä¸­ï¼Œé¡µé¦–å’Œé¡µå°¾çš„æ ¡éªŒå’Œä¸€è‡´æ‰èƒ½è¯´æ˜é¡µé¢åˆ·æ–°æˆåŠŸï¼ŒäºŒè€…ä¸åŒè¯´æ˜åˆ·æ–°æœŸé—´å‘ç”Ÿäº†é”™è¯¯ï¼›LSN å­—æ®µï¼Œä¹Ÿæ˜¯ç”¨æ¥æ ¡éªŒé¡µé¢çš„å®Œæ•´æ€§ æ•°æ®é¡µä¸­åŒ…å«æ•°æ®è¡Œï¼Œæ•°æ®çš„å­˜å‚¨æ˜¯åŸºäºæ•°æ®è¡Œçš„ï¼Œæ•°æ®è¡Œæœ‰ next_record å±æ€§æŒ‡å‘ä¸‹ä¸€ä¸ªè¡Œæ•°æ®ï¼Œæ‰€ä»¥æ˜¯å¯ä»¥éå†çš„ï¼Œä½†æ˜¯ä¸€ç»„æ•°æ®è‡³å¤š 8 ä¸ªè¡Œï¼Œé€šè¿‡ Page Directory å…ˆå®šä½åˆ°ç»„ï¼Œç„¶åéå†è·å–æ‰€éœ€çš„æ•°æ®è¡Œå³å¯ æ•°æ®è¡Œä¸­æœ‰ä¸‰ä¸ªéšè—å­—æ®µï¼štrx_idã€roll_pointerã€row_idï¼ˆåœ¨äº‹åŠ¡ç« èŠ‚ä¼šè¯¦ç»†ä»‹ç»å®ƒä»¬çš„ä½œç”¨ï¼‰ BTreeBTree çš„ç´¢å¼•ç±»å‹æ˜¯åŸºäº B+Tree æ ‘å‹æ•°æ®ç»“æ„çš„ï¼ŒB+Tree åˆæ˜¯ BTree æ•°æ®ç»“æ„çš„å˜ç§ï¼Œç”¨åœ¨æ•°æ®åº“å’Œæ“ä½œç³»ç»Ÿä¸­çš„æ–‡ä»¶ç³»ç»Ÿï¼Œç‰¹ç‚¹æ˜¯èƒ½å¤Ÿä¿æŒæ•°æ®ç¨³å®šæœ‰åº BTree åˆå«å¤šè·¯å¹³è¡¡æœç´¢æ ‘ï¼Œä¸€é¢— m å‰çš„ BTree ç‰¹æ€§å¦‚ä¸‹ï¼š æ ‘ä¸­æ¯ä¸ªèŠ‚ç‚¹æœ€å¤šåŒ…å« m ä¸ªå­©å­ é™¤æ ¹èŠ‚ç‚¹ä¸å¶å­èŠ‚ç‚¹å¤–ï¼Œæ¯ä¸ªèŠ‚ç‚¹è‡³å°‘æœ‰ [ceil(m&#x2F;2)] ä¸ªå­©å­ è‹¥æ ¹èŠ‚ç‚¹ä¸æ˜¯å¶å­èŠ‚ç‚¹ï¼Œåˆ™è‡³å°‘æœ‰ä¸¤ä¸ªå­©å­ æ‰€æœ‰çš„å¶å­èŠ‚ç‚¹éƒ½åœ¨åŒä¸€å±‚ æ¯ä¸ªéå¶å­èŠ‚ç‚¹ç”± n ä¸ª key ä¸ n+1 ä¸ªæŒ‡é’ˆç»„æˆï¼Œå…¶ä¸­ [ceil(m&#x2F;2)-1] &lt;&#x3D; n &lt;&#x3D; m-1 5 å‰ï¼Œkey çš„æ•°é‡ [ceil(m&#x2F;2)-1] &lt;&#x3D; n &lt;&#x3D; m-1 ä¸º 2 &lt;&#x3D; n &lt;&#x3D;4 ï¼Œå½“ n&gt;4 æ—¶ä¸­é—´èŠ‚ç‚¹åˆ†è£‚åˆ°çˆ¶èŠ‚ç‚¹ï¼Œä¸¤è¾¹èŠ‚ç‚¹åˆ†è£‚ æ’å…¥ C N G A H E K Q M F W L T Z D P R X Y S æ•°æ®çš„å·¥ä½œæµç¨‹ï¼š æ’å…¥å‰ 4 ä¸ªå­—æ¯ C N G A æ’å…¥ Hï¼Œn&gt;4ï¼Œä¸­é—´å…ƒç´  G å­—æ¯å‘ä¸Šåˆ†è£‚åˆ°æ–°çš„èŠ‚ç‚¹ æ’å…¥ Eã€Kã€Q ä¸éœ€è¦åˆ†è£‚ æ’å…¥ Mï¼Œä¸­é—´å…ƒç´  M å­—æ¯å‘ä¸Šåˆ†è£‚åˆ°çˆ¶èŠ‚ç‚¹ G æ’å…¥ Fï¼ŒWï¼ŒLï¼ŒT ä¸éœ€è¦åˆ†è£‚ æ’å…¥ Zï¼Œä¸­é—´å…ƒç´  T å‘ä¸Šåˆ†è£‚åˆ°çˆ¶èŠ‚ç‚¹ä¸­ æ’å…¥ Dï¼Œä¸­é—´å…ƒç´  D å‘ä¸Šåˆ†è£‚åˆ°çˆ¶èŠ‚ç‚¹ä¸­ï¼Œç„¶åæ’å…¥ Pï¼ŒRï¼ŒXï¼ŒY ä¸éœ€è¦åˆ†è£‚ æœ€åæ’å…¥ Sï¼ŒNPQR èŠ‚ç‚¹ n&gt;5ï¼Œä¸­é—´èŠ‚ç‚¹ Q å‘ä¸Šåˆ†è£‚ï¼Œä½†åˆ†è£‚åçˆ¶èŠ‚ç‚¹ DGMT çš„ n&gt;5ï¼Œä¸­é—´èŠ‚ç‚¹ M å‘ä¸Šåˆ†è£‚ BTree æ ‘å°±å·²ç»æ„å»ºå®Œæˆäº†ï¼ŒBTree æ ‘å’ŒäºŒå‰æ ‘ç›¸æ¯”ï¼Œ æŸ¥è¯¢æ•°æ®çš„æ•ˆç‡æ›´é«˜ï¼Œ å› ä¸ºå¯¹äºç›¸åŒçš„æ•°æ®é‡æ¥è¯´ï¼ŒBTree çš„å±‚çº§ç»“æ„æ¯”äºŒå‰æ ‘å°‘ï¼Œæ‰€ä»¥æœç´¢é€Ÿåº¦å¿« BTree ç»“æ„çš„æ•°æ®å¯ä»¥è®©ç³»ç»Ÿé«˜æ•ˆçš„æ‰¾åˆ°æ•°æ®æ‰€åœ¨çš„ç£ç›˜å—ï¼Œå®šä¹‰ä¸€æ¡è®°å½•ä¸ºä¸€ä¸ªäºŒå…ƒç»„ [key, data] ï¼Œkey ä¸ºè®°å½•çš„é”®å€¼ï¼Œå¯¹åº”è¡¨ä¸­çš„ä¸»é”®å€¼ï¼Œdata ä¸ºä¸€è¡Œè®°å½•ä¸­é™¤ä¸»é”®å¤–çš„æ•°æ®ã€‚å¯¹äºä¸åŒçš„è®°å½•ï¼Œkey å€¼äº’ä¸ç›¸åŒï¼ŒBTree ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹æ ¹æ®å®é™…æƒ…å†µå¯ä»¥åŒ…å«å¤§é‡çš„å…³é”®å­—ä¿¡æ¯å’Œåˆ†æ”¯ ç¼ºç‚¹ï¼šå½“è¿›è¡ŒèŒƒå›´æŸ¥æ‰¾æ—¶ä¼šå‡ºç°å›æ—‹æŸ¥æ‰¾ B+Treeæ•°æ®ç»“æ„BTree æ•°æ®ç»“æ„ä¸­æ¯ä¸ªèŠ‚ç‚¹ä¸­ä¸ä»…åŒ…å«æ•°æ®çš„ key å€¼ï¼Œè¿˜æœ‰ data å€¼ã€‚ç£ç›˜ä¸­æ¯ä¸€é¡µçš„å­˜å‚¨ç©ºé—´æ˜¯æœ‰é™çš„ï¼Œå¦‚æœ data æ•°æ®è¾ƒå¤§æ—¶å°†ä¼šå¯¼è‡´æ¯ä¸ªèŠ‚ç‚¹ï¼ˆå³ä¸€ä¸ªé¡µï¼‰èƒ½å­˜å‚¨çš„ key çš„æ•°é‡å¾ˆå°ï¼Œå½“å­˜å‚¨çš„æ•°æ®é‡å¾ˆå¤§æ—¶åŒæ ·ä¼šå¯¼è‡´ B-Tree çš„æ·±åº¦è¾ƒå¤§ï¼Œå¢å¤§æŸ¥è¯¢æ—¶çš„ç£ç›˜ I&#x2F;O æ¬¡æ•°ï¼Œè¿›è€Œå½±å“æŸ¥è¯¢æ•ˆç‡ï¼Œæ‰€ä»¥å¼•å…¥ B+Tree B+Tree ä¸º BTree çš„å˜ç§ï¼ŒB+Tree ä¸ BTree çš„åŒºåˆ«ä¸ºï¼š n å‰ B+Tree æœ€å¤šå«æœ‰ n ä¸ª keyï¼ˆå“ˆå¸Œå€¼ï¼‰ï¼Œè€Œ BTree æœ€å¤šå«æœ‰ n-1 ä¸ª key æ‰€æœ‰éå¶å­èŠ‚ç‚¹åªå­˜å‚¨é”®å€¼ key ä¿¡æ¯ï¼Œåªè¿›è¡Œæ•°æ®ç´¢å¼•ï¼Œä½¿æ¯ä¸ªéå¶å­èŠ‚ç‚¹æ‰€èƒ½ä¿å­˜çš„å…³é”®å­—å¤§å¤§å¢åŠ  æ‰€æœ‰æ•°æ®éƒ½å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ï¼Œæ‰€ä»¥æ¯æ¬¡æ•°æ®æŸ¥è¯¢çš„æ¬¡æ•°éƒ½ä¸€æ · å¶å­èŠ‚ç‚¹æŒ‰ç…§ key å¤§å°é¡ºåºæ’åˆ—ï¼Œå·¦è¾¹ç»“å°¾æ•°æ®éƒ½ä¼šä¿å­˜å³è¾¹èŠ‚ç‚¹å¼€å§‹æ•°æ®çš„æŒ‡é’ˆï¼Œå½¢æˆä¸€ä¸ªé“¾è¡¨ æ‰€æœ‰èŠ‚ç‚¹ä¸­çš„ key åœ¨å¶å­èŠ‚ç‚¹ä¸­ä¹Ÿå­˜åœ¨ï¼ˆæ¯”å¦‚ 5)ï¼Œkey å…è®¸é‡å¤ï¼ŒB æ ‘ä¸åŒèŠ‚ç‚¹ä¸å­˜åœ¨é‡å¤çš„ key B* æ ‘ï¼šæ˜¯ B+ æ ‘çš„å˜ä½“ï¼Œåœ¨ B+ æ ‘çš„éæ ¹å’Œéå¶å­ç»“ç‚¹å†å¢åŠ æŒ‡å‘å…„å¼Ÿçš„æŒ‡é’ˆ ä¼˜åŒ–ç»“æ„MySQL ç´¢å¼•æ•°æ®ç»“æ„å¯¹ç»å…¸çš„ B+Tree è¿›è¡Œäº†ä¼˜åŒ–ï¼Œåœ¨åŸ B+Tree çš„åŸºç¡€ä¸Šï¼Œå¢åŠ ä¸€ä¸ªæŒ‡å‘ç›¸é‚»å¶å­èŠ‚ç‚¹çš„é“¾è¡¨æŒ‡é’ˆï¼Œå°±å½¢æˆäº†å¸¦æœ‰é¡ºåºæŒ‡é’ˆçš„ B+Treeï¼Œæé«˜åŒºé—´è®¿é—®çš„æ€§èƒ½ï¼Œé˜²æ­¢å›æ—‹æŸ¥æ‰¾ åŒºé—´è®¿é—®çš„æ„æ€æ˜¯è®¿é—®ç´¢å¼•ä¸º 5 - 15 çš„æ•°æ®ï¼Œå¯ä»¥ç›´æ¥æ ¹æ®ç›¸é‚»èŠ‚ç‚¹çš„æŒ‡é’ˆéå† B+ æ ‘çš„å¶å­èŠ‚ç‚¹æ˜¯æ•°æ®é¡µï¼ˆpageï¼‰ï¼Œä¸€ä¸ªé¡µé‡Œé¢å¯ä»¥å­˜å¤šä¸ªæ•°æ®è¡Œ é€šå¸¸åœ¨ B+Tree ä¸Šæœ‰ä¸¤ä¸ªå¤´æŒ‡é’ˆï¼Œä¸€ä¸ªæŒ‡å‘æ ¹èŠ‚ç‚¹ï¼Œå¦ä¸€ä¸ªæŒ‡å‘å…³é”®å­—æœ€å°çš„å¶å­èŠ‚ç‚¹ï¼Œè€Œä¸”æ‰€æœ‰å¶å­èŠ‚ç‚¹ï¼ˆå³æ•°æ®èŠ‚ç‚¹ï¼‰ä¹‹é—´æ˜¯ä¸€ç§é“¾å¼ç¯ç»“æ„ã€‚å¯ä»¥å¯¹ B+Tree è¿›è¡Œä¸¤ç§æŸ¥æ‰¾è¿ç®—ï¼š æœ‰èŒƒå›´ï¼šå¯¹äºä¸»é”®çš„èŒƒå›´æŸ¥æ‰¾å’Œåˆ†é¡µæŸ¥æ‰¾ æœ‰é¡ºåºï¼šä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œè¿›è¡ŒéšæœºæŸ¥æ‰¾ï¼Œé¡ºåºæŸ¥æ‰¾ InnoDB ä¸­æ¯ä¸ªæ•°æ®é¡µçš„å¤§å°é»˜è®¤æ˜¯ 16KBï¼Œ ç´¢å¼•è¡Œï¼šä¸€èˆ¬è¡¨çš„ä¸»é”®ç±»å‹ä¸º INTï¼ˆ4 å­—èŠ‚ï¼‰æˆ– BIGINTï¼ˆ8 å­—èŠ‚ï¼‰ï¼ŒæŒ‡é’ˆå¤§å°åœ¨ InnoDB ä¸­è®¾ç½®ä¸º 6 å­—èŠ‚èŠ‚ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªé¡µå¤§æ¦‚å­˜å‚¨ 16KB&#x2F;(8B+6B)&#x3D;1K ä¸ªé”®å€¼ï¼ˆä¼°å€¼ï¼‰ã€‚åˆ™ä¸€ä¸ªæ·±åº¦ä¸º 3 çš„ B+Tree ç´¢å¼•å¯ä»¥ç»´æŠ¤ 10^3 * 10^3 * 10^3 = 10äº¿ æ¡è®°å½• æ•°æ®è¡Œï¼šä¸€è¡Œæ•°æ®çš„å¤§å°å¯èƒ½æ˜¯ 1kï¼Œä¸€ä¸ªæ•°æ®é¡µå¯ä»¥å­˜å‚¨ 16 è¡Œ å®é™…æƒ…å†µä¸­æ¯ä¸ªèŠ‚ç‚¹å¯èƒ½ä¸èƒ½å¡«å……æ»¡ï¼Œå› æ­¤åœ¨æ•°æ®åº“ä¸­ï¼ŒB+Tree çš„é«˜åº¦ä¸€èˆ¬éƒ½åœ¨ 2-4 å±‚ã€‚MySQL çš„ InnoDB å­˜å‚¨å¼•æ“åœ¨è®¾è®¡æ—¶æ˜¯å°†æ ¹èŠ‚ç‚¹å¸¸é©»å†…å­˜çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æŸ¥æ‰¾æŸä¸€é”®å€¼çš„è¡Œè®°å½•æ—¶æœ€å¤šåªéœ€è¦ 1~3 æ¬¡ç£ç›˜ I&#x2F;O æ“ä½œ B+Tree ä¼˜ç‚¹ï¼šæé«˜æŸ¥è¯¢é€Ÿåº¦ï¼Œå‡å°‘ç£ç›˜çš„ IO æ¬¡æ•°ï¼Œæ ‘å½¢ç»“æ„è¾ƒå° ç´¢å¼•ç»´æŠ¤B+ æ ‘ä¸ºäº†ä¿æŒç´¢å¼•çš„æœ‰åºæ€§ï¼Œåœ¨æ’å…¥æ–°å€¼çš„æ—¶å€™éœ€è¦åšç›¸åº”çš„ç»´æŠ¤ æ¯ä¸ªç´¢å¼•ä¸­æ¯ä¸ªå—å­˜å‚¨åœ¨ç£ç›˜é¡µä¸­ï¼Œå¯èƒ½ä¼šå‡ºç°ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š å¦‚æœæ‰€åœ¨çš„æ•°æ®é¡µå·²ç»æ»¡äº†ï¼Œè¿™æ—¶å€™éœ€è¦ç”³è¯·ä¸€ä¸ªæ–°çš„æ•°æ®é¡µï¼Œç„¶åæŒªåŠ¨éƒ¨åˆ†æ•°æ®è¿‡å»ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºé¡µåˆ†è£‚ï¼ŒåŸæœ¬æ”¾åœ¨ä¸€ä¸ªé¡µçš„æ•°æ®ç°åœ¨åˆ†åˆ°ä¸¤ä¸ªé¡µä¸­ï¼Œé™ä½äº†ç©ºé—´åˆ©ç”¨ç‡ å½“ç›¸é‚»ä¸¤ä¸ªé¡µç”±äºåˆ é™¤äº†æ•°æ®ï¼Œåˆ©ç”¨ç‡å¾ˆä½ä¹‹åï¼Œä¼šå°†æ•°æ®é¡µåšé¡µåˆå¹¶ï¼Œåˆå¹¶çš„è¿‡ç¨‹å¯ä»¥è®¤ä¸ºæ˜¯åˆ†è£‚è¿‡ç¨‹çš„é€†è¿‡ç¨‹ è¿™ä¸¤ä¸ªæƒ…å†µéƒ½æ˜¯ç”± B+ æ ‘çš„ç»“æ„å†³å®šçš„ ä¸€èˆ¬é€‰ç”¨æ•°æ®å°çš„å­—æ®µåšç´¢å¼•ï¼Œå­—æ®µé•¿åº¦è¶Šå°ï¼Œæ™®é€šç´¢å¼•çš„å¶å­èŠ‚ç‚¹å°±è¶Šå°ï¼Œæ™®é€šç´¢å¼•å ç”¨çš„ç©ºé—´ä¹Ÿå°±è¶Šå° è‡ªå¢ä¸»é”®çš„æ’å…¥æ•°æ®æ¨¡å¼ï¼Œå¯ä»¥è®©ä¸»é”®ç´¢å¼•å°½é‡åœ°ä¿æŒé€’å¢é¡ºåºæ’å…¥ï¼Œä¸æ¶‰åŠåˆ°æŒªåŠ¨å…¶ä»–è®°å½•ï¼Œé¿å…äº†é¡µåˆ†è£‚ï¼Œé¡µåˆ†è£‚çš„ç›®çš„å°±æ˜¯ä¿è¯åä¸€ä¸ªæ•°æ®é¡µä¸­çš„æ‰€æœ‰è¡Œä¸»é”®å€¼æ¯”å‰ä¸€ä¸ªæ•°æ®é¡µä¸­ä¸»é”®å€¼å¤§ å‚è€ƒæ–‡ç« ï¼šhttps://developer.aliyun.com/article/919861 è®¾è®¡åŸåˆ™ç´¢å¼•çš„è®¾è®¡å¯ä»¥éµå¾ªä¸€äº›å·²æœ‰çš„åŸåˆ™ï¼Œåˆ›å»ºç´¢å¼•çš„æ—¶å€™è¯·å°½é‡è€ƒè™‘ç¬¦åˆè¿™äº›åŸåˆ™ï¼Œä¾¿äºæå‡ç´¢å¼•çš„ä½¿ç”¨æ•ˆç‡ åˆ›å»ºç´¢å¼•æ—¶çš„åŸåˆ™ï¼š å¯¹æŸ¥è¯¢é¢‘æ¬¡è¾ƒé«˜ï¼Œä¸”æ•°æ®é‡æ¯”è¾ƒå¤§çš„è¡¨å»ºç«‹ç´¢å¼• ä½¿ç”¨å”¯ä¸€ç´¢å¼•ï¼ŒåŒºåˆ†åº¦è¶Šé«˜ï¼Œä½¿ç”¨ç´¢å¼•çš„æ•ˆç‡è¶Šé«˜ ç´¢å¼•å­—æ®µçš„é€‰æ‹©ï¼Œæœ€ä½³å€™é€‰åˆ—åº”å½“ä» where å­å¥çš„æ¡ä»¶ä¸­æå–ï¼Œä½¿ç”¨è¦†ç›–ç´¢å¼• ä½¿ç”¨çŸ­ç´¢å¼•ï¼Œç´¢å¼•åˆ›å»ºä¹‹åä¹Ÿæ˜¯ä½¿ç”¨ç¡¬ç›˜æ¥å­˜å‚¨çš„ï¼Œå› æ­¤æå‡ç´¢å¼•è®¿é—®çš„ I&#x2F;O æ•ˆç‡ï¼Œä¹Ÿå¯ä»¥æå‡æ€»ä½“çš„è®¿é—®æ•ˆç‡ã€‚å‡å¦‚æ„æˆç´¢å¼•çš„å­—æ®µæ€»é•¿åº¦æ¯”è¾ƒçŸ­ï¼Œé‚£ä¹ˆåœ¨ç»™å®šå¤§å°çš„å­˜å‚¨å—å†…å¯ä»¥å­˜å‚¨æ›´å¤šçš„ç´¢å¼•å€¼ï¼Œç›¸åº”çš„å¯ä»¥æœ‰æ•ˆçš„æå‡ MySQL è®¿é—®ç´¢å¼•çš„ I&#x2F;O æ•ˆç‡ ç´¢å¼•å¯ä»¥æœ‰æ•ˆçš„æå‡æŸ¥è¯¢æ•°æ®çš„æ•ˆç‡ï¼Œä½†ç´¢å¼•æ•°é‡ä¸æ˜¯å¤šå¤šç›Šå–„ï¼Œç´¢å¼•è¶Šå¤šï¼Œç»´æŠ¤ç´¢å¼•çš„ä»£ä»·è¶Šé«˜ã€‚å¯¹äºæ’å…¥ã€æ›´æ–°ã€åˆ é™¤ç­‰ DML æ“ä½œæ¯”è¾ƒé¢‘ç¹çš„è¡¨æ¥è¯´ï¼Œç´¢å¼•è¿‡å¤šï¼Œä¼šå¼•å…¥ç›¸å½“é«˜çš„ç»´æŠ¤ä»£ä»·ï¼Œé™ä½ DML æ“ä½œçš„æ•ˆç‡ï¼Œå¢åŠ ç›¸åº”æ“ä½œçš„æ—¶é—´æ¶ˆè€—ï¼›å¦å¤–ç´¢å¼•è¿‡å¤šçš„è¯ï¼ŒMySQL ä¹Ÿä¼šçŠ¯é€‰æ‹©å›°éš¾ç—…ï¼Œè™½ç„¶æœ€ç»ˆä»ç„¶ä¼šæ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„ç´¢å¼•ï¼Œä½†æé«˜äº†é€‰æ‹©çš„ä»£ä»· MySQL å»ºç«‹è”åˆç´¢å¼•æ—¶ä¼šéµå®ˆæœ€å·¦å‰ç¼€åŒ¹é…åŸåˆ™ï¼Œå³æœ€å·¦ä¼˜å…ˆï¼Œåœ¨æ£€ç´¢æ•°æ®æ—¶ä»è”åˆç´¢å¼•çš„æœ€å·¦è¾¹å¼€å§‹åŒ¹é… N ä¸ªåˆ—ç»„åˆè€Œæˆçš„ç»„åˆç´¢å¼•ï¼Œç›¸å½“äºåˆ›å»ºäº† N ä¸ªç´¢å¼•ï¼Œå¦‚æœæŸ¥è¯¢æ—¶ where å¥ä¸­ä½¿ç”¨äº†ç»„æˆè¯¥ç´¢å¼•çš„å‰å‡ ä¸ªå­—æ®µï¼Œé‚£ä¹ˆè¿™æ¡æŸ¥è¯¢ SQL å¯ä»¥åˆ©ç”¨ç»„åˆç´¢å¼•æ¥æå‡æŸ¥è¯¢æ•ˆç‡ 12345678910-- å¯¹nameã€addressã€phoneåˆ—å»ºä¸€ä¸ªè”åˆç´¢å¼•ALTER TABLE user ADD INDEX index_three(name,address,phone);-- æŸ¥è¯¢è¯­å¥æ‰§è¡Œæ—¶ä¼šä¾ç…§æœ€å·¦å‰ç¼€åŒ¹é…åŸåˆ™ï¼Œæ£€ç´¢æ—¶åˆ†åˆ«ä¼šä½¿ç”¨ç´¢å¼•è¿›è¡Œæ•°æ®åŒ¹é…ã€‚(name,address,phone)(name,address)(name,phone) -- åªæœ‰nameå­—æ®µèµ°äº†ç´¢å¼•(name)-- ç´¢å¼•çš„å­—æ®µå¯ä»¥æ˜¯ä»»æ„é¡ºåºçš„ï¼Œä¼˜åŒ–å™¨ä¼šå¸®åŠ©æˆ‘ä»¬è°ƒæ•´é¡ºåºï¼Œä¸‹é¢çš„SQLè¯­å¥å¯ä»¥å‘½ä¸­ç´¢å¼•SELECT * FROM user WHERE address = &#x27;åŒ—äº¬&#x27; AND phone = &#x27;12345&#x27; AND name = &#x27;å¼ ä¸‰&#x27;; 12-- å¦‚æœè”åˆç´¢å¼•ä¸­æœ€å·¦è¾¹çš„åˆ—ä¸åŒ…å«åœ¨æ¡ä»¶æŸ¥è¯¢ä¸­ï¼ŒSQLè¯­å¥å°±ä¸ä¼šå‘½ä¸­ç´¢å¼•ï¼Œæ¯”å¦‚ï¼šSELECT * FROM user WHERE address = &#x27;åŒ—äº¬&#x27; AND phone = &#x27;12345&#x27;; å“ªäº›æƒ…å†µä¸è¦å»ºç«‹ç´¢å¼•ï¼š è®°å½•å¤ªå°‘çš„è¡¨ ç»å¸¸å¢åˆ æ”¹çš„è¡¨ é¢‘ç¹æ›´æ–°çš„å­—æ®µä¸é€‚åˆåˆ›å»ºç´¢å¼• where æ¡ä»¶é‡Œç”¨ä¸åˆ°çš„å­—æ®µä¸åˆ›å»ºç´¢å¼• ç´¢å¼•ä¼˜åŒ–è¦†ç›–ç´¢å¼•è¦†ç›–ç´¢å¼•ï¼šåŒ…å«æ‰€æœ‰æ»¡è¶³æŸ¥è¯¢éœ€è¦çš„æ•°æ®çš„ç´¢å¼•ï¼ˆSELECT åé¢çš„å­—æ®µåˆšå¥½æ˜¯ç´¢å¼•å­—æ®µï¼‰ï¼Œå¯ä»¥åˆ©ç”¨è¯¥ç´¢å¼•è¿”å› SELECT åˆ—è¡¨çš„å­—æ®µï¼Œè€Œä¸å¿…æ ¹æ®ç´¢å¼•å»èšç°‡ç´¢å¼•ä¸Šè¯»å–æ•°æ®æ–‡ä»¶ å›è¡¨æŸ¥è¯¢ï¼šè¦æŸ¥æ‰¾çš„å­—æ®µä¸åœ¨éä¸»é”®ç´¢å¼•æ ‘ä¸Šæ—¶ï¼Œéœ€è¦é€šè¿‡å¶å­èŠ‚ç‚¹çš„ä¸»é”®å€¼å»ä¸»é”®ç´¢å¼•ä¸Šè·å–å¯¹åº”çš„è¡Œæ•°æ® ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œé˜²æ­¢å›è¡¨æŸ¥è¯¢ï¼š è¡¨ user ä¸»é”®ä¸º idï¼Œæ™®é€šç´¢å¼•ä¸º ageï¼ŒæŸ¥è¯¢è¯­å¥ï¼š 1SELECT * FROM user WHERE age = 30; æŸ¥è¯¢è¿‡ç¨‹ï¼šå…ˆé€šè¿‡æ™®é€šç´¢å¼• age&#x3D;30 å®šä½åˆ°ä¸»é”®å€¼ id&#x3D;1ï¼Œå†é€šè¿‡èšé›†ç´¢å¼• id&#x3D;1 å®šä½åˆ°è¡Œè®°å½•æ•°æ®ï¼Œéœ€è¦ä¸¤æ¬¡æ‰«æ B+ æ ‘ ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼š 123DROP INDEX idx_age ON user;CREATE INDEX idx_age_name ON user(age,name);SELECT id,age FROM user WHERE age = 30; åœ¨ä¸€æ£µç´¢å¼•æ ‘ä¸Šå°±èƒ½è·å–æŸ¥è¯¢æ‰€éœ€çš„æ•°æ®ï¼Œæ— éœ€å›è¡¨é€Ÿåº¦æ›´å¿« ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œè¦æ³¨æ„ SELECT åˆ—è¡¨ä¸­åªå–å‡ºéœ€è¦çš„åˆ—ï¼Œä¸å¯ç”¨ SELECT *ï¼Œæ‰€æœ‰å­—æ®µä¸€èµ·åšç´¢å¼•ä¼šå¯¼è‡´ç´¢å¼•æ–‡ä»¶è¿‡å¤§ï¼ŒæŸ¥è¯¢æ€§èƒ½ä¸‹é™ ç´¢å¼•ä¸‹æ¨ç´¢å¼•æ¡ä»¶ä¸‹æ¨ä¼˜åŒ–ï¼ˆIndex Condition Pushdownï¼ŒICPï¼‰æ˜¯ MySQL5.6 æ·»åŠ ï¼Œå¯ä»¥åœ¨ç´¢å¼•éå†è¿‡ç¨‹ä¸­ï¼Œå¯¹ç´¢å¼•ä¸­åŒ…å«çš„å­—æ®µå…ˆåšåˆ¤æ–­ï¼Œç›´æ¥è¿‡æ»¤æ‰ä¸æ»¡è¶³æ¡ä»¶çš„è®°å½•ï¼Œå‡å°‘å›è¡¨æ¬¡æ•° ç´¢å¼•ä¸‹æ¨å……åˆ†åˆ©ç”¨äº†ç´¢å¼•ä¸­çš„æ•°æ®ï¼Œåœ¨æŸ¥è¯¢å‡ºæ•´è¡Œæ•°æ®ä¹‹å‰è¿‡æ»¤æ‰æ— æ•ˆçš„æ•°æ®ï¼Œå†å»ä¸»é”®ç´¢å¼•æ ‘ä¸ŠæŸ¥æ‰¾ ä¸ä½¿ç”¨ç´¢å¼•ä¸‹æ¨ä¼˜åŒ–æ—¶å­˜å‚¨å¼•æ“é€šè¿‡ç´¢å¼•æ£€ç´¢åˆ°æ•°æ®ï¼Œç„¶åå›è¡¨æŸ¥è¯¢è®°å½•è¿”å›ç»™ Server å±‚ï¼ŒæœåŠ¡å™¨åˆ¤æ–­æ•°æ®æ˜¯å¦ç¬¦åˆæ¡ä»¶ ä½¿ç”¨ç´¢å¼•ä¸‹æ¨ä¼˜åŒ–æ—¶ï¼Œå¦‚æœå­˜åœ¨æŸäº›è¢«ç´¢å¼•çš„åˆ—çš„åˆ¤æ–­æ¡ä»¶æ—¶ï¼Œç”±å­˜å‚¨å¼•æ“åœ¨ç´¢å¼•éå†çš„è¿‡ç¨‹ä¸­åˆ¤æ–­æ•°æ®æ˜¯å¦ç¬¦åˆä¼ é€’çš„æ¡ä»¶ï¼Œå°†ç¬¦åˆæ¡ä»¶çš„æ•°æ®è¿›è¡Œå›è¡¨ï¼Œæ£€ç´¢å‡ºæ¥è¿”å›ç»™æœåŠ¡å™¨ï¼Œç”±æ­¤å‡å°‘ IO æ¬¡æ•° é€‚ç”¨æ¡ä»¶ï¼š éœ€è¦å­˜å‚¨å¼•æ“å°†ç´¢å¼•ä¸­çš„æ•°æ®ä¸æ¡ä»¶è¿›è¡Œåˆ¤æ–­ï¼ˆæ‰€ä»¥æ¡ä»¶åˆ—å¿…é¡»éƒ½åœ¨åŒä¸€ä¸ªç´¢å¼•ä¸­ï¼‰ï¼Œæ‰€ä»¥ä¼˜åŒ–æ˜¯åŸºäºå­˜å‚¨å¼•æ“çš„ï¼Œåªæœ‰ç‰¹å®šå¼•æ“å¯ä»¥ä½¿ç”¨ï¼Œé€‚ç”¨äº InnoDB å’Œ MyISAM å­˜å‚¨å¼•æ“æ²¡æœ‰è°ƒç”¨è·¨å­˜å‚¨å¼•æ“çš„èƒ½åŠ›ï¼Œè·¨å­˜å‚¨å¼•æ“çš„åŠŸèƒ½æœ‰å­˜å‚¨è¿‡ç¨‹ã€è§¦å‘å™¨ã€è§†å›¾ï¼Œæ‰€ä»¥è°ƒç”¨è¿™äº›åŠŸèƒ½çš„ä¸å¯ä»¥è¿›è¡Œç´¢å¼•ä¸‹æ¨ä¼˜åŒ– å¯¹äº InnoDB å¼•æ“åªé€‚ç”¨äºäºŒçº§ç´¢å¼•ï¼ŒInnoDB çš„èšç°‡ç´¢å¼•ä¼šå°†æ•´è¡Œæ•°æ®è¯»åˆ°ç¼“å†²åŒºï¼Œä¸å†éœ€è¦å»å›è¡¨æŸ¥è¯¢äº† å·¥ä½œè¿‡ç¨‹ï¼šç”¨æˆ·è¡¨ userï¼Œ(name, age) æ˜¯è”åˆç´¢å¼• 1SELECT * FROM user WHERE name LIKE &#x27;å¼ %&#x27; AND age = 10; -- å¤´éƒ¨æ¨¡ç³ŠåŒ¹é…ä¼šé€ æˆç´¢å¼•å¤±æ•ˆ ä¼˜åŒ–å‰ï¼šåœ¨éä¸»é”®ç´¢å¼•æ ‘ä¸Šæ‰¾åˆ°æ»¡è¶³ç¬¬ä¸€ä¸ªæ¡ä»¶çš„è¡Œï¼Œç„¶åé€šè¿‡å¶å­èŠ‚ç‚¹è®°å½•çš„ä¸»é”®å€¼å†å›åˆ°ä¸»é”®ç´¢å¼•æ ‘ä¸ŠæŸ¥æ‰¾åˆ°å¯¹åº”çš„è¡Œæ•°æ®ï¼Œå†å¯¹æ¯” AND åçš„æ¡ä»¶æ˜¯å¦ç¬¦åˆï¼Œç¬¦åˆè¿”å›æ•°æ®ï¼Œéœ€è¦ 4 æ¬¡å›è¡¨ ä¼˜åŒ–åï¼šæ£€æŸ¥ç´¢å¼•ä¸­å­˜å‚¨çš„åˆ—ä¿¡æ¯æ˜¯å¦ç¬¦åˆç´¢å¼•æ¡ä»¶ï¼Œç„¶åäº¤ç”±å­˜å‚¨å¼•æ“ç”¨å‰©ä½™çš„åˆ¤æ–­æ¡ä»¶åˆ¤æ–­æ­¤è¡Œæ•°æ®æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼Œä¸æ»¡è¶³æ¡ä»¶çš„ä¸å»è¯»å–è¡¨ä¸­çš„æ•°æ®ï¼Œæ»¡è¶³ä¸‹æ¨æ¡ä»¶çš„å°±æ ¹æ®ä¸»é”®å€¼è¿›è¡Œå›è¡¨æŸ¥è¯¢ï¼Œ2 æ¬¡å›è¡¨ å½“ä½¿ç”¨ EXPLAIN è¿›è¡Œåˆ†ææ—¶ï¼Œå¦‚æœä½¿ç”¨äº†ç´¢å¼•æ¡ä»¶ä¸‹æ¨ï¼ŒExtra ä¼šæ˜¾ç¤º Using index condition å‚è€ƒæ–‡ç« ï¼šhttps://blog.csdn.net/sinat_29774479/article/details/103470244 å‚è€ƒæ–‡ç« ï¼šhttps://time.geekbang.org/column/article/69636 å‰ç¼€ç´¢å¼•å½“è¦ç´¢å¼•çš„åˆ—å­—ç¬¦å¾ˆå¤šæ—¶ï¼Œç´¢å¼•ä¼šå˜å¤§å˜æ…¢ï¼Œå¯ä»¥åªç´¢å¼•åˆ—å¼€å§‹çš„éƒ¨åˆ†å­—ç¬¦ä¸²ï¼ŒèŠ‚çº¦ç´¢å¼•ç©ºé—´ï¼Œæé«˜ç´¢å¼•æ•ˆç‡ æ³¨æ„ï¼šä½¿ç”¨å‰ç¼€ç´¢å¼•å°±ç³»ç»Ÿå°±å¿½ç•¥è¦†ç›–ç´¢å¼•å¯¹æŸ¥è¯¢æ€§èƒ½çš„ä¼˜åŒ–äº† ä¼˜åŒ–åŸåˆ™ï¼šé™ä½é‡å¤çš„ç´¢å¼•å€¼ æ¯”å¦‚åœ°åŒºè¡¨ï¼š 123456area gdp codechinaShanghai 100 aaachinaDalian 200 bbbusaNewYork 300 cccchinaFuxin 400 dddchinaBeijing 500 eee å‘ç° area å­—æ®µå¾ˆå¤šéƒ½æ˜¯ä»¥ china å¼€å¤´çš„ï¼Œé‚£ä¹ˆå¦‚æœä»¥å‰ 1-5 ä½å­—ç¬¦åšå‰ç¼€ç´¢å¼•å°±ä¼šå‡ºç°å¤§é‡ç´¢å¼•å€¼é‡å¤çš„æƒ…å†µï¼Œç´¢å¼•å€¼é‡å¤æ€§è¶Šä½ï¼ŒæŸ¥è¯¢æ•ˆç‡ä¹Ÿå°±è¶Šé«˜ï¼Œæ‰€ä»¥éœ€è¦å»ºç«‹å‰ 6 ä½å­—ç¬¦çš„ç´¢å¼•ï¼š 1CREATE INDEX idx_area ON table_name(area(7)); åœºæ™¯ï¼šå­˜å‚¨èº«ä»½è¯ ç›´æ¥åˆ›å»ºå®Œæ•´ç´¢å¼•ï¼Œè¿™æ ·å¯èƒ½æ¯”è¾ƒå ç”¨ç©ºé—´ åˆ›å»ºå‰ç¼€ç´¢å¼•ï¼ŒèŠ‚çœç©ºé—´ï¼Œä½†ä¼šå¢åŠ æŸ¥è¯¢æ‰«ææ¬¡æ•°ï¼Œå¹¶ä¸”ä¸èƒ½ä½¿ç”¨è¦†ç›–ç´¢å¼• å€’åºå­˜å‚¨ï¼Œå†åˆ›å»ºå‰ç¼€ç´¢å¼•ï¼Œç”¨äºç»•è¿‡å­—ç¬¦ä¸²æœ¬èº«å‰ç¼€çš„åŒºåˆ†åº¦ä¸å¤Ÿçš„é—®é¢˜ï¼ˆå‰ 6 ä½ç›¸åŒçš„å¾ˆå¤šï¼‰ åˆ›å»º hash å­—æ®µç´¢å¼•ï¼ŒæŸ¥è¯¢æ€§èƒ½ç¨³å®šï¼Œæœ‰é¢å¤–çš„å­˜å‚¨å’Œè®¡ç®—æ¶ˆè€—ï¼Œè·Ÿç¬¬ä¸‰ç§æ–¹å¼ä¸€æ ·ï¼Œéƒ½ä¸æ”¯æŒèŒƒå›´æ‰«æ ç´¢å¼•åˆå¹¶ä½¿ç”¨å¤šä¸ªç´¢å¼•æ¥å®Œæˆä¸€æ¬¡æŸ¥è¯¢çš„æ‰§è¡Œæ–¹æ³•å«åšç´¢å¼•åˆå¹¶ index merge Intersection ç´¢å¼•åˆå¹¶ï¼š 1SELECT * FROM table_test WHERE key1 = &#x27;a&#x27; AND key3 = &#x27;b&#x27;; # key1 å’Œ key3 åˆ—éƒ½æ˜¯å•åˆ—ç´¢å¼•ã€äºŒçº§ç´¢å¼• ä»ä¸åŒç´¢å¼•ä¸­æ‰«æåˆ°çš„è®°å½•çš„ id å€¼å–äº¤é›†ï¼ˆç›¸åŒ idï¼‰ï¼Œç„¶åæ‰§è¡Œå›è¡¨æ“ä½œï¼Œè¦æ±‚ä»æ¯ä¸ªäºŒçº§ç´¢å¼•è·å–åˆ°çš„è®°å½•éƒ½æ˜¯æŒ‰ç…§ä¸»é”®å€¼æ’åº Union ç´¢å¼•åˆå¹¶ï¼š 1SELECT * FROM table_test WHERE key1 = &#x27;a&#x27; OR key3 = &#x27;b&#x27;; ä»ä¸åŒç´¢å¼•ä¸­æ‰«æåˆ°çš„è®°å½•çš„ id å€¼å–å¹¶é›†ï¼Œç„¶åæ‰§è¡Œå›è¡¨æ“ä½œï¼Œè¦æ±‚ä»æ¯ä¸ªäºŒçº§ç´¢å¼•è·å–åˆ°çš„è®°å½•éƒ½æ˜¯æŒ‰ç…§ä¸»é”®å€¼æ’åº Sort-Union ç´¢å¼•åˆå¹¶ 1SELECT * FROM table_test WHERE key1 &lt; &#x27;a&#x27; OR key3 &gt; &#x27;b&#x27;; å…ˆå°†ä»ä¸åŒç´¢å¼•ä¸­æ‰«æåˆ°çš„è®°å½•çš„ä¸»é”®å€¼è¿›è¡Œæ’åºï¼Œå†æŒ‰ç…§ Union ç´¢å¼•åˆå¹¶çš„æ–¹å¼è¿›è¡ŒæŸ¥è¯¢ ç´¢å¼•åˆå¹¶ç®—æ³•çš„æ•ˆç‡å¹¶ä¸å¥½ï¼Œé€šè¿‡å°†å…¶ä¸­çš„ä¸€ä¸ªç´¢å¼•æ”¹æˆè”åˆç´¢å¼•ä¼šä¼˜åŒ–æ•ˆç‡ ç³»ç»Ÿä¼˜åŒ–è¡¨ä¼˜åŒ–åˆ†åŒºè¡¨åŸºæœ¬ä»‹ç»åˆ†åŒºè¡¨æ˜¯å°†å¤§è¡¨çš„æ•°æ®æŒ‰åˆ†åŒºå­—æ®µåˆ†æˆè®¸å¤šå°çš„å­é›†ï¼Œå»ºç«‹ä¸€ä¸ªä»¥ ftime å¹´ä»½ä¸ºåˆ†åŒºçš„è¡¨ï¼š 1234567891011CREATE TABLE `t` ( `ftime` datetime NOT NULL, `c` int(11) DEFAULT NULL, KEY (`ftime`)) ENGINE=InnoDB DEFAULT CHARSET=latin1PARTITION BY RANGE (YEAR(ftime))(PARTITION p_2017 VALUES LESS THAN (2017) ENGINE = InnoDB, PARTITION p_2018 VALUES LESS THAN (2018) ENGINE = InnoDB, PARTITION p_2019 VALUES LESS THAN (2019) ENGINE = InnoDB, PARTITION p_others VALUES LESS THAN MAXVALUE ENGINE = InnoDB);INSERT INTO t VALUES(&#x27;2017-4-1&#x27;,1),(&#x27;2018-4-1&#x27;,1);-- è¿™ä¸¤è¡Œè®°å½•åˆ†åˆ«è½åœ¨ p_2018 å’Œ p_2019 è¿™ä¸¤ä¸ªåˆ†åŒºä¸Š è¿™ä¸ªè¡¨åŒ…å«äº†ä¸€ä¸ª.frm æ–‡ä»¶å’Œ 4 ä¸ª.ibd æ–‡ä»¶ï¼Œæ¯ä¸ªåˆ†åŒºå¯¹åº”ä¸€ä¸ª.ibd æ–‡ä»¶ å¯¹äºå¼•æ“å±‚æ¥è¯´ï¼Œè¿™æ˜¯ 4 ä¸ªè¡¨ï¼Œé’ˆå¯¹æ¯ä¸ªåˆ†åŒºè¡¨çš„æ“ä½œä¸ä¼šç›¸äº’å½±å“ å¯¹äº Server å±‚æ¥è¯´ï¼Œè¿™æ˜¯ 1 ä¸ªè¡¨ åˆ†åŒºç­–ç•¥æ‰“å¼€è¡¨è¡Œä¸ºï¼šç¬¬ä¸€æ¬¡è®¿é—®ä¸€ä¸ªåˆ†åŒºè¡¨æ—¶ï¼ŒMySQL éœ€è¦æŠŠæ‰€æœ‰çš„åˆ†åŒºéƒ½è®¿é—®ä¸€éï¼Œå¦‚æœåˆ†åŒºè¡¨çš„æ•°é‡å¾ˆå¤šï¼Œè¶…è¿‡äº† open_files_limit å‚æ•°ï¼ˆé»˜è®¤å€¼ 1024ï¼‰ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨è®¿é—®è¿™ä¸ªè¡¨æ—¶æ‰“å¼€æ‰€æœ‰çš„æ–‡ä»¶ï¼Œå¯¼è‡´æ‰“å¼€è¡¨æ–‡ä»¶çš„ä¸ªæ•°è¶…è¿‡äº†ä¸Šé™è€ŒæŠ¥é”™ é€šç”¨åˆ†åŒºç­–ç•¥ï¼šMyISAM åˆ†åŒºè¡¨ä½¿ç”¨çš„åˆ†åŒºç­–ç•¥ï¼Œæ¯æ¬¡è®¿é—®åˆ†åŒºéƒ½ç”± Server å±‚æ§åˆ¶ï¼Œåœ¨æ–‡ä»¶ç®¡ç†ã€è¡¨ç®¡ç†çš„å®ç°ä¸Šå¾ˆç²—ç³™ï¼Œå› æ­¤æœ‰æ¯”è¾ƒä¸¥é‡çš„æ€§èƒ½é—®é¢˜ æœ¬åœ°åˆ†åŒºç­–ç•¥ï¼šä» MySQL 5.7.9 å¼€å§‹ï¼ŒInnoDB å¼•æ“å†…éƒ¨è‡ªå·±ç®¡ç†æ‰“å¼€åˆ†åŒºçš„è¡Œä¸ºï¼ŒInnoDB å¼•æ“æ‰“å¼€æ–‡ä»¶è¶…è¿‡ innodb_open_files æ—¶å°±ä¼šå…³æ‰ä¸€äº›ä¹‹å‰æ‰“å¼€çš„æ–‡ä»¶ï¼Œæ‰€ä»¥å³ä½¿åˆ†åŒºä¸ªæ•°å¤§äº open_files_limitï¼Œä¹Ÿä¸ä¼šæŠ¥é”™ ä» MySQL 8.0 ç‰ˆæœ¬å¼€å§‹ï¼Œå°±ä¸å…è®¸åˆ›å»º MyISAM åˆ†åŒºè¡¨ï¼Œåªå…è®¸åˆ›å»ºå·²ç»å®ç°äº†æœ¬åœ°åˆ†åŒºç­–ç•¥çš„å¼•æ“ï¼Œç›®å‰åªæœ‰ InnoDB å’Œ NDB è¿™ä¸¤ä¸ªå¼•æ“æ”¯æŒäº†æœ¬åœ°åˆ†åŒºç­–ç•¥ Server å±‚ä» Server å±‚çœ‹ä¸€ä¸ªåˆ†åŒºè¡¨å°±åªæ˜¯ä¸€ä¸ªè¡¨ Session Aï¼š 1SELECT * FROM t WHERE ftime = &#x27;2018-4-1&#x27;; Session Bï¼š 1ALTER TABLE t TRUNCATE PARTITION p_2017; -- blocked ç°è±¡ï¼šSession B åªæ“ä½œ p_2017 åˆ†åŒºï¼Œä½†æ˜¯ç”±äº Session A æŒæœ‰æ•´ä¸ªè¡¨ t çš„ MDL è¯»é”ï¼Œå°±å¯¼è‡´ B çš„ ALTER è¯­å¥è·å– MDL å†™é”é˜»å¡ åˆ†åŒºè¡¨çš„ç‰¹ç‚¹ï¼š ç¬¬ä¸€æ¬¡è®¿é—®çš„æ—¶å€™éœ€è¦è®¿é—®æ‰€æœ‰åˆ†åŒº åœ¨ Server å±‚è®¤ä¸ºè¿™æ˜¯åŒä¸€å¼ è¡¨ï¼Œå› æ­¤æ‰€æœ‰åˆ†åŒºå…±ç”¨åŒä¸€ä¸ª MDL é” åœ¨å¼•æ“å±‚è®¤ä¸ºè¿™æ˜¯ä¸åŒçš„è¡¨ï¼Œå› æ­¤ MDL é”ä¹‹åçš„æ‰§è¡Œè¿‡ç¨‹ï¼Œä¼šæ ¹æ®åˆ†åŒºè¡¨è§„åˆ™ï¼Œåªè®¿é—®éœ€è¦çš„åˆ†åŒº åº”ç”¨åœºæ™¯åˆ†åŒºè¡¨çš„ä¼˜ç‚¹ï¼š å¯¹ä¸šåŠ¡é€æ˜ï¼Œç›¸å¯¹äºç”¨æˆ·åˆ†è¡¨æ¥è¯´ï¼Œä½¿ç”¨åˆ†åŒºè¡¨çš„ä¸šåŠ¡ä»£ç æ›´ç®€æ´ åˆ†åŒºè¡¨å¯ä»¥å¾ˆæ–¹ä¾¿çš„æ¸…ç†å†å²æ•°æ®ã€‚æŒ‰ç…§æ—¶é—´åˆ†åŒºçš„åˆ†åŒºè¡¨ï¼Œå°±å¯ä»¥ç›´æ¥é€šè¿‡ alter table t drop partition è¿™ä¸ªè¯­æ³•ç›´æ¥åˆ é™¤åˆ†åŒºæ–‡ä»¶ï¼Œä»è€Œåˆ æ‰è¿‡æœŸçš„å†å²æ•°æ®ï¼Œä¸ä½¿ç”¨ drop è¯­å¥åˆ é™¤æ•°æ®ç›¸æ¯”ï¼Œä¼˜åŠ¿æ˜¯é€Ÿåº¦å¿«ã€å¯¹ç³»ç»Ÿå½±å“å° ä½¿ç”¨åˆ†åŒºè¡¨ï¼Œä¸å»ºè®®åˆ›å»ºå¤ªå¤šçš„åˆ†åŒºï¼Œæ³¨æ„äº‹é¡¹ï¼š åˆ†åŒºå¹¶ä¸æ˜¯è¶Šç»†è¶Šå¥½ï¼Œå•è¡¨æˆ–è€…å•åˆ†åŒºçš„æ•°æ®ä¸€åƒä¸‡è¡Œï¼Œåªè¦æ²¡æœ‰ç‰¹åˆ«å¤§çš„ç´¢å¼•ï¼Œå¯¹äºç°åœ¨çš„ç¡¬ä»¶èƒ½åŠ›æ¥è¯´éƒ½å·²ç»æ˜¯å°è¡¨ åˆ†åŒºä¸è¦æå‰é¢„ç•™å¤ªå¤šï¼Œåœ¨ä½¿ç”¨ä¹‹å‰é¢„å…ˆåˆ›å»ºå³å¯ã€‚æ¯”å¦‚æ˜¯æŒ‰æœˆåˆ†åŒºï¼Œæ¯å¹´å¹´åº•æ—¶å†æŠŠä¸‹ä¸€å¹´åº¦çš„ 12 ä¸ªæ–°åˆ†åŒºåˆ›å»ºä¸Šå³å¯ï¼Œå¹¶ä¸”å¯¹äºæ²¡æœ‰æ•°æ®çš„å†å²åˆ†åŒºï¼Œè¦åŠæ—¶çš„ drop æ‰ å‚è€ƒæ–‡æ¡£ï¼šhttps://time.geekbang.org/column/article/82560 ä¸´æ—¶è¡¨åŸºæœ¬ä»‹ç»ä¸´æ—¶è¡¨åˆ†ä¸ºå†…éƒ¨ä¸´æ—¶è¡¨å’Œç”¨æˆ·ä¸´æ—¶è¡¨ å†…éƒ¨ä¸´æ—¶è¡¨ï¼šç³»ç»Ÿæ‰§è¡Œ SQL è¯­å¥ä¼˜åŒ–æ—¶äº§ç”Ÿçš„è¡¨ï¼Œä¾‹å¦‚ Join è¿æ¥æŸ¥è¯¢ã€å»é‡æŸ¥è¯¢ç­‰ ç”¨æˆ·ä¸´æ—¶è¡¨ï¼šç”¨æˆ·ä¸»åŠ¨åˆ›å»ºçš„ä¸´æ—¶è¡¨ 1CREATE TEMPORARY TABLE temp_t like table_1; ä¸´æ—¶è¡¨å¯ä»¥æ˜¯å†…å­˜è¡¨ï¼Œä¹Ÿå¯ä»¥æ˜¯ç£ç›˜è¡¨ï¼ˆå¤šè¡¨æ“ä½œ â†’ åµŒå¥—æŸ¥è¯¢ç« èŠ‚æåŠï¼‰ å†…å­˜è¡¨æŒ‡çš„æ˜¯ä½¿ç”¨ Memory å¼•æ“çš„è¡¨ï¼Œå»ºç«‹å“ˆå¸Œç´¢å¼•ï¼Œå»ºè¡¨è¯­æ³•æ˜¯ create table â€¦ engine=memoryï¼Œè¿™ç§è¡¨çš„æ•°æ®éƒ½ä¿å­˜åœ¨å†…å­˜é‡Œï¼Œç³»ç»Ÿé‡å¯æ—¶ä¼šè¢«æ¸…ç©ºï¼Œä½†æ˜¯è¡¨ç»“æ„è¿˜åœ¨ ç£ç›˜è¡¨æ˜¯ä½¿ç”¨ InnoDB å¼•æ“æˆ–è€… MyISAM å¼•æ“çš„ä¸´æ—¶è¡¨ï¼Œå»ºç«‹ B+ æ ‘ç´¢å¼•ï¼Œå†™æ•°æ®çš„æ—¶å€™æ˜¯å†™åˆ°ç£ç›˜ä¸Šçš„ ä¸´æ—¶è¡¨çš„ç‰¹ç‚¹ï¼š ä¸€ä¸ªä¸´æ—¶è¡¨åªèƒ½è¢«åˆ›å»ºå®ƒçš„ session è®¿é—®ï¼Œå¯¹å…¶ä»–çº¿ç¨‹ä¸å¯è§ï¼Œæ‰€ä»¥ä¸åŒ session çš„ä¸´æ—¶è¡¨æ˜¯å¯ä»¥é‡åçš„ ä¸´æ—¶è¡¨å¯ä»¥ä¸æ™®é€šè¡¨åŒåï¼Œä¼šè¯å†…æœ‰åŒåçš„ä¸´æ—¶è¡¨å’Œæ™®é€šè¡¨æ—¶ï¼Œæ‰§è¡Œ show create è¯­å¥ä»¥åŠå¢åˆ æ”¹æŸ¥è¯­å¥è®¿é—®çš„éƒ½æ˜¯ä¸´æ—¶è¡¨ show tables å‘½ä»¤ä¸æ˜¾ç¤ºä¸´æ—¶è¡¨ æ•°æ®åº“å‘ç”Ÿå¼‚å¸¸é‡å¯ä¸éœ€è¦æ‹…å¿ƒæ•°æ®åˆ é™¤é—®é¢˜ï¼Œä¸´æ—¶è¡¨ä¼šè‡ªåŠ¨å›æ”¶ é‡ååŸç†æ‰§è¡Œåˆ›å»ºä¸´æ—¶è¡¨çš„ SQLï¼š 1create temporary table temp_t(id int primary key)engine=innodb; MySQL ç»™ InnoDB è¡¨åˆ›å»ºä¸€ä¸ª frm æ–‡ä»¶ä¿å­˜è¡¨ç»“æ„å®šä¹‰ï¼Œåœ¨ ibd ä¿å­˜è¡¨æ•°æ®ã€‚frm æ–‡ä»¶æ”¾åœ¨ä¸´æ—¶æ–‡ä»¶ç›®å½•ä¸‹ï¼Œæ–‡ä»¶åçš„åç¼€æ˜¯ .frmï¼Œå‰ç¼€æ˜¯ #sql&#123;è¿›ç¨‹ id&#125;_&#123;çº¿ç¨‹ id&#125;_ åºåˆ—å·ï¼Œä½¿ç”¨ select @@tmpdir å‘½ä»¤ï¼Œæ¥æ˜¾ç¤ºå®ä¾‹çš„ä¸´æ—¶æ–‡ä»¶ç›®å½• MySQL ç»´æŠ¤æ•°æ®è¡¨ï¼Œé™¤äº†ç‰©ç†ç£ç›˜ä¸Šçš„æ–‡ä»¶å¤–ï¼Œå†…å­˜é‡Œä¹Ÿæœ‰ä¸€å¥—æœºåˆ¶åŒºåˆ«ä¸åŒçš„è¡¨ï¼Œæ¯ä¸ªè¡¨éƒ½å¯¹åº”ä¸€ä¸ª table_def_key ä¸€ä¸ªæ™®é€šè¡¨çš„ table_def_key çš„å€¼æ˜¯ç”± åº“å + è¡¨å å¾—åˆ°çš„ï¼Œæ‰€ä»¥å¦‚æœåœ¨åŒä¸€ä¸ªåº“ä¸‹åˆ›å»ºä¸¤ä¸ªåŒåçš„æ™®é€šè¡¨ï¼Œåˆ›å»ºç¬¬äºŒä¸ªè¡¨çš„è¿‡ç¨‹ä¸­å°±ä¼šå‘ç° table_def_key å·²ç»å­˜åœ¨äº† å¯¹äºä¸´æ—¶è¡¨ï¼Œtable_def_key åœ¨ åº“å + è¡¨å åŸºç¡€ä¸Šï¼ŒåˆåŠ å…¥äº† server_id + thread_idï¼Œæ‰€ä»¥ä¸åŒçº¿ç¨‹ä¹‹é—´ï¼Œä¸´æ—¶è¡¨å¯ä»¥é‡å å®ç°åŸç†ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½ç»´æŠ¤äº†è‡ªå·±çš„ä¸´æ—¶è¡¨é“¾è¡¨ï¼Œæ¯æ¬¡ session å†…æ“ä½œè¡¨æ—¶ï¼Œå…ˆéå†é“¾è¡¨ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰è¿™ä¸ªåå­—çš„ä¸´æ—¶è¡¨ï¼Œå¦‚æœæœ‰å°±ä¼˜å…ˆæ“ä½œä¸´æ—¶è¡¨ï¼Œå¦‚æœæ²¡æœ‰å†æ“ä½œæ™®é€šè¡¨ï¼›åœ¨ session ç»“æŸæ—¶å¯¹é“¾è¡¨é‡Œçš„æ¯ä¸ªä¸´æ—¶è¡¨ï¼Œæ‰§è¡Œ DROP TEMPORARY TABLE + è¡¨å æ“ä½œ æ‰§è¡Œ rename table è¯­å¥æ— æ³•ä¿®æ”¹ä¸´æ—¶è¡¨ï¼Œå› ä¸ºä¼šæŒ‰ç…§ åº“å / è¡¨å.frm çš„è§„åˆ™å»ç£ç›˜æ‰¾æ–‡ä»¶ï¼Œä½†æ˜¯ä¸´æ—¶è¡¨æ–‡ä»¶åçš„è§„åˆ™æ˜¯ #sql&#123;è¿›ç¨‹ id&#125;_&#123;çº¿ç¨‹ id&#125;_ åºåˆ—å·.frmï¼Œå› æ­¤ä¼šæŠ¥æ‰¾ä¸åˆ°æ–‡ä»¶åçš„é”™è¯¯ ä¸»å¤‡å¤åˆ¶åˆ›å»ºä¸´æ—¶è¡¨çš„è¯­å¥ä¼šä¼ åˆ°å¤‡åº“æ‰§è¡Œï¼Œå› æ­¤å¤‡åº“çš„åŒæ­¥çº¿ç¨‹å°±ä¼šåˆ›å»ºè¿™ä¸ªä¸´æ—¶è¡¨ã€‚ä¸»åº“åœ¨çº¿ç¨‹é€€å‡ºæ—¶ä¼šè‡ªåŠ¨åˆ é™¤ä¸´æ—¶è¡¨ï¼Œä½†å¤‡åº“åŒæ­¥çº¿ç¨‹æ˜¯æŒç»­åœ¨è¿è¡Œçš„å¹¶ä¸ä¼šé€€å‡ºï¼Œæ‰€ä»¥è¿™æ—¶å°±éœ€è¦åœ¨ä¸»åº“ä¸Šå†å†™ä¸€ä¸ª DROP TEMPORARY TABLE ä¼ ç»™å¤‡åº“æ‰§è¡Œ binlog æ—¥å¿—å†™å…¥è§„åˆ™ï¼š binlog_format&#x3D;rowï¼Œè·Ÿä¸´æ—¶è¡¨æœ‰å…³çš„è¯­å¥å°±ä¸ä¼šè®°å½•åˆ° binlog binlog_format&#x3D;statment&#x2F;mixedï¼Œbinlog ä¸­æ‰ä¼šè®°å½•ä¸´æ—¶è¡¨çš„æ“ä½œï¼Œä¹Ÿå°±ä¼šè®°å½• DROP TEMPORARY TABLE è¿™æ¡å‘½ä»¤ ä¸»åº“ä¸Šä¸åŒçš„çº¿ç¨‹åˆ›å»ºåŒåçš„ä¸´æ—¶è¡¨æ˜¯ä¸å†²çªçš„ï¼Œä½†æ˜¯å¤‡åº“åªæœ‰ä¸€ä¸ªæ‰§è¡Œçº¿ç¨‹ï¼Œæ‰€ä»¥ MySQL åœ¨è®°å½• binlog æ—¶ä¼šæŠŠä¸»åº“æ‰§è¡Œè¿™ä¸ªè¯­å¥çš„çº¿ç¨‹ id å†™åˆ° binlog ä¸­ï¼Œåœ¨å¤‡åº“çš„åº”ç”¨çº¿ç¨‹å°±å¯ä»¥è·å–æ‰§è¡Œæ¯ä¸ªè¯­å¥çš„ä¸»åº“çº¿ç¨‹ idï¼Œå¹¶åˆ©ç”¨è¿™ä¸ªçº¿ç¨‹ id æ¥æ„é€ ä¸´æ—¶è¡¨çš„ table_def_key session A çš„ä¸´æ—¶è¡¨ t1ï¼Œåœ¨å¤‡åº“çš„ table_def_key å°±æ˜¯ï¼šåº“å + t1 +â€œM çš„ serverid&quot; + &quot;session A çš„ thread_idâ€ session B çš„ä¸´æ—¶è¡¨ t1ï¼Œåœ¨å¤‡åº“çš„ table_def_key å°±æ˜¯ ï¼šåº“å + t1 +&quot;M çš„ serverid&quot; + &quot;session B çš„ thread_id&quot; MySQL åœ¨è®°å½• binlog çš„æ—¶ä¸è®ºæ˜¯ create table è¿˜æ˜¯ alter table è¯­å¥éƒ½æ˜¯åŸæ ·è®°å½•ï¼Œä½†æ˜¯å¦‚æœæ‰§è¡Œ drop tableï¼Œç³»ç»Ÿè®°å½• binlog å°±ä¼šè¢«æœåŠ¡ç«¯æ”¹å†™ 1DROP TABLE `t_normal` /* generated by server */ è·¨åº“æŸ¥è¯¢åˆ†åº“åˆ†è¡¨ç³»ç»Ÿçš„è·¨åº“æŸ¥è¯¢ä½¿ç”¨ä¸´æ—¶è¡¨ä¸ç”¨æ‹…å¿ƒçº¿ç¨‹ä¹‹é—´çš„é‡åå†²çªï¼Œåˆ†åº“åˆ†è¡¨å°±æ˜¯è¦æŠŠä¸€ä¸ªé€»è¾‘ä¸Šçš„å¤§è¡¨åˆ†æ•£åˆ°ä¸åŒçš„æ•°æ®åº“å®ä¾‹ä¸Š æ¯”å¦‚å°†ä¸€ä¸ªå¤§è¡¨ htï¼ŒæŒ‰ç…§å­—æ®µ fï¼Œæ‹†åˆ†æˆ 1024 ä¸ªåˆ†è¡¨ï¼Œåˆ†å¸ƒåˆ° 32 ä¸ªæ•°æ®åº“å®ä¾‹ä¸Šï¼Œä¸€èˆ¬æƒ…å†µä¸‹éƒ½æœ‰ä¸€ä¸ªä¸­é—´å±‚ proxy è§£æ SQL è¯­å¥ï¼Œé€šè¿‡åˆ†åº“è§„åˆ™é€šè¿‡åˆ†è¡¨è§„åˆ™ï¼ˆæ¯”å¦‚ N%1024ï¼‰ç¡®å®šå°†è¿™æ¡è¯­å¥è·¯ç”±åˆ°å“ªä¸ªåˆ†è¡¨åšæŸ¥è¯¢ 1select v from ht where f=N; å¦‚æœè¿™ä¸ªè¡¨ä¸Šè¿˜æœ‰å¦å¤–ä¸€ä¸ªç´¢å¼• kï¼Œå¹¶ä¸”æŸ¥è¯¢è¯­å¥ï¼š 1select v from ht where k &gt;= M order by t_modified desc limit 100; æŸ¥è¯¢æ¡ä»¶é‡Œé¢æ²¡æœ‰ç”¨åˆ°åˆ†åŒºå­—æ®µ fï¼Œåªèƒ½åˆ°æ‰€æœ‰çš„åˆ†åŒºä¸­å»æŸ¥æ‰¾æ»¡è¶³æ¡ä»¶çš„æ‰€æœ‰è¡Œï¼Œç„¶åç»Ÿä¸€åš order by æ“ä½œï¼Œä¸¤ç§æ–¹å¼ï¼š åœ¨ proxy å±‚çš„è¿›ç¨‹ä»£ç ä¸­å®ç°æ’åºï¼Œæ‹¿åˆ°åˆ†åº“çš„æ•°æ®ä»¥åï¼Œç›´æ¥åœ¨å†…å­˜ä¸­å‚ä¸è®¡ç®—ï¼Œä½†æ˜¯å¯¹ proxy ç«¯çš„å‹åŠ›æ¯”è¾ƒå¤§ï¼Œå¾ˆå®¹æ˜“å‡ºç°å†…å­˜ä¸å¤Ÿç”¨å’Œ CPU ç“¶é¢ˆé—®é¢˜ æŠŠå„ä¸ªåˆ†åº“æ‹¿åˆ°çš„æ•°æ®ï¼Œæ±‡æ€»åˆ°ä¸€ä¸ª MySQL å®ä¾‹çš„ä¸€ä¸ªè¡¨ä¸­ï¼Œç„¶ååœ¨è¿™ä¸ªæ±‡æ€»å®ä¾‹ä¸Šåšé€»è¾‘æ“ä½œï¼Œæ‰§è¡Œæµç¨‹ï¼š åœ¨æ±‡æ€»åº“ä¸Šåˆ›å»ºä¸€ä¸ªä¸´æ—¶è¡¨ temp_htï¼Œè¡¨é‡ŒåŒ…å«ä¸‰ä¸ªå­—æ®µ vã€kã€t_modified åœ¨å„ä¸ªåˆ†åº“æ‰§è¡Œï¼šselect v,k,t_modified from ht_x where k &gt;= M order by t_modified desc limit 100 æŠŠåˆ†åº“æ‰§è¡Œçš„ç»“æœæ’å…¥åˆ° temp_ht è¡¨ä¸­ åœ¨ä¸´æ—¶è¡¨ä¸Šæ‰§è¡Œï¼šselect v from temp_ht order by t_modified desc limit 100 ä¼˜åŒ–æ­¥éª¤æ‰§è¡Œé¢‘ç‡MySQL å®¢æˆ·ç«¯è¿æ¥æˆåŠŸåï¼ŒæŸ¥è¯¢æœåŠ¡å™¨çŠ¶æ€ä¿¡æ¯ï¼š 123SHOW [SESSION|GLOBAL] STATUS LIKE &#x27;&#x27;;-- SESSION: æ˜¾ç¤ºå½“å‰ä¼šè¯è¿æ¥çš„ç»Ÿè®¡ç»“æœï¼Œé»˜è®¤å‚æ•°-- GLOBAL: æ˜¾ç¤ºè‡ªæ•°æ®åº“ä¸Šæ¬¡å¯åŠ¨è‡³ä»Šçš„ç»Ÿè®¡ç»“æœ æŸ¥çœ‹ SQL æ‰§è¡Œé¢‘ç‡ï¼š 1SHOW STATUS LIKE &#x27;Com_____&#x27;; Com_xxx è¡¨ç¤ºæ¯ç§è¯­å¥æ‰§è¡Œçš„æ¬¡æ•° æŸ¥è¯¢ SQL è¯­å¥å½±å“çš„è¡Œæ•°ï¼š 1SHOW STATUS LIKE &#x27;Innodb_rows_%&#x27;; Com_xxxxï¼šè¿™äº›å‚æ•°å¯¹äºæ‰€æœ‰å­˜å‚¨å¼•æ“çš„è¡¨æ“ä½œéƒ½ä¼šè¿›è¡Œç´¯è®¡ Innodb_xxxxï¼šè¿™å‡ ä¸ªå‚æ•°åªæ˜¯é’ˆå¯¹ InnoDB å­˜å‚¨å¼•æ“çš„ï¼Œç´¯åŠ çš„ç®—æ³•ä¹Ÿç•¥æœ‰ä¸åŒ å‚æ•° å«ä¹‰ Com_select æ‰§è¡Œ SELECT æ“ä½œçš„æ¬¡æ•°ï¼Œä¸€æ¬¡æŸ¥è¯¢åªç´¯åŠ  1 Com_insert æ‰§è¡Œ INSERT æ“ä½œçš„æ¬¡æ•°ï¼Œå¯¹äºæ‰¹é‡æ’å…¥çš„ INSERT æ“ä½œï¼Œåªç´¯åŠ ä¸€æ¬¡ Com_update æ‰§è¡Œ UPDATE æ“ä½œçš„æ¬¡æ•° Com_delete æ‰§è¡Œ DELETE æ“ä½œçš„æ¬¡æ•° Innodb_rows_read æ‰§è¡Œ SELECT æŸ¥è¯¢è¿”å›çš„è¡Œæ•° Innodb_rows_inserted æ‰§è¡Œ INSERT æ“ä½œæ’å…¥çš„è¡Œæ•° Innodb_rows_updated æ‰§è¡Œ UPDATE æ“ä½œæ›´æ–°çš„è¡Œæ•° Innodb_rows_deleted æ‰§è¡Œ DELETE æ“ä½œåˆ é™¤çš„è¡Œæ•° Connections è¯•å›¾è¿æ¥ MySQL æœåŠ¡å™¨çš„æ¬¡æ•° Uptime æœåŠ¡å™¨å·¥ä½œæ—¶é—´ Slow_queries æ…¢æŸ¥è¯¢çš„æ¬¡æ•° å®šä½ä½æ•ˆSQL æ‰§è¡Œæ…¢æœ‰ä¸¤ç§æƒ…å†µï¼š å¶å°”æ…¢ï¼šDB åœ¨åˆ·æ–°è„é¡µï¼ˆå­¦å®Œäº‹åŠ¡å°±æ‡‚äº†ï¼‰ redo log å†™æ»¡äº† å†…å­˜ä¸å¤Ÿç”¨ï¼Œè¦ä» LRU é“¾è¡¨ä¸­æ·˜æ±° MySQL è®¤ä¸ºç³»ç»Ÿç©ºé—²çš„æ—¶å€™ MySQL å…³é—­æ—¶ ä¸€ç›´æ…¢çš„åŸå› ï¼šç´¢å¼•æ²¡æœ‰è®¾è®¡å¥½ã€SQL è¯­å¥æ²¡å†™å¥½ã€MySQL é€‰é”™äº†ç´¢å¼• é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼å®šä½æ‰§è¡Œæ•ˆç‡è¾ƒä½çš„ SQL è¯­å¥ æ…¢æ—¥å¿—æŸ¥è¯¢ï¼š æ…¢æŸ¥è¯¢æ—¥å¿—åœ¨æŸ¥è¯¢ç»“æŸä»¥åæ‰è®°å½•ï¼Œæ‰§è¡Œæ•ˆç‡å‡ºç°é—®é¢˜æ—¶æŸ¥è¯¢æ—¥å¿—å¹¶ä¸èƒ½å®šä½é—®é¢˜ é…ç½®æ–‡ä»¶ä¿®æ”¹ï¼šä¿®æ”¹ .cnf æ–‡ä»¶ vim /etc/mysql/my.cnfï¼Œé‡å¯ MySQL æœåŠ¡å™¨ 1234slow_query_log=ONslow_query_log_file=/usr/local/mysql/var/localhost-slow.loglong_query_time=1 #è®°å½•è¶…è¿‡long_query_timeç§’çš„SQLè¯­å¥çš„æ—¥å¿—log-queries-not-using-indexes = 1 ä½¿ç”¨å‘½ä»¤é…ç½®ï¼š 12mysql&gt; SET slow_query_log=ON;mysql&gt; SET GLOBAL slow_query_log=ON; æŸ¥çœ‹æ˜¯å¦é…ç½®æˆåŠŸï¼š 1SHOW VARIABLES LIKE &#x27;%query%&#x27; SHOW PROCESSLISTï¼šå®æ—¶æŸ¥çœ‹å½“å‰ MySQL åœ¨è¿›è¡Œçš„è¿æ¥çº¿ç¨‹ï¼ŒåŒ…æ‹¬çº¿ç¨‹çš„çŠ¶æ€ã€æ˜¯å¦é”è¡¨ã€SQL çš„æ‰§è¡Œæƒ…å†µï¼ŒåŒæ—¶å¯¹ä¸€äº›é”è¡¨æ“ä½œè¿›è¡Œä¼˜åŒ– EXPLAINæ‰§è¡Œè®¡åˆ’é€šè¿‡ EXPLAIN å‘½ä»¤è·å–æ‰§è¡Œ SQL è¯­å¥çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬åœ¨ SELECT è¯­å¥æ‰§è¡Œè¿‡ç¨‹ä¸­å¦‚ä½•è¿æ¥å’Œè¿æ¥çš„é¡ºåºï¼Œæ‰§è¡Œè®¡åˆ’åœ¨ä¼˜åŒ–å™¨ä¼˜åŒ–å®Œæˆåã€æ‰§è¡Œå™¨ä¹‹å‰ç”Ÿæˆï¼Œç„¶åæ‰§è¡Œå™¨ä¼šè°ƒç”¨å­˜å‚¨å¼•æ“æ£€ç´¢æ•°æ® æŸ¥è¯¢ SQL è¯­å¥çš„æ‰§è¡Œè®¡åˆ’ï¼š 1EXPLAIN SELECT * FROM table_1 WHERE id = 1; å­—æ®µ å«ä¹‰ id SELECT çš„åºåˆ—å· select_type è¡¨ç¤º SELECT çš„ç±»å‹ table è®¿é—®æ•°æ®åº“ä¸­è¡¨åç§°ï¼Œæœ‰æ—¶å¯èƒ½æ˜¯ç®€ç§°æˆ–è€…ä¸´æ—¶è¡¨åç§°ï¼ˆï¼‰ type è¡¨ç¤ºè¡¨çš„è¿æ¥ç±»å‹ possible_keys è¡¨ç¤ºæŸ¥è¯¢æ—¶ï¼Œå¯èƒ½ä½¿ç”¨çš„ç´¢å¼• key è¡¨ç¤ºå®é™…ä½¿ç”¨çš„ç´¢å¼• key_len ç´¢å¼•å­—æ®µçš„é•¿åº¦ ref è¡¨ç¤ºä¸ç´¢å¼•åˆ—è¿›è¡Œç­‰å€¼åŒ¹é…çš„å¯¹è±¡ï¼Œå¸¸æ•°ã€æŸä¸ªåˆ—ã€å‡½æ•°ç­‰ï¼Œtype å¿…é¡»åœ¨ï¼ˆrange, const] ä¹‹é—´ï¼Œå·¦é—­å³å¼€ rows æ‰«æå‡ºçš„è¡Œæ•°ï¼Œè¡¨ç¤º MySQL æ ¹æ®è¡¨ç»Ÿè®¡ä¿¡æ¯åŠç´¢å¼•é€‰ç”¨æƒ…å†µï¼Œä¼°ç®—çš„æ‰¾åˆ°æ‰€éœ€çš„è®°å½•æ‰«æçš„è¡Œæ•° filtered æ¡ä»¶è¿‡æ»¤çš„è¡Œç™¾åˆ†æ¯”ï¼Œå•è¡¨æŸ¥è¯¢æ²¡æ„ä¹‰ï¼Œç”¨äºè¿æ¥æŸ¥è¯¢ä¸­å¯¹é©±åŠ¨è¡¨çš„æ‰‡å‡ºè¿›è¡Œè¿‡æ»¤ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨é¢„æµ‹æ‰€æœ‰æ‰‡å‡ºå€¼æ»¡è¶³å‰©ä½™æŸ¥è¯¢æ¡ä»¶çš„ç™¾åˆ†æ¯”ï¼Œç›¸ä¹˜ä»¥åè¡¨ç¤ºå¤šè¡¨æŸ¥è¯¢ä¸­è¿˜è¦å¯¹è¢«é©±åŠ¨æ‰§è¡ŒæŸ¥è¯¢çš„æ¬¡æ•° extra æ‰§è¡Œæƒ…å†µçš„è¯´æ˜å’Œæè¿° MySQL æ‰§è¡Œè®¡åˆ’çš„å±€é™ï¼š åªæ˜¯è®¡åˆ’ï¼Œä¸æ˜¯æ‰§è¡Œ SQL è¯­å¥ï¼Œå¯ä»¥éšç€åº•å±‚ä¼˜åŒ–å™¨è¾“å…¥çš„æ›´æ”¹è€Œæ›´æ”¹ EXPLAIN ä¸ä¼šå‘Šè¯‰æ˜¾ç¤ºå…³äºè§¦å‘å™¨ã€å­˜å‚¨è¿‡ç¨‹çš„ä¿¡æ¯å¯¹æŸ¥è¯¢çš„å½±å“æƒ…å†µï¼Œ ä¸è€ƒè™‘å„ç§ Cache EXPLAIN ä¸èƒ½æ˜¾ç¤º MySQL åœ¨æ‰§è¡ŒæŸ¥è¯¢æ—¶çš„åŠ¨æ€ï¼Œå› ä¸ºæ‰§è¡Œè®¡åˆ’åœ¨æ‰§è¡ŒæŸ¥è¯¢ä¹‹å‰ç”Ÿæˆ EXPALIN åªèƒ½è§£é‡Š SELECT æ“ä½œï¼Œå…¶ä»–æ“ä½œè¦é‡å†™ä¸º SELECT åæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ EXPLAIN PLAN æ˜¾ç¤ºçš„æ˜¯åœ¨è§£é‡Šè¯­å¥æ—¶æ•°æ®åº“å°†å¦‚ä½•è¿è¡Œ SQL è¯­å¥ï¼Œç”±äºæ‰§è¡Œç¯å¢ƒå’Œ EXPLAIN PLAN ç¯å¢ƒçš„ä¸åŒï¼Œæ­¤è®¡åˆ’å¯èƒ½ä¸ SQL è¯­å¥å®é™…çš„æ‰§è¡Œè®¡åˆ’ä¸åŒï¼Œéƒ¨åˆ†ç»Ÿè®¡ä¿¡æ¯æ˜¯ä¼°ç®—çš„ï¼Œå¹¶éç²¾ç¡®å€¼ SHOW WARINGSï¼šåœ¨ä½¿ç”¨ EXPALIN å‘½ä»¤åæ‰§è¡Œè¯¥è¯­å¥ï¼Œå¯ä»¥æŸ¥è¯¢ä¸æ‰§è¡Œè®¡åˆ’ç›¸å…³çš„æ‹“å±•ä¿¡æ¯ï¼Œå±•ç¤ºå‡º Levelã€Codeã€Message ä¸‰ä¸ªå­—æ®µï¼Œå½“ Code ä¸º 1003 æ—¶ï¼ŒMessage å­—æ®µå±•ç¤ºçš„ä¿¡æ¯ç±»ä¼¼äºå°†æŸ¥è¯¢è¯­å¥é‡å†™åçš„ä¿¡æ¯ï¼Œä½†æ˜¯ä¸æ˜¯ç­‰ä»·ï¼Œä¸èƒ½æ‰§è¡Œå¤åˆ¶è¿‡æ¥è¿è¡Œ ç¯å¢ƒå‡†å¤‡ï¼š idid ä»£è¡¨ SQL æ‰§è¡Œçš„é¡ºåºçš„æ ‡è¯†ï¼Œæ¯ä¸ª SELECT å…³é”®å­—å¯¹åº”ä¸€ä¸ªå”¯ä¸€ idï¼Œæ‰€ä»¥åœ¨åŒä¸€ä¸ª SELECT å…³é”®å­—ä¸­çš„è¡¨çš„ id éƒ½æ˜¯ç›¸åŒçš„ã€‚SELECT åçš„ FROM å¯ä»¥è·Ÿéšå¤šä¸ªè¡¨ï¼Œæ¯ä¸ªè¡¨éƒ½ä¼šå¯¹åº”ä¸€æ¡è®°å½•ï¼Œè¿™äº›è®°å½•çš„ id éƒ½æ˜¯ç›¸åŒçš„ï¼Œ id ç›¸åŒæ—¶ï¼Œæ‰§è¡Œé¡ºåºç”±ä¸Šè‡³ä¸‹ã€‚è¿æ¥æŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’ï¼Œè®°å½•çš„ id å€¼éƒ½æ˜¯ç›¸åŒçš„ï¼Œå‡ºç°åœ¨å‰é¢çš„è¡¨ä¸ºé©±åŠ¨è¡¨ï¼Œåé¢ä¸ºè¢«é©±åŠ¨è¡¨ 1EXPLAIN SELECT * FROM t_role r, t_user u, user_role ur WHERE r.id = ur.role_id AND u.id = ur.user_id ; id ä¸åŒæ—¶ï¼Œid å€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¶Šå…ˆè¢«æ‰§è¡Œ 1EXPLAIN SELECT * FROM t_role WHERE id = (SELECT role_id FROM user_role WHERE user_id = (SELECT id FROM t_user WHERE username = &#x27;stu1&#x27;)) id æœ‰ç›¸åŒä¹Ÿæœ‰ä¸åŒæ—¶ï¼Œid ç›¸åŒçš„å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç»„ï¼Œä»ä¸Šå¾€ä¸‹é¡ºåºæ‰§è¡Œï¼›åœ¨æ‰€æœ‰çš„ç»„ä¸­ï¼Œid çš„å€¼è¶Šå¤§çš„ç»„ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¶Šå…ˆæ‰§è¡Œ 1EXPLAIN SELECT * FROM t_role r , (SELECT * FROM user_role ur WHERE ur.`user_id` = &#x27;2&#x27;) a WHERE r.id = a.role_id ; id ä¸º NULL æ—¶ä»£è¡¨çš„æ˜¯ä¸´æ—¶è¡¨ selectè¡¨ç¤ºæŸ¥è¯¢ä¸­æ¯ä¸ª select å­å¥çš„ç±»å‹ï¼ˆç®€å• OR å¤æ‚ï¼‰ select_type å«ä¹‰ SIMPLE ç®€å•çš„ SELECT æŸ¥è¯¢ï¼ŒæŸ¥è¯¢ä¸­ä¸åŒ…å«å­æŸ¥è¯¢æˆ–è€… UNION PRIMARY æŸ¥è¯¢ä¸­è‹¥åŒ…å«ä»»ä½•å¤æ‚çš„å­æŸ¥è¯¢ï¼Œæœ€å¤–å±‚ï¼ˆä¹Ÿå°±æ˜¯æœ€å·¦ä¾§ï¼‰æŸ¥è¯¢æ ‡è®°ä¸ºè¯¥æ ‡è¯† UNION å¯¹äº UNION æˆ–è€… UNION ALL çš„å¤æ‚æŸ¥è¯¢ï¼Œé™¤äº†æœ€å·¦ä¾§çš„æŸ¥è¯¢ï¼Œå…¶ä½™çš„å°æŸ¥è¯¢éƒ½æ˜¯ UNION UNION RESULT UNION éœ€è¦ä½¿ç”¨ä¸´æ—¶è¡¨è¿›è¡Œå»é‡ï¼Œä¸´æ—¶è¡¨çš„æ˜¯ UNION RESULT DEPENDENT UNION å¯¹äº UNION æˆ–è€… UNION ALL çš„å¤æ‚æŸ¥è¯¢ï¼Œå¦‚æœå„ä¸ªå°æŸ¥è¯¢éƒ½ä¾èµ–å¤–å±‚æŸ¥è¯¢ï¼Œæ˜¯ç›¸å…³å­æŸ¥è¯¢ï¼Œé™¤äº†æœ€å·¦ä¾§çš„å°æŸ¥è¯¢ä¸º DEPENDENT SUBQUERYï¼Œå…¶ä½™éƒ½æ˜¯ DEPENDENT UNION SUBQUERY å­æŸ¥è¯¢ä¸æ˜¯ç›¸å…³å­æŸ¥è¯¢ï¼Œè¯¥å­æŸ¥è¯¢ç¬¬ä¸€ä¸ª SELECT ä»£è¡¨çš„æŸ¥è¯¢å°±æ˜¯è¿™ç§ç±»å‹ï¼Œä¼šè¿›è¡Œç‰©åŒ–ï¼ˆè¯¥å­æŸ¥è¯¢åªéœ€è¦æ‰§è¡Œä¸€æ¬¡ï¼‰ DEPENDENT SUBQUERY å­æŸ¥è¯¢æ˜¯ç›¸å…³å­æŸ¥è¯¢ï¼Œè¯¥å­æŸ¥è¯¢ç¬¬ä¸€ä¸ª SELECT ä»£è¡¨çš„æŸ¥è¯¢å°±æ˜¯è¿™ç§ç±»å‹ï¼Œä¸ä¼šç‰©åŒ–ï¼ˆè¯¥å­æŸ¥è¯¢éœ€è¦æ‰§è¡Œå¤šæ¬¡ï¼‰ DERIVED åœ¨ FROM åˆ—è¡¨ä¸­åŒ…å«çš„å­æŸ¥è¯¢ï¼Œè¢«æ ‡è®°ä¸º DERIVEDï¼ˆè¡ç”Ÿï¼‰ï¼Œä¹Ÿå°±æ˜¯ç”Ÿæˆç‰©åŒ–æ´¾ç”Ÿè¡¨çš„è¿™ä¸ªå­æŸ¥è¯¢ MATERIALIZED å°†å­æŸ¥è¯¢ç‰©åŒ–åä¸ä¸å¤–å±‚è¿›è¡Œè¿æ¥æŸ¥è¯¢ï¼Œç”Ÿæˆç‰©åŒ–è¡¨çš„å­æŸ¥è¯¢ å­æŸ¥è¯¢ä¸º DERIVEDï¼šSELECT * FROM (SELECT key1 FROM t1) AS derived_1 WHERE key1 &gt; 10 å­æŸ¥è¯¢ä¸º MATERIALIZEDï¼šSELECT * FROM t1 WHERE key1 IN (SELECT key1 FROM t2) typeå¯¹è¡¨çš„è®¿é—®æ–¹å¼ï¼Œè¡¨ç¤º MySQL åœ¨è¡¨ä¸­æ‰¾åˆ°æ‰€éœ€è¡Œçš„æ–¹å¼ï¼Œåˆç§°è®¿é—®ç±»å‹ type å«ä¹‰ ALL å…¨è¡¨æ‰«æï¼Œå¦‚æœæ˜¯ InnoDB å¼•æ“æ˜¯æ‰«æèšç°‡ç´¢å¼• index å¯ä»¥ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œä½†éœ€è¦æ‰«æå…¨éƒ¨ç´¢å¼• range ç´¢å¼•èŒƒå›´æ‰«æï¼Œå¸¸è§äº betweenã€&lt;ã€&gt; ç­‰çš„æŸ¥è¯¢ index_subquery å­æŸ¥è¯¢å¯ä»¥æ™®é€šç´¢å¼•ï¼Œåˆ™å­æŸ¥è¯¢çš„ type ä¸º index_subquery unique_subquery å­æŸ¥è¯¢å¯ä»¥ä½¿ç”¨ä¸»é”®æˆ–å”¯ä¸€äºŒçº§ç´¢å¼•ï¼Œåˆ™å­æŸ¥è¯¢çš„ type ä¸º index_subquery index_merge ç´¢å¼•åˆå¹¶ ref_or_null éå”¯ä¸€æ€§ç´¢å¼•ï¼ˆæ™®é€šäºŒçº§ç´¢å¼•ï¼‰å¹¶ä¸”å¯ä»¥å­˜å‚¨ NULLï¼Œè¿›è¡Œç­‰å€¼åŒ¹é… ref éå”¯ä¸€æ€§ç´¢å¼•ä¸å¸¸é‡ç­‰å€¼åŒ¹é… eq_ref å”¯ä¸€æ€§ç´¢å¼•ï¼ˆä¸»é”®æˆ–ä¸å­˜å‚¨ NULL çš„å”¯ä¸€äºŒçº§ç´¢å¼•ï¼‰è¿›è¡Œç­‰å€¼åŒ¹é…ï¼Œå¦‚æœäºŒçº§ç´¢å¼•æ˜¯è”åˆç´¢å¼•ï¼Œé‚£ä¹ˆæ‰€æœ‰è”åˆçš„åˆ—éƒ½è¦è¿›è¡Œç­‰å€¼åŒ¹é… const é€šè¿‡ä¸»é”®æˆ–è€…å”¯ä¸€äºŒçº§ç´¢å¼•ä¸å¸¸é‡è¿›è¡Œç­‰å€¼åŒ¹é… system system æ˜¯ const ç±»å‹çš„ç‰¹ä¾‹ï¼Œå½“æŸ¥è¯¢çš„è¡¨åªæœ‰ä¸€æ¡è®°å½•çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ system NULL MySQL åœ¨ä¼˜åŒ–è¿‡ç¨‹ä¸­åˆ†è§£è¯­å¥ï¼Œæ‰§è¡Œæ—¶ç”šè‡³ä¸ç”¨è®¿é—®è¡¨æˆ–ç´¢å¼• ä»ä¸Šåˆ°ä¸‹ï¼Œæ€§èƒ½ä»å·®åˆ°å¥½ï¼Œä¸€èˆ¬æ¥è¯´éœ€è¦ä¿è¯æŸ¥è¯¢è‡³å°‘è¾¾åˆ° range çº§åˆ«ï¼Œ æœ€å¥½è¾¾åˆ° ref keypossible_keysï¼š æŒ‡å‡º MySQL èƒ½ä½¿ç”¨å“ªä¸ªç´¢å¼•åœ¨è¡¨ä¸­æ‰¾åˆ°è®°å½•ï¼ŒæŸ¥è¯¢æ¶‰åŠåˆ°çš„å­—æ®µä¸Šè‹¥å­˜åœ¨ç´¢å¼•ï¼Œåˆ™è¯¥ç´¢å¼•å°†è¢«åˆ—å‡ºï¼Œä½†ä¸ä¸€å®šè¢«æŸ¥è¯¢ä½¿ç”¨ å¦‚æœè¯¥åˆ—æ˜¯ NULLï¼Œåˆ™æ²¡æœ‰ç›¸å…³çš„ç´¢å¼• keyï¼š æ˜¾ç¤º MySQL åœ¨æŸ¥è¯¢ä¸­å®é™…ä½¿ç”¨çš„ç´¢å¼•ï¼Œè‹¥æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ï¼Œæ˜¾ç¤ºä¸º NULL æŸ¥è¯¢ä¸­è‹¥ä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼Œåˆ™è¯¥ç´¢å¼•å¯èƒ½å‡ºç°åœ¨ key åˆ—è¡¨ï¼Œä¸å‡ºç°åœ¨ possible_keys key_lenï¼š è¡¨ç¤ºç´¢å¼•ä¸­ä½¿ç”¨çš„å­—èŠ‚æ•°ï¼Œå¯é€šè¿‡è¯¥åˆ—è®¡ç®—æŸ¥è¯¢ä¸­ä½¿ç”¨çš„ç´¢å¼•çš„é•¿åº¦ key_len æ˜¾ç¤ºçš„å€¼ä¸ºç´¢å¼•å­—æ®µçš„æœ€å¤§å¯èƒ½é•¿åº¦ï¼Œå¹¶éå®é™…ä½¿ç”¨é•¿åº¦ï¼Œå³ key_len æ˜¯æ ¹æ®è¡¨å®šä¹‰è®¡ç®—è€Œå¾—ï¼Œä¸æ˜¯é€šè¿‡è¡¨å†…æ£€ç´¢å‡ºçš„ åœ¨ä¸æŸå¤±ç²¾ç¡®æ€§çš„å‰æä¸‹ï¼Œé•¿åº¦è¶ŠçŸ­è¶Šå¥½ Extraå…¶ä»–çš„é¢å¤–çš„æ‰§è¡Œè®¡åˆ’ä¿¡æ¯ï¼Œåœ¨è¯¥åˆ—å±•ç¤ºï¼š No tables usedï¼šæŸ¥è¯¢è¯­å¥ä¸­ä½¿ç”¨ FROM dual æˆ–è€…æ²¡æœ‰ FROM è¯­å¥ Impossible WHEREï¼šæŸ¥è¯¢è¯­å¥ä¸­çš„ WHERE å­å¥æ¡ä»¶æ°¸è¿œä¸º FALSEï¼Œä¼šå¯¼è‡´æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„è¡Œ Using indexï¼šè¯¥å€¼è¡¨ç¤ºç›¸åº”çš„ SELECT æ“ä½œä¸­ä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼ˆCovering Indexï¼‰ Using index conditionï¼šç¬¬ä¸€ç§æƒ…å†µæ˜¯æœç´¢æ¡ä»¶ä¸­è™½ç„¶å‡ºç°äº†ç´¢å¼•åˆ—ï¼Œä½†æ˜¯éƒ¨åˆ†æ¡ä»¶æ— æ³•å½¢æˆæ‰«æåŒºé—´ï¼ˆç´¢å¼•å¤±æ•ˆï¼‰ï¼Œä¼šæ ¹æ®å¯ç”¨ç´¢å¼•çš„æ¡ä»¶å…ˆæœç´¢ä¸€éå†åŒ¹é…æ— æ³•ä½¿ç”¨ç´¢å¼•çš„æ¡ä»¶ï¼Œå›è¡¨æŸ¥è¯¢æ•°æ®ï¼›ç¬¬äºŒç§æ˜¯ä½¿ç”¨äº†ç´¢å¼•æ¡ä»¶ä¸‹æ¨ä¼˜åŒ– Using whereï¼šæœç´¢çš„æ•°æ®éœ€è¦åœ¨ Server å±‚åˆ¤æ–­ï¼Œæ— æ³•ä½¿ç”¨ç´¢å¼•ä¸‹æ¨ Using join bufferï¼šè¿æ¥æŸ¥è¯¢è¢«é©±åŠ¨è¡¨æ— æ³•åˆ©ç”¨ç´¢å¼•ï¼Œéœ€è¦è¿æ¥ç¼“å†²åŒºæ¥å­˜å‚¨ä¸­é—´ç»“æœ Using filesortï¼šæ— æ³•åˆ©ç”¨ç´¢å¼•å®Œæˆæ’åºï¼ˆä¼˜åŒ–æ–¹å‘ï¼‰ï¼Œéœ€è¦å¯¹æ•°æ®ä½¿ç”¨å¤–éƒ¨æ’åºç®—æ³•ï¼Œå°†å–å¾—çš„æ•°æ®åœ¨å†…å­˜æˆ–ç£ç›˜ä¸­è¿›è¡Œæ’åº Using temporaryï¼šè¡¨ç¤º MySQL éœ€è¦ä½¿ç”¨ä¸´æ—¶è¡¨æ¥å­˜å‚¨ç»“æœé›†ï¼Œå¸¸è§äºæ’åºã€å»é‡ï¼ˆUNIONï¼‰ã€åˆ†ç»„ç­‰åœºæ™¯ Select tables optimized awayï¼šè¯´æ˜ä»…é€šè¿‡ä½¿ç”¨ç´¢å¼•ï¼Œä¼˜åŒ–å™¨å¯èƒ½ä»…ä»èšåˆå‡½æ•°ç»“æœä¸­è¿”å›ä¸€è¡Œ No tables usedï¼šQuery è¯­å¥ä¸­ä½¿ç”¨ from dual æˆ–ä¸å«ä»»ä½• from å­å¥ å‚è€ƒæ–‡ç« ï¼šhttps://www.cnblogs.com/ggjucheng/archive/2012/11/11/2765237.html PROFILESSHOW PROFILES èƒ½å¤Ÿåœ¨åš SQL ä¼˜åŒ–æ—¶åˆ†æå½“å‰ä¼šè¯ä¸­è¯­å¥æ‰§è¡Œçš„èµ„æºæ¶ˆè€—æƒ…å†µ é€šè¿‡ have_profiling å‚æ•°ï¼Œèƒ½å¤Ÿçœ‹åˆ°å½“å‰ MySQL æ˜¯å¦æ”¯æŒ profileï¼š é»˜è®¤ profiling æ˜¯å…³é—­çš„ï¼Œå¯ä»¥é€šè¿‡ set è¯­å¥åœ¨ Session çº§åˆ«å¼€å¯ profilingï¼š 1SET profiling=1; #å¼€å¯profiling å¼€å…³ï¼› æ‰§è¡Œ SHOW PROFILES æŒ‡ä»¤ï¼Œ æ¥æŸ¥çœ‹ SQL è¯­å¥æ‰§è¡Œçš„è€—æ—¶: 1SHOW PROFILES; æŸ¥çœ‹åˆ°è¯¥ SQL æ‰§è¡Œè¿‡ç¨‹ä¸­æ¯ä¸ªçº¿ç¨‹çš„çŠ¶æ€å’Œæ¶ˆè€—çš„æ—¶é—´ï¼š 1SHOW PROFILE FOR QUERY query_id; åœ¨è·å–åˆ°æœ€æ¶ˆè€—æ—¶é—´çš„çº¿ç¨‹çŠ¶æ€åï¼ŒMySQL æ”¯æŒé€‰æ‹© allã€cpuã€block io ã€context switchã€page faults ç­‰ç±»å‹æŸ¥çœ‹ MySQL åœ¨ä½¿ç”¨ä»€ä¹ˆèµ„æºä¸Šè€—è´¹äº†è¿‡é«˜çš„æ—¶é—´ã€‚ä¾‹å¦‚ï¼Œé€‰æ‹©æŸ¥çœ‹ CPU çš„è€—è´¹æ—¶é—´ï¼š Statusï¼šSQL è¯­å¥æ‰§è¡Œçš„çŠ¶æ€ Durationsqlï¼šæ‰§è¡Œè¿‡ç¨‹ä¸­æ¯ä¸€ä¸ªæ­¥éª¤çš„è€—æ—¶ CPU_userï¼šå½“å‰ç”¨æˆ·å æœ‰çš„ CPU CPU_systemï¼šç³»ç»Ÿå æœ‰çš„ CPU TRACEMySQL æä¾›äº†å¯¹ SQL çš„è·Ÿè¸ªï¼Œ é€šè¿‡ trace æ–‡ä»¶å¯ä»¥æŸ¥çœ‹ä¼˜åŒ–å™¨ç”Ÿæˆæ‰§è¡Œè®¡åˆ’çš„è¿‡ç¨‹ æ‰“å¼€ trace åŠŸèƒ½ï¼Œè®¾ç½®æ ¼å¼ä¸º JSONï¼Œå¹¶è®¾ç½® trace çš„æœ€å¤§ä½¿ç”¨å†…å­˜ï¼Œé¿å…è§£æè¿‡ç¨‹ä¸­å› é»˜è®¤å†…å­˜è¿‡å°è€Œä¸èƒ½å¤Ÿå®Œæ•´å±•ç¤º 12SET optimizer_trace=&quot;enabled=on&quot;,end_markers_in_json=ON; -- ä¼šè¯å†…æœ‰æ•ˆSET optimizer_trace_max_mem_size=1000000; æ‰§è¡Œ SQL è¯­å¥ï¼š 1SELECT * FROM tb_item WHERE id &lt; 4; æ£€æŸ¥ information_schema.optimizer_traceï¼š 1SELECT * FROM information_schema.optimizer_trace \\G; -- \\Gä»£è¡¨ç«–åˆ—å±•ç¤º æ‰§è¡Œä¿¡æ¯ä¸»è¦æœ‰ä¸‰ä¸ªé˜¶æ®µï¼šprepare é˜¶æ®µã€optimize é˜¶æ®µï¼ˆæˆæœ¬åˆ†æï¼‰ã€execute é˜¶æ®µï¼ˆæ‰§è¡Œï¼‰ ç´¢å¼•ä¼˜åŒ–åˆ›å»ºç´¢å¼•ç´¢å¼•æ˜¯æ•°æ®åº“ä¼˜åŒ–æœ€é‡è¦çš„æ‰‹æ®µä¹‹ä¸€ï¼Œé€šè¿‡ç´¢å¼•é€šå¸¸å¯ä»¥å¸®åŠ©ç”¨æˆ·è§£å†³å¤§å¤šæ•°çš„ MySQL çš„æ€§èƒ½ä¼˜åŒ–é—®é¢˜ 123456789101112CREATE TABLE `tb_seller` ( `sellerid` varchar (100), `name` varchar (100), `nickname` varchar (50), `password` varchar (60), `status` varchar (1), `address` varchar (100), `createtime` datetime, PRIMARY KEY(`sellerid`))ENGINE=INNODB DEFAULT CHARSET=utf8mb4;INSERT INTO `tb_seller` (`sellerid`, `name`, `nickname`, `password`, `status`, `address`, `createtime`) values(&#x27;xiaomi&#x27;,&#x27;å°ç±³ç§‘æŠ€&#x27;,&#x27;å°ç±³å®˜æ–¹æ——èˆ°åº—&#x27;,&#x27;e10adc3949ba59abbe56e057f20f883e&#x27;,&#x27;1&#x27;,&#x27;è¥¿å®‰å¸‚&#x27;,&#x27;2088-01-01 12:00:00&#x27;);CREATE INDEX idx_seller_name_sta_addr ON tb_seller(name, status, address); # è”åˆç´¢å¼• é¿å…å¤±æ•ˆè¯­å¥é”™è¯¯ å…¨å€¼åŒ¹é…ï¼šå¯¹ç´¢å¼•ä¸­æ‰€æœ‰åˆ—éƒ½æŒ‡å®šå…·ä½“å€¼ï¼Œè¿™ç§æƒ…å†µç´¢å¼•ç”Ÿæ•ˆï¼Œæ‰§è¡Œæ•ˆç‡é«˜ 1EXPLAIN SELECT * FROM tb_seller WHERE name=&#x27;å°ç±³ç§‘æŠ€&#x27; AND status=&#x27;1&#x27; AND address=&#x27;è¥¿å®‰å¸‚&#x27;; æœ€å·¦å‰ç¼€æ³•åˆ™ï¼šè”åˆç´¢å¼•éµå®ˆæœ€å·¦å‰ç¼€æ³•åˆ™ åŒ¹é…æœ€å·¦å‰ç¼€æ³•åˆ™ï¼Œèµ°ç´¢å¼•ï¼š 12EXPLAIN SELECT * FROM tb_seller WHERE name=&#x27;å°ç±³ç§‘æŠ€&#x27;;EXPLAIN SELECT * FROM tb_seller WHERE name=&#x27;å°ç±³ç§‘æŠ€&#x27; AND status=&#x27;1&#x27;; è¿æ³•æœ€å·¦å‰ç¼€æ³•åˆ™ ï¼Œ ç´¢å¼•å¤±æ•ˆï¼š 12EXPLAIN SELECT * FROM tb_seller WHERE status=&#x27;1&#x27;;EXPLAIN SELECT * FROM tb_seller WHERE status=&#x27;1&#x27; AND address=&#x27;è¥¿å®‰å¸‚&#x27;; å¦‚æœç¬¦åˆæœ€å·¦æ³•åˆ™ï¼Œä½†æ˜¯å‡ºç°è·³è·ƒæŸä¸€åˆ—ï¼Œåªæœ‰æœ€å·¦åˆ—ç´¢å¼•ç”Ÿæ•ˆï¼š 1EXPLAIN SELECT * FROM tb_seller WHERE name=&#x27;å°ç±³ç§‘æŠ€&#x27; AND address=&#x27;è¥¿å®‰å¸‚&#x27;; è™½ç„¶ç´¢å¼•åˆ—å¤±æ•ˆï¼Œä½†æ˜¯ç³»ç»Ÿä¼šä½¿ç”¨äº†ç´¢å¼•ä¸‹æ¨è¿›è¡Œäº†ä¼˜åŒ– èŒƒå›´æŸ¥è¯¢å³è¾¹çš„åˆ—ï¼Œä¸èƒ½ä½¿ç”¨ç´¢å¼•ï¼š 1EXPLAIN SELECT * FROM tb_seller WHERE name=&#x27;å°ç±³ç§‘æŠ€&#x27; AND status&gt;&#x27;1&#x27; AND address=&#x27;è¥¿å®‰å¸‚&#x27;; æ ¹æ®å‰é¢çš„ä¸¤ä¸ªå­—æ®µ name ï¼Œ status æŸ¥è¯¢æ˜¯èµ°ç´¢å¼•çš„ï¼Œ ä½†æ˜¯æœ€åä¸€ä¸ªæ¡ä»¶ address æ²¡æœ‰ç”¨åˆ°ç´¢å¼•ï¼Œä½¿ç”¨äº†ç´¢å¼•ä¸‹æ¨ åœ¨ç´¢å¼•åˆ—ä¸Šå‡½æ•°æˆ–è€…è¿ç®—ï¼ˆ+ - æ•°å€¼ï¼‰æ“ä½œï¼Œ ç´¢å¼•å°†å¤±æ•ˆï¼šä¼šç ´åç´¢å¼•å€¼çš„æœ‰åºæ€§ 1EXPLAIN SELECT * FROM tb_seller WHERE SUBSTRING(name,3,2) = &#x27;ç§‘æŠ€&#x27;; å­—ç¬¦ä¸²ä¸åŠ å•å¼•å·ï¼Œé€ æˆç´¢å¼•å¤±æ•ˆï¼šéšå¼ç±»å‹è½¬æ¢ï¼Œå½“å­—ç¬¦ä¸²å’Œæ•°å­—æ¯”è¾ƒæ—¶ä¼šæŠŠå­—ç¬¦ä¸²è½¬åŒ–ä¸ºæ•°å­— æ²¡æœ‰å¯¹å­—ç¬¦ä¸²åŠ å•å¼•å·ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šè°ƒç”¨ CAST å‡½æ•°å°† status è½¬æ¢ä¸º int è¿›è¡Œæ¯”è¾ƒï¼Œé€ æˆç´¢å¼•å¤±æ•ˆ 1EXPLAIN SELECT * FROM tb_seller WHERE name=&#x27;å°ç±³ç§‘æŠ€&#x27; AND status = 1; å¦‚æœ status æ˜¯ int ç±»å‹ï¼ŒSQL ä¸º SELECT * FROM tb_seller WHERE status = &#39;1&#39; å¹¶ä¸ä¼šé€ æˆç´¢å¼•å¤±æ•ˆï¼Œå› ä¸ºä¼šå°† &#39;1&#39; è½¬æ¢ä¸º 1ï¼Œå¹¶ä¸ä¼šå¯¹ç´¢å¼•åˆ—äº§ç”Ÿæ“ä½œ å¤šè¡¨è¿æ¥æŸ¥è¯¢æ—¶ï¼Œå¦‚æœä¸¤å¼ è¡¨çš„å­—ç¬¦é›†ä¸åŒï¼Œä¼šé€ æˆç´¢å¼•å¤±æ•ˆï¼Œå› ä¸ºä¼šè¿›è¡Œç±»å‹è½¬æ¢ è§£å†³æ–¹æ³•ï¼šCONVERT å‡½æ•°æ˜¯åŠ åœ¨è¾“å…¥å‚æ•°ä¸Šã€ä¿®æ”¹è¡¨çš„å­—ç¬¦é›† ç”¨ OR åˆ†å‰²æ¡ä»¶ï¼Œç´¢å¼•å¤±æ•ˆï¼Œå¯¼è‡´å…¨è¡¨æŸ¥è¯¢ï¼š OR å‰çš„æ¡ä»¶ä¸­çš„åˆ—æœ‰ç´¢å¼•è€Œåé¢çš„åˆ—ä¸­æ²¡æœ‰ç´¢å¼•æˆ– OR å‰åä¸¤ä¸ªåˆ—æ˜¯åŒä¸€ä¸ªå¤åˆç´¢å¼•ï¼Œéƒ½é€ æˆç´¢å¼•å¤±æ•ˆ 12EXPLAIN SELECT * FROM tb_seller WHERE name=&#x27;é˜¿é‡Œå·´å·´&#x27; OR createtime = &#x27;2088-01-01 12:00:00&#x27;;EXPLAIN SELECT * FROM tb_seller WHERE name=&#x27;å°ç±³ç§‘æŠ€&#x27; OR status=&#x27;1&#x27;; AND åˆ†å‰²çš„æ¡ä»¶ä¸å½±å“ï¼š 1EXPLAIN SELECT * FROM tb_seller WHERE name=&#x27;é˜¿é‡Œå·´å·´&#x27; AND createtime = &#x27;2088-01-01 12:00:00&#x27;; ä»¥ % å¼€å¤´çš„ LIKE æ¨¡ç³ŠæŸ¥è¯¢ï¼Œç´¢å¼•å¤±æ•ˆï¼š å¦‚æœæ˜¯å°¾éƒ¨æ¨¡ç³ŠåŒ¹é…ï¼Œç´¢å¼•ä¸ä¼šå¤±æ•ˆï¼›å¦‚æœæ˜¯å¤´éƒ¨æ¨¡ç³ŠåŒ¹é…ï¼Œç´¢å¼•å¤±æ•ˆ 1EXPLAIN SELECT * FROM tb_seller WHERE name like &#x27;%ç§‘æŠ€%&#x27;; è§£å†³æ–¹æ¡ˆï¼šé€šè¿‡è¦†ç›–ç´¢å¼•æ¥è§£å†³ 1EXPLAIN SELECT sellerid,name,status FROM tb_seller WHERE name like &#x27;%ç§‘æŠ€%&#x27;; åŸå› ï¼šåœ¨è¦†ç›–ç´¢å¼•çš„è¿™æ£µ B+ æ•°ä¸Šåªéœ€è¦è¿›è¡Œ like çš„åŒ¹é…ï¼Œæˆ–è€…æ˜¯åŸºäºè¦†ç›–ç´¢å¼•æŸ¥è¯¢å†è¿›è¡Œ WHERE çš„åˆ¤æ–­å°±å¯ä»¥è·å¾—ç»“æœ ç³»ç»Ÿä¼˜åŒ–ç³»ç»Ÿä¼˜åŒ–ä¸ºå…¨è¡¨æ‰«æï¼š å¦‚æœ MySQL è¯„ä¼°ä½¿ç”¨ç´¢å¼•æ¯”å…¨è¡¨æ›´æ…¢ï¼Œåˆ™ä¸ä½¿ç”¨ç´¢å¼•ï¼Œç´¢å¼•å¤±æ•ˆï¼š 123CREATE INDEX idx_address ON tb_seller(address);EXPLAIN SELECT * FROM tb_seller WHERE address=&#x27;è¥¿å®‰å¸‚&#x27;;EXPLAIN SELECT * FROM tb_seller WHERE address=&#x27;åŒ—äº¬å¸‚&#x27;; åŒ—äº¬å¸‚çš„é”®å€¼å  9&#x2F;10ï¼ˆåŒºåˆ†åº¦ä½ï¼‰ï¼Œæ‰€ä»¥ä¼˜åŒ–ä¸ºå…¨è¡¨æ‰«æï¼Œtype &#x3D; ALL IS NULLã€IS NOT NULL æœ‰æ—¶ç´¢å¼•å¤±æ•ˆï¼š 12EXPLAIN SELECT * FROM tb_seller WHERE name IS NULL;EXPLAIN SELECT * FROM tb_seller WHERE name IS NOT NULL; NOT NULL å¤±æ•ˆçš„åŸå› æ˜¯ name åˆ—å…¨éƒ¨ä¸æ˜¯ nullï¼Œä¼˜åŒ–ä¸ºå…¨è¡¨æ‰«æï¼Œå½“ NULL è¿‡å¤šæ—¶ï¼ŒIS NULL å¤±æ•ˆ IN è‚¯å®šä¼šèµ°ç´¢å¼•ï¼Œä½†æ˜¯å½“ IN çš„å–å€¼èŒƒå›´è¾ƒå¤§æ—¶ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆï¼Œèµ°å…¨è¡¨æ‰«æï¼š 12EXPLAIN SELECT * FROM tb_seller WHERE sellerId IN (&#x27;alibaba&#x27;,&#x27;huawei&#x27;);-- éƒ½èµ°ç´¢å¼•EXPLAIN SELECT * FROM tb_seller WHERE sellerId NOT IN (&#x27;alibaba&#x27;,&#x27;huawei&#x27;); MySQL å®æˆ˜ 45 è®²è¯¥ç« èŠ‚æœ€åæå‡ºäº†ä¸€ç§æ…¢æŸ¥è¯¢åœºæ™¯ï¼Œè·å–åˆ°æ•°æ®ä»¥å Server å±‚è¿˜ä¼šåšåˆ¤æ–­ åº•å±‚åŸç†ç´¢å¼•å¤±æ•ˆä¸€èˆ¬æ˜¯é’ˆå¯¹è”åˆç´¢å¼•ï¼Œè”åˆç´¢å¼•ä¸€èˆ¬ç”±å‡ ä¸ªå­—æ®µç»„æˆï¼Œæ’åºæ–¹å¼æ˜¯å…ˆæŒ‰ç…§ç¬¬ä¸€ä¸ªå­—æ®µè¿›è¡Œæ’åºï¼Œç„¶åæ’åºç¬¬äºŒä¸ªï¼Œä¾æ­¤ç±»æ¨ï¼Œå›¾ç¤ºï¼ˆa, bï¼‰ç´¢å¼•ï¼Œa ç›¸ç­‰çš„æƒ…å†µä¸‹ b æ˜¯æœ‰åºçš„ æœ€å·¦å‰ç¼€æ³•åˆ™ï¼šå½“ä¸åŒ¹é…å‰é¢çš„å­—æ®µçš„æ—¶å€™ï¼Œåé¢çš„å­—æ®µéƒ½æ˜¯æ— åºçš„ã€‚è¿™ç§æ— åºä¸ä»…ä½“ç°åœ¨å¶å­èŠ‚ç‚¹ï¼Œä¹Ÿä¼šå¯¼è‡´æŸ¥è¯¢æ—¶æ‰«æçš„éå¶å­èŠ‚ç‚¹ä¹Ÿæ˜¯æ— åºçš„ï¼Œå› ä¸ºç´¢å¼•æ ‘ç›¸å½“äºå¿½ç•¥çš„ç¬¬ä¸€ä¸ªå­—æ®µï¼Œå°±æ— æ³•ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾ èŒƒå›´æŸ¥è¯¢å³è¾¹çš„åˆ—ï¼Œä¸èƒ½ä½¿ç”¨ç´¢å¼•ï¼Œæ¯”å¦‚è¯­å¥ï¼š WHERE a &gt; 1 AND b = 1 ï¼Œåœ¨ a å¤§äº 1 çš„æ—¶å€™ï¼Œb æ˜¯æ— åºçš„ï¼Œa &gt; 1 æ˜¯æ‰«ææ—¶æœ‰åºçš„ï¼Œä½†æ˜¯æ‰¾åˆ°ä»¥åè¿›è¡Œå¯»æ‰¾ b æ—¶ï¼Œç´¢å¼•æ ‘å°±ä¸æ˜¯æœ‰åºçš„äº† ä»¥ % å¼€å¤´çš„ LIKE æ¨¡ç³ŠæŸ¥è¯¢ï¼Œç´¢å¼•å¤±æ•ˆï¼Œæ¯”å¦‚è¯­å¥ï¼šWHERE a LIKE &#39;%d&#39;ï¼Œå‰é¢çš„ä¸ç¡®å®šï¼Œå¯¼è‡´ä¸ç¬¦åˆæœ€å·¦åŒ¹é…ï¼Œç›´æ¥å»ç´¢å¼•ä¸­æœç´¢ä»¥ d ç»“å°¾çš„èŠ‚ç‚¹ï¼Œæ‰€ä»¥æ²¡æœ‰é¡ºåº å‚è€ƒæ–‡ç« ï¼šhttps://mp.weixin.qq.com/s/B_M09dzLe9w7cT46rdGIeQ æŸ¥çœ‹ç´¢å¼•12SHOW STATUS LIKE &#x27;Handler_read%&#x27;; SHOW GLOBAL STATUS LIKE &#x27;Handler_read%&#x27;; Handler_read_firstï¼šç´¢å¼•ä¸­ç¬¬ä¸€æ¡è¢«è¯»çš„æ¬¡æ•°ï¼Œå¦‚æœè¾ƒé«˜ï¼Œè¡¨ç¤ºæœåŠ¡å™¨æ­£æ‰§è¡Œå¤§é‡å…¨ç´¢å¼•æ‰«æï¼ˆè¿™ä¸ªå€¼è¶Šä½è¶Šå¥½ï¼‰ Handler_read_keyï¼šå¦‚æœç´¢å¼•æ­£åœ¨å·¥ä½œï¼Œè¿™ä¸ªå€¼ä»£è¡¨ä¸€ä¸ªè¡Œè¢«ç´¢å¼•å€¼è¯»çš„æ¬¡æ•°ï¼Œå€¼è¶Šä½è¡¨ç¤ºç´¢å¼•ä¸ç»å¸¸ä½¿ç”¨ï¼ˆè¿™ä¸ªå€¼è¶Šé«˜è¶Šå¥½ï¼‰ Handler_read_nextï¼šæŒ‰ç…§é”®é¡ºåºè¯»ä¸‹ä¸€è¡Œçš„è¯·æ±‚æ•°ï¼Œå¦‚æœèŒƒå›´çº¦æŸæˆ–æ‰§è¡Œç´¢å¼•æ‰«ææ¥æŸ¥è¯¢ç´¢å¼•åˆ—ï¼Œå€¼å¢åŠ  Handler_read_prevï¼šæŒ‰ç…§é”®é¡ºåºè¯»å‰ä¸€è¡Œçš„è¯·æ±‚æ•°ï¼Œè¯¥è¯»æ–¹æ³•ä¸»è¦ç”¨äºä¼˜åŒ– ORDER BY â€¦ DESC Handler_read_rndï¼šæ ¹æ®å›ºå®šä½ç½®è¯»ä¸€è¡Œçš„è¯·æ±‚æ•°ï¼Œå¦‚æœæ‰§è¡Œå¤§é‡æŸ¥è¯¢å¹¶å¯¹ç»“æœè¿›è¡Œæ’åºåˆ™è¯¥å€¼è¾ƒé«˜ï¼Œå¯èƒ½æ˜¯ä½¿ç”¨äº†å¤§é‡éœ€è¦ MySQL æ‰«ææ•´ä¸ªè¡¨çš„æŸ¥è¯¢æˆ–è¿æ¥ï¼Œè¿™ä¸ªå€¼è¾ƒé«˜æ„å‘³ç€è¿è¡Œæ•ˆç‡ä½ï¼Œåº”è¯¥å»ºç«‹ç´¢å¼•æ¥è§£å†³ Handler_read_rnd_nextï¼šåœ¨æ•°æ®æ–‡ä»¶ä¸­è¯»ä¸‹ä¸€è¡Œçš„è¯·æ±‚æ•°ï¼Œå¦‚æœæ­£è¿›è¡Œå¤§é‡çš„è¡¨æ‰«æï¼Œè¯¥å€¼è¾ƒé«˜ï¼Œè¯´æ˜è¡¨ç´¢å¼•ä¸æ­£ç¡®æˆ–å†™å…¥çš„æŸ¥è¯¢æ²¡æœ‰åˆ©ç”¨ç´¢å¼• SQL ä¼˜åŒ–è‡ªå¢ä¸»é”®è‡ªå¢æœºåˆ¶è‡ªå¢ä¸»é”®å¯ä»¥è®©ä¸»é”®ç´¢å¼•å°½é‡åœ°ä¿æŒåœ¨æ•°æ®é¡µä¸­é€’å¢é¡ºåºæ’å…¥ï¼Œä¸è‡ªå¢éœ€è¦å¯»æ‰¾å…¶ä»–é¡µæ’å…¥ï¼Œå¯¼è‡´éšæœº IO å’Œé¡µåˆ†è£‚çš„æƒ…å†µ è¡¨çš„ç»“æ„å®šä¹‰å­˜æ”¾åœ¨åç¼€åä¸º.frm çš„æ–‡ä»¶ä¸­ï¼Œä½†æ˜¯å¹¶ä¸ä¼šä¿å­˜è‡ªå¢å€¼ï¼Œä¸åŒçš„å¼•æ“å¯¹äºè‡ªå¢å€¼çš„ä¿å­˜ç­–ç•¥ä¸åŒï¼š MyISAM å¼•æ“çš„è‡ªå¢å€¼ä¿å­˜åœ¨æ•°æ®æ–‡ä»¶ä¸­ InnoDB å¼•æ“çš„è‡ªå¢å€¼ä¿å­˜åœ¨äº†å†…å­˜é‡Œï¼Œæ¯æ¬¡æ‰“å¼€è¡¨éƒ½ä¼šå»æ‰¾è‡ªå¢å€¼çš„æœ€å¤§å€¼ max(id)ï¼Œç„¶åå°† max(id)+1 ä½œä¸ºå½“å‰çš„è‡ªå¢å€¼ï¼›8.0 ç‰ˆæœ¬åï¼Œæ‰æœ‰äº†è‡ªå¢å€¼æŒä¹…åŒ–çš„èƒ½åŠ›ï¼Œå°†è‡ªå¢å€¼çš„å˜æ›´è®°å½•åœ¨äº† redo log ä¸­ï¼Œé‡å¯çš„æ—¶å€™ä¾é  redo log æ¢å¤é‡å¯ä¹‹å‰çš„å€¼ åœ¨æ’å…¥ä¸€è¡Œæ•°æ®çš„æ—¶å€™ï¼Œè‡ªå¢å€¼çš„è¡Œä¸ºå¦‚ä¸‹ï¼š å¦‚æœæ’å…¥æ•°æ®æ—¶ id å­—æ®µæŒ‡å®šä¸º 0ã€null æˆ–æœªæŒ‡å®šå€¼ï¼Œé‚£ä¹ˆå°±æŠŠè¿™ä¸ªè¡¨å½“å‰çš„ AUTO_INCREMENT å€¼å¡«åˆ°è‡ªå¢å­—æ®µ å¦‚æœæ’å…¥æ•°æ®æ—¶ id å­—æ®µæŒ‡å®šäº†å…·ä½“çš„å€¼ï¼Œæ¯”å¦‚æŸæ¬¡è¦æ’å…¥çš„å€¼æ˜¯ Xï¼Œå½“å‰çš„è‡ªå¢å€¼æ˜¯ Y å¦‚æœ X&lt;Yï¼Œé‚£ä¹ˆè¿™ä¸ªè¡¨çš„è‡ªå¢å€¼ä¸å˜ å¦‚æœ Xâ‰¥Yï¼Œå°±éœ€è¦æŠŠå½“å‰è‡ªå¢å€¼ä¿®æ”¹ä¸ºæ–°çš„è‡ªå¢å€¼ å‚æ•°è¯´æ˜ï¼šauto_increment_offset å’Œ auto_increment_increment åˆ†åˆ«è¡¨ç¤ºè‡ªå¢çš„åˆå§‹å€¼å’Œæ­¥é•¿ï¼Œé»˜è®¤å€¼éƒ½æ˜¯ 1 è¯­å¥æ‰§è¡Œå¤±è´¥ä¹Ÿä¸å›é€€è‡ªå¢ idï¼Œæ‰€ä»¥ä¿è¯äº†è‡ªå¢ id æ˜¯é€’å¢çš„ï¼Œä½†ä¸ä¿è¯æ˜¯è¿ç»­çš„ï¼ˆä¸èƒ½å›é€€ï¼Œæ‰€ä»¥æœ‰äº›å›æ»šäº‹åŠ¡çš„è‡ªå¢ id å°±ä¸ä¼šé‡æ–°ä½¿ç”¨ï¼Œå¯¼è‡´å‡ºç°ä¸è¿ç»­ï¼‰ è‡ªå¢ IDMySQL ä¸åŒçš„è‡ªå¢ id åœ¨è¾¾åˆ°ä¸Šé™åçš„è¡¨ç°ä¸åŒï¼š è¡¨çš„è‡ªå¢ id å¦‚æœæ˜¯ int ç±»å‹ï¼Œè¾¾åˆ°ä¸Šé™ 2^32-1 åï¼Œå†ç”³è¯·æ—¶å€¼å°±ä¸ä¼šæ”¹å˜ï¼Œè¿›è€Œå¯¼è‡´ç»§ç»­æ’å…¥æ•°æ®æ—¶æŠ¥ä¸»é”®å†²çªçš„é”™è¯¯ row_id é•¿åº¦ä¸º 6 ä¸ªå­—èŠ‚ï¼Œè¾¾åˆ°ä¸Šé™ååˆ™ä¼šå½’ 0 å†é‡æ–°é€’å¢ï¼Œå¦‚æœå‡ºç°ç›¸åŒçš„ row_idï¼Œåå†™çš„æ•°æ®ä¼šè¦†ç›–ä¹‹å‰çš„æ•°æ®ï¼Œé€ æˆæ—§æ•°æ®ä¸¢å¤±ï¼Œå½±å“çš„æ˜¯æ•°æ®å¯é æ€§ï¼Œæ‰€ä»¥åº”è¯¥åœ¨ InnoDB è¡¨ä¸­ä¸»åŠ¨åˆ›å»ºè‡ªå¢ä¸»é”®æŠ¥ä¸»é”®å†²çªï¼Œæ’å…¥å¤±è´¥å½±å“çš„æ˜¯å¯ç”¨æ€§ï¼Œè€Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¯é æ€§ä¼˜å…ˆäºå¯ç”¨æ€§ Xid é•¿åº¦ 8 å­—èŠ‚ï¼Œç”± Server å±‚ç»´æŠ¤ï¼Œåªéœ€è¦ä¸åœ¨åŒä¸€ä¸ª binlog æ–‡ä»¶ä¸­å‡ºç°é‡å¤å€¼å³å¯ï¼Œè™½ç„¶ç†è®ºä¸Šä¼šå‡ºç°é‡å¤å€¼ï¼Œä½†æ˜¯æ¦‚ç‡æå° InnoDB çš„ max_trx_id é€’å¢å€¼æ¯æ¬¡ MySQL é‡å¯éƒ½ä¼šè¢«ä¿å­˜èµ·æ¥ï¼Œé‡å¯ä¹Ÿä¸ä¼šé‡ç½®ä¸º 0ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´ä¸€ç›´å¢åŠ åˆ°è¾¾ä¸Šé™ï¼Œç„¶åä» 0 å¼€å§‹ï¼Œè¿™æ—¶åŸäº‹åŠ¡ 0 ä¿®æ”¹çš„æ•°æ®å¯¹å½“å‰äº‹åŠ¡å°±æ˜¯å¯è§çš„ï¼Œäº§ç”Ÿè„è¯»çš„ç°è±¡ åªè¯»äº‹åŠ¡ä¸åˆ†é… trx_idï¼Œæ‰€ä»¥ trx_id çš„å¢åŠ é€Ÿåº¦å˜æ…¢äº† thread_id é•¿åº¦ 4 ä¸ªå­—èŠ‚ï¼Œåˆ°è¾¾ä¸Šé™åå°±ä¼šé‡ç½®ä¸º 0ï¼ŒMySQL è®¾è®¡äº†ä¸€ä¸ªå”¯ä¸€æ•°ç»„çš„é€»è¾‘ï¼Œç»™æ–°çº¿ç¨‹åˆ†é… thread_id æ—¶åšåˆ¤æ–­ï¼Œä¿è¯ä¸ä¼šå‡ºç°ä¸¤ä¸ªç›¸åŒçš„ thread_idï¼š 123do &#123; new_id = thread_id_counter++;&#125; while (!thread_ids.insert_unique(new_id).second); å‚è€ƒæ–‡ç« ï¼šhttps://time.geekbang.org/column/article/83183 è¦†ç›–ç´¢å¼•å¤åˆç´¢å¼•å¶å­èŠ‚ç‚¹ä¸ä»…ä¿å­˜äº†å¤åˆç´¢å¼•çš„å€¼ï¼Œè¿˜æœ‰ä¸»é”®ç´¢å¼•ï¼Œæ‰€ä»¥ä½¿ç”¨è¦†ç›–ç´¢å¼•çš„æ—¶å€™ï¼ŒåŠ ä¸Šä¸»é”®ä¹Ÿä¼šç”¨åˆ°ç´¢å¼• å°½é‡ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œé¿å… SELECT *ï¼š 1EXPLAIN SELECT name,status,address FROM tb_seller WHERE name=&#x27;å°ç±³ç§‘æŠ€&#x27; AND status=&#x27;1&#x27; AND address=&#x27;è¥¿å®‰å¸‚&#x27;; å¦‚æœæŸ¥è¯¢åˆ—ï¼Œè¶…å‡ºç´¢å¼•åˆ—ï¼Œä¹Ÿä¼šé™ä½æ€§èƒ½ï¼š 1EXPLAIN SELECT name,status,address,password FROM tb_seller WHERE name=&#x27;å°ç±³ç§‘æŠ€&#x27; AND status=&#x27;1&#x27; AND address=&#x27;è¥¿å®‰å¸‚&#x27;; å‡å°‘è®¿é—®é¿å…å¯¹æ•°æ®è¿›è¡Œé‡å¤æ£€ç´¢ï¼šèƒ½å¤Ÿä¸€æ¬¡è¿æ¥å°±è·å–åˆ°ç»“æœçš„ï¼Œå°±ä¸ç”¨ä¸¤æ¬¡è¿æ¥ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§å‡å°‘å¯¹æ•°æ®åº“æ— ç”¨çš„é‡å¤è¯·æ±‚ æŸ¥è¯¢æ•°æ®ï¼š 1234SELECT id,name FROM tb_book;SELECT id,status FROM tb_book; -- å‘æ•°æ®åº“æäº¤ä¸¤æ¬¡è¯·æ±‚ï¼Œæ•°æ®åº“å°±è¦åšä¸¤æ¬¡æŸ¥è¯¢æ“ä½œ-- &gt; ä¼˜åŒ–ä¸º:SELECT id,name,statu FROM tb_book; æ’å…¥æ•°æ®ï¼š 12345INSERT INTO tb_test VALUES(1,&#x27;Tom&#x27;);INSERT INTO tb_test VALUES(2,&#x27;Cat&#x27;);INSERT INTO tb_test VALUES(3,&#x27;Jerry&#x27;); -- è¿æ¥ä¸‰æ¬¡æ•°æ®åº“-- &gt;ä¼˜åŒ–ä¸ºINSERT INTO tb_test VALUES(1,&#x27;Tom&#x27;),(2,&#x27;Cat&#x27;)ï¼Œ(3,&#x27;Jerry&#x27;); -- è¿æ¥ä¸€æ¬¡ åœ¨äº‹åŠ¡ä¸­è¿›è¡Œæ•°æ®æ’å…¥ï¼š 12345start transaction;INSERT INTO tb_test VALUES(1,&#x27;Tom&#x27;);INSERT INTO tb_test VALUES(2,&#x27;Cat&#x27;);INSERT INTO tb_test VALUES(3,&#x27;Jerry&#x27;);commit; -- æ‰‹åŠ¨æäº¤ï¼Œåˆ†æ®µæäº¤ æ•°æ®æœ‰åºæ’å…¥ï¼š 123INSERT INTO tb_test VALUES(1,&#x27;Tom&#x27;);INSERT INTO tb_test VALUES(2,&#x27;Cat&#x27;);INSERT INTO tb_test VALUES(3,&#x27;Jerry&#x27;); å¢åŠ  cache å±‚ï¼šåœ¨åº”ç”¨ä¸­å¢åŠ ç¼“å­˜å±‚æ¥è¾¾åˆ°å‡è½»æ•°æ®åº“è´Ÿæ‹…çš„ç›®çš„ã€‚å¯ä»¥éƒ¨åˆ†æ•°æ®ä»æ•°æ®åº“ä¸­æŠ½å–å‡ºæ¥æ”¾åˆ°åº”ç”¨ç«¯ä»¥æ–‡æœ¬æ–¹å¼å­˜å‚¨ï¼Œæˆ–è€…ä½¿ç”¨æ¡†æ¶ï¼ˆMybatisï¼‰æä¾›çš„ä¸€çº§ç¼“å­˜ &#x2F; äºŒçº§ç¼“å­˜ï¼Œæˆ–è€…ä½¿ç”¨ Redis æ•°æ®åº“æ¥ç¼“å­˜æ•°æ® æ•°æ®æ’å…¥å½“ä½¿ç”¨ load å‘½ä»¤å¯¼å…¥æ•°æ®çš„æ—¶å€™ï¼Œé€‚å½“çš„è®¾ç½®å¯ä»¥æé«˜å¯¼å…¥çš„æ•ˆç‡ï¼š ![](https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/MySQL-ä¼˜åŒ–SQL load data.png) 1LOAD DATA LOCAL INFILE = &#x27;/home/seazean/sql1.log&#x27; INTO TABLE `tb_user_1` FIELD TERMINATED BY &#x27;,&#x27; LINES TERMINATED BY &#x27;\\n&#x27;; -- æ–‡ä»¶æ ¼å¼å¦‚ä¸Šå›¾ å¯¹äº InnoDB ç±»å‹çš„è¡¨ï¼Œæœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼å¯ä»¥æé«˜å¯¼å…¥çš„æ•ˆç‡ï¼š ä¸»é”®é¡ºåºæ’å…¥ï¼šå› ä¸º InnoDB ç±»å‹çš„è¡¨æ˜¯æŒ‰ç…§ä¸»é”®çš„é¡ºåºä¿å­˜çš„ï¼Œæ‰€ä»¥å°†å¯¼å…¥çš„æ•°æ®æŒ‰ç…§ä¸»é”®çš„é¡ºåºæ’åˆ—ï¼Œå¯ä»¥æœ‰æ•ˆçš„æé«˜å¯¼å…¥æ•°æ®çš„æ•ˆç‡ï¼Œå¦‚æœ InnoDB è¡¨æ²¡æœ‰ä¸»é”®ï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šè‡ªåŠ¨é»˜è®¤åˆ›å»ºä¸€ä¸ªå†…éƒ¨åˆ—ä½œä¸ºä¸»é”® ä¸»é”®æ˜¯å¦è¿ç»­å¯¹æ€§èƒ½å½±å“ä¸å¤§ï¼Œåªè¦æ˜¯é€’å¢çš„å°±å¯ä»¥ï¼Œæ¯”å¦‚é›ªèŠ±ç®—æ³•äº§ç”Ÿçš„ ID ä¸æ˜¯è¿ç»­çš„ï¼Œä½†æ˜¯æ˜¯é€’å¢çš„ï¼Œå› ä¸ºé€’å¢å¯ä»¥è®©ä¸»é”®ç´¢å¼•å°½é‡åœ°ä¿æŒé¡ºåºæ’å…¥ï¼Œé¿å…äº†é¡µåˆ†è£‚ï¼Œå› æ­¤ç´¢å¼•æ›´ç´§å‡‘ æ’å…¥ ID é¡ºåºæ’åˆ—æ•°æ®ï¼š æ’å…¥ ID æ— åºæ’åˆ—æ•°æ®ï¼š å…³é—­å”¯ä¸€æ€§æ ¡éªŒï¼šåœ¨å¯¼å…¥æ•°æ®å‰æ‰§è¡Œ SET UNIQUE_CHECKS=0ï¼Œå…³é—­å”¯ä¸€æ€§æ ¡éªŒï¼›å¯¼å…¥ç»“æŸåæ‰§è¡Œ SET UNIQUE_CHECKS=1ï¼Œæ¢å¤å”¯ä¸€æ€§æ ¡éªŒï¼Œå¯ä»¥æé«˜å¯¼å…¥çš„æ•ˆç‡ã€‚ æ‰‹åŠ¨æäº¤äº‹åŠ¡ï¼šå¦‚æœåº”ç”¨ä½¿ç”¨è‡ªåŠ¨æäº¤çš„æ–¹å¼ï¼Œå»ºè®®åœ¨å¯¼å…¥å‰æ‰§è¡ŒSET AUTOCOMMIT=0ï¼Œå…³é—­è‡ªåŠ¨æäº¤ï¼›å¯¼å…¥ç»“æŸåå†æ‰“å¼€è‡ªåŠ¨æäº¤ï¼Œå¯ä»¥æé«˜å¯¼å…¥çš„æ•ˆç‡ã€‚ äº‹åŠ¡éœ€è¦æ§åˆ¶å¤§å°ï¼Œäº‹åŠ¡å¤ªå¤§å¯èƒ½ä¼šå½±å“æ‰§è¡Œçš„æ•ˆç‡ã€‚MySQL æœ‰ innodb_log_buffer_size é…ç½®é¡¹ï¼Œè¶…è¿‡è¿™ä¸ªå€¼çš„æ—¥å¿—ä¼šå†™å…¥ç£ç›˜æ•°æ®ï¼Œæ•ˆç‡ä¼šä¸‹é™ï¼Œæ‰€ä»¥åœ¨äº‹åŠ¡å¤§å°è¾¾åˆ°é…ç½®é¡¹æ•°æ®çº§å‰è¿›è¡Œäº‹åŠ¡æäº¤å¯ä»¥æé«˜æ•ˆç‡ åˆ†ç»„æ’åºORDERæ•°æ®å‡†å¤‡ï¼š 123456789CREATE TABLE `emp` ( `id` INT(11) NOT NULL AUTO_INCREMENT, `name` VARCHAR(100) NOT NULL, `age` INT(3) NOT NULL, `salary` INT(11) DEFAULT NULL, PRIMARY KEY (`id`)) ENGINE=INNODB DEFAULT CHARSET=utf8mb4;INSERT INTO `emp` (`id`, `name`, `age`, `salary`) VALUES(&#x27;1&#x27;,&#x27;Tom&#x27;,&#x27;25&#x27;,&#x27;2300&#x27;);-- ...CREATE INDEX idx_emp_age_salary ON emp(age, salary); ç¬¬ä¸€ç§æ˜¯é€šè¿‡å¯¹è¿”å›æ•°æ®è¿›è¡Œæ’åºï¼Œæ‰€æœ‰ä¸é€šè¿‡ç´¢å¼•ç›´æ¥è¿”å›ç»“æœçš„æ’åºéƒ½å« FileSort æ’åºï¼Œä¼šåœ¨å†…å­˜ä¸­é‡æ–°æ’åº 1EXPLAIN SELECT * FROM emp ORDER BY age DESC; -- å¹´é¾„é™åº ![](https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/MySQL-ä¼˜åŒ–SQL ORDER BYæ’åº1.png) ç¬¬äºŒç§é€šè¿‡æœ‰åºç´¢å¼•é¡ºåºæ‰«æç›´æ¥è¿”å›æœ‰åºæ•°æ®ï¼Œè¿™ç§æƒ…å†µä¸º Using indexï¼Œä¸éœ€è¦é¢å¤–æ’åºï¼Œæ“ä½œæ•ˆç‡é«˜ 1EXPLAIN SELECT id, age, salary FROM emp ORDER BY age DESC; ![](https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/MySQL-ä¼˜åŒ–SQL ORDER BYæ’åº2.png) å¤šå­—æ®µæ’åºï¼š 123EXPLAIN SELECT id,age,salary FROM emp ORDER BY age DESC, salary DESC;EXPLAIN SELECT id,age,salary FROM emp ORDER BY salary DESC, age DESC;EXPLAIN SELECT id,age,salary FROM emp ORDER BY age DESC, salary ASC; ![](https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/MySQL-ä¼˜åŒ–SQL ORDER BYæ’åº3.png) å°½é‡å‡å°‘é¢å¤–çš„æ’åºï¼Œé€šè¿‡ç´¢å¼•ç›´æ¥è¿”å›æœ‰åºæ•°æ®ã€‚éœ€è¦æ»¡è¶³ Order by ä½¿ç”¨ç›¸åŒçš„ç´¢å¼•ã€Order By çš„é¡ºåºå’Œç´¢å¼•é¡ºåºç›¸åŒã€Order by çš„å­—æ®µéƒ½æ˜¯å‡åºæˆ–éƒ½æ˜¯é™åºï¼Œå¦åˆ™éœ€è¦é¢å¤–çš„æ“ä½œï¼Œå°±ä¼šå‡ºç° FileSort ORDER BY RAND() å‘½ä»¤ç”¨æ¥è¿›è¡Œéšæœºæ’åºï¼Œä¼šä½¿ç”¨äº†ä¸´æ—¶å†…å­˜è¡¨ï¼Œä¸´æ—¶å†…å­˜è¡¨æ’åºçš„æ—¶ä½¿ç”¨ rowid æ’åºæ–¹æ³• ä¼˜åŒ–æ–¹å¼ï¼šåˆ›å»ºåˆé€‚çš„ç´¢å¼•èƒ½å¤Ÿå‡å°‘ Filesort çš„å‡ºç°ï¼Œä½†æ˜¯æŸäº›æƒ…å†µä¸‹æ¡ä»¶é™åˆ¶ä¸èƒ½è®© Filesort æ¶ˆå¤±ï¼Œå°±è¦åŠ å¿« Filesort çš„æ’åºæ“ä½œ å†…å­˜ä¸´æ—¶è¡¨ï¼ŒMySQL æœ‰ä¸¤ç§ Filesort æ’åºç®—æ³•ï¼š rowid æ’åºï¼šé¦–å…ˆæ ¹æ®æ¡ä»¶å–å‡ºæ’åºå­—æ®µå’Œä¿¡æ¯ï¼Œç„¶ååœ¨æ’åºåŒº sort bufferï¼ˆServer å±‚ï¼‰ä¸­æ’åºï¼Œå¦‚æœ sort buffer ä¸å¤Ÿï¼Œåˆ™åœ¨ä¸´æ—¶è¡¨ temporary table ä¸­å­˜å‚¨æ’åºç»“æœã€‚å®Œæˆæ’åºåå†æ ¹æ®è¡ŒæŒ‡é’ˆå›è¡¨è¯»å–è®°å½•ï¼Œè¯¥æ“ä½œå¯èƒ½ä¼šå¯¼è‡´å¤§é‡éšæœº I&#x2F;O æ“ä½œ è¯´æ˜ï¼šå¯¹äºä¸´æ—¶å†…å­˜è¡¨ï¼Œå›è¡¨è¿‡ç¨‹åªæ˜¯ç®€å•åœ°æ ¹æ®æ•°æ®è¡Œçš„ä½ç½®ï¼Œç›´æ¥è®¿é—®å†…å­˜å¾—åˆ°æ•°æ®ï¼Œä¸ä¼šå¯¼è‡´å¤šè®¿é—®ç£ç›˜ï¼Œä¼˜å…ˆé€‰æ‹©è¯¥æ–¹å¼ å…¨å­—æ®µæ’åºï¼šä¸€æ¬¡æ€§å–å‡ºæ»¡è¶³æ¡ä»¶çš„æ‰€æœ‰æ•°æ®ï¼Œéœ€è¦å›è¡¨ï¼Œç„¶ååœ¨æ’åºåŒº sort buffer ä¸­æ’åºåç›´æ¥è¾“å‡ºç»“æœé›†ã€‚æ’åºæ—¶å†…å­˜å¼€é”€è¾ƒå¤§ï¼Œä½†æ˜¯æ’åºæ•ˆç‡æ¯”ä¸¤æ¬¡æ‰«æç®—æ³•é«˜ å…·ä½“çš„é€‰æ‹©æ–¹å¼ï¼š MySQL é€šè¿‡æ¯”è¾ƒç³»ç»Ÿå˜é‡ max_length_for_sort_data çš„å¤§å°å’Œ Query è¯­å¥å–å‡ºçš„å­—æ®µçš„å¤§å°ï¼Œæ¥åˆ¤å®šä½¿ç”¨å“ªç§æ’åºç®—æ³•ã€‚å¦‚æœå‰è€…å¤§ï¼Œåˆ™è¯´æ˜ sort buffer ç©ºé—´è¶³å¤Ÿï¼Œä½¿ç”¨ç¬¬äºŒç§ä¼˜åŒ–ä¹‹åçš„ç®—æ³•ï¼Œå¦åˆ™ä½¿ç”¨ç¬¬ä¸€ç§ã€‚ å¯ä»¥é€‚å½“æé«˜ sort_buffer_size å’Œ max_length_for_sort_data ç³»ç»Ÿå˜é‡ï¼Œæ¥å¢å¤§æ’åºåŒºçš„å¤§å°ï¼Œæé«˜æ’åºçš„æ•ˆç‡ 1234SET @@max_length_for_sort_data = 10000; -- è®¾ç½®å…¨å±€å˜é‡SET max_length_for_sort_data = 10240; -- è®¾ç½®ä¼šè¯å˜é‡SHOW VARIABLES LIKE &#x27;max_length_for_sort_data&#x27;; -- é»˜è®¤1024SHOW VARIABLES LIKE &#x27;sort_buffer_size&#x27;; -- é»˜è®¤262114 ç£ç›˜ä¸´æ—¶è¡¨ï¼šæ’åºä½¿ç”¨ä¼˜å…ˆé˜Ÿåˆ—ï¼ˆå †ï¼‰çš„æ–¹å¼ GROUPGROUP BY ä¹Ÿä¼šè¿›è¡Œæ’åºæ“ä½œï¼Œä¸ ORDER BY ç›¸æ¯”ï¼ŒGROUP BY ä¸»è¦åªæ˜¯å¤šäº†æ’åºä¹‹åçš„åˆ†ç»„æ“ä½œï¼Œæ‰€ä»¥åœ¨ GROUP BY çš„å®ç°è¿‡ç¨‹ä¸­ï¼Œä¸ ORDER BY ä¸€æ ·ä¹Ÿå¯ä»¥åˆ©ç”¨åˆ°ç´¢å¼• åˆ†ç»„æŸ¥è¯¢ï¼š 12DROP INDEX idx_emp_age_salary ON emp;EXPLAIN SELECT age,COUNT(*) FROM emp GROUP BY age; ![](https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/MySQL-ä¼˜åŒ–SQL GROUP BYæ’åº1.png) Using temporaryï¼šè¡¨ç¤º MySQL éœ€è¦ä½¿ç”¨ä¸´æ—¶è¡¨ï¼ˆä¸æ˜¯ sort bufferï¼‰æ¥å­˜å‚¨ç»“æœé›†ï¼Œå¸¸è§äºæ’åºå’Œåˆ†ç»„æŸ¥è¯¢ æŸ¥è¯¢åŒ…å« GROUP BY ä½†æ˜¯ç”¨æˆ·æƒ³è¦é¿å…æ’åºç»“æœçš„æ¶ˆè€—ï¼Œ åˆ™å¯ä»¥æ‰§è¡Œ ORDER BY NULL ç¦æ­¢æ’åºï¼š 1EXPLAIN SELECT age,COUNT(*) FROM emp GROUP BY age ORDER BY NULL; ![](https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/MySQL-ä¼˜åŒ–SQL GROUP BYæ’åº2.png) åˆ›å»ºç´¢å¼•ï¼šç´¢å¼•æœ¬èº«æœ‰åºï¼Œä¸éœ€è¦ä¸´æ—¶è¡¨ï¼Œä¹Ÿä¸éœ€è¦å†é¢å¤–æ’åº 1CREATE INDEX idx_emp_age_salary ON emp(age, salary); ![](https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/MySQL-ä¼˜åŒ–SQL GROUP BYæ’åº3.png) æ•°æ®é‡å¾ˆå¤§æ—¶ï¼Œä½¿ç”¨ SQL_BIG_RESULT æç¤ºä¼˜åŒ–å™¨ç›´æ¥ä½¿ç”¨ç›´æ¥ç”¨ç£ç›˜ä¸´æ—¶è¡¨ è”åˆæŸ¥è¯¢å¯¹äºåŒ…å« OR çš„æŸ¥è¯¢å­å¥ï¼Œå¦‚æœè¦åˆ©ç”¨ç´¢å¼•ï¼Œåˆ™ OR ä¹‹é—´çš„æ¯ä¸ªæ¡ä»¶åˆ—éƒ½å¿…é¡»ç”¨åˆ°ç´¢å¼•ï¼Œè€Œä¸”ä¸èƒ½ä½¿ç”¨åˆ°æ¡ä»¶ä¹‹é—´çš„å¤åˆç´¢å¼•ï¼Œå¦‚æœæ²¡æœ‰ç´¢å¼•ï¼Œåˆ™åº”è¯¥è€ƒè™‘å¢åŠ ç´¢å¼• æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ï¼š 1EXPLAIN SELECT * FROM emp WHERE id = 1 OR age = 30; -- ä¸¤ä¸ªç´¢å¼•ï¼Œå¹¶ä¸”ä¸æ˜¯å¤åˆç´¢å¼• ![](https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/MySQL-ä¼˜åŒ–SQL ORæ¡ä»¶æŸ¥è¯¢1.png) 1Extra: Using sort_union(idx_emp_age_salary,PRIMARY); Using where ä½¿ç”¨ UNION æ›¿æ¢ ORï¼Œæ±‚å¹¶é›†ï¼š æ³¨æ„ï¼šè¯¥ä¼˜åŒ–åªé’ˆå¯¹å¤šä¸ªç´¢å¼•åˆ—æœ‰æ•ˆï¼Œå¦‚æœæœ‰åˆ—æ²¡æœ‰è¢«ç´¢å¼•ï¼ŒæŸ¥è¯¢æ•ˆç‡å¯èƒ½ä¼šå› ä¸ºæ²¡æœ‰é€‰æ‹© OR è€Œé™ä½ 1EXPLAIN SELECT * FROM emp WHERE id = 1 UNION SELECT * FROM emp WHERE age = 30; ![](https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/MySQL-ä¼˜åŒ–SQL ORæ¡ä»¶æŸ¥è¯¢2.png) UNION è¦ä¼˜äº OR çš„åŸå› ï¼š UNION è¯­å¥çš„ type å€¼ä¸º refï¼ŒOR è¯­å¥çš„ type å€¼ä¸º range UNION è¯­å¥çš„ ref å€¼ä¸º constï¼ŒOR è¯­å¥çš„ ref å€¼ä¸º nullï¼Œconst è¡¨ç¤ºæ˜¯å¸¸é‡å€¼å¼•ç”¨ï¼Œéå¸¸å¿« åµŒå¥—æŸ¥è¯¢MySQL 4.1 ç‰ˆæœ¬ä¹‹åï¼Œå¼€å§‹æ”¯æŒ SQL çš„å­æŸ¥è¯¢ å¯ä»¥ä½¿ç”¨ SELECT è¯­å¥æ¥åˆ›å»ºä¸€ä¸ªå•åˆ—çš„æŸ¥è¯¢ç»“æœï¼Œç„¶åæŠŠç»“æœä½œä¸ºè¿‡æ»¤æ¡ä»¶ç”¨åœ¨å¦ä¸€ä¸ªæŸ¥è¯¢ä¸­ ä½¿ç”¨å­æŸ¥è¯¢å¯ä»¥ä¸€æ¬¡æ€§çš„å®Œæˆé€»è¾‘ä¸Šéœ€è¦å¤šä¸ªæ­¥éª¤æ‰èƒ½å®Œæˆçš„ SQL æ“ä½œï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥é¿å…äº‹åŠ¡æˆ–è€…è¡¨é”æ­» åœ¨æœ‰äº›æƒ…å†µä¸‹ï¼Œå­æŸ¥è¯¢æ˜¯å¯ä»¥è¢«æ›´é«˜æ•ˆçš„è¿æ¥ï¼ˆJOINï¼‰æ›¿ä»£ ä¾‹å¦‚æŸ¥æ‰¾æœ‰è§’è‰²çš„æ‰€æœ‰çš„ç”¨æˆ·ä¿¡æ¯ï¼š æ‰§è¡Œè®¡åˆ’ï¼š 1EXPLAIN SELECT * FROM t_user WHERE id IN (SELECT user_id FROM user_role); ä¼˜åŒ–åï¼š 1EXPLAIN SELECT * FROM t_user u , user_role ur WHERE u.id = ur.user_id; è¿æ¥æŸ¥è¯¢ä¹‹æ‰€ä»¥æ•ˆç‡æ›´é«˜ ï¼Œæ˜¯å› ä¸ºä¸éœ€è¦åœ¨å†…å­˜ä¸­åˆ›å»ºä¸´æ—¶è¡¨æ¥å®Œæˆé€»è¾‘ä¸Šéœ€è¦ä¸¤ä¸ªæ­¥éª¤çš„æŸ¥è¯¢å·¥ä½œ åˆ†é¡µæŸ¥è¯¢ä¸€èˆ¬åˆ†é¡µæŸ¥è¯¢æ—¶ï¼Œé€šè¿‡åˆ›å»ºè¦†ç›–ç´¢å¼•èƒ½å¤Ÿæ¯”è¾ƒå¥½åœ°æé«˜æ€§èƒ½ ä¸€ä¸ªå¸¸è§çš„é—®é¢˜æ˜¯ LIMIT 200000,10ï¼Œæ­¤æ—¶éœ€è¦ MySQL æ‰«æå‰ 200010 è®°å½•ï¼Œä»…ä»…è¿”å› 200000 - 200010 ä¹‹é—´çš„è®°å½•ï¼Œå…¶ä»–è®°å½•ä¸¢å¼ƒï¼ŒæŸ¥è¯¢æ’åºçš„ä»£ä»·éå¸¸å¤§ åˆ†é¡µæŸ¥è¯¢ï¼š 1EXPLAIN SELECT * FROM tb_user_1 LIMIT 200000,10; ä¼˜åŒ–æ–¹å¼ä¸€ï¼šå†…è¿æ¥æŸ¥è¯¢ï¼Œåœ¨ç´¢å¼•åˆ— id ä¸Šå®Œæˆæ’åºåˆ†é¡µæ“ä½œï¼Œæœ€åæ ¹æ®ä¸»é”®å…³è”å›åŸè¡¨æŸ¥è¯¢æ‰€éœ€è¦çš„å…¶ä»–åˆ—å†…å®¹ 1EXPLAIN SELECT * FROM tb_user_1 t,(SELECT id FROM tb_user_1 ORDER BY id LIMIT 200000,10) a WHERE t.id = a.id; ä¼˜åŒ–æ–¹å¼äºŒï¼šæ–¹æ¡ˆé€‚ç”¨äºä¸»é”®è‡ªå¢çš„è¡¨ï¼Œå¯ä»¥æŠŠ LIMIT æŸ¥è¯¢è½¬æ¢æˆæŸä¸ªä½ç½®çš„æŸ¥è¯¢ 12EXPLAIN SELECT * FROM tb_user_1 WHERE id &gt; 200000 LIMIT 10; -- å†™æ³• 1EXPLAIN SELECT * FROM tb_user_1 WHERE id BETWEEN 200000 and 200010; -- å†™æ³• 2 ä½¿ç”¨æç¤ºSQL æç¤ºï¼Œæ˜¯ä¼˜åŒ–æ•°æ®åº“çš„ä¸€ä¸ªé‡è¦æ‰‹æ®µï¼Œå°±æ˜¯åœ¨ SQL è¯­å¥ä¸­åŠ å…¥ä¸€äº›æç¤ºæ¥è¾¾åˆ°ä¼˜åŒ–æ“ä½œçš„ç›®çš„ USE INDEXï¼šåœ¨æŸ¥è¯¢è¯­å¥ä¸­è¡¨åçš„åé¢æ·»åŠ  USE INDEX æ¥æä¾› MySQL å»å‚è€ƒçš„ç´¢å¼•åˆ—è¡¨ï¼Œå¯ä»¥è®© MySQL ä¸å†è€ƒè™‘å…¶ä»–å¯ç”¨çš„ç´¢å¼• 12CREATE INDEX idx_seller_name ON tb_seller(name);EXPLAIN SELECT * FROM tb_seller USE INDEX(idx_seller_name) WHERE name=&#x27;å°ç±³ç§‘æŠ€&#x27;; IGNORE INDEXï¼šè®© MySQL å¿½ç•¥ä¸€ä¸ªæˆ–è€…å¤šä¸ªç´¢å¼•ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ IGNORE INDEX ä½œä¸ºæç¤º 1EXPLAIN SELECT * FROM tb_seller IGNORE INDEX(idx_seller_name) WHERE name = &#x27;å°ç±³ç§‘æŠ€&#x27;; FORCE INDEXï¼šå¼ºåˆ¶ MySQL ä½¿ç”¨ä¸€ä¸ªç‰¹å®šçš„ç´¢å¼• 1EXPLAIN SELECT * FROM tb_seller FORCE INDEX(idx_seller_name_sta_addr) WHERE NAME=&#x27;å°ç±³ç§‘æŠ€&#x27;; ç»Ÿè®¡è®¡æ•°åœ¨ä¸åŒçš„ MySQL å¼•æ“ä¸­ï¼Œcount(*) æœ‰ä¸åŒçš„å®ç°æ–¹å¼ï¼š MyISAM å¼•æ“æŠŠä¸€ä¸ªè¡¨çš„æ€»è¡Œæ•°å­˜åœ¨äº†ç£ç›˜ä¸Šï¼Œå› æ­¤æ‰§è¡Œ count(*) çš„æ—¶å€™ä¼šç›´æ¥è¿”å›è¿™ä¸ªæ•°ï¼Œæ•ˆç‡å¾ˆé«˜ï¼Œä½†ä¸æ”¯æŒäº‹åŠ¡ show table status å‘½ä»¤é€šè¿‡é‡‡æ ·ä¼°ç®—å¯ä»¥å¿«é€Ÿè·å–ï¼Œä½†æ˜¯ä¸å‡†ç¡® InnoDB è¡¨æ‰§è¡Œ count(*) ä¼šéå†å…¨è¡¨ï¼Œè™½ç„¶ç»“æœå‡†ç¡®ï¼Œä½†ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ è§£å†³æ–¹æ¡ˆï¼š è®¡æ•°ä¿å­˜åœ¨ Redis ä¸­ï¼Œä½†æ˜¯æ›´æ–° MySQL å’Œ Redis çš„æ“ä½œä¸æ˜¯åŸå­çš„ï¼Œä¼šå­˜åœ¨æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ è®¡æ•°ç›´æ¥æ”¾åˆ°æ•°æ®åº“é‡Œå•ç‹¬çš„ä¸€å¼ è®¡æ•°è¡¨ä¸­ï¼Œåˆ©ç”¨äº‹åŠ¡è§£å†³è®¡æ•°ç²¾ç¡®é—®é¢˜ï¼š ä¼šè¯ B çš„è¯»æ“ä½œåœ¨ T3 æ‰§è¡Œçš„ï¼Œè¿™æ—¶æ›´æ–°äº‹åŠ¡è¿˜æ²¡æœ‰æäº¤ï¼Œæ‰€ä»¥è®¡æ•°å€¼åŠ  1 è¿™ä¸ªæ“ä½œå¯¹ä¼šè¯ B è¿˜ä¸å¯è§ï¼Œå› æ­¤ä¼šè¯ B æŸ¥è¯¢çš„è®¡æ•°å€¼å’Œæœ€è¿‘ 100 æ¡è®°å½•ï¼Œè¿”å›çš„ç»“æœé€»è¾‘ä¸Šå°±æ˜¯ä¸€è‡´çš„ å¹¶å‘ç³»ç»Ÿæ€§èƒ½çš„è§’åº¦è€ƒè™‘ï¼Œåº”è¯¥å…ˆæ’å…¥æ“ä½œè®°å½•å†æ›´æ–°è®¡æ•°è¡¨ï¼Œå› ä¸ºæ›´æ–°è®¡æ•°è¡¨æ¶‰åŠåˆ°è¡Œé”çš„ç«äº‰ï¼Œå…ˆæ’å…¥å†æ›´æ–°èƒ½æœ€å¤§ç¨‹åº¦åœ°å‡å°‘äº‹åŠ¡ä¹‹é—´çš„é”ç­‰å¾…ï¼Œæå‡å¹¶å‘åº¦ count å‡½æ•°çš„æŒ‰ç…§æ•ˆç‡æ’åºï¼šcount(å­—æ®µ) &lt; count(ä¸»é”®id) &lt; count(1) â‰ˆ count(*)ï¼Œæ‰€ä»¥å»ºè®®å°½é‡ä½¿ç”¨ count(*) count(ä¸»é”® id)ï¼šInnoDB å¼•æ“ä¼šéå†æ•´å¼ è¡¨ï¼ŒæŠŠæ¯ä¸€è¡Œçš„ id å€¼éƒ½å–å‡ºæ¥è¿”å›ç»™ Server å±‚ï¼ŒServer åˆ¤æ–­ id ä¸ä¸ºç©ºå°±æŒ‰è¡Œç´¯åŠ  count(1)ï¼šInnoDB å¼•æ“éå†æ•´å¼ è¡¨ä½†ä¸å–å€¼ï¼ŒServer å±‚å¯¹äºè¿”å›çš„æ¯ä¸€è¡Œï¼Œæ”¾ä¸€ä¸ªæ•°å­— 1 è¿›å»ï¼Œåˆ¤æ–­ä¸ä¸ºç©ºå°±æŒ‰è¡Œç´¯åŠ  count(å­—æ®µ)ï¼šå¦‚æœè¿™ä¸ªå­—æ®µæ˜¯å®šä¹‰ä¸º not null çš„è¯ï¼Œä¸€è¡Œè¡Œåœ°ä»è®°å½•é‡Œé¢è¯»å‡ºè¿™ä¸ªå­—æ®µï¼Œåˆ¤æ–­ä¸èƒ½ä¸º nullï¼ŒæŒ‰è¡Œç´¯åŠ ï¼›å¦‚æœè¿™ä¸ªå­—æ®µå®šä¹‰å…è®¸ä¸º nullï¼Œé‚£ä¹ˆæ‰§è¡Œçš„æ—¶å€™ï¼Œåˆ¤æ–­åˆ°æœ‰å¯èƒ½æ˜¯ nullï¼Œè¿˜è¦æŠŠå€¼å–å‡ºæ¥å†åˆ¤æ–­ä¸€ä¸‹ï¼Œä¸æ˜¯ null æ‰ç´¯åŠ  count(*)ï¼šä¸å–å€¼ï¼ŒæŒ‰è¡Œç´¯åŠ  å‚è€ƒæ–‡ç« ï¼šhttps://time.geekbang.org/column/article/72775 ç¼“å†²ä¼˜åŒ–ä¼˜åŒ–åŸåˆ™ä¸‰ä¸ªåŸåˆ™ï¼š å°†å°½é‡å¤šçš„å†…å­˜åˆ†é…ç»™ MySQL åšç¼“å­˜ï¼Œä½†ä¹Ÿè¦ç»™æ“ä½œç³»ç»Ÿå’Œå…¶ä»–ç¨‹åºé¢„ç•™è¶³å¤Ÿå†…å­˜ MyISAM å­˜å‚¨å¼•æ“çš„æ•°æ®æ–‡ä»¶è¯»å–ä¾èµ–äºæ“ä½œç³»ç»Ÿè‡ªèº«çš„ IO ç¼“å­˜ï¼Œå¦‚æœæœ‰ MyISAM è¡¨ï¼Œå°±è¦é¢„ç•™æ›´å¤šçš„å†…å­˜ç»™æ“ä½œç³»ç»Ÿåš IO ç¼“å­˜ æ’åºåŒºã€è¿æ¥åŒºç­‰ç¼“å­˜æ˜¯åˆ†é…ç»™æ¯ä¸ªæ•°æ®åº“ä¼šè¯ï¼ˆSessionï¼‰ä¸“ç”¨çš„ï¼Œå€¼çš„è®¾ç½®è¦æ ¹æ®æœ€å¤§è¿æ¥æ•°åˆç†åˆ†é…ï¼Œå¦‚æœè®¾ç½®å¤ªå¤§ï¼Œä¸ä½†æµªè´¹èµ„æºï¼Œè€Œä¸”åœ¨å¹¶å‘æ•°è¾ƒé«˜æ—¶ä¼šå¯¼è‡´ç‰©ç†å†…å­˜è€—å°½ ç¼“å†²å†…å­˜Buffer Pool æœ¬è´¨ä¸Šæ˜¯ InnoDB å‘æ“ä½œç³»ç»Ÿç”³è¯·çš„ä¸€æ®µè¿ç»­çš„å†…å­˜ç©ºé—´ã€‚InnoDB çš„æ•°æ®æ˜¯æŒ‰æ•°æ®é¡µä¸ºå•ä½æ¥è¯»å†™ï¼Œæ¯ä¸ªæ•°æ®é¡µçš„å¤§å°é»˜è®¤æ˜¯ 16KBã€‚æ•°æ®æ˜¯å­˜æ”¾åœ¨ç£ç›˜ä¸­ï¼Œæ¯æ¬¡è¯»å†™æ•°æ®éƒ½éœ€è¦è¿›è¡Œç£ç›˜ IO å°†æ•°æ®è¯»å…¥å†…å­˜è¿›è¡Œæ“ä½œï¼Œæ•ˆç‡ä¼šå¾ˆä½ï¼Œæ‰€ä»¥æä¾›äº† Buffer Pool æ¥æš‚å­˜è¿™äº›æ•°æ®é¡µï¼Œç¼“å­˜ä¸­çš„è¿™äº›é¡µåˆå«ç¼“å†²é¡µ å·¥ä½œåŸç†ï¼š ä»æ•°æ®åº“è¯»å–æ•°æ®æ—¶ï¼Œä¼šé¦–å…ˆä»ç¼“å­˜ä¸­è¯»å–ï¼Œå¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œåˆ™ä»ç£ç›˜è¯»å–åæ”¾å…¥ Buffer Pool å‘æ•°æ®åº“å†™å…¥æ•°æ®æ—¶ï¼Œä¼šå†™å…¥ç¼“å­˜ï¼Œç¼“å­˜ä¸­ä¿®æ”¹çš„æ•°æ®ä¼šå®šæœŸåˆ·æ–°åˆ°ç£ç›˜ï¼Œè¿™ä¸€è¿‡ç¨‹ç§°ä¸ºåˆ·è„ Buffer Pool ä¸­æ¯ä¸ªç¼“å†²é¡µéƒ½æœ‰å¯¹åº”çš„æ§åˆ¶ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¡¨ç©ºé—´ç¼–å·ã€é¡µå·ã€åç§»é‡ã€é“¾è¡¨ä¿¡æ¯ç­‰ï¼Œæ§åˆ¶ä¿¡æ¯å­˜æ”¾åœ¨å ç”¨çš„å†…å­˜ç§°ä¸ºæ§åˆ¶å—ï¼Œæ§åˆ¶å—ä¸ç¼“å†²é¡µæ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œä½†å¹¶ä¸æ˜¯ç‰©ç†ä¸Šç›¸è¿çš„ï¼Œéƒ½åœ¨ç¼“å†²æ± ä¸­ MySQL æä¾›äº†ç¼“å†²é¡µçš„å¿«é€ŸæŸ¥æ‰¾æ–¹å¼ï¼šå“ˆå¸Œè¡¨ï¼Œä½¿ç”¨è¡¨ç©ºé—´å·å’Œé¡µå·ä½œä¸º Keyï¼Œç¼“å†²é¡µæ§åˆ¶å—çš„åœ°å€ä½œä¸º Value åˆ›å»ºä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œè·å–æ•°æ®é¡µæ—¶æ ¹æ® Key è¿›è¡Œå“ˆå¸Œå¯»å€ï¼š å¦‚æœä¸å­˜åœ¨å¯¹åº”çš„ç¼“å­˜é¡µï¼Œå°±ä» free é“¾è¡¨ä¸­é€‰ä¸€ä¸ªç©ºé—²ç¼“å†²é¡µï¼ŒæŠŠç£ç›˜ä¸­çš„å¯¹åº”é¡µåŠ è½½åˆ°è¯¥ä½ç½® å¦‚æœå­˜åœ¨å¯¹åº”çš„ç¼“å­˜é¡µï¼Œç›´æ¥è·å–ä½¿ç”¨ï¼Œæé«˜æŸ¥è¯¢æ•°æ®çš„æ•ˆç‡ å½“å†…å­˜æ•°æ®é¡µè·Ÿç£ç›˜æ•°æ®é¡µå†…å®¹ä¸ä¸€è‡´æ—¶ï¼Œç§°è¿™ä¸ªå†…å­˜é¡µä¸ºè„é¡µï¼›å†…å­˜æ•°æ®å†™å…¥ç£ç›˜åï¼Œå†…å­˜å’Œç£ç›˜ä¸Šçš„æ•°æ®é¡µä¸€è‡´ï¼Œç§°ä¸ºå¹²å‡€é¡µ å†…å­˜ç®¡ç†Free é“¾è¡¨MySQL å¯åŠ¨æ—¶å®Œæˆå¯¹ Buffer Pool çš„åˆå§‹åŒ–ï¼Œå…ˆå‘æ“ä½œç³»ç»Ÿç”³è¯·è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œç„¶åå°†å†…å­˜åˆ’åˆ†ä¸ºè‹¥å¹²å¯¹æ§åˆ¶å—å’Œç¼“å†²é¡µã€‚ä¸ºäº†åŒºåˆ†ç©ºé—²å’Œå·²å ç”¨çš„æ•°æ®é¡µï¼Œå°†æ‰€æœ‰ç©ºé—²ç¼“å†²é¡µå¯¹åº”çš„æ§åˆ¶å—ä½œä¸ºä¸€ä¸ªèŠ‚ç‚¹æ”¾å…¥ä¸€ä¸ªé“¾è¡¨ä¸­ï¼Œå°±æ˜¯ Free é“¾è¡¨ï¼ˆç©ºé—²é“¾è¡¨ï¼‰ åŸºèŠ‚ç‚¹ï¼šæ˜¯ä¸€å—å•ç‹¬ç”³è¯·çš„å†…å­˜ç©ºé—´ï¼ˆå  40 å­—èŠ‚ï¼‰ï¼Œå¹¶ä¸åœ¨ Buffer Pool çš„é‚£ä¸€å¤§ç‰‡è¿ç»­å†…å­˜ç©ºé—´é‡Œ ç£ç›˜åŠ è½½é¡µçš„æµç¨‹ï¼š ä» Free é“¾è¡¨ä¸­å–å‡ºä¸€ä¸ªç©ºé—²çš„ç¼“å†²é¡µ æŠŠç¼“å†²é¡µå¯¹åº”çš„æ§åˆ¶å—çš„ä¿¡æ¯å¡«ä¸Šï¼ˆé¡µæ‰€åœ¨çš„è¡¨ç©ºé—´ã€é¡µå·ä¹‹ç±»çš„ä¿¡æ¯ï¼‰ æŠŠç¼“å†²é¡µå¯¹åº”çš„ Free é“¾è¡¨èŠ‚ç‚¹ï¼ˆæ§åˆ¶å—ï¼‰ä»é“¾è¡¨ä¸­ç§»é™¤ï¼Œè¡¨ç¤ºè¯¥ç¼“å†²é¡µå·²ç»è¢«ä½¿ç”¨ å‚è€ƒæ–‡ç« ï¼šhttps://blog.csdn.net/li1325169021/article/details/121124440 Flush é“¾è¡¨Flush é“¾è¡¨æ˜¯ä¸€ä¸ªç”¨æ¥å­˜å‚¨è„é¡µçš„é“¾è¡¨ï¼Œå¯¹äºå·²ç»ä¿®æ”¹è¿‡çš„ç¼“å†²è„é¡µï¼Œç¬¬ä¸€æ¬¡ä¿®æ”¹ååŠ å…¥åˆ°é“¾è¡¨å¤´éƒ¨ï¼Œä»¥åæ¯æ¬¡ä¿®æ”¹éƒ½ä¸ä¼šé‡æ–°åŠ å…¥ï¼Œåªä¿®æ”¹éƒ¨åˆ†æ§åˆ¶ä¿¡æ¯ï¼Œå‡ºäºæ€§èƒ½è€ƒè™‘å¹¶ä¸æ˜¯ç›´æ¥æ›´æ–°åˆ°ç£ç›˜ï¼Œè€Œæ˜¯åœ¨æœªæ¥çš„æŸä¸ªæ—¶é—´è¿›è¡Œåˆ·è„ åå°æœ‰ä¸“é—¨çš„çº¿ç¨‹æ¯éš”ä¸€æ®µæ—¶é—´æŠŠè„é¡µåˆ·æ–°åˆ°ç£ç›˜ï¼š ä» Flush é“¾è¡¨ä¸­åˆ·æ–°ä¸€éƒ¨åˆ†é¡µé¢åˆ°ç£ç›˜ï¼š åå°çº¿ç¨‹å®šæ—¶ä» Flush é“¾è¡¨åˆ·è„ï¼Œæ ¹æ®ç³»ç»Ÿçš„ç¹å¿™ç¨‹åº¦æ¥å†³å®šåˆ·æ–°é€Ÿç‡ï¼Œè¿™ç§æ–¹å¼ç§°ä¸º BUF_FLUSH_LIST çº¿ç¨‹åˆ·è„çš„æ¯”è¾ƒæ…¢ï¼Œå¯¼è‡´ç”¨æˆ·çº¿ç¨‹åŠ è½½ä¸€ä¸ªæ–°çš„æ•°æ®é¡µæ—¶å‘ç°æ²¡æœ‰ç©ºé—²ç¼“å†²é¡µï¼Œæ­¤æ—¶ä¼šå°è¯•ä» LRU é“¾è¡¨å°¾éƒ¨å¯»æ‰¾ç¼“å†²é¡µç›´æ¥é‡Šæ”¾ï¼Œå¦‚æœè¯¥é¡µé¢æ˜¯å·²ç»ä¿®æ”¹è¿‡çš„è„é¡µå°±åŒæ­¥åˆ·æ–°åˆ°ç£ç›˜ï¼Œé€Ÿåº¦è¾ƒæ…¢ï¼Œè¿™ç§æ–¹å¼ç§°ä¸º BUF_FLUSH_SINGLE_PAGE ä» LRU é“¾è¡¨çš„å†·æ•°æ®ä¸­åˆ·æ–°ä¸€éƒ¨åˆ†é¡µé¢åˆ°ç£ç›˜ï¼Œå³ï¼šBUF_FLUSH_LRU åå°çº¿ç¨‹ä¼šå®šæ—¶ä» LRU é“¾è¡¨çš„å°¾éƒ¨å¼€å§‹æ‰«æä¸€äº›é¡µé¢ï¼Œæ‰«æçš„é¡µé¢æ•°é‡å¯ä»¥é€šè¿‡ç³»ç»Ÿå˜é‡ innodb_lru_scan_depth æŒ‡å®šï¼Œå¦‚æœåœ¨ LRU é“¾è¡¨ä¸­å‘ç°è„é¡µï¼Œåˆ™æŠŠå®ƒä»¬åˆ·æ–°åˆ°ç£ç›˜ï¼Œè¿™ç§æ–¹å¼ç§°ä¸º BUF_FLUSH_LRU æ§åˆ¶å—é‡Œä¼šå­˜å‚¨è¯¥ç¼“å†²é¡µæ˜¯å¦è¢«ä¿®æ”¹çš„ä¿¡æ¯ï¼Œæ‰€ä»¥å¯ä»¥å¾ˆå®¹æ˜“çš„è·å–åˆ°æŸä¸ªç¼“å†²é¡µæ˜¯å¦æ˜¯è„é¡µ å‚è€ƒæ–‡ç« ï¼šhttps://blog.csdn.net/li1325169021/article/details/121125765 LRU é“¾è¡¨Buffer Pool éœ€è¦ä¿è¯ç¼“å­˜çš„å‘½ä¸­ç‡ï¼Œæ‰€ä»¥ MySQL åˆ›å»ºäº†ä¸€ä¸ª LRU é“¾è¡¨ï¼Œå½“è®¿é—®æŸä¸ªé¡µæ—¶ï¼š å¦‚æœè¯¥é¡µä¸åœ¨ Buffer Pool ä¸­ï¼ŒæŠŠè¯¥é¡µä»ç£ç›˜åŠ è½½è¿›æ¥åä¼šå°†è¯¥ç¼“å†²é¡µå¯¹åº”çš„æ§åˆ¶å—ä½œä¸ºèŠ‚ç‚¹æ”¾å…¥ LRU é“¾è¡¨çš„å¤´éƒ¨ï¼Œä¿è¯çƒ­ç‚¹æ•°æ®åœ¨é“¾è¡¨å¤´ å¦‚æœè¯¥é¡µåœ¨ Buffer Pool ä¸­ï¼Œåˆ™ç›´æ¥æŠŠè¯¥é¡µå¯¹åº”çš„æ§åˆ¶å—ç§»åŠ¨åˆ° LRU é“¾è¡¨çš„å¤´éƒ¨ï¼Œæ‰€ä»¥ LRU é“¾è¡¨å°¾éƒ¨å°±æ˜¯æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ç¼“å†²é¡µ MySQL åŸºäºå±€éƒ¨æ€§åŸç†æä¾›äº†é¢„è¯»åŠŸèƒ½ï¼š çº¿æ€§é¢„è¯»ï¼šç³»ç»Ÿå˜é‡ innodb_read_ahead_thresholdï¼Œå¦‚æœé¡ºåºè®¿é—®æŸä¸ªåŒºï¼ˆextentï¼š16 KB çš„é¡µï¼Œè¿ç»­ 64 ä¸ªå½¢æˆä¸€ä¸ªåŒºï¼Œä¸€ä¸ªåŒºé»˜è®¤ 1MB å¤§å°ï¼‰çš„é¡µé¢æ•°è¶…è¿‡äº†è¯¥ç³»ç»Ÿå˜é‡å€¼ï¼Œå°±ä¼šè§¦å‘ä¸€æ¬¡å¼‚æ­¥è¯»å–ä¸‹ä¸€ä¸ªåŒºä¸­å…¨éƒ¨çš„é¡µé¢åˆ° Buffer Pool ä¸­ éšæœºé¢„è¯»ï¼šå¦‚æœæŸä¸ªåŒº 13 ä¸ªè¿ç»­çš„é¡µé¢éƒ½è¢«åŠ è½½åˆ° Buffer Poolï¼Œæ— è®ºè¿™äº›é¡µé¢æ˜¯å¦æ˜¯é¡ºåºè¯»å–ï¼Œéƒ½ä¼šè§¦å‘ä¸€æ¬¡å¼‚æ­¥è¯»å–æœ¬åŒºæ‰€æœ‰çš„å…¶ä»–é¡µé¢åˆ° Buffer Pool ä¸­ é¢„è¯»ä¼šé€ æˆåŠ è½½å¤ªå¤šç”¨ä¸åˆ°çš„æ•°æ®é¡µï¼Œé€ æˆé‚£äº›ä½¿ç”¨é¢‘ç‡å¾ˆé«˜çš„æ•°æ®é¡µè¢«æŒ¤åˆ° LRU é“¾è¡¨å°¾éƒ¨ï¼Œæ‰€ä»¥ InnoDB å°† LRU é“¾è¡¨åˆ†æˆä¸¤æ®µï¼Œå†·çƒ­æ•°æ®éš”ç¦»ï¼š ä¸€éƒ¨åˆ†å­˜å‚¨ä½¿ç”¨é¢‘ç‡å¾ˆé«˜çš„æ•°æ®é¡µï¼Œè¿™éƒ¨åˆ†é“¾è¡¨ä¹Ÿå«çƒ­æ•°æ®ï¼Œyoung åŒºï¼Œé è¿‘é“¾è¡¨å¤´éƒ¨çš„åŒºåŸŸ ä¸€éƒ¨åˆ†å­˜å‚¨ä½¿ç”¨é¢‘ç‡ä¸é«˜çš„å†·æ•°æ®ï¼Œold åŒºï¼Œé è¿‘é“¾è¡¨å°¾éƒ¨ï¼Œé»˜è®¤å  37%ï¼Œå¯ä»¥é€šè¿‡ç³»ç»Ÿå˜é‡ innodb_old_blocks_pct æŒ‡å®š å½“ç£ç›˜ä¸Šçš„æŸæ•°æ®é¡µè¢«åˆæ¬¡åŠ è½½åˆ° Buffer Pool ä¸­ä¼šè¢«æ”¾å…¥ old åŒºï¼Œæ·˜æ±°æ—¶ä¼˜å…ˆæ·˜æ±° old åŒº å½“å¯¹ old åŒºçš„æ•°æ®è¿›è¡Œè®¿é—®æ—¶ï¼Œä¼šåœ¨æ§åˆ¶å—è®°å½•ä¸‹è®¿é—®æ—¶é—´ï¼Œç­‰å¾…åç»­çš„è®¿é—®æ—¶é—´ä¸ç¬¬ä¸€æ¬¡è®¿é—®çš„æ—¶é—´æ˜¯å¦åœ¨æŸä¸ªæ—¶é—´é—´éš”å†…ï¼Œé€šè¿‡ç³»ç»Ÿå˜é‡ innodb_old_blocks_time æŒ‡å®šæ—¶é—´é—´éš”ï¼Œé»˜è®¤ 1000msï¼Œæˆç«‹å°±ç§»åŠ¨åˆ° young åŒºçš„é“¾è¡¨å¤´éƒ¨ innodb_old_blocks_time ä¸º 0 æ—¶ï¼Œæ¯æ¬¡è®¿é—®ä¸€ä¸ªé¡µé¢éƒ½ä¼šæ”¾å…¥ young åŒºçš„å¤´éƒ¨ å‚æ•°ä¼˜åŒ–InnoDB ç”¨ä¸€å—å†…å­˜åŒºåš IO ç¼“å­˜æ± ï¼Œè¯¥ç¼“å­˜æ± ä¸ä»…ç”¨æ¥ç¼“å­˜ InnoDB çš„ç´¢å¼•å—ï¼Œä¹Ÿç”¨æ¥ç¼“å­˜ InnoDB çš„æ•°æ®å—ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„æŒ‡ä»¤æŸ¥çœ‹ Buffer Pool çš„çŠ¶æ€ä¿¡æ¯ï¼š 1SHOW ENGINE INNODB STATUS\\G Buffer pool hit rate å­—æ®µä»£è¡¨å†…å­˜å‘½ä¸­ç‡ï¼Œè¡¨ç¤º Buffer Pool å¯¹æŸ¥è¯¢çš„åŠ é€Ÿæ•ˆæœ æ ¸å¿ƒå‚æ•°ï¼š innodb_buffer_pool_sizeï¼šè¯¥å˜é‡å†³å®šäº† Innodb å­˜å‚¨å¼•æ“è¡¨æ•°æ®å’Œç´¢å¼•æ•°æ®çš„æœ€å¤§ç¼“å­˜åŒºå¤§å°ï¼Œé»˜è®¤ 128M 1SHOW VARIABLES LIKE &#x27;innodb_buffer_pool_size&#x27;; åœ¨ä¿è¯æ“ä½œç³»ç»ŸåŠå…¶ä»–ç¨‹åºæœ‰è¶³å¤Ÿå†…å­˜å¯ç”¨çš„æƒ…å†µä¸‹ï¼Œinnodb_buffer_pool_size çš„å€¼è¶Šå¤§ï¼Œç¼“å­˜å‘½ä¸­ç‡è¶Šé«˜ï¼Œå»ºè®®è®¾ç½®æˆå¯ç”¨ç‰©ç†å†…å­˜çš„ 60%~80% 1innodb_buffer_pool_size=512M innodb_log_buffer_sizeï¼šè¯¥å€¼å†³å®šäº† Innodb æ—¥å¿—ç¼“å†²åŒºçš„å¤§å°ï¼Œä¿å­˜è¦å†™å…¥ç£ç›˜ä¸Šçš„æ—¥å¿—æ–‡ä»¶æ•°æ® å¯¹äºå¯èƒ½äº§ç”Ÿå¤§é‡æ›´æ–°è®°å½•çš„å¤§äº‹åŠ¡ï¼Œå¢åŠ è¯¥å€¼çš„å¤§å°ï¼Œå¯ä»¥é¿å… Innodb åœ¨äº‹åŠ¡æäº¤å‰å°±æ‰§è¡Œä¸å¿…è¦çš„æ—¥å¿—å†™å…¥ç£ç›˜æ“ä½œï¼Œå½±å“æ‰§è¡Œæ•ˆç‡ï¼Œé€šè¿‡é…ç½®æ–‡ä»¶ä¿®æ”¹ï¼š 1innodb_log_buffer_size=10M åœ¨å¤šçº¿ç¨‹ä¸‹ï¼Œè®¿é—® Buffer Pool ä¸­çš„å„ç§é“¾è¡¨éƒ½éœ€è¦åŠ é”ï¼Œæ‰€ä»¥å°† Buffer Pool æ‹†æˆè‹¥å¹²ä¸ªå°å®ä¾‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªå®ä¾‹ï¼Œç‹¬ç«‹ç®¡ç†å†…å­˜ç©ºé—´å’Œå„ç§é“¾è¡¨ï¼ˆç±»ä¼¼ ThreadLocalï¼‰ï¼Œå¤šçº¿ç¨‹è®¿é—®å„è‡ªå®ä¾‹äº’ä¸å½±å“ï¼Œæé«˜äº†å¹¶å‘èƒ½åŠ› MySQL 5.7.5 ä¹‹å‰ innodb_buffer_pool_size åªæ”¯æŒåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶ä¿®æ”¹ï¼Œç°åœ¨å·²ç»æ”¯æŒè¿è¡Œæ—¶ä¿®æ”¹ Buffer Pool çš„å¤§å°ï¼Œä½†æ˜¯æ¯æ¬¡è°ƒæ•´å‚æ•°éƒ½ä¼šé‡æ–°å‘æ“ä½œç³»ç»Ÿç”³è¯·ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œå°†æ—§çš„ç¼“å†²æ± çš„å†…å®¹æ‹·è´åˆ°æ–°ç©ºé—´éå¸¸è€—æ—¶ï¼Œæ‰€ä»¥ MySQL å¼€å§‹ä»¥ä¸€ä¸ª chunk ä¸ºå•ä½å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ï¼Œæ‰€ä»¥ä¸€ä¸ª Buffer Pool å®ä¾‹å¯ä»¥ç”±å¤šä¸ª chunk ç»„æˆ åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è®¾ç½®ç³»ç»Ÿå˜é‡ innodb_buffer_pool_instance å¯ä»¥æŒ‡å®š Buffer Pool å®ä¾‹çš„ä¸ªæ•°ï¼Œä½†æ˜¯å½“ Buffer Pool å°äº 1GB æ—¶ï¼Œè®¾ç½®å¤šä¸ªå®ä¾‹æ—¶æ— æ•ˆçš„ æŒ‡å®šç³»ç»Ÿå˜é‡ innodb_buffer_pool_chunk_size æ¥æ”¹å˜ chunk çš„å¤§å°ï¼Œåªèƒ½åœ¨å¯åŠ¨æ—¶ä¿®æ”¹ï¼Œè¿è¡Œä¸­ä¸èƒ½ä¿®æ”¹ï¼Œè€Œä¸”è¯¥å˜é‡å¹¶ä¸åŒ…å«ç¼“å†²é¡µçš„æ§åˆ¶å—çš„å†…å­˜å¤§å° innodb_buffer_pool_size å¿…é¡»æ˜¯ innodb_buffer_pool_chunk_size Ã— innodb_buffer_pool_instance çš„å€æ•°ï¼Œé»˜è®¤å€¼æ˜¯ 128M Ã— 16 = 2Gï¼ŒBuffer Pool å¿…é¡»æ˜¯ 2G çš„æ•´æ•°å€ï¼Œå¦‚æœæŒ‡å®š 5Gï¼Œä¼šè‡ªåŠ¨è°ƒæ•´æˆ 6G å¦‚æœå¯åŠ¨æ—¶ chunk Ã— instances &gt; pool_sizeï¼Œé‚£ä¹ˆ chunk çš„å€¼ä¼šè‡ªåŠ¨è®¾ç½®ä¸º pool_size Ã· instances å†…å­˜ä¼˜åŒ–ChangeInnoDB ç®¡ç†çš„ Buffer Pool ä¸­æœ‰ä¸€å—å†…å­˜å« Change Buffer ç”¨æ¥å¯¹å¢åˆ æ”¹æ“ä½œæä¾›ç¼“å­˜ï¼Œå¯ä»¥é€šè¿‡å‚æ•°æ¥åŠ¨æ€è®¾ç½®ï¼Œè®¾ç½®ä¸º 50 æ—¶è¡¨ç¤º Change Buffer çš„å¤§å°æœ€å¤šå ç”¨ Buffer Pool çš„ 50% å”¯ä¸€ç´¢å¼•çš„æ›´æ–°ä¸èƒ½ä½¿ç”¨ Change Bufferï¼Œéœ€è¦å°†æ•°æ®é¡µè¯»å…¥å†…å­˜ï¼Œåˆ¤æ–­æ²¡æœ‰å†²çªåœ¨å†™å…¥ æ™®é€šç´¢å¼•å¯ä»¥ä½¿ç”¨ Change Bufferï¼Œç›´æ¥å†™å…¥ Buffer å°±ç»“æŸï¼Œä¸ç”¨æ ¡éªŒå”¯ä¸€æ€§ Change Buffer å¹¶ä¸æ˜¯æ•°æ®é¡µï¼Œåªæ˜¯å¯¹æ“ä½œçš„ç¼“å­˜ï¼Œæ‰€ä»¥éœ€è¦å°† Change Buffer ä¸­çš„æ“ä½œåº”ç”¨åˆ°æ—§æ•°æ®é¡µï¼Œå¾—åˆ°æ–°çš„æ•°æ®é¡µï¼ˆè„é¡µï¼‰çš„è¿‡ç¨‹ç§°ä¸º Merge è§¦å‘æ—¶æœºï¼šè®¿é—®æ•°æ®é¡µæ—¶ä¼šè§¦å‘ Mergeã€åå°æœ‰å®šæ—¶çº¿ç¨‹è¿›è¡Œ Mergeã€åœ¨æ•°æ®åº“æ­£å¸¸å…³é—­ï¼ˆshutdownï¼‰çš„è¿‡ç¨‹ä¸­ä¹Ÿä¼šè§¦å‘ å·¥ä½œæµç¨‹ï¼šé¦–å…ˆä»ç£ç›˜è¯»å…¥æ•°æ®é¡µåˆ°å†…å­˜ï¼ˆå› ä¸º Buffer Pool ä¸­ä¸ä¸€å®šå­˜åœ¨å¯¹åº”çš„æ•°æ®é¡µï¼‰ï¼Œä» Change Buffer ä¸­æ‰¾åˆ°å¯¹åº”çš„æ“ä½œåº”ç”¨åˆ°æ•°æ®é¡µï¼Œå¾—åˆ°æ–°çš„æ•°æ®é¡µå³ä¸ºè„é¡µï¼Œç„¶åå†™å…¥ redo logï¼Œç­‰å¾…åˆ·è„å³å¯ è¯´æ˜ï¼šChange Buffer ä¸­çš„è®°å½•ï¼Œåœ¨äº‹åŠ¡æäº¤æ—¶ä¹Ÿä¼šå†™å…¥ redo logï¼Œæ‰€ä»¥æ˜¯å¯ä»¥ä¿è¯ä¸ä¸¢å¤±çš„ ä¸šåŠ¡åœºæ™¯ï¼š å¯¹äºå†™å¤šè¯»å°‘çš„ä¸šåŠ¡æ¥è¯´ï¼Œé¡µé¢åœ¨å†™å®Œä»¥åé©¬ä¸Šè¢«è®¿é—®åˆ°çš„æ¦‚ç‡æ¯”è¾ƒå°ï¼Œæ­¤æ—¶ Change Buffer çš„ä½¿ç”¨æ•ˆæœæœ€å¥½ï¼Œå¸¸è§çš„å°±æ˜¯è´¦å•ç±»ã€æ—¥å¿—ç±»çš„ç³»ç»Ÿ ä¸€ä¸ªä¸šåŠ¡çš„æ›´æ–°æ¨¡å¼æ˜¯å†™å…¥åé©¬ä¸ŠåšæŸ¥è¯¢ï¼Œé‚£ä¹ˆå³ä½¿æ»¡è¶³äº†æ¡ä»¶ï¼Œå°†æ›´æ–°å…ˆè®°å½•åœ¨ Change Bufferï¼Œä½†ä¹‹åç”±äºé©¬ä¸Šè¦è®¿é—®è¿™ä¸ªæ•°æ®é¡µï¼Œä¼šç«‹å³è§¦å‘ Merge è¿‡ç¨‹ï¼Œè¿™æ ·éšæœºè®¿é—® IO çš„æ¬¡æ•°ä¸ä¼šå‡å°‘ï¼Œå¹¶ä¸”å¢åŠ äº† Change Buffer çš„ç»´æŠ¤ä»£ä»· è¡¥å……ï¼šChange Buffer çš„å‰èº«æ˜¯ Insert Bufferï¼Œåªèƒ½å¯¹ Insert æ“ä½œä¼˜åŒ–ï¼Œåæ¥å¢åŠ äº† Update&#x2F;Delete çš„æ”¯æŒï¼Œæ”¹ä¸º Change Buffer NetServer å±‚é’ˆå¯¹ä¼˜åŒ–æŸ¥è¯¢çš„å†…å­˜ä¸º Net Bufferï¼Œå†…å­˜çš„å¤§å°æ˜¯ç”±å‚æ•° net_buffer_lengthå®šä¹‰ï¼Œé»˜è®¤ 16kï¼Œå®ç°æµç¨‹ï¼š è·å–ä¸€è¡Œæ•°æ®å†™å…¥ Net Bufferï¼Œé‡å¤è·å–ç›´åˆ° Net Buffer å†™æ»¡ï¼Œè°ƒç”¨ç½‘ç»œæ¥å£å‘å‡ºå» è‹¥å‘é€æˆåŠŸå°±æ¸…ç©º Net Bufferï¼Œç„¶åç»§ç»­å–ä¸‹ä¸€è¡Œï¼›è‹¥å‘é€å‡½æ•°è¿”å› EAGAIN æˆ– WSAEWOULDBLOCKï¼Œè¡¨ç¤ºæœ¬åœ°ç½‘ç»œæ ˆ socket send buffer å†™æ»¡äº†ï¼Œè¿›å…¥ç­‰å¾…ï¼Œç›´åˆ°ç½‘ç»œæ ˆé‡æ–°å¯å†™å†ç»§ç»­å‘é€ MySQL é‡‡ç”¨çš„æ˜¯è¾¹è¯»è¾¹å‘çš„é€»è¾‘ï¼Œå› æ­¤å¯¹äºæ•°æ®é‡å¾ˆå¤§çš„æŸ¥è¯¢æ¥è¯´ï¼Œä¸ä¼šåœ¨ Server ç«¯ä¿å­˜å®Œæ•´çš„ç»“æœé›†ï¼Œå¦‚æœå®¢æˆ·ç«¯è¯»ç»“æœä¸åŠæ—¶ï¼Œä¼šå µä½ MySQL çš„æŸ¥è¯¢è¿‡ç¨‹ï¼Œä½†æ˜¯ä¸ä¼šæŠŠå†…å­˜æ‰“çˆ†å¯¼è‡´ OOM SHOW PROCESSLIST è·å–çº¿ç¨‹ä¿¡æ¯åï¼Œå¤„äº Sending to client çŠ¶æ€ä»£è¡¨æœåŠ¡å™¨ç«¯çš„ç½‘ç»œæ ˆå†™æ»¡ï¼Œç­‰å¾…å®¢æˆ·ç«¯æ¥æ”¶æ•°æ® å‡è®¾æœ‰ä¸€ä¸ªä¸šåŠ¡çš„é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œæ¯è¯»ä¸€è¡Œæ•°æ®ä»¥åè¦å¤„ç†å¾ˆä¹…çš„é€»è¾‘ï¼Œå°±ä¼šå¯¼è‡´å®¢æˆ·ç«¯è¦è¿‡å¾ˆä¹…æ‰ä¼šå»å–ä¸‹ä¸€è¡Œæ•°æ®ï¼Œå¯¼è‡´ MySQL çš„é˜»å¡ï¼Œä¸€ç›´å¤„äº Sending to client çš„çŠ¶æ€ è§£å†³æ–¹æ³•ï¼šå¦‚æœä¸€ä¸ªæŸ¥è¯¢çš„è¿”å›ç»“æœå¾ˆæ˜¯å¾ˆå¤šï¼Œå»ºè®®ä½¿ç”¨ mysql_store_result è¿™ä¸ªæ¥å£ï¼Œç›´æ¥æŠŠæŸ¥è¯¢ç»“æœä¿å­˜åˆ°æœ¬åœ°å†…å­˜ å‚è€ƒæ–‡ç« ï¼šhttps://blog.csdn.net/qq_33589510/article/details/117673449 Readread_rnd_buffer æ˜¯ MySQL çš„éšæœºè¯»ç¼“å†²åŒºï¼Œå½“æŒ‰ä»»æ„é¡ºåºè¯»å–è®°å½•è¡Œæ—¶å°†åˆ†é…ä¸€ä¸ªéšæœºè¯»å–ç¼“å†²åŒºï¼Œè¿›è¡Œæ’åºæŸ¥è¯¢æ—¶ï¼ŒMySQL ä¼šé¦–å…ˆæ‰«æä¸€éè¯¥ç¼“å†²ï¼Œä»¥é¿å…ç£ç›˜æœç´¢ï¼Œæé«˜æŸ¥è¯¢é€Ÿåº¦ï¼Œå¤§å°æ˜¯ç”± read_rnd_buffer_size å‚æ•°æ§åˆ¶çš„ Multi-Range Read ä¼˜åŒ–ï¼Œå°†éšæœº IO è½¬åŒ–ä¸ºé¡ºåº IO ä»¥é™ä½æŸ¥è¯¢è¿‡ç¨‹ä¸­ IO å¼€é”€ï¼Œå› ä¸ºå¤§å¤šæ•°çš„æ•°æ®éƒ½æ˜¯æŒ‰ç…§ä¸»é”®é€’å¢é¡ºåºæ’å…¥å¾—åˆ°ï¼Œæ‰€ä»¥æŒ‰ç…§ä¸»é”®çš„é€’å¢é¡ºåºæŸ¥è¯¢çš„è¯ï¼Œå¯¹ç£ç›˜çš„è¯»æ¯”è¾ƒæ¥è¿‘é¡ºåºè¯»ï¼Œèƒ½å¤Ÿæå‡è¯»æ€§èƒ½ äºŒçº§ç´¢å¼•ä¸º aï¼Œèšç°‡ç´¢å¼•ä¸º idï¼Œä¼˜åŒ–å›è¡¨æµç¨‹ï¼š æ ¹æ®ç´¢å¼• aï¼Œå®šä½åˆ°æ»¡è¶³æ¡ä»¶çš„è®°å½•ï¼Œå°† id å€¼æ”¾å…¥ read_rnd_buffer ä¸­ å°† read_rnd_buffer ä¸­çš„ id è¿›è¡Œé€’å¢æ’åº æ’åºåçš„ id æ•°ç»„ï¼Œä¾æ¬¡å›è¡¨åˆ°ä¸»é”® id ç´¢å¼•ä¸­æŸ¥è®°å½•ï¼Œå¹¶ä½œä¸ºç»“æœè¿”å› è¯´æ˜ï¼šå¦‚æœæ­¥éª¤ 1 ä¸­ read_rnd_buffer æ”¾æ»¡äº†ï¼Œå°±ä¼šå…ˆæ‰§è¡Œæ­¥éª¤ 2 å’Œ 3ï¼Œç„¶åæ¸…ç©º read_rnd_bufferï¼Œä¹‹åç»§ç»­æ‰¾ç´¢å¼• a çš„ä¸‹ä¸ªè®°å½• ä½¿ç”¨ MRR ä¼˜åŒ–éœ€è¦è®¾è¿›è¡Œè®¾ç½®ï¼š 1SET optimizer_switch=&#x27;mrr_cost_based=off&#x27; KeyMyISAM å­˜å‚¨å¼•æ“ä½¿ç”¨ key_buffer ç¼“å­˜ç´¢å¼•å—ï¼ŒåŠ é€Ÿ MyISAM ç´¢å¼•çš„è¯»å†™é€Ÿåº¦ã€‚å¯¹äº MyISAM è¡¨çš„æ•°æ®å—æ²¡æœ‰ç‰¹åˆ«çš„ç¼“å­˜æœºåˆ¶ï¼Œå®Œå…¨ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„ IO ç¼“å­˜ key_buffer_sizeï¼šè¯¥å˜é‡å†³å®š MyISAM ç´¢å¼•å—ç¼“å­˜åŒºçš„å¤§å°ï¼Œç›´æ¥å½±å“åˆ° MyISAM è¡¨çš„å­˜å–æ•ˆç‡ 1SHOW VARIABLES LIKE &#x27;key_buffer_size&#x27;; -- å•ä½æ˜¯å­—èŠ‚ åœ¨ MySQL é…ç½®æ–‡ä»¶ä¸­è®¾ç½®è¯¥å€¼ï¼Œå»ºè®®è‡³å°‘å°†1&#x2F;4å¯ç”¨å†…å­˜åˆ†é…ç»™ key_buffer_sizeï¼š 12vim /etc/mysql/my.cnfkey_buffer_size=1024M read_buffer_sizeï¼šå¦‚æœéœ€è¦ç»å¸¸é¡ºåºæ‰«æ MyISAM è¡¨ï¼Œå¯ä»¥é€šè¿‡å¢å¤§ read_buffer_size çš„å€¼æ¥æ”¹å–„æ€§èƒ½ã€‚ä½† read_buffer_size æ˜¯æ¯ä¸ª Session ç‹¬å çš„ï¼Œå¦‚æœé»˜è®¤å€¼è®¾ç½®å¤ªå¤§ï¼Œå¹¶å‘ç¯å¢ƒå°±ä¼šé€ æˆå†…å­˜æµªè´¹ read_rnd_buffer_sizeï¼šå¯¹äºéœ€è¦åšæ’åºçš„ MyISAM è¡¨çš„æŸ¥è¯¢ï¼Œå¦‚å¸¦æœ‰ ORDER BY å­å¥çš„è¯­å¥ï¼Œé€‚å½“å¢åŠ è¯¥çš„å€¼ï¼Œå¯ä»¥æ”¹å–„æ­¤ç±»çš„ SQL çš„æ€§èƒ½ï¼Œä½†æ˜¯ read_rnd_buffer_size æ˜¯æ¯ä¸ª Session ç‹¬å çš„ï¼Œå¦‚æœé»˜è®¤å€¼è®¾ç½®å¤ªå¤§ï¼Œå°±ä¼šé€ æˆå†…å­˜æµªè´¹ å­˜å‚¨ä¼˜åŒ–æ•°æ®å­˜å‚¨ç³»ç»Ÿè¡¨ç©ºé—´æ˜¯ç”¨æ¥æ”¾ç³»ç»Ÿä¿¡æ¯çš„ï¼Œæ¯”å¦‚æ•°æ®å­—å…¸ä»€ä¹ˆçš„ï¼Œå¯¹åº”çš„ç£ç›˜æ–‡ä»¶æ˜¯ ibdataï¼Œæ•°æ®è¡¨ç©ºé—´æ˜¯ä¸€ä¸ªä¸ªçš„è¡¨æ•°æ®æ–‡ä»¶ï¼Œå¯¹åº”çš„ç£ç›˜æ–‡ä»¶å°±æ˜¯è¡¨å.ibd è¡¨æ•°æ®æ—¢å¯ä»¥å­˜åœ¨å…±äº«è¡¨ç©ºé—´é‡Œï¼Œä¹Ÿå¯ä»¥æ˜¯å•ç‹¬çš„æ–‡ä»¶ï¼Œè¿™ä¸ªè¡Œä¸ºæ˜¯ç”±å‚æ•° innodb_file_per_table æ§åˆ¶çš„ï¼š OFFï¼šè¡¨ç¤ºè¡¨çš„æ•°æ®æ”¾åœ¨ç³»ç»Ÿå…±äº«è¡¨ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯è·Ÿæ•°æ®å­—å…¸æ”¾åœ¨ä¸€èµ· ON ï¼šè¡¨ç¤ºæ¯ä¸ª InnoDB è¡¨æ•°æ®å­˜å‚¨åœ¨ä¸€ä¸ªä»¥ .ibd ä¸ºåç¼€çš„æ–‡ä»¶ä¸­ï¼ˆé»˜è®¤ï¼‰ ä¸€ä¸ªè¡¨å•ç‹¬å­˜å‚¨ä¸ºä¸€ä¸ªæ–‡ä»¶æ›´å®¹æ˜“ç®¡ç†ï¼Œåœ¨ä¸éœ€è¦è¿™ä¸ªè¡¨æ—¶é€šè¿‡ drop table å‘½ä»¤ï¼Œç³»ç»Ÿå°±ä¼šç›´æ¥åˆ é™¤è¿™ä¸ªæ–‡ä»¶ï¼›å¦‚æœæ˜¯æ”¾åœ¨å…±äº«è¡¨ç©ºé—´ä¸­ï¼Œå³ä½¿è¡¨åˆ æ‰äº†ï¼Œç©ºé—´ä¹Ÿæ˜¯ä¸ä¼šå›æ”¶çš„ æ•°æ®åˆ é™¤MySQL çš„æ•°æ®åˆ é™¤å°±æ˜¯ç§»é™¤æ‰æŸä¸ªè®°å½•åï¼Œè¯¥ä½ç½®å°±è¢«æ ‡è®°ä¸ºå¯å¤ç”¨ï¼Œå¦‚æœæœ‰ç¬¦åˆèŒƒå›´æ¡ä»¶çš„æ•°æ®å¯ä»¥æ’å…¥åˆ°è¿™é‡Œã€‚ç¬¦åˆèŒƒå›´æ¡ä»¶çš„æ„æ€æ˜¯å‡è®¾åˆ é™¤è®°å½• R4ï¼Œä¹‹åè¦å†æ’å…¥ä¸€ä¸ª ID åœ¨ 300 å’Œ 600 ä¹‹é—´çš„è®°å½•æ—¶ï¼Œå°±ä¼šå¤ç”¨è¿™ä¸ªä½ç½® InnoDB çš„æ•°æ®æ˜¯æŒ‰é¡µå­˜å‚¨çš„å¦‚æœåˆ æ‰äº†ä¸€ä¸ªæ•°æ®é¡µä¸Šçš„æ‰€æœ‰è®°å½•ï¼Œæ•´ä¸ªæ•°æ®é¡µå°±å¯ä»¥è¢«å¤ç”¨äº†ï¼Œå¦‚æœç›¸é‚»çš„ä¸¤ä¸ªæ•°æ®é¡µåˆ©ç”¨ç‡éƒ½å¾ˆå°ï¼Œç³»ç»Ÿå°±ä¼šæŠŠè¿™ä¸¤ä¸ªé¡µä¸Šçš„æ•°æ®åˆåˆ°å…¶ä¸­ä¸€ä¸ªé¡µä¸Šï¼Œå¦å¤–ä¸€ä¸ªæ•°æ®é¡µå°±è¢«æ ‡è®°ä¸ºå¯å¤ç”¨ åˆ é™¤å‘½ä»¤å…¶å®åªæ˜¯æŠŠè®°å½•çš„ä½ç½®ï¼Œæˆ–è€…æ•°æ®é¡µæ ‡è®°ä¸ºäº†å¯å¤ç”¨ï¼Œä½†ç£ç›˜æ–‡ä»¶çš„å¤§å°æ˜¯ä¸ä¼šå˜çš„ï¼Œè¿™äº›å¯ä»¥å¤ç”¨è¿˜æ²¡æœ‰è¢«ä½¿ç”¨çš„ç©ºé—´ï¼Œçœ‹èµ·æ¥å°±åƒæ˜¯ç©ºæ´ï¼Œé€ æˆæ•°æ®åº“çš„ç¨€ç–ï¼Œå› æ­¤éœ€è¦è¿›è¡Œç´§å‡‘å¤„ç† é‡å»ºæ•°æ®é‡å»ºè¡¨å°±æ˜¯æŒ‰ç…§ä¸»é”® ID é€’å¢çš„é¡ºåºï¼ŒæŠŠæ•°æ®ä¸€è¡Œä¸€è¡Œåœ°ä»æ—§è¡¨ä¸­è¯»å‡ºæ¥å†æ’å…¥åˆ°æ–°è¡¨ä¸­ï¼Œè®©æ•°æ®æ›´åŠ ç´§å‡‘ã€‚é‡å»ºè¡¨æ—¶ MySQL ä¼šè‡ªåŠ¨å®Œæˆè½¬å­˜æ•°æ®ã€äº¤æ¢è¡¨åã€åˆ é™¤æ—§è¡¨çš„æ“ä½œï¼Œçº¿ä¸Šæ“ä½œä¼šé˜»å¡å¤§é‡çš„çº¿ç¨‹å¢åˆ æ”¹æŸ¥çš„æ“ä½œ é‡å»ºå‘½ä»¤ï¼š 1ALTER TABLE A ENGINE=InnoDB å·¥ä½œæµç¨‹ï¼šæ–°å»ºä¸´æ—¶è¡¨ tmp_table Bï¼ˆåœ¨ Server å±‚åˆ›å»ºçš„ï¼‰ï¼ŒæŠŠè¡¨ A ä¸­çš„æ•°æ®å¯¼å…¥åˆ°è¡¨ B ä¸­ï¼Œæ“ä½œå®Œæˆåç”¨è¡¨ B æ›¿æ¢è¡¨ Aï¼Œå®Œæˆé‡å»º é‡å»ºè¡¨çš„æ­¥éª¤éœ€è¦ DDL ä¸æ˜¯ Online çš„ï¼Œå› ä¸ºåœ¨å¯¼å…¥æ•°æ®çš„è¿‡ç¨‹æœ‰æ–°çš„æ•°æ®è¦å†™å…¥åˆ°è¡¨ A çš„è¯ï¼Œå°±ä¼šé€ æˆæ•°æ®ä¸¢å¤± MySQL 5.6 ç‰ˆæœ¬å¼€å§‹å¼•å…¥çš„ Online DDLï¼Œé‡å»ºè¡¨çš„å‘½ä»¤é»˜è®¤æ‰§è¡Œæ­¤æ­¥éª¤ï¼š å»ºç«‹ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ tmp_fileï¼ˆInnoDB åˆ›å»ºï¼‰ï¼Œæ‰«æè¡¨ A ä¸»é”®çš„æ‰€æœ‰æ•°æ®é¡µ ç”¨æ•°æ®é¡µä¸­è¡¨ A çš„è®°å½•ç”Ÿæˆ B+ æ ‘ï¼Œå­˜å‚¨åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­ ç”Ÿæˆä¸´æ—¶æ–‡ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œå°†æ‰€æœ‰å¯¹ A çš„æ“ä½œè®°å½•åœ¨ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼ˆrow logï¼‰ä¸­ï¼Œå¯¹åº”çš„æ˜¯å›¾ä¸­ state2 çš„çŠ¶æ€ ä¸´æ—¶æ–‡ä»¶ç”Ÿæˆåï¼Œå°†æ—¥å¿—æ–‡ä»¶ä¸­çš„æ“ä½œåº”ç”¨åˆ°ä¸´æ—¶æ–‡ä»¶ï¼Œå¾—åˆ°ä¸€ä¸ªé€»è¾‘æ•°æ®ä¸Šä¸è¡¨ A ç›¸åŒçš„æ•°æ®æ–‡ä»¶ï¼Œå¯¹åº”çš„å°±æ˜¯å›¾ä¸­ state3 ç”¨ä¸´æ—¶æ–‡ä»¶æ›¿æ¢è¡¨ A çš„æ•°æ®æ–‡ä»¶ Online DDL æ“ä½œä¼šå…ˆè·å– MDL å†™é”ï¼Œå†é€€åŒ–æˆ MDL è¯»é”ã€‚ä½† MDL å†™é”æŒæœ‰æ—¶é—´æ¯”è¾ƒçŸ­ï¼Œæ‰€ä»¥å¯ä»¥ç§°ä¸º Onlineï¼› è€Œ MDL è¯»é”ï¼Œä¸é˜»æ­¢æ•°æ®å¢åˆ æŸ¥æ”¹ï¼Œä½†ä¼šé˜»æ­¢å…¶å®ƒçº¿ç¨‹ä¿®æ”¹è¡¨ç»“æ„ï¼ˆå¯ä»¥å¯¹æ¯” ANALYZE TABLE t å‘½ä»¤ï¼‰ é—®é¢˜ï¼šé‡å»ºè¡¨å¯ä»¥æ”¶ç¼©è¡¨ç©ºé—´ï¼Œä½†æ˜¯æ‰§è¡ŒæŒ‡ä»¤åæ•´ä½“å ç”¨ç©ºé—´å¢å¤§ åŸå› ï¼šåœ¨é‡å»ºè¡¨å InnoDB ä¸ä¼šæŠŠæ•´å¼ è¡¨å æ»¡ï¼Œæ¯ä¸ªé¡µç•™äº† 1&#x2F;16 ç»™åç»­çš„æ›´æ–°ä½¿ç”¨ã€‚è¡¨åœ¨æœªæ•´ç†ä¹‹å‰é¡µå·²ç»å ç”¨ 15&#x2F;16 ä»¥ä¸Šï¼Œæ”¶ç¼©ä¹‹åéœ€è¦ä¿æŒæ•°æ®å ç”¨ç©ºé—´åœ¨ 15&#x2F;16ï¼Œæ‰€ä»¥æ–‡ä»¶å ç”¨ç©ºé—´æ›´å¤§æ‰èƒ½ä¿æŒ æ³¨æ„ï¼šä¸´æ—¶æ–‡ä»¶ä¹Ÿè¦å ç”¨ç©ºé—´ï¼Œå¦‚æœç©ºé—´ä¸è¶³ä¼šé‡å»ºå¤±è´¥ åŸåœ°ç½®æ¢DDL ä¸­çš„ä¸´æ—¶è¡¨ tmp_table æ˜¯åœ¨ Server å±‚åˆ›å»ºçš„ï¼ŒOnline DDL ä¸­çš„ä¸´æ—¶æ–‡ä»¶ tmp_file æ˜¯ InnoDB åœ¨å†…éƒ¨åˆ›å»ºå‡ºæ¥çš„ï¼Œæ•´ä¸ª DDL è¿‡ç¨‹éƒ½åœ¨ InnoDB å†…éƒ¨å®Œæˆï¼Œå¯¹äº Server å±‚æ¥è¯´ï¼Œæ²¡æœ‰æŠŠæ•°æ®æŒªåŠ¨åˆ°ä¸´æ—¶è¡¨ï¼Œæ˜¯ä¸€ä¸ªåŸåœ°æ“ä½œï¼Œè¿™å°±æ˜¯ inplace ä¸¤è€…çš„å…³ç³»ï¼š DDL è¿‡ç¨‹å¦‚æœæ˜¯ Online çš„ï¼Œå°±ä¸€å®šæ˜¯ inplace çš„ inplace çš„ DDLï¼Œæœ‰å¯èƒ½ä¸æ˜¯ Online çš„ï¼Œæˆªæ­¢åˆ° MySQL 8.0ï¼Œå…¨æ–‡ç´¢å¼•ï¼ˆFULLTEXTï¼‰å’Œç©ºé—´ç´¢å¼•ï¼ˆSPATIALï¼‰å±äºè¿™ç§æƒ…å†µ å¹¶å‘ä¼˜åŒ–MySQL Server æ˜¯å¤šçº¿ç¨‹ç»“æ„ï¼ŒåŒ…æ‹¬åå°çº¿ç¨‹å’Œå®¢æˆ·æœåŠ¡çº¿ç¨‹ã€‚å¤šçº¿ç¨‹å¯ä»¥æœ‰æ•ˆåˆ©ç”¨æœåŠ¡å™¨èµ„æºï¼Œæé«˜æ•°æ®åº“çš„å¹¶å‘æ€§èƒ½ã€‚åœ¨ MySQL ä¸­ï¼Œæ§åˆ¶å¹¶å‘è¿æ¥å’Œçº¿ç¨‹çš„ä¸»è¦å‚æ•°ï¼š max_connectionsï¼šæ§åˆ¶å…è®¸è¿æ¥åˆ° MySQL æ•°æ®åº“çš„æœ€å¤§è¿æ¥æ•°ï¼Œé»˜è®¤å€¼æ˜¯ 151 å¦‚æœçŠ¶æ€å˜é‡ connection_errors_max_connections ä¸ä¸ºé›¶ï¼Œå¹¶ä¸”ä¸€ç›´å¢é•¿ï¼Œåˆ™è¯´æ˜ä¸æ–­æœ‰è¿æ¥è¯·æ±‚å› æ•°æ®åº“è¿æ¥æ•°å·²è¾¾åˆ°å…è®¸æœ€å¤§å€¼è€Œå¤±è´¥ï¼Œè¿™æ—¶å¯ä»¥è€ƒè™‘å¢å¤§ max_connections çš„å€¼ MySQL æœ€å¤§å¯æ”¯æŒçš„è¿æ¥æ•°å–å†³äºå¾ˆå¤šå› ç´ ï¼ŒåŒ…æ‹¬æ“ä½œç³»ç»Ÿå¹³å°çš„çº¿ç¨‹åº“çš„è´¨é‡ã€å†…å­˜å¤§å°ã€æ¯ä¸ªè¿æ¥çš„è´Ÿè·ã€CPUçš„å¤„ç†é€Ÿåº¦ã€æœŸæœ›çš„å“åº”æ—¶é—´ç­‰ã€‚åœ¨ Linux å¹³å°ä¸‹ï¼Œæ€§èƒ½å¥½çš„æœåŠ¡å™¨ï¼Œå¯ä»¥æ”¯æŒ 500-1000 ä¸ªè¿æ¥ï¼Œéœ€è¦æ ¹æ®æœåŠ¡å™¨æ€§èƒ½è¿›è¡Œè¯„ä¼°è®¾å®š innodb_thread_concurrencyï¼šå¹¶å‘çº¿ç¨‹æ•°ï¼Œä»£è¡¨ç³»ç»Ÿå†…åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡ï¼ˆå·²ç»è¢«ç§»é™¤ï¼‰ back_logï¼šæ§åˆ¶ MySQL ç›‘å¬ TCP ç«¯å£æ—¶çš„ç§¯å‹è¯·æ±‚æ ˆçš„å¤§å° å¦‚æœ Mysql çš„è¿æ¥æ•°è¾¾åˆ° max_connections æ—¶ï¼Œæ–°æ¥çš„è¯·æ±‚å°†ä¼šè¢«å­˜åœ¨å †æ ˆä¸­ï¼Œä»¥ç­‰å¾…æŸä¸€è¿æ¥é‡Šæ”¾èµ„æºï¼Œè¯¥å †æ ˆçš„æ•°é‡å³ back_logã€‚å¦‚æœç­‰å¾…è¿æ¥çš„æ•°é‡è¶…è¿‡ back_logï¼Œå°†ä¸è¢«æˆäºˆè¿æ¥èµ„æºç›´æ¥æŠ¥é”™ 5.6.6 ç‰ˆæœ¬ä¹‹å‰é»˜è®¤å€¼ä¸º 50ï¼Œä¹‹åçš„ç‰ˆæœ¬é»˜è®¤ä¸º 50 + (max_connections/5)ï¼Œä½†æœ€å¤§ä¸è¶…è¿‡900ï¼Œå¦‚æœéœ€è¦æ•°æ®åº“åœ¨è¾ƒçŸ­çš„æ—¶é—´å†…å¤„ç†å¤§é‡è¿æ¥è¯·æ±‚ï¼Œ å¯ä»¥è€ƒè™‘é€‚å½“å¢å¤§ back_log çš„å€¼ table_open_cacheï¼šæ§åˆ¶æ‰€æœ‰ SQL è¯­å¥æ‰§è¡Œçº¿ç¨‹å¯æ‰“å¼€è¡¨ç¼“å­˜çš„æ•°é‡ åœ¨æ‰§è¡Œ SQL è¯­å¥æ—¶ï¼Œæ¯ä¸ªæ‰§è¡Œçº¿ç¨‹è‡³å°‘è¦æ‰“å¼€1ä¸ªè¡¨ç¼“å­˜ï¼Œè¯¥å‚æ•°çš„å€¼åº”è¯¥æ ¹æ®è®¾ç½®çš„æœ€å¤§è¿æ¥æ•°ä»¥åŠæ¯ä¸ªè¿æ¥æ‰§è¡Œå…³è”æŸ¥è¯¢ä¸­æ¶‰åŠçš„è¡¨çš„æœ€å¤§æ•°é‡æ¥è®¾å®šï¼šmax_connections * N thread_cache_sizeï¼šå¯æ§åˆ¶ MySQL ç¼“å­˜å®¢æˆ·æœåŠ¡çº¿ç¨‹çš„æ•°é‡ ä¸ºäº†åŠ å¿«è¿æ¥æ•°æ®åº“çš„é€Ÿåº¦ï¼ŒMySQL ä¼šç¼“å­˜ä¸€å®šæ•°é‡çš„å®¢æˆ·æœåŠ¡çº¿ç¨‹ä»¥å¤‡é‡ç”¨ï¼Œæ± åŒ–æ€æƒ³ innodb_lock_wait_timeoutï¼šè®¾ç½® InnoDB äº‹åŠ¡ç­‰å¾…è¡Œé”çš„æ—¶é—´ï¼Œé»˜è®¤å€¼æ˜¯ 50ms å¯¹äºéœ€è¦å¿«é€Ÿåé¦ˆçš„ä¸šåŠ¡ç³»ç»Ÿï¼Œå¯ä»¥å°†è¡Œé”çš„ç­‰å¾…æ—¶é—´è°ƒå°ï¼Œä»¥é¿å…äº‹åŠ¡è¢«é•¿æ—¶é—´æŒ‚èµ·ï¼› å¯¹äºåå°è¿è¡Œçš„æ‰¹é‡å¤„ç†ç¨‹åºæ¥è¯´ï¼Œå¯ä»¥å°†è¡Œé”çš„ç­‰å¾…æ—¶é—´è°ƒå¤§ï¼Œä»¥é¿å…å‘ç”Ÿå¤§çš„å›æ»šæ“ä½œ äº‹åŠ¡æœºåˆ¶åŸºæœ¬ä»‹ç»äº‹åŠ¡ï¼ˆTransactionï¼‰æ˜¯è®¿é—®å’Œæ›´æ–°æ•°æ®åº“çš„ç¨‹åºæ‰§è¡Œå•å…ƒï¼›äº‹åŠ¡ä¸­å¯èƒ½åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª SQL è¯­å¥ï¼Œè¿™äº›è¯­å¥è¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œï¼Œä½œä¸ºä¸€ä¸ªå…³ç³»å‹æ•°æ®åº“ï¼ŒMySQL æ”¯æŒäº‹åŠ¡ã€‚ å•å…ƒä¸­çš„æ¯æ¡ SQL è¯­å¥éƒ½ç›¸äº’ä¾èµ–ï¼Œå½¢æˆä¸€ä¸ªæ•´ä½“ å¦‚æœæŸæ¡ SQL è¯­å¥æ‰§è¡Œå¤±è´¥æˆ–è€…å‡ºç°é”™è¯¯ï¼Œé‚£ä¹ˆæ•´ä¸ªå•å…ƒå°±ä¼šå›æ»šï¼Œæ’¤å›åˆ°äº‹åŠ¡æœ€åˆçš„çŠ¶æ€ å¦‚æœå•å…ƒä¸­æ‰€æœ‰çš„ SQL è¯­å¥éƒ½æ‰§è¡ŒæˆåŠŸï¼Œåˆ™äº‹åŠ¡å°±é¡ºåˆ©æ‰§è¡Œ äº‹åŠ¡çš„å››å¤§ç‰¹å¾ï¼šACID åŸå­æ€§ (atomicity) ä¸€è‡´æ€§ (consistency) éš”ç¦»æ€§ (isolaction) æŒä¹…æ€§ (durability) äº‹åŠ¡çš„å‡ ç§çŠ¶æ€ï¼š æ´»åŠ¨çš„ï¼ˆactiveï¼‰ï¼šäº‹åŠ¡å¯¹åº”çš„æ•°æ®åº“æ“ä½œæ­£åœ¨æ‰§è¡Œä¸­ éƒ¨åˆ†æäº¤çš„ï¼ˆpartially committedï¼‰ï¼šäº‹åŠ¡çš„æœ€åä¸€ä¸ªæ“ä½œæ‰§è¡Œå®Œï¼Œä½†æ˜¯å†…å­˜è¿˜æ²¡åˆ·æ–°è‡³ç£ç›˜ å¤±è´¥çš„ï¼ˆfailedï¼‰ï¼šå½“äº‹åŠ¡å¤„äºæ´»åŠ¨çŠ¶æ€æˆ–éƒ¨åˆ†æäº¤çŠ¶æ€æ—¶ï¼Œå¦‚æœæ•°æ®åº“é‡åˆ°äº†é”™è¯¯æˆ–åˆ·è„å¤±è´¥ï¼Œæˆ–è€…ç”¨æˆ·ä¸»åŠ¨åœæ­¢å½“å‰çš„äº‹åŠ¡ ä¸­æ­¢çš„ï¼ˆabortedï¼‰ï¼šå¤±è´¥çŠ¶æ€çš„äº‹åŠ¡å›æ»šå®Œæˆåçš„çŠ¶æ€ æäº¤çš„ï¼ˆcommittedï¼‰ï¼šå½“å¤„äºéƒ¨åˆ†æäº¤çŠ¶æ€çš„äº‹åŠ¡åˆ·è„æˆåŠŸï¼Œå°±å¤„äºæäº¤çŠ¶æ€ äº‹åŠ¡ç®¡ç†åŸºæœ¬æ“ä½œäº‹åŠ¡ç®¡ç†çš„ä¸‰ä¸ªæ­¥éª¤ å¼€å¯äº‹åŠ¡ï¼šè®°å½•å›æ»šç‚¹ï¼Œå¹¶é€šçŸ¥æœåŠ¡å™¨ï¼Œå°†è¦æ‰§è¡Œä¸€ç»„æ“ä½œï¼Œè¦ä¹ˆåŒæ—¶æˆåŠŸã€è¦ä¹ˆåŒæ—¶å¤±è´¥ æ‰§è¡Œ SQL è¯­å¥ï¼šæ‰§è¡Œå…·ä½“çš„ä¸€æ¡æˆ–å¤šæ¡ SQL è¯­å¥ ç»“æŸäº‹åŠ¡ï¼ˆæäº¤|å›æ»šï¼‰ æäº¤ï¼šæ²¡å‡ºç°é—®é¢˜ï¼Œæ•°æ®è¿›è¡Œæ›´æ–° å›æ»šï¼šå‡ºç°é—®é¢˜ï¼Œæ•°æ®æ¢å¤åˆ°å¼€å¯äº‹åŠ¡æ—¶çš„çŠ¶æ€ äº‹åŠ¡æ“ä½œï¼š æ˜¾å¼å¼€å¯äº‹åŠ¡ 12START TRANSACTION [READ ONLY|READ WRITE|WITH CONSISTENT SNAPSHOT]; #å¯ä»¥è·Ÿä¸€ä¸ªæˆ–å¤šä¸ªçŠ¶æ€ï¼Œæœ€åçš„æ˜¯ä¸€è‡´æ€§è¯»BEGIN [WORK]; è¯´æ˜ï¼šä¸å¡«çŠ¶æ€é»˜è®¤æ˜¯è¯»å†™äº‹åŠ¡ å›æ»šäº‹åŠ¡ï¼Œç”¨æ¥æ‰‹åŠ¨ä¸­æ­¢äº‹åŠ¡ 1ROLLBACK; æäº¤äº‹åŠ¡ï¼Œæ˜¾ç¤ºæ‰§è¡Œæ˜¯æ‰‹åŠ¨æäº¤ï¼ŒMySQL é»˜è®¤ä¸ºè‡ªåŠ¨æäº¤ 1COMMIT; ä¿å­˜ç‚¹ï¼šåœ¨äº‹åŠ¡çš„æ‰§è¡Œè¿‡ç¨‹ä¸­è®¾ç½®çš„è¿˜åŸç‚¹ï¼Œè°ƒç”¨ ROLLBACK æ—¶å¯ä»¥æŒ‡å®šå›æ»šåˆ°å“ªä¸ªç‚¹ 123SAVEPOINT point_name; #è®¾ç½®ä¿å­˜ç‚¹RELEASE point_name #åˆ é™¤ä¿å­˜ç‚¹ROLLBACK [WORK] TO [SAVEPOINT] point_name #å›æ»šè‡³æŸä¸ªä¿å­˜ç‚¹ï¼Œä¸å¡«é»˜è®¤å›æ»šåˆ°äº‹åŠ¡æ‰§è¡Œä¹‹å‰çš„çŠ¶æ€ æ“ä½œæ¼”ç¤º 1234567891011121314-- å¼€å¯äº‹åŠ¡START TRANSACTION;-- å¼ ä¸‰ç»™æå››è½¬è´¦500å…ƒ-- 1.å¼ ä¸‰è´¦æˆ·-500UPDATE account SET money=money-500 WHERE NAME=&#x27;å¼ ä¸‰&#x27;;-- 2.æå››è´¦æˆ·+500UPDATE account SET money=money+500 WHERE NAME=&#x27;æå››&#x27;;-- å›æ»šäº‹åŠ¡(å‡ºç°é—®é¢˜)ROLLBACK;-- æäº¤äº‹åŠ¡(æ²¡å‡ºç°é—®é¢˜)COMMIT; æäº¤æ–¹å¼æäº¤æ–¹å¼çš„ç›¸å…³è¯­æ³•ï¼š æŸ¥çœ‹äº‹åŠ¡æäº¤æ–¹å¼ 12SELECT @@AUTOCOMMIT; -- ä¼šè¯ï¼Œ1 ä»£è¡¨è‡ªåŠ¨æäº¤ 0 ä»£è¡¨æ‰‹åŠ¨æäº¤SELECT @@GLOBAL.AUTOCOMMIT; -- ç³»ç»Ÿ ä¿®æ”¹äº‹åŠ¡æäº¤æ–¹å¼ 12SET @@AUTOCOMMIT=æ•°å­—; -- ç³»ç»ŸSET AUTOCOMMIT=æ•°å­—; -- ä¼šè¯ ç³»ç»Ÿå˜é‡çš„æ“ä½œï¼š 12SET [GLOBAL|SESSION] å˜é‡å = å€¼; -- é»˜è®¤æ˜¯ä¼šè¯SET @@[(GLOBAL|SESSION).]å˜é‡å = å€¼; -- é»˜è®¤æ˜¯ç³»ç»Ÿ 1SHOW [GLOBAL|SESSION] VARIABLES [LIKE &#x27;å˜é‡%&#x27;]; -- é»˜è®¤æŸ¥çœ‹ä¼šè¯å†…ç³»ç»Ÿå˜é‡å€¼ å·¥ä½œåŸç†ï¼š è‡ªåŠ¨æäº¤ï¼šå¦‚æœæ²¡æœ‰ START TRANSACTION æ˜¾å¼åœ°å¼€å§‹ä¸€ä¸ªäº‹åŠ¡ï¼Œé‚£ä¹ˆæ¯æ¡ SQL è¯­å¥éƒ½ä¼šè¢«å½“åšä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œæäº¤æ“ä½œï¼›æ˜¾å¼å¼€å¯äº‹åŠ¡åï¼Œä¼šåœ¨æœ¬æ¬¡äº‹åŠ¡ç»“æŸï¼ˆæäº¤æˆ–å›æ»šï¼‰å‰æš‚æ—¶å…³é—­è‡ªåŠ¨æäº¤ æ‰‹åŠ¨æäº¤ï¼šä¸éœ€è¦æ˜¾å¼çš„å¼€å¯äº‹åŠ¡ï¼Œæ‰€æœ‰çš„ SQL è¯­å¥éƒ½åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œç›´åˆ°æ‰§è¡Œäº†æäº¤æˆ–å›æ»šï¼Œç„¶åè¿›å…¥ä¸‹ä¸€ä¸ªäº‹åŠ¡ éšå¼æäº¤ï¼šå­˜åœ¨ä¸€äº›ç‰¹æ®Šçš„å‘½ä»¤ï¼Œåœ¨äº‹åŠ¡ä¸­æ‰§è¡Œäº†è¿™äº›å‘½ä»¤ä¼šé©¬ä¸Šå¼ºåˆ¶æ‰§è¡Œ COMMIT æäº¤äº‹åŠ¡ DDL è¯­å¥ (CREATE&#x2F;DROP&#x2F;ALTER)ã€LOCK TABLES è¯­å¥ã€LOAD DATA å¯¼å…¥æ•°æ®è¯­å¥ã€ä¸»ä»å¤åˆ¶è¯­å¥ç­‰ å½“ä¸€ä¸ªäº‹åŠ¡è¿˜æ²¡æäº¤æˆ–å›æ»šï¼Œæ˜¾å¼çš„å¼€å¯ä¸€ä¸ªäº‹åŠ¡ä¼šéšå¼çš„æäº¤ä¸Šä¸€ä¸ªäº‹åŠ¡ äº‹åŠ¡ IDäº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¯¹æŸä¸ªè¡¨æ‰§è¡Œäº†å¢åˆ æ”¹æ“ä½œæˆ–è€…åˆ›å»ºè¡¨ï¼Œå°±ä¼šä¸ºå½“å‰äº‹åŠ¡åˆ†é…ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„äº‹åŠ¡ IDï¼ˆå¯¹ä¸´æ—¶è¡¨å¹¶ä¸ä¼šåˆ†é… IDï¼‰ï¼Œå¦‚æœå½“å‰äº‹åŠ¡æ²¡æœ‰è¢«åˆ†é… IDï¼Œé»˜è®¤æ˜¯ 0 è¯´æ˜ï¼šåªè¯»äº‹åŠ¡ä¸èƒ½å¯¹æ™®é€šçš„è¡¨è¿›è¡Œå¢åˆ æ”¹æ“ä½œï¼Œä½†æ˜¯å¯ä»¥å¯¹ä¸´æ—¶è¡¨å¢åˆ æ”¹ï¼Œè¯»å†™äº‹åŠ¡å¯ä»¥å¯¹æ•°æ®è¡¨æ‰§è¡Œå¢åˆ æ”¹æŸ¥æ“ä½œ äº‹åŠ¡ ID æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªæ•°å­—ï¼ŒæœåŠ¡å™¨åœ¨å†…å­˜ä¸­ç»´æŠ¤ä¸€ä¸ªå…¨å±€å˜é‡ï¼š æ¯å½“éœ€è¦ä¸ºæŸä¸ªäº‹åŠ¡åˆ†é… IDï¼Œå°±ä¼šæŠŠå…¨å±€å˜é‡çš„å€¼èµ‹å€¼ç»™äº‹åŠ¡ IDï¼Œç„¶åå˜é‡è‡ªå¢ 1 æ¯å½“å˜é‡å€¼ä¸º 256 çš„å€æ•°æ—¶ï¼Œå°±å°†è¯¥å˜é‡çš„å€¼åˆ·æ–°åˆ°ç³»ç»Ÿè¡¨ç©ºé—´çš„ Max Trx ID å±æ€§ä¸­ï¼Œè¯¥å±æ€§å  8 å­—èŠ‚ ç³»ç»Ÿå†æ¬¡å¯åŠ¨åï¼Œä¼šè¯»å–è¡¨ç©ºé—´çš„ Max Trx ID å±æ€§åˆ°å†…å­˜ï¼ŒåŠ ä¸Š 256 åèµ‹å€¼ç»™å…¨å±€å˜é‡ï¼Œå› ä¸ºå…³æœºæ—¶çš„äº‹åŠ¡ ID å¯èƒ½å¹¶ä¸æ˜¯ 256 çš„å€æ•°ï¼Œä¼šæ¯” Max Trx ID å¤§ï¼Œæ‰€ä»¥éœ€è¦åŠ ä¸Š 256 ä¿æŒäº‹åŠ¡ ID æ˜¯ä¸€ä¸ªé€’å¢çš„æ•°å­— èšç°‡ç´¢å¼•çš„è¡Œè®°å½•é™¤äº†å®Œæ•´çš„æ•°æ®ï¼Œè¿˜ä¼šè‡ªåŠ¨æ·»åŠ  trx_idã€roll_pointer éšè—åˆ—ï¼Œå¦‚æœè¡¨ä¸­æ²¡æœ‰ä¸»é”®å¹¶ä¸”æ²¡æœ‰éç©ºå”¯ä¸€ç´¢å¼•ï¼Œä¹Ÿä¼šæ·»åŠ ä¸€ä¸ª row_id çš„éšè—åˆ—ä½œä¸ºèšç°‡ç´¢å¼• éš”ç¦»çº§åˆ«å››ç§çº§åˆ«äº‹åŠ¡çš„éš”ç¦»çº§åˆ«ï¼šå¤šä¸ªå®¢æˆ·ç«¯æ“ä½œæ—¶ï¼Œå„ä¸ªå®¢æˆ·ç«¯çš„äº‹åŠ¡ä¹‹é—´åº”è¯¥æ˜¯éš”ç¦»çš„ï¼Œä¸åŒçš„äº‹åŠ¡ä¹‹é—´ä¸è¯¥äº’ç›¸å½±å“ï¼Œè€Œå¦‚æœå¤šä¸ªäº‹åŠ¡æ“ä½œåŒä¸€æ‰¹æ•°æ®æ—¶ï¼Œåˆ™éœ€è¦è®¾ç½®ä¸åŒçš„éš”ç¦»çº§åˆ«ï¼Œå¦åˆ™å°±ä¼šäº§ç”Ÿé—®é¢˜ã€‚ éš”ç¦»çº§åˆ«åˆ†ç±»ï¼š éš”ç¦»çº§åˆ« åç§° ä¼šå¼•å‘çš„é—®é¢˜ æ•°æ®åº“é»˜è®¤éš”ç¦»çº§åˆ« Read Uncommitted è¯»æœªæäº¤ è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯» Read Committed è¯»å·²æäº¤ ä¸å¯é‡å¤è¯»ã€å¹»è¯» Oracle &#x2F; SQL Server Repeatable Read å¯é‡å¤è¯» å¹»è¯» MySQL Serializable å¯ä¸²è¡ŒåŒ– æ—  ä¸€èˆ¬æ¥è¯´ï¼Œéš”ç¦»çº§åˆ«è¶Šä½ï¼Œç³»ç»Ÿå¼€é”€è¶Šä½ï¼Œå¯æ”¯æŒçš„å¹¶å‘è¶Šé«˜ï¼Œä½†éš”ç¦»æ€§ä¹Ÿè¶Šå·® è„å†™ (Dirty Write)ï¼šå½“ä¸¤ä¸ªæˆ–å¤šä¸ªäº‹åŠ¡é€‰æ‹©åŒä¸€è¡Œï¼Œæœ€åˆçš„äº‹åŠ¡ä¿®æ”¹çš„å€¼è¢«åé¢äº‹åŠ¡ä¿®æ”¹çš„å€¼è¦†ç›–ï¼Œæ‰€æœ‰çš„éš”ç¦»çº§åˆ«éƒ½å¯ä»¥é¿å…è„å†™ï¼ˆåˆå«ä¸¢å¤±æ›´æ–°ï¼‰ï¼Œå› ä¸ºæœ‰è¡Œé” è„è¯» (Dirty Reads)ï¼šåœ¨ä¸€ä¸ªäº‹åŠ¡å¤„ç†è¿‡ç¨‹ä¸­è¯»å–äº†å¦ä¸€ä¸ªæœªæäº¤çš„äº‹åŠ¡ä¸­ä¿®æ”¹è¿‡çš„æ•°æ® ä¸å¯é‡å¤è¯» (Non-Repeatable Reads)ï¼šåœ¨ä¸€ä¸ªäº‹åŠ¡å¤„ç†è¿‡ç¨‹ä¸­è¯»å–äº†å¦ä¸€ä¸ªäº‹åŠ¡ä¸­ä¿®æ”¹å¹¶å·²æäº¤çš„æ•°æ® å¯é‡å¤è¯»çš„æ„æ€æ˜¯ä¸ç®¡è¯»å‡ æ¬¡ï¼Œç»“æœéƒ½ä¸€æ ·ï¼Œå¯ä»¥é‡å¤çš„è¯»ï¼Œå¯ä»¥ç†è§£ä¸ºå¿«ç…§è¯»ï¼Œè¦è¯»çš„æ•°æ®é›†ä¸ä¼šå‘ç”Ÿå˜åŒ– å¹»è¯» (Phantom Reads)ï¼šåœ¨äº‹åŠ¡ä¸­æŒ‰æŸä¸ªæ¡ä»¶å…ˆåä¸¤æ¬¡æŸ¥è¯¢æ•°æ®åº“ï¼Œåä¸€æ¬¡æŸ¥è¯¢æŸ¥åˆ°äº†å‰ä¸€æ¬¡æŸ¥è¯¢æ²¡æœ‰æŸ¥åˆ°çš„è¡Œï¼Œæ•°æ®æ¡ç›®å‘ç”Ÿäº†å˜åŒ–ã€‚æ¯”å¦‚æŸ¥è¯¢æŸæ•°æ®ä¸å­˜åœ¨ï¼Œå‡†å¤‡æ’å…¥æ­¤è®°å½•ï¼Œä½†æ‰§è¡Œæ’å…¥æ—¶å‘ç°æ­¤è®°å½•å·²å­˜åœ¨ï¼Œæ— æ³•æ’å…¥ éš”ç¦»çº§åˆ«æ“ä½œè¯­æ³•ï¼š æŸ¥è¯¢æ•°æ®åº“éš”ç¦»çº§åˆ« 12SELECT @@TX_ISOLATION; -- ä¼šè¯SELECT @@GLOBAL.TX_ISOLATION; -- ç³»ç»Ÿ ä¿®æ”¹æ•°æ®åº“éš”ç¦»çº§åˆ« 1SET GLOBAL TRANSACTION ISOLATION LEVEL çº§åˆ«å­—ç¬¦ä¸²; åŠ é”åˆ†æInnoDB å­˜å‚¨å¼•æ“æ”¯æŒäº‹åŠ¡ï¼Œæ‰€ä»¥åŠ é”åˆ†ææ˜¯åŸºäºè¯¥å­˜å‚¨å¼•æ“ Read Uncommitted çº§åˆ«ï¼Œä»»ä½•æ“ä½œéƒ½ä¸ä¼šåŠ é” Read Committed çº§åˆ«ï¼Œå¢åˆ æ”¹æ“ä½œä¼šåŠ å†™é”ï¼ˆè¡Œé”ï¼‰ï¼Œè¯»æ“ä½œä¸åŠ é” åœ¨ Server å±‚è¿‡æ»¤æ¡ä»¶æ—¶å‘ç°ä¸æ»¡è¶³çš„è®°å½•ä¼šè°ƒç”¨ unlock_row æ–¹æ³•é‡Šæ”¾è¯¥è®°å½•çš„è¡Œé”ï¼Œä¿è¯æœ€ååªæœ‰æ»¡è¶³æ¡ä»¶çš„è®°å½•åŠ é”ï¼Œä½†æ˜¯æ‰«è¡¨è¿‡ç¨‹ä¸­æ¯æ¡è®°å½•çš„åŠ é”æ“ä½œä¸èƒ½çœç•¥ã€‚æ‰€ä»¥å¯¹æ•°æ®é‡å¾ˆå¤§çš„è¡¨åšæ‰¹é‡ä¿®æ”¹æ—¶ï¼Œå¦‚æœæ— æ³•ä½¿ç”¨ç›¸åº”çš„ç´¢å¼•ï¼ˆå…¨è¡¨æ‰«æï¼‰ï¼Œåœ¨ Server è¿‡æ»¤æ•°æ®æ—¶å°±ä¼šç‰¹åˆ«æ…¢ï¼Œå‡ºç°è™½ç„¶æ²¡æœ‰ä¿®æ”¹æŸäº›è¡Œçš„æ•°æ®ï¼Œä½†æ˜¯è¿˜æ˜¯è¢«é”ä½äº†çš„ç°è±¡ï¼ˆé”è¡¨ï¼‰ï¼Œè¿™ç§æƒ…å†µåŒæ ·é€‚ç”¨äº RR Repeatable Read çº§åˆ«ï¼Œå¢åˆ æ”¹æ“ä½œä¼šåŠ å†™é”ï¼Œè¯»æ“ä½œä¸åŠ é”ã€‚å› ä¸ºè¯»å†™é”ä¸å…¼å®¹ï¼ŒåŠ äº†è¯»é”åå…¶ä»–äº‹åŠ¡å°±æ— æ³•ä¿®æ”¹æ•°æ®ï¼Œå½±å“äº†å¹¶å‘æ€§èƒ½ï¼Œä¸ºäº†ä¿è¯éš”ç¦»æ€§å’Œå¹¶å‘æ€§ï¼ŒMySQL é€šè¿‡ MVCC è§£å†³äº†è¯»å†™å†²çªã€‚RR çº§åˆ«ä¸‹çš„é”æœ‰å¾ˆå¤šç§ï¼Œé”æœºåˆ¶ç« èŠ‚è¯¦è§£ Serializable çº§åˆ«ï¼Œè¯»åŠ å…±äº«é”ï¼Œå†™åŠ æ’ä»–é”ï¼Œè¯»å†™äº’æ–¥ï¼Œä½¿ç”¨çš„æ‚²è§‚é”çš„ç†è®ºï¼Œå®ç°ç®€å•ï¼Œæ•°æ®æ›´åŠ å®‰å…¨ï¼Œä½†æ˜¯å¹¶å‘èƒ½åŠ›éå¸¸å·® ä¸²è¡ŒåŒ–ï¼šè®©æ‰€æœ‰äº‹åŠ¡æŒ‰é¡ºåºå•ç‹¬æ‰§è¡Œï¼Œå†™æ“ä½œä¼šåŠ å†™é”ï¼Œè¯»æ“ä½œä¼šåŠ è¯»é” å¯ä¸²è¡ŒåŒ–ï¼šè®©æ‰€æœ‰æ“ä½œç›¸åŒæ•°æ®çš„äº‹åŠ¡é¡ºåºæ‰§è¡Œï¼Œé€šè¿‡åŠ é”å®ç° å‚è€ƒæ–‡ç« ï¼šhttps://tech.meituan.com/2014/08/20/innodb-lock.html åŸå­ç‰¹æ€§å®ç°æ–¹å¼åŸå­æ€§æ˜¯æŒ‡äº‹åŠ¡æ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½ï¼Œäº‹åŠ¡çš„æ“ä½œå¦‚æœæˆåŠŸå°±å¿…é¡»è¦å®Œå…¨åº”ç”¨åˆ°æ•°æ®åº“ï¼Œå¤±è´¥åˆ™ä¸èƒ½å¯¹æ•°æ®åº“æœ‰ä»»ä½•å½±å“ã€‚æ¯”å¦‚äº‹åŠ¡ä¸­ä¸€ä¸ª SQL è¯­å¥æ‰§è¡Œå¤±è´¥ï¼Œåˆ™å·²æ‰§è¡Œçš„è¯­å¥ä¹Ÿå¿…é¡»å›æ»šï¼Œæ•°æ®åº“é€€å›åˆ°äº‹åŠ¡å‰çš„çŠ¶æ€ InnoDB å­˜å‚¨å¼•æ“æä¾›äº†ä¸¤ç§äº‹åŠ¡æ—¥å¿—ï¼šredo logï¼ˆé‡åšæ—¥å¿—ï¼‰å’Œ undo logï¼ˆå›æ»šæ—¥å¿—ï¼‰ redo log ç”¨äºä¿è¯äº‹åŠ¡æŒä¹…æ€§ undo log ç”¨äºä¿è¯äº‹åŠ¡åŸå­æ€§å’Œéš”ç¦»æ€§ undo log å±äºé€»è¾‘æ—¥å¿—ï¼Œæ ¹æ®æ¯è¡Œæ“ä½œè¿›è¡Œè®°å½•ï¼Œè®°å½•äº† SQL æ‰§è¡Œç›¸å…³çš„ä¿¡æ¯ï¼Œç”¨æ¥å›æ»šè¡Œè®°å½•åˆ°æŸä¸ªç‰ˆæœ¬ å½“äº‹åŠ¡å¯¹æ•°æ®åº“è¿›è¡Œä¿®æ”¹æ—¶ï¼ŒInnoDB ä¼šå…ˆè®°å½•å¯¹åº”çš„ undo logï¼Œå¦‚æœäº‹åŠ¡æ‰§è¡Œå¤±è´¥æˆ–è°ƒç”¨äº† rollback å¯¼è‡´äº‹åŠ¡å›æ»šï¼ŒInnoDB ä¼šæ ¹æ® undo log çš„å†…å®¹åšä¸ä¹‹å‰ç›¸åçš„æ“ä½œï¼š å¯¹äºæ¯ä¸ª insertï¼Œå›æ»šæ—¶ä¼šæ‰§è¡Œ delete å¯¹äºæ¯ä¸ª deleteï¼Œå›æ»šæ—¶ä¼šæ‰§è¡Œ insert å¯¹äºæ¯ä¸ª updateï¼Œå›æ»šæ—¶ä¼šæ‰§è¡Œä¸€ä¸ªç›¸åçš„ updateï¼ŒæŠŠæ•°æ®ä¿®æ”¹å›å» å‚è€ƒæ–‡ç« ï¼šhttps://www.cnblogs.com/kismetv/p/10331633.html DML è§£æINSERTä¹è§‚æ’å…¥ï¼šå½“å‰æ•°æ®é¡µçš„å‰©ä½™ç©ºé—´å……è¶³ï¼Œç›´æ¥å°†æ•°æ®è¿›è¡Œæ’å…¥ æ‚²è§‚æ’å…¥ï¼šå½“å‰æ•°æ®é¡µçš„å‰©ä½™ç©ºé—´ä¸è¶³ï¼Œéœ€è¦è¿›è¡Œé¡µåˆ†è£‚ï¼Œç”³è¯·ä¸€ä¸ªæ–°çš„é¡µé¢æ¥æ’å…¥æ•°æ®ï¼Œä¼šé€ æˆæ›´å¤šçš„ redo logï¼Œundo log å½±å“ä¸å¤§ å½“å‘æŸä¸ªè¡¨æ’å…¥ä¸€æ¡è®°å½•ï¼Œå®é™…ä¸Šéœ€è¦å‘èšç°‡ç´¢å¼•å’Œæ‰€æœ‰äºŒçº§ç´¢å¼•éƒ½æ’å…¥ä¸€æ¡è®°å½•ï¼Œä½†æ˜¯ undo log åªé’ˆå¯¹èšç°‡ç´¢å¼•è®°å½•ï¼Œåœ¨å›æ»šæ—¶ä¼šæ ¹æ®èšç°‡ç´¢å¼•å»æ‰€æœ‰çš„äºŒçº§ç´¢å¼•è¿›è¡Œå›æ»šæ“ä½œ roll_pointer æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘è®°å½•å¯¹åº”çš„ undo log æ—¥å¿—ï¼Œä¸€æ¡è®°å½•å°±æ˜¯ä¸€ä¸ªæ•°æ®è¡Œï¼Œè¡Œæ ¼å¼ä¸­çš„ roll_pointer å°±æŒ‡å‘ undo log DELETEæ’å…¥åˆ°é¡µé¢ä¸­çš„è®°å½•ä¼šæ ¹æ® next_record å±æ€§ç»„æˆä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œè¿™ä¸ªé“¾è¡¨ç§°ä¸ºæ­£å¸¸é“¾è¡¨ï¼Œè¢«åˆ é™¤çš„è®°å½•ä¹Ÿä¼šé€šè¿‡ next_record ç»„æˆä¸€ä¸ªåƒåœ¾é“¾è¡¨ï¼Œè¯¥é“¾è¡¨ä¸­æ‰€å ç”¨çš„å­˜å‚¨ç©ºé—´å¯ä»¥è¢«é‡æ–°åˆ©ç”¨ï¼Œå¹¶ä¸ä¼šç›´æ¥æ¸…é™¤æ•°æ® åœ¨é¡µé¢ Page Header ä¸­ï¼ŒPAGE_FREE å±æ€§æŒ‡å‘åƒåœ¾é“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼Œåˆ é™¤çš„å·¥ä½œè¿‡ç¨‹ï¼š å°†è¦åˆ é™¤çš„è®°å½•çš„ delete_flag ä½ç½®ä¸º 1ï¼Œå…¶ä»–ä¸åšä¿®æ”¹ï¼Œè¿™ä¸ªè¿‡ç¨‹å« delete mark åœ¨äº‹åŠ¡æäº¤å‰ï¼Œdelete_flag &#x3D; 1 çš„è®°å½•ä¸€ç›´éƒ½ä¼šå¤„äºä¸­é—´çŠ¶æ€ äº‹åŠ¡æäº¤åï¼Œæœ‰ä¸“é—¨çš„çº¿ç¨‹å°† delete_flag &#x3D; 1 çš„è®°å½•ä»æ­£å¸¸é“¾è¡¨ç§»é™¤å¹¶åŠ å…¥åƒåœ¾é“¾è¡¨ï¼Œè¿™ä¸ªè¿‡ç¨‹å« purge purge çº¿ç¨‹åœ¨æ‰§è¡Œåˆ é™¤æ“ä½œæ—¶ä¼šåˆ›å»ºä¸€ä¸ª ReadViewï¼Œæ ¹æ®äº‹åŠ¡çš„å¯è§æ€§ç§»é™¤æ•°æ®ï¼ˆéš”ç¦»ç‰¹æ€§éƒ¨åˆ†è¯¦è§£ï¼‰ å½“æœ‰æ–°æ’å…¥çš„è®°å½•æ—¶ï¼Œé¦–å…ˆåˆ¤æ–­ PAGE_FREE æŒ‡å‘çš„å¤´èŠ‚ç‚¹æ˜¯å¦è¶³å¤Ÿå®¹çº³æ–°çºªå½•ï¼š å¦‚æœå¯ä»¥å®¹çº³æ–°çºªå½•ï¼Œå°±ä¼šç›´æ¥é‡ç”¨å·²åˆ é™¤çš„è®°å½•çš„å­˜å‚¨ç©ºé—´ï¼Œç„¶åè®© PAGE_FREE æŒ‡å‘åƒåœ¾é“¾è¡¨çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ å¦‚æœä¸èƒ½å®¹çº³æ–°çºªå½•ï¼Œå°±ç›´æ¥å‘é¡µé¢ç”³è¯·æ–°çš„ç©ºé—´å­˜å‚¨ï¼Œå¹¶ä¸ä¼šéå†åƒåœ¾é“¾è¡¨ é‡ç”¨å·²åˆ é™¤çš„è®°å½•ç©ºé—´ï¼Œå¯èƒ½ä¼šé€ æˆç©ºé—´ç¢ç‰‡ï¼Œå½“æ•°æ®é¡µå®¹çº³ä¸äº†ä¸€æ¡è®°å½•æ—¶ï¼Œä¼šåˆ¤æ–­å°†ç¢ç‰‡ç©ºé—´åŠ èµ·æ¥æ˜¯å¦å¯ä»¥å®¹çº³ï¼Œåˆ¤æ–­ä¸ºçœŸå°±ä¼šé‡æ–°ç»„ç»‡é¡µå†…çš„è®°å½•ï¼š å¼€è¾Ÿä¸€ä¸ªä¸´æ—¶é¡µé¢ï¼Œå°†é¡µå†…è®°å½•ä¸€æ¬¡æ’å…¥åˆ°ä¸´æ—¶é¡µé¢ï¼Œæ­¤æ—¶ä¸´æ—¶é¡µé¢æ—¶æ²¡æœ‰ç¢ç‰‡çš„ æŠŠä¸´æ—¶é¡µé¢çš„å†…å®¹å¤åˆ¶åˆ°æœ¬é¡µï¼Œè¿™æ ·å°±è§£æ”¾å‡ºäº†å†…å­˜ç¢ç‰‡ï¼Œä½†æ˜¯ä¼šè€—è´¹å¾ˆå¤§çš„æ€§èƒ½èµ„æº UPDATEæ‰§è¡Œ UPDATE è¯­å¥ï¼Œå¯¹äºæ›´æ–°ä¸»é”®å’Œä¸æ›´æ–°ä¸»é”®æœ‰ä¸¤ç§ä¸åŒçš„å¤„ç†æ–¹å¼ ä¸æ›´æ–°ä¸»é”®çš„æƒ…å†µï¼š å°±åœ°æ›´æ–°ï¼ˆin-place updateï¼‰ï¼Œå¦‚æœæ›´æ–°åçš„åˆ—å’Œæ›´æ–°å‰çš„åˆ—å ç”¨çš„å­˜å‚¨ç©ºé—´ä¸€æ ·å¤§ï¼Œå°±å¯ä»¥ç›´æ¥åœ¨åŸè®°å½•ä¸Šä¿®æ”¹ å…ˆåˆ é™¤æ—§çºªå½•ï¼Œå†æ’å…¥æ–°çºªå½•ï¼Œè¿™é‡Œçš„åˆ é™¤ä¸æ˜¯ delete markï¼Œè€Œæ˜¯ç›´æ¥å°†è®°å½•åŠ å…¥åƒåœ¾é“¾è¡¨ï¼Œå¹¶ä¸”ä¿®æ”¹é¡µé¢çš„ç›¸åº”çš„æ§åˆ¶ä¿¡æ¯ï¼Œæ‰§è¡Œåˆ é™¤çš„çº¿ç¨‹ä¸æ˜¯ purgeï¼Œæ˜¯æ‰§è¡Œæ›´æ–°çš„ç”¨æˆ·çº¿ç¨‹ï¼Œæ’å…¥æ–°è®°å½•æ—¶å¯èƒ½é€ æˆé¡µç©ºé—´ä¸è¶³ï¼Œä»è€Œå¯¼è‡´é¡µåˆ†è£‚ æ›´æ–°ä¸»é”®çš„æƒ…å†µï¼š å°†æ—§çºªå½•è¿›è¡Œ delete markï¼Œåœ¨æ›´æ–°è¯­å¥æäº¤åç”± purge çº¿ç¨‹ç§»å…¥åƒåœ¾é“¾è¡¨ æ ¹æ®æ›´æ–°çš„å„åˆ—çš„å€¼åˆ›å»ºä¸€æ¡æ–°çºªå½•ï¼Œæ’å…¥åˆ°èšç°‡ç´¢å¼•ä¸­ åœ¨å¯¹ä¸€æ¡è®°å½•ä¿®æ”¹å‰ä¼šå°†è®°å½•çš„éšè—åˆ— trx_id å’Œ roll_pointer çš„æ—§å€¼è®°å½•åˆ°å½“å‰ undo log å¯¹åº”çš„å±æ€§ä¸­ï¼Œè¿™æ ·å½“å‰è®°å½•çš„ roll_pointer æŒ‡å‘å½“å‰ undo log è®°å½•ï¼Œå½“å‰ undo log è®°å½•çš„ roll_pointer æŒ‡å‘æ—§çš„ undo log è®°å½•ï¼Œå½¢æˆä¸€ä¸ªç‰ˆæœ¬é“¾ UPDATEã€DELETE æ“ä½œäº§ç”Ÿçš„ undo æ—¥å¿—ä¼šç”¨äºå…¶ä»–äº‹åŠ¡çš„ MVCC æ“ä½œï¼Œæ‰€ä»¥ä¸èƒ½ç«‹å³åˆ é™¤ï¼ŒINSERT å¯ä»¥åˆ é™¤çš„åŸå› æ˜¯ MVCC æ˜¯å¯¹ç°æœ‰æ•°æ®çš„å¿«ç…§ å›æ»šæ—¥å¿—undo log æ˜¯é‡‡ç”¨æ®µçš„æ–¹å¼æ¥è®°å½•ï¼ŒRollback Segement ç§°ä¸ºå›æ»šæ®µï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªç±»å‹æ˜¯ Rollback Segement Header çš„é¡µé¢ æ¯ä¸ªå›æ»šæ®µä¸­æœ‰ 1024 ä¸ª undo slotï¼Œæ¯ä¸ª slot å­˜æ”¾ undo é“¾è¡¨é¡µé¢çš„å¤´èŠ‚ç‚¹é¡µå·ï¼Œæ¯ä¸ªé“¾è¡¨å¯¹åº”ä¸€ä¸ªå« undo log segment çš„æ®µ åœ¨ä»¥å‰è€ç‰ˆæœ¬ï¼Œåªæ”¯æŒ 1 ä¸ª Rollback Segementï¼Œåªèƒ½è®°å½• 1024 ä¸ª undo log segment MySQL5.5 å¼€å§‹æ”¯æŒ 128 ä¸ª Rollback Segementï¼Œæ”¯æŒ 128*1024 ä¸ª undo æ“ä½œ å·¥ä½œæµç¨‹ï¼š äº‹åŠ¡æ‰§è¡Œå‰éœ€è¦åˆ°ç³»ç»Ÿè¡¨ç©ºé—´ç¬¬ 5 å·é¡µé¢ä¸­åˆ†é…ä¸€ä¸ªå›æ»šæ®µï¼ˆé¡µï¼‰ï¼Œè·å–ä¸€ä¸ª Rollback Segement Header é¡µé¢çš„åœ°å€ å›æ»šæ®µé¡µé¢æœ‰ 1024 ä¸ª undo slotï¼Œé¦–å…ˆå»å›æ»šæ®µçš„ä¸¤ä¸ª cached é“¾è¡¨è·å–ç¼“å­˜çš„ slotï¼Œç¼“å­˜ä¸­æ²¡æœ‰å°±åœ¨å›æ»šæ®µé¡µé¢ä¸­æ‰¾ä¸€ä¸ªå¯ç”¨çš„ undo slot åˆ†é…ç»™å½“å‰äº‹åŠ¡ å¦‚æœæ˜¯ç¼“å­˜ä¸­è·å–çš„ slotï¼Œåˆ™è¯¥ slot å¯¹åº”çš„ undo log segment å·²ç»åˆ†é…äº†ï¼Œéœ€è¦é‡æ–°åˆ†é…ï¼Œç„¶åä» undo log segment ä¸­ç”³è¯·ä¸€ä¸ªé¡µé¢ä½œä¸ºæ—¥å¿—é“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼Œå¹¶å¡«å…¥å¯¹åº”çš„ slot ä¸­ æ¯ä¸ªäº‹åŠ¡ undo æ—¥å¿—åœ¨è®°å½•çš„æ—¶å€™å ç”¨ä¸¤ä¸ª undo é¡µé¢çš„ç»„æˆé“¾è¡¨ï¼Œåˆ†åˆ«ä¸º insert undo é“¾è¡¨å’Œ update undo é“¾è¡¨ï¼Œé“¾è¡¨çš„å¤´èŠ‚ç‚¹é¡µé¢ä¸º first undo page ä¼šåŒ…å«ä¸€äº›ç®¡ç†ä¿¡æ¯ï¼Œå…¶ä»–é¡µé¢ä¸º normal undo page è¯´æ˜ï¼šäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹çš„ä¸´æ—¶è¡¨ä¹Ÿéœ€è¦ä¸¤ä¸ª undo é“¾è¡¨ï¼Œä¸å’Œæ™®é€šè¡¨å…±ç”¨ï¼Œè¿™äº›é“¾è¡¨å¹¶ä¸æ˜¯äº‹åŠ¡å¼€å§‹å°±åˆ†é…ï¼Œè€Œæ˜¯æŒ‰éœ€åˆ†é… éš”ç¦»ç‰¹æ€§å®ç°æ–¹å¼éš”ç¦»æ€§æ˜¯æŒ‡ï¼Œäº‹åŠ¡å†…éƒ¨çš„æ“ä½œä¸å…¶ä»–äº‹åŠ¡æ˜¯éš”ç¦»çš„ï¼Œå¤šä¸ªå¹¶å‘äº‹åŠ¡ä¹‹é—´è¦ç›¸äº’éš”ç¦»ï¼Œä¸èƒ½äº’ç›¸å¹²æ‰° ä¸¥æ ¼çš„éš”ç¦»æ€§ï¼Œå¯¹åº”äº†äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸­çš„ serializableï¼Œå®é™…åº”ç”¨ä¸­å¯¹æ€§èƒ½è€ƒè™‘å¾ˆå°‘ä½¿ç”¨å¯ä¸²è¡ŒåŒ– ä¸åŸå­æ€§ã€æŒä¹…æ€§ä¾§é‡äºç ”ç©¶äº‹åŠ¡æœ¬èº«ä¸åŒï¼Œéš”ç¦»æ€§ç ”ç©¶çš„æ˜¯ä¸åŒäº‹åŠ¡ä¹‹é—´çš„ç›¸äº’å½±å“ éš”ç¦»æ€§è®©å¹¶å‘æƒ…å½¢ä¸‹çš„äº‹åŠ¡ä¹‹é—´äº’ä¸å¹²æ‰°ï¼š ä¸€ä¸ªäº‹åŠ¡çš„å†™æ“ä½œå¯¹å¦ä¸€ä¸ªäº‹åŠ¡çš„å†™æ“ä½œï¼ˆå†™å†™ï¼‰ï¼šé”æœºåˆ¶ä¿è¯éš”ç¦»æ€§ ä¸€ä¸ªäº‹åŠ¡çš„å†™æ“ä½œå¯¹å¦ä¸€ä¸ªäº‹åŠ¡çš„è¯»æ“ä½œï¼ˆè¯»å†™ï¼‰ï¼šMVCC ä¿è¯éš”ç¦»æ€§ é”æœºåˆ¶ï¼šäº‹åŠ¡åœ¨ä¿®æ”¹æ•°æ®ä¹‹å‰ï¼Œéœ€è¦å…ˆè·å¾—ç›¸åº”çš„é”ï¼Œè·å¾—é”ä¹‹åï¼Œäº‹åŠ¡ä¾¿å¯ä»¥ä¿®æ”¹æ•°æ®ï¼›è¯¥äº‹åŠ¡æ“ä½œæœŸé—´ï¼Œè¿™éƒ¨åˆ†æ•°æ®æ˜¯é”å®šçš„ï¼Œå…¶ä»–äº‹åŠ¡å¦‚æœéœ€è¦ä¿®æ”¹æ•°æ®ï¼Œéœ€è¦ç­‰å¾…å½“å‰äº‹åŠ¡æäº¤æˆ–å›æ»šåé‡Šæ”¾é”ï¼ˆè¯¦è§£è§é”æœºåˆ¶ï¼‰ å¹¶å‘æ§åˆ¶MVCC å…¨ç§° Multi-Version Concurrency Controlï¼Œå³å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼Œç”¨æ¥è§£å†³è¯»å†™å†²çªçš„æ— é”å¹¶å‘æ§åˆ¶ï¼Œå¯ä»¥åœ¨å‘ç”Ÿè¯»å†™è¯·æ±‚å†²çªæ—¶ä¸ç”¨åŠ é”è§£å†³ï¼Œè¿™ä¸ªè¯»æ˜¯æŒ‡çš„å¿«ç…§è¯»ï¼ˆä¹Ÿå«ä¸€è‡´æ€§è¯»æˆ–ä¸€è‡´æ€§æ— é”è¯»ï¼‰ï¼Œè€Œä¸æ˜¯å½“å‰è¯»ï¼š å¿«ç…§è¯»ï¼šå®ç°åŸºäº MVCCï¼Œå› ä¸ºæ˜¯å¤šç‰ˆæœ¬å¹¶å‘ï¼Œæ‰€ä»¥å¿«ç…§è¯»è¯»åˆ°çš„æ•°æ®ä¸ä¸€å®šæ˜¯å½“å‰æœ€æ–°çš„æ•°æ®ï¼Œæœ‰å¯èƒ½æ˜¯å†å²ç‰ˆæœ¬çš„æ•°æ® å½“å‰è¯»ï¼šåˆå«åŠ é”è¯»ï¼Œè¯»å–æ•°æ®åº“è®°å½•æ˜¯å½“å‰æœ€æ–°çš„ç‰ˆæœ¬ï¼ˆäº§ç”Ÿå¹»è¯»ã€ä¸å¯é‡å¤è¯»ï¼‰ï¼Œå¯ä»¥å¯¹è¯»å–çš„æ•°æ®è¿›è¡ŒåŠ é”ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡ä¿®æ”¹æ•°æ®ï¼Œæ˜¯æ‚²è§‚é”çš„ä¸€ç§æ“ä½œï¼Œè¯»å†™æ“ä½œåŠ å…±äº«é”æˆ–è€…æ’ä»–é”å’Œä¸²è¡ŒåŒ–äº‹åŠ¡çš„éš”ç¦»çº§åˆ«éƒ½æ˜¯å½“å‰è¯» æ•°æ®åº“å¹¶å‘åœºæ™¯ï¼š è¯»-è¯»ï¼šä¸å­˜åœ¨ä»»ä½•é—®é¢˜ï¼Œä¹Ÿä¸éœ€è¦å¹¶å‘æ§åˆ¶ è¯»-å†™ï¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¯èƒ½ä¼šé€ æˆäº‹åŠ¡éš”ç¦»æ€§é—®é¢˜ï¼Œå¯èƒ½é‡åˆ°è„è¯»ï¼Œå¹»è¯»ï¼Œä¸å¯é‡å¤è¯» å†™-å†™ï¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¯èƒ½ä¼šå­˜åœ¨è„å†™ï¼ˆä¸¢å¤±æ›´æ–°ï¼‰é—®é¢˜ MVCC çš„ä¼˜ç‚¹ï¼š åœ¨å¹¶å‘è¯»å†™æ•°æ®åº“æ—¶ï¼Œåšåˆ°åœ¨è¯»æ“ä½œæ—¶ä¸ç”¨é˜»å¡å†™æ“ä½œï¼Œå†™æ“ä½œä¹Ÿä¸ç”¨é˜»å¡è¯»æ“ä½œï¼Œæé«˜äº†å¹¶å‘è¯»å†™çš„æ€§èƒ½ å¯ä»¥è§£å†³è„è¯»ï¼Œä¸å¯é‡å¤è¯»ç­‰äº‹åŠ¡éš”ç¦»é—®é¢˜ï¼ˆåŠ é”ä¹Ÿèƒ½è§£å†³ï¼‰ï¼Œä½†ä¸èƒ½è§£å†³æ›´æ–°ä¸¢å¤±é—®é¢˜ï¼ˆå†™é”ä¼šè§£å†³ï¼‰ æé«˜è¯»å†™å’Œå†™å†™çš„å¹¶å‘æ€§èƒ½ï¼š MVCC + æ‚²è§‚é”ï¼šMVCC è§£å†³è¯»å†™å†²çªï¼Œæ‚²è§‚é”è§£å†³å†™å†™å†²çª MVCC + ä¹è§‚é”ï¼šMVCC è§£å†³è¯»å†™å†²çªï¼Œä¹è§‚é”è§£å†³å†™å†™å†²çª å‚è€ƒæ–‡ç« ï¼šhttps://www.jianshu.com/p/8845ddca3b23 å®ç°åŸç†éšè—å­—æ®µå®ç°åŸç†ä¸»è¦æ˜¯éšè—å­—æ®µï¼Œundoæ—¥å¿—ï¼ŒRead View æ¥å®ç°çš„ InnoDB å­˜å‚¨å¼•æ“ï¼Œæ•°æ®åº“ä¸­çš„èšç°‡ç´¢å¼•æ¯è¡Œæ•°æ®ï¼Œé™¤äº†è‡ªå®šä¹‰çš„å­—æ®µï¼Œè¿˜æœ‰æ•°æ®åº“éšå¼å®šä¹‰çš„å­—æ®µï¼š DB_TRX_IDï¼šæœ€è¿‘ä¿®æ”¹äº‹åŠ¡ IDï¼Œè®°å½•åˆ›å»ºè¯¥æ•°æ®æˆ–æœ€åä¸€æ¬¡ä¿®æ”¹è¯¥æ•°æ®çš„äº‹åŠ¡ ID DB_ROLL_PTRï¼šå›æ»šæŒ‡é’ˆï¼ŒæŒ‡å‘è®°å½•å¯¹åº”çš„ undo log æ—¥å¿—ï¼Œundo log ä¸­åˆæŒ‡å‘ä¸Šä¸€ä¸ªæ—§ç‰ˆæœ¬çš„ undo log DB_ROW_IDï¼šéšå«çš„è‡ªå¢ IDï¼ˆéšè—ä¸»é”®ï¼‰ï¼Œå¦‚æœæ•°æ®è¡¨æ²¡æœ‰ä¸»é”®ï¼ŒInnoDB ä¼šè‡ªåŠ¨ä»¥ DB_ROW_ID ä½œä¸ºèšç°‡ç´¢å¼• ç‰ˆæœ¬é“¾undo log æ˜¯é€»è¾‘æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯æ¯ä¸ªäº‹åŠ¡å¯¹æ•°æ®æ‰§è¡Œçš„æ“ä½œï¼Œè€Œä¸æ˜¯è®°å½•çš„å…¨éƒ¨æ•°æ®ï¼Œè¦æ ¹æ® undo log é€†æ¨å‡ºä»¥å¾€äº‹åŠ¡çš„æ•°æ® undo log çš„ä½œç”¨ï¼š ä¿è¯äº‹åŠ¡è¿›è¡Œ rollback æ—¶çš„åŸå­æ€§å’Œä¸€è‡´æ€§ï¼Œå½“äº‹åŠ¡è¿›è¡Œå›æ»šçš„æ—¶å€™å¯ä»¥ç”¨ undo log çš„æ•°æ®è¿›è¡Œæ¢å¤ ç”¨äº MVCC å¿«ç…§è¯»ï¼Œé€šè¿‡è¯»å– undo log çš„å†å²ç‰ˆæœ¬æ•°æ®å¯ä»¥å®ç°ä¸åŒäº‹åŠ¡ç‰ˆæœ¬å·éƒ½æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„å¿«ç…§æ•°æ® undo log ä¸»è¦åˆ†ä¸ºä¸¤ç§ï¼š insert undo logï¼šäº‹åŠ¡åœ¨ insert æ–°è®°å½•æ—¶äº§ç”Ÿçš„ undo logï¼Œåªåœ¨äº‹åŠ¡å›æ»šæ—¶éœ€è¦ï¼Œå¹¶ä¸”åœ¨äº‹åŠ¡æäº¤åå¯ä»¥è¢«ç«‹å³ä¸¢å¼ƒ update undo logï¼šäº‹åŠ¡åœ¨è¿›è¡Œ update æˆ– delete æ—¶äº§ç”Ÿçš„ undo logï¼Œåœ¨äº‹åŠ¡å›æ»šæ—¶éœ€è¦ï¼Œåœ¨å¿«ç…§è¯»æ—¶ä¹Ÿéœ€è¦ã€‚ä¸èƒ½éšæ„åˆ é™¤ï¼Œåªæœ‰åœ¨å½“å‰è¯»æˆ–äº‹åŠ¡å›æ»šä¸æ¶‰åŠè¯¥æ—¥å¿—æ—¶ï¼Œå¯¹åº”çš„æ—¥å¿—æ‰ä¼šè¢« purge çº¿ç¨‹ç»Ÿä¸€æ¸…é™¤ æ¯æ¬¡å¯¹æ•°æ®åº“è®°å½•è¿›è¡Œæ”¹åŠ¨ï¼Œéƒ½ä¼šäº§ç”Ÿçš„æ–°ç‰ˆæœ¬çš„ undo logï¼Œéšç€æ›´æ–°æ¬¡æ•°çš„å¢å¤šï¼Œæ‰€æœ‰çš„ç‰ˆæœ¬éƒ½ä¼šè¢« roll_pointer å±æ€§è¿æ¥æˆä¸€ä¸ªé“¾è¡¨ï¼ŒæŠŠè¿™ä¸ªé“¾è¡¨ç§°ä¹‹ä¸ºç‰ˆæœ¬é“¾ï¼Œç‰ˆæœ¬é“¾çš„å¤´èŠ‚ç‚¹å°±æ˜¯å½“å‰çš„æœ€æ–°çš„ undo logï¼Œé“¾å°¾å°±æ˜¯æœ€æ—©çš„æ—§ undo log è¯´æ˜ï¼šå› ä¸º DELETE åˆ é™¤è®°å½•ï¼Œéƒ½æ˜¯ç§»åŠ¨åˆ°åƒåœ¾é“¾è¡¨ä¸­ï¼Œä¸æ˜¯çœŸæ­£çš„åˆ é™¤ï¼Œæ‰€ä»¥æ‰å¯ä»¥é€šè¿‡ç‰ˆæœ¬é“¾è®¿é—®åŸå§‹æ•°æ® æ³¨æ„ï¼šundo æ˜¯é€»è¾‘æ—¥å¿—ï¼Œè¿™é‡Œåªæ˜¯ç›´è§‚çš„å±•ç¤ºå‡ºæ¥ å·¥ä½œæµç¨‹ï¼š æœ‰ä¸ªäº‹åŠ¡æ’å…¥ persion è¡¨ä¸€æ¡æ–°è®°å½•ï¼Œname ä¸º Jerryï¼Œage ä¸º 24 äº‹åŠ¡ 1 ä¿®æ”¹è¯¥è¡Œæ•°æ®æ—¶ï¼Œæ•°æ®åº“ä¼šå…ˆå¯¹è¯¥è¡ŒåŠ æ’ä»–é”ï¼Œç„¶åå…ˆè®°å½• undo logï¼Œç„¶åä¿®æ”¹è¯¥è¡Œ name ä¸º Tomï¼Œå¹¶ä¸”ä¿®æ”¹éšè—å­—æ®µçš„äº‹åŠ¡ ID ä¸ºå½“å‰äº‹åŠ¡ 1 çš„ IDï¼ˆé»˜è®¤ä¸º 1 ä¹‹åé€’å¢ï¼‰ï¼Œå›æ»šæŒ‡é’ˆæŒ‡å‘æ‹·è´åˆ° undo log çš„å‰¯æœ¬è®°å½•ï¼Œäº‹åŠ¡æäº¤åï¼Œé‡Šæ”¾é” ä»¥æ­¤ç±»æ¨ è¯»è§†å›¾Read View æ˜¯äº‹åŠ¡è¿›è¡Œè¯»æ•°æ®æ“ä½œæ—¶äº§ç”Ÿçš„è¯»è§†å›¾ï¼Œè¯¥äº‹åŠ¡æ‰§è¡Œå¿«ç…§è¯»çš„é‚£ä¸€åˆ»ä¼šç”Ÿæˆæ•°æ®åº“ç³»ç»Ÿå½“å‰çš„ä¸€ä¸ªå¿«ç…§ï¼Œè®°å½•å¹¶ç»´æŠ¤ç³»ç»Ÿå½“å‰æ´»è·ƒäº‹åŠ¡çš„ IDï¼Œç”¨æ¥åšå¯è§æ€§åˆ¤æ–­ï¼Œæ ¹æ®è§†å›¾åˆ¤æ–­å½“å‰äº‹åŠ¡èƒ½å¤Ÿçœ‹åˆ°å“ªä¸ªç‰ˆæœ¬çš„æ•°æ® æ³¨æ„ï¼šè¿™é‡Œçš„å¿«ç…§å¹¶ä¸æ˜¯æŠŠæ‰€æœ‰çš„æ•°æ®æ‹·è´ä¸€ä»½å‰¯æœ¬ï¼Œè€Œæ˜¯ç”± undo log è®°å½•çš„é€»è¾‘æ—¥å¿—ï¼Œæ ¹æ®åº“ä¸­çš„æ•°æ®è¿›è¡Œè®¡ç®—å‡ºå†å²æ•°æ® å·¥ä½œæµç¨‹ï¼šå°†ç‰ˆæœ¬é“¾çš„å¤´èŠ‚ç‚¹çš„äº‹åŠ¡ IDï¼ˆæœ€æ–°æ•°æ®äº‹åŠ¡ IDï¼Œå¤§æ¦‚ç‡ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼‰DB_TRX_ID å–å‡ºæ¥ï¼Œä¸ç³»ç»Ÿå½“å‰æ´»è·ƒäº‹åŠ¡çš„ ID å¯¹æ¯”è¿›è¡Œå¯è§æ€§åˆ†æï¼Œä¸å¯è§å°±é€šè¿‡ DB_ROLL_PTR å›æ»šæŒ‡é’ˆå»å–å‡º undo log ä¸­çš„ä¸‹ä¸€ä¸ª DB_TRX_ID æ¯”è¾ƒï¼Œç›´åˆ°æ‰¾åˆ°æœ€è¿‘çš„æ»¡è¶³å¯è§æ€§çš„ DB_TRX_IDï¼Œè¯¥äº‹åŠ¡ ID æ‰€åœ¨çš„æ—§è®°å½•å°±æ˜¯å½“å‰äº‹åŠ¡èƒ½çœ‹è§çš„æœ€æ–°çš„è®°å½• Read View å‡ ä¸ªå±æ€§ï¼š m_idsï¼šç”Ÿæˆ Read View æ—¶å½“å‰ç³»ç»Ÿä¸­æ´»è·ƒçš„äº‹åŠ¡ id åˆ—è¡¨ï¼ˆæœªæäº¤çš„äº‹åŠ¡é›†åˆï¼Œå½“å‰äº‹åŠ¡ä¹Ÿåœ¨å…¶ä¸­ï¼‰ min_trx_idï¼šç”Ÿæˆ Read View æ—¶å½“å‰ç³»ç»Ÿä¸­æ´»è·ƒçš„æœ€å°çš„äº‹åŠ¡ idï¼Œä¹Ÿå°±æ˜¯ m_ids ä¸­çš„æœ€å°å€¼ï¼ˆå·²æäº¤çš„äº‹åŠ¡é›†åˆï¼‰ max_trx_idï¼šç”Ÿæˆ Read View æ—¶å½“å‰ç³»ç»Ÿåº”è¯¥åˆ†é…ç»™ä¸‹ä¸€ä¸ªäº‹åŠ¡çš„ id å€¼ï¼Œm_ids ä¸­çš„æœ€å¤§å€¼åŠ  1ï¼ˆæœªå¼€å§‹äº‹åŠ¡ï¼‰ creator_trx_idï¼šç”Ÿæˆè¯¥ Read View çš„äº‹åŠ¡çš„äº‹åŠ¡ idï¼Œå°±æ˜¯åˆ¤æ–­è¯¥ id çš„äº‹åŠ¡èƒ½è¯»åˆ°ä»€ä¹ˆæ•°æ® creator åˆ›å»ºä¸€ä¸ª Read Viewï¼Œè¿›è¡Œå¯è§æ€§ç®—æ³•åˆ†æï¼šï¼ˆè§£å†³äº†è¯»æœªæäº¤ï¼‰ db_trx_id &#x3D;&#x3D; creator_trx_idï¼šè¡¨ç¤ºè¿™ä¸ªæ•°æ®å°±æ˜¯å½“å‰äº‹åŠ¡è‡ªå·±ç”Ÿæˆçš„ï¼Œè‡ªå·±ç”Ÿæˆçš„æ•°æ®è‡ªå·±è‚¯å®šèƒ½çœ‹è§ï¼Œæ‰€ä»¥æ­¤æ•°æ®å¯¹ creator æ˜¯å¯è§çš„ db_trx_id &lt; min_trx_idï¼šè¯¥ç‰ˆæœ¬å¯¹åº”çš„äº‹åŠ¡ ID å°äº Read view ä¸­çš„æœ€å°æ´»è·ƒäº‹åŠ¡ IDï¼Œåˆ™è¿™ä¸ªäº‹åŠ¡åœ¨å½“å‰äº‹åŠ¡ä¹‹å‰å°±å·²ç»è¢«æäº¤äº†ï¼Œå¯¹ creator å¯è§ï¼ˆå› ä¸ºæ¯”å·²æäº¤çš„æœ€å¤§äº‹åŠ¡ ID å°çš„å¹¶ä¸ä¸€å®šå·²ç»æäº¤ï¼Œæ‰€ä»¥åº”è¯¥åˆ¤æ–­æ˜¯å¦åœ¨æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ï¼‰ db_trx_id &gt;&#x3D; max_trx_idï¼šè¯¥ç‰ˆæœ¬å¯¹åº”çš„äº‹åŠ¡ ID å¤§äº Read view ä¸­å½“å‰ç³»ç»Ÿçš„æœ€å¤§äº‹åŠ¡ IDï¼Œåˆ™è¯´æ˜è¯¥æ•°æ®æ˜¯åœ¨å½“å‰ Read view åˆ›å»ºä¹‹åæ‰äº§ç”Ÿçš„ï¼Œå¯¹ creator ä¸å¯è§ min_trx_id&lt;&#x3D; db_trx_id &lt; max_trx_idï¼šåˆ¤æ–­ db_trx_id æ˜¯å¦åœ¨æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ m_ids ä¸­ åœ¨åˆ—è¡¨ä¸­ï¼Œè¯´æ˜è¯¥ç‰ˆæœ¬å¯¹åº”çš„äº‹åŠ¡æ­£åœ¨è¿è¡Œï¼Œæ•°æ®ä¸èƒ½æ˜¾ç¤ºï¼ˆä¸èƒ½è¯»åˆ°æœªæäº¤çš„æ•°æ®ï¼‰ ä¸åœ¨åˆ—è¡¨ä¸­ï¼Œè¯´æ˜è¯¥ç‰ˆæœ¬å¯¹åº”çš„äº‹åŠ¡å·²ç»è¢«æäº¤ï¼Œæ•°æ®å¯ä»¥æ˜¾ç¤ºï¼ˆå¯ä»¥è¯»åˆ°å·²ç»æäº¤çš„æ•°æ®ï¼‰ å·¥ä½œæµç¨‹è¡¨ user æ•°æ® 12id name age1 å¼ ä¸‰ 18 Transaction 20ï¼š 123START TRANSACTION; -- å¼€å¯äº‹åŠ¡UPDATE user SET name = &#x27;æå››&#x27; WHERE id = 1;UPDATE user SET name = &#x27;ç‹äº”&#x27; WHERE id = 1; Transaction 60ï¼š 12START TRANSACTION; -- å¼€å¯äº‹åŠ¡-- æ“ä½œè¡¨çš„å…¶ä»–æ•°æ® ID ä¸º 0 çš„äº‹åŠ¡åˆ›å»º Read Viewï¼š m_idsï¼š20ã€60 min_trx_idï¼š20 max_trx_idï¼š61 creator_trx_idï¼š0 åªæœ‰çº¢æ¡†éƒ¨åˆ†æ‰å¤åˆæ¡ä»¶ï¼Œæ‰€ä»¥åªæœ‰å¼ ä¸‰å¯¹åº”çš„ç‰ˆæœ¬çš„æ•°æ®å¯ä»¥è¢«çœ‹åˆ° å‚è€ƒè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV1t5411u7Fg äºŒçº§ç´¢å¼•åªæœ‰åœ¨èšç°‡ç´¢å¼•ä¸­æ‰æœ‰ trx_id å’Œ roll_pointer çš„éšè—åˆ—ï¼Œå¯¹äºäºŒçº§ç´¢å¼•åˆ¤æ–­å¯è§æ€§çš„æ–¹å¼ï¼š äºŒçº§ç´¢å¼•é¡µé¢çš„ Page Header ä¸­æœ‰ä¸€ä¸ª PAGE_MAX_TRX_ID å±æ€§ï¼Œä»£è¡¨ä¿®æ”¹å½“å‰é¡µé¢çš„æœ€å¤§çš„äº‹åŠ¡ IDï¼ŒSELECT è¯­å¥è®¿é—®æŸä¸ªäºŒçº§ç´¢å¼•æ—¶ä¼šåˆ¤æ–­ ReadView çš„ min_trx_id æ˜¯å¦å¤§äºè¯¥å±æ€§ï¼Œå¤§äºè¯´æ˜è¯¥é¡µé¢çš„æ‰€æœ‰å±æ€§å¯¹ ReadView å¯è§ å¦‚æœå±æ€§åˆ¤æ–­ä¸å¯è§ï¼Œå°±éœ€è¦åˆ©ç”¨äºŒçº§ç´¢å¼•è·å–ä¸»é”®å€¼è¿›è¡Œå›è¡¨æ“ä½œï¼Œå¾—åˆ°èšç°‡ç´¢å¼•åæŒ‰ç…§èšç°‡ç´¢å¼•çš„å¯è§æ€§åˆ¤æ–­çš„æ–¹æ³•æ“ä½œ RC RRRead View ç”¨äºæ”¯æŒ RCï¼ˆRead Committedï¼Œè¯»å·²æäº¤ï¼‰å’Œ RRï¼ˆRepeatable Readï¼Œå¯é‡å¤è¯»ï¼‰éš”ç¦»çº§åˆ«çš„å®ç°ï¼Œæ‰€ä»¥ SELECT åœ¨ RC å’Œ RR éš”ç¦»çº§åˆ«ä½¿ç”¨ MVCC è¯»å–è®°å½• RRã€RC ç”Ÿæˆæ—¶æœºï¼š RC éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ¯æ¬¡è¯»å–æ•°æ®å‰éƒ½ä¼šç”Ÿæˆæœ€æ–°çš„ Read Viewï¼ˆå½“å‰è¯»ï¼‰ RR éš”ç¦»çº§åˆ«ä¸‹ï¼Œåœ¨ç¬¬ä¸€æ¬¡æ•°æ®è¯»å–æ—¶æ‰ä¼šåˆ›å»º Read Viewï¼ˆå¿«ç…§è¯»ï¼‰ RCã€RR çº§åˆ«ä¸‹çš„ InnoDB å¿«ç…§è¯»åŒºåˆ« RC çº§åˆ«ä¸‹ï¼Œäº‹åŠ¡ä¸­æ¯æ¬¡å¿«ç…§è¯»éƒ½ä¼šæ–°ç”Ÿæˆä¸€ä¸ª Read Viewï¼Œè¿™å°±æ˜¯åœ¨ RC çº§åˆ«ä¸‹çš„äº‹åŠ¡ä¸­å¯ä»¥çœ‹åˆ°åˆ«çš„äº‹åŠ¡æäº¤çš„æ›´æ–°çš„åŸå›  RR çº§åˆ«ä¸‹ï¼ŒæŸä¸ªäº‹åŠ¡çš„å¯¹æŸæ¡è®°å½•çš„ç¬¬ä¸€æ¬¡å¿«ç…§è¯»ä¼šåˆ›å»ºä¸€ä¸ª Read Viewï¼Œ å°†å½“å‰ç³»ç»Ÿæ´»è·ƒçš„å…¶ä»–äº‹åŠ¡è®°å½•èµ·æ¥ï¼Œæ­¤ååœ¨è°ƒç”¨å¿«ç…§è¯»çš„æ—¶å€™ï¼Œä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ª Read Viewï¼Œæ‰€ä»¥ä¸€ä¸ªäº‹åŠ¡çš„æŸ¥è¯¢ç»“æœæ¯æ¬¡éƒ½æ˜¯ç›¸åŒçš„ RR çº§åˆ«ä¸‹ï¼Œé€šè¿‡ START TRANSACTION WITH CONSISTENT SNAPSHOT å¼€å¯äº‹åŠ¡ï¼Œä¼šåœ¨æ‰§è¡Œè¯¥è¯­å¥åç«‹åˆ»ç”Ÿæˆä¸€ä¸ª Read Viewï¼Œä¸æ˜¯åœ¨æ‰§è¡Œç¬¬ä¸€æ¡ SELECT è¯­å¥æ—¶ç”Ÿæˆï¼ˆæ‰€ä»¥è¯´ START TRANSACTION å¹¶ä¸æ˜¯äº‹åŠ¡çš„èµ·ç‚¹ï¼Œæ‰§è¡Œç¬¬ä¸€æ¡è¯­å¥æ‰ç®—èµ·ç‚¹ï¼‰ è§£å†³å¹»è¯»é—®é¢˜ï¼š å¿«ç…§è¯»ï¼šé€šè¿‡ MVCC æ¥è¿›è¡Œæ§åˆ¶çš„ï¼Œåœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ™®é€šæŸ¥è¯¢æ˜¯å¿«ç…§è¯»ï¼Œæ˜¯ä¸ä¼šçœ‹åˆ°åˆ«çš„äº‹åŠ¡æ’å…¥çš„æ•°æ®çš„ï¼Œä½†æ˜¯å¹¶ä¸èƒ½å®Œå…¨é¿å…å¹»è¯» åœºæ™¯ï¼šRR çº§åˆ«ï¼ŒT1 äº‹åŠ¡å¼€å¯ï¼Œåˆ›å»º Read Viewï¼Œæ­¤æ—¶ T2 å» INSERT æ–°çš„ä¸€è¡Œç„¶åæäº¤ï¼Œç„¶å T1 å» UPDATE è¯¥è¡Œä¼šå‘ç°æ›´æ–°æˆåŠŸï¼Œå¹¶ä¸”æŠŠè¿™æ¡æ–°è®°å½•çš„ trx_id å˜ä¸ºå½“å‰çš„äº‹åŠ¡ idï¼Œæ‰€ä»¥å¯¹å½“å‰äº‹åŠ¡å°±æ˜¯å¯è§çš„ã€‚å› ä¸º Read View å¹¶ä¸èƒ½é˜»æ­¢äº‹åŠ¡å»æ›´æ–°æ•°æ®ï¼Œæ›´æ–°æ•°æ®éƒ½æ˜¯å…ˆè¯»åå†™å¹¶ä¸”æ˜¯å½“å‰è¯»ï¼Œè¯»å–åˆ°çš„æ˜¯æœ€æ–°ç‰ˆæœ¬çš„æ•°æ® å½“å‰è¯»ï¼šé€šè¿‡ next-key é”ï¼ˆè¡Œé” + é—´éš™é”ï¼‰æ¥è§£å†³é—®é¢˜ æŒä¹…ç‰¹æ€§å®ç°æ–¹å¼æŒä¹…æ€§æ˜¯æŒ‡ä¸€ä¸ªäº‹åŠ¡ä¸€æ—¦è¢«æäº¤äº†ï¼Œé‚£ä¹ˆå¯¹æ•°æ®åº“ä¸­æ•°æ®çš„æ”¹å˜å°±æ˜¯æ°¸ä¹…æ€§çš„ï¼Œæ¥ä¸‹æ¥çš„å…¶ä»–æ“ä½œæˆ–æ•…éšœä¸åº”è¯¥å¯¹å…¶æœ‰ä»»ä½•å½±å“ã€‚ Buffer Pool çš„ä½¿ç”¨æé«˜äº†è¯»å†™æ•°æ®çš„æ•ˆç‡ï¼Œä½†æ˜¯å¦‚æœ MySQL å®•æœºï¼Œæ­¤æ—¶ Buffer Pool ä¸­ä¿®æ”¹çš„æ•°æ®è¿˜æ²¡æœ‰åˆ·æ–°åˆ°ç£ç›˜ï¼Œå°±ä¼šå¯¼è‡´æ•°æ®çš„ä¸¢å¤±ï¼Œäº‹åŠ¡çš„æŒä¹…æ€§æ— æ³•ä¿è¯ï¼Œæ‰€ä»¥å¼•å…¥äº† redo log æ—¥å¿—ï¼š redo log è®°å½•æ•°æ®é¡µçš„ç‰©ç†ä¿®æ”¹ï¼Œè€Œä¸æ˜¯æŸä¸€è¡Œæˆ–æŸå‡ è¡Œçš„ä¿®æ”¹ï¼Œç”¨æ¥æ¢å¤æäº¤åçš„æ•°æ®é¡µï¼Œåªèƒ½æ¢å¤åˆ°æœ€åä¸€æ¬¡æäº¤çš„ä½ç½® redo log é‡‡ç”¨çš„æ˜¯ WALï¼ˆWrite-ahead loggingï¼Œé¢„å†™å¼æ—¥å¿—ï¼‰ï¼Œæ‰€æœ‰ä¿®æ”¹è¦å…ˆå†™å…¥æ—¥å¿—ï¼Œå†æ›´æ–°åˆ°ç£ç›˜ï¼Œä¿è¯äº†æ•°æ®ä¸ä¼šå›  MySQL å®•æœºè€Œä¸¢å¤±ï¼Œä»è€Œæ»¡è¶³äº†æŒä¹…æ€§è¦æ±‚ ç®€å•çš„ redo log æ˜¯çº¯ç²¹çš„ç‰©ç†æ—¥å¿—ï¼Œå¤æ‚çš„ redo log ä¼šå­˜åœ¨ç‰©ç†æ—¥å¿—å’Œé€»è¾‘æ—¥å¿— å·¥ä½œè¿‡ç¨‹ï¼šMySQL å‘ç”Ÿäº†å®•æœºï¼ŒInnoDB ä¼šåˆ¤æ–­ä¸€ä¸ªæ•°æ®é¡µåœ¨å´©æºƒæ¢å¤æ—¶ä¸¢å¤±äº†æ›´æ–°ï¼Œå°±ä¼šå°†å®ƒè¯»åˆ°å†…å­˜ï¼Œç„¶åæ ¹æ® redo log å†…å®¹æ›´æ–°å†…å­˜ï¼Œæ›´æ–°å®Œæˆåï¼Œå†…å­˜é¡µå˜æˆè„é¡µï¼Œç„¶åè¿›è¡Œåˆ·è„ ç¼“å†²æ± çš„åˆ·è„ç­–ç•¥ï¼š redo log æ–‡ä»¶æ˜¯å›ºå®šå¤§å°çš„ï¼Œå¦‚æœå†™æ»¡äº†å°±è¦æ“¦é™¤ä»¥å‰çš„è®°å½•ï¼Œåœ¨æ“¦é™¤ä¹‹å‰éœ€è¦æŠŠå¯¹åº”çš„æ›´æ–°æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ Buffer Pool å†…å­˜ä¸è¶³ï¼Œéœ€è¦æ·˜æ±°éƒ¨åˆ†æ•°æ®é¡µï¼ˆLRU é“¾è¡¨å°¾éƒ¨ï¼‰ï¼Œå¦‚æœæ·˜æ±°çš„æ˜¯è„é¡µï¼Œå°±è¦å…ˆå°†è„é¡µå†™åˆ°ç£ç›˜ï¼ˆè¦é¿å…å¤§äº‹åŠ¡ï¼‰ ç³»ç»Ÿç©ºé—²æ—¶ï¼Œåå°çº¿ç¨‹ä¼šè‡ªåŠ¨è¿›è¡Œåˆ·è„ï¼ˆFlush é“¾è¡¨éƒ¨åˆ†å·²ç»è¯¦è§£ï¼‰ MySQL æ­£å¸¸å…³é—­æ—¶ï¼Œä¼šæŠŠå†…å­˜çš„è„é¡µéƒ½åˆ·æ–°åˆ°ç£ç›˜ä¸Š é‡åšæ—¥å¿—æ—¥å¿—ç¼“å†²æœåŠ¡å™¨å¯åŠ¨æ—¶ä¼šå‘æ“ä½œç³»ç»Ÿç”³è¯·ä¸€ç‰‡è¿ç»­å†…å­˜ç©ºé—´ä½œä¸º redo log bufferï¼ˆé‡åšæ—¥å¿—ç¼“å†²åŒºï¼‰ï¼Œå¯ä»¥é€šè¿‡ innodb_log_buffer_size ç³»ç»Ÿå˜é‡æŒ‡å®š redo log buffer çš„å¤§å°ï¼Œé»˜è®¤æ˜¯ 16MB log buffer è¢«åˆ’åˆ†ä¸ºè‹¥å¹² redo log blockï¼ˆå—ï¼Œç±»ä¼¼æ•°æ®é¡µçš„æ¦‚å¿µï¼‰ï¼Œæ¯ä¸ªé»˜è®¤å¤§å° 512 å­—èŠ‚ï¼Œæ¯ä¸ª block ç”± 12 å­—èŠ‚çš„ log block headã€496 å­—èŠ‚çš„ log block bodyã€4 å­—èŠ‚çš„ log block trailer ç»„æˆ å½“æ•°æ®ä¿®æ”¹æ—¶ï¼Œå…ˆä¿®æ”¹ Change Buffer ä¸­çš„æ•°æ®ï¼Œç„¶ååœ¨ redo log buffer è®°å½•è¿™æ¬¡æ“ä½œï¼Œå†™å…¥ log buffer çš„è¿‡ç¨‹æ˜¯é¡ºåºå†™å…¥çš„ï¼ˆå…ˆå†™å…¥å‰é¢çš„ blockï¼Œå†™æ»¡åç»§ç»­å†™ä¸‹ä¸€ä¸ªï¼‰ log buffer ä¸­æœ‰ä¸€ä¸ªæŒ‡é’ˆ buf_freeï¼Œæ¥æ ‡è¯†è¯¥ä½ç½®ä¹‹å‰éƒ½æ˜¯å¡«æ»¡çš„ blockï¼Œè¯¥ä½ç½®ä¹‹åéƒ½æ˜¯ç©ºé—²åŒºåŸŸ MySQL è§„å®šå¯¹åº•å±‚é¡µé¢çš„ä¸€æ¬¡åŸå­è®¿é—®ç§°ä¸ºä¸€ä¸ª Mini-Transactionï¼ˆMTRï¼‰ï¼Œæ¯”å¦‚åœ¨ B+ æ ‘ä¸Šæ’å…¥ä¸€æ¡æ•°æ®å°±ç®—ä¸€ä¸ª MTR ä¸€ä¸ªäº‹åŠ¡åŒ…å«è‹¥å¹²ä¸ª MTRï¼Œä¸€ä¸ª MTR å¯¹åº”ä¸€ç»„è‹¥å¹²æ¡ redo logï¼Œä¸€ç»„ redo log æ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œåœ¨è¿›è¡Œæ•°æ®æ¢å¤æ—¶ä¹ŸæŠŠä¸€ç»„ redo log å½“ä½œä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ•´ä½“å¤„ç† ä¸æ˜¯æ¯ç”Ÿæˆä¸€æ¡ redo æ—¥å¿—å°±å°†å…¶æ’å…¥åˆ° log buffer ä¸­ï¼Œè€Œæ˜¯ä¸€ä¸ª MTR ç»“æŸåå°†ä¸€ç»„ redo æ—¥å¿—å†™å…¥ InnoDB çš„ redo log æ˜¯å›ºå®šå¤§å°çš„ï¼Œredo æ—¥å¿—åœ¨ç£ç›˜ä¸­ä»¥æ–‡ä»¶ç»„çš„å½¢å¼å­˜å‚¨ï¼ŒåŒä¸€ç»„ä¸­çš„æ¯ä¸ªæ–‡ä»¶å¤§å°ä¸€æ ·æ ¼å¼ä¸€æ · innodb_log_group_home_dir ä»£è¡¨ç£ç›˜å­˜å‚¨ redo log çš„æ–‡ä»¶ç›®å½•ï¼Œé»˜è®¤æ˜¯å½“å‰æ•°æ®ç›®å½• innodb_log_file_size ä»£è¡¨æ–‡ä»¶å¤§å°ï¼Œé»˜è®¤ 48Mï¼Œinnodb_log_files_in_group ä»£è¡¨æ–‡ä»¶ä¸ªæ•°ï¼Œé»˜è®¤ 2 æœ€å¤§ 100ï¼Œæ‰€ä»¥æ—¥å¿—çš„æ–‡ä»¶å¤§å°ä¸º innodb_log_file_size * innodb_log_files_in_group redo æ—¥å¿—æ–‡ä»¶ä¹Ÿæ˜¯ç”±è‹¥å¹²ä¸ª 512 å­—èŠ‚çš„ block ç»„æˆï¼Œæ—¥å¿—æ–‡ä»¶çš„å‰ 2048 ä¸ªå­—èŠ‚ï¼ˆå‰ 4 ä¸ª blockï¼‰ç”¨æ¥å­˜å‚¨ä¸€äº›ç®¡ç†ä¿¡æ¯ï¼Œä»¥åçš„ç”¨æ¥å­˜å‚¨ log buffer ä¸­çš„ block é•œåƒ æ³¨æ„ï¼šblock å¹¶ä¸ä»£è¡¨ä¸€ç»„ redo logï¼Œä¸€ç»„æ—¥å¿—å¯èƒ½å ç”¨ä¸åˆ°ä¸€ä¸ª block æˆ–è€…å‡ ä¸ª blockï¼Œä¾èµ–äº MTR çš„å¤§å° æ—¥å¿—åˆ·ç›˜redo log éœ€è¦åœ¨äº‹åŠ¡æäº¤æ—¶å°†æ—¥å¿—å†™å…¥ç£ç›˜ï¼Œä½†æ˜¯æ¯” Buffer Pool ä¿®æ”¹çš„æ•°æ®å†™å…¥ç£ç›˜çš„é€Ÿåº¦å¿«ï¼ŒåŸå› ï¼š åˆ·è„æ˜¯éšæœº IOï¼Œå› ä¸ºæ¯æ¬¡ä¿®æ”¹çš„æ•°æ®ä½ç½®éšæœºï¼›redo log å’Œ binlog éƒ½æ˜¯é¡ºåºå†™ï¼Œç£ç›˜çš„é¡ºåº IO æ¯”éšæœº IO é€Ÿåº¦è¦å¿« åˆ·è„æ˜¯ä»¥æ•°æ®é¡µï¼ˆPageï¼‰ä¸ºå•ä½çš„ï¼Œä¸€ä¸ªé¡µä¸Šçš„ä¸€ä¸ªå°ä¿®æ”¹éƒ½è¦æ•´é¡µå†™å…¥ï¼›redo log ä¸­åªåŒ…å«çœŸæ­£éœ€è¦å†™å…¥çš„éƒ¨åˆ†ï¼Œå¥½å‡ é¡µçš„æ•°æ®ä¿®æ”¹å¯èƒ½åªè®°å½•åœ¨ä¸€ä¸ª redo log é¡µä¸­ï¼Œå‡å°‘æ— æ•ˆ IO ç»„æäº¤æœºåˆ¶ï¼Œå¯ä»¥å¤§å¹…åº¦é™ä½ç£ç›˜çš„ IO æ¶ˆè€— InnoDB å¼•æ“ä¼šåœ¨é€‚å½“çš„æ—¶å€™ï¼ŒæŠŠå†…å­˜ä¸­ redo log buffer æŒä¹…åŒ–ï¼ˆfsyncï¼‰åˆ°ç£ç›˜ï¼Œå…·ä½“çš„åˆ·ç›˜ç­–ç•¥ï¼š åœ¨äº‹åŠ¡æäº¤æ—¶éœ€è¦è¿›è¡Œåˆ·ç›˜ï¼Œé€šè¿‡ä¿®æ”¹å‚æ•° innodb_flush_log_at_trx_commit è®¾ç½®ï¼š 0ï¼šè¡¨ç¤ºå½“æäº¤äº‹åŠ¡æ—¶ï¼Œå¹¶ä¸å°†ç¼“å†²åŒºçš„ redo æ—¥å¿—å†™å…¥ç£ç›˜ï¼Œè€Œæ˜¯ç­‰å¾…åå°çº¿ç¨‹æ¯ç§’åˆ·æ–°ä¸€æ¬¡ 1ï¼šåœ¨äº‹åŠ¡æäº¤æ—¶å°†ç¼“å†²åŒºçš„ redo æ—¥å¿—åŒæ­¥å†™å…¥åˆ°ç£ç›˜ï¼Œä¿è¯ä¸€å®šä¼šå†™å…¥æˆåŠŸï¼ˆé»˜è®¤å€¼ï¼‰ 2ï¼šåœ¨äº‹åŠ¡æäº¤æ—¶å°†ç¼“å†²åŒºçš„ redo æ—¥å¿—å¼‚æ­¥å†™å…¥åˆ°ç£ç›˜ï¼Œä¸èƒ½ä¿è¯æäº¤æ—¶è‚¯å®šä¼šå†™å…¥ï¼Œåªæ˜¯æœ‰è¿™ä¸ªåŠ¨ä½œã€‚æ—¥å¿—å·²ç»åœ¨æ“ä½œç³»ç»Ÿçš„ç¼“å­˜ï¼Œå¦‚æœæ“ä½œç³»ç»Ÿæ²¡æœ‰å®•æœºè€Œ MySQL å®•æœºï¼Œä¹Ÿæ˜¯å¯ä»¥æ¢å¤æ•°æ®çš„ å†™å…¥ redo log buffer çš„æ—¥å¿—è¶…è¿‡äº†æ€»å®¹é‡çš„ä¸€åŠï¼Œå°±ä¼šå°†æ—¥å¿—åˆ·å…¥åˆ°ç£ç›˜æ–‡ä»¶ï¼Œè¿™ä¼šå½±å“æ‰§è¡Œæ•ˆç‡ï¼Œæ‰€ä»¥å¼€å‘ä¸­åº”é¿å…å¤§äº‹åŠ¡ æœåŠ¡å™¨å…³é—­æ—¶ å¹¶è¡Œçš„äº‹åŠ¡æäº¤ï¼ˆç»„æäº¤ï¼‰æ—¶ï¼Œä¼šå°†å°†å…¶ä»–äº‹åŠ¡çš„ redo log æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚å‡è®¾äº‹åŠ¡ A å·²ç»å†™å…¥ redo log buffer ä¸­ï¼Œè¿™æ—¶å¦å¤–ä¸€ä¸ªçº¿ç¨‹çš„äº‹åŠ¡ B æäº¤ï¼Œå¦‚æœ innodb_flush_log_at_trx_commit è®¾ç½®çš„æ˜¯ 1ï¼Œé‚£ä¹ˆäº‹åŠ¡ B è¦æŠŠ redo log buffer é‡Œçš„æ—¥å¿—å…¨éƒ¨æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œå› ä¸ºå¤šä¸ªäº‹åŠ¡å…±ç”¨ä¸€ä¸ª redo log bufferï¼Œæ‰€ä»¥ä¸€æ¬¡ fsync å¯ä»¥åˆ·ç›˜å¤šä¸ªäº‹åŠ¡çš„ redo logï¼Œæå‡äº†å¹¶å‘é‡ æœåŠ¡å™¨å¯åŠ¨å redo ç£ç›˜ç©ºé—´ä¸å˜ï¼Œæ‰€ä»¥ redo ç£ç›˜ä¸­çš„æ—¥å¿—æ–‡ä»¶æ˜¯è¢«å¾ªç¯ä½¿ç”¨çš„ï¼Œé‡‡ç”¨å¾ªç¯å†™æ•°æ®çš„æ–¹å¼ï¼Œå†™å®Œå°¾éƒ¨é‡æ–°å†™å¤´éƒ¨ï¼Œæ‰€ä»¥è¦ç¡®ä¿å¤´éƒ¨ log å¯¹åº”çš„ä¿®æ”¹å·²ç»æŒä¹…åŒ–åˆ°ç£ç›˜ æ—¥å¿—åºå·lsn (log sequence number) ä»£è¡¨å·²ç»å†™å…¥çš„ redo æ—¥å¿—é‡ã€flushed_to_disk_lsn æŒ‡åˆ·æ–°åˆ°ç£ç›˜ä¸­çš„ redo æ—¥å¿—é‡ï¼Œä¸¤è€…éƒ½æ˜¯å…¨å±€å˜é‡ï¼Œå¦‚æœä¸¤è€…çš„å€¼ç›¸åŒï¼Œè¯´æ˜ log buffer ä¸­æ‰€æœ‰çš„ redo æ—¥å¿—éƒ½å·²ç»æŒä¹…åŒ–åˆ°ç£ç›˜ å·¥ä½œè¿‡ç¨‹ï¼šå†™å…¥ log buffer æ•°æ®æ—¶ï¼Œbuf_free ä¼šè¿›è¡Œåç§»ï¼Œåç§»é‡å°±ä¼šåŠ åˆ° lsn ä¸Š MTR çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ä¿®æ”¹è¿‡çš„é¡µå¯¹åº”çš„æ§åˆ¶å—ä¼šåŠ åˆ° Buffer Pool çš„ flush é“¾è¡¨ä¸­ï¼Œé“¾è¡¨ä¸­è„é¡µæ˜¯æŒ‰ç…§ç¬¬ä¸€æ¬¡ä¿®æ”¹çš„æ—¶é—´è¿›è¡Œæ’åºçš„ï¼ˆå¤´æ’ï¼‰ï¼Œæ§åˆ¶å—ä¸­æœ‰ä¸¤ä¸ªæŒ‡é’ˆç”¨æ¥è®°å½•è„é¡µè¢«ä¿®æ”¹çš„æ—¶é—´ï¼š oldest_modificationï¼šç¬¬ä¸€æ¬¡ä¿®æ”¹ Buffer Pool ä¸­æŸä¸ªç¼“å†²é¡µæ—¶ï¼Œå°†ä¿®æ”¹è¯¥é¡µçš„ MTR å¼€å§‹æ—¶å¯¹åº”çš„ lsn å€¼å†™å…¥è¿™ä¸ªå±æ€§ newest_modificationï¼šæ¯æ¬¡ä¿®æ”¹é¡µé¢ï¼Œéƒ½å°† MTR ç»“æŸæ—¶å…¨å±€çš„ lsn å€¼å†™å…¥è¿™ä¸ªå±æ€§ï¼Œæ‰€ä»¥è¯¥å€¼æ˜¯è¯¥é¡µé¢æœ€åä¸€æ¬¡ä¿®æ”¹åçš„ lsn å€¼ å…¨å±€å˜é‡ checkpoint_lsn è¡¨ç¤ºå½“å‰ç³»ç»Ÿå¯ä»¥è¢«è¦†ç›–çš„ redo æ—¥å¿—æ€»é‡ï¼Œå½“ redo æ—¥å¿—å¯¹åº”çš„è„é¡µå·²ç»è¢«åˆ·æ–°åˆ°ç£ç›˜åï¼Œè¯¥æ–‡ä»¶ç©ºé—´å°±å¯ä»¥è¢«è¦†ç›–é‡ç”¨ï¼Œæ­¤æ—¶æ‰§è¡Œä¸€æ¬¡ checkpoint æ¥æ›´æ–° checkpoint_lsn çš„å€¼å­˜å…¥ç®¡ç†ä¿¡æ¯ï¼ˆåˆ·è„å’Œæ‰§è¡Œä¸€æ¬¡ checkpoint å¹¶ä¸æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼‰ï¼Œè¯¥å€¼çš„å¢é‡å°±ä»£è¡¨ç£ç›˜æ–‡ä»¶ä¸­å½“å‰ä½ç½®å‘åå¯ä»¥è¢«è¦†ç›–çš„æ–‡ä»¶çš„é‡ï¼Œæ‰€ä»¥è¯¥å€¼æ˜¯ä¸€ç›´å¢å¤§çš„ checkpointï¼šä» flush é“¾è¡¨å°¾éƒ¨ä¸­æ‰¾å‡ºè¿˜æœªåˆ·è„çš„é¡µé¢ï¼Œè¯¥é¡µé¢æ˜¯å½“å‰ç³»ç»Ÿä¸­æœ€æ—©è¢«ä¿®æ”¹çš„è„é¡µï¼Œè¯¥é¡µé¢ä¹‹å‰äº§ç”Ÿçš„è„é¡µéƒ½å·²ç»åˆ·è„ï¼Œç„¶åå°†è¯¥é¡µ oldest_modification å€¼èµ‹å€¼ç»™ checkpoint_lsnï¼Œå› ä¸º lsn å°äºè¯¥å€¼æ—¶äº§ç”Ÿçš„ redo æ—¥å¿—éƒ½å¯ä»¥è¢«è¦†ç›–äº† ä½†æ˜¯åœ¨ç³»ç»Ÿå¿™ç¢Œæ—¶ï¼Œåå°çº¿ç¨‹çš„åˆ·è„æ“ä½œä¸èƒ½å°†è„é¡µå¿«é€Ÿåˆ·å‡ºï¼Œå¯¼è‡´ç³»ç»Ÿæ— æ³•åŠæ—¶æ‰§è¡Œ checkpoint ï¼Œè¿™æ—¶éœ€è¦ç”¨æˆ·çº¿ç¨‹ä» flush é“¾è¡¨ä¸­æŠŠæœ€æ—©ä¿®æ”¹çš„è„é¡µåˆ·æ–°åˆ°ç£ç›˜ä¸­ï¼Œç„¶åæ‰§è¡Œ checkpoint 1write pos ------- checkpoint_lsn // ä¸¤å€¼ä¹‹é—´çš„éƒ¨åˆ†è¡¨ç¤ºå¯ä»¥å†™å…¥çš„æ—¥å¿—é‡ï¼Œå½“ pos è¿½èµ¶ä¸Š lsn æ—¶å¿…é¡»æ‰§è¡Œ checkpoint ä½¿ç”¨å‘½ä»¤å¯ä»¥æŸ¥çœ‹å½“å‰ InnoDB å­˜å‚¨å¼•æ“å„ç§ lsn çš„å€¼ï¼š 1SHOW ENGINE INNODB STATUS\\G å´©æºƒæ¢å¤æ¢å¤çš„èµ·ç‚¹ï¼šåœ¨ä» redo æ—¥å¿—æ–‡ä»¶ç»„çš„ç®¡ç†ä¿¡æ¯ä¸­è·å–æœ€è¿‘å‘ç”Ÿ checkpoint çš„ä¿¡æ¯ï¼Œä» checkpoint_lsn å¯¹åº”çš„æ—¥å¿—æ–‡ä»¶å¼€å§‹æ¢å¤ æ¢å¤çš„ç»ˆç‚¹ï¼šæ‰«ææ—¥å¿—æ–‡ä»¶çš„ blockï¼Œblock çš„å¤´éƒ¨è®°å½•ç€å½“å‰ block ä½¿ç”¨äº†å¤šå°‘å­—èŠ‚ï¼Œå¡«æ»¡çš„ block æ€»æ˜¯ 512 å­—èŠ‚ï¼Œ å¦‚æœæŸä¸ª block ä¸æ˜¯ 512 å­—èŠ‚ï¼Œè¯´æ˜è¯¥ block å°±æ˜¯éœ€è¦æ¢å¤çš„æœ€åä¸€ä¸ª block æ¢å¤çš„è¿‡ç¨‹ï¼šæŒ‰ç…§ redo log ä¾æ¬¡æ‰§è¡Œæ¢å¤æ•°æ®ï¼Œä¼˜åŒ–æ–¹å¼ ä½¿ç”¨å“ˆå¸Œè¡¨ï¼šæ ¹æ® redo log çš„ space id å’Œ page number å±æ€§è®¡ç®—å‡ºå“ˆå¸Œå€¼ï¼Œå°†å¯¹åŒä¸€é¡µé¢çš„ä¿®æ”¹æ”¾å…¥åŒä¸€ä¸ªæ§½é‡Œï¼Œå¯ä»¥ä¸€æ¬¡æ€§å®Œæˆå¯¹æŸé¡µçš„æ¢å¤ï¼Œé¿å…äº†éšæœº IO è·³è¿‡å·²ç»åˆ·æ–°åˆ°ç£ç›˜ä¸­çš„é¡µé¢ï¼šæ•°æ®é¡µçš„ File Header ä¸­çš„ FILE_PAGE_LSN å±æ€§ï¼ˆç±»ä¼¼ newest_modificationï¼‰è¡¨ç¤ºæœ€è¿‘ä¸€æ¬¡ä¿®æ”¹é¡µé¢æ—¶çš„ lsn å€¼ï¼Œæ•°æ®é¡µè¢«åˆ·æ–°åˆ°ç£ç›˜ä¸­ï¼Œé‚£ä¹ˆè¯¥é¡µ lsn å±æ€§è‚¯å®šå¤§äº checkpoint_lsn å‚è€ƒä¹¦ç±ï¼šhttps://book.douban.com/subject/35231266/ å·¥ä½œæµç¨‹æ—¥å¿—å¯¹æ¯”MySQL ä¸­è¿˜å­˜åœ¨ binlogï¼ˆäºŒè¿›åˆ¶æ—¥å¿—ï¼‰ä¹Ÿå¯ä»¥è®°å½•å†™æ“ä½œå¹¶ç”¨äºæ•°æ®çš„æ¢å¤ï¼Œä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼ŒäºŒè€…çš„åŒºåˆ«æ˜¯ï¼š ä½œç”¨ä¸åŒï¼šredo log æ˜¯ç”¨äº crash recovery ï¼ˆæ•…éšœæ¢å¤ï¼‰ï¼Œä¿è¯ MySQL å®•æœºä¹Ÿä¸ä¼šå½±å“æŒä¹…æ€§ï¼›binlog æ˜¯ç”¨äº point-in-time recovery çš„ï¼Œä¿è¯æœåŠ¡å™¨å¯ä»¥åŸºäºæ—¶é—´ç‚¹æ¢å¤æ•°æ®ï¼Œæ­¤å¤– binlog è¿˜ç”¨äºä¸»ä»å¤åˆ¶ å±‚æ¬¡ä¸åŒï¼šredo log æ˜¯ InnoDB å­˜å‚¨å¼•æ“å®ç°çš„ï¼Œè€Œ binlog æ˜¯MySQLçš„ Server å±‚å®ç°çš„ï¼ŒåŒæ—¶æ”¯æŒ InnoDB å’Œå…¶ä»–å­˜å‚¨å¼•æ“ å†…å®¹ä¸åŒï¼šredo log æ˜¯ç‰©ç†æ—¥å¿—ï¼Œå†…å®¹åŸºäºç£ç›˜çš„ Pageï¼›binlog çš„å†…å®¹æ˜¯äºŒè¿›åˆ¶çš„ï¼Œæ ¹æ® binlog_format å‚æ•°çš„ä¸åŒï¼Œå¯èƒ½åŸºäºSQL è¯­å¥ã€åŸºäºæ•°æ®æœ¬èº«æˆ–è€…äºŒè€…çš„æ··åˆï¼ˆæ—¥å¿—éƒ¨åˆ†è¯¦è§£ï¼‰ å†™å…¥æ—¶æœºä¸åŒï¼šbinlog åœ¨äº‹åŠ¡æäº¤æ—¶ä¸€æ¬¡å†™å…¥ï¼›redo log çš„å†™å…¥æ—¶æœºç›¸å¯¹å¤šå…ƒ binlog ä¸ºä»€ä¹ˆä¸æ”¯æŒå´©æºƒæ¢å¤ï¼Ÿ binlog è®°å½•çš„æ˜¯è¯­å¥ï¼Œå¹¶ä¸è®°å½•æ•°æ®é¡µçº§çš„æ•°æ®ï¼ˆå“ªä¸ªé¡µæ”¹äº†å“ªäº›åœ°æ–¹ï¼‰ï¼Œæ‰€ä»¥æ²¡æœ‰èƒ½åŠ›æ¢å¤æ•°æ®é¡µ binlog æ˜¯è¿½åŠ å†™ï¼Œä¿å­˜å…¨é‡çš„æ—¥å¿—ï¼Œæ²¡æœ‰æ ‡å¿—ç¡®å®šä»å“ªä¸ªç‚¹å¼€å§‹çš„æ•°æ®æ˜¯å·²ç»åˆ·ç›˜äº†ï¼Œè€Œ redo log åªè¦åœ¨ checkpoint_lsn åé¢çš„å°±æ˜¯æ²¡æœ‰åˆ·ç›˜çš„ æ›´æ–°è®°å½•æ›´æ–°ä¸€æ¡è®°å½•çš„è¿‡ç¨‹ï¼šå†™ä¹‹å‰ä¸€å®šå…ˆè¯» åœ¨ B+ æ ‘ä¸­å®šä½åˆ°è¯¥è®°å½•ï¼Œå¦‚æœè¯¥è®°å½•æ‰€åœ¨çš„é¡µé¢ä¸åœ¨ Buffer Pool é‡Œï¼Œå…ˆå°†å…¶åŠ è½½è¿›å†…å­˜ é¦–å…ˆæ›´æ–°è¯¥è®°å½•å¯¹åº”çš„èšç°‡ç´¢å¼•ï¼Œæ›´æ–°èšç°‡ç´¢å¼•è®°å½•æ—¶ï¼š æ›´æ–°è®°å½•å‰å‘ undo é¡µé¢å†™ undo æ—¥å¿—ï¼Œç”±äºè¿™æ˜¯æ›´æ”¹é¡µé¢ï¼Œæ‰€ä»¥éœ€è¦è®°å½•ä¸€ä¸‹ç›¸åº”çš„ redo æ—¥å¿— æ³¨æ„ï¼šä¿®æ”¹ undo é¡µé¢ä¹Ÿæ˜¯åœ¨ä¿®æ”¹é¡µé¢ï¼Œäº‹åŠ¡åªè¦ä¿®æ”¹é¡µé¢å°±éœ€è¦å…ˆè®°å½•ç›¸åº”çš„ redo æ—¥å¿— ç„¶åè®°å½•å¯¹åº”çš„ redo æ—¥å¿—ï¼ˆç­‰å¾… MTR æäº¤åå†™å…¥ redo log bufferï¼‰ï¼Œæœ€åè¿›è¡ŒçœŸæ­£çš„æ›´æ–°è®°å½• æ›´æ–°å…¶ä»–çš„äºŒçº§ç´¢å¼•è®°å½•ï¼Œä¸ä¼šå†è®°å½• undo logï¼Œåªè®°å½• redo log åˆ° buffer ä¸­ åœ¨ä¸€æ¡æ›´æ–°è¯­å¥æ‰§è¡Œå®Œæˆåï¼ˆä¹Ÿå°±æ˜¯å°†æ‰€æœ‰å¾…æ›´æ–°è®°å½•éƒ½æ›´æ–°å®Œäº†ï¼‰ï¼Œå°±ä¼šå¼€å§‹è®°å½•è¯¥è¯­å¥å¯¹åº”çš„ binlog æ—¥å¿—ï¼Œæ­¤æ—¶è®°å½•çš„ binlog å¹¶æ²¡æœ‰åˆ·æ–°åˆ°ç¡¬ç›˜ä¸Šï¼Œè¿˜åœ¨å†…å­˜ä¸­ï¼Œåœ¨äº‹åŠ¡æäº¤æ—¶æ‰ä¼šç»Ÿä¸€å°†è¯¥äº‹åŠ¡è¿è¡Œè¿‡ç¨‹ä¸­çš„æ‰€æœ‰ binlog æ—¥å¿—åˆ·æ–°åˆ°ç¡¬ç›˜ å‡è®¾è¡¨ä¸­æœ‰å­—æ®µ id å’Œ aï¼Œå­˜åœ¨ä¸€æ¡ id = 1, a = 2 çš„è®°å½•ï¼Œæ­¤æ—¶æ‰§è¡Œæ›´æ–°è¯­å¥ï¼š 1update table set a=2 where id=1; InnoDB ä¼šçœŸæ­£çš„å»æ‰§è¡ŒæŠŠå€¼ä¿®æ”¹æˆ (1,2) è¿™ä¸ªæ“ä½œï¼Œå…ˆåŠ è¡Œé”ï¼Œåœ¨å»æ›´æ–°ï¼Œå¹¶ä¸ä¼šæå‰åˆ¤æ–­ç›¸åŒå°±ä¸ä¿®æ”¹äº† å‚è€ƒæ–‡ç« ï¼šhttps://mp.weixin.qq.com/s/wcJ2KisSaMnfP4nH5NYaQA ä¸¤æ®µæäº¤å½“å®¢æˆ·ç«¯æ‰§è¡Œ COMMIT è¯­å¥æˆ–è€…åœ¨è‡ªåŠ¨æäº¤çš„æƒ…å†µä¸‹ï¼ŒMySQL å†…éƒ¨å¼€å¯ä¸€ä¸ª XA äº‹åŠ¡ï¼Œåˆ†ä¸¤é˜¶æ®µæ¥å®Œæˆ XA äº‹åŠ¡çš„æäº¤ï¼š 1update T set c=c+1 where ID=2; æµç¨‹è¯´æ˜ï¼šæ‰§è¡Œå¼•æ“å°†è¿™è¡Œæ–°æ•°æ®è¯»å…¥åˆ°å†…å­˜ä¸­ï¼ˆBuffer Poolï¼‰åï¼Œå…ˆå°†æ­¤æ¬¡æ›´æ–°æ“ä½œè®°å½•åˆ° redo log buffer é‡Œï¼Œç„¶åæ›´æ–°è®°å½•ã€‚æœ€åå°† redo log åˆ·ç›˜åäº‹åŠ¡å¤„äº prepare çŠ¶æ€ï¼Œæ‰§è¡Œå™¨ä¼šç”Ÿæˆè¿™ä¸ªæ“ä½œçš„ binlogï¼Œå¹¶æŠŠ binlog å†™å…¥ç£ç›˜ï¼Œå®Œæˆæäº¤ ä¸¤é˜¶æ®µï¼š Prepare é˜¶æ®µï¼šå­˜å‚¨å¼•æ“å°†è¯¥äº‹åŠ¡çš„ redo æ—¥å¿—åˆ·ç›˜ï¼Œå¹¶ä¸”å°†æœ¬äº‹åŠ¡çš„çŠ¶æ€è®¾ç½®ä¸º PREPAREï¼Œä»£è¡¨æ‰§è¡Œå®Œæˆéšæ—¶å¯ä»¥æäº¤äº‹åŠ¡ Commit é˜¶æ®µï¼šå…ˆå°†äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ binlog åˆ·æ–°åˆ°ç¡¬ç›˜ï¼Œå†æ‰§è¡Œå­˜å‚¨å¼•æ“çš„æäº¤å·¥ä½œï¼Œå¼•æ“æŠŠ redo log æ”¹æˆæäº¤çŠ¶æ€ å­˜å‚¨å¼•æ“å±‚çš„ redo log å’Œ server å±‚çš„ binlog å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œ éƒ½å¯ä»¥ç”¨äºè¡¨ç¤ºäº‹åŠ¡çš„æäº¤çŠ¶æ€ï¼Œè€Œä¸¤é˜¶æ®µæäº¤å°±æ˜¯è®©è¿™ä¸¤ä¸ªçŠ¶æ€ä¿æŒé€»è¾‘ä¸Šçš„ä¸€è‡´ï¼Œä¹Ÿæœ‰åˆ©äºä¸»ä»å¤åˆ¶ï¼Œæ›´å¥½çš„ä¿æŒä¸»ä»æ•°æ®çš„ä¸€è‡´æ€§ æ•°æ®æ¢å¤ç³»ç»Ÿå´©æºƒå‰æ²¡æœ‰æäº¤çš„äº‹åŠ¡çš„ redo log å¯èƒ½å·²ç»åˆ·ç›˜ï¼ˆå®šæ—¶çº¿ç¨‹æˆ–è€… checkpointï¼‰ï¼Œæ€ä¹ˆå¤„ç†å´©æºƒæ¢å¤ï¼Ÿ å·¥ä½œæµç¨‹ï¼šè·å– undo é“¾è¡¨é¦–èŠ‚ç‚¹é¡µé¢çš„ undo segement header ä¸­çš„ TRX_UNDO_STATE å±æ€§ï¼Œè¡¨ç¤ºå½“å‰é“¾è¡¨çš„äº‹åŠ¡å±æ€§ï¼Œäº‹åŠ¡çŠ¶æ€æ˜¯æ´»è·ƒï¼ˆæœªæäº¤ï¼‰çš„å°±å…¨éƒ¨å›æ»šï¼Œå¦‚æœæ˜¯ PREPARE çŠ¶æ€ï¼Œå°±éœ€è¦æ ¹æ® binlog çš„çŠ¶æ€è¿›è¡Œåˆ¤æ–­ï¼š å¦‚æœåœ¨æ—¶åˆ» A å‘ç”Ÿäº†å´©æºƒï¼ˆcrashï¼‰ï¼Œç”±äºæ­¤æ—¶ binlog è¿˜æ²¡å®Œæˆï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œå›æ»š å¦‚æœåœ¨æ—¶åˆ» B å‘ç”Ÿäº†å´©æºƒï¼Œredo log å’Œ binlog æœ‰ä¸€ä¸ªå…±åŒçš„æ•°æ®å­—æ®µå« XIDï¼Œå´©æºƒæ¢å¤çš„æ—¶å€™ï¼Œä¼šæŒ‰é¡ºåºæ‰«æ redo logï¼š å¦‚æœ redo log é‡Œé¢çš„äº‹åŠ¡æ˜¯å®Œæ•´çš„ï¼Œä¹Ÿå°±æ˜¯å·²ç»æœ‰äº† commit æ ‡è¯†ï¼Œè¯´æ˜ binlog ä¹Ÿå·²ç»è®°å½•å®Œæ•´ï¼Œç›´æ¥ä» redo log æ¢å¤æ•°æ® å¦‚æœ redo log é‡Œé¢çš„äº‹åŠ¡åªæœ‰ prepareï¼Œå°±æ ¹æ® XID å» binlog ä¸­åˆ¤æ–­å¯¹åº”çš„äº‹åŠ¡æ˜¯å¦å­˜åœ¨å¹¶å®Œæ•´ï¼Œå¦‚æœå®Œæ•´å¯ä»¥æ¢å¤æ•°æ® åˆ¤æ–­ä¸€ä¸ªäº‹åŠ¡çš„ binlog æ˜¯å¦å®Œæ•´çš„æ–¹æ³•ï¼š statement æ ¼å¼çš„ binlogï¼Œæœ€åä¼šæœ‰ COMMIT row æ ¼å¼çš„ binlogï¼Œæœ€åä¼šæœ‰ä¸€ä¸ª XID event MySQL 5.6.2 ç‰ˆæœ¬ä»¥åï¼Œå¼•å…¥äº† binlog-checksum å‚æ•°ç”¨æ¥éªŒè¯ binlog å†…å®¹çš„æ­£ç¡®æ€§ï¼ˆå¯èƒ½æ—¥å¿—ä¸­é—´å‡ºé”™ï¼‰ å‚è€ƒæ–‡ç« ï¼šhttps://time.geekbang.org/column/article/73161 åˆ·è„ä¼˜åŒ–ç³»ç»Ÿåœ¨è¿›è¡Œåˆ·è„æ—¶ä¼šå ç”¨ä¸€éƒ¨åˆ†ç³»ç»Ÿèµ„æºï¼Œä¼šå½±å“ç³»ç»Ÿçš„æ€§èƒ½ï¼Œäº§ç”Ÿç³»ç»ŸæŠ–åŠ¨ ä¸€ä¸ªæŸ¥è¯¢è¦æ·˜æ±°çš„è„é¡µä¸ªæ•°å¤ªå¤šï¼Œä¼šå¯¼è‡´æŸ¥è¯¢çš„å“åº”æ—¶é—´æ˜æ˜¾å˜é•¿ æ—¥å¿—å†™æ»¡ï¼Œæ›´æ–°å…¨éƒ¨å µä½ï¼Œå†™æ€§èƒ½è·Œä¸º 0ï¼Œè¿™ç§æƒ…å†µå¯¹æ•æ„Ÿä¸šåŠ¡æ¥è¯´ï¼Œæ˜¯ä¸èƒ½æ¥å—çš„ InnoDB åˆ·è„é¡µçš„æ§åˆ¶ç­–ç•¥ï¼š innodb_io_capacity å‚æ•°ä»£è¡¨ç£ç›˜çš„è¯»å†™èƒ½åŠ›ï¼Œå»ºè®®è®¾ç½®æˆç£ç›˜çš„ IOPSï¼ˆæ¯ç§’çš„ IO æ¬¡æ•°ï¼‰ åˆ·è„é€Ÿåº¦å‚è€ƒä¸¤ä¸ªå› ç´ ï¼šè„é¡µæ¯”ä¾‹å’Œ redo log å†™ç›˜é€Ÿåº¦ å‚æ•° innodb_max_dirty_pages_pct æ˜¯è„é¡µæ¯”ä¾‹ä¸Šé™ï¼Œé»˜è®¤å€¼æ˜¯ 75%ï¼ŒInnoDB ä¼šæ ¹æ®å½“å‰çš„è„é¡µæ¯”ä¾‹ï¼Œç®—å‡ºä¸€ä¸ªèŒƒå›´åœ¨ 0 åˆ° 100 ä¹‹é—´çš„æ•°å­— InnoDB æ¯æ¬¡å†™å…¥çš„æ—¥å¿—éƒ½æœ‰ä¸€ä¸ªåºå·ï¼Œå½“å‰å†™å…¥çš„åºå·è·Ÿ checkpoint å¯¹åº”çš„åºå·ä¹‹é—´çš„å·®å€¼ï¼ŒInnoDB æ ¹æ®å·®å€¼ç®—å‡ºä¸€ä¸ªèŒƒå›´åœ¨ 0 åˆ° 100 ä¹‹é—´çš„æ•°å­— ä¸¤è€…è¾ƒå¤§çš„å€¼è®°ä¸º Rï¼Œæ‰§è¡Œå¼•æ“æŒ‰ç…§ innodb_io_capacity å®šä¹‰çš„èƒ½åŠ›ä¹˜ä»¥ R% æ¥æ§åˆ¶åˆ·è„é¡µçš„é€Ÿåº¦ innodb_flush_neighbors å‚æ•°ç½®ä¸º 1 ä»£è¡¨æ§åˆ¶åˆ·è„æ—¶æ£€æŸ¥ç›¸é‚»çš„æ•°æ®é¡µï¼Œå¦‚æœä¹Ÿæ˜¯è„é¡µå°±ä¸€èµ·åˆ·è„ï¼Œå¹¶æ£€æŸ¥é‚»å±…çš„é‚»å±…ï¼Œè¿™ä¸ªè¡Œä¸ºä¼šä¸€ç›´è”“å»¶ç›´åˆ°ä¸æ˜¯è„é¡µï¼Œåœ¨ MySQL 8.0 ä¸­è¯¥å€¼çš„é»˜è®¤å€¼æ˜¯ 0ï¼Œä¸å»ºè®®å¼€å¯æ­¤åŠŸèƒ½ ä¸€è‡´ç‰¹æ€§ä¸€è‡´æ€§æ˜¯æŒ‡äº‹åŠ¡æ‰§è¡Œå‰åï¼Œæ•°æ®åº“çš„å®Œæ•´æ€§çº¦æŸæ²¡æœ‰è¢«ç ´åï¼Œäº‹åŠ¡æ‰§è¡Œçš„å‰åéƒ½æ˜¯åˆæ³•çš„æ•°æ®çŠ¶æ€ã€‚ æ•°æ®åº“çš„å®Œæ•´æ€§çº¦æŸåŒ…æ‹¬ä½†ä¸é™äºï¼šå®ä½“å®Œæ•´æ€§ï¼ˆå¦‚è¡Œçš„ä¸»é”®å­˜åœ¨ä¸”å”¯ä¸€ï¼‰ã€åˆ—å®Œæ•´æ€§ï¼ˆå¦‚å­—æ®µçš„ç±»å‹ã€å¤§å°ã€é•¿åº¦è¦ç¬¦åˆè¦æ±‚ï¼‰ã€å¤–é”®çº¦æŸã€ç”¨æˆ·è‡ªå®šä¹‰å®Œæ•´æ€§ï¼ˆå¦‚è½¬è´¦å‰åï¼Œä¸¤ä¸ªè´¦æˆ·ä½™é¢çš„å’Œåº”è¯¥ä¸å˜ï¼‰ å®ç°ä¸€è‡´æ€§çš„æªæ–½ï¼š ä¿è¯åŸå­æ€§ã€æŒä¹…æ€§å’Œéš”ç¦»æ€§ï¼Œå¦‚æœè¿™äº›ç‰¹æ€§æ— æ³•ä¿è¯ï¼Œäº‹åŠ¡çš„ä¸€è‡´æ€§ä¹Ÿæ— æ³•ä¿è¯ æ•°æ®åº“æœ¬èº«æä¾›ä¿éšœï¼Œä¾‹å¦‚ä¸å…è®¸å‘æ•´å½¢åˆ—æ’å…¥å­—ç¬¦ä¸²å€¼ã€å­—ç¬¦ä¸²é•¿åº¦ä¸èƒ½è¶…è¿‡åˆ—çš„é™åˆ¶ç­‰ åº”ç”¨å±‚é¢è¿›è¡Œä¿éšœï¼Œä¾‹å¦‚å¦‚æœè½¬è´¦æ“ä½œåªæ‰£é™¤è½¬è´¦è€…çš„ä½™é¢ï¼Œè€Œæ²¡æœ‰å¢åŠ æ¥æ”¶è€…çš„ä½™é¢ï¼Œæ— è®ºæ•°æ®åº“å®ç°çš„å¤šä¹ˆå®Œç¾ï¼Œä¹Ÿæ— æ³•ä¿è¯çŠ¶æ€çš„ä¸€è‡´ é”æœºåˆ¶åŸºæœ¬ä»‹ç»é”æœºåˆ¶ï¼šæ•°æ®åº“ä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œåœ¨å…±äº«çš„èµ„æºè¢«å¹¶å‘è®¿é—®æ—¶å˜å¾—å®‰å…¨æœ‰åºæ‰€è®¾è®¡çš„ä¸€ç§è§„åˆ™ åˆ©ç”¨ MVCC æ€§è´¨è¿›è¡Œè¯»å–çš„æ“ä½œå«ä¸€è‡´æ€§è¯»ï¼Œè¯»å–æ•°æ®å‰åŠ é”çš„æ“ä½œå«é”å®šè¯» é”çš„åˆ†ç±»ï¼š æŒ‰æ“ä½œåˆ†ç±»ï¼š å…±äº«é”ï¼šä¹Ÿå«è¯»é”ã€‚å¯¹åŒä¸€ä»½æ•°æ®ï¼Œå¤šä¸ªäº‹åŠ¡è¯»æ“ä½œå¯ä»¥åŒæ—¶åŠ é”è€Œä¸äº’ç›¸å½±å“ ï¼Œä½†ä¸èƒ½ä¿®æ”¹æ•°æ® æ’ä»–é”ï¼šä¹Ÿå«å†™é”ã€‚å½“å‰çš„æ“ä½œæ²¡æœ‰å®Œæˆå‰ï¼Œä¼šé˜»æ–­å…¶ä»–æ“ä½œçš„è¯»å–å’Œå†™å…¥ æŒ‰ç²’åº¦åˆ†ç±»ï¼š è¡¨çº§é”ï¼šä¼šé”å®šæ•´ä¸ªè¡¨ï¼Œå¼€é”€å°ï¼ŒåŠ é”å¿«ï¼›ä¸ä¼šå‡ºç°æ­»é”ï¼›é”å®šåŠ›åº¦å¤§ï¼Œå‘ç”Ÿé”å†²çªæ¦‚ç‡é«˜ï¼Œå¹¶å‘åº¦æœ€ä½ï¼Œåå‘ MyISAM è¡Œçº§é”ï¼šä¼šé”å®šå½“å‰æ“ä½œè¡Œï¼Œå¼€é”€å¤§ï¼ŒåŠ é”æ…¢ï¼›ä¼šå‡ºç°æ­»é”ï¼›é”å®šåŠ›åº¦å°ï¼Œå‘ç”Ÿé”å†²çªæ¦‚ç‡ä½ï¼Œå¹¶å‘åº¦é«˜ï¼Œåå‘ InnoDB é¡µçº§é”ï¼šé”çš„åŠ›åº¦ã€å‘ç”Ÿå†²çªçš„æ¦‚ç‡å’ŒåŠ é”å¼€é”€ä»‹äºè¡¨é”å’Œè¡Œé”ä¹‹é—´ï¼Œä¼šå‡ºç°æ­»é”ï¼Œå¹¶å‘æ€§èƒ½ä¸€èˆ¬ æŒ‰ä½¿ç”¨æ–¹å¼åˆ†ç±»ï¼š æ‚²è§‚é”ï¼šæ¯æ¬¡æŸ¥è¯¢æ•°æ®æ—¶éƒ½è®¤ä¸ºåˆ«äººä¼šä¿®æ”¹ï¼Œå¾ˆæ‚²è§‚ï¼Œæ‰€ä»¥æŸ¥è¯¢æ—¶åŠ é” ä¹è§‚é”ï¼šæ¯æ¬¡æŸ¥è¯¢æ•°æ®æ—¶éƒ½è®¤ä¸ºåˆ«äººä¸ä¼šä¿®æ”¹ï¼Œå¾ˆä¹è§‚ï¼Œä½†æ˜¯æ›´æ–°æ—¶ä¼šåˆ¤æ–­ä¸€ä¸‹åœ¨æ­¤æœŸé—´åˆ«äººæœ‰æ²¡æœ‰å»æ›´æ–°è¿™ä¸ªæ•°æ® ä¸åŒå­˜å‚¨å¼•æ“æ”¯æŒçš„é” å­˜å‚¨å¼•æ“ è¡¨çº§é” è¡Œçº§é” é¡µçº§é” MyISAM æ”¯æŒ ä¸æ”¯æŒ ä¸æ”¯æŒ InnoDB æ”¯æŒ æ”¯æŒ ä¸æ”¯æŒ MEMORY æ”¯æŒ ä¸æ”¯æŒ ä¸æ”¯æŒ BDB æ”¯æŒ ä¸æ”¯æŒ æ”¯æŒ ä»é”çš„è§’åº¦æ¥è¯´ï¼šè¡¨çº§é”æ›´é€‚åˆäºä»¥æŸ¥è¯¢ä¸ºä¸»ï¼Œåªæœ‰å°‘é‡æŒ‰ç´¢å¼•æ¡ä»¶æ›´æ–°æ•°æ®çš„åº”ç”¨ï¼Œå¦‚ Web åº”ç”¨ï¼›è€Œè¡Œçº§é”åˆ™æ›´é€‚åˆäºæœ‰å¤§é‡æŒ‰ç´¢å¼•æ¡ä»¶å¹¶å‘æ›´æ–°å°‘é‡ä¸åŒæ•°æ®ï¼ŒåŒæ—¶åˆæœ‰å¹¶æŸ¥è¯¢çš„åº”ç”¨ï¼Œå¦‚ä¸€äº›åœ¨çº¿äº‹åŠ¡å¤„ç†ç³»ç»Ÿ å†…å­˜ç»“æ„å¯¹ä¸€æ¡è®°å½•åŠ é”çš„æœ¬è´¨å°±æ˜¯åœ¨å†…å­˜ä¸­åˆ›å»ºä¸€ä¸ªé”ç»“æ„ä¸ä¹‹å…³è”ï¼Œç»“æ„åŒ…æ‹¬ äº‹åŠ¡ä¿¡æ¯ï¼šé”å¯¹åº”çš„äº‹åŠ¡ä¿¡æ¯ï¼Œä¸€ä¸ªé”å±äºä¸€ä¸ªäº‹åŠ¡ ç´¢å¼•ä¿¡æ¯ï¼šå¯¹äºè¡Œçº§é”ï¼Œéœ€è¦è®°å½•åŠ é”çš„è®°å½•å±äºå“ªä¸ªç´¢å¼• è¡¨é”å’Œè¡Œé”ä¿¡æ¯ï¼šè¡¨é”è®°å½•ç€é”å®šçš„è¡¨ï¼Œè¡Œé”è®°å½•äº† Space ID æ‰€åœ¨è¡¨ç©ºé—´ã€Page Number æ‰€åœ¨çš„é¡µå·ã€n_bits ä½¿ç”¨äº†å¤šå°‘æ¯”ç‰¹ type_modeï¼šä¸€ä¸ª 32 æ¯”ç‰¹çš„æ•°ï¼Œè¢«åˆ†æˆ lock_modeã€lock_typeã€rec_lock_type ä¸‰ä¸ªéƒ¨åˆ† lock_modeï¼šé”æ¨¡å¼ï¼Œè®°å½•æ˜¯å…±äº«é”ã€æ’ä»–é”ã€æ„å‘é”ä¹‹ç±» lock_typeï¼šä»£è¡¨è¡¨çº§é”è¿˜æ˜¯è¡Œçº§é” rec_lock_typeï¼šä»£è¡¨è¡Œé”çš„å…·ä½“ç±»å‹å’Œ is_waiting å±æ€§ï¼Œis_waiting &#x3D; true æ—¶è¡¨ç¤ºå½“å‰äº‹åŠ¡å°šæœªè·å–åˆ°é”ï¼Œå¤„äºç­‰å¾…çŠ¶æ€ã€‚äº‹åŠ¡è·å–é”åçš„é”ç»“æ„æ˜¯ is_waiting ä¸º falseï¼Œé‡Šæ”¾é”æ—¶ä¼šæ£€æŸ¥æ˜¯å¦ä¸å½“å‰è®°å½•å…³è”çš„é”ç»“æ„ï¼Œå¦‚æœæœ‰å°±å”¤é†’å¯¹åº”äº‹åŠ¡çš„çº¿ç¨‹ ä¸€ä¸ªäº‹åŠ¡å¯èƒ½æ“ä½œå¤šæ¡è®°å½•ï¼Œä¸ºäº†èŠ‚çœå†…å­˜ï¼Œæ»¡è¶³ä¸‹é¢æ¡ä»¶çš„é”ä½¿ç”¨åŒä¸€ä¸ªé”ç»“æ„ï¼š åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­çš„åŠ é”æ“ä½œ è¢«åŠ é”çš„è®°å½•åœ¨åŒä¸€ä¸ªé¡µé¢ä¸­ åŠ é”çš„ç±»å‹æ˜¯ä¸€æ ·çš„ åŠ é”çš„çŠ¶æ€æ˜¯ä¸€æ ·çš„ ServerMySQL é‡Œé¢è¡¨çº§åˆ«çš„é”æœ‰ä¸¤ç§ï¼šä¸€ç§æ˜¯è¡¨é”ï¼Œä¸€ç§æ˜¯å…ƒæ•°æ®é”ï¼ˆmeta data lockï¼ŒMDL) MDL å«å…ƒæ•°æ®é”ï¼Œä¸»è¦ç”¨æ¥ä¿æŠ¤ MySQL å†…éƒ¨å¯¹è±¡çš„å…ƒæ•°æ®ï¼Œä¿è¯æ•°æ®è¯»å†™çš„æ­£ç¡®æ€§ï¼Œå½“å¯¹ä¸€ä¸ªè¡¨åšå¢åˆ æ”¹æŸ¥çš„æ—¶å€™ï¼ŒåŠ  MDL è¯»é”ï¼›å½“è¦å¯¹è¡¨åšç»“æ„å˜æ›´æ“ä½œ DDL çš„æ—¶å€™ï¼ŒåŠ  MDL å†™é”ï¼Œä¸¤ç§é”ä¸ç›¸äº’å…¼å®¹ï¼Œæ‰€ä»¥å¯ä»¥ä¿è¯ DDLã€DMLã€DQL æ“ä½œçš„å®‰å…¨ è¯´æ˜ï¼šDDL æ“ä½œæ‰§è¡Œå‰ä¼šéšå¼æäº¤å½“å‰ä¼šè¯çš„äº‹åŠ¡ï¼Œå› ä¸º DDL ä¸€èˆ¬ä¼šåœ¨è‹¥å¹²ä¸ªç‰¹æ®Šäº‹åŠ¡ä¸­å®Œæˆï¼Œå¼€å¯ç‰¹æ®Šäº‹åŠ¡å‰éœ€è¦æäº¤åˆ°å…¶ä»–äº‹åŠ¡ MDL é”çš„ç‰¹æ€§ï¼š MDL é”ä¸éœ€è¦æ˜¾å¼ä½¿ç”¨ï¼Œåœ¨è®¿é—®ä¸€ä¸ªè¡¨çš„æ—¶å€™ä¼šè¢«è‡ªåŠ¨åŠ ä¸Šï¼Œåœ¨äº‹åŠ¡å¼€å§‹æ—¶ç”³è¯·ï¼Œæ•´ä¸ªäº‹åŠ¡æäº¤åé‡Šæ”¾ï¼ˆæ‰§è¡Œå®Œå•æ¡è¯­å¥ä¸é‡Šæ”¾ï¼‰ MDL é”æ˜¯åœ¨ Server ä¸­å®ç°ï¼Œä¸æ˜¯ InnoDB å­˜å‚¨å¼•æ“å±‚èƒ½ç›´æ¥å®ç°çš„é” MDL é”è¿˜èƒ½å®ç°å…¶ä»–ç²’åº¦çº§åˆ«çš„é”ï¼Œæ¯”å¦‚å…¨å±€é”ã€åº“çº§åˆ«çš„é”ã€è¡¨ç©ºé—´çº§åˆ«çš„é” FLUSH TABLES WITH READ LOCK ç®€ç§°ï¼ˆFTWRLï¼‰ï¼Œå…¨å±€è¯»é”ï¼Œè®©æ•´ä¸ªåº“å¤„äºåªè¯»çŠ¶æ€ï¼ŒDDL DML éƒ½è¢«é˜»å¡ï¼Œå·¥ä½œæµç¨‹ï¼š ä¸Šå…¨å±€è¯»é”ï¼ˆlock_global_read_lockï¼‰ æ¸…ç†è¡¨ç¼“å­˜ï¼ˆclose_cached_tablesï¼‰ ä¸Šå…¨å±€ COMMIT é”ï¼ˆmake_global_read_lock_block_commitï¼‰ è¯¥å‘½ä»¤ä¸»è¦ç”¨äºå¤‡ä»½å·¥å…·åšä¸€è‡´æ€§å¤‡ä»½ï¼Œç”±äº FTWRL éœ€è¦æŒæœ‰ä¸¤æŠŠå…¨å±€çš„ MDL é”ï¼Œå¹¶ä¸”è¿˜è¦å…³é—­æ‰€æœ‰è¡¨å¯¹è±¡ï¼Œå› æ­¤æ€ä¼¤æ€§å¾ˆå¤§ MyISAMè¡¨çº§é”MyISAM å­˜å‚¨å¼•æ“åªæ”¯æŒè¡¨é”ï¼Œè¿™ä¹Ÿæ˜¯ MySQL å¼€å§‹å‡ ä¸ªç‰ˆæœ¬ä¸­å”¯ä¸€æ”¯æŒçš„é”ç±»å‹ MyISAM å¼•æ“åœ¨æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ä¹‹å‰ï¼Œä¼šè‡ªåŠ¨ç»™æ¶‰åŠåˆ°çš„æ‰€æœ‰è¡¨åŠ è¯»é”ï¼Œåœ¨æ‰§è¡Œå¢åˆ æ”¹ä¹‹å‰ï¼Œä¼šè‡ªåŠ¨ç»™æ¶‰åŠçš„è¡¨åŠ å†™é”ï¼Œè¿™ä¸ªè¿‡ç¨‹å¹¶ä¸éœ€è¦ç”¨æˆ·å¹²é¢„ï¼Œæ‰€ä»¥ç”¨æˆ·ä¸€èˆ¬ä¸éœ€è¦ç›´æ¥ç”¨ LOCK TABLE å‘½ä»¤ç»™ MyISAM è¡¨æ˜¾å¼åŠ é” åŠ é”å‘½ä»¤ï¼šï¼ˆå¯¹ InnoDB å­˜å‚¨å¼•æ“ä¹Ÿé€‚ç”¨ï¼‰ è¯»é”ï¼šæ‰€æœ‰è¿æ¥åªèƒ½è¯»å–æ•°æ®ï¼Œä¸èƒ½ä¿®æ”¹ å†™é”ï¼šå…¶ä»–è¿æ¥ä¸èƒ½æŸ¥è¯¢å’Œä¿®æ”¹æ•°æ® 12345-- è¯»é”LOCK TABLE table_name READ;-- å†™é”LOCK TABLE table_name WRITE; è§£é”å‘½ä»¤ï¼š 12-- å°†å½“å‰ä¼šè¯æ‰€æœ‰çš„è¡¨è¿›è¡Œè§£é”UNLOCK TABLES; é”çš„å…¼å®¹æ€§ï¼š å¯¹ MyISAM è¡¨çš„è¯»æ“ä½œï¼Œä¸ä¼šé˜»å¡å…¶ä»–ç”¨æˆ·å¯¹åŒä¸€è¡¨çš„è¯»è¯·æ±‚ï¼Œä½†ä¼šé˜»å¡å¯¹åŒä¸€è¡¨çš„å†™è¯·æ±‚ å¯¹ MyISAM è¡¨çš„å†™æ“ä½œï¼Œåˆ™ä¼šé˜»å¡å…¶ä»–ç”¨æˆ·å¯¹åŒä¸€è¡¨çš„è¯»å’Œå†™æ“ä½œ ![](https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/MySQL-MyISAM é”çš„å…¼å®¹æ€§.png) é”è°ƒåº¦ï¼šMyISAM çš„è¯»å†™é”è°ƒåº¦æ˜¯å†™ä¼˜å…ˆï¼Œå› ä¸ºå†™é”åå…¶ä»–çº¿ç¨‹ä¸èƒ½åšä»»ä½•æ“ä½œï¼Œå¤§é‡çš„æ›´æ–°ä¼šä½¿æŸ¥è¯¢å¾ˆéš¾å¾—åˆ°é”ï¼Œä»è€Œé€ æˆæ°¸è¿œé˜»å¡ï¼Œæ‰€ä»¥ MyISAM ä¸é€‚åˆåšå†™ä¸ºä¸»çš„è¡¨çš„å­˜å‚¨å¼•æ“ é”æ“ä½œè¯»é”ä¸¤ä¸ªå®¢æˆ·ç«¯æ“ä½œ Client 1å’Œ Client 2ï¼Œç®€åŒ–ä¸º C1ã€C2 æ•°æ®å‡†å¤‡ï¼š 12345678910CREATE TABLE `tb_book` ( `id` INT(11) AUTO_INCREMENT, `name` VARCHAR(50) DEFAULT NULL, `publish_time` DATE DEFAULT NULL, `status` CHAR(1) DEFAULT NULL, PRIMARY KEY (`id`)) ENGINE=MYISAM DEFAULT CHARSET=utf8 ;INSERT INTO tb_book (id, NAME, publish_time, STATUS) VALUES(NULL,&#x27;javaç¼–ç¨‹æ€æƒ³&#x27;,&#x27;2088-08-01&#x27;,&#x27;1&#x27;);INSERT INTO tb_book (id, NAME, publish_time, STATUS) VALUES(NULL,&#x27;mysqlç¼–ç¨‹æ€æƒ³&#x27;,&#x27;2088-08-08&#x27;,&#x27;0&#x27;); C1ã€C2 åŠ è¯»é”ï¼ŒåŒæ—¶æŸ¥è¯¢å¯ä»¥æ­£å¸¸æŸ¥è¯¢å‡ºæ•°æ® 12LOCK TABLE tb_book READ; -- C1ã€C2SELECT * FROM tb_book; -- C1ã€C2 ![](https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/MySQL-MyISAM è¯»é”1.png) C1 åŠ è¯»é”ï¼ŒC1ã€C2 æŸ¥è¯¢æœªé”å®šçš„è¡¨ï¼ŒC1 æŠ¥é”™ï¼ŒC2 æ­£å¸¸æŸ¥è¯¢ 12LOCK TABLE tb_book READ; -- C1SELECT * FROM tb_user; -- C1ã€C2 ![](https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/MySQL-MyISAM è¯»é”2.png) C1ã€C2 æ‰§è¡Œæ’å…¥æ“ä½œï¼ŒC1 æŠ¥é”™ï¼ŒC2 ç­‰å¾…è·å– 1INSERT INTO tb_book VALUES(NULL,&#x27;Springé«˜çº§&#x27;,&#x27;2088-01-01&#x27;,&#x27;1&#x27;); -- C1ã€C2 ![](https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/MySQL-MyISAM è¯»é”3.png) å½“åœ¨ C1 ä¸­é‡Šæ”¾é”æŒ‡ä»¤ UNLOCK TABLESï¼ŒC2 ä¸­çš„ INSERT è¯­å¥ç«‹å³æ‰§è¡Œ å†™é”ä¸¤ä¸ªå®¢æˆ·ç«¯æ“ä½œ Client 1å’Œ Client 2ï¼Œç®€åŒ–ä¸º C1ã€C2 C1 åŠ å†™é”ï¼ŒC1ã€C2æŸ¥è¯¢è¡¨ï¼ŒC1 æ­£å¸¸æŸ¥è¯¢ï¼ŒC2 éœ€è¦ç­‰å¾… 12LOCK TABLE tb_book WRITE; -- C1SELECT * FROM tb_book; -- C1ã€C2 ![](https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/MySQL-MyISAM å†™é”1.png) å½“åœ¨ C1 ä¸­é‡Šæ”¾é”æŒ‡ä»¤ UNLOCK TABLESï¼ŒC2 ä¸­çš„ SELECT è¯­å¥ç«‹å³æ‰§è¡Œ C1ã€C2 åŒæ—¶åŠ å†™é” 1LOCK TABLE tb_book WRITE; ![](https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/MySQL-MyISAM å†™é”2.png) C1 åŠ å†™é”ï¼ŒC1ã€C2æŸ¥è¯¢æœªé”å®šçš„è¡¨ï¼ŒC1 æŠ¥é”™ï¼ŒC2 æ­£å¸¸æŸ¥è¯¢ é”çŠ¶æ€ æŸ¥çœ‹é”ç«äº‰ï¼š 1SHOW OPEN TABLES; In_userï¼šè¡¨å½“å‰è¢«æŸ¥è¯¢ä½¿ç”¨çš„æ¬¡æ•°ï¼Œå¦‚æœè¯¥æ•°ä¸ºé›¶ï¼Œåˆ™è¡¨æ˜¯æ‰“å¼€çš„ï¼Œä½†æ˜¯å½“å‰æ²¡æœ‰è¢«ä½¿ç”¨ Name_lockedï¼šè¡¨åç§°æ˜¯å¦è¢«é”å®šï¼Œåç§°é”å®šç”¨äºå–æ¶ˆè¡¨æˆ–å¯¹è¡¨è¿›è¡Œé‡å‘½åç­‰æ“ä½œ 1LOCK TABLE tb_book READ; -- æ‰§è¡Œå‘½ä»¤ æŸ¥çœ‹é”çŠ¶æ€ï¼š 1SHOW STATUS LIKE &#x27;Table_locks%&#x27;; ![](https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/MySQL-MyISAM é”çŠ¶æ€.png) Table_locks_immediateï¼šæŒ‡çš„æ˜¯èƒ½ç«‹å³è·å¾—è¡¨çº§é”çš„æ¬¡æ•°ï¼Œæ¯ç«‹å³è·å–é”ï¼Œå€¼åŠ  1 Table_locks_waitedï¼šæŒ‡çš„æ˜¯ä¸èƒ½ç«‹å³è·å–è¡¨çº§é”è€Œéœ€è¦ç­‰å¾…çš„æ¬¡æ•°ï¼Œæ¯ç­‰å¾…ä¸€æ¬¡ï¼Œè¯¥å€¼åŠ  1ï¼Œæ­¤å€¼é«˜è¯´æ˜å­˜åœ¨ç€è¾ƒä¸ºä¸¥é‡çš„è¡¨çº§é”äº‰ç”¨æƒ…å†µ InnoDBè¡Œçº§é”è®°å½•é”InnoDB ä¸ MyISAM çš„æœ€å¤§ä¸åŒæœ‰ä¸¤ç‚¹ï¼šä¸€æ˜¯æ”¯æŒäº‹åŠ¡ï¼›äºŒæ˜¯é‡‡ç”¨äº†è¡Œçº§é”ï¼ŒInnoDB åŒæ—¶æ”¯æŒè¡¨é”å’Œè¡Œé” è¡Œçº§é”ï¼Œä¹Ÿç§°ä¸ºè®°å½•é”ï¼ˆRecord Lockï¼‰ï¼ŒInnoDB å®ç°äº†ä»¥ä¸‹ä¸¤ç§ç±»å‹çš„è¡Œé”ï¼š å…±äº«é” (S)ï¼šåˆç§°ä¸ºè¯»é”ï¼Œç®€ç§° S é”ï¼Œå¤šä¸ªäº‹åŠ¡å¯¹äºåŒä¸€æ•°æ®å¯ä»¥å…±äº«ä¸€æŠŠé”ï¼Œéƒ½èƒ½è®¿é—®åˆ°æ•°æ®ï¼Œä½†æ˜¯åªèƒ½è¯»ä¸èƒ½ä¿®æ”¹ æ’ä»–é” (X)ï¼šåˆç§°ä¸ºå†™é”ï¼Œç®€ç§° X é”ï¼Œä¸èƒ½ä¸å…¶ä»–é”å¹¶å­˜ï¼Œè·å–æ’ä»–é”çš„äº‹åŠ¡æ˜¯å¯ä»¥å¯¹æ•°æ®è¯»å–å’Œä¿®æ”¹ RR éš”ç¦»ç•Œåˆ«ä¸‹ï¼Œå¯¹äº UPDATEã€DELETE å’Œ INSERT è¯­å¥ï¼ŒInnoDB ä¼šè‡ªåŠ¨ç»™æ¶‰åŠæ•°æ®é›†åŠ æ’ä»–é”ï¼ˆè¡Œé”ï¼‰ï¼Œåœ¨ commit æ—¶è‡ªåŠ¨é‡Šæ”¾ï¼›å¯¹äºæ™®é€š SELECT è¯­å¥ï¼Œä¸ä¼šåŠ ä»»ä½•é”ï¼ˆåªæ˜¯é’ˆå¯¹ InnoDB å±‚æ¥è¯´çš„ï¼Œå› ä¸ºåœ¨ Server å±‚ä¼šåŠ  MDL è¯»é”ï¼‰ï¼Œé€šè¿‡ MVCC é˜²æ­¢å¹¶å‘å†²çª åœ¨äº‹åŠ¡ä¸­åŠ çš„é”ï¼Œå¹¶ä¸æ˜¯ä¸éœ€è¦äº†å°±é‡Šæ”¾ï¼Œè€Œæ˜¯åœ¨äº‹åŠ¡ä¸­æ­¢æˆ–æäº¤æ—¶è‡ªåŠ¨é‡Šæ”¾ï¼Œè¿™ä¸ªå°±æ˜¯ä¸¤é˜¶æ®µé”åè®®ã€‚æ‰€ä»¥ä¸€èˆ¬å°†æ›´æ–°å…±äº«èµ„æºï¼ˆå¹¶å‘é«˜ï¼‰çš„ SQL æ”¾åˆ°äº‹åŠ¡çš„æœ€åæ‰§è¡Œï¼Œå¯ä»¥è®©å…¶ä»–çº¿ç¨‹å°½é‡çš„å‡å°‘ç­‰å¾…æ—¶é—´ é”çš„å…¼å®¹æ€§ï¼š å…±äº«é”å’Œå…±äº«é” å…¼å®¹ å…±äº«é”å’Œæ’ä»–é” å†²çª æ’ä»–é”å’Œæ’ä»–é” å†²çª æ’ä»–é”å’Œå…±äº«é” å†²çª æ˜¾å¼ç»™æ•°æ®é›†åŠ å…±äº«é”æˆ–æ’ä»–é”ï¼šåŠ é”è¯»å°±æ˜¯å½“å‰è¯»ï¼Œè¯»å–çš„æ˜¯æœ€æ–°æ•°æ® 12SELECT * FROM table_name WHERE ... LOCK IN SHARE MODE -- å…±äº«é”SELECT * FROM table_name WHERE ... FOR UPDATE -- æ’ä»–é” æ³¨æ„ï¼šé”é»˜è®¤ä¼šé”èšç°‡ç´¢å¼•ï¼ˆé”å°±æ˜¯åŠ åœ¨ç´¢å¼•ä¸Šï¼‰ï¼Œä½†æ˜¯å½“ä½¿ç”¨è¦†ç›–ç´¢å¼•æ—¶ï¼ŒåŠ å…±äº«é”åªé”äºŒçº§ç´¢å¼•ï¼Œä¸é”èšç°‡ç´¢å¼• é”æ“ä½œä¸¤ä¸ªå®¢æˆ·ç«¯æ“ä½œ Client 1å’Œ Client 2ï¼Œç®€åŒ–ä¸º C1ã€C2 ç¯å¢ƒå‡†å¤‡ 1234567891011CREATE TABLE test_innodb_lock( id INT(11), name VARCHAR(16), sex VARCHAR(1))ENGINE = INNODB DEFAULT CHARSET=utf8;INSERT INTO test_innodb_lock VALUES(1,&#x27;100&#x27;,&#x27;1&#x27;);-- ..........CREATE INDEX idx_test_innodb_lock_id ON test_innodb_lock(id);CREATE INDEX idx_test_innodb_lock_name ON test_innodb_lock(name); å…³é—­è‡ªåŠ¨æäº¤åŠŸèƒ½ï¼š 1SET AUTOCOMMIT=0; -- C1ã€C2 æ­£å¸¸æŸ¥è¯¢æ•°æ®ï¼š 1SELECT * FROM test_innodb_lock; -- C1ã€C2 æŸ¥è¯¢ id ä¸º 3 çš„æ•°æ®ï¼Œæ­£å¸¸æŸ¥è¯¢ï¼š 1SELECT * FROM test_innodb_lock WHERE id=3; -- C1ã€C2 ![](https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/MySQL-InnoDB é”æ“ä½œ1.png) C1 æ›´æ–° id ä¸º 3 çš„æ•°æ®ï¼Œä½†ä¸æäº¤ï¼š 1UPDATE test_innodb_lock SET name=&#x27;300&#x27; WHERE id=3; -- C1 ![](https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/MySQL-InnoDB é”æ“ä½œ2.png) C2 æŸ¥è¯¢ä¸åˆ° C1 ä¿®æ”¹çš„æ•°æ®ï¼Œå› ä¸ºéš”ç¦»ç•Œåˆ«ä¸º REPEATABLE READï¼ŒC1 æäº¤äº‹åŠ¡ï¼ŒC2 æŸ¥è¯¢ï¼š 1COMMIT; -- C1 ![](https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/MySQL-InnoDB é”æ“ä½œ3.png) æäº¤åä»ç„¶æŸ¥è¯¢ä¸åˆ° C1 ä¿®æ”¹çš„æ•°æ®ï¼Œå› ä¸ºéš”ç¦»çº§åˆ«å¯ä»¥é˜²æ­¢è„è¯»ã€ä¸å¯é‡å¤è¯»ï¼Œæ‰€ä»¥ C2 éœ€è¦æäº¤æ‰å¯ä»¥æŸ¥è¯¢åˆ°å…¶ä»–äº‹åŠ¡å¯¹æ•°æ®çš„ä¿®æ”¹ï¼š 12COMMIT; -- C2SELECT * FROM test_innodb_lock WHERE id=3; -- C2 ![](https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/MySQL-InnoDB é”æ“ä½œ4.png) C1 æ›´æ–° id ä¸º 3 çš„æ•°æ®ï¼Œä½†ä¸æäº¤ï¼ŒC2 ä¹Ÿæ›´æ–° id ä¸º 3 çš„æ•°æ®ï¼š 12UPDATE test_innodb_lock SET name=&#x27;3&#x27; WHERE id=3; -- C1UPDATE test_innodb_lock SET name=&#x27;30&#x27; WHERE id=3; -- C2 ![](https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/MySQL-InnoDB é”æ“ä½œ5.png) å½“ C1 æäº¤ï¼ŒC2 ç›´æ¥è§£é™¤é˜»å¡ï¼Œç›´æ¥æ›´æ–° æ“ä½œä¸åŒè¡Œçš„æ•°æ®ï¼š 12UPDATE test_innodb_lock SET name=&#x27;10&#x27; WHERE id=1; -- C1UPDATE test_innodb_lock SET name=&#x27;30&#x27; WHERE id=3; -- C2 ![](https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/MySQL-InnoDB é”æ“ä½œ6.png) ç”±äº C1ã€C2 æ“ä½œçš„ä¸åŒè¡Œï¼Œè·å–ä¸åŒçš„è¡Œé”ï¼Œæ‰€ä»¥éƒ½å¯ä»¥æ­£å¸¸è·å–è¡Œé” é”åˆ†ç±»é—´éš™é”InnoDB ä¼šå¯¹é—´éš™ï¼ˆGAPï¼‰è¿›è¡ŒåŠ é”ï¼Œå°±æ˜¯é—´éš™é” ï¼ˆRR éš”ç¦»çº§åˆ«ä¸‹æ‰æœ‰è¯¥é”ï¼‰ã€‚é—´éš™é”ä¹‹é—´ä¸å­˜åœ¨å†²çªå…³ç³»ï¼Œå¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶å¯¹ä¸€ä¸ªé—´éš™åŠ é”ï¼Œä½†æ˜¯é—´éš™é”ä¼šé˜»æ­¢å¾€è¿™ä¸ªé—´éš™ä¸­æ’å…¥ä¸€ä¸ªè®°å½•çš„æ“ä½œ InnoDB åŠ é”çš„åŸºæœ¬å•ä½æ˜¯ next-key lockï¼Œè¯¥é”æ˜¯è¡Œé”å’Œ gap lock çš„ç»„åˆï¼ˆX or S é”ï¼‰ï¼Œä½†æ˜¯åŠ é”è¿‡ç¨‹æ˜¯åˆ†ä¸ºé—´éš™é”å’Œè¡Œé”ä¸¤æ®µæ‰§è¡Œ å¯ä»¥ä¿æŠ¤å½“å‰è®°å½•å’Œå‰é¢çš„é—´éš™ï¼Œéµå¾ªå·¦å¼€å³é—­åŸåˆ™ï¼Œå•çº¯çš„é—´éš™é”æ˜¯å·¦å¼€å³å¼€ å‡è®¾æœ‰ 10ã€11ã€13ï¼Œé‚£ä¹ˆå¯èƒ½çš„é—´éš™é”åŒ…æ‹¬ï¼š(è´Ÿæ— ç©·,10]ã€(10,11]ã€(11,13]ã€(13,æ­£æ— ç©·) å‡ ç§ç´¢å¼•çš„åŠ é”æƒ…å†µï¼š å”¯ä¸€ç´¢å¼•åŠ é”åœ¨å€¼å­˜åœ¨æ—¶æ˜¯è¡Œé”ï¼Œnext-key lock ä¼šé€€åŒ–ä¸ºè¡Œé”ï¼Œå€¼ä¸å­˜åœ¨ä¼šå˜æˆé—´éš™é” æ™®é€šç´¢å¼•åŠ é”ä¼šç»§ç»­å‘å³éå†åˆ°ä¸æ»¡è¶³æ¡ä»¶çš„å€¼ä¸ºæ­¢ï¼Œnext-key lock é€€åŒ–ä¸ºé—´éš™é” èŒƒå›´æŸ¥è¯¢æ— è®ºæ˜¯å¦æ˜¯å”¯ä¸€ç´¢å¼•ï¼Œéƒ½éœ€è¦è®¿é—®åˆ°ä¸æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€ä¸ªå€¼ä¸ºæ­¢ å¯¹äºè”åˆç´¢å¼•ä¸”æ˜¯å”¯ä¸€ç´¢å¼•ï¼Œå¦‚æœ where æ¡ä»¶åªåŒ…æ‹¬è”åˆç´¢å¼•çš„ä¸€éƒ¨åˆ†ï¼Œé‚£ä¹ˆä¼šåŠ é—´éš™é” é—´éš™é”ä¼˜ç‚¹ï¼šRR çº§åˆ«ä¸‹é—´éš™é”å¯ä»¥è§£å†³äº‹åŠ¡çš„ä¸€éƒ¨åˆ†çš„å¹»è¯»é—®é¢˜ï¼Œé€šè¿‡å¯¹é—´éš™åŠ é”ï¼Œå¯ä»¥é˜²æ­¢è¯»å–è¿‡ç¨‹ä¸­æ•°æ®æ¡ç›®å‘ç”Ÿå˜åŒ–ã€‚ä¸€éƒ¨åˆ†çš„æ„æ€æ˜¯ä¸ä¼šå¯¹å…¨éƒ¨é—´éš™åŠ é”ï¼Œåªèƒ½åŠ é”ä¸€éƒ¨åˆ†çš„é—´éš™ é—´éš™é”å±å®³ï¼š å½“é”å®šä¸€ä¸ªèŒƒå›´çš„é”®å€¼åï¼Œå³ä½¿æŸäº›ä¸å­˜åœ¨çš„é”®å€¼ä¹Ÿä¼šè¢«æ— è¾œçš„é”å®šï¼Œé€ æˆåœ¨é”å®šçš„æ—¶å€™æ— æ³•æ’å…¥é”å®šé”®å€¼èŒƒå›´å†…çš„ä»»ä½•æ•°æ®ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹è¿™å¯èƒ½ä¼šå¯¹æ€§èƒ½é€ æˆå¾ˆå¤§çš„å±å®³ï¼Œå½±å“å¹¶å‘åº¦ äº‹åŠ¡ A B åŒæ—¶é”ä½ä¸€ä¸ªé—´éš™åï¼ŒA å¾€å½“å‰é—´éš™æ’å…¥æ•°æ®æ—¶ä¼šè¢« B çš„é—´éš™é”é˜»å¡ï¼ŒB ä¹Ÿæ‰§è¡Œæ’å…¥é—´éš™æ•°æ®çš„æ“ä½œæ—¶å°±ä¼šäº§ç”Ÿæ­»é” ç°åœºæ¼”ç¤ºï¼š å…³é—­è‡ªåŠ¨æäº¤åŠŸèƒ½ï¼š 1SET AUTOCOMMIT=0; -- C1ã€C2 æŸ¥è¯¢æ•°æ®è¡¨ï¼š 1SELECT * FROM test_innodb_lock; ![](https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/MySQL-InnoDB é—´éš™é”1.png) C1 æ ¹æ® id èŒƒå›´æ›´æ–°æ•°æ®ï¼ŒC2 æ’å…¥æ•°æ®ï¼š 12UPDATE test_innodb_lock SET name=&#x27;8888&#x27; WHERE id &lt; 4; -- C1INSERT INTO test_innodb_lock VALUES(2,&#x27;200&#x27;,&#x27;2&#x27;); -- C2 ![](https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/MySQL-InnoDB é—´éš™é”2.png) å‡ºç°é—´éš™é”ï¼ŒC2 è¢«é˜»å¡ï¼Œç­‰å¾… C1 æäº¤äº‹åŠ¡åæ‰èƒ½æ›´æ–° æ„å‘é”InnoDB ä¸ºäº†æ”¯æŒå¤šç²’åº¦çš„åŠ é”ï¼Œå…è®¸è¡Œé”å’Œè¡¨é”åŒæ—¶å­˜åœ¨ï¼Œæ”¯æŒåœ¨ä¸åŒç²’åº¦ä¸Šçš„åŠ é”æ“ä½œï¼ŒInnoDB å¢åŠ äº†æ„å‘é”ï¼ˆIntention Lockï¼‰ æ„å‘é”æ˜¯å°†é”å®šçš„å¯¹è±¡åˆ†ä¸ºå¤šä¸ªå±‚æ¬¡ï¼Œæ„å‘é”æ„å‘³ç€äº‹åŠ¡å¸Œæœ›åœ¨æ›´ç»†ç²’åº¦ä¸Šè¿›è¡ŒåŠ é”ï¼Œæ„å‘é”åˆ†ä¸ºä¸¤ç§ï¼š æ„å‘å…±äº«é”ï¼ˆISï¼‰ï¼šäº‹åŠ¡æœ‰æ„å‘å¯¹è¡¨åŠ å…±äº«é” æ„å‘æ’ä»–é”ï¼ˆIXï¼‰ï¼šäº‹åŠ¡æœ‰æ„å‘å¯¹è¡¨åŠ æ’ä»–é” IXï¼ŒIS æ˜¯è¡¨çº§é”ï¼Œä¸ä¼šå’Œè¡Œçº§çš„ Xï¼ŒS é”å‘ç”Ÿå†²çªï¼Œæ„å‘é”æ˜¯åœ¨åŠ è¡¨çº§é”ä¹‹å‰æ·»åŠ ï¼Œä¸ºäº†åœ¨åŠ è¡¨çº§é”æ—¶å¯ä»¥å¿«é€Ÿåˆ¤æ–­è¡¨ä¸­æ˜¯å¦æœ‰è®°å½•è¢«ä¸Šé”ï¼Œæ¯”å¦‚å‘ä¸€ä¸ªè¡¨æ·»åŠ è¡¨çº§ X é”çš„æ—¶ï¼š æ²¡æœ‰æ„å‘é”ï¼Œåˆ™éœ€è¦éå†æ•´ä¸ªè¡¨åˆ¤æ–­æ˜¯å¦æœ‰é”å®šçš„è®°å½• æœ‰äº†æ„å‘é”ï¼Œé¦–å…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨æ„å‘é”ï¼Œç„¶ååˆ¤æ–­è¯¥æ„å‘é”ä¸å³å°†æ·»åŠ çš„è¡¨çº§é”æ˜¯å¦å…¼å®¹å³å¯ï¼Œå› ä¸ºæ„å‘é”çš„å­˜åœ¨ä»£è¡¨æœ‰è¡¨çº§é”çš„å­˜åœ¨æˆ–è€…å³å°†æœ‰è¡¨çº§é”çš„å­˜åœ¨ å…¼å®¹æ€§å¦‚ä¸‹æ‰€ç¤ºï¼š æ’å…¥æ„å‘é” Insert Intention Lock æ˜¯åœ¨æ’å…¥ä¸€è¡Œè®°å½•æ“ä½œä¹‹å‰è®¾ç½®çš„ä¸€ç§é—´éš™é”ï¼Œæ˜¯è¡Œçº§é” æ’å…¥æ„å‘é”é‡Šæ”¾äº†ä¸€ç§æ’å…¥ä¿¡å·ï¼Œå³å¤šä¸ªäº‹åŠ¡åœ¨ç›¸åŒçš„ç´¢å¼•é—´éš™æ’å…¥æ—¶å¦‚æœä¸æ˜¯æ’å…¥ç›¸åŒçš„é—´éš™ä½ç½®å°±ä¸éœ€è¦äº’ç›¸ç­‰å¾…ã€‚å‡è®¾æŸåˆ—æœ‰ç´¢å¼•ï¼Œåªè¦ä¸¤ä¸ªäº‹åŠ¡æ’å…¥ä½ç½®ä¸åŒï¼Œå¦‚äº‹åŠ¡ A æ’å…¥ 3ï¼Œäº‹åŠ¡ B æ’å…¥ 4ï¼Œé‚£ä¹ˆå°±å¯ä»¥åŒæ—¶æ’å…¥ è‡ªå¢é”ç³»ç»Ÿä¼šè‡ªåŠ¨ç»™ AUTO_INCREMENT ä¿®é¥°çš„åˆ—è¿›è¡Œé€’å¢èµ‹å€¼ï¼Œå®ç°æ–¹å¼ï¼š AUTO_INC é”ï¼šè¡¨çº§é”ï¼Œæ‰§è¡Œæ’å…¥è¯­å¥æ—¶ä¼šè‡ªåŠ¨æ·»åŠ ï¼Œåœ¨è¯¥è¯­å¥æ‰§è¡Œå®Œæˆåé‡Šæ”¾ï¼Œå¹¶ä¸æ˜¯äº‹åŠ¡ç»“æŸ è½»é‡çº§é”ï¼šä¸ºæ’å…¥è¯­å¥ç”Ÿæˆ AUTO_INCREMENT ä¿®é¥°çš„åˆ—æ—¶è·å–è¯¥é”ï¼Œç”Ÿæˆä»¥åé‡Šæ”¾æ‰ï¼Œä¸éœ€è¦ç­‰åˆ°æ’å…¥è¯­å¥æ‰§è¡Œå®Œåé‡Šæ”¾ ç³»ç»Ÿå˜é‡ innodb_autoinc_lock_mode æ§åˆ¶é‡‡å–å“ªç§æ–¹å¼ï¼š 0ï¼šå…¨éƒ¨é‡‡ç”¨ AUTO_INC é” 1ï¼šå…¨éƒ¨é‡‡ç”¨è½»é‡çº§é” 2ï¼šæ··åˆä½¿ç”¨ï¼Œåœ¨æ’å…¥è®°å½•çš„æ•°é‡ç¡®å®šæ—¶é‡‡ç”¨è½»é‡çº§é”ï¼Œä¸ç¡®å®šæ—¶é‡‡ç”¨ AUTO_INC é” éšå¼é”ä¸€èˆ¬æƒ…å†µä¸‹ INSERT è¯­å¥æ˜¯ä¸éœ€è¦åœ¨å†…å­˜ä¸­ç”Ÿæˆé”ç»“æ„çš„ï¼Œä¼šè¿›è¡Œéšå¼çš„åŠ é”ï¼Œä¿æŠ¤çš„æ˜¯æ’å…¥åçš„å®‰å…¨ æ³¨æ„ï¼šå¦‚æœæ’å…¥çš„é—´éš™è¢«å…¶ä»–äº‹åŠ¡åŠ äº†é—´éš™é”ï¼Œæ­¤æ¬¡æ’å…¥ä¼šè¢«é˜»å¡ï¼Œå¹¶åœ¨è¯¥é—´éš™æ’å…¥ä¸€ä¸ªæ’å…¥æ„å‘é” èšç°‡ç´¢å¼•ï¼šç´¢å¼•è®°å½•æœ‰ trx_id éšè—åˆ—ï¼Œè¡¨ç¤ºæœ€åæ”¹åŠ¨è¯¥è®°å½•çš„äº‹åŠ¡ idï¼Œæ’å…¥æ•°æ®åäº‹åŠ¡ id å°±æ˜¯å½“å‰äº‹åŠ¡ã€‚å…¶ä»–äº‹åŠ¡æƒ³è·å–è¯¥è®°å½•çš„é”æ—¶ä¼šåˆ¤æ–­å½“å‰è®°å½•çš„äº‹åŠ¡ id æ˜¯å¦æ˜¯æ´»è·ƒçš„ï¼Œå¦‚æœä¸æ˜¯å°±å¯ä»¥æ­£å¸¸åŠ é”ï¼›å¦‚æœæ˜¯å°±åˆ›å»ºä¸€ä¸ª X çš„é”ç»“æ„ï¼Œè¯¥é”çš„ is_waiting æ˜¯ falseï¼Œä¸ºè‡ªå·±çš„äº‹åŠ¡åˆ›å»ºä¸€ä¸ªé”ç»“æ„ï¼Œis_waiting æ˜¯ trueï¼ˆç±»ä¼¼ Java ä¸­çš„é”å‡çº§ï¼‰ äºŒçº§ç´¢å¼•ï¼šè·å–æ•°æ®é¡µ Page Header ä¸­çš„ PAGE_MAX_TRX_ID å±æ€§ï¼Œä»£è¡¨ä¿®æ”¹å½“å‰é¡µé¢çš„æœ€å¤§çš„äº‹åŠ¡ IDï¼Œå¦‚æœå°äºå½“å‰æ´»è·ƒçš„æœ€å°äº‹åŠ¡ idï¼Œå°±è¯æ˜æ’å…¥è¯¥æ•°æ®çš„äº‹åŠ¡å·²ç»æäº¤ï¼Œå¦åˆ™å°±éœ€è¦è·å–åˆ°ä¸»é”®å€¼è¿›è¡Œå›è¡¨æ“ä½œ éšå¼é”èµ·åˆ°äº†å»¶è¿Ÿç”Ÿæˆé”çš„æ•ˆæœï¼Œå¦‚æœå…¶ä»–äº‹åŠ¡ä¸éšå¼é”æ²¡æœ‰å†²çªï¼Œå°±å¯ä»¥é¿å…é”ç»“æ„çš„ç”Ÿæˆï¼ŒèŠ‚çœäº†å†…å­˜èµ„æº INSERT åœ¨ä¸¤ç§æƒ…å†µä¸‹ä¼šç”Ÿæˆé”ç»“æ„ï¼š é‡å¤é”®ï¼šåœ¨æ’å…¥ä¸»é”®æˆ–å”¯ä¸€äºŒçº§ç´¢å¼•æ—¶é‡åˆ°é‡å¤çš„é”®å€¼ä¼šæŠ¥é”™ï¼Œåœ¨æŠ¥é”™å‰éœ€è¦å¯¹å¯¹åº”çš„èšç°‡ç´¢å¼•è¿›è¡ŒåŠ é” éš”ç¦»çº§åˆ« &lt;&#x3D; Read Uncommittedï¼ŒåŠ  S å‹ Record Lock éš”ç¦»çº§åˆ« &gt;&#x3D; Repeatable Readï¼ŒåŠ  S å‹ next_key é” å¤–é”®æ£€æŸ¥ï¼šå¦‚æœå¾…æ’å…¥çš„è®°å½•åœ¨çˆ¶è¡¨ä¸­å¯ä»¥æ‰¾åˆ°ï¼Œä¼šå¯¹çˆ¶è¡¨çš„è®°å½•åŠ  S å‹ Record Lockã€‚å¦‚æœå¾…æ’å…¥çš„è®°å½•åœ¨çˆ¶è¡¨ä¸­æ‰¾ä¸åˆ° éš”ç¦»çº§åˆ« &lt;&#x3D; Read Committedï¼Œä¸åŠ é” éš”ç¦»çº§åˆ« &gt;&#x3D; Repeatable Readï¼ŒåŠ é—´éš™é” é”ä¼˜åŒ–ä¼˜åŒ–é”InnoDB å­˜å‚¨å¼•æ“å®ç°äº†è¡Œçº§é”å®šï¼Œè™½ç„¶åœ¨é”å®šæœºåˆ¶çš„å®ç°æ–¹é¢å¸¦æ¥äº†æ€§èƒ½æŸè€—å¯èƒ½æ¯”è¡¨é”ä¼šæ›´é«˜ï¼Œä½†æ˜¯åœ¨æ•´ä½“å¹¶å‘å¤„ç†èƒ½åŠ›æ–¹é¢è¦è¿œè¿œä¼˜äº MyISAM çš„è¡¨é”ï¼Œå½“ç³»ç»Ÿå¹¶å‘é‡è¾ƒé«˜çš„æ—¶å€™ï¼ŒInnoDB çš„æ•´ä½“æ€§èƒ½è¿œè¿œå¥½äº MyISAM ä½†æ˜¯ä½¿ç”¨ä¸å½“å¯èƒ½ä¼šè®© InnoDB çš„æ•´ä½“æ€§èƒ½è¡¨ç°ä¸ä»…ä¸èƒ½æ¯” MyISAM é«˜ï¼Œç”šè‡³å¯èƒ½ä¼šæ›´å·® ä¼˜åŒ–å»ºè®®ï¼š å°½å¯èƒ½è®©æ‰€æœ‰æ•°æ®æ£€ç´¢éƒ½èƒ½é€šè¿‡ç´¢å¼•æ¥å®Œæˆï¼Œé¿å…æ— ç´¢å¼•è¡Œé”å‡çº§ä¸ºè¡¨é” åˆç†è®¾è®¡ç´¢å¼•ï¼Œå°½é‡ç¼©å°é”çš„èŒƒå›´ å°½å¯èƒ½å‡å°‘ç´¢å¼•æ¡ä»¶åŠç´¢å¼•èŒƒå›´ï¼Œé¿å…é—´éš™é” å°½é‡æ§åˆ¶äº‹åŠ¡å¤§å°ï¼Œå‡å°‘é”å®šèµ„æºé‡å’Œæ—¶é—´é•¿åº¦ å°½å¯ä½¿ç”¨ä½çº§åˆ«äº‹åŠ¡éš”ç¦»ï¼ˆéœ€è¦ä¸šåŠ¡å±‚é¢æ»¡è¶³éœ€æ±‚ï¼‰ é”å‡çº§ç´¢å¼•å¤±æ•ˆé€ æˆè¡Œé”å‡çº§ä¸ºè¡¨é”ï¼Œä¸é€šè¿‡ç´¢å¼•æ£€ç´¢æ•°æ®ï¼Œå…¨å±€æ‰«æçš„è¿‡ç¨‹ä¸­ InnoDB ä¼šå°†å¯¹è¡¨ä¸­çš„æ‰€æœ‰è®°å½•åŠ é”ï¼Œå®é™…æ•ˆæœå’Œè¡¨é”ä¸€æ ·ï¼Œå®é™…å¼€å‘è¿‡ç¨‹åº”é¿å…å‡ºç°ç´¢å¼•å¤±æ•ˆçš„çŠ¶å†µ æŸ¥çœ‹å½“å‰è¡¨çš„ç´¢å¼•ï¼š 1SHOW INDEX FROM test_innodb_lock; å…³é—­è‡ªåŠ¨æäº¤åŠŸèƒ½ï¼š 1SET AUTOCOMMIT=0; -- C1ã€C2 æ‰§è¡Œæ›´æ–°è¯­å¥ï¼š 12UPDATE test_innodb_lock SET sex=&#x27;2&#x27; WHERE name=10; -- C1UPDATE test_innodb_lock SET sex=&#x27;2&#x27; WHERE id=3; -- C2 ![](https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/MySQL-InnoDB é”å‡çº§.png) ç´¢å¼•å¤±æ•ˆï¼šæ‰§è¡Œæ›´æ–°æ—¶ name å­—æ®µä¸º varchar ç±»å‹ï¼Œé€ æˆç´¢å¼•å¤±æ•ˆï¼Œæœ€ç»ˆè¡Œé”å˜ä¸ºè¡¨é” æ­»é”ä¸åŒäº‹åŠ¡ç”±äºäº’ç›¸æŒæœ‰å¯¹æ–¹éœ€è¦çš„é”è€Œå¯¼è‡´äº‹åŠ¡éƒ½æ— æ³•ç»§ç»­æ‰§è¡Œçš„æƒ…å†µç§°ä¸ºæ­»é” æ­»é”æƒ…å†µï¼šçº¿ç¨‹ A ä¿®æ”¹äº† id &#x3D; 1 çš„æ•°æ®ï¼Œè¯·æ±‚ä¿®æ”¹ id &#x3D; 2 çš„æ•°æ®ï¼Œçº¿ç¨‹ B ä¿®æ”¹äº† id &#x3D; 2 çš„æ•°æ®ï¼Œè¯·æ±‚ä¿®æ”¹ id &#x3D; 1 çš„æ•°æ®ï¼Œäº§ç”Ÿæ­»é” è§£å†³ç­–ç•¥ï¼š ç›´æ¥è¿›å…¥ç­‰å¾…ç›´åˆ°è¶…æ—¶ï¼Œè¶…æ—¶æ—¶é—´å¯ä»¥é€šè¿‡å‚æ•° innodb_lock_wait_timeout æ¥è®¾ç½®ï¼Œé»˜è®¤ 50 ç§’ï¼Œä½†æ˜¯æ—¶é—´çš„è®¾ç½®ä¸å¥½æ§åˆ¶ï¼Œè¶…æ—¶å¯èƒ½ä¸æ˜¯å› ä¸ºæ­»é”ï¼Œè€Œæ˜¯å› ä¸ºäº‹åŠ¡å¤„ç†æ¯”è¾ƒæ…¢ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸é‡‡å–è¯¥æ–¹å¼ ä¸»åŠ¨æ­»é”æ£€æµ‹ï¼Œå‘ç°æ­»é”åä¸»åŠ¨å›æ»šæ­»é”é“¾æ¡ä¸­è¾ƒå°çš„ä¸€ä¸ªäº‹åŠ¡ï¼Œè®©å…¶ä»–äº‹åŠ¡å¾—ä»¥ç»§ç»­æ‰§è¡Œï¼Œå°†å‚æ•° innodb_deadlock_detect è®¾ç½®ä¸º onï¼Œè¡¨ç¤ºå¼€å¯è¯¥åŠŸèƒ½ï¼ˆäº‹åŠ¡è¾ƒå°çš„æ„æ€å°±æ˜¯äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­æ’å…¥ã€åˆ é™¤ã€æ›´æ–°çš„è®°å½•æ¡æ•°ï¼‰ æ­»é”æ£€æµ‹å¹¶ä¸æ˜¯æ¯ä¸ªè¯­å¥éƒ½è¦æ£€æµ‹ï¼Œåªæœ‰åœ¨åŠ é”è®¿é—®çš„è¡Œä¸Šå·²ç»æœ‰é”æ—¶ï¼Œå½“å‰äº‹åŠ¡è¢«é˜»å¡äº†æ‰ä¼šæ£€æµ‹ï¼Œä¹Ÿæ˜¯ä»å½“å‰äº‹åŠ¡å¼€å§‹è¿›è¡Œæ£€æµ‹ é€šè¿‡æ‰§è¡Œ SHOW ENGINE INNODB STATUS å¯ä»¥æŸ¥çœ‹æœ€è¿‘å‘ç”Ÿçš„ä¸€æ¬¡æ­»å¾ªç¯ï¼Œå…¨å±€ç³»ç»Ÿå˜é‡ innodb_print_all_deadlocks è®¾ç½®ä¸º onï¼Œå°±å¯ä»¥å°†æ¯ä¸ªæ­»é”ä¿¡æ¯éƒ½è®°å½•åœ¨ MySQL é”™è¯¯æ—¥å¿—ä¸­ æ­»é”ä¸€èˆ¬æ˜¯è¡Œçº§é”ï¼Œå½“è¡¨é”å‘ç”Ÿæ­»é”æ—¶ï¼Œä¼šåœ¨äº‹åŠ¡ä¸­è®¿é—®å…¶ä»–è¡¨æ—¶ç›´æ¥æŠ¥é”™ï¼Œç ´åäº†æŒæœ‰å¹¶ç­‰å¾…çš„æ­»é”æ¡ä»¶ é”çŠ¶æ€æŸ¥çœ‹é”ä¿¡æ¯ 1SHOW STATUS LIKE &#x27;innodb_row_lock%&#x27;; å‚æ•°è¯´æ˜ï¼š Innodb_row_lock_current_waitsï¼šå½“å‰æ­£åœ¨ç­‰å¾…é”å®šçš„æ•°é‡ Innodb_row_lock_timeï¼šä»ç³»ç»Ÿå¯åŠ¨åˆ°ç°åœ¨é”å®šæ€»æ—¶é—´é•¿åº¦ Innodb_row_lock_time_avgï¼šæ¯æ¬¡ç­‰å¾…æ‰€èŠ±å¹³å‡æ—¶é•¿ Innodb_row_lock_time_maxï¼šä»ç³»ç»Ÿå¯åŠ¨åˆ°ç°åœ¨ç­‰å¾…æœ€é•¿çš„ä¸€æ¬¡æ‰€èŠ±çš„æ—¶é—´ Innodb_row_lock_waitsï¼šç³»ç»Ÿå¯åŠ¨ååˆ°ç°åœ¨æ€»å…±ç­‰å¾…çš„æ¬¡æ•° å½“ç­‰å¾…çš„æ¬¡æ•°å¾ˆé«˜ï¼Œè€Œä¸”æ¯æ¬¡ç­‰å¾…çš„æ—¶é•¿ä¹Ÿä¸çŸ­çš„æ—¶å€™ï¼Œå°±éœ€è¦åˆ†æç³»ç»Ÿä¸­ä¸ºä»€ä¹ˆä¼šæœ‰å¦‚æ­¤å¤šçš„ç­‰å¾…ï¼Œç„¶åæ ¹æ®åˆ†æç»“æœåˆ¶å®šä¼˜åŒ–è®¡åˆ’ æŸ¥çœ‹é”çŠ¶æ€ï¼š 12SELECT * FROM information_schema.innodb_locks; #é”çš„æ¦‚å†µSHOW ENGINE INNODB STATUS\\G; #InnoDBæ•´ä½“çŠ¶æ€ï¼Œå…¶ä¸­åŒ…æ‹¬é”çš„æƒ…å†µ lock_id æ˜¯é” idï¼›lock_trx_id ä¸ºäº‹åŠ¡ idï¼›lock_mode ä¸º X ä»£è¡¨æ’å®ƒé”ï¼ˆå†™é”ï¼‰ï¼›lock_type ä¸º RECORD ä»£è¡¨é”ä¸ºè¡Œé”ï¼ˆè®°å½•é”ï¼‰ ä¹è§‚é”æ‚²è§‚é”ï¼šåœ¨æ•´ä¸ªæ•°æ®å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå°†æ•°æ®å¤„äºé”å®šçŠ¶æ€ï¼Œä¸ºäº†ä¿è¯äº‹åŠ¡çš„éš”ç¦»æ€§ï¼Œå°±éœ€è¦ä¸€è‡´æ€§é”å®šè¯»ã€‚è¯»å–æ•°æ®æ—¶ç»™åŠ é”ï¼Œå…¶å®ƒäº‹åŠ¡æ— æ³•ä¿®æ”¹è¿™äº›æ•°æ®ï¼Œä¿®æ”¹åˆ é™¤æ•°æ®æ—¶ä¹ŸåŠ é”ï¼Œå…¶å®ƒäº‹åŠ¡åŒæ ·æ— æ³•è¯»å–è¿™äº›æ•°æ® æ‚²è§‚é”å’Œä¹è§‚é”ä½¿ç”¨å‰æï¼š å¯¹äºè¯»çš„æ“ä½œè¿œå¤šäºå†™çš„æ“ä½œçš„æ—¶å€™ï¼Œä¸€ä¸ªæ›´æ–°æ“ä½œåŠ é”ä¼šé˜»å¡æ‰€æœ‰çš„è¯»å–æ“ä½œï¼Œé™ä½äº†ååé‡ï¼Œæœ€åéœ€è¦é‡Šæ”¾é”ï¼Œé”æ˜¯éœ€è¦ä¸€äº›å¼€é”€çš„ï¼Œè¿™æ—¶å€™å¯ä»¥é€‰æ‹©ä¹è§‚é” å¦‚æœæ˜¯è¯»å†™æ¯”ä¾‹å·®è·ä¸æ˜¯éå¸¸å¤§æˆ–è€…ç³»ç»Ÿæ²¡æœ‰å“åº”ä¸åŠæ—¶ï¼Œååé‡ç“¶é¢ˆçš„é—®é¢˜ï¼Œé‚£å°±ä¸è¦å»ä½¿ç”¨ä¹è§‚é”ï¼Œå®ƒå¢åŠ äº†å¤æ‚åº¦ï¼Œä¹Ÿå¸¦æ¥äº†ä¸šåŠ¡é¢å¤–çš„é£é™©ï¼Œè¿™æ—¶å€™å¯ä»¥é€‰æ‹©æ‚²è§‚é” ä¹è§‚é”çš„å®ç°æ–¹å¼ï¼šå°±æ˜¯ CASï¼Œæ¯”è¾ƒå¹¶äº¤æ¢ ç‰ˆæœ¬å· ç»™æ•°æ®è¡¨ä¸­æ·»åŠ ä¸€ä¸ª version åˆ—ï¼Œæ¯æ¬¡æ›´æ–°åéƒ½å°†è¿™ä¸ªåˆ—çš„å€¼åŠ  1 è¯»å–æ•°æ®æ—¶ï¼Œå°†ç‰ˆæœ¬å·è¯»å–å‡ºæ¥ï¼Œåœ¨æ‰§è¡Œæ›´æ–°çš„æ—¶å€™ï¼Œæ¯”è¾ƒç‰ˆæœ¬å· å¦‚æœç›¸åŒåˆ™æ‰§è¡Œæ›´æ–°ï¼Œå¦‚æœä¸ç›¸åŒï¼Œè¯´æ˜æ­¤æ¡æ•°æ®å·²ç»å‘ç”Ÿäº†å˜åŒ– ç”¨æˆ·è‡ªè¡Œæ ¹æ®è¿™ä¸ªé€šçŸ¥æ¥å†³å®šæ€ä¹ˆå¤„ç†ï¼Œæ¯”å¦‚é‡æ–°å¼€å§‹ä¸€éï¼Œæˆ–è€…æ”¾å¼ƒæœ¬æ¬¡æ›´æ–° 123456789101112131415-- åˆ›å»ºcityè¡¨CREATE TABLE city( id INT PRIMARY KEY AUTO_INCREMENT, -- åŸå¸‚id NAME VARCHAR(20), -- åŸå¸‚åç§° VERSION INT -- ç‰ˆæœ¬å·);-- æ·»åŠ æ•°æ®INSERT INTO city VALUES (NULL,&#x27;åŒ—äº¬&#x27;,1),(NULL,&#x27;ä¸Šæµ·&#x27;,1),(NULL,&#x27;å¹¿å·&#x27;,1),(NULL,&#x27;æ·±åœ³&#x27;,1);-- ä¿®æ”¹åŒ—äº¬ä¸ºåŒ—äº¬å¸‚-- 1.æŸ¥è¯¢åŒ—äº¬çš„versionSELECT VERSION FROM city WHERE NAME=&#x27;åŒ—äº¬&#x27;;-- 2.ä¿®æ”¹åŒ—äº¬ä¸ºåŒ—äº¬å¸‚ï¼Œç‰ˆæœ¬å·+1ã€‚å¹¶å¯¹æ¯”ç‰ˆæœ¬å·UPDATE city SET NAME=&#x27;åŒ—äº¬å¸‚&#x27;,VERSION=VERSION+1 WHERE NAME=&#x27;åŒ—äº¬&#x27; AND VERSION=1; æ—¶é—´æˆ³ å’Œç‰ˆæœ¬å·æ–¹å¼åŸºæœ¬ä¸€æ ·ï¼Œç»™æ•°æ®è¡¨ä¸­æ·»åŠ ä¸€ä¸ªåˆ—ï¼Œåç§°æ— æ‰€è°“ï¼Œæ•°æ®ç±»å‹éœ€è¦æ˜¯ timestamp æ¯æ¬¡æ›´æ–°åéƒ½å°†æœ€æ–°æ—¶é—´æ’å…¥åˆ°æ­¤åˆ— è¯»å–æ•°æ®æ—¶ï¼Œå°†æ—¶é—´è¯»å–å‡ºæ¥ï¼Œåœ¨æ‰§è¡Œæ›´æ–°çš„æ—¶å€™ï¼Œæ¯”è¾ƒæ—¶é—´ å¦‚æœç›¸åŒåˆ™æ‰§è¡Œæ›´æ–°ï¼Œå¦‚æœä¸ç›¸åŒï¼Œè¯´æ˜æ­¤æ¡æ•°æ®å·²ç»å‘ç”Ÿäº†å˜åŒ– ä¹è§‚é”çš„å¼‚å¸¸æƒ…å†µï¼šå¦‚æœ version è¢«å…¶ä»–äº‹åŠ¡æŠ¢å…ˆæ›´æ–°ï¼Œåˆ™åœ¨å½“å‰äº‹åŠ¡ä¸­æ›´æ–°å¤±è´¥ï¼Œtrx_id æ²¡æœ‰å˜æˆå½“å‰äº‹åŠ¡çš„ IDï¼Œå½“å‰äº‹åŠ¡å†æ¬¡æŸ¥è¯¢è¿˜æ˜¯æ—§å€¼ï¼Œå°±ä¼šå‡ºç°å€¼æ²¡å˜ä½†æ˜¯æ›´æ–°ä¸äº†çš„ç°è±¡ï¼ˆanomalyï¼‰ è§£å†³æ–¹æ¡ˆï¼šæ¯æ¬¡ CAS æ›´æ–°ä¸ç®¡æˆåŠŸå¤±è´¥ï¼Œå°±ç»“æŸå½“å‰äº‹åŠ¡ï¼›å¦‚æœå¤±è´¥åˆ™é‡æ–°èµ·ä¸€ä¸ªäº‹åŠ¡è¿›è¡ŒæŸ¥è¯¢æ›´æ–° ä¸»ä»åŸºæœ¬ä»‹ç»ä¸»ä»å¤åˆ¶æ˜¯æŒ‡å°†ä¸»æ•°æ®åº“çš„ DDL å’Œ DML æ“ä½œé€šè¿‡äºŒè¿›åˆ¶æ—¥å¿—ä¼ åˆ°ä»åº“æœåŠ¡å™¨ä¸­ï¼Œç„¶ååœ¨ä»åº“ä¸Šå¯¹è¿™äº›æ—¥å¿—é‡æ–°æ‰§è¡Œï¼ˆä¹Ÿå«é‡åšï¼‰ï¼Œä»è€Œä½¿å¾—ä»åº“å’Œä¸»åº“çš„æ•°æ®ä¿æŒåŒæ­¥ MySQL æ”¯æŒä¸€å°ä¸»åº“åŒæ—¶å‘å¤šå°ä»åº“è¿›è¡Œå¤åˆ¶ï¼Œä»åº“åŒæ—¶ä¹Ÿå¯ä»¥ä½œä¸ºå…¶ä»–ä»æœåŠ¡å™¨çš„ä¸»åº“ï¼Œå®ç°é“¾çŠ¶å¤åˆ¶ MySQL å¤åˆ¶çš„ä¼˜ç‚¹ä¸»è¦åŒ…å«ä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢ï¼š ä¸»åº“å‡ºç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿåˆ‡æ¢åˆ°ä»åº“æä¾›æœåŠ¡ å¯ä»¥åœ¨ä»åº“ä¸Šæ‰§è¡ŒæŸ¥è¯¢æ“ä½œï¼Œä»ä¸»åº“ä¸­æ›´æ–°ï¼Œå®ç°è¯»å†™åˆ†ç¦» å¯ä»¥åœ¨ä»åº“ä¸­æ‰§è¡Œå¤‡ä»½ï¼Œä»¥é¿å…å¤‡ä»½æœŸé—´å½±å“ä¸»åº“çš„æœåŠ¡ï¼ˆå¤‡ä»½æ—¶ä¼šåŠ å…¨å±€è¯»é”ï¼‰ ä¸»ä»å¤åˆ¶ä¸»ä»ç»“æ„MySQL çš„ä¸»ä»ä¹‹é—´ç»´æŒäº†ä¸€ä¸ªé•¿è¿æ¥ã€‚ä¸»åº“å†…éƒ¨æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œä¸“é—¨ç”¨äºæœåŠ¡ä»åº“çš„é•¿è¿æ¥ï¼Œè¿æ¥è¿‡ç¨‹ï¼š ä»åº“æ‰§è¡Œ change master å‘½ä»¤ï¼Œè®¾ç½®ä¸»åº“çš„ IPã€ç«¯å£ã€ç”¨æˆ·åã€å¯†ç ä»¥åŠè¦ä»å“ªä¸ªä½ç½®å¼€å§‹è¯·æ±‚ binlogï¼Œè¿™ä¸ªä½ç½®åŒ…å«æ–‡ä»¶åå’Œæ—¥å¿—åç§»é‡ ä»åº“æ‰§è¡Œ start slave å‘½ä»¤ï¼Œè¿™æ—¶ä»åº“ä¼šå¯åŠ¨ä¸¤ä¸ªçº¿ç¨‹ï¼Œå°±æ˜¯å›¾ä¸­çš„ io_thread å’Œ sql_threadï¼Œå…¶ä¸­ io_thread è´Ÿè´£ä¸ä¸»åº“å»ºç«‹è¿æ¥ ä¸»åº“æ ¡éªŒå®Œç”¨æˆ·åã€å¯†ç åï¼Œå¼€å§‹æŒ‰ç…§ä»ä¼ è¿‡æ¥çš„ä½ç½®ï¼Œä»æœ¬åœ°è¯»å– binlog å‘ç»™ä»åº“ï¼Œå¼€å§‹ä¸»ä»å¤åˆ¶ ä¸»ä»å¤åˆ¶åŸç†å›¾ï¼š ä¸»ä»å¤åˆ¶ä¸»è¦ä¾èµ–çš„æ˜¯ binlogï¼ŒMySQL é»˜è®¤æ˜¯å¼‚æ­¥å¤åˆ¶ï¼Œéœ€è¦ä¸‰ä¸ªçº¿ç¨‹ï¼š binlog threadï¼šåœ¨ä¸»åº“äº‹åŠ¡æäº¤æ—¶ï¼ŒæŠŠæ•°æ®å˜æ›´è®°å½•åœ¨æ—¥å¿—æ–‡ä»¶ binlog ä¸­ï¼Œå¹¶é€šçŸ¥ slave æœ‰æ•°æ®æ›´æ–° I&#x2F;O threadï¼šè´Ÿè´£ä»ä¸»æœåŠ¡å™¨ä¸Šæ‹‰å–äºŒè¿›åˆ¶æ—¥å¿—ï¼Œå¹¶å°† binlog æ—¥å¿—å†…å®¹ä¾æ¬¡å†™åˆ° relay log ä¸­è½¬æ—¥å¿—çš„æœ€æœ«ç«¯ï¼Œå¹¶å°†æ–°çš„ binlog æ–‡ä»¶åå’Œ offset è®°å½•åˆ° master-info æ–‡ä»¶ä¸­ï¼Œä»¥ä¾¿ä¸‹ä¸€æ¬¡è¯»å–æ—¥å¿—æ—¶ä»æŒ‡å®š binlog æ—¥å¿—æ–‡ä»¶åŠä½ç½®å¼€å§‹è¯»å–æ–°çš„ binlog æ—¥å¿—å†…å®¹ SQL threadï¼šç›‘æµ‹æœ¬åœ° relay log ä¸­æ–°å¢äº†æ—¥å¿—å†…å®¹ï¼Œè¯»å–ä¸­ç»§æ—¥å¿—å¹¶é‡åšå…¶ä¸­çš„ SQL è¯­å¥ï¼Œä»åº“åœ¨ relay-log.info ä¸­è®°å½•å½“å‰åº”ç”¨ä¸­ç»§æ—¥å¿—çš„æ–‡ä»¶åå’Œä½ç‚¹ä»¥ä¾¿ä¸‹ä¸€æ¬¡æ‰§è¡Œ åŒæ­¥ä¸å¼‚æ­¥ï¼š å¼‚æ­¥å¤åˆ¶æœ‰æ•°æ®ä¸¢å¤±é£é™©ï¼Œä¾‹å¦‚æ•°æ®è¿˜æœªåŒæ­¥åˆ°ä»åº“ï¼Œä¸»åº“å°±ç»™å®¢æˆ·ç«¯å“åº”ï¼Œç„¶åä¸»åº“æŒ‚äº†ï¼Œæ­¤æ—¶ä»åº“æ™‹å‡ä¸ºä¸»åº“çš„è¯æ•°æ®æ˜¯ç¼ºå¤±çš„ åŒæ­¥å¤åˆ¶ï¼Œä¸»åº“éœ€è¦å°† binlog å¤åˆ¶åˆ°æ‰€æœ‰ä»åº“ï¼Œç­‰æ‰€æœ‰ä»åº“å“åº”äº†ä¹‹åä¸»åº“æ‰è¿›è¡Œå…¶ä»–é€»è¾‘ï¼Œè¿™æ ·çš„è¯æ€§èƒ½å¾ˆå·®ï¼Œä¸€èˆ¬ä¸ä¼šé€‰æ‹© MySQL 5.7 ä¹‹åå‡ºç°äº†åŠåŒæ­¥å¤åˆ¶ï¼Œæœ‰å‚æ•°å¯ä»¥é€‰æ‹©æˆåŠŸåŒæ­¥å‡ ä¸ªä»åº“å°±è¿”å›å“åº” ä¸»ä¸»ç»“æ„ä¸»ä¸»ç»“æ„å°±æ˜¯ä¸¤ä¸ªæ•°æ®åº“ä¹‹é—´æ€»æ˜¯äº’ä¸ºä¸»ä»å…³ç³»ï¼Œè¿™æ ·åœ¨åˆ‡æ¢çš„æ—¶å€™å°±ä¸ç”¨å†ä¿®æ”¹ä¸»ä»å…³ç³» å¾ªç¯å¤åˆ¶ï¼šåœ¨åº“ A ä¸Šæ›´æ–°äº†ä¸€æ¡è¯­å¥ï¼Œç„¶åæŠŠç”Ÿæˆçš„ binlog å‘ç»™åº“ Bï¼Œåº“ B æ‰§è¡Œå®Œè¿™æ¡æ›´æ–°è¯­å¥åä¹Ÿä¼šç”Ÿæˆ binlogï¼Œä¼šå†å‘ç»™ A è§£å†³æ–¹æ³•ï¼š ä¸¤ä¸ªåº“çš„ server id å¿…é¡»ä¸åŒï¼Œå¦‚æœç›¸åŒåˆ™å®ƒä»¬ä¹‹é—´ä¸èƒ½è®¾å®šä¸ºä¸»ä¸»å…³ç³» ä¸€ä¸ªåº“æ¥åˆ° binlog å¹¶åœ¨é‡æ”¾çš„è¿‡ç¨‹ä¸­ï¼Œç”Ÿæˆä¸åŸ binlog çš„ server id ç›¸åŒçš„æ–°çš„ binlog æ¯ä¸ªåº“åœ¨æ”¶åˆ°ä»ä¸»åº“å‘è¿‡æ¥çš„æ—¥å¿—åï¼Œå…ˆåˆ¤æ–­ server idï¼Œå¦‚æœè·Ÿè‡ªå·±çš„ç›¸åŒï¼Œè¡¨ç¤ºè¿™ä¸ªæ—¥å¿—æ˜¯è‡ªå·±ç”Ÿæˆçš„ï¼Œå°±ç›´æ¥ä¸¢å¼ƒè¿™ä¸ªæ—¥å¿— ä¸»ä»å»¶è¿Ÿå»¶è¿ŸåŸå› æ­£å¸¸æƒ…å†µä¸»åº“æ‰§è¡Œæ›´æ–°ç”Ÿæˆçš„æ‰€æœ‰ binlogï¼Œéƒ½å¯ä»¥ä¼ åˆ°ä»åº“å¹¶è¢«æ­£ç¡®åœ°æ‰§è¡Œï¼Œä»åº“å°±èƒ½è¾¾åˆ°è·Ÿä¸»åº“ä¸€è‡´çš„çŠ¶æ€ï¼Œè¿™å°±æ˜¯æœ€ç»ˆä¸€è‡´æ€§ ä¸»ä»å»¶è¿Ÿæ˜¯ä¸»ä»ä¹‹é—´æ˜¯å­˜åœ¨ä¸€å®šæ—¶é—´çš„æ•°æ®ä¸ä¸€è‡´ï¼Œå°±æ˜¯åŒä¸€ä¸ªäº‹åŠ¡åœ¨ä»åº“æ‰§è¡Œå®Œæˆçš„æ—¶é—´å’Œä¸»åº“æ‰§è¡Œå®Œæˆçš„æ—¶é—´çš„å·®å€¼ï¼Œå³ T2-T1 ä¸»åº“ A æ‰§è¡Œå®Œæˆä¸€ä¸ªäº‹åŠ¡ï¼Œå†™å…¥ binlogï¼Œè¯¥æ—¶åˆ»è®°ä¸º T1 æ—¥å¿—ä¼ ç»™ä»åº“ Bï¼Œä»åº“ B æ‰§è¡Œå®Œè¿™ä¸ªäº‹åŠ¡ï¼Œè¯¥æ—¶åˆ»è®°ä¸º T2 é€šè¿‡åœ¨ä»åº“æ‰§è¡Œ show slave status å‘½ä»¤ï¼Œè¿”å›ç»“æœä¼šæ˜¾ç¤º seconds_behind_master è¡¨ç¤ºå½“å‰ä»åº“å»¶è¿Ÿäº†å¤šå°‘ç§’ æ¯ä¸€ä¸ªäº‹åŠ¡çš„ binlog éƒ½æœ‰ä¸€ä¸ªæ—¶é—´å­—æ®µï¼Œç”¨äºè®°å½•ä¸»åº“ä¸Šå†™å…¥çš„æ—¶é—´ ä»åº“å–å‡ºå½“å‰æ­£åœ¨æ‰§è¡Œçš„äº‹åŠ¡çš„æ—¶é—´å­—æ®µï¼Œè·Ÿç³»ç»Ÿçš„æ—¶é—´è¿›è¡Œç›¸å‡ï¼Œå¾—åˆ°çš„å°±æ˜¯ seconds_behind_master ä¸»ä»å»¶è¿Ÿçš„åŸå› ï¼š ä»åº“çš„æœºå™¨æ€§èƒ½æ¯”ä¸»åº“çš„å·®ï¼Œå¯¼è‡´ä»åº“çš„å¤åˆ¶èƒ½åŠ›å¼± ä»åº“çš„æŸ¥è¯¢å‹åŠ›å¤§ï¼Œå»ºç«‹ä¸€ä¸»å¤šä»çš„ç»“æ„ å¤§äº‹åŠ¡çš„æ‰§è¡Œï¼Œä¸»åº“å¿…é¡»è¦ç­‰åˆ°äº‹åŠ¡å®Œæˆä¹‹åæ‰ä¼šå†™å…¥ binlogï¼Œå¯¼è‡´ä»èŠ‚ç‚¹å‡ºç°åº”ç”¨ binlog å»¶è¿Ÿ ä¸»åº“çš„ DDLï¼Œä»åº“ä¸ä¸»åº“çš„ DDL åŒæ­¥æ˜¯ä¸²è¡Œè¿›è¡Œï¼ŒDDL åœ¨ä¸»åº“æ‰§è¡Œæ—¶é—´å¾ˆé•¿ï¼Œé‚£ä¹ˆä»åº“ä¹Ÿä¼šæ¶ˆè€—åŒæ ·çš„æ—¶é—´ é”å†²çªé—®é¢˜ä¹Ÿå¯èƒ½å¯¼è‡´ä»èŠ‚ç‚¹çš„ SQL çº¿ç¨‹æ‰§è¡Œæ…¢ ä¸»ä»åŒæ­¥é—®é¢˜æ°¸è¿œéƒ½æ˜¯ä¸€è‡´æ€§å’Œæ€§èƒ½çš„æƒè¡¡ï¼Œéœ€è¦æ ¹æ®å®é™…çš„åº”ç”¨åœºæ™¯ï¼Œå¯ä»¥é‡‡å–ä¸‹é¢çš„åŠæ³•ï¼š ä¼˜åŒ– SQLï¼Œé¿å…æ…¢ SQLï¼Œå‡å°‘æ‰¹é‡æ“ä½œ é™ä½å¤šçº¿ç¨‹å¤§äº‹åŠ¡å¹¶å‘çš„æ¦‚ç‡ï¼Œä¼˜åŒ–ä¸šåŠ¡é€»è¾‘ ä¸šåŠ¡ä¸­å¤§å¤šæ•°æƒ…å†µæŸ¥è¯¢æ“ä½œè¦æ¯”æ›´æ–°æ“ä½œæ›´å¤šï¼Œæ­å»ºä¸€ä¸»å¤šä»ç»“æ„ï¼Œè®©è¿™äº›ä»åº“æ¥åˆ†æ‹…è¯»çš„å‹åŠ› å°½é‡é‡‡ç”¨çŸ­çš„é“¾è·¯ï¼Œä¸»åº“å’Œä»åº“æœåŠ¡å™¨çš„è·ç¦»å°½é‡è¦çŸ­ï¼Œæå‡ç«¯å£å¸¦å®½ï¼Œå‡å°‘ binlog ä¼ è¾“çš„ç½‘ç»œå»¶æ—¶ å®æ—¶æ€§è¦æ±‚é«˜çš„ä¸šåŠ¡è¯»å¼ºåˆ¶èµ°ä¸»åº“ï¼Œä»åº“åªåšå¤‡ä»½ å¹¶è¡Œå¤åˆ¶MySQL5.6é«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œä¸»åº“çš„ä¼šäº§ç”Ÿå¤§é‡çš„ binlogï¼Œåœ¨ä»åº“ä¸­æœ‰ä¸¤ä¸ªçº¿ç¨‹ IO Thread å’Œ SQL Thread å•çº¿ç¨‹æ‰§è¡Œï¼Œä¼šå¯¼è‡´ä¸»åº“å»¶è¿Ÿå˜å¤§ã€‚ä¸ºäº†æ”¹å–„å¤åˆ¶å»¶è¿Ÿé—®é¢˜ï¼ŒMySQL 5.6 ç‰ˆæœ¬å¢åŠ äº†å¹¶è¡Œå¤åˆ¶åŠŸèƒ½ï¼Œä»¥é‡‡ç”¨å¤šçº¿ç¨‹æœºåˆ¶æ¥ä¿ƒè¿›æ‰§è¡Œ coordinator å°±æ˜¯åŸæ¥çš„ SQL Threadï¼Œå¹¶è¡Œå¤åˆ¶ä¸­å®ƒä¸å†ç›´æ¥æ›´æ–°æ•°æ®ï¼Œåªè´Ÿè´£è¯»å–ä¸­è½¬æ—¥å¿—å’Œåˆ†å‘äº‹åŠ¡ï¼š çº¿ç¨‹åˆ†é…å®Œæˆå¹¶ä¸æ˜¯ç«‹å³æ‰§è¡Œï¼Œä¸ºäº†é˜²æ­¢é€ æˆæ›´æ–°è¦†ç›–ï¼Œæ›´æ–°åŒä¸€ DB çš„ä¸¤ä¸ªäº‹åŠ¡å¿…é¡»è¢«åˆ†å‘åˆ°åŒä¸€ä¸ªå·¥ä½œçº¿ç¨‹ åŒä¸€ä¸ªäº‹åŠ¡ä¸èƒ½è¢«æ‹†å¼€ï¼Œå¿…é¡»æ”¾åˆ°åŒä¸€ä¸ªå·¥ä½œçº¿ç¨‹ MySQL 5.6 ç‰ˆæœ¬çš„ç­–ç•¥ï¼šæ¯ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ª hash è¡¨ï¼Œç”¨äºä¿å­˜å½“å‰è¿™ä¸ªçº¿ç¨‹çš„æ‰§è¡Œé˜Ÿåˆ—é‡Œçš„äº‹åŠ¡æ‰€æ¶‰åŠçš„è¡¨ï¼Œhash è¡¨çš„ key æ˜¯æ•°æ®åº“åï¼Œvalue æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œè¡¨ç¤ºé˜Ÿåˆ—ä¸­æœ‰å¤šå°‘ä¸ªäº‹åŠ¡ä¿®æ”¹è¿™ä¸ªåº“ï¼Œé€‚ç”¨äºä¸»åº“ä¸Šæœ‰å¤šä¸ª DB çš„æƒ…å†µ æ¯ä¸ªäº‹åŠ¡åœ¨åˆ†å‘çš„æ—¶å€™ï¼Œè·Ÿçº¿ç¨‹çš„å†²çªï¼ˆäº‹åŠ¡æ“ä½œçš„æ˜¯åŒä¸€ä¸ªåº“ï¼‰å…³ç³»åŒ…æ‹¬ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š å¦‚æœè·Ÿæ‰€æœ‰çº¿ç¨‹éƒ½ä¸å†²çªï¼Œcoordinator çº¿ç¨‹å°±ä¼šæŠŠè¿™ä¸ªäº‹åŠ¡åˆ†é…ç»™æœ€ç©ºé—²çš„çº¿ç¨‹ å¦‚æœåªè·Ÿä¸€ä¸ªçº¿ç¨‹å†²çªï¼Œcoordinator çº¿ç¨‹å°±ä¼šæŠŠè¿™ä¸ªäº‹åŠ¡åˆ†é…ç»™è¿™ä¸ªå­˜åœ¨å†²çªå…³ç³»çš„çº¿ç¨‹ å¦‚æœè·Ÿå¤šäºä¸€ä¸ªçº¿ç¨‹å†²çªï¼Œcoordinator çº¿ç¨‹å°±è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°å’Œè¿™ä¸ªäº‹åŠ¡å­˜åœ¨å†²çªå…³ç³»çš„çº¿ç¨‹åªå‰©ä¸‹ 1 ä¸ª ä¼˜ç¼ºç‚¹ï¼š æ„é€  hash å€¼çš„æ—¶å€™å¾ˆå¿«ï¼Œåªéœ€è¦åº“åï¼Œè€Œä¸”ä¸€ä¸ªå®ä¾‹ä¸Š DB æ•°ä¹Ÿä¸ä¼šå¾ˆå¤šï¼Œä¸ä¼šå‡ºç°éœ€è¦æ„é€ å¾ˆå¤šé¡¹çš„æƒ…å†µ ä¸è¦æ±‚ binlog çš„æ ¼å¼ï¼Œstatement æ ¼å¼çš„ binlog ä¹Ÿå¯ä»¥å¾ˆå®¹æ˜“æ‹¿åˆ°åº“åï¼ˆæ—¥å¿—ç« èŠ‚è¯¦è§£äº† binlogï¼‰ ä¸»åº“ä¸Šçš„è¡¨éƒ½æ”¾åœ¨åŒä¸€ä¸ª DB é‡Œé¢ï¼Œè¿™ä¸ªç­–ç•¥å°±æ²¡æœ‰æ•ˆæœäº†ï¼›æˆ–è€…ä¸åŒ DB çš„çƒ­ç‚¹ä¸åŒï¼Œæ¯”å¦‚ä¸€ä¸ªæ˜¯ä¸šåŠ¡é€»è¾‘åº“ï¼Œä¸€ä¸ªæ˜¯ç³»ç»Ÿé…ç½®åº“ï¼Œé‚£ä¹Ÿèµ·ä¸åˆ°å¹¶è¡Œçš„æ•ˆæœï¼Œéœ€è¦æŠŠç›¸åŒçƒ­åº¦çš„è¡¨å‡åŒ€åˆ†åˆ°è¿™äº›ä¸åŒçš„ DB ä¸­ï¼Œæ‰å¯ä»¥ä½¿ç”¨è¿™ä¸ªç­–ç•¥ MySQL5.7MySQL 5.7 ç”±å‚æ•° slave-parallel-type æ¥æ§åˆ¶å¹¶è¡Œå¤åˆ¶ç­–ç•¥ï¼š é…ç½®ä¸º DATABASEï¼Œè¡¨ç¤ºä½¿ç”¨ MySQL 5.6 ç‰ˆæœ¬çš„æŒ‰åº“ï¼ˆDBï¼‰å¹¶è¡Œç­–ç•¥ é…ç½®ä¸º LOGICAL_CLOCKï¼Œè¡¨ç¤ºçš„æŒ‰æäº¤çŠ¶æ€å¹¶è¡Œæ‰§è¡Œ æŒ‰æäº¤çŠ¶æ€å¹¶è¡Œå¤åˆ¶ç­–ç•¥çš„æ€æƒ³æ˜¯ï¼š æ‰€æœ‰å¤„äº commit çŠ¶æ€çš„äº‹åŠ¡å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼›åŒæ—¶å¤„äº prepare çŠ¶æ€çš„äº‹åŠ¡ï¼Œåœ¨ä»åº“æ‰§è¡Œæ—¶æ˜¯å¯ä»¥å¹¶è¡Œçš„ å¤„äº prepare çŠ¶æ€çš„äº‹åŠ¡ï¼Œä¸å¤„äº commit çŠ¶æ€çš„äº‹åŠ¡ä¹‹é—´ï¼Œåœ¨ä»åº“æ‰§è¡Œæ—¶ä¹Ÿæ˜¯å¯ä»¥å¹¶è¡Œçš„ MySQL 5.7.22 ç‰ˆæœ¬é‡Œï¼ŒMySQL å¢åŠ äº†ä¸€ä¸ªæ–°çš„å¹¶è¡Œå¤åˆ¶ç­–ç•¥ï¼ŒåŸºäº WRITESET çš„å¹¶è¡Œå¤åˆ¶ï¼Œæ–°å¢äº†ä¸€ä¸ªå‚æ•° binlog-transaction-dependency-trackingï¼Œç”¨æ¥æ§åˆ¶æ˜¯å¦å¯ç”¨è¿™ä¸ªæ–°ç­–ç•¥ï¼š COMMIT_ORDERï¼šè¡¨ç¤ºæ ¹æ®åŒæ—¶è¿›å…¥ prepare å’Œ commit æ¥åˆ¤æ–­æ˜¯å¦å¯ä»¥å¹¶è¡Œçš„ç­–ç•¥ WRITESETï¼šè¡¨ç¤ºçš„æ˜¯å¯¹äºæ¯ä¸ªäº‹åŠ¡æ¶‰åŠæ›´æ–°çš„æ¯ä¸€è¡Œï¼Œè®¡ç®—å‡ºè¿™ä¸€è¡Œçš„ hash å€¼ï¼Œç»„æˆè¯¥äº‹åŠ¡çš„ writeset é›†åˆï¼Œå¦‚æœä¸¤ä¸ªäº‹åŠ¡æ²¡æœ‰æ“ä½œç›¸åŒçš„è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä»¬çš„ writeset æ²¡æœ‰äº¤é›†ï¼Œå°±å¯ä»¥å¹¶è¡Œï¼ˆæŒ‰è¡Œå¹¶è¡Œï¼‰ ä¸ºäº†å”¯ä¸€æ ‡è¯†ï¼Œè¿™ä¸ª hash è¡¨çš„å€¼æ˜¯é€šè¿‡ åº“å + è¡¨å + ç´¢å¼•å + å€¼ï¼ˆè¡¨ç¤ºçš„æ˜¯æŸä¸€è¡Œï¼‰è®¡ç®—å‡ºæ¥çš„ WRITESET_SESSIONï¼šæ˜¯åœ¨ WRITESET çš„åŸºç¡€ä¸Šå¤šäº†ä¸€ä¸ªçº¦æŸï¼Œå³åœ¨ä¸»åº“ä¸ŠåŒä¸€ä¸ªçº¿ç¨‹å…ˆåæ‰§è¡Œçš„ä¸¤ä¸ªäº‹åŠ¡ï¼Œåœ¨å¤‡åº“æ‰§è¡Œçš„æ—¶å€™ï¼Œè¦ä¿è¯ç›¸åŒçš„å…ˆåé¡ºåº MySQL 5.7.22 æŒ‰è¡Œå¹¶å‘çš„ä¼˜åŠ¿ï¼š writeset æ˜¯åœ¨ä¸»åº“ç”Ÿæˆåç›´æ¥å†™å…¥åˆ° binlog é‡Œé¢çš„ï¼Œè¿™æ ·åœ¨å¤‡åº“æ‰§è¡Œçš„æ—¶å€™ï¼Œä¸éœ€è¦è§£æ binlog å†…å®¹ï¼ŒèŠ‚çœäº†è®¡ç®—é‡ ä¸éœ€è¦æŠŠæ•´ä¸ªäº‹åŠ¡çš„ binlog éƒ½æ‰«ä¸€éæ‰èƒ½å†³å®šåˆ†å‘åˆ°å“ªä¸ªçº¿ç¨‹ï¼Œæ›´çœå†…å­˜ ä»åº“çš„åˆ†å‘ç­–ç•¥ä¸ä¾èµ–äº binlog å†…å®¹ï¼Œæ‰€ä»¥ binlog æ˜¯ statement æ ¼å¼ä¹Ÿå¯ä»¥ï¼Œæ›´èŠ‚çº¦å†…å­˜ï¼ˆå› ä¸º row æ‰è®°å½•æ›´æ”¹çš„è¡Œï¼‰ MySQL 5.7.22 çš„å¹¶è¡Œå¤åˆ¶ç­–ç•¥åœ¨é€šç”¨æ€§ä¸Šæ˜¯æœ‰ä¿è¯çš„ï¼Œä½†æ˜¯å¯¹äºè¡¨ä¸Šæ²¡ä¸»é”®ã€å”¯ä¸€å’Œå¤–é”®çº¦æŸçš„åœºæ™¯ï¼ŒWRITESET ç­–ç•¥ä¹Ÿæ˜¯æ²¡æ³•å¹¶è¡Œçš„ï¼Œä¹Ÿä¼šæš‚æ—¶é€€åŒ–ä¸ºå•çº¿ç¨‹æ¨¡å‹ å‚è€ƒæ–‡ç« ï¼šhttps://time.geekbang.org/column/article/77083 è¯»å†™åˆ†ç¦»è¯»å†™å»¶è¿Ÿè¯»å†™åˆ†ç¦»ï¼šå¯ä»¥é™ä½ä¸»åº“çš„è®¿é—®å‹åŠ›ï¼Œæé«˜ç³»ç»Ÿçš„å¹¶å‘èƒ½åŠ› ä¸»åº“ä¸å»ºæŸ¥è¯¢çš„ç´¢å¼•ï¼Œä»åº“å»ºæŸ¥è¯¢çš„ç´¢å¼•ã€‚å› ä¸ºç´¢å¼•éœ€è¦ç»´æŠ¤çš„ï¼Œæ¯”å¦‚æ’å…¥ä¸€æ¡æ•°æ®ï¼Œä¸ä»…è¦åœ¨èšç°‡ç´¢å¼•ä¸Šé¢æ’å…¥ï¼Œå¯¹åº”çš„äºŒçº§ç´¢å¼•ä¹Ÿå¾—æ’å…¥ å°†è¯»æ“ä½œåˆ†åˆ°ä»åº“äº†ä¹‹åï¼Œå¯ä»¥åœ¨ä¸»åº“æŠŠæŸ¥è¯¢è¦ç”¨çš„ç´¢å¼•åˆ äº†ï¼Œå‡å°‘å†™æ“ä½œå¯¹ä¸»åº“çš„å½±å“ è¯»å†™åˆ†ç¦»äº§ç”Ÿäº†è¯»å†™å»¶è¿Ÿï¼Œé€ æˆæ•°æ®çš„ä¸ä¸€è‡´æ€§ã€‚å‡å¦‚å®¢æˆ·ç«¯æ‰§è¡Œå®Œä¸€ä¸ªæ›´æ–°äº‹åŠ¡åé©¬ä¸Šå‘èµ·æŸ¥è¯¢ï¼Œå¦‚æœæŸ¥è¯¢é€‰æ‹©çš„æ˜¯ä»åº“çš„è¯ï¼Œå¯èƒ½è¯»åˆ°çš„è¿˜æ˜¯ä»¥å‰çš„æ•°æ®ï¼Œå«è¿‡æœŸè¯» è§£å†³æ–¹æ¡ˆï¼š å¼ºåˆ¶å°†å†™ä¹‹åç«‹åˆ»è¯»çš„æ“ä½œè½¬ç§»åˆ°ä¸»åº“ï¼Œæ¯”å¦‚åˆšæ³¨å†Œçš„ç”¨æˆ·ï¼Œç›´æ¥ç™»å½•ä»åº“æŸ¥è¯¢å¯èƒ½æŸ¥è¯¢ä¸åˆ°ï¼Œå…ˆèµ°ä¸»åº“ç™»å½• äºŒæ¬¡æŸ¥è¯¢ï¼Œå¦‚æœä»åº“æŸ¥ä¸åˆ°æ•°æ®ï¼Œåˆ™å†å»ä¸»åº“æŸ¥ä¸€éï¼Œç”± API å°è£…ï¼Œæ¯”è¾ƒç®€å•ï¼Œä½†å¯¼è‡´ä¸»åº“å‹åŠ›å¤§ æ›´æ–°ä¸»åº“åï¼Œè¯»ä»åº“ä¹‹å‰å…ˆ sleep ä¸€ä¸‹ï¼Œç±»ä¼¼äºæ‰§è¡Œä¸€æ¡ select sleep(1) å‘½ä»¤ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ä¸»å¤‡å»¶è¿Ÿåœ¨ 1 ç§’ä¹‹å†… ç¡®ä¿æœºåˆ¶æ— å»¶è¿Ÿç¡®ä¿ä¸»å¤‡æ— å»¶è¿Ÿçš„æ–¹æ³•ï¼š æ¯æ¬¡ä»åº“æ‰§è¡ŒæŸ¥è¯¢è¯·æ±‚å‰ï¼Œå…ˆåˆ¤æ–­ seconds_behind_master æ˜¯å¦å·²ç»ç­‰äº 0ï¼Œå¦‚æœä¸ç­‰äºé‚£å°±ç­‰åˆ°å‚æ•°å˜ä¸º 0 æ‰§è¡ŒæŸ¥è¯¢è¯·æ±‚ å¯¹æ¯”ä½ç‚¹ï¼ŒMaster_Log_File å’Œ Read_Master_Log_Pos è¡¨ç¤ºçš„æ˜¯è¯»åˆ°çš„ä¸»åº“çš„æœ€æ–°ä½ç‚¹ï¼ŒRelay_Master_Log_File å’Œ Exec_Master_Log_Pos è¡¨ç¤ºçš„æ˜¯å¤‡åº“æ‰§è¡Œçš„æœ€æ–°ä½ç‚¹ï¼Œè¿™ä¸¤ç»„å€¼å®Œå…¨ç›¸åŒå°±è¯´æ˜æ¥æ”¶åˆ°çš„æ—¥å¿—å·²ç»åŒæ­¥å®Œæˆ å¯¹æ¯” GTID é›†åˆï¼ŒRetrieved_Gtid_Set æ˜¯å¤‡åº“æ”¶åˆ°çš„æ‰€æœ‰æ—¥å¿—çš„ GTID é›†åˆï¼ŒExecuted_Gtid_Set æ˜¯å¤‡åº“æ‰€æœ‰å·²ç»æ‰§è¡Œå®Œæˆçš„ GTID é›†åˆï¼Œå¦‚æœè¿™ä¸¤ä¸ªé›†åˆç›¸åŒä¹Ÿè¡¨ç¤ºå¤‡åº“æ¥æ”¶åˆ°çš„æ—¥å¿—éƒ½å·²ç»åŒæ­¥å®Œæˆ åŠåŒæ­¥åŠåŒæ­¥å¤åˆ¶å°±æ˜¯ semi-sync replicationï¼Œé€‚ç”¨äºä¸€ä¸»ä¸€å¤‡çš„åœºæ™¯ï¼Œå·¥ä½œæµç¨‹ï¼š äº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œä¸»åº“æŠŠ binlog å‘ç»™ä»åº“ ä»åº“æ”¶åˆ° binlog ä»¥åï¼Œå‘å›ç»™ä¸»åº“ä¸€ä¸ª ackï¼Œè¡¨ç¤ºæ”¶åˆ°äº† ä¸»åº“æ”¶åˆ°è¿™ä¸ª ack ä»¥åï¼Œæ‰èƒ½ç»™å®¢æˆ·ç«¯è¿”å›äº‹åŠ¡å®Œæˆçš„ç¡®è®¤ åœ¨ä¸€ä¸»å¤šä»åœºæ™¯ä¸­ï¼Œä¸»åº“åªè¦ç­‰åˆ°ä¸€ä¸ªä»åº“çš„ ackï¼Œå°±å¼€å§‹ç»™å®¢æˆ·ç«¯è¿”å›ç¡®è®¤ï¼Œè¿™æ—¶åœ¨ä»åº“ä¸Šæ‰§è¡ŒæŸ¥è¯¢è¯·æ±‚ï¼Œæœ‰ä¸¤ç§æƒ…å†µï¼š å¦‚æœæŸ¥è¯¢æ˜¯è½åœ¨è¿™ä¸ªå“åº”äº† ack çš„ä»åº“ä¸Šï¼Œæ˜¯èƒ½å¤Ÿç¡®ä¿è¯»åˆ°æœ€æ–°æ•°æ® å¦‚æœæŸ¥è¯¢è½åˆ°å…¶ä»–ä»åº“ä¸Šï¼Œå®ƒä»¬å¯èƒ½è¿˜æ²¡æœ‰æ”¶åˆ°æœ€æ–°çš„æ—¥å¿—ï¼Œå°±ä¼šäº§ç”Ÿè¿‡æœŸè¯»çš„é—®é¢˜ åœ¨ä¸šåŠ¡æ›´æ–°çš„é«˜å³°æœŸï¼Œä¸»åº“çš„ä½ç‚¹æˆ–è€… GTID é›†åˆæ›´æ–°å¾ˆå¿«ï¼Œå¯¼è‡´ä»åº“æ¥ä¸åŠå¤„ç†ï¼Œé‚£ä¹ˆä¸¤ä¸ªä½ç‚¹ç­‰å€¼åˆ¤æ–­å°±ä¼šä¸€ç›´ä¸æˆç«‹ï¼Œå¾ˆå¯èƒ½å‡ºç°ä»åº“ä¸Šè¿Ÿè¿Ÿæ— æ³•å“åº”æŸ¥è¯¢è¯·æ±‚çš„æƒ…å†µ ç­‰ä½ç‚¹åœ¨ä»åº“æ‰§è¡Œåˆ¤æ–­ä½ç‚¹çš„å‘½ä»¤ï¼Œå‚æ•° file å’Œ pos æŒ‡çš„æ˜¯ä¸»åº“ä¸Šçš„æ–‡ä»¶åå’Œä½ç½®ï¼Œtimeout å¯é€‰ï¼Œè®¾ç½®ä¸ºæ­£æ•´æ•° N è¡¨ç¤ºæœ€å¤šç­‰å¾… N ç§’ 1SELECT master_pos_wait(file, pos[, timeout]); å‘½ä»¤æ­£å¸¸è¿”å›çš„ç»“æœæ˜¯ä¸€ä¸ªæ­£æ•´æ•° Mï¼Œè¡¨ç¤ºä»å‘½ä»¤å¼€å§‹æ‰§è¡Œï¼Œåˆ°åº”ç”¨å®Œ file å’Œ pos è¡¨ç¤ºçš„ binlog ä½ç½®ï¼Œæ‰§è¡Œäº†å¤šå°‘äº‹åŠ¡ å¦‚æœæ‰§è¡ŒæœŸé—´ï¼Œå¤‡åº“åŒæ­¥çº¿ç¨‹å‘ç”Ÿå¼‚å¸¸ï¼Œåˆ™è¿”å› NULL å¦‚æœç­‰å¾…è¶…è¿‡ N ç§’ï¼Œå°±è¿”å› -1 å¦‚æœåˆšå¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œå°±å‘ç°å·²ç»æ‰§è¡Œè¿‡è¿™ä¸ªä½ç½®äº†ï¼Œåˆ™è¿”å› 0 å·¥ä½œæµç¨‹ï¼šå…ˆæ‰§è¡Œ trx1ï¼Œå†æ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢è¯·æ±‚çš„é€»è¾‘ï¼Œè¦ä¿è¯èƒ½å¤ŸæŸ¥åˆ°æ­£ç¡®çš„æ•°æ® trx1 äº‹åŠ¡æ›´æ–°å®Œæˆåï¼Œé©¬ä¸Šæ‰§è¡Œ show master status å¾—åˆ°å½“å‰ä¸»åº“æ‰§è¡Œåˆ°çš„ File å’Œ Position é€‰å®šä¸€ä¸ªä»åº“æ‰§è¡Œåˆ¤æ–­ä½ç‚¹è¯­å¥ï¼Œå¦‚æœè¿”å›å€¼æ˜¯ &gt;&#x3D;0 çš„æ­£æ•´æ•°ï¼Œè¯´æ˜ä»åº“å·²ç»åŒæ­¥å®Œäº‹åŠ¡ï¼Œå¯ä»¥åœ¨è¿™ä¸ªä»åº“æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ å¦‚æœå‡ºç°å…¶ä»–æƒ…å†µï¼Œéœ€è¦åˆ°ä¸»åº“æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ æ³¨æ„ï¼šå¦‚æœæ‰€æœ‰çš„ä»åº“éƒ½å»¶è¿Ÿè¶…è¿‡ timeout ç§’ï¼ŒæŸ¥è¯¢å‹åŠ›å°±éƒ½è·‘åˆ°ä¸»åº“ä¸Šï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œæƒè¡¡ ç­‰GTIDæ•°æ®åº“å¼€å¯äº† GTID æ¨¡å¼ï¼ŒMySQL æä¾›äº†åˆ¤æ–­ GTID çš„å‘½ä»¤ 1SELECT wait_for_executed_gtid_set(gtid_set [, timeout]) ç­‰å¾…ç›´åˆ°è¿™ä¸ªåº“æ‰§è¡Œçš„äº‹åŠ¡ä¸­åŒ…å«ä¼ å…¥çš„ gtid_setï¼Œè¿”å› 0 è¶…æ—¶è¿”å› 1 å·¥ä½œæµç¨‹ï¼šå…ˆæ‰§è¡Œ trx1ï¼Œå†æ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢è¯·æ±‚çš„é€»è¾‘ï¼Œè¦ä¿è¯èƒ½å¤ŸæŸ¥åˆ°æ­£ç¡®çš„æ•°æ® trx1 äº‹åŠ¡æ›´æ–°å®Œæˆåï¼Œä»è¿”å›åŒ…ç›´æ¥è·å–è¿™ä¸ªäº‹åŠ¡çš„ GTIDï¼Œè®°ä¸º gtid é€‰å®šä¸€ä¸ªä»åº“æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ï¼Œå¦‚æœè¿”å›å€¼æ˜¯ 0ï¼Œåˆ™åœ¨è¿™ä¸ªä»åº“æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ï¼Œå¦åˆ™åˆ°ä¸»åº“æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ å¯¹æ¯”ç­‰å¾…ä½ç‚¹æ–¹æ³•ï¼Œå‡å°‘äº†ä¸€æ¬¡ show master status çš„æ–¹æ³•ï¼Œå°†å‚æ•° session_track_gtids è®¾ç½®ä¸º OWN_GTIDï¼Œç„¶åé€šè¿‡ API æ¥å£ mysql_session_track_get_first ä»è¿”å›åŒ…è§£æå‡º GTID çš„å€¼å³å¯ æ€»ç»“ï¼šæ‰€æœ‰çš„ç­‰å¾…æ— å»¶è¿Ÿçš„æ–¹æ³•ï¼Œéƒ½éœ€è¦æ ¹æ®å…·ä½“çš„ä¸šåŠ¡åœºæ™¯å»åˆ¤æ–­å®æ–½ å‚è€ƒæ–‡ç« ï¼šhttps://time.geekbang.org/column/article/77636 è´Ÿè½½å‡è¡¡è´Ÿè½½å‡è¡¡æ˜¯åº”ç”¨ä¸­ä½¿ç”¨éå¸¸æ™®éçš„ä¸€ç§ä¼˜åŒ–æ–¹æ³•ï¼Œæœºåˆ¶å°±æ˜¯åˆ©ç”¨æŸç§å‡è¡¡ç®—æ³•ï¼Œå°†å›ºå®šçš„è´Ÿè½½é‡åˆ†å¸ƒåˆ°ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œä»¥æ­¤æ¥é™ä½å•å°æœåŠ¡å™¨çš„è´Ÿè½½ï¼Œè¾¾åˆ°ä¼˜åŒ–çš„æ•ˆæœ åˆ†æµæŸ¥è¯¢ï¼šé€šè¿‡ MySQL çš„ä¸»ä»å¤åˆ¶ï¼Œå®ç°è¯»å†™åˆ†ç¦»ï¼Œä½¿å¢åˆ æ”¹æ“ä½œèµ°ä¸»èŠ‚ç‚¹ï¼ŒæŸ¥è¯¢æ“ä½œèµ°ä»èŠ‚ç‚¹ï¼Œä»è€Œå¯ä»¥é™ä½å•å°æœåŠ¡å™¨çš„è¯»å†™å‹åŠ› åˆ†å¸ƒå¼æ•°æ®åº“æ¶æ„ï¼šé€‚åˆå¤§æ•°æ®é‡ã€è´Ÿè½½é«˜çš„æƒ…å†µï¼Œå…·æœ‰è‰¯å¥½çš„æ‹“å±•æ€§å’Œé«˜å¯ç”¨æ€§ã€‚é€šè¿‡åœ¨å¤šå°æœåŠ¡å™¨ä¹‹é—´åˆ†å¸ƒæ•°æ®ï¼Œå¯ä»¥å®ç°åœ¨å¤šå°æœåŠ¡å™¨ä¹‹é—´çš„è´Ÿè½½å‡è¡¡ï¼Œæé«˜è®¿é—®æ•ˆç‡ ä¸»ä»æ­å»ºmaster åœ¨master çš„é…ç½®æ–‡ä»¶ï¼ˆ&#x2F;etc&#x2F;mysql&#x2F;my.cnfï¼‰ä¸­ï¼Œé…ç½®å¦‚ä¸‹å†…å®¹ï¼š 1234567891011121314151617181920212223242526#mysql æœåŠ¡ID,ä¿è¯æ•´ä¸ªé›†ç¾¤ç¯å¢ƒä¸­å”¯ä¸€server-id=1#mysql binlog æ—¥å¿—çš„å­˜å‚¨è·¯å¾„å’Œæ–‡ä»¶ålog-bin=/var/lib/mysql/mysqlbin#é”™è¯¯æ—¥å¿—,é»˜è®¤å·²ç»å¼€å¯#log-err#mysqlçš„å®‰è£…ç›®å½•#basedir#mysqlçš„ä¸´æ—¶ç›®å½•#tmpdir#mysqlçš„æ•°æ®å­˜æ”¾ç›®å½•#datadir#æ˜¯å¦åªè¯»,1 ä»£è¡¨åªè¯», 0 ä»£è¡¨è¯»å†™read-only=0#å¿½ç•¥çš„æ•°æ®, æŒ‡ä¸éœ€è¦åŒæ­¥çš„æ•°æ®åº“binlog-ignore-db=mysql#æŒ‡å®šåŒæ­¥çš„æ•°æ®åº“#binlog-do-db=db01 æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œéœ€è¦é‡å¯ MySQL åˆ›å»ºåŒæ­¥æ•°æ®çš„è´¦æˆ·ï¼Œå¹¶ä¸”è¿›è¡Œæˆæƒæ“ä½œï¼š 12GRANT REPLICATION SLAVE ON *.* TO &#x27;seazean&#x27;@&#x27;192.168.0.137&#x27; IDENTIFIED BY &#x27;123456&#x27;;FLUSH PRIVILEGES; æŸ¥çœ‹ master çŠ¶æ€ï¼š 1SHOW MASTER STATUS; Fileï¼šä»å“ªä¸ªæ—¥å¿—æ–‡ä»¶å¼€å§‹æ¨é€æ—¥å¿—æ–‡ä»¶ Positionï¼šä»å“ªä¸ªä½ç½®å¼€å§‹æ¨é€æ—¥å¿— Binlog_Ignore_DBï¼šæŒ‡å®šä¸éœ€è¦åŒæ­¥çš„æ•°æ®åº“ slave åœ¨ slave ç«¯é…ç½®æ–‡ä»¶ä¸­ï¼Œé…ç½®å¦‚ä¸‹å†…å®¹ï¼š 12345#mysqlæœåŠ¡ç«¯ID,å”¯ä¸€server-id=2#æŒ‡å®šbinlogæ—¥å¿—log-bin=/var/lib/mysql/mysqlbin æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œéœ€è¦é‡å¯ MySQL æŒ‡å®šå½“å‰ä»åº“å¯¹åº”çš„ä¸»åº“çš„IPåœ°å€ã€ç”¨æˆ·åã€å¯†ç ï¼Œä»å“ªä¸ªæ—¥å¿—æ–‡ä»¶å¼€å§‹çš„é‚£ä¸ªä½ç½®å¼€å§‹åŒæ­¥æ¨é€æ—¥å¿— 1CHANGE MASTER TO MASTER_HOST= &#x27;192.168.0.138&#x27;, MASTER_USER=&#x27;seazean&#x27;, MASTER_PASSWORD=&#x27;seazean&#x27;, MASTER_LOG_FILE=&#x27;mysqlbin.000001&#x27;, MASTER_LOG_POS=413; å¼€å¯åŒæ­¥æ“ä½œï¼š 12START SLAVE;SHOW SLAVE STATUS; åœæ­¢åŒæ­¥æ“ä½œï¼š 1STOP SLAVE; éªŒè¯ åœ¨ä¸»åº“ä¸­åˆ›å»ºæ•°æ®åº“ï¼Œåˆ›å»ºè¡¨å¹¶æ’å…¥æ•°æ®ï¼š 123456789101112CREATE DATABASE db01;USE db01;CREATE TABLE user( id INT(11) NOT NULL AUTO_INCREMENT, name VARCHAR(50) NOT NULL, sex VARCHAR(1), PRIMARY KEY (id))ENGINE=INNODB DEFAULT CHARSET=utf8;INSERT INTO user(id,NAME,sex) VALUES(NULL,&#x27;Tom&#x27;,&#x27;1&#x27;);INSERT INTO user(id,NAME,sex) VALUES(NULL,&#x27;Trigger&#x27;,&#x27;0&#x27;);INSERT INTO user(id,NAME,sex) VALUES(NULL,&#x27;Dawn&#x27;,&#x27;1&#x27;); åœ¨ä»åº“ä¸­æŸ¥è¯¢æ•°æ®ï¼Œè¿›è¡ŒéªŒè¯ï¼š åœ¨ä»åº“ä¸­ï¼Œå¯ä»¥æŸ¥çœ‹åˆ°åˆšæ‰åˆ›å»ºçš„æ•°æ®åº“ï¼š åœ¨è¯¥æ•°æ®åº“ä¸­ï¼ŒæŸ¥è¯¢è¡¨ä¸­çš„æ•°æ®ï¼š ä¸»ä»åˆ‡æ¢æ­£å¸¸åˆ‡æ¢æ­£å¸¸åˆ‡æ¢æ­¥éª¤ï¼š åœ¨å¼€å§‹åˆ‡æ¢ä¹‹å‰å…ˆå¯¹ä¸»åº“è¿›è¡Œé”è¡¨ flush tables with read lockï¼Œç„¶åç­‰å¾…æ‰€æœ‰è¯­å¥æ‰§è¡Œå®Œæˆï¼Œåˆ‡æ¢å®Œæˆåå¯ä»¥é‡Šæ”¾é” æ£€æŸ¥ slave åŒæ­¥çŠ¶æ€ï¼Œåœ¨ slave æ‰§è¡Œ show processlist åœæ­¢ slave io çº¿ç¨‹ï¼Œæ‰§è¡Œå‘½ä»¤ STOP SLAVE IO_THREAD æå‡ slave ä¸º master 1234Stop slave;Reset master;Reset slave all;set global read_only=off; -- è®¾ç½®ä¸ºå¯æ›´æ–°çŠ¶æ€ å°†åŸæ¥ master å˜ä¸º slaveï¼ˆå‚è€ƒæ­å»ºæµç¨‹ä¸­çš„ slave æ–¹æ³•ï¼‰ å¯é æ€§ä¼˜å…ˆç­–ç•¥ï¼š åˆ¤æ–­å¤‡åº“ B ç°åœ¨çš„ seconds_behind_masterï¼Œå¦‚æœå°äºæŸä¸ªå€¼ï¼ˆæ¯”å¦‚ 5 ç§’ï¼‰ç»§ç»­ä¸‹ä¸€æ­¥ï¼Œå¦åˆ™æŒç»­é‡è¯•è¿™ä¸€æ­¥ æŠŠä¸»åº“ A æ”¹æˆåªè¯»çŠ¶æ€ï¼Œå³æŠŠ readonly è®¾ç½®ä¸º true åˆ¤æ–­å¤‡åº“ B çš„ seconds_behind_master çš„å€¼ï¼Œç›´åˆ°è¿™ä¸ªå€¼å˜æˆ 0 ä¸ºæ­¢ï¼ˆè¯¥æ­¥éª¤æ¯”è¾ƒè€—æ—¶ï¼Œæ‰€ä»¥æ­¥éª¤ 1 ä¸­è¦å°½é‡ç­‰å¾…è¯¥å€¼å˜å°ï¼‰ æŠŠå¤‡åº“ B æ”¹æˆå¯è¯»å†™çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯æŠŠ readonly è®¾ç½®ä¸º false æŠŠä¸šåŠ¡è¯·æ±‚åˆ‡åˆ°å¤‡åº“ B å¯ç”¨æ€§ä¼˜å…ˆç­–ç•¥ï¼šå…ˆåšæœ€åä¸¤æ­¥ï¼Œä¼šé€ æˆä¸»å¤‡æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ å‚è€ƒæ–‡ç« ï¼šhttps://time.geekbang.org/column/article/76795 å¥åº·æ£€æµ‹ä¸»åº“å‘ç”Ÿæ•…éšœåä»åº“ä¼šä¸Šä½ï¼Œå…¶ä»–ä»åº“æŒ‡å‘æ–°çš„ä¸»åº“ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªå¥åº·æ£€æµ‹çš„æœºåˆ¶æ¥åˆ¤æ–­ä¸»åº“æ˜¯å¦å®•æœº select 1 åˆ¤æ–­ï¼Œä½†æ˜¯é«˜å¹¶å‘ä¸‹æ£€æµ‹ä¸å‡ºçº¿ç¨‹çš„é”ç­‰å¾…çš„é˜»å¡é—®é¢˜ æŸ¥è¡¨åˆ¤æ–­ï¼Œåœ¨ç³»ç»Ÿåº“ï¼ˆmysql åº“ï¼‰é‡Œåˆ›å»ºä¸€ä¸ªè¡¨ï¼Œæ¯”å¦‚å‘½åä¸º health_checkï¼Œé‡Œé¢åªæ”¾ä¸€è¡Œæ•°æ®ï¼Œç„¶åå®šæœŸæ‰§è¡Œã€‚ä½†æ˜¯å½“ binlog æ‰€åœ¨ç£ç›˜çš„ç©ºé—´å ç”¨ç‡è¾¾åˆ° 100%ï¼Œæ‰€æœ‰çš„æ›´æ–°å’Œäº‹åŠ¡æäº¤è¯­å¥éƒ½è¢«é˜»å¡ï¼ŒæŸ¥è¯¢è¯­å¥å¯ä»¥ç»§ç»­è¿è¡Œ æ›´æ–°åˆ¤æ–­ï¼Œåœ¨å¥åº·æ£€æµ‹è¡¨ä¸­æ”¾ä¸€ä¸ª timestamp å­—æ®µï¼Œç”¨æ¥è¡¨ç¤ºæœ€åä¸€æ¬¡æ‰§è¡Œæ£€æµ‹çš„æ—¶é—´ 1UPDATE mysql.health_check SET t_modified=now(); èŠ‚ç‚¹å¯ç”¨æ€§çš„æ£€æµ‹éƒ½åº”è¯¥åŒ…å«ä¸»åº“å’Œå¤‡åº“ï¼Œä¸ºäº†è®©ä¸»å¤‡ä¹‹é—´çš„æ›´æ–°ä¸äº§ç”Ÿå†²çªï¼Œå¯ä»¥åœ¨ mysql.health_check è¡¨ä¸Šå­˜å…¥å¤šè¡Œæ•°æ®ï¼Œå¹¶ç”¨ä¸»å¤‡çš„ server_id åšä¸»é”®ï¼Œä¿è¯ä¸»ã€å¤‡åº“å„è‡ªçš„æ£€æµ‹å‘½ä»¤ä¸ä¼šå‘ç”Ÿå†²çª åŸºäºä½ç‚¹ä¸»åº“ä¸Šä½åï¼Œä»åº“ B æ‰§è¡Œ CHANGE MASTER TO å‘½ä»¤ï¼ŒæŒ‡å®š MASTER_LOG_FILEã€MASTER_LOG_POS è¡¨ç¤ºä»æ–°ä¸»åº“ A çš„å“ªä¸ªæ–‡ä»¶çš„å“ªä¸ªä½ç‚¹å¼€å§‹åŒæ­¥ï¼Œè¿™ä¸ªä½ç½®å°±æ˜¯åŒæ­¥ä½ç‚¹ï¼Œå¯¹åº”ä¸»åº“çš„æ–‡ä»¶åå’Œæ—¥å¿—åç§»é‡ å¯»æ‰¾ä½ç‚¹éœ€è¦æ‰¾ä¸€ä¸ªç¨å¾®å¾€å‰çš„ï¼Œç„¶åå†é€šè¿‡åˆ¤æ–­è·³è¿‡é‚£äº›åœ¨ä»åº“ B ä¸Šå·²ç»æ‰§è¡Œè¿‡çš„äº‹åŠ¡ï¼Œè·å–ä½ç‚¹æ–¹æ³•ï¼š ç­‰å¾…æ–°ä¸»åº“ A æŠŠä¸­è½¬æ—¥å¿—ï¼ˆrelay logï¼‰å…¨éƒ¨åŒæ­¥å®Œæˆ åœ¨ A ä¸Šæ‰§è¡Œ show master status å‘½ä»¤ï¼Œå¾—åˆ°å½“å‰ A ä¸Šæœ€æ–°çš„ File å’Œ Position å–åŸä¸»åº“æ•…éšœçš„æ—¶åˆ» Tï¼Œç”¨ mysqlbinlog å·¥å…·è§£ææ–°ä¸»åº“ A çš„ Fileï¼Œå¾—åˆ° T æ—¶åˆ»çš„ä½ç‚¹ é€šå¸¸æƒ…å†µä¸‹è¯¥å€¼å¹¶ä¸å‡†ç¡®ï¼Œåœ¨åˆ‡æ¢çš„è¿‡ç¨‹ä¸­ä¼šå‘ç”Ÿé”™è¯¯ï¼Œæ‰€ä»¥è¦å…ˆä¸»åŠ¨è·³è¿‡è¿™äº›é”™è¯¯ï¼š åˆ‡æ¢è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šé‡å¤æ‰§è¡Œä¸€ä¸ªäº‹åŠ¡ï¼Œæ‰€ä»¥éœ€è¦ä¸»åŠ¨è·³è¿‡æ‰€æœ‰é‡å¤çš„äº‹åŠ¡ 12SET GLOBAL sql_slave_skip_counter=1;START SLAVE; è®¾ç½® slave_skip_errors å‚æ•°ï¼Œç›´æ¥è®¾ç½®è·³è¿‡æŒ‡å®šçš„é”™è¯¯ï¼Œä¿è¯ä¸»ä»åˆ‡æ¢çš„æ­£å¸¸è¿›è¡Œ 1062 é”™è¯¯æ˜¯æ’å…¥æ•°æ®æ—¶å”¯ä¸€é”®å†²çª 1032 é”™è¯¯æ˜¯åˆ é™¤æ•°æ®æ—¶æ‰¾ä¸åˆ°è¡Œ è¯¥æ–¹æ³•é’ˆå¯¹çš„æ˜¯ä¸»å¤‡åˆ‡æ¢æ—¶ï¼Œç”±äºæ‰¾ä¸åˆ°ç²¾ç¡®çš„åŒæ­¥ä½ç‚¹ï¼Œåªèƒ½é‡‡ç”¨è¿™ç§æ–¹æ³•æ¥åˆ›å»ºä»åº“å’Œæ–°ä¸»åº“çš„ä¸»å¤‡å…³ç³»ã€‚ç­‰åˆ°ä¸»å¤‡é—´çš„åŒæ­¥å…³ç³»å»ºç«‹å®Œæˆå¹¶ç¨³å®šæ‰§è¡Œä¸€æ®µæ—¶é—´åï¼Œè¿˜éœ€è¦æŠŠè¿™ä¸ªå‚æ•°è®¾ç½®ä¸ºç©ºï¼Œä»¥å…çœŸçš„å‡ºç°äº†ä¸»ä»æ•°æ®ä¸ä¸€è‡´ä¹Ÿè·³è¿‡äº† åŸºäºGTIDGTIDGTID çš„å…¨ç§°æ˜¯ Global Transaction Identifierï¼Œå…¨å±€äº‹åŠ¡ IDï¼Œæ˜¯ä¸€ä¸ªäº‹åŠ¡åœ¨æäº¤æ—¶ç”Ÿæˆçš„ï¼Œæ˜¯è¿™ä¸ªäº‹åŠ¡çš„å”¯ä¸€æ ‡è¯†ï¼Œç»„æˆï¼š 1GTID=source_id:transaction_id source_idï¼šæ˜¯ä¸€ä¸ªå®ä¾‹ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œæ˜¯ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„å€¼ transaction_idï¼šåˆå§‹å€¼æ˜¯ 1ï¼Œæ¯æ¬¡æäº¤äº‹åŠ¡çš„æ—¶å€™åˆ†é…ç»™è¿™ä¸ªäº‹åŠ¡ï¼Œå¹¶åŠ  1ï¼Œæ˜¯è¿ç»­çš„ï¼ˆåŒºåˆ†äº‹åŠ¡ IDï¼Œäº‹åŠ¡ ID æ˜¯åœ¨æ‰§è¡Œæ—¶ç”Ÿæˆï¼‰ å¯åŠ¨ MySQL å®ä¾‹æ—¶ï¼ŒåŠ ä¸Šå‚æ•° gtid_mode=on å’Œ enforce_gtid_consistency=on å°±å¯ä»¥å¯åŠ¨ GTID æ¨¡å¼ï¼Œæ¯ä¸ªäº‹åŠ¡éƒ½ä¼šå’Œä¸€ä¸ª GTID ä¸€ä¸€å¯¹åº”ï¼Œæ¯ä¸ª MySQL å®ä¾‹éƒ½ç»´æŠ¤äº†ä¸€ä¸ª GTID é›†åˆï¼Œç”¨æ¥å­˜å‚¨å½“å‰å®ä¾‹æ‰§è¡Œè¿‡çš„æ‰€æœ‰äº‹åŠ¡ GTID æœ‰ä¸¤ç§ç”Ÿæˆæ–¹å¼ï¼Œä½¿ç”¨å“ªç§æ–¹å¼å–å†³äº session å˜é‡ gtid_nextï¼š gtid_next=automaticï¼šä½¿ç”¨é»˜è®¤å€¼ï¼ŒæŠŠ source_id:transaction_id ï¼ˆé€’å¢ï¼‰åˆ†é…ç»™è¿™ä¸ªäº‹åŠ¡ï¼Œç„¶ååŠ å…¥æœ¬å®ä¾‹çš„ GTID é›†åˆ 1@@SESSION.GTID_NEXT = &#x27;source_id:transaction_id&#x27;; gtid_next=GTIDï¼šæŒ‡å®šçš„ GTID çš„å€¼ï¼Œå¦‚æœè¯¥å€¼å·²ç»å­˜åœ¨äºå®ä¾‹çš„ GTID é›†åˆä¸­ï¼Œæ¥ä¸‹æ¥æ‰§è¡Œçš„äº‹åŠ¡ä¼šç›´æ¥è¢«ç³»ç»Ÿå¿½ç•¥ï¼›åä¹‹å°±å°†è¯¥å€¼åˆ†é…ç»™æ¥ä¸‹æ¥è¦æ‰§è¡Œçš„äº‹åŠ¡ï¼Œç³»ç»Ÿä¸éœ€è¦ç»™è¿™ä¸ªäº‹åŠ¡ç”Ÿæˆæ–°çš„ GTIDï¼Œä¹Ÿä¸ç”¨åŠ  1 æ³¨æ„ï¼šä¸€ä¸ª GTID åªèƒ½ç»™ä¸€ä¸ªäº‹åŠ¡ä½¿ç”¨ï¼Œæ‰€ä»¥æ‰§è¡Œä¸‹ä¸€ä¸ªäº‹åŠ¡ï¼Œè¦æŠŠ gtid_next è®¾ç½®æˆå¦å¤–ä¸€ä¸ª GTID æˆ–è€… automatic ä¸šåŠ¡åœºæ™¯ï¼š ä¸»åº“ X å’Œä»åº“ Y æ‰§è¡Œä¸€æ¡ç›¸åŒçš„æŒ‡ä»¤åè¿›è¡Œäº‹åŠ¡åŒæ­¥ 1INSERT INTO t VALUES(1,1); å½“ Y åŒæ­¥ X æ—¶ï¼Œä¼šå‡ºç°ä¸»é”®å†²çªï¼Œå¯¼è‡´å®ä¾‹ X çš„åŒæ­¥çº¿ç¨‹åœæ­¢ï¼Œè§£å†³æ–¹æ³•ï¼š 12345SET gtid_next=&#x27;(è¿™é‡Œæ˜¯ä¸»åº“ X çš„ GTID å€¼)&#x27;;BEGIN;COMMIT;SET gtid_next=automatic;START SLAVE; å‰ä¸‰æ¡è¯­å¥é€šè¿‡æäº¤ä¸€ä¸ªç©ºäº‹åŠ¡ï¼ŒæŠŠ X çš„ GTID åŠ åˆ°å®ä¾‹ Y çš„ GTID é›†åˆä¸­ï¼Œå®ä¾‹ Y å°±ä¼šç›´æ¥è·³è¿‡è¿™ä¸ªäº‹åŠ¡ åˆ‡æ¢åœ¨ GTID æ¨¡å¼ä¸‹ï¼ŒCHANGE MASTER TO ä¸éœ€è¦æŒ‡å®šæ—¥å¿—åå’Œæ—¥å¿—åç§»é‡ï¼ŒæŒ‡å®š master_auto_position=1 ä»£è¡¨ä½¿ç”¨ GTID æ¨¡å¼ æ–°ä¸»åº“å®ä¾‹ A çš„ GTID é›†åˆè®°ä¸º set_aï¼Œä»åº“å®ä¾‹ B çš„ GTID é›†åˆè®°ä¸º set_bï¼Œä¸»å¤‡åˆ‡æ¢é€»è¾‘ï¼š å®ä¾‹ B æŒ‡å®šä¸»åº“ Aï¼ŒåŸºäºä¸»å¤‡åè®®å»ºç«‹è¿æ¥ï¼Œå®ä¾‹ B å¹¶æŠŠ set_b å‘ç»™ä¸»åº“ A å®ä¾‹ A ç®—å‡º set_a ä¸ set_b çš„å·®é›†ï¼Œå°±æ˜¯æ‰€æœ‰å­˜åœ¨äº set_a ä½†ä¸å­˜åœ¨äº set_b çš„ GTID çš„é›†åˆï¼Œåˆ¤æ–­ A æœ¬åœ°æ˜¯å¦åŒ…å«äº†è¿™ä¸ªå·®é›†éœ€è¦çš„æ‰€æœ‰ binlog äº‹åŠ¡ å¦‚æœä¸åŒ…å«ï¼Œè¡¨ç¤º A å·²ç»æŠŠå®ä¾‹ B éœ€è¦çš„ binlog ç»™åˆ æ‰äº†ï¼Œç›´æ¥è¿”å›é”™è¯¯ å¦‚æœç¡®è®¤å…¨éƒ¨åŒ…å«ï¼ŒA ä»è‡ªå·±çš„ binlog æ–‡ä»¶é‡Œé¢ï¼Œæ‰¾å‡ºç¬¬ä¸€ä¸ªä¸åœ¨ set_b çš„äº‹åŠ¡ï¼Œå‘ç»™ B å®ä¾‹ A ä¹‹åå°±ä»è¿™ä¸ªäº‹åŠ¡å¼€å§‹ï¼Œå¾€åè¯»æ–‡ä»¶ï¼ŒæŒ‰é¡ºåºå– binlog å‘ç»™ B å»æ‰§è¡Œ å‚è€ƒæ–‡ç« ï¼šhttps://time.geekbang.org/column/article/77427 æ—¥å¿—æ—¥å¿—åˆ†ç±»åœ¨ä»»ä½•ä¸€ç§æ•°æ®åº“ä¸­ï¼Œéƒ½ä¼šæœ‰å„ç§å„æ ·çš„æ—¥å¿—ï¼Œè®°å½•ç€æ•°æ®åº“å·¥ä½œçš„è¿‡ç¨‹ï¼Œå¯ä»¥å¸®åŠ©æ•°æ®åº“ç®¡ç†å‘˜è¿½è¸ªæ•°æ®åº“æ›¾ç»å‘ç”Ÿè¿‡çš„å„ç§äº‹ä»¶ MySQLæ—¥å¿—ä¸»è¦åŒ…æ‹¬å…­ç§ï¼š é‡åšæ—¥å¿—ï¼ˆredo logï¼‰ å›æ»šæ—¥å¿—ï¼ˆundo logï¼‰ å½’æ¡£æ—¥å¿—ï¼ˆbinlogï¼‰ï¼ˆäºŒè¿›åˆ¶æ—¥å¿—ï¼‰ é”™è¯¯æ—¥å¿—ï¼ˆerrorlogï¼‰ æ…¢æŸ¥è¯¢æ—¥å¿—ï¼ˆslow query logï¼‰ ä¸€èˆ¬æŸ¥è¯¢æ—¥å¿—ï¼ˆgeneral logï¼‰ ä¸­ç»§æ—¥å¿—ï¼ˆrelay logï¼‰ é”™è¯¯æ—¥å¿—é”™è¯¯æ—¥å¿—æ˜¯ MySQL ä¸­æœ€é‡è¦çš„æ—¥å¿—ä¹‹ä¸€ï¼Œè®°å½•äº†å½“ mysqld å¯åŠ¨å’Œåœæ­¢æ—¶ï¼Œä»¥åŠæœåŠ¡å™¨åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿä»»ä½•ä¸¥é‡é”™è¯¯æ—¶çš„ç›¸å…³ä¿¡æ¯ã€‚å½“æ•°æ®åº“å‡ºç°ä»»ä½•æ•…éšœå¯¼è‡´æ— æ³•æ­£å¸¸ä½¿ç”¨æ—¶ï¼Œå¯ä»¥é¦–å…ˆæŸ¥çœ‹æ­¤æ—¥å¿— è¯¥æ—¥å¿—æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œé»˜è®¤ä½ç½®æ˜¯ï¼š/var/log/mysql/error.log æŸ¥çœ‹æŒ‡ä»¤ï¼š 1SHOW VARIABLES LIKE &#x27;log_error%&#x27;; æŸ¥çœ‹æ—¥å¿—å†…å®¹ï¼š 1tail -f /var/log/mysql/error.log å½’æ¡£æ—¥å¿—åŸºæœ¬ä»‹ç»å½’æ¡£æ—¥å¿—ï¼ˆBINLOGï¼‰ä¹Ÿå«äºŒè¿›åˆ¶æ—¥å¿—ï¼Œæ˜¯å› ä¸ºé‡‡ç”¨äºŒè¿›åˆ¶è¿›è¡Œå­˜å‚¨ï¼Œè®°å½•äº†æ‰€æœ‰çš„ DDLï¼ˆæ•°æ®å®šä¹‰è¯­è¨€ï¼‰è¯­å¥å’Œ DMLï¼ˆæ•°æ®æ“ä½œè¯­è¨€ï¼‰è¯­å¥ï¼Œä½†ä¸åŒ…æ‹¬æ•°æ®æŸ¥è¯¢è¯­å¥ï¼Œåœ¨äº‹åŠ¡æäº¤å‰çš„æœ€åé˜¶æ®µå†™å…¥ ä½œç”¨ï¼šç¾éš¾æ—¶çš„æ•°æ®æ¢å¤å’Œ MySQL çš„ä¸»ä»å¤åˆ¶ å½’æ¡£æ—¥å¿—é»˜è®¤æƒ…å†µä¸‹æ˜¯æ²¡æœ‰å¼€å¯çš„ï¼Œéœ€è¦åœ¨ MySQL é…ç½®æ–‡ä»¶ä¸­å¼€å¯ï¼Œå¹¶é…ç½® MySQL æ—¥å¿—çš„æ ¼å¼ï¼š 1234567cd /etc/mysqlvim my.cnf# é…ç½®å¼€å¯binlogæ—¥å¿—ï¼Œ æ—¥å¿—çš„æ–‡ä»¶å‰ç¼€ä¸º mysqlbin -----&gt; ç”Ÿæˆçš„æ–‡ä»¶åå¦‚: mysqlbin.000001log_bin=mysqlbin# é…ç½®äºŒè¿›åˆ¶æ—¥å¿—çš„æ ¼å¼binlog_format=STATEMENT æ—¥å¿—å­˜æ”¾ä½ç½®ï¼šé…ç½®æ—¶ç»™å®šäº†æ–‡ä»¶åä½†æ˜¯æ²¡æœ‰æŒ‡å®šè·¯å¾„ï¼Œæ—¥å¿—é»˜è®¤å†™å…¥MySQL çš„æ•°æ®ç›®å½• æ—¥å¿—æ ¼å¼ï¼š STATEMENTï¼šè¯¥æ—¥å¿—æ ¼å¼åœ¨æ—¥å¿—æ–‡ä»¶ä¸­è®°å½•çš„éƒ½æ˜¯ SQL è¯­å¥ï¼Œæ¯ä¸€æ¡å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹çš„ SQL éƒ½ä¼šè®°å½•åœ¨æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œé€šè¿‡ mysqlbinlog å·¥å…·ï¼Œå¯ä»¥æŸ¥çœ‹åˆ°æ¯æ¡è¯­å¥çš„æ–‡æœ¬ã€‚ä¸»ä»å¤åˆ¶æ—¶ï¼Œä»åº“ä¼šå°†æ—¥å¿—è§£æä¸ºåŸè¯­å¥ï¼Œå¹¶åœ¨ä»åº“é‡æ–°æ‰§è¡Œä¸€é ç¼ºç‚¹ï¼šå¯èƒ½ä¼šå¯¼è‡´ä¸»å¤‡ä¸ä¸€è‡´ï¼Œå› ä¸ºè®°å½•çš„ SQL åœ¨ä¸åŒçš„ç¯å¢ƒä¸­å¯èƒ½é€‰æ‹©çš„ç´¢å¼•ä¸åŒï¼Œå¯¼è‡´ç»“æœä¸åŒ ROWï¼šè¯¥æ—¥å¿—æ ¼å¼åœ¨æ—¥å¿—æ–‡ä»¶ä¸­è®°å½•çš„æ˜¯æ¯ä¸€è¡Œçš„æ•°æ®å˜æ›´ï¼Œè€Œä¸æ˜¯è®°å½• SQL è¯­å¥ã€‚æ¯”å¦‚æ‰§è¡Œ SQL è¯­å¥ update tb_book set status=&#39;1&#39;ï¼Œå¦‚æœæ˜¯ STATEMENTï¼Œåœ¨æ—¥å¿—ä¸­ä¼šè®°å½•ä¸€è¡Œ SQL è¯­å¥ï¼› å¦‚æœæ˜¯ ROWï¼Œç”±äºæ˜¯å¯¹å…¨è¡¨è¿›è¡Œæ›´æ–°ï¼Œå°±æ˜¯æ¯ä¸€è¡Œè®°å½•éƒ½ä¼šå‘ç”Ÿå˜æ›´ï¼ŒROW æ ¼å¼çš„æ—¥å¿—ä¸­ä¼šè®°å½•æ¯ä¸€è¡Œçš„æ•°æ®å˜æ›´ ç¼ºç‚¹ï¼šè®°å½•çš„æ•°æ®æ¯”è¾ƒå¤šï¼Œå ç”¨å¾ˆå¤šçš„å­˜å‚¨ç©ºé—´ MIXEDï¼šè¿™æ˜¯ MySQL é»˜è®¤çš„æ—¥å¿—æ ¼å¼ï¼Œæ··åˆäº†STATEMENT å’Œ ROW ä¸¤ç§æ ¼å¼ï¼ŒMIXED æ ¼å¼èƒ½å°½é‡åˆ©ç”¨ä¸¤ç§æ¨¡å¼çš„ä¼˜ç‚¹ï¼Œè€Œé¿å¼€å®ƒä»¬çš„ç¼ºç‚¹ æ—¥å¿—åˆ·ç›˜äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå…ˆå°†æ—¥å¿—å†™ï¼ˆwriteï¼‰åˆ° binlog cacheï¼Œäº‹åŠ¡æäº¤æ—¶å†æŠŠ binlog cache å†™ï¼ˆfsyncï¼‰åˆ° binlog æ–‡ä»¶ä¸­ï¼Œä¸€ä¸ªäº‹åŠ¡çš„ binlog æ˜¯ä¸èƒ½è¢«æ‹†å¼€çš„ï¼Œæ‰€ä»¥ä¸è®ºè¿™ä¸ªäº‹åŠ¡å¤šå¤§ä¹Ÿè¦ç¡®ä¿ä¸€æ¬¡æ€§å†™å…¥ äº‹åŠ¡æäº¤æ—¶æ‰§è¡Œå™¨æŠŠ binlog cache é‡Œçš„å®Œæ•´äº‹åŠ¡å†™å…¥åˆ° binlog ä¸­ï¼Œå¹¶æ¸…ç©º binlog cache write å’Œ fsync çš„æ—¶æœºç”±å‚æ•° sync_binlog æ§åˆ¶çš„ï¼š sync_binlog&#x3D;0ï¼šè¡¨ç¤ºæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½åª writeï¼Œä¸ fsync sync_binlog&#x3D;1ï¼šè¡¨ç¤ºæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½ä¼šæ‰§è¡Œ fsync sync_binlog&#x3D;N(N&gt;1)ï¼šè¡¨ç¤ºæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½ writeï¼Œä½†ç´¯ç§¯ N ä¸ªäº‹åŠ¡åæ‰ fsyncï¼Œä½†æ˜¯å¦‚æœä¸»æœºå‘ç”Ÿå¼‚å¸¸é‡å¯ï¼Œä¼šä¸¢å¤±æœ€è¿‘ N ä¸ªäº‹åŠ¡çš„ binlog æ—¥å¿— æ—¥å¿—è¯»å–æ—¥å¿—æ–‡ä»¶å­˜å‚¨ä½ç½®ï¼š&#x2F;var&#x2F;lib&#x2F;mysql ç”±äºæ—¥å¿—ä»¥äºŒè¿›åˆ¶æ–¹å¼å­˜å‚¨ï¼Œä¸èƒ½ç›´æ¥è¯»å–ï¼Œéœ€è¦ç”¨ mysqlbinlog å·¥å…·æ¥æŸ¥çœ‹ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š 1mysqlbinlog log-file; æŸ¥çœ‹ STATEMENT æ ¼å¼æ—¥å¿—ï¼š æ‰§è¡Œæ’å…¥è¯­å¥ï¼š 1INSERT INTO tb_book VALUES(NULL,&#x27;Lucene&#x27;,&#x27;2088-05-01&#x27;,&#x27;0&#x27;); cd /var/lib/mysqlï¼š 12-rw-r----- 1 mysql mysql 177 5æœˆ 23 21:08 mysqlbin.000001-rw-r----- 1 mysql mysql 18 5æœˆ 23 21:04 mysqlbin.index mysqlbin.indexï¼šè¯¥æ–‡ä»¶æ˜¯æ—¥å¿—ç´¢å¼•æ–‡ä»¶ ï¼Œ è®°å½•æ—¥å¿—çš„æ–‡ä»¶åï¼› mysqlbing.000001ï¼šæ—¥å¿—æ–‡ä»¶ æŸ¥çœ‹æ—¥å¿—å†…å®¹ï¼š 1mysqlbinlog mysqlbing.000001; æ—¥å¿—ç»“å°¾æœ‰ COMMIT æŸ¥çœ‹ ROW æ ¼å¼æ—¥å¿—ï¼š ä¿®æ”¹é…ç½®ï¼š 12# é…ç½®äºŒè¿›åˆ¶æ—¥å¿—çš„æ ¼å¼binlog_format=ROW æ’å…¥æ•°æ®ï¼š 1INSERT INTO tb_book VALUES(NULL,&#x27;SpringCloudå®æˆ˜&#x27;,&#x27;2088-05-05&#x27;,&#x27;0&#x27;); æŸ¥çœ‹æ—¥å¿—å†…å®¹ï¼šæ—¥å¿—æ ¼å¼ ROWï¼Œç›´æ¥æŸ¥çœ‹æ•°æ®æ˜¯ä¹±ç ï¼Œå¯ä»¥åœ¨ mysqlbinlog åé¢åŠ ä¸Šå‚æ•° -vv 1mysqlbinlog -vv mysqlbin.000002 æ—¥å¿—åˆ é™¤å¯¹äºæ¯”è¾ƒç¹å¿™çš„ç³»ç»Ÿï¼Œç”Ÿæˆæ—¥å¿—é‡å¤§ï¼Œè¿™äº›æ—¥å¿—å¦‚æœé•¿æ—¶é—´ä¸æ¸…é™¤ï¼Œå°†ä¼šå ç”¨å¤§é‡çš„ç£ç›˜ç©ºé—´ï¼Œéœ€è¦åˆ é™¤æ—¥å¿— Reset Master æŒ‡ä»¤åˆ é™¤å…¨éƒ¨ binlog æ—¥å¿—ï¼Œåˆ é™¤ä¹‹åï¼Œæ—¥å¿—ç¼–å·å°†ä» xxxx.000001é‡æ–°å¼€å§‹ 1Reset Master -- MySQLæŒ‡ä»¤ æ‰§è¡ŒæŒ‡ä»¤ PURGE MASTER LOGS TO &#39;mysqlbin.***ï¼Œè¯¥å‘½ä»¤å°†åˆ é™¤ *** ç¼–å·ä¹‹å‰çš„æ‰€æœ‰æ—¥å¿— æ‰§è¡ŒæŒ‡ä»¤ PURGE MASTER LOGS BEFORE &#39;yyyy-mm-dd hh:mm:ss&#39; ï¼Œè¯¥å‘½ä»¤å°†åˆ é™¤æ—¥å¿—ä¸º yyyy-mm-dd hh:mm:ss ä¹‹å‰äº§ç”Ÿçš„æ—¥å¿— è®¾ç½®å‚æ•° --expire_logs_days=#ï¼Œæ­¤å‚æ•°çš„å«ä¹‰æ˜¯è®¾ç½®æ—¥å¿—çš„è¿‡æœŸå¤©æ•°ï¼Œè¿‡äº†æŒ‡å®šçš„å¤©æ•°åæ—¥å¿—å°†ä¼šè¢«è‡ªåŠ¨åˆ é™¤ï¼Œè¿™æ ·åšæœ‰åˆ©äºå‡å°‘ç®¡ç†æ—¥å¿—çš„å·¥ä½œé‡ï¼Œé…ç½® my.cnf æ–‡ä»¶ï¼š 123log_bin=mysqlbinbinlog_format=ROW--expire_logs_days=3 æ•°æ®æ¢å¤è¯¯åˆ åº“æˆ–è€…è¡¨æ—¶ï¼Œéœ€è¦æ ¹æ® binlog è¿›è¡Œæ•°æ®æ¢å¤ ä¸€èˆ¬æƒ…å†µä¸‹æ•°æ®åº“æœ‰å®šæ—¶çš„å…¨é‡å¤‡ä»½ï¼Œå‡å¦‚æ¯å¤© 0 ç‚¹å®šæ—¶å¤‡ä»½ï¼Œ12 ç‚¹è¯¯åˆ äº†åº“ï¼Œæ¢å¤æµç¨‹ï¼š å–æœ€è¿‘ä¸€æ¬¡å…¨é‡å¤‡ä»½ï¼Œç”¨å¤‡ä»½æ¢å¤å‡ºä¸€ä¸ªä¸´æ—¶åº“ ä»æ—¥å¿—æ–‡ä»¶ä¸­å–å‡ºå‡Œæ™¨ 0 ç‚¹ä¹‹åçš„æ—¥å¿— æŠŠé™¤äº†è¯¯åˆ é™¤æ•°æ®çš„è¯­å¥å¤–æ—¥å¿—ï¼Œå…¨éƒ¨åº”ç”¨åˆ°ä¸´æ—¶åº“ è·³è¿‡è¯¯åˆ é™¤è¯­å¥æ—¥å¿—çš„æ–¹æ³•ï¼š å¦‚æœåŸå®ä¾‹æ²¡æœ‰ä½¿ç”¨ GTID æ¨¡å¼ï¼Œåªèƒ½åœ¨åº”ç”¨åˆ°åŒ…å« 12 ç‚¹çš„ binlog æ–‡ä»¶çš„æ—¶å€™ï¼Œå…ˆç”¨ â€“stop-position å‚æ•°æ‰§è¡Œåˆ°è¯¯æ“ä½œä¹‹å‰çš„æ—¥å¿—ï¼Œç„¶åå†ç”¨ â€“start-position ä»è¯¯æ“ä½œä¹‹åçš„æ—¥å¿—ç»§ç»­æ‰§è¡Œ å¦‚æœå®ä¾‹ä½¿ç”¨äº† GTID æ¨¡å¼ï¼Œå‡è®¾è¯¯æ“ä½œå‘½ä»¤çš„ GTID æ˜¯ gtid1ï¼Œé‚£ä¹ˆåªéœ€è¦æäº¤ä¸€ä¸ªç©ºäº‹åŠ¡å…ˆå°†è¿™ä¸ª GTID åŠ åˆ°ä¸´æ—¶å®ä¾‹çš„ GTID é›†åˆï¼Œä¹‹åæŒ‰é¡ºåºæ‰§è¡Œ binlog çš„æ—¶å°±ä¼šè‡ªåŠ¨è·³è¿‡è¯¯æ“ä½œçš„è¯­å¥ æŸ¥è¯¢æ—¥å¿—æŸ¥è¯¢æ—¥å¿—ä¸­è®°å½•äº†å®¢æˆ·ç«¯çš„æ‰€æœ‰æ“ä½œè¯­å¥ï¼Œè€ŒäºŒè¿›åˆ¶æ—¥å¿—ä¸åŒ…å«æŸ¥è¯¢æ•°æ®çš„ SQL è¯­å¥ é»˜è®¤æƒ…å†µä¸‹ï¼ŒæŸ¥è¯¢æ—¥å¿—æ˜¯æœªå¼€å¯çš„ã€‚å¦‚æœéœ€è¦å¼€å¯æŸ¥è¯¢æ—¥å¿—ï¼Œé…ç½® my.cnfï¼š 1234# è¯¥é€‰é¡¹ç”¨æ¥å¼€å¯æŸ¥è¯¢æ—¥å¿—ï¼Œå¯é€‰å€¼0æˆ–è€…1ï¼Œ0ä»£è¡¨å…³é—­ï¼Œ1ä»£è¡¨å¼€å¯ general_log=1# è®¾ç½®æ—¥å¿—çš„æ–‡ä»¶åï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œé»˜è®¤çš„æ–‡ä»¶åä¸ºhost_name.logï¼Œå­˜æ”¾åœ¨/var/lib/mysqlgeneral_log_file=mysql_query.log é…ç½®å®Œæ¯•ä¹‹åï¼Œåœ¨æ•°æ®åº“æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š 1234SELECT * FROM tb_book;SELECT * FROM tb_book WHERE id = 1;UPDATE tb_book SET name = &#x27;luceneå…¥é—¨æŒ‡å—&#x27; WHERE id = 5;SELECT * FROM tb_book WHERE id &lt; 8 æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œ å†æ¬¡æ¥æŸ¥è¯¢æ—¥å¿—æ–‡ä»¶ï¼š æ…¢æ—¥å¿—æ…¢æŸ¥è¯¢æ—¥å¿—è®°å½•æ‰€æœ‰æ‰§è¡Œæ—¶é—´è¶…è¿‡ long_query_time å¹¶ä¸”æ‰«æè®°å½•æ•°ä¸å°äº min_examined_row_limit çš„æ‰€æœ‰çš„ SQL è¯­å¥çš„æ—¥å¿—long_query_time é»˜è®¤ä¸º 10 ç§’ï¼Œæœ€å°ä¸º 0ï¼Œ ç²¾åº¦åˆ°å¾®ç§’ æ…¢æŸ¥è¯¢æ—¥å¿—é»˜è®¤æ˜¯å…³é—­çš„ï¼Œå¯ä»¥é€šè¿‡ä¸¤ä¸ªå‚æ•°æ¥æ§åˆ¶æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œé…ç½®æ–‡ä»¶ /etc/mysql/my.cnfï¼š 12345678# è¯¥å‚æ•°ç”¨æ¥æ§åˆ¶æ…¢æŸ¥è¯¢æ—¥å¿—æ˜¯å¦å¼€å¯ï¼Œå¯é€‰å€¼0æˆ–è€…1ï¼Œ0ä»£è¡¨å…³é—­ï¼Œ1ä»£è¡¨å¼€å¯ slow_query_log=1 # è¯¥å‚æ•°ç”¨æ¥æŒ‡å®šæ…¢æŸ¥è¯¢æ—¥å¿—çš„æ–‡ä»¶åï¼Œå­˜æ”¾åœ¨ /var/lib/mysqlslow_query_log_file=slow_query.log# è¯¥é€‰é¡¹ç”¨æ¥é…ç½®æŸ¥è¯¢çš„æ—¶é—´é™åˆ¶ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´å°†è®¤ä¸ºå€¼æ…¢æŸ¥è¯¢ï¼Œå°†éœ€è¦è¿›è¡Œæ—¥å¿—è®°å½•ï¼Œé»˜è®¤10slong_query_time=10 æ—¥å¿—è¯»å–ï¼š ç›´æ¥é€šè¿‡ cat æŒ‡ä»¤æŸ¥è¯¢è¯¥æ—¥å¿—æ–‡ä»¶ï¼š 1cat slow_query.log å¦‚æœæ…¢æŸ¥è¯¢æ—¥å¿—å†…å®¹å¾ˆå¤šï¼Œç›´æ¥æŸ¥çœ‹æ–‡ä»¶æ¯”è¾ƒç¹çï¼Œå¯ä»¥å€ŸåŠ© mysql è‡ªå¸¦çš„ mysqldumpslow å·¥å…·å¯¹æ…¢æŸ¥è¯¢æ—¥å¿—è¿›è¡Œåˆ†ç±»æ±‡æ€»ï¼š 1mysqldumpslow slow_query.log èŒƒå¼ç¬¬ä¸€èŒƒå¼å»ºç«‹ç§‘å­¦çš„ï¼Œè§„èŒƒçš„æ•°æ®è¡¨å°±éœ€è¦æ»¡è¶³ä¸€äº›è§„åˆ™æ¥ä¼˜åŒ–æ•°æ®çš„è®¾è®¡å’Œå­˜å‚¨ï¼Œè¿™äº›è§„åˆ™å°±ç§°ä¸ºèŒƒå¼ 1NFï¼šæ•°æ®åº“è¡¨çš„æ¯ä¸€åˆ—éƒ½æ˜¯ä¸å¯åˆ†å‰²çš„åŸå­æ•°æ®é¡¹ï¼Œä¸èƒ½æ˜¯é›†åˆã€æ•°ç»„ç­‰éåŸå­æ•°æ®é¡¹ã€‚å³è¡¨ä¸­çš„æŸä¸ªåˆ—æœ‰å¤šä¸ªå€¼æ—¶ï¼Œå¿…é¡»æ‹†åˆ†ä¸ºä¸åŒçš„åˆ—ã€‚ç®€è€Œè¨€ä¹‹ï¼Œç¬¬ä¸€èŒƒå¼æ¯ä¸€åˆ—ä¸å¯å†æ‹†åˆ†ï¼Œç§°ä¸ºåŸå­æ€§ åŸºæœ¬è¡¨ï¼š ç¬¬ä¸€èŒƒå¼è¡¨ï¼š ç¬¬äºŒèŒƒå¼2NFï¼šåœ¨æ»¡è¶³ç¬¬ä¸€èŒƒå¼çš„åŸºç¡€ä¸Šï¼Œéä¸»å±æ€§å®Œå…¨ä¾èµ–äºä¸»ç ï¼ˆä¸»å…³é”®å­—ã€ä¸»é”®ï¼‰ï¼Œæ¶ˆé™¤éä¸»å±æ€§å¯¹ä¸»ç çš„éƒ¨åˆ†å‡½æ•°ä¾èµ–ã€‚ç®€è€Œè¨€ä¹‹ï¼Œè¡¨ä¸­çš„æ¯ä¸€ä¸ªå­—æ®µ ï¼ˆæ‰€æœ‰åˆ—ï¼‰éƒ½å®Œå…¨ä¾èµ–äºä¸»é”®ï¼Œè®°å½•çš„å”¯ä¸€æ€§ ä½œç”¨ï¼šéµå®ˆç¬¬äºŒèŒƒå¼å‡å°‘æ•°æ®å†—ä½™ï¼Œé€šè¿‡ä¸»é”®åŒºåˆ†ç›¸åŒæ•°æ®ã€‚ å‡½æ•°ä¾èµ–ï¼šA â†’ Bï¼Œå¦‚æœé€šè¿‡ A å±æ€§(å±æ€§ç»„)çš„å€¼ï¼Œå¯ä»¥ç¡®å®šå”¯ä¸€ B å±æ€§çš„å€¼ï¼Œåˆ™ç§° B ä¾èµ–äº A å­¦å· â†’ å§“åï¼›(å­¦å·ï¼Œè¯¾ç¨‹åç§°) â†’ åˆ†æ•° å®Œå…¨å‡½æ•°ä¾èµ–ï¼šA â†’ Bï¼Œå¦‚æœAæ˜¯ä¸€ä¸ªå±æ€§ç»„ï¼Œåˆ™ B å±æ€§å€¼çš„ç¡®å®šéœ€è¦ä¾èµ–äº A å±æ€§ç»„çš„æ‰€æœ‰å±æ€§å€¼ (å­¦å·ï¼Œè¯¾ç¨‹åç§°) â†’ åˆ†æ•° éƒ¨åˆ†å‡½æ•°ä¾èµ–ï¼šA â†’ Bï¼Œå¦‚æœ A æ˜¯ä¸€ä¸ªå±æ€§ç»„ï¼Œåˆ™ B å±æ€§å€¼çš„ç¡®å®šåªéœ€è¦ä¾èµ–äº A å±æ€§ç»„çš„æŸäº›å±æ€§å€¼ (å­¦å·ï¼Œè¯¾ç¨‹åç§°) â†’ å§“å ä¼ é€’å‡½æ•°ä¾èµ–ï¼šA â†’ Bï¼ŒB â†’ Cï¼Œå¦‚æœé€šè¿‡Aå±æ€§(å±æ€§ç»„)çš„å€¼ï¼Œå¯ä»¥ç¡®å®šå”¯ä¸€ B å±æ€§çš„å€¼ï¼Œåœ¨é€šè¿‡ B å±æ€§(å±æ€§ç»„)çš„å€¼ï¼Œå¯ä»¥ç¡®å®šå”¯ä¸€ C å±æ€§çš„å€¼ï¼Œåˆ™ç§° C ä¼ é€’å‡½æ•°ä¾èµ–äº A å­¦å· â†’ ç³»åï¼Œç³»å â†’ ç³»ä¸»ä»» ç ï¼šå¦‚æœåœ¨ä¸€å¼ è¡¨ä¸­ï¼Œä¸€ä¸ªå±æ€§æˆ–å±æ€§ç»„ï¼Œè¢«å…¶ä»–æ‰€æœ‰å±æ€§æ‰€å®Œå…¨ä¾èµ–ï¼Œåˆ™ç§°è¿™ä¸ªå±æ€§(å±æ€§ç»„)ä¸ºè¯¥è¡¨çš„ç  è¯¥è¡¨ä¸­çš„ç ï¼š(å­¦å·ï¼Œè¯¾ç¨‹åç§°) ä¸»å±æ€§ï¼šç å±æ€§ç»„ä¸­çš„æ‰€æœ‰å±æ€§ éä¸»å±æ€§ï¼šé™¤ç å±æ€§ç»„ä»¥å¤–çš„å±æ€§ ç¬¬ä¸‰èŒƒå¼3NFï¼šåœ¨æ»¡è¶³ç¬¬äºŒèŒƒå¼çš„åŸºç¡€ä¸Šï¼Œè¡¨ä¸­çš„ä»»ä½•å±æ€§ä¸ä¾èµ–äºå…¶å®ƒéä¸»å±æ€§ï¼Œæ¶ˆé™¤ä¼ é€’ä¾èµ–ã€‚ç®€è€Œè¨€ä¹‹ï¼Œéä¸»é”®éƒ½ç›´æ¥ä¾èµ–äºä¸»é”®ï¼Œè€Œä¸æ˜¯é€šè¿‡å…¶å®ƒçš„é”®æ¥é—´æ¥ä¾èµ–äºä¸»é”®ã€‚ ä½œç”¨ï¼šå¯ä»¥é€šè¿‡ä¸»é”® id åŒºåˆ†ç›¸åŒæ•°æ®ï¼Œä¿®æ”¹æ•°æ®çš„æ—¶å€™åªéœ€è¦ä¿®æ”¹ä¸€å¼ è¡¨ï¼ˆæ–¹ä¾¿ä¿®æ”¹ï¼‰ï¼Œåä¹‹éœ€è¦ä¿®æ”¹å¤šè¡¨ã€‚ æ€»ç»“ RedisNoSQLæ¦‚è¿°NoSQLï¼ˆNot-Only SQLï¼‰ï¼šæ³›æŒ‡éå…³ç³»å‹çš„æ•°æ®åº“ï¼Œä½œä¸ºå…³ç³»å‹æ•°æ®åº“çš„è¡¥å…… MySQL æ”¯æŒ ACID ç‰¹æ€§ï¼Œä¿è¯å¯é æ€§å’ŒæŒä¹…æ€§ï¼Œè¯»å–æ€§èƒ½ä¸é«˜ï¼Œå› æ­¤éœ€è¦ç¼“å­˜çš„æ¥å‡ç¼“æ•°æ®åº“çš„è®¿é—®å‹åŠ› ä½œç”¨ï¼šåº”å¯¹åŸºäºæµ·é‡ç”¨æˆ·å’Œæµ·é‡æ•°æ®å‰æä¸‹çš„æ•°æ®å¤„ç†é—®é¢˜ ç‰¹å¾ï¼š å¯æ‰©å®¹ï¼Œå¯ä¼¸ç¼©ï¼ŒSQL æ•°æ®å…³ç³»è¿‡äºå¤æ‚ï¼ŒNosql ä¸å­˜å…³ç³»ï¼Œåªå­˜æ•°æ® å¤§æ•°æ®é‡ä¸‹é«˜æ€§èƒ½ï¼Œæ•°æ®ä¸å­˜å–åœ¨ç£ç›˜ IOï¼Œå­˜å–åœ¨å†…å­˜ çµæ´»çš„æ•°æ®æ¨¡å‹ï¼Œè®¾è®¡äº†ä¸€äº›æ•°æ®å­˜å‚¨æ ¼å¼ï¼Œèƒ½ä¿è¯æ•ˆç‡ä¸Šçš„æé«˜ é«˜å¯ç”¨ï¼Œé›†ç¾¤ å¸¸è§çš„ NoSQLï¼šRedisã€memcacheã€HBaseã€MongoDB å‚è€ƒä¹¦ç±ï¼šhttps://book.douban.com/subject/25900156/ å‚è€ƒè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV1CJ411m7Gc RedisRedis (REmote DIctionary Server) ï¼šç”¨ C è¯­è¨€å¼€å‘çš„ä¸€ä¸ªå¼€æºçš„é«˜æ€§èƒ½é”®å€¼å¯¹ï¼ˆkey-valueï¼‰æ•°æ®åº“ ç‰¹å¾ï¼š æ•°æ®é—´æ²¡æœ‰å¿…ç„¶çš„å…³è”å…³ç³»ï¼Œä¸å­˜å…³ç³»ï¼Œåªå­˜æ•°æ® æ•°æ®å­˜å‚¨åœ¨å†…å­˜ï¼Œå­˜å–é€Ÿåº¦å¿«ï¼Œè§£å†³äº†ç£ç›˜ IO é€Ÿåº¦æ…¢çš„é—®é¢˜ å†…éƒ¨é‡‡ç”¨å•çº¿ç¨‹æœºåˆ¶è¿›è¡Œå·¥ä½œ é«˜æ€§èƒ½ï¼Œå®˜æ–¹æµ‹è¯•æ•°æ®ï¼Œ50 ä¸ªå¹¶å‘æ‰§è¡Œ 100000 ä¸ªè¯·æ±‚ï¼Œè¯»çš„é€Ÿåº¦æ˜¯ 110000 æ¬¡&#x2F;sï¼Œå†™çš„é€Ÿåº¦æ˜¯ 81000 æ¬¡&#x2F;s å¤šæ•°æ®ç±»å‹æ”¯æŒ å­—ç¬¦ä¸²ç±»å‹ï¼šstringï¼ˆStringï¼‰ åˆ—è¡¨ç±»å‹ï¼šlistï¼ˆLinkedListï¼‰ æ•£åˆ—ç±»å‹ï¼šhashï¼ˆHashMapï¼‰ é›†åˆç±»å‹ï¼šsetï¼ˆHashSetï¼‰ æœ‰åºé›†åˆç±»å‹ï¼šzset&#x2F;sorted_setï¼ˆTreeSetï¼‰ æ”¯æŒæŒä¹…åŒ–ï¼Œå¯ä»¥è¿›è¡Œæ•°æ®ç¾éš¾æ¢å¤ å®‰è£…å¯åŠ¨å®‰è£…ï¼š Redis 5.0 è¢«åŒ…å«åœ¨é»˜è®¤çš„ Ubuntu 20.04 è½¯ä»¶æºä¸­ 12sudo apt updatesudo apt install redis-server æ£€æŸ¥ Redis çŠ¶æ€ 1sudo systemctl status redis-server å¯åŠ¨ï¼š å¯åŠ¨æœåŠ¡å™¨â€”â€”å‚æ•°å¯åŠ¨ 12redis-server [--port port]#redis-server --port 6379 å¯åŠ¨æœåŠ¡å™¨â€”â€”é…ç½®æ–‡ä»¶å¯åŠ¨ 12redis-server config_file_name#redis-server /etc/redis/conf/redis-6397.conf å¯åŠ¨å®¢æˆ·ç«¯ï¼š 12redis-cli [-h host] [-p port]#redis-cli -h 192.168.2.185 -p 6397 æ³¨æ„ï¼šæœåŠ¡å™¨å¯åŠ¨æŒ‡å®šç«¯å£ä½¿ç”¨çš„æ˜¯â€“portï¼Œå®¢æˆ·ç«¯å¯åŠ¨æŒ‡å®šç«¯å£ä½¿ç”¨çš„æ˜¯-p åŸºæœ¬é…ç½®ç³»ç»Ÿç›®å½• åˆ›å»ºæ–‡ä»¶ç»“æ„ åˆ›å»ºé…ç½®æ–‡ä»¶å­˜å‚¨ç›®å½• 1mkdir conf åˆ›å»ºæœåŠ¡å™¨æ–‡ä»¶å­˜å‚¨ç›®å½•ï¼ˆåŒ…å«æ—¥å¿—ã€æ•°æ®ã€ä¸´æ—¶é…ç½®æ–‡ä»¶ç­‰ï¼‰ 1mkdir data åˆ›å»ºé…ç½®æ–‡ä»¶å‰¯æœ¬æ”¾å…¥ conf ç›®å½•ï¼ŒUbuntu ç³»ç»Ÿé…ç½®æ–‡ä»¶ redis.conf åœ¨ç›®å½• /etc/redis ä¸­ 1cat redis.conf | grep -v &quot;#&quot; | grep -v &quot;^$&quot; -&gt; /conf/redis-6379.conf å»é™¤é…ç½®æ–‡ä»¶çš„æ³¨é‡Šå’Œç©ºæ ¼ï¼Œè¾“å‡ºåˆ°æ–°çš„æ–‡ä»¶ï¼Œå‘½ä»¤æ–¹å¼é‡‡ç”¨ redis-port.conf æœåŠ¡å™¨ è®¾ç½®æœåŠ¡å™¨ä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è¿è¡Œï¼Œå…³é—­åæœåŠ¡å™¨æ§åˆ¶å°ä¸­å°†æ‰“å°æœåŠ¡å™¨è¿è¡Œä¿¡æ¯ï¼ˆåŒæ—¥å¿—å†…å®¹ç›¸åŒï¼‰ï¼š 1daemonize yes|no ç»‘å®šä¸»æœºåœ°å€ï¼Œç»‘å®šæœ¬åœ°IPåœ°å€ï¼Œå¦åˆ™SSHæ— æ³•è®¿é—®ï¼š 1bind ip è®¾ç½®æœåŠ¡å™¨ç«¯å£ï¼š 1port port è®¾ç½®æœåŠ¡å™¨æ–‡ä»¶ä¿å­˜åœ°å€ï¼š 1dir path è®¾ç½®æ•°æ®åº“çš„æ•°é‡ï¼š 1databases 16 å¤šæœåŠ¡å™¨å¿«æ·é…ç½®ï¼š å¯¼å…¥å¹¶åŠ è½½æŒ‡å®šé…ç½®æ–‡ä»¶ä¿¡æ¯ï¼Œç”¨äºå¿«é€Ÿåˆ›å»º redis å…¬å…±é…ç½®è¾ƒå¤šçš„ redis å®ä¾‹é…ç½®æ–‡ä»¶ï¼Œä¾¿äºç»´æŠ¤ 1include /path/conf_name.conf å®¢æˆ·ç«¯ æœåŠ¡å™¨å…è®¸å®¢æˆ·ç«¯è¿æ¥æœ€å¤§æ•°é‡ï¼Œé»˜è®¤ 0ï¼Œè¡¨ç¤ºæ— é™åˆ¶ï¼Œå½“å®¢æˆ·ç«¯è¿æ¥åˆ°è¾¾ä¸Šé™åï¼ŒRedis ä¼šæ‹’ç»æ–°çš„è¿æ¥ï¼š 1maxclients count å®¢æˆ·ç«¯é—²ç½®ç­‰å¾…æœ€å¤§æ—¶é•¿ï¼Œè¾¾åˆ°æœ€å¤§å€¼åå…³é—­å¯¹åº”è¿æ¥ï¼Œå¦‚éœ€å…³é—­è¯¥åŠŸèƒ½ï¼Œè®¾ç½®ä¸º 0ï¼š 1timeout seconds æ—¥å¿—é…ç½®è®¾ç½®æ—¥å¿—è®°å½• è®¾ç½®æœåŠ¡å™¨ä»¥æŒ‡å®šæ—¥å¿—è®°å½•çº§åˆ« 1loglevel debug|verbose|notice|warning æ—¥å¿—è®°å½•æ–‡ä»¶å 1logfile filename æ³¨æ„ï¼šæ—¥å¿—çº§åˆ«å¼€å‘æœŸè®¾ç½®ä¸º verbose å³å¯ï¼Œç”Ÿäº§ç¯å¢ƒä¸­é…ç½®ä¸º noticeï¼Œç®€åŒ–æ—¥å¿—è¾“å‡ºé‡ï¼Œé™ä½å†™æ—¥å¿— IO çš„é¢‘åº¦ é…ç½®æ–‡ä»¶ï¼š 1234567bind 192.168.2.185port 6379#timeout 0daemonize nologfile /etc/redis/data/redis-6379.logdir /etc/redis/datadbfilename &quot;dump-6379.rdb&quot; åŸºæœ¬æŒ‡ä»¤å¸®åŠ©ä¿¡æ¯ï¼š è·å–å‘½ä»¤å¸®åŠ©æ–‡æ¡£ 12help [command]#help set è·å–ç»„ä¸­æ‰€æœ‰å‘½ä»¤ä¿¡æ¯åç§° 12help [@group-name]#help @string é€€å‡ºæœåŠ¡ é€€å‡ºå®¢æˆ·ç«¯ï¼š 12quitexit é€€å‡ºå®¢æˆ·ç«¯æœåŠ¡å™¨å¿«æ·é”®ï¼š 1Ctrl+C æ•°æ®åº“æœåŠ¡å™¨Redis æœåŠ¡å™¨å°†æ‰€æœ‰æ•°æ®åº“ä¿å­˜åœ¨æœåŠ¡å™¨çŠ¶æ€ redisServer ç»“æ„çš„ db æ•°ç»„ä¸­ï¼Œæ•°ç»„çš„æ¯ä¸€é¡¹éƒ½æ˜¯ redisDb ç»“æ„ï¼Œä»£è¡¨ä¸€ä¸ªæ•°æ®åº“ï¼Œæ¯ä¸ªæ•°æ®åº“ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œ**å…±ç”¨ **Redis å†…å­˜ï¼Œä¸åŒºåˆ†å¤§å°ã€‚åœ¨åˆå§‹åŒ–æœåŠ¡å™¨æ—¶ï¼Œæ ¹æ® dbnum å±æ€§å†³å®šåˆ›å»ºæ•°æ®åº“çš„æ•°é‡ï¼Œè¯¥å±æ€§ç”±æœåŠ¡å™¨é…ç½®çš„ database é€‰é¡¹å†³å®šï¼Œé»˜è®¤ 16 1234567struct redisServer &#123; // ä¿å­˜æœåŠ¡å™¨æ‰€æœ‰çš„æ•°æ®åº“ redisDB *db; // æœåŠ¡å™¨æ•°æ®åº“çš„æ•°é‡ int dbnum;&#125;; åœ¨æœåŠ¡å™¨å†…éƒ¨ï¼Œå®¢æˆ·ç«¯çŠ¶æ€ redisClient ç»“æ„çš„ db å±æ€§è®°å½•äº†ç›®æ ‡æ•°æ®åº“ï¼Œæ˜¯ä¸€ä¸ªæŒ‡å‘ redisDb ç»“æ„çš„æŒ‡é’ˆ 1234struct redisClient &#123; // è®°å½•å®¢æˆ·ç«¯æ­£åœ¨ä½¿ç”¨çš„æ•°æ®åº“ï¼ŒæŒ‡å‘ redisServer.db æ•°ç»„ä¸­çš„æŸä¸€ä¸ª db redisDB *db;&#125;; æ¯ä¸ª Redis å®¢æˆ·ç«¯éƒ½æœ‰ç›®æ ‡æ•°æ®åº“ï¼Œæ‰§è¡Œæ•°æ®åº“è¯»å†™å‘½ä»¤æ—¶ç›®æ ‡æ•°æ®åº“å°±ä¼šæˆä¸ºè¿™äº›å‘½ä»¤çš„æ“ä½œå¯¹è±¡ï¼Œé»˜è®¤æƒ…å†µä¸‹ Redis å®¢æˆ·ç«¯çš„ç›®æ ‡æ•°æ®åº“ä¸º 0 å·æ•°æ®åº“ï¼Œå®¢æˆ·ç«¯å¯ä»¥æ‰§è¡Œ SELECT å‘½ä»¤åˆ‡æ¢ç›®æ ‡æ•°æ®åº“ï¼ŒåŸç†æ˜¯é€šè¿‡ä¿®æ”¹ redisClient.db æŒ‡é’ˆæŒ‡å‘æœåŠ¡å™¨ä¸­ä¸åŒæ•°æ®åº“ å‘½ä»¤æ“ä½œï¼š 1234select index #åˆ‡æ¢æ•°æ®åº“ï¼Œindexä»0-15å–å€¼move key db #æ•°æ®ç§»åŠ¨åˆ°æŒ‡å®šæ•°æ®åº“ï¼Œdbæ˜¯æ•°æ®åº“ç¼–å·ping #æµ‹è¯•æ•°æ®åº“æ˜¯å¦è¿æ¥æ­£å¸¸ï¼Œè¿”å›PONGecho message #æ§åˆ¶å°è¾“å‡ºä¿¡æ¯ Redis æ²¡æœ‰å¯ä»¥è¿”å›å®¢æˆ·ç«¯ç›®æ ‡æ•°æ®åº“çš„å‘½ä»¤ï¼Œä½†æ˜¯ redis-cli å®¢æˆ·ç«¯æ—è¾¹ä¼šæç¤ºå½“å‰æ‰€ä½¿ç”¨çš„ç›®æ ‡æ•°æ®åº“ 123redis&gt; SELECT 1 OK redis[1]&gt; é”®ç©ºé—´key spaceRedis æ˜¯ä¸€ä¸ªé”®å€¼å¯¹ï¼ˆkey-value pairï¼‰æ•°æ®åº“æœåŠ¡å™¨ï¼Œæ¯ä¸ªæ•°æ®åº“éƒ½ç”±ä¸€ä¸ª redisDb ç»“æ„è¡¨ç¤ºï¼ŒredisDb.dict å­—å…¸ä¸­ä¿å­˜äº†æ•°æ®åº“çš„æ‰€æœ‰é”®å€¼å¯¹ï¼Œå°†è¿™ä¸ªå­—å…¸ç§°ä¸ºé”®ç©ºé—´ï¼ˆkey spaceï¼‰ 1234typedef struct redisDB &#123; // æ•°æ®åº“é”®ç©ºé—´ï¼Œä¿å­˜æ‰€æœ‰é”®å€¼å¯¹ dict *dict&#125; redisDB; é”®ç©ºé—´å’Œç”¨æˆ·æ‰€è§çš„æ•°æ®åº“æ˜¯ç›´æ¥å¯¹åº”çš„ï¼š é”®ç©ºé—´çš„é”®å°±æ˜¯æ•°æ®åº“çš„é”®ï¼Œæ¯ä¸ªé”®éƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ é”®ç©ºé—´çš„å€¼å°±æ˜¯æ•°æ®åº“çš„å€¼ï¼Œæ¯ä¸ªå€¼å¯ä»¥æ˜¯ä»»æ„ä¸€ç§ Redis å¯¹è±¡ å½“ä½¿ç”¨ Redis å‘½ä»¤å¯¹æ•°æ®åº“è¿›è¡Œè¯»å†™æ—¶ï¼ŒæœåŠ¡å™¨ä¸ä»…ä¼šå¯¹é”®ç©ºé—´æ‰§è¡ŒæŒ‡å®šçš„è¯»å†™æ“ä½œï¼Œè¿˜ä¼šè¿›è¡Œä¸€äº›ç»´æŠ¤æ“ä½œï¼š åœ¨è¯»å–ä¸€ä¸ªé”®åï¼ˆè¯»æ“ä½œå’Œå†™æ“ä½œéƒ½è¦å¯¹é”®è¿›è¡Œè¯»å–ï¼‰ï¼ŒæœåŠ¡å™¨ä¼šæ ¹æ®é”®æ˜¯å¦å­˜åœ¨æ¥æ›´æ–°æœåŠ¡å™¨çš„é”®ç©ºé—´å‘½ä¸­ hit æ¬¡æ•°æˆ–é”®ç©ºé—´ä¸å‘½ä¸­ miss æ¬¡æ•°ï¼Œè¿™ä¸¤ä¸ªå€¼å¯ä»¥åœ¨ INFO stats å‘½ä»¤çš„ keyspace_hits å±æ€§å’Œ keyspace_misses å±æ€§ä¸­æŸ¥çœ‹ æ›´æ–°é”®çš„ LRUï¼ˆæœ€åä½¿ç”¨ï¼‰æ—¶é—´ï¼Œè¯¥å€¼å¯ä»¥ç”¨äºè®¡ç®—é”®çš„é—²ç½®æ—¶é—´ï¼Œä½¿ç”¨ OBJECT idletime key æŸ¥çœ‹é”® key çš„é—²ç½®æ—¶é—´ å¦‚æœåœ¨è¯»å–ä¸€ä¸ªé”®æ—¶å‘ç°è¯¥é”®å·²ç»è¿‡æœŸï¼ŒæœåŠ¡å™¨ä¼šå…ˆåˆ é™¤è¿‡æœŸé”®ï¼Œå†æ‰§è¡Œå…¶ä»–æ“ä½œ å¦‚æœå®¢æˆ·ç«¯ä½¿ç”¨ WATCH å‘½ä»¤ç›‘è§†äº†æŸä¸ªé”®ï¼Œé‚£ä¹ˆæœåŠ¡å™¨åœ¨å¯¹è¢«ç›‘è§†çš„é”®è¿›è¡Œä¿®æ”¹ä¹‹åï¼Œä¼šå°†è¿™ä¸ªé”®æ ‡è®°ä¸ºè„ï¼ˆdirtyï¼‰ï¼Œä»è€Œè®©äº‹åŠ¡æ³¨æ„åˆ°è¿™ä¸ªé”®å·²ç»è¢«ä¿®æ”¹è¿‡ æœåŠ¡å™¨æ¯æ¬¡ä¿®æ”¹ä¸€ä¸ªé”®ä¹‹åï¼Œéƒ½ä¼šå¯¹ dirty é”®è®¡æ•°å™¨çš„å€¼å¢1ï¼Œè¯¥è®¡æ•°å™¨ä¼šè§¦å‘æœåŠ¡å™¨çš„æŒä¹…åŒ–ä»¥åŠå¤åˆ¶æ“ä½œ å¦‚æœæœåŠ¡å™¨å¼€å¯äº†æ•°æ®åº“é€šçŸ¥åŠŸèƒ½ï¼Œé‚£ä¹ˆåœ¨å¯¹é”®è¿›è¡Œä¿®æ”¹ä¹‹åï¼ŒæœåŠ¡å™¨å°†æŒ‰é…ç½®å‘é€ç›¸åº”çš„æ•°æ®åº“é€šçŸ¥ è¯»å†™æŒ‡ä»¤å¸¸è§é”®æ“ä½œæŒ‡ä»¤ï¼š å¢åŠ æŒ‡ä»¤ 1234567 set key value #æ·»åŠ ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„é”®å€¼å¯¹* åˆ é™¤æŒ‡ä»¤ ```sh del key #åˆ é™¤æŒ‡å®škey unlink key #éé˜»å¡åˆ é™¤keyï¼ŒçœŸæ­£çš„åˆ é™¤ä¼šåœ¨åç»­å¼‚æ­¥æ“ä½œ æ›´æ–°æŒ‡ä»¤ 12rename key newkey #æ”¹årenamenx key newkey #æ”¹å å€¼å¾—æ›´æ–°éœ€è¦å‚çœ‹å…·ä½“å¾— Redis å¯¹è±¡å¾—æ“ä½œæ–¹å¼ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²å¯¹è±¡æ‰§è¡Œ SET key value å°±å¯ä»¥å®Œæˆä¿®æ”¹ æŸ¥è¯¢æŒ‡ä»¤ 123exists key #è·å–keyæ˜¯å¦å­˜åœ¨randomkey #éšæœºè¿”å›ä¸€ä¸ªé”®keys pattern #æŸ¥è¯¢key KEYS å‘½ä»¤éœ€è¦éå†å­˜å‚¨çš„é”®å€¼å¯¹ï¼Œæ“ä½œå»¶æ—¶é«˜ï¼Œä¸€èˆ¬ä¸è¢«å»ºè®®ç”¨äºç”Ÿäº§ç¯å¢ƒä¸­ æŸ¥è¯¢æ¨¡å¼è§„åˆ™ï¼š* åŒ¹é…ä»»æ„æ•°é‡çš„ä»»æ„ç¬¦å·ã€? é…åˆä¸€ä¸ªä»»æ„ç¬¦å·ã€[] åŒ¹é…ä¸€ä¸ªæŒ‡å®šç¬¦å· 123456keys * #æŸ¥è¯¢æ‰€æœ‰keykeys aa* #æŸ¥è¯¢æ‰€æœ‰ä»¥aaå¼€å¤´keys *bb #æŸ¥è¯¢æ‰€æœ‰ä»¥bbç»“å°¾keys ??cc #æŸ¥è¯¢æ‰€æœ‰å‰é¢ä¸¤ä¸ªå­—ç¬¦ä»»æ„ï¼Œåé¢ä»¥ccç»“å°¾ keys user:? #æŸ¥è¯¢æ‰€æœ‰ä»¥user:å¼€å¤´ï¼Œæœ€åä¸€ä¸ªå­—ç¬¦ä»»æ„keys u[st]er:1 #æŸ¥è¯¢æ‰€æœ‰ä»¥uå¼€å¤´ï¼Œä»¥er:1ç»“å°¾ï¼Œä¸­é—´åŒ…å«ä¸€ä¸ªå­—æ¯ï¼Œsæˆ–t å…¶ä»–æŒ‡ä»¤ 1234type key #è·å–keyçš„ç±»å‹dbsize #è·å–å½“å‰æ•°æ®åº“çš„æ•°æ®æ€»é‡ï¼Œå³keyçš„ä¸ªæ•°flushdb #æ¸…é™¤å½“å‰æ•°æ®åº“çš„æ‰€æœ‰æ•°æ®(æ…ç”¨)flushall #æ¸…é™¤æ‰€æœ‰æ•°æ®(æ…ç”¨) åœ¨æ‰§è¡Œ FLUSHDB è¿™æ ·çš„å±é™©å‘½ä»¤ä¹‹å‰ï¼Œæœ€å¥½å…ˆæ‰§è¡Œä¸€ä¸ª SELECT å‘½ä»¤ï¼Œä¿è¯å½“å‰æ‰€æ“ä½œçš„æ•°æ®åº“æ˜¯ç›®æ ‡æ•°æ®åº“ æ—¶æ•ˆè®¾ç½®å®¢æˆ·ç«¯å¯ä»¥ä»¥ç§’æˆ–æ¯«ç§’çš„ç²¾åº¦ä¸ºæ•°æ®åº“ä¸­çš„æŸä¸ªé”®è®¾ç½®ç”Ÿå­˜æ—¶é—´ï¼ˆTimeTo Live, TTLï¼‰ï¼Œåœ¨ç»è¿‡æŒ‡å®šæ—¶é—´ä¹‹åï¼ŒæœåŠ¡å™¨å°±ä¼šè‡ªåŠ¨åˆ é™¤ç”Ÿå­˜æ—¶é—´ä¸º 0 çš„é”®ï¼›ä¹Ÿå¯ä»¥ä»¥ UNIX æ—¶é—´æˆ³çš„æ–¹å¼è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆexpire timeï¼‰ï¼Œå½“é”®çš„è¿‡æœŸæ—¶é—´åˆ°è¾¾ï¼ŒæœåŠ¡å™¨ä¼šè‡ªåŠ¨åˆ é™¤è¿™ä¸ªé”® 1234expire key seconds #ä¸ºæŒ‡å®škeyè®¾ç½®ç”Ÿå­˜æ—¶é—´ï¼Œå•ä½ä¸ºç§’pexpire key milliseconds #ä¸ºæŒ‡å®škeyè®¾ç½®ç”Ÿå­˜æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’expireat key timestamp #ä¸ºæŒ‡å®škeyè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºæ—¶é—´æˆ³pexpireat key mil-timestamp #ä¸ºæŒ‡å®škeyè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’æ—¶é—´æˆ³ å®é™…ä¸Š EXPIREã€EXPIREã€EXPIREAT ä¸‰ä¸ªå‘½ä»¤åº•å±‚éƒ½æ˜¯è½¬æ¢ä¸º PEXPIREAT å‘½ä»¤æ¥å®ç°çš„ SETEX å‘½ä»¤å¯ä»¥åœ¨è®¾ç½®ä¸€ä¸ªå­—ç¬¦ä¸²é”®çš„åŒæ—¶ä¸ºé”®è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œä½†æ˜¯è¯¥å‘½ä»¤æ˜¯ä¸€ä¸ªç±»å‹é™å®šå‘½ä»¤ redisDb ç»“æ„çš„ expires å­—å…¸ä¿å­˜äº†æ•°æ®åº“ä¸­æ‰€æœ‰é”®çš„è¿‡æœŸæ—¶é—´ï¼Œå­—å…¸ç§°ä¸ºè¿‡æœŸå­—å…¸ï¼š é”®æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘é”®ç©ºé—´ä¸­çš„æŸä¸ªé”®å¯¹è±¡ï¼ˆå¤ç”¨é”®ç©ºé—´çš„å¯¹è±¡ï¼Œä¸ä¼šäº§ç”Ÿå†…å­˜æµªè´¹ï¼‰ å€¼æ˜¯ä¸€ä¸ª long long ç±»å‹çš„æ•´æ•°ï¼Œä¿å­˜äº†é”®çš„è¿‡æœŸæ—¶é—´ï¼Œæ˜¯ä¸€ä¸ªæ¯«ç§’ç²¾åº¦çš„ UNIX æ—¶é—´æˆ³ 1234typedef struct redisDB &#123; // è¿‡æœŸå­—å…¸ï¼Œä¿å­˜æ‰€æœ‰é”®çš„è¿‡æœŸæ—¶é—´ dict *expires&#125; redisDB; å®¢æˆ·ç«¯æ‰§è¡Œ PEXPIREAT å‘½ä»¤ï¼ŒæœåŠ¡å™¨ä¼šåœ¨æ•°æ®åº“çš„è¿‡æœŸå­—å…¸ä¸­å…³è”ç»™å®šçš„æ•°æ®åº“é”®å’Œè¿‡æœŸæ—¶é—´ï¼š 12345678910def PEXPIREAT(key, expire_time_in_ms): # å¦‚æœç»™å®šçš„é”®ä¸å­˜åœ¨äºé”®ç©ºé—´ï¼Œé‚£ä¹ˆä¸èƒ½è®¾ç½®è¿‡æœŸæ—¶é—´ if key not in redisDb.dict: return 0 # åœ¨è¿‡æœŸå­—å…¸ä¸­å…³è”é”®å’Œè¿‡æœŸæ—¶é—´ redisDB.expires[key] = expire_time_in_ms # è¿‡æœŸæ—¶é—´è®¾ç½®æˆåŠŸ return 1 æ—¶æ•ˆçŠ¶æ€TTL å’Œ PTTL å‘½ä»¤é€šè¿‡è®¡ç®—é”®çš„è¿‡æœŸæ—¶é—´å’Œå½“å‰æ—¶é—´ä¹‹é—´çš„å·®ï¼Œè¿”å›è¿™ä¸ªé”®çš„å‰©ä½™ç”Ÿå­˜æ—¶é—´ è¿”å›æ­£æ•°ä»£è¡¨è¯¥æ•°æ®åœ¨å†…å­˜ä¸­è¿˜èƒ½å­˜æ´»çš„æ—¶é—´ è¿”å› -1 ä»£è¡¨æ°¸ä¹…æ€§ï¼Œè¿”å› -2 ä»£è¡¨é”®ä¸å­˜åœ¨ 12ttl key #è·å–keyçš„å‰©ä½™æ—¶é—´ï¼Œæ¯æ¬¡è·å–ä¼šè‡ªåŠ¨å˜åŒ–(å‡å°)ï¼Œç±»ä¼¼äºå€’è®¡æ—¶pttl key #è·å–keyçš„å‰©ä½™æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ï¼Œæ¯æ¬¡è·å–ä¼šè‡ªåŠ¨å˜åŒ–(å‡å°) PERSIST æ˜¯ PEXPIREAT å‘½ä»¤çš„åæ“ä½œï¼Œåœ¨è¿‡æœŸå­—å…¸ä¸­æŸ¥æ‰¾ç»™å®šçš„é”®ï¼Œå¹¶è§£é™¤é”®å’Œå€¼ï¼ˆè¿‡æœŸæ—¶é—´ï¼‰åœ¨è¿‡æœŸå­—å…¸ä¸­çš„å…³è” 1persist key #åˆ‡æ¢keyä»æ—¶æ•ˆæ€§è½¬æ¢ä¸ºæ°¸ä¹…æ€§ Redis é€šè¿‡è¿‡æœŸå­—å…¸å¯ä»¥æ£€æŸ¥ä¸€ä¸ªç»™å®šé”®æ˜¯å¦è¿‡æœŸï¼š æ£€æŸ¥ç»™å®šé”®æ˜¯å¦å­˜åœ¨äºè¿‡æœŸå­—å…¸ï¼šå¦‚æœå­˜åœ¨ï¼Œé‚£ä¹ˆå–å¾—é”®çš„è¿‡æœŸæ—¶é—´ æ£€æŸ¥å½“å‰ UNIX æ—¶é—´æˆ³æ˜¯å¦å¤§äºé”®çš„è¿‡æœŸæ—¶é—´ï¼šå¦‚æœæ˜¯é‚£ä¹ˆé”®å·²ç»è¿‡æœŸï¼Œå¦åˆ™é”®æœªè¿‡æœŸ è¡¥å……ï¼šAOFã€RDB å’Œå¤åˆ¶åŠŸèƒ½å¯¹è¿‡æœŸé”®çš„å¤„ç† RDB ï¼š ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œç¨‹åºä¼šå¯¹æ•°æ®åº“ä¸­çš„é”®è¿›è¡Œæ£€æŸ¥ï¼Œå·²è¿‡æœŸçš„é”®ä¸ä¼šè¢«ä¿å­˜åˆ°æ–°åˆ›å»ºçš„ RDB æ–‡ä»¶ä¸­ è½½å…¥ RDB æ–‡ä»¶ï¼Œå¦‚æœæœåŠ¡å™¨ä»¥ä¸»æœåŠ¡å™¨æ¨¡å¼è¿è¡Œï¼Œé‚£ä¹ˆåœ¨è½½å…¥æ—¶ä¼šå¯¹é”®è¿›è¡Œæ£€æŸ¥ï¼Œè¿‡æœŸé”®ä¼šè¢«å¿½ç•¥ï¼›å¦‚æœæœåŠ¡å™¨ä»¥ä»æœåŠ¡å™¨æ¨¡å¼è¿è¡Œï¼Œä¼šè½½å…¥æ‰€æœ‰é”®ï¼ŒåŒ…æ‹¬è¿‡æœŸé”®ï¼Œä½†æ˜¯ä¸»ä»æœåŠ¡å™¨è¿›è¡Œæ•°æ®åŒæ­¥æ—¶å°±ä¼šåˆ é™¤è¿™äº›é”® AOFï¼š å†™å…¥ AOF æ–‡ä»¶ï¼Œå¦‚æœæ•°æ®åº“ä¸­çš„æŸä¸ªé”®å·²ç»è¿‡æœŸï¼Œä½†è¿˜æ²¡æœ‰è¢«åˆ é™¤ï¼Œé‚£ä¹ˆ AOF æ–‡ä»¶ä¸ä¼šå› ä¸ºè¿™ä¸ªè¿‡æœŸé”®è€Œäº§ç”Ÿä»»ä½•å½±å“ï¼›å½“è¯¥è¿‡æœŸé”®è¢«åˆ é™¤ï¼Œç¨‹åºä¼šå‘ AOF æ–‡ä»¶è¿½åŠ ä¸€æ¡ DEL å‘½ä»¤ï¼Œæ˜¾å¼çš„åˆ é™¤è¯¥é”® AOF é‡å†™ï¼Œä¼šå¯¹æ•°æ®åº“ä¸­çš„é”®è¿›è¡Œæ£€æŸ¥ï¼Œå¿½ç•¥å·²ç»è¿‡æœŸçš„é”® å¤åˆ¶ï¼šå½“æœåŠ¡å™¨è¿è¡Œåœ¨å¤åˆ¶æ¨¡å¼ä¸‹æ—¶ï¼Œä»æœåŠ¡å™¨çš„è¿‡æœŸé”®åˆ é™¤åŠ¨ä½œç”±ä¸»æœåŠ¡å™¨æ§åˆ¶ ä¸»æœåŠ¡å™¨åœ¨åˆ é™¤ä¸€ä¸ªè¿‡æœŸé”®ä¹‹åï¼Œä¼šæ˜¾å¼åœ°å‘æ‰€æœ‰ä»æœåŠ¡å™¨å‘é€ä¸€ä¸ª DEL å‘½ä»¤ï¼Œå‘ŠçŸ¥ä»æœåŠ¡å™¨åˆ é™¤è¿™ä¸ªè¿‡æœŸé”® ä»æœåŠ¡å™¨åœ¨æ‰§è¡Œå®¢æˆ·ç«¯å‘é€çš„è¯»å‘½ä»¤æ—¶ï¼Œå³ä½¿ç¢°åˆ°è¿‡æœŸé”®ä¹Ÿä¸ä¼šå°†è¿‡æœŸé”®åˆ é™¤ï¼Œä¼šå½“ä½œæœªè¿‡æœŸé”®å¤„ç†ï¼Œåªæœ‰åœ¨æ¥åˆ°ä¸»æœåŠ¡å™¨å‘æ¥çš„ DEL å‘½ä»¤ä¹‹åï¼Œæ‰ä¼šåˆ é™¤è¿‡æœŸé”®ï¼ˆæ•°æ®ä¸ä¸€è‡´ï¼‰ è¿‡æœŸåˆ é™¤åˆ é™¤ç­–ç•¥åˆ é™¤ç­–ç•¥å°±æ˜¯é’ˆå¯¹å·²è¿‡æœŸæ•°æ®çš„å¤„ç†ç­–ç•¥ï¼Œå·²è¿‡æœŸçš„æ•°æ®ä¸ä¸€å®šè¢«ç«‹å³åˆ é™¤ï¼Œåœ¨ä¸åŒçš„åœºæ™¯ä¸‹ä½¿ç”¨ä¸åŒçš„åˆ é™¤æ–¹å¼ä¼šæœ‰ä¸åŒæ•ˆæœï¼Œåœ¨å†…å­˜å ç”¨ä¸ CPU å ç”¨ä¹‹é—´å¯»æ‰¾ä¸€ç§å¹³è¡¡ï¼Œé¡¾æ­¤å¤±å½¼éƒ½ä¼šé€ æˆæ•´ä½“ Redis æ€§èƒ½çš„ä¸‹é™ï¼Œç”šè‡³å¼•å‘æœåŠ¡å™¨å®•æœºæˆ–å†…å­˜æ³„éœ² é’ˆå¯¹è¿‡æœŸæ•°æ®æœ‰ä¸‰ç§åˆ é™¤ç­–ç•¥ï¼š å®šæ—¶åˆ é™¤ æƒ°æ€§åˆ é™¤ï¼ˆè¢«åŠ¨åˆ é™¤ï¼‰ å®šæœŸåˆ é™¤ Redis é‡‡ç”¨æƒ°æ€§åˆ é™¤å’Œå®šæœŸåˆ é™¤ç­–ç•¥çš„ç»“åˆä½¿ç”¨ å®šæ—¶åˆ é™¤åœ¨è®¾ç½®é”®çš„è¿‡æœŸæ—¶é—´çš„åŒæ—¶ï¼Œåˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ï¼ˆtimerï¼‰ï¼Œè®©å®šæ—¶å™¨åœ¨é”®çš„è¿‡æœŸæ—¶é—´åˆ°è¾¾æ—¶ï¼Œç«‹å³æ‰§è¡Œå¯¹é”®çš„åˆ é™¤æ“ä½œ ä¼˜ç‚¹ï¼šèŠ‚çº¦å†…å­˜ï¼Œåˆ°æ—¶å°±åˆ é™¤ï¼Œå¿«é€Ÿé‡Šæ”¾æ‰ä¸å¿…è¦çš„å†…å­˜å ç”¨ ç¼ºç‚¹ï¼šå¯¹ CPU ä¸å‹å¥½ï¼Œæ— è®º CPU æ­¤æ—¶è´Ÿè½½å¤šé«˜å‡å ç”¨ CPUï¼Œä¼šå½±å“ Redis æœåŠ¡å™¨å“åº”æ—¶é—´å’ŒæŒ‡ä»¤ååé‡ æ€»ç»“ï¼šç”¨å¤„ç†å™¨æ€§èƒ½æ¢å–å­˜å‚¨ç©ºé—´ï¼ˆæ‹¿æ—¶é—´æ¢ç©ºé—´ï¼‰ åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨éœ€è¦ç”¨åˆ° Redis æœåŠ¡å™¨ä¸­çš„æ—¶é—´äº‹ä»¶ï¼Œè€Œæ—¶é—´äº‹ä»¶çš„å®ç°æ–¹å¼æ˜¯æ— åºé“¾è¡¨ï¼ŒæŸ¥æ‰¾ä¸€ä¸ªäº‹ä»¶çš„æ—¶é—´å¤æ‚åº¦ä¸º O(N)ï¼Œå¹¶ä¸èƒ½é«˜æ•ˆåœ°å¤„ç†å¤§é‡æ—¶é—´äº‹ä»¶ï¼Œæ‰€ä»¥é‡‡ç”¨è¿™ç§æ–¹å¼å¹¶ä¸ç°å® æƒ°æ€§åˆ é™¤æ•°æ®åˆ°è¾¾è¿‡æœŸæ—¶é—´ä¸åšå¤„ç†ï¼Œç­‰ä¸‹æ¬¡è®¿é—®åˆ°è¯¥æ•°æ®æ—¶æ‰§è¡Œ expireIfNeeded() åˆ¤æ–­ï¼š å¦‚æœè¾“å…¥é”®å·²ç»è¿‡æœŸï¼Œé‚£ä¹ˆ expireIfNeeded å‡½æ•°å°†è¾“å…¥é”®ä»æ•°æ®åº“ä¸­åˆ é™¤ï¼Œæ¥ç€è®¿é—®å°±ä¼šè¿”å›ç©º å¦‚æœè¾“å…¥é”®æœªè¿‡æœŸï¼Œé‚£ä¹ˆ expireIfNeeded å‡½æ•°ä¸åšåŠ¨ä½œ æ‰€æœ‰çš„ Redis è¯»å†™å‘½ä»¤åœ¨æ‰§è¡Œå‰éƒ½ä¼šè°ƒç”¨ expireIfNeeded å‡½æ•°è¿›è¡Œæ£€æŸ¥ï¼Œè¯¥å‡½æ•°å°±åƒä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œåœ¨å‘½ä»¤çœŸæ­£æ‰§è¡Œä¹‹å‰è¿‡æ»¤æ‰è¿‡æœŸé”® æƒ°æ€§åˆ é™¤çš„ç‰¹ç‚¹ï¼š ä¼˜ç‚¹ï¼šèŠ‚çº¦ CPU æ€§èƒ½ï¼Œåˆ é™¤çš„ç›®æ ‡ä»…é™äºå½“å‰å¤„ç†çš„é”®ï¼Œä¸ä¼šåœ¨åˆ é™¤å…¶ä»–æ— å…³çš„è¿‡æœŸé”®ä¸ŠèŠ±è´¹ä»»ä½• CPU æ—¶é—´ ç¼ºç‚¹ï¼šå†…å­˜å‹åŠ›å¾ˆå¤§ï¼Œå‡ºç°é•¿æœŸå ç”¨å†…å­˜çš„æ•°æ®ï¼Œå¦‚æœè¿‡æœŸé”®æ°¸è¿œä¸è¢«è®¿é—®ï¼Œè¿™ç§æƒ…å†µç›¸å½“äºå†…å­˜æ³„æ¼ æ€»ç»“ï¼šç”¨å­˜å‚¨ç©ºé—´æ¢å–å¤„ç†å™¨æ€§èƒ½ï¼ˆæ‹¿ç©ºé—´æ¢æ—¶é—´ï¼‰ å®šæœŸåˆ é™¤å®šæœŸåˆ é™¤ç­–ç•¥æ˜¯æ¯éš”ä¸€æ®µæ—¶é—´æ‰§è¡Œä¸€æ¬¡åˆ é™¤è¿‡æœŸé”®æ“ä½œï¼Œå¹¶é€šè¿‡é™åˆ¶åˆ é™¤æ“ä½œæ‰§è¡Œçš„æ—¶é•¿å’Œé¢‘ç‡æ¥å‡å°‘åˆ é™¤æ“ä½œå¯¹ CPU æ—¶é—´çš„å½±å“ å¦‚æœåˆ é™¤æ“ä½œæ‰§è¡Œå¾—å¤ªé¢‘ç¹ï¼Œæˆ–è€…æ‰§è¡Œæ—¶é—´å¤ªé•¿ï¼Œå°±ä¼šé€€åŒ–æˆå®šæ—¶åˆ é™¤ç­–ç•¥ï¼Œå°† CPU æ—¶é—´è¿‡å¤šåœ°æ¶ˆè€—åœ¨åˆ é™¤è¿‡æœŸé”®ä¸Š å¦‚æœåˆ é™¤æ“ä½œæ‰§è¡Œå¾—å¤ªå°‘ï¼Œæˆ–è€…æ‰§è¡Œæ—¶é—´å¤ªçŸ­ï¼Œå®šæœŸåˆ é™¤ç­–ç•¥åˆä¼šå’Œæƒ°æ€§åˆ é™¤ç­–ç•¥ä¸€æ ·ï¼Œå‡ºç°æµªè´¹å†…å­˜çš„æƒ…å†µ å®šæœŸåˆ é™¤æ˜¯å‘¨æœŸæ€§è½®è¯¢ Redis åº“ä¸­çš„æ—¶æ•ˆæ€§æ•°æ®ï¼Œä»è¿‡æœŸå­—å…¸ä¸­éšæœºæŠ½å–ä¸€éƒ¨åˆ†é”®æ£€æŸ¥ï¼Œåˆ©ç”¨è¿‡æœŸæ•°æ®å æ¯”çš„æ–¹å¼æ§åˆ¶åˆ é™¤é¢‘åº¦ Redis å¯åŠ¨æœåŠ¡å™¨åˆå§‹åŒ–æ—¶ï¼Œè¯»å–é…ç½® server.hz çš„å€¼ï¼Œé»˜è®¤ä¸º 10ï¼Œæ‰§è¡ŒæŒ‡ä»¤ info server å¯ä»¥æŸ¥çœ‹ï¼Œæ¯ç§’é’Ÿæ‰§è¡Œ server.hz æ¬¡ serverCron() â†’ activeExpireCycle() activeExpireCycle() å¯¹æŸä¸ªæ•°æ®åº“ä¸­çš„æ¯ä¸ª expires è¿›è¡Œæ£€æµ‹ï¼Œå·¥ä½œæ¨¡å¼ï¼š è½®è¯¢æ¯ä¸ªæ•°æ®åº“ï¼Œä»æ•°æ®åº“ä¸­å–å‡ºä¸€å®šæ•°é‡çš„éšæœºé”®è¿›è¡Œæ£€æŸ¥ï¼Œå¹¶åˆ é™¤å…¶ä¸­çš„è¿‡æœŸé”®ï¼Œå¦‚æœè¿‡æœŸ key çš„æ¯”ä¾‹è¶…è¿‡äº† 25%ï¼Œåˆ™ç»§ç»­é‡å¤æ­¤è¿‡ç¨‹ï¼Œç›´åˆ°è¿‡æœŸ key çš„æ¯”ä¾‹ä¸‹é™åˆ° 25% ä»¥ä¸‹ï¼Œæˆ–è€…è¿™æ¬¡ä»»åŠ¡çš„æ‰§è¡Œè€—æ—¶è¶…è¿‡äº† 25 æ¯«ç§’ å…¨å±€å˜é‡ current_db ç”¨äºè®°å½• activeExpireCycle() çš„æ£€æŸ¥è¿›åº¦ï¼ˆå“ªä¸€ä¸ªæ•°æ®åº“ï¼‰ï¼Œä¸‹ä¸€æ¬¡è°ƒç”¨æ—¶æ¥ç€è¯¥è¿›åº¦å¤„ç† éšç€å‡½æ•°çš„ä¸æ–­æ‰§è¡Œï¼ŒæœåŠ¡å™¨ä¸­çš„æ‰€æœ‰æ•°æ®åº“éƒ½ä¼šè¢«æ£€æŸ¥ä¸€éï¼Œè¿™æ—¶å°† current_db é‡ç½®ä¸º 0ï¼Œç„¶åå†æ¬¡å¼€å§‹æ–°ä¸€è½®çš„æ£€æŸ¥ å®šæœŸåˆ é™¤ç‰¹ç‚¹ï¼š CPU æ€§èƒ½å ç”¨è®¾ç½®æœ‰å³°å€¼ï¼Œæ£€æµ‹é¢‘åº¦å¯è‡ªå®šä¹‰è®¾ç½® å†…å­˜å‹åŠ›ä¸æ˜¯å¾ˆå¤§ï¼Œé•¿æœŸå ç”¨å†…å­˜çš„å†·æ•°æ®ä¼šè¢«æŒç»­æ¸…ç† å‘¨æœŸæ€§æŠ½æŸ¥å­˜å‚¨ç©ºé—´ï¼ˆéšæœºæŠ½æŸ¥ï¼Œé‡ç‚¹æŠ½æŸ¥ï¼‰ æ•°æ®æ·˜æ±°é€å‡ºç®—æ³•æ•°æ®æ·˜æ±°ç­–ç•¥ï¼šå½“æ–°æ•°æ®è¿›å…¥ Redis æ—¶ï¼Œåœ¨æ‰§è¡Œæ¯ä¸€ä¸ªå‘½ä»¤å‰ï¼Œä¼šè°ƒç”¨ freeMemoryIfNeeded() æ£€æµ‹å†…å­˜æ˜¯å¦å……è¶³ã€‚å¦‚æœå†…å­˜ä¸æ»¡è¶³æ–°åŠ å…¥æ•°æ®çš„æœ€ä½å­˜å‚¨è¦æ±‚ï¼ŒRedis è¦ä¸´æ—¶åˆ é™¤ä¸€äº›æ•°æ®ä¸ºå½“å‰æŒ‡ä»¤æ¸…ç†å­˜å‚¨ç©ºé—´ï¼Œæ¸…ç†æ•°æ®çš„ç­–ç•¥ç§°ä¸ºé€å‡ºç®—æ³• é€å‡ºæ•°æ®çš„è¿‡ç¨‹ä¸æ˜¯ 100% èƒ½å¤Ÿæ¸…ç†å‡ºè¶³å¤Ÿçš„å¯ä½¿ç”¨çš„å†…å­˜ç©ºé—´ï¼Œå¦‚æœä¸æˆåŠŸåˆ™åå¤æ‰§è¡Œï¼Œå½“å¯¹æ‰€æœ‰æ•°æ®å°è¯•å®Œæ¯•ï¼Œå¦‚ä¸èƒ½è¾¾åˆ°å†…å­˜æ¸…ç†çš„è¦æ±‚ï¼Œå‡ºç° Redis å†…å­˜æ‰“æ»¡å¼‚å¸¸ï¼š 1(error) OOM command not allowed when used memory &gt;&#x27;maxmemory&#x27; ç­–ç•¥é…ç½®Redis å¦‚æœä¸è®¾ç½®æœ€å¤§å†…å­˜å¤§å°æˆ–è€…è®¾ç½®æœ€å¤§å†…å­˜å¤§å°ä¸º 0ï¼Œåœ¨ 64 ä½æ“ä½œç³»ç»Ÿä¸‹ä¸é™åˆ¶å†…å­˜å¤§å°ï¼Œåœ¨ 32 ä½æ“ä½œç³»ç»Ÿé»˜è®¤ä¸º 3GB å†…å­˜ï¼Œä¸€èˆ¬æ¨èè®¾ç½® Redis å†…å­˜ä¸ºæœ€å¤§ç‰©ç†å†…å­˜çš„å››åˆ†ä¹‹ä¸‰ å†…å­˜é…ç½®æ–¹å¼ï¼š é€šè¿‡ä¿®æ”¹æ–‡ä»¶é…ç½®ï¼ˆæ°¸ä¹…ç”Ÿæ•ˆï¼‰ï¼šä¿®æ”¹é…ç½®æ–‡ä»¶ maxmemory å­—æ®µï¼Œå•ä½ä¸ºå­—èŠ‚ é€šè¿‡å‘½ä»¤ä¿®æ”¹ï¼ˆé‡å¯å¤±æ•ˆï¼‰ï¼š config set maxmemory 104857600ï¼šè®¾ç½® Redis æœ€å¤§å ç”¨å†…å­˜ä¸º 100MB config get maxmemoryï¼šè·å– Redis æœ€å¤§å ç”¨å†…å­˜ info ï¼šå¯ä»¥æŸ¥çœ‹ Redis å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œused_memory_human å­—æ®µè¡¨ç¤ºå®é™…å·²ç»å ç”¨çš„å†…å­˜ï¼Œmaxmemory è¡¨ç¤ºæœ€å¤§å ç”¨å†…å­˜ å½±å“æ•°æ®æ·˜æ±°çš„ç›¸å…³é…ç½®å¦‚ä¸‹ï¼Œé…ç½® conf æ–‡ä»¶ï¼š æ¯æ¬¡é€‰å–å¾…åˆ é™¤æ•°æ®çš„ä¸ªæ•°ï¼Œé‡‡ç”¨éšæœºè·å–æ•°æ®çš„æ–¹å¼ä½œä¸ºå¾…æ£€æµ‹åˆ é™¤æ•°æ®ï¼Œé˜²æ­¢å…¨åº“æ‰«æï¼Œå¯¼è‡´ä¸¥é‡çš„æ€§èƒ½æ¶ˆè€—ï¼Œé™ä½è¯»å†™æ€§èƒ½ 1maxmemory-samples count è¾¾åˆ°æœ€å¤§å†…å­˜åçš„ï¼Œå¯¹è¢«æŒ‘é€‰å‡ºæ¥çš„æ•°æ®è¿›è¡Œåˆ é™¤çš„ç­–ç•¥ 1maxmemory-policy policy æ•°æ®åˆ é™¤çš„ç­–ç•¥ policyï¼š3 ç±» 8 ç§ ç¬¬ä¸€ç±»ï¼šæ£€æµ‹æ˜“å¤±æ•°æ®ï¼ˆå¯èƒ½ä¼šè¿‡æœŸçš„æ•°æ®é›† server.db[i].expiresï¼‰ï¼š 1234volatile-lru # å¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key é€‰æ‹©æœ€è¿‘æœ€ä¹…æœªä½¿ç”¨ä½¿ç”¨çš„æ•°æ®æ·˜æ±°volatile-lfu # å¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key é€‰æ‹©æœ€è¿‘ä½¿ç”¨æ¬¡æ•°æœ€å°‘çš„æ•°æ®æ·˜æ±°volatile-ttl # å¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key é€‰æ‹©å°†è¦è¿‡æœŸçš„æ•°æ®æ·˜æ±°volatile-random # å¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key é€‰æ‹©ä»»æ„æ•°æ®æ·˜æ±° ç¬¬äºŒç±»ï¼šæ£€æµ‹å…¨åº“æ•°æ®ï¼ˆæ‰€æœ‰æ•°æ®é›† server.db[i].dict ï¼‰ï¼š 123allkeys-lru # å¯¹æ‰€æœ‰ key é€‰æ‹©æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°allkeLyRs-lfu # å¯¹æ‰€æœ‰ key é€‰æ‹©æœ€è¿‘ä½¿ç”¨æ¬¡æ•°æœ€å°‘çš„æ•°æ®æ·˜æ±°allkeys-random # å¯¹æ‰€æœ‰ key é€‰æ‹©ä»»æ„æ•°æ®æ·˜æ±°ï¼Œç›¸å½“äºéšæœº ç¬¬ä¸‰ç±»ï¼šæ”¾å¼ƒæ•°æ®é©±é€ 1no-enviction #ç¦æ­¢é©±é€æ•°æ®(redis4.0ä¸­é»˜è®¤ç­–ç•¥)ï¼Œä¼šå¼•å‘OOM(Out Of Memory) æ•°æ®æ·˜æ±°ç­–ç•¥é…ç½®ä¾æ®ï¼šä½¿ç”¨ INFO å‘½ä»¤è¾“å‡ºç›‘æ§ä¿¡æ¯ï¼ŒæŸ¥è¯¢ç¼“å­˜ hit å’Œ miss çš„æ¬¡æ•°ï¼Œæ ¹æ®éœ€æ±‚è°ƒä¼˜ Redis é…ç½® æ’åºæœºåˆ¶åŸºæœ¬ä»‹ç»Redis çš„ SORT å‘½ä»¤å¯ä»¥å¯¹åˆ—è¡¨é”®ã€é›†åˆé”®æˆ–è€…æœ‰åºé›†åˆé”®çš„å€¼è¿›è¡Œæ’åºï¼Œå¹¶ä¸æ›´æ”¹é›†åˆä¸­çš„æ•°æ®ä½ç½®ï¼Œåªæ˜¯æŸ¥è¯¢ 12SORT key [ASC/DESC] #å¯¹keyä¸­æ•°æ®æ’åºï¼Œé»˜è®¤å¯¹æ•°å­—æ’åºï¼Œå¹¶ä¸æ›´æ”¹é›†åˆä¸­çš„æ•°æ®ä½ç½®ï¼Œåªæ˜¯æŸ¥è¯¢SORT key ALPHA #å¯¹keyä¸­å­—æ¯æ’åºï¼ŒæŒ‰ç…§å­—å…¸åº SORTSORT &lt;key&gt; å‘½ä»¤å¯ä»¥å¯¹ä¸€ä¸ªåŒ…å«æ•°å­—å€¼çš„é”® key è¿›è¡Œæ’åº å‡è®¾ RPUSH numbers 3 1 2ï¼Œæ‰§è¡Œ SORT numbers çš„è¯¦ç»†æ­¥éª¤ï¼š åˆ›å»ºä¸€ä¸ªå’Œ key åˆ—è¡¨é•¿åº¦ç›¸åŒçš„æ•°ç»„ï¼Œæ•°ç»„æ¯é¡¹éƒ½æ˜¯ redisSortObject ç»“æ„ 123456789101112typedef struct redisSortObject &#123; // è¢«æ’åºé”®çš„å€¼ robj *obj; // æƒé‡ union &#123; // æ’åºæ•°å­—å€¼æ—¶ä½¿ç”¨ double score; // æ’åºå¸¦æœ‰ BY é€‰é¡¹çš„å­—ç¬¦ä¸² robj *cmpobj; &#125; u;&#125; éå†æ•°ç»„ï¼Œå°†å„ä¸ªæ•°ç»„é¡¹çš„ obj æŒ‡é’ˆåˆ†åˆ«æŒ‡å‘ numbers åˆ—è¡¨çš„å„ä¸ªé¡¹ éå†æ•°ç»„ï¼Œå°† obj æŒ‡é’ˆæ‰€æŒ‡å‘çš„åˆ—è¡¨é¡¹è½¬æ¢æˆä¸€ä¸ª double ç±»å‹çš„æµ®ç‚¹æ•°ï¼Œå¹¶å°†æµ®ç‚¹æ•°ä¿å­˜åœ¨å¯¹åº”æ•°ç»„é¡¹çš„ u.score å±æ€§é‡Œ æ ¹æ®æ•°ç»„é¡¹ u.score å±æ€§çš„å€¼ï¼Œå¯¹æ•°ç»„è¿›è¡Œæ•°å­—å€¼æ’åºï¼Œæ’åºåçš„æ•°ç»„é¡¹æŒ‰ u.score å±æ€§çš„å€¼ä»å°åˆ°å¤§æ’åˆ— éå†æ•°ç»„ï¼Œå°†å„ä¸ªæ•°ç»„é¡¹çš„ obj æŒ‡é’ˆæ‰€æŒ‡å‘çš„å€¼ä½œä¸ºæ’åºç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œç¨‹åºé¦–å…ˆè®¿é—®æ•°ç»„çš„ç´¢å¼• 0ï¼Œä¾æ¬¡å‘åè®¿é—® å¯¹äº SORT key [ASC/DESC] å‡½æ•°ï¼š åœ¨æ‰§è¡Œå‡åºæ’åºæ—¶ï¼Œæ’åºç®—æ³•ä½¿ç”¨çš„å¯¹æ¯”å‡½æ•°äº§ç”Ÿå‡åºå¯¹æ¯”ç»“æœ åœ¨æ‰§è¡Œé™åºæ’åºæ—¶ï¼Œæ’åºç®—æ³•ä½¿ç”¨çš„å¯¹æ¯”å‡½æ•°äº§ç”Ÿé™åºå¯¹æ¯”ç»“æœ BYSORT å‘½ä»¤é»˜è®¤ä½¿ç”¨è¢«æ’åºé”®ä¸­åŒ…å«çš„å…ƒç´ ä½œä¸ºæ’åºçš„æƒé‡ï¼Œå…ƒç´ æœ¬èº«å†³å®šäº†å…ƒç´ åœ¨æ’åºä¹‹åæ‰€å¤„çš„ä½ç½®ï¼Œé€šè¿‡ä½¿ç”¨ BY é€‰é¡¹ï¼ŒSORT å‘½ä»¤å¯ä»¥æŒ‡å®šæŸäº›å­—ç¬¦ä¸²é”®ï¼Œæˆ–è€…æŸä¸ªå“ˆå¸Œé”®æ‰€åŒ…å«çš„æŸäº›åŸŸï¼ˆfieldï¼‰æ¥ä½œä¸ºå…ƒç´ çš„æƒé‡ï¼Œå¯¹ä¸€ä¸ªé”®è¿›è¡Œæ’åº 12SORT &lt;key&gt; BY &lt;pattern&gt; # æ•°å€¼SORT &lt;key&gt; BY &lt;pattern&gt; ALPHA # å­—ç¬¦ 123456redis&gt; SADD fruits &quot;apple&quot; &quot;banana&quot; &quot;cherry&quot; (integer) 3redis&gt; SORT fruits ALPHA1) &quot;apple&quot;2) &quot;banana&quot;3) &quot;cherry&quot; 1234567redis&gt; MSET apple-price 8 banana-price 5.5 cherry-price 7 OK# ä½¿ç”¨æ°´æœçš„ä»·é’±è¿›è¡Œæ’åºredis&gt; SORT fruits BY *-price1) &quot;banana&quot;2) &quot;cherry&quot;3) &quot;apple&quot; å®ç°åŸç†ï¼šæ’åºæ—¶çš„ u.score å±æ€§å°±ä¼šè¢«è®¾ç½®ä¸ºå¯¹åº”çš„æƒé‡ LIMITSORT å‘½ä»¤é»˜è®¤ä¼šå°†æ’åºåçš„æ‰€æœ‰å…ƒç´ éƒ½è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œé€šè¿‡ LIMIT é€‰é¡¹å¯ä»¥è®© SORT å‘½ä»¤åªè¿”å›å…¶ä¸­ä¸€éƒ¨åˆ†å·²æ’åºçš„å…ƒç´  1LIMIT &lt;offset&gt; &lt;count&gt; offset å‚æ•°è¡¨ç¤ºè¦è·³è¿‡çš„å·²æ’åºå…ƒç´ æ•°é‡ count å‚æ•°è¡¨ç¤ºè·³è¿‡ç»™å®šæ•°é‡çš„å…ƒç´ åï¼Œè¦è¿”å›çš„å·²æ’åºå…ƒç´ æ•°é‡ 12345# å¯¹åº” a b c d e f gredis&gt; SORT alphabet ALPHA LIMIT 2 31) &quot;c&quot;2) &quot;d&quot;3) &quot;e&quot; å®ç°åŸç†ï¼šåœ¨æ’åºåçš„ redisSortObject ç»“æ„æ•°ç»„ä¸­ï¼Œå°†æŒ‡é’ˆç§»åŠ¨åˆ°æ•°ç»„çš„ç´¢å¼• 2 ä¸Šï¼Œä¾æ¬¡è®¿é—® array[2]ã€array[3]ã€array[4] è¿™ 3 ä¸ªæ•°ç»„é¡¹ï¼Œå¹¶å°†æ•°ç»„é¡¹çš„ obj æŒ‡é’ˆæ‰€æŒ‡å‘çš„å…ƒç´ è¿”å›ç»™å®¢æˆ·ç«¯ GETSORT å‘½ä»¤é»˜è®¤åœ¨å¯¹é”®è¿›è¡Œæ’åºåï¼Œè¿”å›è¢«æ’åºé”®æœ¬èº«æ‰€åŒ…å«çš„å…ƒç´ ï¼Œé€šè¿‡ä½¿ç”¨ GET é€‰é¡¹ï¼Œ å¯ä»¥åœ¨å¯¹é”®è¿›è¡Œæ’åºåï¼Œæ ¹æ®è¢«æ’åºçš„å…ƒç´ ä»¥åŠ GET é€‰é¡¹æ‰€æŒ‡å®šçš„æ¨¡å¼ï¼ŒæŸ¥æ‰¾å¹¶è¿”å›æŸäº›é”®çš„å€¼ 1SORT &lt;key&gt; GET &lt;pattern&gt; 12345678redis&gt; SADD students &quot;tom&quot; &quot;jack&quot; &quot;sea&quot;#è®¾ç½®å…¨åredis&gt; SET tom-name &quot;Tom Li&quot; OK redis&gt; SET jack-name &quot;Jack Wang&quot; OK redis&gt; SET sea-name &quot;Sea Zhang&quot;OK 1234redis&gt; SORT students ALPHA GET *-name1) &quot;Jack Wang&quot;2) &quot;Sea Zhang&quot;3) &quot;Tom Li&quot; å®ç°åŸç†ï¼šå¯¹ students è¿›è¡Œæ’åºåï¼Œå¯¹äº jack å…ƒç´ å’Œ *-name æ¨¡å¼ï¼ŒæŸ¥æ‰¾ç¨‹åºè¿”å›é”® jack-nameï¼Œç„¶åè·å– jack-name é”®å¯¹åº”çš„å€¼ STORESORT å‘½ä»¤é»˜è®¤åªå‘å®¢æˆ·ç«¯è¿”å›æ’åºç»“æœï¼Œè€Œä¸ä¿å­˜æ’åºç»“æœï¼Œé€šè¿‡ä½¿ç”¨ STORE é€‰é¡¹å¯ä»¥å°†æ’åºç»“æœä¿å­˜åœ¨æŒ‡å®šçš„é”®é‡Œé¢ 1SORT &lt;key&gt; STORE &lt;sort_key&gt; 1234redis&gt; SADD students &quot;tom&quot; &quot;jack&quot; &quot;sea&quot;(integer) 3 redis&gt; SORT students ALPHA STORE sorted_students (integer) 3 å®ç°åŸç†ï¼šæ’åºåï¼Œæ£€æŸ¥ sorted_students é”®æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±åˆ é™¤è¯¥é”®ï¼Œè®¾ç½® sorted_students ä¸ºç©ºç™½çš„åˆ—è¡¨é”®ï¼Œéå†æ’åºæ•°ç»„å°†å…ƒç´ ä¾æ¬¡æ”¾å…¥ æ‰§è¡Œé¡ºåºè°ƒç”¨ SORT å‘½ä»¤ï¼Œé™¤äº† GET é€‰é¡¹ä¹‹å¤–ï¼Œæ”¹å˜å…¶ä»–é€‰é¡¹çš„æ‘†æ”¾é¡ºåºå¹¶ä¸ä¼šå½±å“å‘½ä»¤æ‰§è¡Œé€‰é¡¹çš„é¡ºåº 1SORT &lt;key&gt; ALPHA [ASC/DESC] BY &lt;by-pattern&gt; LIMIT &lt;offset&gt; &lt;count&gt; GET &lt;get-pattern&gt; STORE &lt;store_key&gt; æ‰§è¡Œé¡ºåºï¼š æ’åºï¼šå‘½ä»¤ä¼šä½¿ç”¨ ALPHA ã€ASC æˆ– DESCã€BY è¿™å‡ ä¸ªé€‰é¡¹ï¼Œå¯¹è¾“å…¥é”®è¿›è¡Œæ’åºï¼Œå¹¶å¾—åˆ°ä¸€ä¸ªæ’åºç»“æœé›† é™åˆ¶æ’åºç»“æœé›†çš„é•¿åº¦ï¼šä½¿ç”¨ LIMIT é€‰é¡¹ï¼Œå¯¹æ’åºç»“æœé›†çš„é•¿åº¦è¿›è¡Œé™åˆ¶ è·å–å¤–éƒ¨é”®ï¼šæ ¹æ®æ’åºç»“æœé›†ä¸­çš„å…ƒç´ ä»¥åŠ GET é€‰é¡¹æŒ‡å®šçš„æ¨¡å¼ï¼ŒæŸ¥æ‰¾å¹¶è·å–æŒ‡å®šé”®çš„å€¼ï¼Œå¹¶ç”¨è¿™äº›å€¼æ¥ä½œä¸ºæ–°çš„æ’åºç»“æœé›† ä¿å­˜æ’åºç»“æœé›†ï¼šä½¿ç”¨ STORE é€‰é¡¹ï¼Œå°†æ’åºç»“æœé›†ä¿å­˜åˆ°æŒ‡å®šçš„é”®ä¸Šé¢å» å‘å®¢æˆ·ç«¯è¿”å›æ’åºç»“æœé›†ï¼šæœ€åä¸€æ­¥å‘½ä»¤éå†æ’åºç»“æœé›†ï¼Œå¹¶ä¾æ¬¡å‘å®¢æˆ·ç«¯è¿”å›æ’åºç»“æœé›†ä¸­çš„å…ƒç´  é€šçŸ¥æœºåˆ¶æ•°æ®åº“é€šçŸ¥æ˜¯å¯ä»¥è®©å®¢æˆ·ç«¯é€šè¿‡è®¢é˜…ç»™å®šçš„é¢‘é“æˆ–è€…æ¨¡å¼ï¼Œæ¥è·çŸ¥æ•°æ®åº“ä¸­é”®çš„å˜åŒ–ï¼Œä»¥åŠæ•°æ®åº“ä¸­å‘½ä»¤çš„æ‰§è¡Œæƒ…å†µ å…³æ³¨æŸä¸ªé”®æ‰§è¡Œäº†ä»€ä¹ˆå‘½ä»¤çš„é€šçŸ¥ç§°ä¸ºé”®ç©ºé—´é€šçŸ¥ï¼ˆkey-space notificationï¼‰ å…³æ³¨æŸä¸ªå‘½ä»¤è¢«ä»€ä¹ˆé”®æ‰§è¡Œçš„é€šçŸ¥ç§°ä¸ºé”®äº‹ä»¶é€šçŸ¥ï¼ˆkey-event notificationï¼‰ å›¾ç¤ºè®¢é˜… 0 å·æ•°æ®åº“ message é”®ï¼š æœåŠ¡å™¨é…ç½®çš„ notify-keyspace-events é€‰é¡¹å†³å®šäº†æœåŠ¡å™¨æ‰€å‘é€é€šçŸ¥çš„ç±»å‹ AKE ä»£è¡¨æœåŠ¡å™¨å‘é€æ‰€æœ‰ç±»å‹çš„é”®ç©ºé—´é€šçŸ¥å’Œé”®äº‹ä»¶é€šçŸ¥ AK ä»£è¡¨æœåŠ¡å™¨å‘é€æ‰€æœ‰ç±»å‹çš„é”®ç©ºé—´é€šçŸ¥ AE ä»£è¡¨æœåŠ¡å™¨å‘é€æ‰€æœ‰ç±»å‹çš„é”®äº‹ä»¶é€šçŸ¥ K$ ä»£è¡¨æœåŠ¡å™¨åªå‘é€å’Œå­—ç¬¦ä¸²é”®æœ‰å…³çš„é”®ç©ºé—´é€šçŸ¥ EL ä»£è¡¨æœåŠ¡å™¨åªå‘é€å’Œåˆ—è¡¨é”®æœ‰å…³çš„é”®äº‹ä»¶é€šçŸ¥ â€¦.. å‘é€æ•°æ®åº“é€šçŸ¥çš„åŠŸèƒ½æ˜¯ç”± notifyKeyspaceEvent å‡½æ•°å®ç°çš„ï¼š å¦‚æœç»™å®šçš„é€šçŸ¥ç±»å‹ type ä¸æ˜¯æœåŠ¡å™¨å…è®¸å‘é€çš„é€šçŸ¥ç±»å‹ï¼Œé‚£ä¹ˆå‡½æ•°ä¼šç›´æ¥è¿”å› å¦‚æœç»™å®šçš„é€šçŸ¥æ˜¯æœåŠ¡å™¨å…è®¸å‘é€çš„é€šçŸ¥ æ£€æµ‹æœåŠ¡å™¨æ˜¯å¦å…è®¸å‘é€é”®ç©ºé—´é€šçŸ¥ï¼Œå…è®¸å°±ä¼šæ„å»ºå¹¶å‘é€äº‹ä»¶é€šçŸ¥ æ£€æµ‹æœåŠ¡å™¨æ˜¯å¦å…è®¸å‘é€é”®äº‹ä»¶é€šçŸ¥ï¼Œå…è®¸å°±ä¼šæ„å»ºå¹¶å‘é€äº‹ä»¶é€šçŸ¥ ä½“ç³»æ¶æ„äº‹ä»¶é©±åŠ¨åŸºæœ¬ä»‹ç»Redis æœåŠ¡å™¨æ˜¯ä¸€ä¸ªäº‹ä»¶é©±åŠ¨ç¨‹åºï¼ŒæœåŠ¡å™¨éœ€è¦å¤„ç†ä¸¤ç±»äº‹ä»¶ æ–‡ä»¶äº‹ä»¶ (file event)ï¼šæœåŠ¡å™¨é€šè¿‡å¥—æ¥å­—ä¸å®¢æˆ·ç«¯ï¼ˆæˆ–å…¶ä»– Redis æœåŠ¡å™¨ï¼‰è¿›è¡Œè¿æ¥ï¼Œè€Œæ–‡ä»¶äº‹ä»¶å°±æ˜¯æœåŠ¡å™¨å¯¹å¥—æ¥å­—æ“ä½œçš„æŠ½è±¡ã€‚æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯çš„é€šä¿¡ä¼šäº§ç”Ÿç›¸åº”çš„æ–‡ä»¶äº‹ä»¶ï¼ŒæœåŠ¡å™¨é€šè¿‡ç›‘å¬å¹¶å¤„ç†è¿™äº›äº‹ä»¶å®Œæˆä¸€ç³»åˆ—ç½‘ç»œé€šä¿¡æ“ä½œ æ—¶é—´äº‹ä»¶ (time event)ï¼šRedis æœåŠ¡å™¨ä¸­çš„ä¸€äº›æ“ä½œï¼ˆæ¯”å¦‚ serverCron å‡½æ•°ï¼‰éœ€è¦åœ¨æŒ‡å®šæ—¶é—´æ‰§è¡Œï¼Œè€Œæ—¶é—´äº‹ä»¶å°±æ˜¯æœåŠ¡å™¨å¯¹è¿™ç±»å®šæ—¶æ“ä½œçš„æŠ½è±¡ æ–‡ä»¶äº‹ä»¶åŸºæœ¬ç»„æˆRedis åŸºäº Reactor æ¨¡å¼å¼€å‘äº†ç½‘ç»œäº‹ä»¶å¤„ç†å™¨ï¼Œè¿™ä¸ªå¤„ç†å™¨è¢«ç§°ä¸ºæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ (file event handler) ä½¿ç”¨ I&#x2F;O å¤šè·¯å¤ç”¨ (multiplexing) ç¨‹åºæ¥åŒæ—¶ç›‘å¬å¤šä¸ªå¥—æ¥å­—ï¼Œå¹¶æ ¹æ®å¥—æ¥å­—æ‰§è¡Œçš„ä»»åŠ¡æ¥ä¸ºå¥—æ¥å­—å…³è”ä¸åŒçš„äº‹ä»¶å¤„ç†å™¨ å½“è¢«ç›‘å¬çš„å¥—æ¥å­—å‡†å¤‡å¥½æ‰§è¡Œè¿æ¥åº”ç­” (accept)ã€ è¯»å– (read)ã€ å†™å…¥ (write)ã€ å…³é—­ (close) ç­‰æ“ä½œæ—¶ï¼Œä¸æ“ä½œç›¸å¯¹åº”çš„æ–‡ä»¶äº‹ä»¶å°±ä¼šäº§ç”Ÿï¼Œè¿™æ—¶æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ä¼šè°ƒç”¨å¥—æ¥å­—å…³è”å¥½çš„äº‹ä»¶å¤„ç†å™¨æ¥å¤„ç†äº‹ä»¶ æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ä»¥å•çº¿ç¨‹æ–¹å¼è¿è¡Œï¼Œä½†é€šè¿‡ä½¿ç”¨ I&#x2F;O å¤šè·¯å¤ç”¨ç¨‹åºæ¥ç›‘å¬å¤šä¸ªå¥—æ¥å­—ï¼Œ æ—¢å®ç°äº†é«˜æ€§èƒ½çš„ç½‘ç»œé€šä¿¡æ¨¡å‹ï¼Œåˆå¯ä»¥å¾ˆå¥½åœ°ä¸ Redis æœåŠ¡å™¨ä¸­å…¶ä»–åŒæ ·ä»¥å•çº¿ç¨‹æ–¹å¼è¿è¡Œçš„æ¨¡å—è¿›è¡Œå¯¹æ¥ï¼Œä¿æŒäº† Redis å†…éƒ¨å•çº¿ç¨‹è®¾è®¡çš„ç®€å•æ€§ æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨çš„ç»„æˆç»“æ„ï¼š I&#x2F;O å¤šè·¯å¤ç”¨ç¨‹åºå°†æ‰€æœ‰äº§ç”Ÿäº‹ä»¶çš„å¥—æ¥å­—å¤„ç†è¯·æ±‚æ”¾å…¥ä¸€ä¸ªå•çº¿ç¨‹çš„æ‰§è¡Œé˜Ÿåˆ—ä¸­ï¼Œé€šè¿‡é˜Ÿåˆ—æœ‰åºã€åŒæ­¥çš„å‘æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ä¼ é€å¥—æ¥å­—ï¼Œä¸Šä¸€ä¸ªå¥—æ¥å­—äº§ç”Ÿçš„äº‹ä»¶å¤„ç†å®Œåï¼Œæ‰ä¼šç»§ç»­å‘åˆ†æ´¾å™¨ä¼ é€ä¸‹ä¸€ä¸ª Redis å•çº¿ç¨‹ä¹Ÿèƒ½é«˜æ•ˆçš„åŸå› ï¼š çº¯å†…å­˜æ“ä½œ æ ¸å¿ƒæ˜¯åŸºäºéé˜»å¡çš„ IO å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œå•çº¿ç¨‹å¯ä»¥é«˜æ•ˆå¤„ç†å¤šä¸ªè¯·æ±‚ åº•å±‚ä½¿ç”¨ C è¯­è¨€å®ç°ï¼ŒC è¯­è¨€å®ç°çš„ç¨‹åºè·ç¦»æ“ä½œç³»ç»Ÿæ›´è¿‘ï¼Œæ‰§è¡Œé€Ÿåº¦ç›¸å¯¹ä¼šæ›´å¿« å•çº¿ç¨‹åŒæ—¶ä¹Ÿé¿å…äº†å¤šçº¿ç¨‹çš„ä¸Šä¸‹æ–‡é¢‘ç¹åˆ‡æ¢é—®é¢˜ï¼Œé¢„é˜²äº†å¤šçº¿ç¨‹å¯èƒ½äº§ç”Ÿçš„ç«äº‰é—®é¢˜ å¤šè·¯å¤ç”¨Redis çš„ I&#x2F;O å¤šè·¯å¤ç”¨ç¨‹åºçš„æ‰€æœ‰åŠŸèƒ½éƒ½æ˜¯é€šè¿‡åŒ…è£…å¸¸è§çš„ select ã€epollã€ evport å’Œ kqueue è¿™äº›å‡½æ•°åº“æ¥å®ç°çš„ï¼ŒRedis åœ¨ I&#x2F;O å¤šè·¯å¤ç”¨ç¨‹åºçš„å®ç°æºç ä¸­ç”¨ #include å®å®šä¹‰äº†ç›¸åº”çš„è§„åˆ™ï¼Œç¼–è¯‘æ—¶è‡ªåŠ¨é€‰æ‹©ç³»ç»Ÿä¸­æ€§èƒ½æœ€é«˜çš„å¤šè·¯å¤ç”¨å‡½æ•°æ¥ä½œä¸ºåº•å±‚å®ç° I&#x2F;O å¤šè·¯å¤ç”¨ç¨‹åºç›‘å¬å¤šä¸ªå¥—æ¥å­—çš„ AE_READABLE äº‹ä»¶å’Œ AE_WRITABLE äº‹ä»¶ï¼Œè¿™ä¸¤ç±»äº‹ä»¶å’Œå¥—æ¥å­—æ“ä½œä¹‹é—´çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š å½“å¥—æ¥å­—å˜å¾—å¯è¯»æ—¶ï¼ˆå®¢æˆ·ç«¯å¯¹å¥—æ¥å­—æ‰§è¡Œ write æ“ä½œæˆ–è€… close æ“ä½œï¼‰ï¼Œæˆ–è€…æœ‰æ–°çš„å¯åº”ç­”ï¼ˆacceptableï¼‰å¥—æ¥å­—å‡ºç°æ—¶ï¼ˆå®¢æˆ·ç«¯å¯¹æœåŠ¡å™¨çš„ç›‘å¬å¥—æ¥å­—æ‰§è¡Œ connect è¿æ¥æ“ä½œï¼‰ï¼Œå¥—æ¥å­—äº§ç”Ÿ AE_READABLE äº‹ä»¶ å½“å¥—æ¥å­—å˜å¾—å¯å†™æ—¶ï¼ˆå®¢æˆ·ç«¯å¯¹å¥—æ¥å­—æ‰§è¡Œ read æ“ä½œï¼Œå¯¹äºæœåŠ¡å™¨æ¥è¯´å°±æ˜¯å¯ä»¥å†™äº†ï¼‰ï¼Œå¥—æ¥å­—äº§ç”Ÿ AE_WRITABLE äº‹ä»¶ I&#x2F;O å¤šè·¯å¤ç”¨ç¨‹åºå…è®¸æœåŠ¡å™¨åŒæ—¶ç›‘å¬å¥—æ¥å­—çš„ AE_READABLE å’Œ AE_WRITABLE äº‹ä»¶ï¼Œ å¦‚æœä¸€ä¸ªå¥—æ¥å­—åŒæ—¶äº§ç”Ÿäº†è¿™ä¸¤ç§äº‹ä»¶ï¼Œé‚£ä¹ˆæ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ä¼šä¼˜å…ˆå¤„ç† AE_READABLE äº‹ä»¶ï¼Œ ç­‰ AE_READABLE äº‹ä»¶å¤„ç†å®Œä¹‹åæ‰å¤„ç† AE_WRITABLE äº‹ä»¶ å¤„ç†å™¨Redis ä¸ºæ–‡ä»¶äº‹ä»¶ç¼–å†™äº†å¤šä¸ªå¤„ç†å™¨ï¼Œè¿™äº›äº‹ä»¶å¤„ç†å™¨åˆ†åˆ«ç”¨äºå®ç°ä¸åŒçš„ç½‘ç»œé€šä¿¡éœ€æ±‚ï¼š è¿æ¥åº”ç­”å¤„ç†å™¨ï¼Œç”¨äºå¯¹è¿æ¥æœåŠ¡å™¨çš„å„ä¸ªå®¢æˆ·ç«¯è¿›è¡Œåº”ç­”ï¼ŒRedis æœåŠ¡å™¨åˆå§‹åŒ–æ—¶å°†è¯¥å¤„ç†å™¨ä¸ AE_READABLE äº‹ä»¶å…³è” å‘½ä»¤è¯·æ±‚å¤„ç†å™¨ï¼Œç”¨äºæ¥æ”¶å®¢æˆ·ç«¯ä¼ æ¥çš„å‘½ä»¤è¯·æ±‚ï¼Œæ‰§è¡Œå¥—æ¥å­—çš„è¯»å…¥æ“ä½œï¼Œä¸ AE_READABLE äº‹ä»¶å…³è” å‘½ä»¤å›å¤å¤„ç†å™¨ï¼Œç”¨äºå‘å®¢æˆ·ç«¯è¿”å›å‘½ä»¤çš„æ‰§è¡Œç»“æœï¼Œæ‰§è¡Œå¥—æ¥å­—çš„å†™å…¥æ“ä½œï¼Œä¸ AE_WRITABLE äº‹ä»¶å…³è” å¤åˆ¶å¤„ç†å™¨ï¼Œå½“ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨è¿›è¡Œå¤åˆ¶æ“ä½œæ—¶ï¼Œä¸»ä»æœåŠ¡å™¨éƒ½éœ€è¦å…³è”è¯¥å¤„ç†å™¨ Redis å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨è¿›è¡Œè¿æ¥å¹¶å‘é€å‘½ä»¤çš„æ•´ä¸ªè¿‡ç¨‹ï¼š Redis æœåŠ¡å™¨æ­£åœ¨è¿ä½œç›‘å¬å¥—æ¥å­—çš„ AE_READABLE äº‹ä»¶ï¼Œå…³è”è¿æ¥åº”ç­”å¤„ç†å™¨ å½“ Redis å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘èµ·è¿æ¥ï¼Œç›‘å¬å¥—æ¥å­—å°†äº§ç”Ÿ AE_READABLE äº‹ä»¶ï¼Œè§¦å‘è¿æ¥åº”ç­”å¤„ç†å™¨æ‰§è¡Œï¼Œå¯¹å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚è¿›è¡Œåº”ç­”ï¼Œåˆ›å»ºå®¢æˆ·ç«¯å¥—æ¥å­—ä»¥åŠå®¢æˆ·ç«¯çŠ¶æ€ï¼Œå¹¶å°†å®¢æˆ·ç«¯å¥—æ¥å­—çš„ AE_READABLE äº‹ä»¶ä¸å‘½ä»¤è¯·æ±‚å¤„ç†å™¨è¿›è¡Œå…³è” å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€å‘½ä»¤è¯·æ±‚ï¼Œå®¢æˆ·ç«¯å¥—æ¥å­—äº§ç”Ÿ AE_READABLE äº‹ä»¶ï¼Œå¼•å‘å‘½ä»¤è¯·æ±‚å¤„ç†å™¨æ‰§è¡Œï¼Œè¯»å–å®¢æˆ·ç«¯çš„å‘½ä»¤å†…å®¹ä¼ ç»™ç›¸å…³ç¨‹åºå»æ‰§è¡Œ æ‰§è¡Œå‘½ä»¤ä¼šäº§ç”Ÿç›¸åº”çš„å‘½ä»¤å›å¤ï¼Œä¸ºäº†å°†è¿™äº›å‘½ä»¤å›å¤ä¼ é€å›å®¢æˆ·ç«¯ï¼ŒæœåŠ¡å™¨ä¼šå°†å®¢æˆ·ç«¯å¥—æ¥å­—çš„ AE_WRITABLE äº‹ä»¶ä¸å‘½ä»¤å›å¤å¤„ç†å™¨è¿›è¡Œå…³è” å½“å®¢æˆ·ç«¯å°è¯•è¯»å–å‘½ä»¤å›å¤æ—¶ï¼Œå®¢æˆ·ç«¯å¥—æ¥å­—äº§ç”Ÿ AE_WRITABLE äº‹ä»¶ï¼Œè§¦å‘å‘½ä»¤å›å¤å¤„ç†å™¨æ‰§è¡Œï¼Œåœ¨å‘½ä»¤å›å¤å…¨éƒ¨å†™å…¥å¥—æ¥å­—åï¼ŒæœåŠ¡å™¨å°±ä¼šè§£é™¤å®¢æˆ·ç«¯å¥—æ¥å­—çš„ AE_WRITABLE äº‹ä»¶ä¸å‘½ä»¤å›å¤å¤„ç†å™¨ä¹‹é—´çš„å…³è” æ—¶é—´äº‹ä»¶Redis çš„æ—¶é—´äº‹ä»¶åˆ†ä¸ºä»¥ä¸‹ä¸¤ç±»ï¼š å®šæ—¶äº‹ä»¶ï¼šåœ¨æŒ‡å®šçš„æ—¶é—´ä¹‹åæ‰§è¡Œä¸€æ¬¡ï¼ˆRedis ä¸­æš‚æ—¶æœªä½¿ç”¨ï¼‰ å‘¨æœŸäº‹ä»¶ï¼šæ¯éš”æŒ‡å®šæ—¶é—´å°±æ‰§è¡Œä¸€æ¬¡ ä¸€ä¸ªæ—¶é—´äº‹ä»¶ä¸»è¦ç”±ä»¥ä¸‹ä¸‰ä¸ªå±æ€§ç»„æˆï¼š idï¼šæœåŠ¡å™¨ä¸ºæ—¶é—´äº‹ä»¶åˆ›å»ºçš„å…¨å±€å”¯ä¸€ IDï¼ˆæ ‡è¯†å·ï¼‰ï¼Œä»å°åˆ°å¤§é¡ºåºé€’å¢ï¼Œæ–°äº‹ä»¶çš„ ID æ¯”æ—§äº‹ä»¶çš„ ID å·è¦å¤§ whenï¼šæ¯«ç§’ç²¾åº¦çš„ UNIX æ—¶é—´æˆ³ï¼Œè®°å½•äº†æ—¶é—´äº‹ä»¶çš„åˆ°è¾¾ï¼ˆarriveï¼‰æ—¶é—´ timeProcï¼šæ—¶é—´äº‹ä»¶å¤„ç†å™¨ï¼Œå½“æ—¶é—´äº‹ä»¶åˆ°è¾¾æ—¶ï¼ŒæœåŠ¡å™¨å°±ä¼šè°ƒç”¨ç›¸åº”çš„å¤„ç†å™¨æ¥å¤„ç†äº‹ä»¶ æ—¶é—´äº‹ä»¶æ˜¯å®šæ—¶äº‹ä»¶è¿˜æ˜¯å‘¨æœŸæ€§äº‹ä»¶å–å†³äºæ—¶é—´äº‹ä»¶å¤„ç†å™¨çš„è¿”å›å€¼ï¼š å®šæ—¶äº‹ä»¶ï¼šäº‹ä»¶å¤„ç†å™¨è¿”å› AE_NOMOREï¼Œè¯¥äº‹ä»¶åœ¨åˆ°è¾¾ä¸€æ¬¡åå°±ä¼šè¢«åˆ é™¤ å‘¨æœŸäº‹ä»¶ï¼šäº‹ä»¶å¤„ç†å™¨è¿”å›é AE_NOMORE çš„æ•´æ•°å€¼ï¼ŒæœåŠ¡å™¨æ ¹æ®è¯¥å€¼å¯¹äº‹ä»¶çš„ when å±æ€§æ›´æ–°ï¼Œè®©è¯¥äº‹ä»¶åœ¨ä¸€æ®µæ—¶é—´åå†æ¬¡äº¤ä»˜ æœåŠ¡å™¨å°†æ‰€æœ‰æ—¶é—´äº‹ä»¶éƒ½æ”¾åœ¨ä¸€ä¸ªæ— åºé“¾è¡¨ä¸­ï¼Œæ–°çš„æ—¶é—´äº‹ä»¶æ’å…¥åˆ°é“¾è¡¨çš„è¡¨å¤´ï¼š æ— åºé“¾è¡¨æŒ‡æ˜¯é“¾è¡¨ä¸æŒ‰ when å±æ€§çš„å¤§å°æ’åºï¼Œæ¯å½“æ—¶é—´äº‹ä»¶æ‰§è¡Œå™¨è¿è¡Œæ—¶å°±å¿…é¡»éå†æ•´ä¸ªé“¾è¡¨ï¼ŒæŸ¥æ‰¾æ‰€æœ‰å·²åˆ°è¾¾çš„æ—¶é—´äº‹ä»¶ï¼Œå¹¶è°ƒç”¨ç›¸åº”çš„äº‹ä»¶å¤„ç†å™¨å¤„ç† æ— åºé“¾è¡¨å¹¶ä¸å½±å“æ—¶é—´äº‹ä»¶å¤„ç†å™¨çš„æ€§èƒ½ï¼Œå› ä¸ºæ­£å¸¸æ¨¡å¼ä¸‹çš„ Redis æœåŠ¡å™¨åªä½¿ç”¨ serverCron ä¸€ä¸ªæ—¶é—´äº‹ä»¶ï¼Œåœ¨ benchmark æ¨¡å¼ä¸‹æœåŠ¡å™¨ä¹Ÿåªä½¿ç”¨ä¸¤ä¸ªæ—¶é—´äº‹ä»¶ï¼Œæ‰€ä»¥æ— åºé“¾è¡¨ä¸ä¼šå½±å“æœåŠ¡å™¨çš„æ€§èƒ½ï¼Œå‡ ä¹å¯ä»¥æŒ‰ç…§ä¸€ä¸ªæŒ‡é’ˆå¤„ç† äº‹ä»¶è°ƒåº¦æœåŠ¡å™¨ä¸­åŒæ—¶å­˜åœ¨æ–‡ä»¶äº‹ä»¶å’Œæ—¶é—´äº‹ä»¶ä¸¤ç§äº‹ä»¶ç±»å‹ï¼Œè°ƒåº¦ä¼ªä»£ç ï¼š 1234567891011121314151617181920# äº‹ä»¶è°ƒåº¦ä¼ªä»£ç def aeProcessEvents(): # è·å–åˆ°è¾¾æ—¶é—´ç¦»å½“å‰æ—¶é—´æœ€æ¥è¿‘çš„æ—¶é—´äº‹ä»¶ time_event = aeSearchNearestTime() # è®¡ç®—æœ€æ¥è¿‘çš„æ—¶é—´äº‹ä»¶è·ç¦»åˆ°è¾¾è¿˜æœ‰å¤šå°‘äº³ç§’ remaind_ms = time_event.when - unix_ts_now() # å¦‚æœäº‹ä»¶å·²åˆ°è¾¾ï¼Œé‚£ä¹ˆ remaind_ms çš„å€¼å¯èƒ½ä¸ºè´Ÿæ•°ï¼Œè®¾ç½®ä¸º 0 if remaind_ms &lt; 0: remaind_ms = 0 # æ ¹æ® remaind_ms çš„å€¼ï¼Œåˆ›å»º timeval ç»“æ„ timeval = create_timeval_with_ms(remaind_ms) # ã€é˜»å¡å¹¶ç­‰å¾…æ–‡ä»¶äº‹ä»¶ã€‘äº§ç”Ÿï¼Œæœ€å¤§é˜»å¡æ—¶é—´ç”±ä¼ å…¥çš„timevalç»“æ„å†³å®šï¼Œremaind_msçš„å€¼ä¸º0æ—¶è°ƒç”¨åé©¬ä¸Šè¿”å›ï¼Œä¸é˜»å¡ aeApiPoll(timeval) # å¤„ç†æ‰€æœ‰å·²äº§ç”Ÿçš„æ–‡ä»¶äº‹ä»¶ processFileEvents() # å¤„ç†æ‰€æœ‰å·²åˆ°è¾¾çš„æ—¶é—´äº‹ä»¶ processTimeEvents() äº‹ä»¶çš„è°ƒåº¦å’Œæ‰§è¡Œè§„åˆ™ï¼š aeApiPoll å‡½æ•°çš„æœ€å¤§é˜»å¡æ—¶é—´ç”±åˆ°è¾¾æ—¶é—´æœ€æ¥è¿‘å½“å‰æ—¶é—´çš„æ—¶é—´äº‹ä»¶å†³å®šï¼Œå¯ä»¥é¿å…æœåŠ¡å™¨å¯¹æ—¶é—´äº‹ä»¶è¿›è¡Œé¢‘ç¹çš„è½®è¯¢ï¼ˆå¿™ç­‰å¾…ï¼‰ï¼Œä¹Ÿå¯ä»¥ç¡®ä¿ aeApiPoll å‡½æ•°ä¸ä¼šé˜»å¡è¿‡é•¿æ—¶é—´ å¯¹æ–‡ä»¶äº‹ä»¶å’Œæ—¶é—´äº‹ä»¶çš„å¤„ç†éƒ½æ˜¯åŒæ­¥ã€æœ‰åºã€åŸå­åœ°æ‰§è¡Œï¼ŒæœåŠ¡å™¨ä¸ä¼šä¸­é€”ä¸­æ–­äº‹ä»¶å¤„ç†ï¼Œä¹Ÿä¸ä¼šå¯¹äº‹ä»¶è¿›è¡ŒæŠ¢å ï¼Œæ‰€ä»¥ä¸¤ç§å¤„ç†å™¨éƒ½è¦å°½å¯åœ°å‡å°‘ç¨‹åºçš„é˜»å¡æ—¶é—´ï¼Œå¹¶åœ¨æœ‰éœ€è¦æ—¶ä¸»åŠ¨è®©å‡ºæ‰§è¡Œæƒï¼Œä»è€Œé™ä½äº‹ä»¶é¥¥é¥¿çš„å¯èƒ½æ€§ å‘½ä»¤å›å¤å¤„ç†å™¨åœ¨å†™å…¥å­—èŠ‚æ•°è¶…è¿‡äº†æŸä¸ªé¢„è®¾å¸¸é‡ï¼Œå°±ä¼šä¸»åŠ¨ç”¨ break è·³å‡ºå†™å…¥å¾ªç¯ï¼Œå°†ä½™ä¸‹çš„æ•°æ®ç•™åˆ°ä¸‹æ¬¡å†å†™ æ—¶é—´äº‹ä»¶ä¹Ÿä¼šå°†éå¸¸è€—æ—¶çš„æŒä¹…åŒ–æ“ä½œæ”¾åˆ°å­çº¿ç¨‹æˆ–è€…å­è¿›ç¨‹æ‰§è¡Œ æ—¶é—´äº‹ä»¶åœ¨æ–‡ä»¶äº‹ä»¶ä¹‹åæ‰§è¡Œï¼Œå¹¶ä¸”äº‹ä»¶ä¹‹é—´ä¸ä¼šå‡ºç°æŠ¢å ï¼Œæ‰€ä»¥æ—¶é—´äº‹ä»¶çš„å®é™…å¤„ç†æ—¶é—´é€šå¸¸ä¼šæ¯”è®¾å®šçš„åˆ°è¾¾æ—¶é—´ç¨æ™š å¤šçº¿ç¨‹Redis6.0 å¼•å…¥å¤šçº¿ç¨‹ä¸»è¦æ˜¯ä¸ºäº†æé«˜ç½‘ç»œ IO è¯»å†™æ€§èƒ½ï¼Œå› ä¸ºè¿™æ˜¯ Redis çš„ä¸€ä¸ªæ€§èƒ½ç“¶é¢ˆï¼ˆRedis çš„ç“¶é¢ˆä¸»è¦å—é™äºå†…å­˜å’Œç½‘ç»œï¼‰ï¼Œå¤šçº¿ç¨‹åªæ˜¯ç”¨æ¥å¤„ç†ç½‘ç»œæ•°æ®çš„è¯»å†™å’Œåè®®è§£æï¼Œ æ‰§è¡Œå‘½ä»¤ä»ç„¶æ˜¯å•çº¿ç¨‹é¡ºåºæ‰§è¡Œï¼Œå› æ­¤ä¸éœ€è¦æ‹…å¿ƒçº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ Redis6.0 çš„å¤šçº¿ç¨‹é»˜è®¤æ˜¯ç¦ç”¨çš„ï¼Œåªä½¿ç”¨ä¸»çº¿ç¨‹ã€‚å¦‚éœ€å¼€å¯éœ€è¦ä¿®æ”¹ redis é…ç½®æ–‡ä»¶ redis.conf ï¼š 1io-threads-do-reads yesCopy to clipboardErrorCopied å¼€å¯å¤šçº¿ç¨‹åï¼Œè¿˜éœ€è¦è®¾ç½®çº¿ç¨‹æ•°ï¼Œå¦åˆ™æ˜¯ä¸ç”Ÿæ•ˆçš„ï¼ŒåŒæ ·éœ€è¦ä¿®æ”¹ redis é…ç½®æ–‡ä»¶ : 1io-threads 4 #å®˜ç½‘å»ºè®®4æ ¸çš„æœºå™¨å»ºè®®è®¾ç½®ä¸º2æˆ–3ä¸ªçº¿ç¨‹ï¼Œ8æ ¸çš„å»ºè®®è®¾ç½®ä¸º6ä¸ªçº¿ç¨‹ å‚è€ƒæ–‡ç« ï¼šhttps://mp.weixin.qq.com/s/dqmiR0ECf4lB6Y2OyK-dyA å®¢æˆ·ç«¯åŸºæœ¬ä»‹ç»Redis æœåŠ¡å™¨æ˜¯å…¸å‹çš„ä¸€å¯¹å¤šç¨‹åºï¼Œä¸€ä¸ªæœåŠ¡å™¨å¯ä»¥ä¸å¤šä¸ªå®¢æˆ·ç«¯å»ºç«‹ç½‘ç»œè¿æ¥ï¼ŒæœåŠ¡å™¨å¯¹æ¯ä¸ªè¿æ¥çš„å®¢æˆ·ç«¯å»ºç«‹äº†ç›¸åº”çš„ redisClient ç»“æ„ï¼ˆå®¢æˆ·ç«¯çŠ¶æ€ï¼Œåœ¨æœåŠ¡å™¨ç«¯çš„å­˜å‚¨ç»“æ„ï¼‰ï¼Œä¿å­˜äº†å®¢æˆ·ç«¯å½“å‰çš„çŠ¶æ€ä¿¡æ¯ï¼Œä»¥åŠæ‰§è¡Œç›¸å…³åŠŸèƒ½æ—¶éœ€è¦ç”¨åˆ°çš„æ•°æ®ç»“æ„ Redis æœåŠ¡å™¨çŠ¶æ€ç»“æ„çš„ clients å±æ€§æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œè¿™ä¸ªé“¾è¡¨ä¿å­˜äº†æ‰€æœ‰ä¸æœåŠ¡å™¨è¿æ¥çš„å®¢æˆ·ç«¯çš„çŠ¶æ€ç»“æ„ï¼š 123456struct redisServer &#123; // ä¸€ä¸ªé“¾è¡¨ï¼Œä¿å­˜äº†æ‰€æœ‰å®¢æˆ·ç«¯çŠ¶æ€ list *clients; //...&#125;; æ•°æ®ç»“æ„redisClientå®¢æˆ·ç«¯çš„æ•°æ®ç»“æ„ï¼š 123456789101112131415161718192021222324252627282930313233343536typedef struct redisClient &#123; //... // å¥—æ¥å­— int fd; // åå­— robj *name; // æ ‡å¿— int flags; // è¾“å…¥ç¼“å†²åŒº sds querybuf; // è¾“å‡ºç¼“å†²åŒº buf æ•°ç»„ char buf[REDIS_REPLY_CHUNK_BYTES]; // è®°å½•äº† buf æ•°ç»„ç›®å‰å·²ä½¿ç”¨çš„å­—èŠ‚æ•°é‡ int bufpos; // å¯å˜å¤§å°çš„è¾“å‡ºç¼“å†²åŒºï¼Œé“¾è¡¨ + å­—ç¬¦ä¸²å¯¹è±¡ list *reply; // å‘½ä»¤æ•°ç»„ rboj **argv; // å‘½ä»¤æ•°ç»„çš„é•¿åº¦ int argc; // å‘½ä»¤çš„ä¿¡æ¯ struct redisCommand *cmd; // æ˜¯å¦é€šè¿‡èº«ä»½éªŒè¯ int authenticated; // åˆ›å»ºå®¢æˆ·ç«¯çš„æ—¶é—´ time_t ctime; // å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨æœ€åä¸€æ¬¡è¿›è¡Œäº¤äº’çš„æ—¶é—´ time_t lastinteraction; // è¾“å‡ºç¼“å†²åŒºç¬¬ä¸€æ¬¡åˆ°è¾¾è½¯æ€§é™åˆ¶ (soft limit) çš„æ—¶é—´ time_t obuf_soft_limit_reached_time;&#125; å®¢æˆ·ç«¯çŠ¶æ€åŒ…æ‹¬ä¸¤ç±»å±æ€§ ä¸€ç±»æ˜¯æ¯”è¾ƒé€šç”¨çš„å±æ€§ï¼Œè¿™äº›å±æ€§å¾ˆå°‘ä¸ç‰¹å®šåŠŸèƒ½ç›¸å…³ï¼Œæ— è®ºå®¢æˆ·ç«¯æ‰§è¡Œçš„æ˜¯ä»€ä¹ˆå·¥ä½œï¼Œéƒ½è¦ç”¨åˆ°è¿™äº›å±æ€§ å¦ä¸€ç±»æ˜¯å’Œç‰¹å®šåŠŸèƒ½ç›¸å…³çš„å±æ€§ï¼Œæ¯”å¦‚æ“ä½œæ•°æ®åº“æ—¶ç”¨åˆ°çš„ db å±æ€§å’Œ dict id å±æ€§ï¼Œæ‰§è¡Œäº‹åŠ¡æ—¶ç”¨åˆ°çš„ mstate å±æ€§ï¼Œä»¥åŠæ‰§è¡Œ WATCH å‘½ä»¤æ—¶ç”¨åˆ°çš„ watched_keys å±æ€§ç­‰ï¼Œä»£ç ä¸­æ²¡æœ‰åˆ—å‡º å¥—æ¥å­—å®¢æˆ·ç«¯çŠ¶æ€çš„ fd å±æ€§è®°å½•äº†å®¢æˆ·ç«¯æ­£åœ¨ä½¿ç”¨çš„å¥—æ¥å­—æè¿°ç¬¦ï¼Œæ ¹æ®å®¢æˆ·ç«¯ç±»å‹çš„ä¸åŒï¼Œfd å±æ€§çš„å€¼å¯ä»¥æ˜¯ -1 æˆ–è€…å¤§äº -1 çš„æ•´æ•°ï¼š ä¼ªå®¢æˆ·ç«¯ (fake client) çš„ fd å±æ€§çš„å€¼ä¸º -1ï¼Œå‘½ä»¤è¯·æ±‚æ¥æºäº AOF æ–‡ä»¶æˆ–è€… Lua è„šæœ¬ï¼Œè€Œä¸æ˜¯ç½‘ç»œï¼Œæ‰€ä»¥ä¸éœ€è¦å¥—æ¥å­—è¿æ¥ æ™®é€šå®¢æˆ·ç«¯çš„ fd å±æ€§çš„å€¼ä¸ºå¤§äº -1 çš„æ•´æ•°ï¼Œå› ä¸ºåˆæ³•çš„å¥—æ¥å­—æè¿°ç¬¦ä¸èƒ½æ˜¯ -1 æ‰§è¡Œ CLIENT list å‘½ä»¤å¯ä»¥åˆ—å‡ºç›®å‰æ‰€æœ‰è¿æ¥åˆ°æœåŠ¡å™¨çš„æ™®é€šå®¢æˆ·ç«¯ï¼Œä¸åŒ…æ‹¬ä¼ªå®¢æˆ·ç«¯ åå­—åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ªè¿æ¥åˆ°æœåŠ¡å™¨çš„å®¢æˆ·ç«¯æ˜¯æ²¡æœ‰åå­—çš„ï¼Œä½¿ç”¨ CLIENT setname å‘½ä»¤å¯ä»¥ä¸ºå®¢æˆ·ç«¯è®¾ç½®ä¸€ä¸ªåå­— æ ‡å¿—å®¢æˆ·ç«¯çš„æ ‡å¿—å±æ€§ flags è®°å½•äº†å®¢æˆ·ç«¯çš„è§’è‰²ä»¥åŠå®¢æˆ·ç«¯ç›®å‰æ‰€å¤„çš„çŠ¶æ€ï¼Œæ¯ä¸ªæ ‡å¿—ä½¿ç”¨ä¸€ä¸ªå¸¸é‡è¡¨ç¤º flags çš„å€¼å¯ä»¥æ˜¯å•ä¸ªæ ‡å¿—ï¼šflags = &lt;flag&gt; flags çš„å€¼å¯ä»¥æ˜¯å¤šä¸ªæ ‡å¿—çš„äºŒè¿›åˆ¶ï¼šflags = &lt;flagl&gt; | &lt;flag2&gt; | ... ä¸€éƒ¨åˆ†æ ‡å¿—è®°å½•å®¢æˆ·ç«¯çš„è§’è‰²ï¼š REDIS_MASTER è¡¨ç¤ºå®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªä»æœåŠ¡å™¨ï¼ŒREDIS_SLAVE è¡¨ç¤ºå®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªä»æœåŠ¡å™¨ï¼Œåœ¨ä¸»ä»å¤åˆ¶æ—¶ä½¿ç”¨ REDIS_PRE_PSYNC è¡¨ç¤ºå®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªç‰ˆæœ¬ä½äº Redis2.8 çš„ä»æœåŠ¡å™¨ï¼Œä¸»æœåŠ¡å™¨ä¸èƒ½ä½¿ç”¨ PSYNC å‘½ä»¤ä¸è¯¥ä»æœåŠ¡å™¨è¿›è¡ŒåŒæ­¥ï¼Œè¿™ä¸ªæ ‡å¿—åªèƒ½åœ¨ REDIS_ SLAVE æ ‡å¿—å¤„äºæ‰“å¼€çŠ¶æ€æ—¶ä½¿ç”¨ REDIS_LUA_CLIENT è¡¨ç¤ºå®¢æˆ·ç«¯æ˜¯ä¸“é—¨ç”¨äºå¤„ç† Lua è„šæœ¬é‡Œé¢åŒ…å«çš„ Redis å‘½ä»¤çš„ä¼ªå®¢æˆ·ç«¯ ä¸€éƒ¨åˆ†æ ‡å¿—è®°å½•ç›®å‰å®¢æˆ·ç«¯æ‰€å¤„çš„çŠ¶æ€ï¼š REDIS_UNIX_SOCKET è¡¨ç¤ºæœåŠ¡å™¨ä½¿ç”¨ UNIX å¥—æ¥å­—æ¥è¿æ¥å®¢æˆ·ç«¯ REDIS_BLOCKED è¡¨ç¤ºå®¢æˆ·ç«¯æ­£åœ¨è¢« BRPOPã€BLPOP ç­‰å‘½ä»¤é˜»å¡ REDIS_UNBLOCKED è¡¨ç¤ºå®¢æˆ·ç«¯å·²ç»ä» REDIS_BLOCKED æ‰€è¡¨ç¤ºçš„é˜»å¡çŠ¶æ€è„±ç¦»ï¼Œåœ¨ REDIS_BLOCKED æ ‡å¿—æ‰“å¼€çš„æƒ…å†µä¸‹ä½¿ç”¨ REDIS_MULTI æ ‡å¿—è¡¨ç¤ºå®¢æˆ·ç«¯æ­£åœ¨æ‰§è¡Œäº‹åŠ¡ REDIS_DIRTY_CAS è¡¨ç¤ºäº‹åŠ¡ä½¿ç”¨ WATCH å‘½ä»¤ç›‘è§†çš„æ•°æ®åº“é”®å·²ç»è¢«ä¿®æ”¹ â€¦.. ç¼“å†²åŒºå®¢æˆ·ç«¯çŠ¶æ€çš„è¾“å…¥ç¼“å†²åŒºç”¨äºä¿å­˜å®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤è¯·æ±‚ï¼Œè¾“å…¥ç¼“å†²åŒºçš„å¤§å°ä¼šæ ¹æ®è¾“å…¥å†…å®¹åŠ¨æ€åœ°ç¼©å°æˆ–è€…æ‰©å¤§ï¼Œä½†æœ€å¤§å¤§å°ä¸èƒ½è¶…è¿‡ 1GBï¼Œå¦åˆ™æœåŠ¡å™¨å°†å…³é—­è¿™ä¸ªå®¢æˆ·ç«¯ï¼Œæ¯”å¦‚æ‰§è¡Œ SET key value ï¼Œé‚£ä¹ˆç¼“å†²åŒº querybuf çš„å†…å®¹ï¼š 1*3\\r\\n$3\\r\\nSET\\r\\n$3\\r\\nkey\\r\\n$5\\r\\nvalue\\r\\n # è¾“å‡ºç¼“å†²åŒºæ˜¯æœåŠ¡å™¨ç”¨äºä¿å­˜æ‰§è¡Œå®¢æˆ·ç«¯å‘½ä»¤æ‰€å¾—çš„å‘½ä»¤å›å¤ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯éƒ½æœ‰ä¸¤ä¸ªè¾“å‡ºç¼“å†²åŒºå¯ç”¨ï¼š ä¸€ä¸ªæ˜¯å›ºå®šå¤§å°çš„ç¼“å†²åŒºï¼Œä¿å­˜é•¿åº¦æ¯”è¾ƒå°çš„å›å¤ï¼Œæ¯”å¦‚ OKã€ç®€çŸ­çš„å­—ç¬¦ä¸²å€¼ã€æ•´æ•°å€¼ã€é”™è¯¯å›å¤ç­‰ ä¸€ä¸ªæ˜¯å¯å˜å¤§å°çš„ç¼“å†²åŒºï¼Œä¿å­˜é‚£äº›é•¿åº¦æ¯”è¾ƒå¤§çš„å›å¤ï¼Œ æ¯”å¦‚ä¸€ä¸ªéå¸¸é•¿çš„å­—ç¬¦ä¸²å€¼æˆ–è€…ä¸€ä¸ªåŒ…å«äº†å¾ˆå¤šå…ƒç´ çš„é›†åˆç­‰ buf æ˜¯ä¸€ä¸ªå¤§å°ä¸º REDIS_REPLY_CHUNK_BYTES (å¸¸é‡é»˜è®¤ 16*1024 &#x3D; 16KB) å­—èŠ‚çš„å­—èŠ‚æ•°ç»„ï¼Œbufpos å±æ€§è®°å½•äº† buf æ•°ç»„ç›®å‰å·²ä½¿ç”¨çš„å­—èŠ‚æ•°é‡ï¼Œå½“ buf æ•°ç»„çš„ç©ºé—´å·²ç»ç”¨å®Œæˆ–è€…å›å¤æ•°æ®å¤ªå¤§æ— æ³•æ”¾è¿› buf æ•°ç»„é‡Œï¼ŒæœåŠ¡å™¨å°±ä¼šå¼€å§‹ä½¿ç”¨å¯å˜å¤§å°çš„ç¼“å†²åŒº é€šè¿‡ä½¿ç”¨ reply é“¾è¡¨è¿æ¥å¤šä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œå¯ä»¥ä¸ºå®¢æˆ·ç«¯ä¿å­˜ä¸€ä¸ªéå¸¸é•¿çš„å‘½ä»¤å›å¤ï¼Œè€Œä¸å¿…å—åˆ°å›ºå®šå¤§å°ç¼“å†²åŒº 16KB å¤§å°çš„é™åˆ¶ å‘½ä»¤æœåŠ¡å™¨å¯¹ querybuf ä¸­çš„å‘½ä»¤è¯·æ±‚çš„å†…å®¹è¿›è¡Œåˆ†æï¼Œå¾—å‡ºçš„å‘½ä»¤å‚æ•°ä»¥åŠå‚æ•°çš„æ•°é‡åˆ†åˆ«ä¿å­˜åˆ°å®¢æˆ·ç«¯çŠ¶æ€çš„ argv å’Œ argc å±æ€§ argv å±æ€§æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¯é¡¹éƒ½æ˜¯å­—ç¬¦ä¸²å¯¹è±¡ï¼Œå…¶ä¸­ argv[0] æ˜¯è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œè€Œä¹‹åçš„å…¶ä»–é¡¹åˆ™æ˜¯å‘½ä»¤çš„å‚æ•° argc å±æ€§è´Ÿè´£è®°å½• argv æ•°ç»„çš„é•¿åº¦ æœåŠ¡å™¨å°†æ ¹æ®é¡¹ argv[0] çš„å€¼ï¼Œåœ¨å‘½ä»¤è¡¨ä¸­æŸ¥æ‰¾å‘½ä»¤æ‰€å¯¹åº”çš„å‘½ä»¤çš„ redisCommandï¼Œå°†å®¢æˆ·ç«¯çŠ¶æ€çš„ cmd æŒ‡å‘è¯¥ç»“æ„ å‘½ä»¤è¡¨æ˜¯ä¸€ä¸ªå­—å…¸ç»“æ„ï¼Œé”®æ˜¯ SDS ç»“æ„ä¿å­˜å‘½ä»¤çš„åå­—ï¼›å€¼æ˜¯å‘½ä»¤æ‰€å¯¹åº”çš„ redisCommand ç»“æ„ï¼Œä¿å­˜äº†å‘½ä»¤çš„å®ç°å‡½æ•°ã€å‘½ä»¤æ ‡å¿—ã€ å‘½ä»¤åº”è¯¥ç»™å®šçš„å‚æ•°ä¸ªæ•°ã€å‘½ä»¤çš„æ€»æ‰§è¡Œæ¬¡æ•°å’Œæ€»æ¶ˆè€—æ—¶é•¿ç­‰ç»Ÿè®¡ä¿¡æ¯ éªŒè¯å®¢æˆ·ç«¯çŠ¶æ€çš„ authenticated å±æ€§ç”¨äºè®°å½•å®¢æˆ·ç«¯æ˜¯å¦é€šè¿‡äº†èº«ä»½éªŒè¯ authenticated å€¼ä¸º 0ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯æœªé€šè¿‡èº«ä»½éªŒè¯ authenticated å€¼ä¸º 1ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯å·²é€šè¿‡èº«ä»½éªŒè¯ å½“å®¢æˆ·ç«¯ authenticated &#x3D; 0 æ—¶ï¼Œé™¤äº† AUTH å‘½ä»¤ä¹‹å¤–ï¼Œ å®¢æˆ·ç«¯å‘é€çš„æ‰€æœ‰å…¶ä»–å‘½ä»¤éƒ½ä¼šè¢«æœåŠ¡å™¨æ‹’ç»æ‰§è¡Œ 123456redis&gt; PING (error) NOAUTH Authentication required.redis&gt; AUTH 123321 OKredis&gt; PING PONG æ—¶é—´ctime å±æ€§è®°å½•äº†åˆ›å»ºå®¢æˆ·ç«¯çš„æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´å¯ä»¥ç”¨æ¥è®¡ç®—å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨å·²ç»è¿æ¥äº†å¤šå°‘ç§’ï¼ŒCLIENT list å‘½ä»¤çš„ age åŸŸè®°å½•äº†è¿™ä¸ªç§’æ•° lastinteraction å±æ€§è®°å½•äº†å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨æœ€åä¸€æ¬¡è¿›è¡Œäº’åŠ¨ (interaction) çš„æ—¶é—´ï¼Œäº’åŠ¨å¯ä»¥æ˜¯å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€å‘½ä»¤è¯·æ±‚ï¼Œä¹Ÿå¯ä»¥æ˜¯æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€å‘½ä»¤å›å¤ã€‚è¯¥å±æ€§å¯ä»¥ç”¨æ¥è®¡ç®—å®¢æˆ·ç«¯çš„ç©ºè½¬ (idle) æ—¶é•¿ï¼Œ å°±æ˜¯è·ç¦»å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨æœ€åä¸€æ¬¡è¿›è¡Œäº’åŠ¨å·²ç»è¿‡å»äº†å¤šå°‘ç§’ï¼ŒCLIENT list å‘½ä»¤çš„ idle åŸŸè®°å½•äº†è¿™ä¸ªç§’æ•° obuf_soft_limit_reached_time å±æ€§è®°å½•äº†è¾“å‡ºç¼“å†²åŒºç¬¬ä¸€æ¬¡åˆ°è¾¾è½¯æ€§é™åˆ¶ (soft limit) çš„æ—¶é—´ ç”Ÿå‘½å‘¨æœŸåˆ›å»ºæœåŠ¡å™¨ä½¿ç”¨ä¸åŒçš„æ–¹å¼æ¥åˆ›å»ºå’Œå…³é—­ä¸åŒç±»å‹çš„å®¢æˆ·ç«¯ å¦‚æœå®¢æˆ·ç«¯æ˜¯é€šè¿‡ç½‘ç»œè¿æ¥ä¸æœåŠ¡å™¨è¿›è¡Œè¿æ¥çš„æ™®é€šå®¢æˆ·ç«¯ï¼Œé‚£ä¹ˆåœ¨å®¢æˆ·ç«¯ä½¿ç”¨ connect å‡½æ•°è¿æ¥åˆ°æœåŠ¡å™¨æ—¶ï¼ŒæœåŠ¡å™¨å°±ä¼šè°ƒç”¨è¿æ¥åº”ç­”å¤„ç†å™¨ä¸ºå®¢æˆ·ç«¯åˆ›å»ºç›¸åº”çš„å®¢æˆ·ç«¯çŠ¶æ€ï¼Œå¹¶å°†è¿™ä¸ªæ–°çš„å®¢æˆ·ç«¯çŠ¶æ€æ·»åŠ åˆ°æœåŠ¡å™¨çŠ¶æ€ç»“æ„ clients é“¾è¡¨çš„æœ«å°¾ æœåŠ¡å™¨ä¼šåœ¨åˆå§‹åŒ–æ—¶åˆ›å»ºè´Ÿè´£æ‰§è¡Œ Lua è„šæœ¬ä¸­åŒ…å«çš„ Redis å‘½ä»¤çš„ä¼ªå®¢æˆ·ç«¯ï¼Œå¹¶å°†ä¼ªå®¢æˆ·ç«¯å…³è”åœ¨æœåŠ¡å™¨çŠ¶æ€çš„ lua_client å±æ€§ 123456struct redisServer &#123; // ä¿å­˜ä¼ªå®¢æˆ·ç«¯ redisClient *lua_clientï¼› //...&#125;; lua_client ä¼ªå®¢æˆ·ç«¯åœ¨æœåŠ¡å™¨è¿è¡Œçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¼šä¸€ç›´å­˜åœ¨ï¼Œåªæœ‰æœåŠ¡å™¨è¢«å…³é—­æ—¶ï¼Œè¿™ä¸ªå®¢æˆ·ç«¯æ‰ä¼šè¢«å…³é—­ è½½å…¥ AOF æ–‡ä»¶æ—¶ï¼Œ æœåŠ¡å™¨ä¼šåˆ›å»ºç”¨äºæ‰§è¡Œ AOF æ–‡ä»¶åŒ…å«çš„ Redis å‘½ä»¤çš„ä¼ªå®¢æˆ·ç«¯ï¼Œå¹¶åœ¨è½½å…¥å®Œæˆä¹‹åï¼Œå…³é—­è¿™ä¸ªä¼ªå®¢æˆ·ç«¯ å…³é—­ä¸€ä¸ªæ™®é€šå®¢æˆ·ç«¯å¯ä»¥å› ä¸ºå¤šç§åŸå› è€Œè¢«å…³é—­ï¼š å®¢æˆ·ç«¯è¿›ç¨‹é€€å‡ºæˆ–è€…è¢«æ€æ­»ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„ç½‘ç»œè¿æ¥å°†è¢«å…³é—­ï¼Œä»è€Œé€ æˆå®¢æˆ·ç«¯è¢«å…³é—­ å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€äº†å¸¦æœ‰ä¸ç¬¦åˆåè®®æ ¼å¼çš„å‘½ä»¤è¯·æ±‚ï¼Œé‚£ä¹ˆè¿™ä¸ªå®¢æˆ·ç«¯ä¼šè¢«æœåŠ¡å™¨å…³é—­ å®¢æˆ·ç«¯æ˜¯ CLIENT KILL å‘½ä»¤çš„ç›®æ ‡ å¦‚æœç”¨æˆ·ä¸ºæœåŠ¡å™¨è®¾ç½®äº† timeout é…ç½®é€‰é¡¹ï¼Œé‚£ä¹ˆå½“å®¢æˆ·ç«¯çš„ç©ºè½¬æ—¶é—´è¶…è¿‡è¯¥å€¼æ—¶å°†è¢«å…³é—­ï¼Œç‰¹æ®Šæƒ…å†µä¸ä¼šè¢«å…³é—­ï¼š å®¢æˆ·ç«¯æ˜¯ä¸»æœåŠ¡å™¨ï¼ˆREDIS_MASTER ï¼‰æˆ–è€…ä»æœåŠ¡å™¨ï¼ˆæ‰“å¼€äº† REDIS_SLAVE æ ‡å¿—ï¼‰ æ­£åœ¨è¢« BLPOP ç­‰å‘½ä»¤é˜»å¡ï¼ˆREDIS_BLOCKEDï¼‰ æ­£åœ¨æ‰§è¡Œ SUBSCRIBEã€PSUBSCRIBE ç­‰è®¢é˜…å‘½ä»¤ å®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤è¯·æ±‚çš„å¤§å°è¶…è¿‡äº†è¾“å…¥ç¼“å†²åŒºçš„é™åˆ¶å¤§å°ï¼ˆé»˜è®¤ä¸º 1GBï¼‰ å‘é€ç»™å®¢æˆ·ç«¯çš„å‘½ä»¤å›å¤çš„å¤§å°è¶…è¿‡äº†è¾“å‡ºç¼“å†²åŒºçš„é™åˆ¶å¤§å° ç†è®ºä¸Šæ¥è¯´ï¼Œå¯å˜ç¼“å†²åŒºå¯ä»¥ä¿å­˜ä»»æ„é•¿çš„å‘½ä»¤å›å¤ï¼Œä½†æ˜¯ä¸ºäº†å›å¤è¿‡å¤§å ç”¨è¿‡å¤šçš„æœåŠ¡å™¨èµ„æºï¼ŒæœåŠ¡å™¨ä¼šæ—¶åˆ»æ£€æŸ¥å®¢æˆ·ç«¯çš„è¾“å‡ºç¼“å†²åŒºçš„å¤§å°ï¼Œå¹¶åœ¨ç¼“å†²åŒºçš„å¤§å°è¶…å‡ºèŒƒå›´æ—¶ï¼Œæ‰§è¡Œç›¸åº”çš„é™åˆ¶æ“ä½œï¼š ç¡¬æ€§é™åˆ¶ (hard limit)ï¼šè¾“å‡ºç¼“å†²åŒºçš„å¤§å°è¶…è¿‡äº†ç¡¬æ€§é™åˆ¶æ‰€è®¾ç½®çš„å¤§å°ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä¼šå…³é—­å®¢æˆ·ç«¯ï¼ˆserverCron å‡½æ•°ä¸­æ‰§è¡Œï¼‰ï¼Œç§¯å­˜åœ¨è¾“å‡ºç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹ä¼šè¢«ç›´æ¥é‡Šæ”¾ï¼Œä¸ä¼šè¿”å›ç»™å®¢æˆ·ç«¯ è½¯æ€§é™åˆ¶ (soft limit)ï¼šè¾“å‡ºç¼“å†²åŒºçš„å¤§å°è¶…è¿‡äº†è½¯æ€§é™åˆ¶æ‰€è®¾ç½®çš„å¤§å°ï¼Œå°äºç¡¬æ€§é™åˆ¶çš„å¤§å°ï¼ŒæœåŠ¡å™¨çš„æ“ä½œï¼š ç”¨å±æ€§ obuf_soft_limit_reached_time è®°å½•ä¸‹å®¢æˆ·ç«¯åˆ°è¾¾è½¯æ€§é™åˆ¶çš„èµ·å§‹æ—¶é—´ï¼Œç»§ç»­ç›‘è§†å®¢æˆ·ç«¯ å¦‚æœè¾“å‡ºç¼“å†²åŒºçš„å¤§å°ä¸€ç›´è¶…å‡ºè½¯æ€§é™åˆ¶ï¼Œå¹¶ä¸”æŒç»­æ—¶é—´è¶…è¿‡æœåŠ¡å™¨è®¾å®šçš„æ—¶é•¿ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å°†å…³é—­å®¢æˆ·ç«¯ å¦‚æœåœ¨æŒ‡å®šæ—¶é—´å†…ä¸å†è¶…å‡ºè½¯æ€§é™åˆ¶ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å°±ä¸ä¼šè¢«å…³é—­ï¼Œå¹¶ä¸” o_s_l_r_t å±æ€§æ¸…é›¶ ä½¿ç”¨ client-output-buffer-limit é€‰é¡¹å¯ä»¥ä¸ºæ™®é€šå®¢æˆ·ç«¯ã€ä»æœåŠ¡å™¨å®¢æˆ·ç«¯ã€æ‰§è¡Œå‘å¸ƒä¸è®¢é˜…åŠŸèƒ½çš„å®¢æˆ·ç«¯åˆ†åˆ«è®¾ç½®ä¸åŒçš„è½¯æ€§é™åˆ¶å’Œç¡¬æ€§é™åˆ¶ï¼Œæ ¼å¼ï¼š 12345client-output-buffer-limit &lt;class&gt; &lt;hard limit&gt; &lt;soft limit&gt; &lt;soft seconds&gt;client-output-buffer-limit normal 0 0 0 client-output-buffer-limit slave 256mb 64mb 60 client-output-buffer-limit pubsub 32mb 8mb 60 ç¬¬ä¸€è¡Œï¼šå°†æ™®é€šå®¢æˆ·ç«¯çš„ç¡¬æ€§é™åˆ¶å’Œè½¯æ€§é™åˆ¶éƒ½è®¾ç½®ä¸º 0ï¼Œè¡¨ç¤ºä¸é™åˆ¶å®¢æˆ·ç«¯çš„è¾“å‡ºç¼“å†²åŒºå¤§å° ç¬¬äºŒè¡Œï¼šå°†ä»æœåŠ¡å™¨å®¢æˆ·ç«¯çš„ç¡¬æ€§é™åˆ¶è®¾ç½®ä¸º 256MBï¼Œè½¯æ€§é™åˆ¶è®¾ç½®ä¸º 64MBï¼Œè½¯æ€§é™åˆ¶çš„æ—¶é•¿ä¸º 60 ç§’ ç¬¬ä¸‰è¡Œï¼šå°†æ‰§è¡Œå‘å¸ƒä¸è®¢é˜…åŠŸèƒ½çš„å®¢æˆ·ç«¯çš„ç¡¬æ€§é™åˆ¶è®¾ç½®ä¸º 32MBï¼Œè½¯æ€§é™åˆ¶è®¾ç½®ä¸º 8MBï¼Œè½¯æ€§é™åˆ¶çš„æ—¶é•¿ä¸º 60 ç§’ æœåŠ¡å™¨æ‰§è¡Œæµç¨‹Redis æœåŠ¡å™¨ä¸å¤šä¸ªå®¢æˆ·ç«¯å»ºç«‹ç½‘ç»œè¿æ¥ï¼Œå¤„ç†å®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤è¯·æ±‚ï¼Œåœ¨æ•°æ®åº“ä¸­ä¿å­˜å®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤æ‰€äº§ç”Ÿçš„æ•°æ®ï¼Œå¹¶é€šè¿‡èµ„æºç®¡ç†æ¥ç»´æŒæœåŠ¡å™¨è‡ªèº«çš„è¿è½¬ï¼Œæ‰€ä»¥ä¸€ä¸ªå‘½ä»¤è¯·æ±‚ä»å‘é€åˆ°è·å¾—å›å¤çš„è¿‡ç¨‹ä¸­ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éœ€è¦å®Œæˆä¸€ç³»åˆ—æ“ä½œ å‘½ä»¤è¯·æ±‚Redis æœåŠ¡å™¨çš„å‘½ä»¤è¯·æ±‚æ¥è‡ª Redis å®¢æˆ·ç«¯ï¼Œå½“ç”¨æˆ·åœ¨å®¢æˆ·ç«¯ä¸­é”®å…¥ä¸€ä¸ªå‘½ä»¤è¯·æ±‚æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šå°†è¿™ä¸ªå‘½ä»¤è¯·æ±‚è½¬æ¢æˆåè®®æ ¼å¼ï¼Œé€šè¿‡è¿æ¥åˆ°æœåŠ¡å™¨çš„å¥—æ¥å­—ï¼Œå°†åè®®æ ¼å¼çš„å‘½ä»¤è¯·æ±‚å‘é€ç»™æœåŠ¡å™¨ 12SET KEY VALUE -&gt; # å‘½ä»¤*3\\r\\nS3\\r\\nSET\\r\\n$3\\r\\nKEY\\r\\n$5\\r\\nVALUE\\r\\n # åè®®æ ¼å¼ å½“å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥å¥—æ¥å­—å› ä¸ºå®¢æˆ·ç«¯çš„å†™å…¥è€Œå˜å¾—å¯è¯»ï¼ŒæœåŠ¡å™¨è°ƒç”¨å‘½ä»¤è¯·æ±‚å¤„ç†å™¨æ¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š è¯»å–å¥—æ¥å­—ä¸­åè®®æ ¼å¼çš„å‘½ä»¤è¯·æ±‚ï¼Œå¹¶å°†å…¶ä¿å­˜åˆ°å®¢æˆ·ç«¯çŠ¶æ€çš„è¾“å…¥ç¼“å†²åŒºé‡Œé¢ å¯¹è¾“å…¥ç¼“å†²åŒºä¸­çš„å‘½ä»¤è¯·æ±‚è¿›è¡Œåˆ†æï¼Œæå–å‡ºå‘½ä»¤è¯·æ±‚ä¸­åŒ…å«çš„å‘½ä»¤å‚æ•°ä»¥åŠå‘½ä»¤å‚æ•°çš„ä¸ªæ•°ï¼Œç„¶ååˆ†åˆ«å°†å‚æ•°å’Œå‚æ•°ä¸ªæ•°ä¿å­˜åˆ°å®¢æˆ·ç«¯çŠ¶æ€çš„ argv å±æ€§å’Œ argc å±æ€§é‡Œ è°ƒç”¨å‘½ä»¤æ‰§è¡Œå™¨ï¼Œæ‰§è¡Œå®¢æˆ·ç«¯æŒ‡å®šçš„å‘½ä»¤ æœ€åå®¢æˆ·ç«¯æ¥æ”¶åˆ°åè®®æ ¼å¼çš„å‘½ä»¤å›å¤ä¹‹åï¼Œä¼šå°†è¿™äº›å›å¤è½¬æ¢æˆç”¨æˆ·å¯è¯»çš„æ ¼å¼æ‰“å°ç»™ç”¨æˆ·è§‚çœ‹ï¼Œè‡³æ­¤æ•´ä½“æµç¨‹ç»“æŸ å‘½ä»¤æ‰§è¡Œå‘½ä»¤æ‰§è¡Œå™¨å¼€å§‹å¯¹å‘½ä»¤æ“ä½œï¼š æŸ¥æ‰¾å‘½ä»¤ï¼šé¦–å…ˆæ ¹æ®å®¢æˆ·ç«¯çŠ¶æ€çš„ argv[0] å‚æ•°ï¼Œåœ¨å‘½ä»¤è¡¨ (command table) ä¸­æŸ¥æ‰¾å‚æ•°æ‰€æŒ‡å®šçš„å‘½ä»¤ï¼Œå¹¶å°†æ‰¾åˆ°çš„å‘½ä»¤ä¿å­˜åˆ°å®¢æˆ·ç«¯çŠ¶æ€çš„ cmd å±æ€§é‡Œé¢ï¼Œæ˜¯ä¸€ä¸ª redisCommand ç»“æ„ å‘½ä»¤æŸ¥æ‰¾ç®—æ³•ä¸å­—æ¯çš„å¤§å°å†™æ— å…³ï¼Œæ‰€ä»¥å‘½ä»¤åå­—çš„å¤§å°å†™ä¸å½±å“å‘½ä»¤è¡¨çš„æŸ¥æ‰¾ç»“æœ æ‰§è¡Œé¢„å¤‡æ“ä½œï¼š æ£€æŸ¥å®¢æˆ·ç«¯çŠ¶æ€çš„ cmd æŒ‡é’ˆæ˜¯å¦æŒ‡å‘ NULLï¼Œæ ¹æ® redisCommand æ£€æŸ¥è¯·æ±‚å‚æ•°çš„æ•°é‡æ˜¯å¦æ­£ç¡® æ£€æŸ¥å®¢æˆ·ç«¯æ˜¯å¦é€šè¿‡èº«ä»½éªŒè¯ å¦‚æœæœåŠ¡å™¨æ‰“å¼€äº† maxmemory åŠŸèƒ½ï¼Œæ‰§è¡Œå‘½ä»¤ä¹‹å‰è¦å…ˆæ£€æŸ¥æœåŠ¡å™¨çš„å†…å­˜å ç”¨ï¼Œåœ¨æœ‰éœ€è¦æ—¶è¿›è¡Œå†…å­˜å›æ”¶ï¼ˆé€å‡ºç®—æ³•ï¼‰ å¦‚æœæœåŠ¡å™¨ä¸Šä¸€æ¬¡æ‰§è¡Œ BGSAVE å‘½ä»¤å‡ºé”™ï¼Œå¹¶ä¸”æœåŠ¡å™¨æ‰“å¼€äº† stop-writes-on-bgsave-error åŠŸèƒ½ï¼Œé‚£ä¹ˆå¦‚æœæœ¬æ¬¡æ‰§è¡Œçš„æ˜¯å†™å‘½ä»¤ï¼ŒæœåŠ¡ä¼šæ‹’ç»æ‰§è¡Œï¼Œå¹¶è¿”å›é”™è¯¯ å¦‚æœå®¢æˆ·ç«¯å½“å‰æ­£åœ¨ç”¨ SUBSCRIBE æˆ– PSUBSCRIBE å‘½ä»¤è®¢é˜…é¢‘é“ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä¼šæ‹’ç»é™¤äº† SUBSCRIBEã€SUBSCRIBEã€ UNSUBSCRIBEã€PUNSUBSCRIBE ä¹‹å¤–çš„å…¶ä»–å‘½ä»¤ å¦‚æœæœåŠ¡å™¨æ­£åœ¨è¿›è¡Œè½½å…¥æ•°æ®ï¼Œåªæœ‰ sflags å¸¦æœ‰ 1 æ ‡è¯†ï¼ˆæ¯”å¦‚ INFOã€SHUTDOWNã€PUBLISHç­‰ï¼‰çš„å‘½ä»¤æ‰ä¼šè¢«æ‰§è¡Œ å¦‚æœæœåŠ¡å™¨æ‰§è¡Œ Lua è„šæœ¬è€Œè¶…æ—¶å¹¶è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œé‚£ä¹ˆåªä¼šæ‰§è¡Œå®¢æˆ·ç«¯å‘æ¥çš„ SHUTDOWN nosave å’Œ SCRIPT KILL å‘½ä»¤ å¦‚æœå®¢æˆ·ç«¯æ­£åœ¨æ‰§è¡Œäº‹åŠ¡ï¼Œé‚£ä¹ˆæœåŠ¡å™¨åªä¼šæ‰§è¡Œå®¢æˆ·ç«¯å‘æ¥çš„ EXECã€DISCARDã€MULTIã€WATCH å››ä¸ªå‘½ä»¤ï¼Œå…¶ä»–å‘½ä»¤éƒ½ä¼šè¢«æ”¾è¿›äº‹åŠ¡é˜Ÿåˆ—ä¸­ å¦‚æœæœåŠ¡å™¨æ‰“å¼€äº†ç›‘è§†å™¨åŠŸèƒ½ï¼Œé‚£ä¹ˆä¼šå°†è¦æ‰§è¡Œçš„å‘½ä»¤å’Œå‚æ•°ç­‰ä¿¡æ¯å‘é€ç»™ç›‘è§†å™¨ è°ƒç”¨å‘½ä»¤çš„å®ç°å‡½æ•°ï¼šè¢«è°ƒç”¨çš„å‡½æ•°ä¼šæ‰§è¡ŒæŒ‡å®šçš„æ“ä½œå¹¶äº§ç”Ÿç›¸åº”çš„å‘½ä»¤å›å¤ï¼Œå›å¤ä¼šè¢«ä¿å­˜åœ¨å®¢æˆ·ç«¯çŠ¶æ€çš„è¾“å‡ºç¼“å†²åŒºé‡Œé¢ï¼ˆbuf å’Œ reply å±æ€§ï¼‰ï¼Œç„¶åå®ç°å‡½æ•°è¿˜ä¼šä¸ºå®¢æˆ·ç«¯çš„å¥—æ¥å­—å…³è”å‘½ä»¤å›å¤å¤„ç†å™¨ï¼Œè¿™ä¸ªå¤„ç†å™¨è´Ÿè´£å°†å‘½ä»¤å›å¤è¿”å›ç»™å®¢æˆ·ç«¯ æ‰§è¡Œåç»­å·¥ä½œï¼š å¦‚æœæœåŠ¡å™¨å¼€å¯äº†æ…¢æŸ¥è¯¢æ—¥å¿—åŠŸèƒ½ï¼Œé‚£ä¹ˆæ…¢æŸ¥è¯¢æ—¥å¿—æ¨¡å—ä¼šæ£€æŸ¥æ˜¯å¦éœ€è¦ä¸ºåˆšåˆšæ‰§è¡Œå®Œçš„å‘½ä»¤è¯·æ±‚æ·»åŠ ä¸€æ¡æ–°çš„æ…¢æŸ¥è¯¢æ—¥å¿— æ ¹æ®æ‰§è¡Œå‘½ä»¤æ‰€è€—è´¹çš„æ—¶é•¿ï¼Œæ›´æ–°å‘½ä»¤çš„ redisCommand ç»“æ„çš„ milliseconds å±æ€§ï¼Œå¹¶å°†å‘½ä»¤ calls è®¡æ•°å™¨çš„å€¼å¢ä¸€ å¦‚æœæœåŠ¡å™¨å¼€å¯äº† AOF æŒä¹…åŒ–åŠŸèƒ½ï¼Œé‚£ä¹ˆ AOF æŒä¹…åŒ–æ¨¡å—ä¼šå°†æ‰§è¡Œçš„å‘½ä»¤è¯·æ±‚å†™å…¥åˆ° AOF ç¼“å†²åŒºé‡Œé¢ å¦‚æœæœ‰å…¶ä»–ä»æœåŠ¡å™¨æ­£åœ¨å¤åˆ¶å½“å‰è¿™ä¸ªæœåŠ¡å™¨ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä¼šå°†æ‰§è¡Œçš„å‘½ä»¤ä¼ æ’­ç»™æ‰€æœ‰ä»æœåŠ¡å™¨ å°†å‘½ä»¤å›å¤å‘é€ç»™å®¢æˆ·ç«¯ï¼šå®¢æˆ·ç«¯å¥—æ¥å­—å˜ä¸ºå¯å†™çŠ¶æ€æ—¶ï¼ŒæœåŠ¡å™¨å°±ä¼šæ‰§è¡Œå‘½ä»¤å›å¤å¤„ç†å™¨ï¼Œå°†å®¢æˆ·ç«¯è¾“å‡ºç¼“å†²åŒºä¸­çš„å‘½ä»¤å›å¤å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå‘é€å®Œæ¯•ä¹‹åå›å¤å¤„ç†å™¨ä¼šæ¸…ç©ºå®¢æˆ·ç«¯çŠ¶æ€çš„è¾“å‡ºç¼“å†²åŒºï¼Œä¸ºå¤„ç†ä¸‹ä¸€ä¸ªå‘½ä»¤è¯·æ±‚åšå¥½å‡†å¤‡ Commandæ¯ä¸ª redisCommand ç»“æ„è®°å½•äº†ä¸€ä¸ªRedis å‘½ä»¤çš„å®ç°ä¿¡æ¯ï¼Œä¸»è¦å±æ€§ 1234567891011121314151617181920212223242526struct redisCommand &#123; // å‘½ä»¤çš„åå­—ï¼Œæ¯”å¦‚&quot;set&quot; char *name; // å‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘å‘½ä»¤çš„å®ç°å‡½æ•°ï¼Œæ¯”å¦‚setCommand // redisCommandProc ç±»å‹çš„å®šä¹‰ä¸º typedef void redisCommandProc(redisClient *c) redisCommandProc *proc; // å‘½ä»¤å‚æ•°çš„ä¸ªæ•°ï¼Œç”¨äºæ£€æŸ¥å‘½ä»¤è¯·æ±‚çš„æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚å¦‚æœè¿™ä¸ªå€¼ä¸ºè´Ÿæ•°-N, é‚£ä¹ˆè¡¨ç¤ºå‚æ•°çš„æ•°é‡å¤§äºç­‰äºNã€‚ // æ³¨æ„å‘½ä»¤çš„åå­—æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå‚æ•°ï¼Œæ¯”å¦‚ SET msg &quot;hello&quot;ï¼Œå‘½ä»¤çš„å‚æ•°æ˜¯&quot;SET&quot;ã€&quot;msg&quot;ã€&quot;hello&quot; ä¸‰ä¸ª int arity; // å­—ç¬¦ä¸²å½¢å¼çš„æ ‡è¯†å€¼ï¼Œè¿™ä¸ªå€¼è®°å½•äº†å‘½ä»¤çš„å±æ€§ï¼Œï¼Œ // æ¯”å¦‚è¿™ä¸ªå‘½ä»¤æ˜¯å†™å‘½ä»¤è¿˜æ˜¯è¯»å‘½ä»¤ï¼Œè¿™ä¸ªå‘½ä»¤æ˜¯å¦å…è®¸åœ¨è½½å…¥æ•°æ®æ—¶ä½¿ç”¨ï¼Œæ˜¯å¦å…è®¸åœ¨Luaè„šæœ¬ä¸­ä½¿ç”¨ç­‰ç­‰ char *sflags; // å¯¹sflagsæ ‡è¯†è¿›è¡Œåˆ†æå¾—å‡ºçš„äºŒè¿›åˆ¶æ ‡è¯†ï¼Œç”±ç¨‹åºè‡ªåŠ¨ç”Ÿæˆã€‚æœåŠ¡å™¨å¯¹å‘½ä»¤æ ‡è¯†è¿›è¡Œæ£€æŸ¥æ—¶ä½¿ç”¨çš„éƒ½æ˜¯ flags å±æ€§ // è€Œä¸æ˜¯sflagså±æ€§ï¼Œå› ä¸ºå¯¹äºŒè¿›åˆ¶æ ‡è¯†çš„æ£€æŸ¥å¯ä»¥æ–¹ä¾¿åœ°é€šè¿‡&amp; ^ ~ ç­‰æ“ä½œæ¥å®Œæˆ int flags; // æœåŠ¡å™¨æ€»å…±æ‰§è¡Œäº†å¤šå°‘æ¬¡è¿™ä¸ªå‘½ä»¤ long long calls; // æœåŠ¡å™¨æ‰§è¡Œè¿™ä¸ªå‘½ä»¤æ‰€è€—è´¹çš„æ€»æ—¶é•¿ long long milliseconds;&#125;; serverCronåŸºæœ¬ä»‹ç»Redis æœåŠ¡å™¨ä»¥å‘¨æœŸæ€§äº‹ä»¶çš„æ–¹å¼æ¥è¿è¡Œ serverCron å‡½æ•°ï¼ŒæœåŠ¡å™¨åˆå§‹åŒ–æ—¶è¯»å–é…ç½® server.hz çš„å€¼ï¼Œé»˜è®¤ä¸º 10ï¼Œä»£è¡¨æ¯ç§’é’Ÿæ‰§è¡Œ 10 æ¬¡ï¼Œå³æ¯éš” 100 æ¯«ç§’æ‰§è¡Œä¸€æ¬¡ï¼Œæ‰§è¡ŒæŒ‡ä»¤ info server å¯ä»¥æŸ¥çœ‹ serverCron å‡½æ•°è´Ÿè´£å®šæœŸå¯¹è‡ªèº«çš„èµ„æºå’ŒçŠ¶æ€è¿›è¡Œæ£€æŸ¥å’Œè°ƒæ•´ï¼Œä»è€Œç¡®ä¿æœåŠ¡å™¨å¯ä»¥é•¿æœŸã€ç¨³å®šåœ°è¿è¡Œ æ›´æ–°æœåŠ¡å™¨çš„å„ç±»ç»Ÿè®¡ä¿¡æ¯ï¼Œæ¯”å¦‚æ—¶é—´ã€å†…å­˜å ç”¨ã€ æ•°æ®åº“å ç”¨æƒ…å†µç­‰ æ¸…ç†æ•°æ®åº“ä¸­çš„è¿‡æœŸé”®å€¼å¯¹ å…³é—­å’Œæ¸…ç†è¿æ¥å¤±æ•ˆçš„å®¢æˆ·ç«¯ è¿›è¡Œ AOF æˆ– RDB æŒä¹…åŒ–æ“ä½œ å¦‚æœæœåŠ¡å™¨æ˜¯ä¸»æœåŠ¡å™¨ï¼Œé‚£ä¹ˆå¯¹ä»æœåŠ¡å™¨è¿›è¡Œå®šæœŸåŒæ­¥ å¦‚æœå¤„äºé›†ç¾¤æ¨¡å¼ï¼Œå¯¹é›†ç¾¤è¿›è¡Œå®šæœŸåŒæ­¥å’Œè¿æ¥æµ‹è¯• æ—¶é—´ç¼“å­˜Redis æœåŠ¡å™¨ä¸­æœ‰å¾ˆå¤šåŠŸèƒ½éœ€è¦è·å–ç³»ç»Ÿçš„å½“å‰æ—¶é—´ï¼Œè€Œæ¯æ¬¡è·å–ç³»ç»Ÿçš„å½“å‰æ—¶é—´éƒ½éœ€è¦æ‰§è¡Œä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œä¸ºäº†å‡å°‘ç³»ç»Ÿè°ƒç”¨çš„æ‰§è¡Œæ¬¡æ•°ï¼ŒæœåŠ¡å™¨çŠ¶æ€ä¸­çš„ unixtime å±æ€§å’Œ mstime å±æ€§è¢«ç”¨ä½œå½“å‰æ—¶é—´çš„ç¼“å­˜ 1234567struct redisServer &#123; // ä¿å­˜äº†ç§’çº§ç²¾åº¦çš„ç³»ç»Ÿå½“å‰UNIXæ—¶é—´æˆ³ time_t unixtime; // ä¿å­˜äº†æ¯«ç§’çº§ç²¾åº¦çš„ç³»ç»Ÿå½“å‰UNIXæ—¶é—´æˆ³ long long mstime; &#125;; serverCron å‡½æ•°é»˜è®¤ä»¥æ¯ 100 æ¯«ç§’ä¸€æ¬¡çš„é¢‘ç‡æ›´æ–°ä¸¤ä¸ªå±æ€§ï¼Œæ‰€ä»¥å±æ€§è®°å½•çš„æ—¶é—´çš„ç²¾ç¡®åº¦å¹¶ä¸é«˜ æœåŠ¡å™¨åªä¼šåœ¨æ‰“å°æ—¥å¿—ã€æ›´æ–°æœåŠ¡å™¨çš„ LRU æ—¶é’Ÿã€å†³å®šæ˜¯å¦æ‰§è¡ŒæŒä¹…åŒ–ä»»åŠ¡ã€è®¡ç®—æœåŠ¡å™¨ä¸Šçº¿æ—¶é—´ï¼ˆuptimeï¼‰è¿™ç±»å¯¹æ—¶é—´ç²¾ç¡®åº¦è¦æ±‚ä¸é«˜çš„åŠŸèƒ½ä¸Š å¯¹äºä¸ºé”®è®¾ç½®è¿‡æœŸæ—¶é—´ã€æ·»åŠ æ…¢æŸ¥è¯¢æ—¥å¿—è¿™ç§éœ€è¦é«˜ç²¾ç¡®åº¦æ—¶é—´çš„åŠŸèƒ½æ¥è¯´ï¼ŒæœåŠ¡å™¨è¿˜æ˜¯ä¼šå†æ¬¡æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œä»è€Œè·å¾—æœ€å‡†ç¡®çš„ç³»ç»Ÿå½“å‰æ—¶é—´ LRU æ—¶é’ŸæœåŠ¡å™¨çŠ¶æ€ä¸­çš„ lruclock å±æ€§ä¿å­˜äº†æœåŠ¡å™¨çš„ LRU æ—¶é’Ÿ 1234struct redisServer &#123; // é»˜è®¤æ¯10ç§’æ›´æ–°ä¸€æ¬¡çš„æ—¶é’Ÿç¼“å­˜ï¼Œç”¨äºè®¡ç®—é”®çš„ç©ºè½¬(idle)æ—¶é•¿ã€‚ unsigned lruclock:22; &#125;; æ¯ä¸ª Redis å¯¹è±¡éƒ½ä¼šæœ‰ä¸€ä¸ª lru å±æ€§ï¼Œ è¿™ä¸ª lru å±æ€§ä¿å­˜äº†å¯¹è±¡æœ€åä¸€æ¬¡è¢«å‘½ä»¤è®¿é—®çš„æ—¶é—´ 123typedef struct redisObiect &#123; unsigned lru:22; &#125; robj; å½“æœåŠ¡å™¨è¦è®¡ç®—ä¸€ä¸ªæ•°æ®åº“é”®çš„ç©ºè½¬æ—¶é—´ï¼ˆå³æ•°æ®åº“é”®å¯¹åº”çš„å€¼å¯¹è±¡çš„ç©ºè½¬æ—¶é—´ï¼‰ï¼Œç¨‹åºä¼šç”¨æœåŠ¡å™¨çš„ lruclock å±æ€§è®°å½•çš„æ—¶é—´å‡å»å¯¹è±¡çš„ lru å±æ€§è®°å½•çš„æ—¶é—´ serverCron å‡½æ•°é»˜è®¤ä»¥æ¯ 100 æ¯«ç§’ä¸€æ¬¡çš„é¢‘ç‡æ›´æ–°è¿™ä¸ªå±æ€§ï¼Œæ‰€ä»¥å¾—å‡ºçš„ç©ºè½¬æ—¶é—´ä¹Ÿæ˜¯æ¨¡ç³Šçš„ å‘½ä»¤æ¬¡æ•°serverCron ä¸­çš„ trackOperationsPerSecond å‡½æ•°ä»¥æ¯ 100 æ¯«ç§’ä¸€æ¬¡çš„é¢‘ç‡æ‰§è¡Œï¼Œå‡½æ•°åŠŸèƒ½æ˜¯ä»¥æŠ½æ ·è®¡ç®—çš„æ–¹å¼ï¼Œä¼°ç®—å¹¶è®°å½•æœåŠ¡å™¨åœ¨æœ€è¿‘ä¸€ç§’é’Ÿå¤„ç†çš„å‘½ä»¤è¯·æ±‚æ•°é‡ï¼Œè¿™ä¸ªå€¼å¯ä»¥é€šè¿‡ INFO status å‘½ä»¤çš„ instantaneous_ops_per_sec åŸŸæŸ¥çœ‹ï¼š 123redis&gt; INFO stats# Stats instantaneous_ops_per_sec:6 æ ¹æ®ä¸Šä¸€æ¬¡æŠ½æ ·æ—¶é—´ ops_sec_last_sample_time å’Œå½“å‰ç³»ç»Ÿæ—¶é—´ï¼Œä»¥åŠä¸Šä¸€æ¬¡å·²æ‰§è¡Œçš„å‘½ä»¤æ•° ops_sec_last_sample_ops å’ŒæœåŠ¡å™¨å½“å‰å·²ç»æ‰§è¡Œçš„å‘½ä»¤æ•°ï¼Œè®¡ç®—å‡ºä¸¤æ¬¡å‡½æ•°è°ƒç”¨æœŸé—´ï¼ŒæœåŠ¡å™¨å¹³å‡æ¯æ¯«ç§’å¤„ç†äº†å¤šå°‘ä¸ªå‘½ä»¤è¯·æ±‚ï¼Œè¯¥å€¼ä¹˜ä»¥ 1000 å¾—åˆ°æ¯ç§’å†…çš„æ‰§è¡Œå‘½ä»¤çš„ä¼°è®¡å€¼ï¼Œæ”¾å…¥ ops_sec_samples ç¯å½¢æ•°ç»„é‡Œ 12345678910struct redisServer &#123; // ä¸Šä¸€æ¬¡è¿›è¡ŒæŠ½æ ·çš„æ—¶é—´ long long ops_sec_last_sample_time; // ä¸Šä¸€æ¬¡æŠ½æ ·æ—¶ï¼ŒæœåŠ¡å™¨å·²æ‰§è¡Œå‘½ä»¤çš„æ•°é‡ long long ops_sec_last_sample_ops; // REDIS_OPS_SEC_SAMPLES å¤§å°ï¼ˆé»˜è®¤å€¼ä¸º16)çš„ç¯å½¢æ•°ç»„ï¼Œæ•°ç»„çš„æ¯ä¸€é¡¹è®°å½•ä¸€æ¬¡çš„æŠ½æ ·ç»“æœ long long ops_sec_samples[REDIS_OPS_SEC_SAMPLES]; // ops_sec_samplesæ•°ç»„çš„ç´¢å¼•å€¼ï¼Œæ¯æ¬¡æŠ½æ ·åå°†å€¼è‡ªå¢ä¸€ï¼Œå€¼ä¸º16æ—¶é‡ç½®ä¸º0ï¼Œè®©æ•°ç»„æˆä¸ºä¸€ä¸ªç¯å½¢æ•°ç»„ int ops_sec_idx;&#125;; å†…å­˜å³°å€¼æœåŠ¡å™¨çŠ¶æ€é‡Œçš„ stat_peak_memory å±æ€§è®°å½•äº†æœåŠ¡å™¨å†…å­˜å³°å€¼å¤§å°ï¼Œå¾ªç¯å‡½æ•°æ¯æ¬¡æ‰§è¡Œæ—¶éƒ½ä¼šæŸ¥çœ‹æœåŠ¡å™¨å½“å‰ä½¿ç”¨çš„å†…å­˜æ•°é‡ï¼Œå¹¶ä¸ stat_peak_memory ä¿å­˜çš„æ•°å€¼è¿›è¡Œæ¯”è¾ƒï¼Œè®¾ç½®ä¸ºè¾ƒå¤§çš„å€¼ 1234struct redisServer &#123; // å·²ä½¿ç”¨å†…å­˜å³°å€¼ size_t stat_peak_memory;&#125;; INFO memory å‘½ä»¤çš„ used_memory_peak å’Œ used_memory_peak_human ä¸¤ä¸ªåŸŸåˆ†åˆ«ä»¥ä¸¤ç§æ ¼å¼è®°å½•äº†æœåŠ¡å™¨çš„å†…å­˜å³°å€¼ï¼š 12345redis&gt; INFO memory # Memory ...used_memory_peak:501824 used_memory_peak_human:490.06K SIGTERMæœåŠ¡å™¨å¯åŠ¨æ—¶ï¼ŒRedis ä¼šä¸ºæœåŠ¡å™¨è¿›ç¨‹çš„ SIGTERM ä¿¡å·å…³è”å¤„ç†å™¨ sigtermHandler å‡½æ•°ï¼Œè¯¥ä¿¡å·å¤„ç†å™¨è´Ÿè´£åœ¨æœåŠ¡å™¨æ¥åˆ° SIGTERM ä¿¡å·æ—¶ï¼Œæ‰“å¼€æœåŠ¡å™¨çŠ¶æ€çš„ shutdown_asap æ ‡è¯† 1234struct redisServer &#123; // å…³é—­æœåŠ¡å™¨çš„æ ‡è¯†ï¼šå€¼ä¸º1æ—¶å…³é—­æœåŠ¡å™¨ï¼Œå€¼ä¸º0æ—¶ä¸åšæ“ä½œ int shutdown_asap;&#125;; æ¯æ¬¡ serverCron å‡½æ•°è¿è¡Œæ—¶ï¼Œç¨‹åºéƒ½ä¼šå¯¹æœåŠ¡å™¨çŠ¶æ€çš„ shutdown_asap å±æ€§è¿›è¡Œæ£€æŸ¥ï¼Œå¹¶æ ¹æ®å±æ€§çš„å€¼å†³å®šæ˜¯å¦å…³é—­æœåŠ¡å™¨ æœåŠ¡å™¨åœ¨æ¥åˆ° SIGTERM ä¿¡å·ä¹‹åï¼Œå…³é—­æœåŠ¡å™¨å¹¶æ‰“å°ç›¸å…³æ—¥å¿—çš„è¿‡ç¨‹ï¼š 12345[6794 | signal handler] (1384435690) Received SIGTERM, scheduling shutdown ... [6794] 14 Nov 21:28:10.108 # User requested shutdown ... [6794] 14 Nov 21:28:10.108 * Saving the final RDB snapshot before exiting. [6794) 14 Nov 21:28:10.161 * DB saved on disk [6794) 14 Nov 21:28:10.161 # Redisis now ready to exit, bye bye ... ç®¡ç†èµ„æºserverCron å‡½æ•°æ¯æ¬¡æ‰§è¡Œéƒ½ä¼šè°ƒç”¨ clientsCron å’Œ databasesCron å‡½æ•°ï¼Œè¿›è¡Œç®¡ç†å®¢æˆ·ç«¯èµ„æºå’Œæ•°æ®åº“èµ„æº clientsCron å‡½æ•°å¯¹ä¸€å®šæ•°é‡çš„å®¢æˆ·ç«¯è¿›è¡Œä»¥ä¸‹ä¸¤ä¸ªæ£€æŸ¥ï¼š å¦‚æœå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥å·³ç»è¶…æ—¶ï¼ˆå¾ˆé•¿ä¸€æ®µæ—¶é—´å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ½æ²¡æœ‰äº’åŠ¨ï¼‰ï¼Œé‚£ä¹ˆç¨‹åºé‡Šæ”¾è¿™ä¸ªå®¢æˆ·ç«¯ å¦‚æœå®¢æˆ·ç«¯åœ¨ä¸Šä¸€æ¬¡æ‰§è¡Œå‘½ä»¤è¯·æ±‚ä¹‹åï¼Œè¾“å…¥ç¼“å†²åŒºçš„å¤§å°è¶…è¿‡äº†ä¸€å®šçš„é•¿åº¦ï¼Œé‚£ä¹ˆç¨‹åºä¼šé‡Šæ”¾å®¢æˆ·ç«¯å½“å‰çš„è¾“å…¥ç¼“å†²åŒºï¼Œå¹¶é‡æ–°åˆ›å»ºä¸€ä¸ªé»˜è®¤å¤§å°çš„è¾“å…¥ç¼“å†²åŒºï¼Œä»è€Œé˜²æ­¢å®¢æˆ·ç«¯çš„è¾“å…¥ç¼“å†²åŒºè€—è´¹äº†è¿‡å¤šçš„å†…å­˜ databasesCron å‡½æ•°ä¼šå¯¹æœåŠ¡å™¨ä¸­çš„ä¸€éƒ¨åˆ†æ•°æ®åº“è¿›è¡Œæ£€æŸ¥ï¼Œåˆ é™¤å…¶ä¸­çš„è¿‡æœŸé”®ï¼Œå¹¶åœ¨æœ‰éœ€è¦æ—¶å¯¹å­—å…¸è¿›è¡Œæ”¶ç¼©æ“ä½œ æŒä¹…çŠ¶æ€æœåŠ¡å™¨çŠ¶æ€ä¸­è®°å½•æ‰§è¡Œ BGSAVE å‘½ä»¤å’Œ BGREWRITEAOF å‘½ä»¤çš„å­è¿›ç¨‹çš„ ID 123456struct redisServer &#123; // è®°å½•æ‰§è¡ŒBGSAVEå‘½ä»¤çš„å­è¿›ç¨‹çš„IDï¼Œå¦‚æœæœåŠ¡å™¨æ²¡æœ‰åœ¨æ‰§è¡ŒBGSAVEï¼Œé‚£ä¹ˆè¿™ä¸ªå±æ€§çš„å€¼ä¸º-1 pid_t rdb_child_pid; // è®°å½•æ‰§è¡ŒBGREWRITEAOFå‘½ä»¤çš„å­è¿›ç¨‹çš„IDï¼Œå¦‚æœæœåŠ¡å™¨æ²¡æœ‰åœ¨æ‰§è¡Œé‚£ä¹ˆè¿™ä¸ªå±æ€§çš„å€¼ä¸º-1 pid_t aof_child_pid&#125;; serverCron å‡½æ•°æ‰§è¡Œæ—¶ï¼Œä¼šæ£€æŸ¥ä¸¤ä¸ªå±æ€§çš„å€¼ï¼Œåªè¦å…¶ä¸­ä¸€ä¸ªå±æ€§çš„å€¼ä¸ä¸º -1ï¼Œç¨‹åºå°±ä¼šæ‰§è¡Œä¸€æ¬¡ wait3 å‡½æ•°ï¼Œæ£€æŸ¥å­è¿›ç¨‹æ˜¯å¦æœ‰ä¿¡å·å‘æ¥æœåŠ¡å™¨è¿›ç¨‹ï¼š å¦‚æœæœ‰ä¿¡å·åˆ°è¾¾ï¼Œé‚£ä¹ˆè¡¨ç¤ºæ–°çš„ RDB æ–‡ä»¶å·²ç»ç”Ÿæˆæˆ–è€… AOF é‡å†™å®Œæ¯•ï¼ŒæœåŠ¡å™¨éœ€è¦è¿›è¡Œç›¸åº”å‘½ä»¤çš„åç»­æ“ä½œï¼Œæ¯”å¦‚ç”¨æ–°çš„ RDB æ–‡ä»¶æ›¿æ¢ç°æœ‰çš„ RDB æ–‡ä»¶ï¼Œç”¨é‡å†™åçš„ AOF æ–‡ä»¶æ›¿æ¢ç°æœ‰çš„ AOF æ–‡ä»¶ å¦‚æœæ²¡æœ‰ä¿¡å·åˆ°è¾¾ï¼Œé‚£ä¹ˆè¡¨ç¤ºæŒä¹…åŒ–æ“ä½œæœªå®Œæˆï¼Œç¨‹åºä¸åšåŠ¨ä½œ å¦‚æœä¸¤ä¸ªå±æ€§çš„å€¼éƒ½ä¸º -1ï¼Œè¡¨ç¤ºæœåŠ¡å™¨æ²¡æœ‰è¿›è¡ŒæŒä¹…åŒ–æ“ä½œ æŸ¥çœ‹æ˜¯å¦æœ‰ BGREWRITEAOF è¢«å»¶è¿Ÿï¼Œç„¶åæ‰§è¡Œ AOF åå°é‡å†™ æŸ¥çœ‹æœåŠ¡å™¨çš„è‡ªåŠ¨ä¿å­˜æ¡ä»¶æ˜¯å¦å·²ç»è¢«æ»¡è¶³ï¼Œå¹¶ä¸”æœåŠ¡å™¨æ²¡æœ‰åœ¨è¿›è¡ŒæŒä¹…åŒ–ï¼Œå°±å¼€å§‹ä¸€æ¬¡æ–°çš„ BGSAVE æ“ä½œ å› ä¸ºæ¡ä»¶ 1 å¯èƒ½ä¼šå¼•å‘ä¸€æ¬¡ AOFï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªæ£€æŸ¥ä¸­ä¼šå†æ¬¡ç¡®è®¤æœåŠ¡å™¨æ˜¯å¦å·²ç»åœ¨æ‰§è¡ŒæŒä¹…åŒ–æ“ä½œ æ£€æŸ¥æœåŠ¡å™¨è®¾ç½®çš„ AOF é‡å†™æ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼Œæ¡ä»¶æ»¡è¶³å¹¶ä¸”æœåŠ¡å™¨æ²¡æœ‰è¿›è¡ŒæŒä¹…åŒ–ï¼Œå°±è¿›è¡Œä¸€æ¬¡ AOF é‡å†™ å¦‚æœæœåŠ¡å™¨å¼€å¯äº† AOF æŒä¹…åŒ–åŠŸèƒ½ï¼Œå¹¶ä¸” AOF ç¼“å†²åŒºé‡Œè¿˜æœ‰å¾…å†™å…¥çš„æ•°æ®ï¼Œ é‚£ä¹ˆ serverCron å‡½æ•°ä¼šè°ƒç”¨ç›¸åº”çš„ç¨‹åºï¼Œå°† AOF ç¼“å†²åŒºä¸­çš„å†…å®¹å†™å…¥åˆ° AOF æ–‡ä»¶é‡Œ å»¶è¿Ÿæ‰§è¡Œåœ¨æœåŠ¡å™¨æ‰§è¡Œ BGSAVE å‘½ä»¤çš„æœŸé—´ï¼Œå¦‚æœå®¢æˆ·ç«¯å‘é€ BGREWRITEAOF å‘½ä»¤ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä¼šå°† BGREWRITEAOF å‘½ä»¤çš„æ‰§è¡Œæ—¶é—´å»¶è¿Ÿåˆ° BGSAVE å‘½ä»¤æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œç”¨æœåŠ¡å™¨çŠ¶æ€çš„ aof_rewrite_scheduled å±æ€§æ ‡è¯†å»¶è¿Ÿä¸å¦ 1234struct redisServer &#123; // å¦‚æœå€¼ä¸º1ï¼Œé‚£ä¹ˆè¡¨ç¤ºæœ‰ BGREWRITEAOFå‘½ä»¤è¢«å»¶è¿Ÿäº† int aof_rewrite_scheduled;&#125;; serverCron å‡½æ•°ä¼šæ£€æŸ¥ BGSAVE æˆ–è€… BGREWRITEAOF å‘½ä»¤æ˜¯å¦æ­£åœ¨æ‰§è¡Œï¼Œå¦‚æœè¿™ä¸¤ä¸ªå‘½ä»¤éƒ½æ²¡åœ¨æ‰§è¡Œï¼Œå¹¶ä¸” aof_rewrite_scheduled å±æ€§çš„å€¼ä¸º 1ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å°±ä¼šæ‰§è¡Œä¹‹å‰è¢«æ¨å»¶çš„ BGREWRITEAOF å‘½ä»¤ æ‰§è¡Œæ¬¡æ•°æœåŠ¡å™¨çŠ¶æ€çš„ cronloops å±æ€§è®°å½•äº† serverCron å‡½æ•°æ‰§è¡Œçš„æ¬¡æ•° 1234struct redisServer &#123; // serverCron å‡½æ•°æ¯æ‰§è¡Œä¸€æ¬¡ï¼Œè¿™ä¸ªå±æ€§çš„å€¼å°±å¢ 1 int cronloops;&#125;; ç¼“å†²é™åˆ¶æœåŠ¡å™¨ä¼šå…³é—­é‚£äº›è¾“å…¥æˆ–è€…è¾“å‡ºç¼“å†²åŒºå¤§å°è¶…å‡ºé™åˆ¶çš„å®¢æˆ·ç«¯ åˆå§‹åŒ–åˆå§‹ç»“æ„ä¸€ä¸ª Redis æœåŠ¡å™¨ä»å¯åŠ¨åˆ°èƒ½å¤Ÿæ¥å—å®¢æˆ·ç«¯çš„å‘½ä»¤è¯·æ±‚ï¼Œéœ€è¦ç»è¿‡ä¸€ç³»åˆ—çš„åˆå§‹åŒ–å’Œè®¾ç½®è¿‡ç¨‹ ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºä¸€ä¸ª redisServer ç±»å‹çš„å®ä¾‹å˜é‡ server ä½œä¸ºæœåŠ¡å™¨çš„çŠ¶æ€ï¼Œå¹¶ä¸ºç»“æ„ä¸­çš„å„ä¸ªå±æ€§è®¾ç½®é»˜è®¤å€¼ï¼Œç”± initServerConfig å‡½æ•°è¿›è¡Œåˆå§‹åŒ–ä¸€èˆ¬å±æ€§ï¼š è®¾ç½®æœåŠ¡å™¨çš„è¿è¡Œ IDã€é»˜è®¤è¿è¡Œé¢‘ç‡ã€é»˜è®¤é…ç½®æ–‡ä»¶è·¯å¾„ã€é»˜è®¤ç«¯å£å·ã€é»˜è®¤ RDB æŒä¹…åŒ–æ¡ä»¶å’Œ AOF æŒä¹…åŒ–æ¡ä»¶ åˆå§‹åŒ–æœåŠ¡å™¨çš„ LRU æ—¶é’Ÿï¼Œåˆ›å»ºå‘½ä»¤è¡¨ ç¬¬äºŒæ­¥ï¼šè½½å…¥é…ç½®é€‰é¡¹ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ç»™å®šé…ç½®å‚æ•°æˆ–è€…æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œå¯¹ server å˜é‡ç›¸å…³å±æ€§çš„é»˜è®¤å€¼è¿›è¡Œä¿®æ”¹ ç¬¬ä¸‰æ­¥ï¼šåˆå§‹åŒ–æœåŠ¡å™¨æ•°æ®ç»“æ„ï¼ˆé™¤äº†å‘½ä»¤è¡¨ä¹‹å¤–ï¼‰ï¼Œå› ä¸ºæœåŠ¡å™¨å¿…é¡»å…ˆè½½å…¥ç”¨æˆ·æŒ‡å®šçš„é…ç½®é€‰é¡¹æ‰èƒ½æ­£ç¡®åœ°å¯¹æ•°æ®ç»“æ„è¿›è¡Œåˆå§‹åŒ–ï¼Œæ‰€ä»¥è½½å…¥é…ç½®å®Œæˆåæ‰è¿›æ€§æ•°æ®ç»“æ„çš„åˆå§‹åŒ–ï¼ŒæœåŠ¡å™¨å°†è°ƒç”¨ initServer å‡½æ•°ï¼š server.clients é“¾è¡¨ï¼Œè®°å½•äº†çš„å®¢æˆ·ç«¯çš„çŠ¶æ€ç»“æ„ï¼›server.db æ•°ç»„ï¼ŒåŒ…å«äº†æœåŠ¡å™¨çš„æ‰€æœ‰æ•°æ®åº“ ç”¨äºä¿å­˜é¢‘é“è®¢é˜…ä¿¡æ¯çš„ server.pubsub_channels å­—å…¸ï¼Œ ä»¥åŠä¿å­˜æ¨¡å¼è®¢é˜…ä¿¡æ¯çš„ server.pubsub_patterns é“¾è¡¨ ç”¨äºæ‰§è¡Œ Lua è„šæœ¬çš„ Lua ç¯å¢ƒ server.lua ä¿å­˜æ…¢æŸ¥è¯¢æ—¥å¿—çš„ server.slowlog å±æ€§ initServer è¿˜è¿›è¡Œäº†éå¸¸é‡è¦çš„è®¾ç½®æ“ä½œï¼š ä¸ºæœåŠ¡å™¨è®¾ç½®è¿›ç¨‹ä¿¡å·å¤„ç†å™¨ åˆ›å»ºå…±äº«å¯¹è±¡ï¼ŒåŒ…å« OKã€ERRã€æ•´æ•° 1 åˆ° 10000 çš„å­—ç¬¦ä¸²å¯¹è±¡ç­‰ æ‰“å¼€æœåŠ¡å™¨çš„ç›‘å¬ç«¯å£ ä¸º serverCron å‡½æ•°åˆ›å»ºæ—¶é—´äº‹ä»¶ï¼Œ ç­‰å¾…æœåŠ¡å™¨æ­£å¼è¿è¡Œæ—¶æ‰§è¡Œ serverCron å‡½æ•° å¦‚æœ AOF æŒä¹…åŒ–åŠŸèƒ½å·²ç»æ‰“å¼€ï¼Œé‚£ä¹ˆæ‰“å¼€ç°æœ‰çš„ AOF æ–‡ä»¶ï¼Œå¦‚æœ AOF æ–‡ä»¶ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆåˆ›å»ºå¹¶æ‰“å¼€ä¸€ä¸ªæ–°çš„ AOF æ–‡ä»¶ ï¼Œä¸º AOF å†™å…¥åšå¥½å‡†å¤‡ åˆå§‹åŒ–æœåŠ¡å™¨çš„åå° I&#x2F;O æ¨¡å—ï¼ˆBIOï¼‰, ä¸ºå°†æ¥çš„ I&#x2F;O æ“ä½œåšå¥½å‡†å¤‡ å½“ initServer å‡½æ•°æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œ æœåŠ¡å™¨å°†ç”¨ ASCII å­—ç¬¦åœ¨æ—¥å¿—ä¸­æ‰“å°å‡º Redis çš„å›¾æ ‡ï¼Œ ä»¥åŠ Redis çš„ç‰ˆæœ¬å·ä¿¡æ¯ è¿˜åŸçŠ¶æ€åœ¨å®Œæˆäº†å¯¹æœåŠ¡å™¨çŠ¶æ€çš„åˆå§‹åŒ–ä¹‹åï¼ŒæœåŠ¡å™¨éœ€è¦è½½å…¥RDBæ–‡ä»¶æˆ–è€…AOF æ–‡ä»¶ï¼Œ å¹¶æ ¹æ®æ–‡ä»¶è®°å½•çš„å†…å®¹æ¥è¿˜åŸæœåŠ¡å™¨çš„æ•°æ®åº“çŠ¶æ€ï¼š å¦‚æœæœåŠ¡å™¨å¯ç”¨äº† AOF æŒä¹…åŒ–åŠŸèƒ½ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä½¿ç”¨ AOF æ–‡ä»¶æ¥è¿˜åŸæ•°æ®åº“çŠ¶æ€ å¦‚æœæœåŠ¡å™¨æ²¡æœ‰å¯ç”¨ AOF æŒä¹…åŒ–åŠŸèƒ½ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä½¿ç”¨ RDB æ–‡ä»¶æ¥è¿˜åŸæ•°æ®åº“çŠ¶æ€ å½“æœåŠ¡å™¨å®Œæˆæ•°æ®åº“çŠ¶æ€è¿˜åŸå·¥ä½œä¹‹åï¼ŒæœåŠ¡å™¨å°†åœ¨æ—¥å¿—ä¸­æ‰“å°å‡ºè½½å…¥æ–‡ä»¶å¹¶è¿˜åŸæ•°æ®åº“çŠ¶æ€æ‰€è€—è´¹çš„æ—¶é•¿ 1[7171] 22 Nov 22:43:49.084 * DB loaded from disk: 0.071 seconds é©±åŠ¨å¾ªç¯åœ¨åˆå§‹åŒ–çš„æœ€åä¸€æ­¥ï¼ŒæœåŠ¡å™¨å°†æ‰“å°å‡ºä»¥ä¸‹æ—¥å¿—ï¼Œå¹¶å¼€å§‹æ‰§è¡ŒæœåŠ¡å™¨çš„äº‹ä»¶å¾ªç¯ï¼ˆloopï¼‰ 1[7171] 22 Nov 22:43:49.084 * The server is now ready to accept connections on pert 6379 æœåŠ¡å™¨ç°åœ¨å¼€å§‹å¯ä»¥æ¥å—å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ï¼Œå¹¶å¤„ç†å®¢æˆ·ç«¯å‘æ¥çš„å‘½ä»¤è¯·æ±‚äº† æ…¢æ—¥å¿—åŸºæœ¬ä»‹ç»Redis çš„æ…¢æŸ¥è¯¢æ—¥å¿—åŠŸèƒ½ç”¨äºè®°å½•æ‰§è¡Œæ—¶é—´è¶…è¿‡ç»™å®šæ—¶é•¿çš„å‘½ä»¤è¯·æ±‚ï¼Œé€šè¿‡äº§ç”Ÿçš„æ—¥å¿—æ¥ç›‘è§†å’Œä¼˜åŒ–æŸ¥è¯¢é€Ÿåº¦ æœåŠ¡å™¨é…ç½®æœ‰ä¸¤ä¸ªå’Œæ…¢æŸ¥è¯¢æ—¥å¿—ç›¸å…³çš„é€‰é¡¹ï¼š slowlog-log-slower-than é€‰é¡¹æŒ‡å®šæ‰§è¡Œæ—¶é—´è¶…è¿‡å¤šå°‘å¾®ç§’çš„å‘½ä»¤è¯·æ±‚ä¼šè¢«è®°å½•åˆ°æ—¥å¿—ä¸Š slowlog-max-len é€‰é¡¹æŒ‡å®šæœåŠ¡å™¨æœ€å¤šä¿å­˜å¤šå°‘æ¡æ…¢æŸ¥è¯¢æ—¥å¿— æœåŠ¡å™¨ä½¿ç”¨å…ˆè¿›å…ˆå‡º FIFO çš„æ–¹å¼ä¿å­˜å¤šæ¡æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œå½“æœåŠ¡å™¨å­˜å‚¨çš„æ…¢æŸ¥è¯¢æ—¥å¿—æ•°é‡ç­‰äº slowlog-max-len é€‰é¡¹çš„å€¼æ—¶ï¼Œåœ¨æ·»åŠ ä¸€æ¡æ–°çš„æ…¢æŸ¥è¯¢æ—¥å¿—ä¹‹å‰ï¼Œä¼šå…ˆå°†æœ€æ—§çš„ä¸€æ¡æ…¢æŸ¥è¯¢æ—¥å¿—åˆ é™¤ é…ç½®é€‰é¡¹å¯ä»¥é€šè¿‡ CONFIG SET option value å‘½ä»¤è¿›è¡Œè®¾ç½® å¸¸ç”¨å‘½ä»¤ï¼š 123SLOWLOG GET [n] # æŸ¥çœ‹ n æ¡æœåŠ¡å™¨ä¿å­˜çš„æ…¢æ—¥å¿—SLOWLOG LEN # æŸ¥çœ‹æ—¥å¿—æ•°é‡SLOWLOG RESET # æ¸…é™¤æ‰€æœ‰æ…¢æŸ¥è¯¢æ—¥å¿— æ—¥å¿—ä¿å­˜æœåŠ¡å™¨çŠ¶æ€ä¸­åŒ…å«äº†æ…¢æŸ¥è¯¢æ—¥å¿—åŠŸèƒ½æœ‰å…³çš„å±æ€§ï¼š 123456789101112struct redisServer &#123; // ä¸‹ä¸€æ¡æ…¢æŸ¥è¯¢æ—¥å¿—çš„ID long long slowlog_entry_id; // ä¿å­˜äº†æ‰€æœ‰æ…¢æŸ¥è¯¢æ—¥å¿—çš„é“¾è¡¨ list *slowlog; // æœåŠ¡å™¨é…ç½®é€‰é¡¹çš„å€¼ long long slowlog-log-slower-than; // æœåŠ¡å™¨é…ç½®é€‰é¡¹çš„å€¼ unsigned long slowlog_max_len;&#125; slowlog_entry_id å±æ€§çš„åˆå§‹å€¼ä¸º 0ï¼Œæ¯å½“åˆ›å»ºä¸€æ¡æ–°çš„æ…¢æŸ¥è¯¢æ—¥å¿—æ—¶ï¼Œè¿™ä¸ªå±æ€§å°±ä¼šç”¨ä½œæ–°æ—¥å¿—çš„ id å€¼ï¼Œä¹‹åè¯¥å±æ€§å¢ä¸€ slowlog é“¾è¡¨ä¿å­˜äº†æœåŠ¡å™¨ä¸­çš„æ‰€æœ‰æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œé“¾è¡¨ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ª slowlogEntry ç»“æ„ï¼Œ ä»£è¡¨ä¸€æ¡æ…¢æŸ¥è¯¢æ—¥å¿—ï¼š 123456789101112typedef struct slowlogEntry &#123; // å”¯ä¸€æ ‡è¯†ç¬¦ long long id; // å‘½ä»¤æ‰§è¡Œæ—¶çš„æ—¶é—´ï¼Œæ ¼å¼ä¸ºUNIXæ—¶é—´æˆ³ time_t time; // æ‰§è¡Œå‘½ä»¤æ¶ˆè€—çš„æ—¶é—´ï¼Œä»¥å¾®ç§’ä¸ºå•ä½ long long duration; // å‘½ä»¤ä¸å‘½ä»¤å‚æ•° robj **argv; // å‘½ä»¤ä¸å‘½ä»¤å‚æ•°çš„æ•°é‡ int argc;&#125; æ·»åŠ æ—¥å¿—åœ¨æ¯æ¬¡æ‰§è¡Œå‘½ä»¤çš„å‰åï¼Œç¨‹åºéƒ½ä¼šè®°å½•å¾®ç§’æ ¼å¼çš„å½“å‰ UNIX æ—¶é—´æˆ³ï¼Œä¸¤ä¸ªæ—¶é—´ä¹‹å·®å°±æ˜¯æ‰§è¡Œå‘½ä»¤æ‰€è€—è´¹çš„æ—¶é•¿ï¼Œå‡½æ•°ä¼šæ£€æŸ¥å‘½ä»¤çš„æ‰§è¡Œæ—¶é•¿æ˜¯å¦è¶…è¿‡ slowlog-log-slower-than é€‰é¡¹æ‰€è®¾ç½®ï¼š å¦‚æœæ˜¯çš„è¯ï¼Œå°±ä¸ºå‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„æ—¥å¿—ï¼Œå¹¶å°†æ–°æ—¥å¿—æ·»åŠ åˆ° slowlog é“¾è¡¨çš„è¡¨å¤´ æ£€æŸ¥æ…¢æŸ¥è¯¢æ—¥å¿—çš„é•¿åº¦æ˜¯å¦è¶…è¿‡ slowlog-max-len é€‰é¡¹æ‰€è®¾ç½®çš„é•¿åº¦ï¼Œå¦‚æœæ˜¯å°†å¤šå‡ºæ¥çš„æ—¥å¿—ä» slowlog é“¾è¡¨ä¸­åˆ é™¤æ‰ å°† redisServer. slowlog_entry_id çš„å€¼å¢ 1 æ•°æ®ç»“æ„å­—ç¬¦ä¸²SDSRedis æ„å»ºäº†ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰çš„æ•°æ®ç±»å‹ï¼Œä½œä¸º Redis çš„é»˜è®¤å­—ç¬¦ä¸²è¡¨ç¤ºï¼ŒåŒ…å«å­—ç¬¦ä¸²çš„é”®å€¼å¯¹åœ¨åº•å±‚éƒ½æ˜¯ç”± SDS å®ç° 12345678910struct sdshdr &#123; // è®°å½•bufæ•°ç»„ä¸­å·²ä½¿ç”¨å­—èŠ‚çš„æ•°é‡ï¼Œç­‰äº SDS æ‰€ä¿å­˜å­—ç¬¦ä¸²çš„é•¿åº¦ int len; // è®°å½•bufæ•°ç»„ä¸­æœªä½¿ç”¨å­—èŠ‚çš„æ•°é‡ int free; // ã€å­—èŠ‚ã€‘æ•°ç»„ï¼Œç”¨äºä¿å­˜å­—ç¬¦ä¸²ï¼ˆä¸æ˜¯å­—ç¬¦æ•°ç»„ï¼‰ char buf[];&#125;; SDS éµå¾ª C å­—ç¬¦ä¸²ä»¥ç©ºå­—ç¬¦ç»“å°¾çš„æƒ¯ä¾‹ï¼Œä¿å­˜ç©ºå­—ç¬¦çš„ 1 å­—èŠ‚ä¸è®¡ç®—åœ¨ len å±æ€§ï¼ŒSDS ä¼šè‡ªåŠ¨ä¸ºç©ºå­—ç¬¦åˆ†é…é¢å¤–çš„ 1 å­—èŠ‚ç©ºé—´å’Œæ·»åŠ ç©ºå­—ç¬¦åˆ°å­—ç¬¦ä¸²æœ«å°¾ï¼Œæ‰€ä»¥ç©ºå­—ç¬¦å¯¹äº SDS çš„ä½¿ç”¨è€…æ¥è¯´æ˜¯å®Œå…¨é€æ˜çš„ å¯¹æ¯”å¸¸æ•°å¤æ‚åº¦è·å–å­—ç¬¦ä¸²é•¿åº¦ï¼š C å­—ç¬¦ä¸²ä¸è®°å½•è‡ªèº«çš„é•¿åº¦ï¼Œè·å–æ—¶éœ€è¦éå†æ•´ä¸ªå­—ç¬¦ä¸²ï¼Œé‡åˆ°ç©ºå­—ç¬¦ä¸²ä¸ºæ­¢ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(N) SDS è·å–å­—ç¬¦ä¸²é•¿åº¦çš„æ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼Œè®¾ç½®å’Œæ›´æ–° SDS é•¿åº¦ç”±å‡½æ•°åº•å±‚è‡ªåŠ¨å®Œæˆ æœç»ç¼“å†²åŒºæº¢å‡ºï¼š C å­—ç¬¦ä¸²è°ƒç”¨ strcat å‡½æ•°æ‹¼æ¥å­—ç¬¦ä¸²æ—¶ï¼Œå¦‚æœå­—ç¬¦ä¸²å†…å­˜ä¸å¤Ÿå®¹çº³ç›®æ ‡å­—ç¬¦ä¸²ï¼Œå°±ä¼šé€ æˆç¼“å†²åŒºæº¢å‡ºï¼ˆBuffer Overflowï¼‰ s1 å’Œ s2 æ˜¯å†…å­˜ä¸­ç›¸é‚»çš„å­—ç¬¦ä¸²ï¼Œæ‰§è¡Œ strcat(s1, &quot; Cluster&quot;)ï¼ˆæœ‰ç©ºæ ¼ï¼‰ï¼š SDS ç©ºé—´åˆ†é…ç­–ç•¥ï¼šå½“å¯¹ SDS è¿›è¡Œä¿®æ”¹æ—¶ï¼Œé¦–å…ˆæ£€æŸ¥ SDS çš„ç©ºé—´æ˜¯å¦æ»¡è¶³ä¿®æ”¹æ‰€éœ€çš„è¦æ±‚ï¼Œ å¦‚æœä¸æ»¡è¶³ä¼šè‡ªåŠ¨å°† SDS çš„ç©ºé—´æ‰©å±•è‡³æ‰§è¡Œä¿®æ”¹æ‰€éœ€çš„å¤§å°ï¼Œç„¶åæ‰§è¡Œå®é™…çš„ä¿®æ”¹æ“ä½œï¼Œ é¿å…äº†ç¼“å†²åŒºæº¢å‡ºçš„é—®é¢˜ äºŒè¿›åˆ¶å®‰å…¨ï¼š C å­—ç¬¦ä¸²ä¸­çš„å­—ç¬¦å¿…é¡»ç¬¦åˆæŸç§ç¼–ç ï¼ˆæ¯”å¦‚ ASCIIï¼‰æ–¹å¼ï¼Œé™¤äº†å­—ç¬¦ä¸²æœ«å°¾ä»¥å¤–å…¶ä»–ä½ç½®ä¸èƒ½åŒ…å«ç©ºå­—ç¬¦ï¼Œå¦åˆ™ä¼šè¢«è¯¯è®¤ä¸ºæ˜¯å­—ç¬¦ä¸²çš„ç»“å°¾ï¼Œæ‰€ä»¥åªèƒ½ä¿å­˜æ–‡æœ¬æ•°æ® SDS çš„ API éƒ½æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ï¼Œä½¿ç”¨å­—èŠ‚æ•°ç»„ buf ä¿å­˜ä¸€ç³»åˆ—çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œä½¿ç”¨ len å±æ€§æ¥åˆ¤æ–­æ•°æ®çš„ç»“å°¾ï¼Œæ‰€ä»¥å¯ä»¥ä¿å­˜å›¾ç‰‡ã€è§†é¢‘ã€å‹ç¼©æ–‡ä»¶ç­‰äºŒè¿›åˆ¶æ•°æ® å…¼å®¹ C å­—ç¬¦ä¸²çš„å‡½æ•°ï¼šSDS ä¼šåœ¨ä¸º buf æ•°ç»„åˆ†é…ç©ºé—´æ—¶å¤šåˆ†é…ä¸€ä¸ªå­—èŠ‚æ¥ä¿å­˜ç©ºå­—ç¬¦ï¼Œæ‰€ä»¥å¯ä»¥é‡ç”¨ä¸€éƒ¨åˆ† C å­—ç¬¦ä¸²å‡½æ•°åº“çš„å‡½æ•° å†…å­˜C å­—ç¬¦ä¸²æ¯æ¬¡å¢é•¿æˆ–è€…ç¼©çŸ­éƒ½ä¼šè¿›è¡Œä¸€æ¬¡å†…å­˜é‡åˆ†é…ï¼Œæ‹¼æ¥æ“ä½œé€šè¿‡é‡åˆ†é…æ‰©å±•åº•å±‚æ•°ç»„ç©ºé—´ï¼Œæˆªæ–­æ“ä½œé€šè¿‡é‡åˆ†é…é‡Šæ”¾ä¸ä½¿ç”¨çš„å†…å­˜ç©ºé—´ï¼Œé˜²æ­¢å‡ºç°å†…å­˜æ³„éœ² SDS é€šè¿‡æœªä½¿ç”¨ç©ºé—´è§£é™¤äº†å­—ç¬¦ä¸²é•¿åº¦å’Œåº•å±‚æ•°ç»„é•¿åº¦ä¹‹é—´çš„å…³è”ï¼Œåœ¨ SDS ä¸­ buf æ•°ç»„çš„é•¿åº¦ä¸ä¸€å®šå°±æ˜¯å­—ç¬¦æ•°é‡åŠ ä¸€ï¼Œ æ•°ç»„é‡Œé¢å¯ä»¥åŒ…å«æœªä½¿ç”¨çš„å­—èŠ‚ï¼Œå­—èŠ‚çš„æ•°é‡ç”± free å±æ€§è®°å½• å†…å­˜é‡åˆ†é…æ¶‰åŠå¤æ‚çš„ç®—æ³•ï¼Œéœ€è¦æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒè€—æ—¶çš„æ“ä½œï¼ŒSDS çš„ä¸¤ç§ä¼˜åŒ–ç­–ç•¥ï¼š ç©ºé—´é¢„åˆ†é…ï¼šå½“ SDS éœ€è¦è¿›è¡Œç©ºé—´æ‰©å±•æ—¶ï¼Œç¨‹åºä¸ä»…ä¼šä¸º SDS åˆ†é…ä¿®æ”¹æ‰€å¿…éœ€çš„ç©ºé—´ï¼Œ è¿˜ä¼šä¸º SDS åˆ†é…é¢å¤–çš„æœªä½¿ç”¨ç©ºé—´ å¯¹ SDS ä¿®æ”¹ä¹‹åï¼ŒSDS çš„é•¿åº¦ï¼ˆlen å±æ€§ï¼‰å°äº 1MBï¼Œç¨‹åºåˆ†é…å’Œ len å±æ€§åŒæ ·å¤§å°çš„æœªä½¿ç”¨ç©ºé—´ï¼Œæ­¤æ—¶ len å’Œ free ç›¸ç­‰ s ä¸º Redisï¼Œæ‰§è¡Œ sdscat(s, &quot; Cluster&quot;) åï¼Œlen å˜ä¸º 13 å­—èŠ‚ï¼Œæ‰€ä»¥ä¹Ÿåˆ†é…äº† 13 å­—èŠ‚çš„ free ç©ºé—´ï¼Œæ€»é•¿åº¦å˜ä¸º 27 å­—èŠ‚ï¼ˆé¢å¤–çš„ä¸€å­—èŠ‚ä¿å­˜ç©ºå­—ç¬¦ï¼Œ13 + 13 + 1 &#x3D; 27ï¼‰ å¯¹ SDS ä¿®æ”¹ä¹‹åï¼ŒSDS çš„é•¿åº¦å¤§äºç­‰äº 1MBï¼Œç¨‹åºä¼šåˆ†é… 1MB çš„æœªä½¿ç”¨ç©ºé—´ åœ¨æ‰©å±• SDS ç©ºé—´å‰ï¼ŒAPI ä¼šå…ˆæ£€æŸ¥ free ç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼Œå¦‚æœè¶³å¤Ÿå°±æ— éœ€æ‰§è¡Œå†…å­˜é‡åˆ†é…ï¼Œæ‰€ä»¥é€šè¿‡é¢„åˆ†é…ç­–ç•¥ï¼ŒSDS å°†è¿ç»­å¢é•¿ N æ¬¡å­—ç¬¦ä¸²æ‰€éœ€å†…å­˜çš„é‡åˆ†é…æ¬¡æ•°ä»å¿…å®š N æ¬¡é™ä½ä¸ºæœ€å¤š N æ¬¡ æƒ°æ€§ç©ºé—´é‡Šæ”¾ï¼šå½“ SDS ç¼©çŸ­å­—ç¬¦ä¸²æ—¶ï¼Œç¨‹åºå¹¶ä¸ç«‹å³ä½¿ç”¨å†…å­˜é‡åˆ†é…æ¥å›æ”¶ç¼©çŸ­åå¤šå‡ºæ¥çš„å­—èŠ‚ï¼Œè€Œæ˜¯ä½¿ç”¨ free å±æ€§å°†è¿™äº›å­—èŠ‚çš„æ•°é‡è®°å½•èµ·æ¥ï¼Œå¹¶ç­‰å¾…å°†æ¥å¤ç”¨ SDS æä¾›äº†ç›¸åº”çš„ API æ¥çœŸæ­£é‡Šæ”¾ SDS çš„æœªä½¿ç”¨ç©ºé—´ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒç©ºé—´æƒ°æ€§é‡Šæ”¾ç­–ç•¥é€ æˆçš„å†…å­˜æµªè´¹é—®é¢˜ é“¾è¡¨é“¾è¡¨æä¾›äº†é«˜æ•ˆçš„èŠ‚ç‚¹é‡æ’èƒ½åŠ›ï¼ŒC è¯­è¨€å¹¶æ²¡æœ‰å†…ç½®è¿™ç§æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥ Redis æ„å»ºäº†é“¾è¡¨æ•°æ®ç±»å‹ é“¾è¡¨èŠ‚ç‚¹ï¼š 12345678910typedef struct listNode &#123; // å‰ç½®èŠ‚ç‚¹ struct listNode *prev; // åç½®èŠ‚ç‚¹ struct listNode *next; // èŠ‚ç‚¹çš„å€¼ void *value&#125; listNode; å¤šä¸ª listNode é€šè¿‡ prev å’Œ next æŒ‡é’ˆç»„æˆåŒç«¯é“¾è¡¨ï¼š list é“¾è¡¨ç»“æ„ï¼šæä¾›äº†è¡¨å¤´æŒ‡é’ˆ head ã€è¡¨å°¾æŒ‡é’ˆ tail ä»¥åŠé“¾è¡¨é•¿åº¦è®¡æ•°å™¨ len 12345678910111213141516typedef struct list &#123; // è¡¨å¤´èŠ‚ç‚¹ listNode *head; // è¡¨å°¾èŠ‚ç‚¹ listNode *tail; // é“¾è¡¨æ‰€åŒ…å«çš„èŠ‚ç‚¹æ•°é‡ unsigned long len; // èŠ‚ç‚¹å€¼å¤åˆ¶å‡½æ•°ï¼Œç”¨äºå¤åˆ¶é“¾è¡¨èŠ‚ç‚¹æ‰€ä¿å­˜çš„å€¼ void *(*dup) (void *ptr); // èŠ‚ç‚¹å€¼é‡Šæ”¾å‡½æ•°ï¼Œç”¨äºé‡Šæ”¾é“¾è¡¨èŠ‚ç‚¹æ‰€ä¿å­˜çš„å€¼ void (*free) (void *ptr); // èŠ‚ç‚¹å€¼å¯¹æ¯”å‡½æ•°ï¼Œç”¨äºå¯¹æ¯”é“¾è¡¨èŠ‚ç‚¹æ‰€ä¿å­˜çš„å€¼å’Œå¦ä¸€ä¸ªè¾“å…¥å€¼æ˜¯å¦ç›¸ç­‰ int (*match) (void *ptr, void *key);&#125; list; Redis é“¾è¡¨çš„ç‰¹æ€§ï¼š åŒç«¯ï¼šé“¾è¡¨èŠ‚ç‚¹å¸¦æœ‰ prev å’Œ next æŒ‡é’ˆï¼Œè·å–æŸä¸ªèŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹å’Œåç½®èŠ‚ç‚¹çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ O(1) æ— ç¯ï¼šè¡¨å¤´èŠ‚ç‚¹çš„ prev æŒ‡é’ˆå’Œè¡¨å°¾èŠ‚ç‚¹çš„ next æŒ‡é’ˆéƒ½æŒ‡å‘ NULLï¼Œå¯¹é“¾è¡¨çš„è®¿é—®ä»¥ NULL ä¸ºç»ˆç‚¹ å¸¦è¡¨å¤´æŒ‡é’ˆå’Œè¡¨å°¾æŒ‡é’ˆï¼š é€šè¿‡ list ç»“æ„çš„ head æŒ‡é’ˆå’Œ tail æŒ‡é’ˆï¼Œè·å–é“¾è¡¨çš„è¡¨å¤´èŠ‚ç‚¹å’Œè¡¨å°¾èŠ‚ç‚¹çš„æ—¶é—´å¤æ‚åº¦ä¸º O(1) å¸¦é“¾è¡¨é•¿åº¦è®¡æ•°å™¨ï¼šä½¿ç”¨ len å±æ€§æ¥å¯¹ list æŒæœ‰çš„é“¾è¡¨èŠ‚ç‚¹è¿›è¡Œè®¡æ•°ï¼Œè·å–é“¾è¡¨ä¸­èŠ‚ç‚¹æ•°é‡çš„æ—¶é—´å¤æ‚åº¦ä¸º O(1) å¤šæ€ï¼šé“¾è¡¨èŠ‚ç‚¹ä½¿ç”¨ void * æŒ‡é’ˆæ¥ä¿å­˜èŠ‚ç‚¹å€¼ï¼Œ å¹¶ä¸”å¯ä»¥é€šè¿‡ dupã€free ã€match ä¸‰ä¸ªå±æ€§ä¸ºèŠ‚ç‚¹å€¼è®¾ç½®ç±»å‹ç‰¹å®šå‡½æ•°ï¼Œæ‰€ä»¥é“¾è¡¨å¯ä»¥ä¿å­˜å„ç§ä¸åŒç±»å‹çš„å€¼ å­—å…¸å“ˆå¸Œè¡¨Redis å­—å…¸ä½¿ç”¨çš„å“ˆå¸Œè¡¨ç»“æ„ï¼š 12345678910111213typedef struct dictht &#123; // å“ˆå¸Œè¡¨æ•°ç»„ï¼Œæ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ æŒ‡å‘ dictEntry ç»“æ„ dictEntry **table; // å“ˆå¸Œè¡¨å¤§å°ï¼Œæ•°ç»„çš„é•¿åº¦ unsigned long size; // å“ˆå¸Œè¡¨å¤§å°æ©ç ï¼Œç”¨äºè®¡ç®—ç´¢å¼•å€¼ï¼Œæ€»æ˜¯ç­‰äº ã€size-1ã€‘ unsigned long sizemask; // è¯¥å“ˆå¸Œè¡¨å·²æœ‰èŠ‚ç‚¹çš„æ•°é‡ unsigned long used;&#125; dictht; å“ˆå¸Œè¡¨èŠ‚ç‚¹ç»“æ„ï¼š 1234567891011121314typedef struct dictEntry &#123; // é”® void *key; // å€¼ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œæˆ–è€…æ•´æ•° union &#123; void *val; // æŒ‡é’ˆ uint64_t u64; int64_t s64; &#125; // æŒ‡å‘ä¸‹ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹ï¼Œå½¢æˆé“¾è¡¨ï¼Œç”¨æ¥è§£å†³å†²çªé—®é¢˜ struct dictEntry *next;&#125; dictEntry; å­—å…¸ç»“æ„å­—å…¸ï¼Œåˆç§°ä¸ºç¬¦å·è¡¨ã€å…³è”æ•°ç»„ã€æ˜ å°„ï¼ˆMapï¼‰ï¼Œç”¨äºä¿å­˜é”®å€¼å¯¹çš„æ•°æ®ç»“æ„ï¼Œå­—å…¸ä¸­çš„æ¯ä¸ªé”®éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„ã€‚åº•å±‚é‡‡ç”¨å“ˆå¸Œè¡¨å®ç°ï¼Œä¸€ä¸ªå“ˆå¸Œè¡¨åŒ…å«å¤šä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¿å­˜ä¸€ä¸ªé”®å€¼å¯¹ 1234567891011121314typedef struct dict &#123; // ç±»å‹ç‰¹å®šå‡½æ•° dictType *type; // ç§æœ‰æ•°æ® void *privdata; // å“ˆå¸Œè¡¨ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªé¡¹éƒ½æ˜¯ä¸€ä¸ªdicthtå“ˆå¸Œè¡¨ï¼Œ // ä¸€èˆ¬æƒ…å†µä¸‹å­—å…¸åªä½¿ç”¨ ht[0] å“ˆå¸Œè¡¨ï¼Œ ht[1] å“ˆå¸Œè¡¨åªä¼šåœ¨å¯¹ ht[0] å“ˆå¸Œè¡¨è¿›è¡Œ rehash æ—¶ä½¿ç”¨ dictht ht[2]; // rehash ç´¢å¼•ï¼Œå½“ rehash ä¸åœ¨è¿›è¡Œæ—¶ï¼Œå€¼ä¸º -1 int rehashidx;&#125; dict; type å±æ€§å’Œ privdata å±æ€§æ˜¯é’ˆå¯¹ä¸åŒç±»å‹çš„é”®å€¼å¯¹ï¼Œ ä¸ºåˆ›å»ºå¤šæ€å­—å…¸è€Œè®¾ç½®çš„ï¼š type å±æ€§æ˜¯æŒ‡å‘ dictType ç»“æ„çš„æŒ‡é’ˆï¼Œ æ¯ä¸ª dictType ç»“æ„ä¿å­˜äº†ä¸€ç°‡ç”¨äºæ“ä½œç‰¹å®šç±»å‹é”®å€¼å¯¹çš„å‡½æ•°ï¼Œ Redis ä¼šä¸ºç”¨é€”ä¸åŒçš„å­—å…¸è®¾ç½®ä¸åŒçš„ç±»å‹ç‰¹å®šå‡½æ•° privdata å±æ€§ä¿å­˜äº†éœ€è¦ä¼ ç»™é‚£äº›ç±»å‹ç‰¹å®šå‡½æ•°çš„å¯é€‰å‚æ•° å“ˆå¸Œå†²çªRedis ä½¿ç”¨ MurmurHash ç®—æ³•æ¥è®¡ç®—é”®çš„å“ˆå¸Œå€¼ï¼Œè¿™ç§ç®—æ³•çš„ä¼˜ç‚¹åœ¨äºï¼Œå³ä½¿è¾“å…¥çš„é”®æ˜¯æœ‰è§„å¾‹çš„ï¼Œç®—æ³•ä»èƒ½ç»™å‡ºä¸€ä¸ªå¾ˆå¥½çš„éšæœºåˆ†å¸ƒæ€§ï¼Œå¹¶ä¸”ç®—æ³•çš„è®¡ç®—é€Ÿåº¦ä¹Ÿéå¸¸å¿« å°†ä¸€ä¸ªæ–°çš„é”®å€¼å¯¹æ·»åŠ åˆ°å­—å…¸é‡Œï¼Œéœ€è¦å…ˆæ ¹æ®é”® key è®¡ç®—å‡ºå“ˆå¸Œå€¼ï¼Œç„¶åè¿›è¡Œå–æ¨¡è¿ç®—ï¼ˆå–ä½™ï¼‰ï¼š 1index = hash &amp; dict-&gt;ht[x].sizemask å½“æœ‰ä¸¤ä¸ªæˆ–ä»¥ä¸Šæ•°é‡çš„é”®è¢«åˆ†é…åˆ°äº†å“ˆå¸Œè¡¨æ•°ç»„çš„åŒä¸€ä¸ªç´¢å¼•ä¸Šæ—¶ï¼Œå°±ç§°è¿™äº›é”®å‘ç”Ÿäº†å“ˆå¸Œå†²çªï¼ˆcollisionï¼‰ Redis çš„å“ˆå¸Œè¡¨ä½¿ç”¨é“¾åœ°å€æ³•ï¼ˆseparate chainingï¼‰æ¥è§£å†³é”®å“ˆå¸Œå†²çªï¼Œ æ¯ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ª next æŒ‡é’ˆï¼Œå¤šä¸ªèŠ‚ç‚¹é€šè¿‡ next æŒ‡é’ˆæ„æˆä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œè¢«åˆ†é…åˆ°åŒä¸€ä¸ªç´¢å¼•ä¸Šçš„å¤šä¸ªèŠ‚ç‚¹å¯ä»¥ç”¨è¿™ä¸ªå•å‘é“¾è¡¨è¿æ¥èµ·æ¥ï¼Œè¿™å°±è§£å†³äº†é”®å†²çªçš„é—®é¢˜ dictEntry èŠ‚ç‚¹ç»„æˆçš„é“¾è¡¨æ²¡æœ‰æŒ‡å‘é“¾è¡¨è¡¨å°¾çš„æŒ‡é’ˆï¼Œä¸ºäº†é€Ÿåº¦è€ƒè™‘ï¼Œç¨‹åºæ€»æ˜¯å°†æ–°èŠ‚ç‚¹æ·»åŠ åˆ°é“¾è¡¨çš„è¡¨å¤´ä½ç½®ï¼ˆå¤´æ’æ³•ï¼‰ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1) è´Ÿè½½å› å­è´Ÿè½½å› å­çš„è®¡ç®—æ–¹å¼ï¼šå“ˆå¸Œè¡¨ä¸­çš„èŠ‚ç‚¹æ•°é‡ &#x2F; å“ˆå¸Œè¡¨çš„å¤§å°ï¼ˆé•¿åº¦ï¼‰ 1load_factor = ht[0].used / ht[0].size ä¸ºäº†è®©å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­ï¼ˆload factorï¼‰ç»´æŒåœ¨ä¸€ä¸ªåˆç†çš„èŒƒå›´ä¹‹å†…ï¼Œå½“å“ˆå¸Œè¡¨ä¿å­˜çš„é”®å€¼å¯¹æ•°é‡å¤ªå¤šæˆ–è€…å¤ªå°‘æ—¶ ï¼Œç¨‹åºä¼šè‡ªåŠ¨å¯¹å“ˆå¸Œè¡¨çš„å¤§å°è¿›è¡Œç›¸åº”çš„æ‰©å±•æˆ–è€…æ”¶ç¼© å“ˆå¸Œè¡¨æ‰§è¡Œæ‰©å®¹çš„æ¡ä»¶ï¼š æœåŠ¡å™¨æ²¡æœ‰æ‰§è¡Œ BGSAVE æˆ–è€… BGREWRITEAOF å‘½ä»¤ï¼Œå“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­å¤§äºç­‰äº 1 æœåŠ¡å™¨æ­£åœ¨æ‰§è¡Œ BGSAVE æˆ–è€… BGREWRITEAOF å‘½ä»¤ï¼Œå“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­å¤§äºç­‰äº 5 åŸå› ï¼šæ‰§è¡Œè¯¥å‘½ä»¤çš„è¿‡ç¨‹ä¸­ï¼ŒRedis éœ€è¦åˆ›å»ºå½“å‰æœåŠ¡å™¨è¿›ç¨‹çš„å­è¿›ç¨‹ï¼Œè€Œå¤§å¤šæ•°æ“ä½œç³»ç»Ÿéƒ½é‡‡ç”¨å†™æ—¶å¤åˆ¶ï¼ˆcopy-onÂ­-writeï¼‰æŠ€æœ¯æ¥ä¼˜åŒ–å­è¿›ç¨‹çš„ä½¿ç”¨æ•ˆç‡ï¼Œé€šè¿‡æé«˜æ‰§è¡Œæ‰©å±•æ“ä½œçš„è´Ÿè½½å› å­ï¼Œå°½å¯èƒ½åœ°é¿å…åœ¨å­è¿›ç¨‹å­˜åœ¨æœŸé—´è¿›è¡Œå“ˆå¸Œè¡¨æ‰©å±•æ“ä½œï¼Œå¯ä»¥é¿å…ä¸å¿…è¦çš„å†…å­˜å†™å…¥æ“ä½œï¼Œæœ€å¤§é™åº¦åœ°èŠ‚çº¦å†…å­˜ å“ˆå¸Œè¡¨æ‰§è¡Œæ”¶ç¼©çš„æ¡ä»¶ï¼šè´Ÿè½½å› å­å°äº 0.1ï¼ˆè‡ªåŠ¨æ‰§è¡Œï¼ŒservreCron ä¸­æ£€æµ‹ï¼‰ é‡æ–°æ•£åˆ—æ‰©å±•å’Œæ”¶ç¼©å“ˆå¸Œè¡¨çš„æ“ä½œé€šè¿‡ rehashï¼ˆé‡æ–°æ•£åˆ—ï¼‰æ¥å®Œæˆï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š ä¸ºå­—å…¸çš„ ht[1] å“ˆå¸Œè¡¨åˆ†é…ç©ºé—´ï¼Œç©ºé—´å¤§å°çš„åˆ†é…æƒ…å†µï¼š å¦‚æœæ‰§è¡Œçš„æ˜¯æ‰©å±•æ“ä½œï¼Œht[1] çš„å¤§å°ä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äº $ht[0].used * 2$ çš„ $2^n$ å¦‚æœæ‰§è¡Œçš„æ˜¯æ”¶ç¼©æ“ä½œï¼Œht[1] çš„å¤§å°ä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äº $ht[0].used$ çš„ $2^n$ å°†ä¿å­˜åœ¨ ht[0] ä¸­æ‰€æœ‰çš„é”®å€¼å¯¹é‡æ–°è®¡ç®—å“ˆå¸Œå€¼å’Œç´¢å¼•å€¼ï¼Œè¿ç§»åˆ° ht[1] ä¸Š å½“ ht[0] åŒ…å«çš„æ‰€æœ‰é”®å€¼å¯¹éƒ½è¿ç§»åˆ°äº† ht[1] ä¹‹åï¼ˆht[0] å˜ä¸ºç©ºè¡¨ï¼‰ï¼Œé‡Šæ”¾ ht[0]ï¼Œå°† ht[1] è®¾ç½®ä¸º ht[0]ï¼Œå¹¶åœ¨ ht[1] åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºç™½å“ˆå¸Œè¡¨ï¼Œä¸ºä¸‹ä¸€æ¬¡ rehash åšå‡†å¤‡ å¦‚æœå“ˆå¸Œè¡¨é‡Œä¿å­˜çš„é”®å€¼å¯¹æ•°é‡å¾ˆå°‘ï¼Œrehash å°±å¯ä»¥åœ¨ç¬é—´å®Œæˆï¼Œä½†æ˜¯å¦‚æœå“ˆå¸Œè¡¨é‡Œæ•°æ®å¾ˆå¤šï¼Œé‚£ä¹ˆè¦ä¸€æ¬¡æ€§å°†è¿™äº›é”®å€¼å¯¹å…¨éƒ¨ rehash åˆ° ht[1] éœ€è¦å¤§é‡è®¡ç®—ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœåŠ¡å™¨åœ¨ä¸€æ®µæ—¶é—´å†…åœæ­¢æœåŠ¡ Redis å¯¹ rehash åšäº†ä¼˜åŒ–ï¼Œä½¿ rehash çš„åŠ¨ä½œå¹¶ä¸æ˜¯ä¸€æ¬¡æ€§ã€é›†ä¸­å¼çš„å®Œæˆï¼Œè€Œæ˜¯åˆ†å¤šæ¬¡ï¼Œæ¸è¿›å¼çš„å®Œæˆï¼Œåˆå«æ¸è¿›å¼ rehash ä¸º ht[1] åˆ†é…ç©ºé—´ï¼Œæ­¤æ—¶å­—å…¸åŒæ—¶æŒæœ‰ ht[0] å’Œ ht[1] ä¸¤ä¸ªå“ˆå¸Œè¡¨ åœ¨å­—å…¸ä¸­ç»´æŠ¤äº†ä¸€ä¸ªç´¢å¼•è®¡æ•°å™¨å˜é‡ rehashidxï¼Œå¹¶å°†å˜é‡çš„å€¼è®¾ä¸º 0ï¼Œè¡¨ç¤º rehash æ­£å¼å¼€å§‹ åœ¨ rehash è¿›è¡ŒæœŸé—´ï¼Œæ¯æ¬¡å¯¹å­—å…¸æ‰§è¡Œå¢åˆ æ”¹æŸ¥æ“ä½œæ—¶ï¼Œç¨‹åºé™¤äº†æ‰§è¡ŒæŒ‡å®šçš„æ“ä½œä»¥å¤–ï¼Œè¿˜ä¼šé¡ºå¸¦å°† ht[0] å“ˆå¸Œè¡¨åœ¨ rehashidx ç´¢å¼•ä¸Šçš„æ‰€æœ‰é”®å€¼å¯¹ rehash åˆ° ht[1]ï¼Œrehash å®Œæˆä¹‹åå°† rehashidx å±æ€§çš„å€¼å¢ä¸€ éšç€å­—å…¸æ“ä½œçš„ä¸æ–­æ‰§è¡Œï¼Œæœ€ç»ˆåœ¨æŸä¸ªæ—¶é—´ç‚¹ ht[0] çš„æ‰€æœ‰é”®å€¼å¯¹éƒ½è¢« rehash è‡³ ht[1]ï¼Œå°† rehashidx å±æ€§çš„å€¼è®¾ä¸º -1 æ¸è¿›å¼ rehash é‡‡ç”¨åˆ†è€Œæ²»ä¹‹çš„æ–¹å¼ï¼Œå°† rehash é”®å€¼å¯¹æ‰€éœ€çš„è®¡ç®—å·¥ä½œå‡æ‘Šåˆ°å¯¹å­—å…¸çš„æ¯ä¸ªæ·»åŠ ã€åˆ é™¤ã€æŸ¥æ‰¾å’Œæ›´æ–°æ“ä½œä¸Šï¼Œä»è€Œé¿å…äº†é›†ä¸­å¼ rehash å¸¦æ¥çš„åºå¤§è®¡ç®—é‡ æ¸è¿›å¼ rehash æœŸé—´çš„å“ˆå¸Œè¡¨æ“ä½œï¼š å­—å…¸çš„æŸ¥æ‰¾ã€åˆ é™¤ã€æ›´æ–°æ“ä½œä¼šåœ¨ä¸¤ä¸ªå“ˆå¸Œè¡¨ä¸Šè¿›è¡Œï¼Œæ¯”å¦‚æŸ¥æ‰¾ä¸€ä¸ªé”®ä¼šå…ˆåœ¨ ht[0] ä¸ŠæŸ¥æ‰¾ï¼ŒæŸ¥æ‰¾ä¸åˆ°å°±å» ht[1] ç»§ç»­æŸ¥æ‰¾ å­—å…¸çš„æ·»åŠ æ“ä½œä¼šç›´æ¥åœ¨ ht[1] ä¸Šæ·»åŠ ï¼Œä¸åœ¨ ht[0] ä¸Šè¿›è¡Œä»»ä½•æ·»åŠ  è·³è·ƒè¡¨åº•å±‚ç»“æ„è·³è·ƒè¡¨ï¼ˆskiplistï¼‰æ˜¯ä¸€ç§æœ‰åºï¼ˆé»˜è®¤å‡åºï¼‰çš„æ•°æ®ç»“æ„ï¼Œåœ¨é“¾è¡¨çš„åŸºç¡€ä¸Šå¢åŠ äº†å¤šçº§ç´¢å¼•ä»¥æå‡æŸ¥æ‰¾çš„æ•ˆç‡ï¼Œç´¢å¼•æ˜¯å å†…å­˜çš„ï¼Œæ‰€ä»¥æ˜¯ä¸€ä¸ªç©ºé—´æ¢æ—¶é—´çš„æ–¹æ¡ˆï¼Œè·³è¡¨å¹³å‡ O(logN)ã€æœ€å O(N) å¤æ‚åº¦çš„èŠ‚ç‚¹æŸ¥æ‰¾ï¼Œæ•ˆç‡ä¸å¹³è¡¡æ ‘ç›¸å½“ä½†æ˜¯å®ç°æ›´ç®€å• åŸå§‹é“¾è¡¨ä¸­å­˜å‚¨çš„æœ‰å¯èƒ½æ˜¯å¾ˆå¤§çš„å¯¹è±¡ï¼Œè€Œç´¢å¼•ç»“ç‚¹åªéœ€è¦å­˜å‚¨å…³é”®å€¼å’Œå‡ ä¸ªæŒ‡é’ˆï¼Œå¹¶ä¸éœ€è¦å­˜å‚¨å¯¹è±¡ï¼Œå› æ­¤å½“èŠ‚ç‚¹æœ¬èº«æ¯”è¾ƒå¤§æˆ–è€…å…ƒç´ æ•°é‡æ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œå…¶ä¼˜åŠ¿å¯ä»¥è¢«æ”¾å¤§ï¼Œè€Œç¼ºç‚¹ï¼ˆå å†…å­˜ï¼‰åˆ™å¯ä»¥å¿½ç•¥ Redis åªåœ¨ä¸¤ä¸ªåœ°æ–¹åº”ç”¨äº†è·³è·ƒè¡¨ï¼Œä¸€ä¸ªæ˜¯å®ç°æœ‰åºé›†åˆé”®ï¼Œå¦ä¸€ä¸ªæ˜¯åœ¨é›†ç¾¤èŠ‚ç‚¹ä¸­ç”¨ä½œå†…éƒ¨æ•°æ®ç»“æ„ 12345678910typedef struct zskiplist &#123; // è¡¨å¤´èŠ‚ç‚¹å’Œè¡¨å°¾èŠ‚ç‚¹ï¼ŒO(1) çš„æ—¶é—´å¤æ‚åº¦å®šä½å¤´å°¾èŠ‚ç‚¹ struct skiplistNode *head, *tail; // è¡¨çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯è¡¨å†…çš„èŠ‚ç‚¹æ•°é‡ (è¡¨å¤´èŠ‚ç‚¹ä¸è®¡ç®—åœ¨å†…) unsigned long length; // è¡¨ä¸­å±‚æ•°æœ€å¤§çš„èŠ‚ç‚¹çš„å±‚æ•° (è¡¨å¤´èŠ‚ç‚¹çš„å±‚é«˜ä¸è®¡ç®—åœ¨å†…) int level&#125; zskiplist; 123456789101112131415161718typedef struct zskiplistNode &#123; // å±‚ struct zskiplistLevel &#123; // å‰è¿›æŒ‡é’ˆ struct zskiplistNode *forward; // è·¨åº¦ unsigned int span; &#125; level[]; // åé€€æŒ‡é’ˆ struct zskiplistNode *backward; // åˆ†å€¼ double score; // æˆå‘˜å¯¹è±¡ robj *obj;&#125; zskiplistNode; å±æ€§åˆ†æå±‚ï¼šlevel æ•°ç»„åŒ…å«å¤šä¸ªå…ƒç´ ï¼Œæ¯ä¸ªå…ƒç´ åŒ…å«æŒ‡å‘å…¶ä»–èŠ‚ç‚¹çš„æŒ‡é’ˆã€‚æ ¹æ®å¹•æ¬¡å®šå¾‹ï¼ˆpower lawï¼Œè¶Šå¤§çš„æ•°å‡ºç°çš„æ¦‚ç‡è¶Šå°ï¼‰éšæœºç”Ÿæˆä¸€ä¸ªä»‹äº 1 å’Œ 32 ä¹‹é—´çš„å€¼ï¼ˆRedis5 ä¹‹åæœ€å¤§ä¸º 64ï¼‰ä½œä¸º level æ•°ç»„çš„å¤§å°ï¼Œè¿™ä¸ªå¤§å°å°±æ˜¯å±‚çš„é«˜åº¦ï¼ŒèŠ‚ç‚¹çš„ç¬¬ä¸€å±‚æ˜¯ level[0] &#x3D; L1 å‰è¿›æŒ‡é’ˆï¼šforward ç”¨äºä»è¡¨å¤´åˆ°è¡¨å°¾æ–¹å‘æ­£åºï¼ˆå‡åºï¼‰éå†èŠ‚ç‚¹ï¼Œé‡åˆ° NULL åœæ­¢éå† è·¨åº¦ï¼šspan ç”¨äºè®°å½•ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„è·ç¦»ï¼Œç”¨æ¥è®¡ç®—æ’ä½ï¼ˆrankï¼‰ï¼š ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„è·¨åº¦è¶Šå¤§ç›¸è·çš„å°±è¶Šè¿œï¼ŒæŒ‡å‘ NULL çš„æ‰€æœ‰å‰è¿›æŒ‡é’ˆçš„è·¨åº¦éƒ½ä¸º 0 åœ¨æŸ¥æ‰¾æŸä¸ªèŠ‚ç‚¹çš„è¿‡ç¨‹ä¸­ï¼Œå°†æ²¿é€”è®¿é—®è¿‡çš„æ‰€æœ‰å±‚çš„è·¨åº¦ç´¯è®¡èµ·æ¥ï¼Œç»“æœå°±æ˜¯ç›®æ ‡èŠ‚ç‚¹åœ¨è·³è·ƒè¡¨ä¸­çš„æ’ä½ï¼ŒæŒ‰ç…§ä¸Šå›¾æ‰€ç¤ºï¼š æŸ¥æ‰¾åˆ†å€¼ä¸º 3.0 çš„èŠ‚ç‚¹ï¼Œæ²¿é€”ç»å†çš„å±‚ï¼šæŸ¥æ‰¾çš„è¿‡ç¨‹åªç»è¿‡äº†ä¸€ä¸ªå±‚ï¼Œå¹¶ä¸”å±‚çš„è·¨åº¦ä¸º 3ï¼Œæ‰€ä»¥ç›®æ ‡èŠ‚ç‚¹åœ¨è·³è·ƒè¡¨ä¸­çš„æ’ä½ä¸º 3 æŸ¥æ‰¾åˆ†å€¼ä¸º 2.0 çš„èŠ‚ç‚¹ï¼Œæ²¿é€”ç»å†çš„å±‚ï¼šç»è¿‡äº†ä¸¤ä¸ªè·¨åº¦ä¸º 1 çš„èŠ‚ç‚¹ï¼Œå› æ­¤å¯ä»¥è®¡ç®—å‡ºç›®æ ‡èŠ‚ç‚¹åœ¨è·³è·ƒè¡¨ä¸­çš„æ’ä½ä¸º 2 åé€€æŒ‡é’ˆï¼šbackward ç”¨äºä»è¡¨å°¾åˆ°è¡¨å¤´æ–¹å‘é€†åºï¼ˆé™åºï¼‰éå†èŠ‚ç‚¹ åˆ†å€¼ï¼šscore å±æ€§ä¸€ä¸ª double ç±»å‹çš„æµ®ç‚¹æ•°ï¼Œè·³è·ƒè¡¨ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½æŒ‰åˆ†å€¼ä»å°åˆ°å¤§æ¥æ’åº æˆå‘˜å¯¹è±¡ï¼šobj å±æ€§æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ª SDS å­—ç¬¦ä¸²å¯¹è±¡ã€‚åŒä¸€ä¸ªè·³è·ƒè¡¨ä¸­ï¼Œå„ä¸ªèŠ‚ç‚¹ä¿å­˜çš„æˆå‘˜å¯¹è±¡å¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œä½†æ˜¯å¤šä¸ªèŠ‚ç‚¹ä¿å­˜çš„åˆ†å€¼å¯ä»¥æ˜¯ç›¸åŒçš„ï¼Œåˆ†å€¼ç›¸åŒçš„èŠ‚ç‚¹å°†æŒ‰ç…§æˆå‘˜å¯¹è±¡åœ¨å­—å…¸åºä¸­çš„å¤§å°æ¥è¿›è¡Œæ’åºï¼ˆä»å°åˆ°å¤§ï¼‰ ä¸ªäººç¬”è®°ï¼šJUC â†’ å¹¶å‘åŒ… â†’ ConcurrentSkipListMap è¯¦è§£è·³è·ƒè¡¨ æ•´æ•°é›†åˆåº•å±‚ç»“æ„æ•´æ•°é›†åˆï¼ˆintsetï¼‰æ˜¯ç”¨äºä¿å­˜æ•´æ•°å€¼çš„é›†åˆæ•°æ®ç»“æ„ï¼Œæ˜¯ Redis é›†åˆé”®çš„åº•å±‚å®ç°ä¹‹ä¸€ 12345678910typedef struct intset &#123; // ç¼–ç æ–¹å¼ uint32_t encoding; // é›†åˆåŒ…å«çš„å…ƒç´ æ•°é‡ï¼Œä¹Ÿå°±æ˜¯ contents æ•°ç»„çš„é•¿åº¦ uint32_t length; // ä¿å­˜å…ƒç´ çš„æ•°ç»„ int8_t contents[];&#125; intset; encoding å–å€¼ä¸ºä¸‰ç§ï¼šINTSET_ENC_INT16ã€INTSET_ENC_INT32ã€INTSET_ENC_INT64 æ•´æ•°é›†åˆçš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ contents æ•°ç»„çš„ä¸€ä¸ªæ•°ç»„é¡¹ï¼ˆitemï¼‰ï¼Œåœ¨æ•°ç»„ä¸­æŒ‰å€¼çš„å¤§å°ä»å°åˆ°å¤§æœ‰åºæ’åˆ—ï¼Œå¹¶ä¸”æ•°ç»„ä¸­ä¸åŒ…å«ä»»ä½•é‡å¤é¡¹ã€‚è™½ç„¶ contents å±æ€§å£°æ˜ä¸º int8_t ç±»å‹ï¼Œä½†å®é™…ä¸Šæ•°ç»„å¹¶ä¸ä¿å­˜ä»»ä½• int8_t ç±»å‹çš„å€¼ï¼Œ çœŸæ­£ç±»å‹å–å†³äº encoding å±æ€§ è¯´æ˜ï¼šåº•å±‚å­˜å‚¨ç»“æ„æ˜¯æ•°ç»„ï¼Œæ‰€ä»¥ä¸ºäº†ä¿è¯æœ‰åºæ€§å’Œä¸é‡å¤æ€§ï¼Œæ¯æ¬¡æ·»åŠ ä¸€ä¸ªå…ƒç´ çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(N) ç±»å‹å‡çº§æ•´æ•°é›†åˆæ·»åŠ çš„æ–°å…ƒç´ çš„ç±»å‹æ¯”é›†åˆç°æœ‰æ‰€æœ‰å…ƒç´ çš„ç±»å‹éƒ½è¦é•¿æ—¶ï¼Œéœ€è¦å…ˆè¿›è¡Œå‡çº§ï¼ˆupgradeï¼‰ï¼Œå‡çº§æµç¨‹ï¼š æ ¹æ®æ–°å…ƒç´ çš„ç±»å‹é•¿åº¦ä»¥åŠé›†åˆå…ƒç´ çš„æ•°é‡ï¼ˆåŒ…æ‹¬æ–°å…ƒç´ åœ¨å†…ï¼‰ï¼Œæ‰©å±•æ•´æ•°é›†åˆåº•å±‚æ•°ç»„çš„ç©ºé—´å¤§å° å°†åº•å±‚æ•°ç»„ç°æœ‰çš„æ‰€æœ‰å…ƒç´ éƒ½è½¬æ¢æˆä¸æ–°å…ƒç´ ç›¸åŒçš„ç±»å‹ï¼Œå¹¶å°†è½¬æ¢åçš„å…ƒç´ æ”¾å…¥æ­£ç¡®çš„ä½ç½®ï¼Œæ”¾ç½®è¿‡ç¨‹ä¿è¯æ•°ç»„çš„æœ‰åºæ€§ å›¾ç¤º 32 * 4 &#x3D; 128 ä½ï¼Œé¦–å…ˆå°† 3 æ”¾å…¥ç´¢å¼• 2ï¼ˆ64 ä½ - 95 ä½ï¼‰ï¼Œç„¶åå°† 2 æ”¾ç½®ç´¢å¼• 1ï¼Œå°† 1 æ”¾ç½®åœ¨ç´¢å¼• 0ï¼Œä»åå‘å‰ä¾æ¬¡æ”¾ç½®åœ¨å¯¹åº”çš„åŒºé—´ï¼Œæœ€åæ”¾ç½® 65535 å…ƒç´ åˆ°ç´¢å¼• 3ï¼ˆ96 ä½- 127 ä½ï¼‰ï¼Œä¿®æ”¹ length å±æ€§ä¸º 4 å°†æ–°å…ƒç´ æ·»åŠ åˆ°åº•å±‚æ•°ç»„é‡Œ æ¯æ¬¡å‘æ•´æ•°é›†åˆæ·»åŠ æ–°å…ƒç´ éƒ½å¯èƒ½ä¼šå¼•èµ·å‡çº§ï¼Œè€Œæ¯æ¬¡å‡çº§éƒ½éœ€è¦å¯¹åº•å±‚æ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ è¿›è¡Œç±»å‹è½¬æ¢ï¼Œæ‰€ä»¥å‘æ•´æ•°é›†åˆæ·»åŠ æ–°å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦ä¸º O(N) å¼•å‘å‡çº§çš„æ–°å…ƒç´ çš„é•¿åº¦æ€»æ˜¯æ¯”æ•´æ•°é›†åˆç°æœ‰æ‰€æœ‰å…ƒç´ çš„é•¿åº¦éƒ½å¤§ï¼Œæ‰€ä»¥è¿™ä¸ªæ–°å…ƒç´ çš„å€¼è¦ä¹ˆå°±å¤§äºæ‰€æœ‰ç°æœ‰å…ƒç´ ï¼Œè¦ä¹ˆå°±å°äºæ‰€æœ‰ç°æœ‰å…ƒç´ ï¼Œå‡çº§ä¹‹åæ–°å…ƒç´ çš„æ‘†æ”¾ä½ç½®ï¼š åœ¨æ–°å…ƒç´ å°äºæ‰€æœ‰ç°æœ‰å…ƒç´ çš„æƒ…å†µä¸‹ï¼Œæ–°å…ƒç´ ä¼šè¢«æ”¾ç½®åœ¨åº•å±‚æ•°ç»„çš„æœ€å¼€å¤´ï¼ˆç´¢å¼• 0ï¼‰ åœ¨æ–°å…ƒç´ å¤§äºæ‰€æœ‰ç°æœ‰å…ƒç´ çš„æƒ…å†µä¸‹ï¼Œæ–°å…ƒç´ ä¼šè¢«æ”¾ç½®åœ¨åº•å±‚æ•°ç»„çš„æœ€æœ«å°¾ï¼ˆç´¢å¼• length-1ï¼‰ æ•´æ•°é›†åˆå‡çº§ç­–ç•¥çš„ä¼˜ç‚¹ï¼š æå‡æ•´æ•°é›†åˆçš„çµæ´»æ€§ï¼šC è¯­è¨€æ˜¯é™æ€ç±»å‹è¯­è¨€ï¼Œä¸ºäº†é¿å…ç±»å‹é”™è¯¯é€šå¸¸ä¸ä¼šå°†ä¸¤ç§ä¸åŒç±»å‹çš„å€¼æ”¾åœ¨åŒä¸€ä¸ªæ•°æ®ç»“æ„é‡Œé¢ï¼Œæ•´æ•°é›†åˆå¯ä»¥è‡ªåŠ¨å‡çº§åº•å±‚æ•°ç»„æ¥é€‚åº”æ–°å…ƒç´ ï¼Œæ‰€ä»¥å¯ä»¥éšæ„çš„æ·»åŠ æ•´æ•° èŠ‚çº¦å†…å­˜ï¼šè¦è®©æ•°ç»„å¯ä»¥åŒæ—¶ä¿å­˜ int16ã€int32ã€int64 ä¸‰ç§ç±»å‹çš„å€¼ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ int64_t ç±»å‹çš„æ•°ç»„ä½œä¸ºæ•´æ•°é›†åˆçš„åº•å±‚å®ç°ï¼Œä½†æ˜¯ä¼šé€ æˆå†…å­˜æµªè´¹ï¼Œæ•´æ•°é›†åˆå¯ä»¥ç¡®ä¿å‡çº§æ“ä½œåªä¼šåœ¨æœ‰éœ€è¦çš„æ—¶å€™è¿›è¡Œï¼Œå°½é‡èŠ‚çœå†…å­˜ æ•´æ•°é›†åˆä¸æ”¯æŒé™çº§æ“ä½œï¼Œä¸€æ—¦å¯¹æ•°ç»„è¿›è¡Œäº†å‡çº§ï¼Œç¼–ç å°±ä¼šä¸€ç›´ä¿æŒå‡çº§åçš„çŠ¶æ€ å‹ç¼©åˆ—è¡¨åº•å±‚ç»“æ„å‹ç¼©åˆ—è¡¨ï¼ˆziplistï¼‰æ˜¯ Redis ä¸ºäº†èŠ‚çº¦å†…å­˜è€Œå¼€å‘çš„ï¼Œæ˜¯åˆ—è¡¨é”®å’Œå“ˆå¸Œé”®çš„åº•å±‚å®ç°ä¹‹ä¸€ã€‚æ˜¯ç”±ä¸€ç³»åˆ—ç‰¹æ®Šç¼–ç çš„è¿ç»­å†…å­˜å—ç»„æˆçš„é¡ºåºå‹ï¼ˆsequentialï¼‰æ•°æ®ç»“æ„ï¼Œä¸€ä¸ªå‹ç¼©åˆ—è¡¨å¯ä»¥åŒ…å«ä»»æ„å¤šä¸ªèŠ‚ç‚¹ï¼ˆentryï¼‰ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯ä»¥ä¿å­˜ä¸€ä¸ªå­—èŠ‚æ•°ç»„æˆ–è€…ä¸€ä¸ªæ•´æ•°å€¼ zlbytesï¼šuint32_t ç±»å‹ 4 å­—èŠ‚ï¼Œè®°å½•æ•´ä¸ªå‹ç¼©åˆ—è¡¨å ç”¨çš„å†…å­˜å­—èŠ‚æ•°ï¼Œåœ¨å¯¹å‹ç¼©åˆ—è¡¨è¿›è¡Œå†…å­˜é‡åˆ†é…æˆ–è€…è®¡ç®— zlend çš„ä½ç½®æ—¶ä½¿ç”¨ zltailï¼šuint32_t ç±»å‹ 4 å­—èŠ‚ï¼Œè®°å½•å‹ç¼©åˆ—è¡¨è¡¨å°¾èŠ‚ç‚¹è·ç¦»èµ·å§‹åœ°å€æœ‰å¤šå°‘å­—èŠ‚ï¼Œé€šè¿‡è¿™ä¸ªåç§»é‡ç¨‹åºæ— é¡»éå†æ•´ä¸ªå‹ç¼©åˆ—è¡¨å°±å¯ä»¥ç¡®å®šè¡¨å°¾èŠ‚ç‚¹çš„åœ°å€ zllenï¼šuint16_t ç±»å‹ 2 å­—èŠ‚ï¼Œè®°å½•äº†å‹ç¼©åˆ—è¡¨åŒ…å«çš„èŠ‚ç‚¹æ•°é‡ï¼Œå½“è¯¥å±æ€§çš„å€¼å°äº UINT16_MAX (65535) æ—¶ï¼Œè¯¥å€¼å°±æ˜¯å‹ç¼©åˆ—è¡¨ä¸­èŠ‚ç‚¹çš„æ•°é‡ï¼›å½“è¿™ä¸ªå€¼ç­‰äº UINT16_MAX æ—¶èŠ‚ç‚¹çš„çœŸå®æ•°é‡éœ€è¦éå†æ•´ä¸ªå‹ç¼©åˆ—è¡¨æ‰èƒ½è®¡ç®—å¾—å‡º entryXï¼šåˆ—è¡¨èŠ‚ç‚¹ï¼Œå‹ç¼©åˆ—è¡¨ä¸­çš„å„ä¸ªèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹çš„é•¿åº¦ç”±èŠ‚ç‚¹ä¿å­˜çš„å†…å®¹å†³å®š zlendï¼šuint8_t ç±»å‹ 1 å­—èŠ‚ï¼Œæ˜¯ä¸€ä¸ªç‰¹æ®Šå€¼ 0xFF (255)ï¼Œç”¨äºæ ‡è®°å‹ç¼©åˆ—è¡¨çš„æœ«ç«¯ åˆ—è¡¨ zlbytes å±æ€§çš„å€¼ä¸º 0x50 (åè¿›åˆ¶ 80)ï¼Œè¡¨ç¤ºå‹ç¼©åˆ—è¡¨çš„æ€»é•¿ä¸º 80 å­—èŠ‚ï¼Œåˆ—è¡¨ zltail å±æ€§çš„å€¼ä¸º 0x3c (åè¿›åˆ¶ 60)ï¼Œå‡è®¾è¡¨çš„èµ·å§‹åœ°å€ä¸º pï¼Œè®¡ç®—å¾—å‡ºè¡¨å°¾èŠ‚ç‚¹ entry3 çš„åœ°å€ p + 60 åˆ—è¡¨èŠ‚ç‚¹åˆ—è¡¨èŠ‚ç‚¹ entry çš„æ•°æ®ç»“æ„ï¼š previous_entry_lengthï¼šä»¥å­—èŠ‚ä¸ºå•ä½è®°å½•äº†å‹ç¼©åˆ—è¡¨ä¸­å‰ä¸€ä¸ªèŠ‚ç‚¹çš„é•¿åº¦ï¼Œç¨‹åºå¯ä»¥é€šè¿‡æŒ‡é’ˆè¿ç®—ï¼Œæ ¹æ®å½“å‰èŠ‚ç‚¹çš„èµ·å§‹åœ°å€æ¥è®¡ç®—å‡ºå‰ä¸€ä¸ªèŠ‚ç‚¹çš„èµ·å§‹åœ°å€ï¼Œå®Œæˆä»è¡¨å°¾å‘è¡¨å¤´éå†æ“ä½œ å¦‚æœå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å°äº 254 å­—èŠ‚ï¼Œè¯¥å±æ€§çš„é•¿åº¦ä¸º 1 å­—èŠ‚ï¼Œå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å°±ä¿å­˜åœ¨è¿™ä¸€ä¸ªå­—èŠ‚é‡Œ å¦‚æœå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å¤§äºç­‰äº 254 å­—èŠ‚ï¼Œè¯¥å±æ€§çš„é•¿åº¦ä¸º 5 å­—èŠ‚ï¼Œå…¶ä¸­ç¬¬ä¸€å­—èŠ‚ä¼šè¢«è®¾ç½®ä¸º 0xFEï¼ˆåè¿›åˆ¶ 254ï¼‰ï¼Œä¹‹åçš„å››ä¸ªå­—èŠ‚åˆ™ç”¨äºä¿å­˜å‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦ encodingï¼šè®°å½•äº†èŠ‚ç‚¹çš„ content å±æ€§æ‰€ä¿å­˜çš„æ•°æ®ç±»å‹å’Œé•¿åº¦ é•¿åº¦ä¸º 1 å­—èŠ‚ã€2 å­—èŠ‚æˆ–è€… 5 å­—èŠ‚ï¼Œå€¼çš„æœ€é«˜ä½ä¸º 00ã€01 æˆ–è€… 10 çš„æ˜¯å­—èŠ‚æ•°ç»„ç¼–ç ï¼Œæ•°ç»„çš„é•¿åº¦ç”±ç¼–ç é™¤å»æœ€é«˜ä¸¤ä½ä¹‹åçš„å…¶ä»–ä½è®°å½•ï¼Œä¸‹åˆ’çº¿ _ è¡¨ç¤ºç•™ç©ºï¼Œè€Œ bã€x ç­‰å˜é‡åˆ™ä»£è¡¨å®é™…çš„äºŒè¿›åˆ¶æ•°æ® é•¿åº¦ä¸º 1 å­—èŠ‚ï¼Œå€¼çš„æœ€é«˜ä½ä¸º 11 çš„æ˜¯æ•´æ•°ç¼–ç ï¼Œæ•´æ•°å€¼çš„ç±»å‹å’Œé•¿åº¦ç”±ç¼–ç é™¤å»æœ€é«˜ä¸¤ä½ä¹‹åçš„å…¶ä»–ä½è®°å½• contentï¼šæ¯ä¸ªå‹ç¼©åˆ—è¡¨èŠ‚ç‚¹å¯ä»¥ä¿å­˜ä¸€ä¸ªå­—èŠ‚æ•°ç»„æˆ–è€…ä¸€ä¸ªæ•´æ•°å€¼ å­—èŠ‚æ•°ç»„å¯ä»¥æ˜¯ä»¥ä¸‹ä¸‰ç§é•¿åº¦çš„å…¶ä¸­ä¸€ç§ï¼š é•¿åº¦å°äºç­‰äº $63 (2^6-1)$ å­—èŠ‚çš„å­—èŠ‚æ•°ç»„ é•¿åº¦å°äºç­‰äº $16383(2^{14}-1)$ å­—èŠ‚çš„å­—èŠ‚æ•°ç»„ é•¿åº¦å°äºç­‰äº $4294967295(2^{32}-1)$ å­—èŠ‚çš„å­—èŠ‚æ•°ç»„ æ•´æ•°å€¼åˆ™å¯ä»¥æ˜¯ä»¥ä¸‹å…­ç§é•¿åº¦çš„å…¶ä¸­ä¸€ç§ï¼š 4 ä½é•¿ï¼Œä»‹äº 0 è‡³ 12 ä¹‹é—´çš„æ— ç¬¦å·æ•´æ•° 1 å­—èŠ‚é•¿çš„æœ‰ç¬¦å·æ•´æ•° 3 å­—èŠ‚é•¿çš„æœ‰ç¬¦å·æ•´æ•° int16_t ç±»å‹æ•´æ•° int32_t ç±»å‹æ•´æ•° int64_t ç±»å‹æ•´æ•° è¿é”æ›´æ–°Redis å°†åœ¨ç‰¹æ®Šæƒ…å†µä¸‹äº§ç”Ÿçš„è¿ç»­å¤šæ¬¡ç©ºé—´æ‰©å±•æ“ä½œç§°ä¹‹ä¸ºè¿é”æ›´æ–°ï¼ˆcascade updateï¼‰ å‡è®¾åœ¨ä¸€ä¸ªå‹ç¼©åˆ—è¡¨ä¸­ï¼Œæœ‰å¤šä¸ªè¿ç»­çš„ã€é•¿åº¦ä»‹äº 250 åˆ° 253 å­—èŠ‚ä¹‹é—´çš„èŠ‚ç‚¹ e1 è‡³ eNã€‚å°†ä¸€ä¸ªé•¿åº¦å¤§äºç­‰äº 254 å­—èŠ‚çš„æ–°èŠ‚ç‚¹ new è®¾ç½®ä¸ºå‹ç¼©åˆ—è¡¨çš„å¤´èŠ‚ç‚¹ï¼Œnew å°±æˆä¸º e1 çš„å‰ç½®èŠ‚ç‚¹ã€‚e1 çš„ previous_entry_length å±æ€§ä»…ä¸º 1 å­—èŠ‚ï¼Œæ— æ³•ä¿å­˜æ–°èŠ‚ç‚¹ new çš„é•¿åº¦ï¼Œæ‰€ä»¥è¦å¯¹å‹ç¼©åˆ—è¡¨æ‰§è¡Œç©ºé—´é‡åˆ†é…æ“ä½œï¼Œå¹¶å°† e1 èŠ‚ç‚¹çš„ previous_entry_length å±æ€§ä» 1 å­—èŠ‚é•¿æ‰©å±•ä¸º 5 å­—èŠ‚é•¿ã€‚ç”±äº e1 åŸæœ¬çš„é•¿åº¦ä»‹äº 250 è‡³ 253 å­—èŠ‚ä¹‹é—´ï¼Œæ‰€ä»¥æ‰©å±•å e1 çš„é•¿åº¦å°±å˜æˆäº† 254 è‡³ 257 å­—èŠ‚ä¹‹é—´ï¼Œå¯¼è‡´ e2 çš„ previous_entry_length å±æ€§æ— æ³•ä¿å­˜ e1 çš„é•¿åº¦ï¼Œç¨‹åºéœ€è¦ä¸æ–­åœ°å¯¹å‹ç¼©åˆ—è¡¨æ‰§è¡Œç©ºé—´é‡åˆ†é…æ“ä½œï¼Œç›´åˆ° eN ä¸ºæ­¢ åˆ é™¤èŠ‚ç‚¹ä¹Ÿå¯èƒ½ä¼šå¼•å‘è¿é”æ›´æ–°ï¼Œbig.length &gt;&#x3D; 254ï¼Œsmall.length &lt; 254ï¼Œåˆ é™¤ small èŠ‚ç‚¹ è¿é”æ›´æ–°åœ¨æœ€åæƒ…å†µä¸‹éœ€è¦å¯¹å‹ç¼©åˆ—è¡¨æ‰§è¡Œ N æ¬¡ç©ºé—´é‡åˆ†é…ï¼Œæ¯æ¬¡é‡åˆ†é…çš„æœ€åå¤æ‚åº¦ä¸º O(N)ï¼Œæ‰€ä»¥è¿é”æ›´æ–°çš„æœ€åå¤æ‚åº¦ä¸º O(N^2) è¯´æ˜ï¼šå°½ç®¡è¿é”æ›´æ–°çš„å¤æ‚åº¦è¾ƒé«˜ï¼Œä½†å‡ºç°çš„è®°å½•æ˜¯éå¸¸ä½çš„ï¼Œå³ä½¿å‡ºç°åªè¦è¢«æ›´æ–°çš„èŠ‚ç‚¹æ•°é‡ä¸å¤šï¼Œå°±ä¸ä¼šå¯¹æ€§èƒ½é€ æˆå½±å“ æ•°æ®ç±»å‹redisObjå¯¹è±¡ç³»ç»ŸRedis ä½¿ç”¨å¯¹è±¡æ¥è¡¨ç¤ºæ•°æ®åº“ä¸­çš„é”®å’Œå€¼ï¼Œå½“åœ¨ Redis æ•°æ®åº“ä¸­æ–°åˆ›å»ºä¸€ä¸ªé”®å€¼å¯¹æ—¶è‡³å°‘ä¼šåˆ›å»ºä¸¤ä¸ªå¯¹è±¡ï¼Œä¸€ä¸ªå¯¹è±¡ç”¨ä½œé”®å€¼å¯¹çš„é”®ï¼ˆé”®å¯¹è±¡ï¼‰ï¼Œå¦ä¸€ä¸ªå¯¹è±¡ç”¨ä½œé”®å€¼å¯¹çš„å€¼ï¼ˆå€¼å¯¹è±¡ï¼‰ Redis ä¸­å¯¹è±¡ç”±ä¸€ä¸ª redisObject ç»“æ„è¡¨ç¤ºï¼Œè¯¥ç»“æ„ä¸­å’Œä¿å­˜æ•°æ®æœ‰å…³çš„ä¸‰ä¸ªå±æ€§åˆ†åˆ«æ˜¯ typeã€ encodingã€ptrï¼š 12345678910typedef struct redisObiect &#123; // ç±»å‹ unsigned type:4; // ç¼–ç  unsigned encoding:4; // æŒ‡å‘åº•å±‚æ•°æ®ç»“æ„çš„æŒ‡é’ˆ void *ptr; // ....&#125; robj; Redis å¹¶æ²¡æœ‰ç›´æ¥ä½¿ç”¨æ•°æ®ç»“æ„æ¥å®ç°é”®å€¼å¯¹æ•°æ®åº“ï¼Œè€Œæ˜¯åŸºäºè¿™äº›æ•°æ®ç»“æ„åˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ç³»ç»Ÿï¼ŒåŒ…å«å­—ç¬¦ä¸²å¯¹è±¡ã€åˆ—è¡¨å¯¹è±¡ã€å“ˆå¸Œå¯¹è±¡ã€é›†åˆå¯¹è±¡å’Œæœ‰åºé›†åˆå¯¹è±¡è¿™äº”ç§ç±»å‹çš„å¯¹è±¡ï¼Œè€Œæ¯ç§å¯¹è±¡åˆé€šè¿‡ä¸åŒçš„ç¼–ç æ˜ å°„åˆ°ä¸åŒçš„åº•å±‚æ•°æ®ç»“æ„ Redis æ˜¯ä¸€ä¸ª Map ç±»å‹ï¼Œå…¶ä¸­æ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯é‡‡ç”¨ key : value çš„å½¢å¼å­˜å‚¨ï¼Œé”®å¯¹è±¡éƒ½æ˜¯å­—ç¬¦ä¸²å¯¹è±¡ï¼Œè€Œå€¼å¯¹è±¡æœ‰äº”ç§åŸºæœ¬ç±»å‹å’Œä¸‰ç§é«˜çº§ç±»å‹å¯¹è±¡ å¯¹ä¸€ä¸ªæ•°æ®åº“é”®æ‰§è¡Œ TYPE å‘½ä»¤ï¼Œè¿”å›çš„ç»“æœä¸ºæ•°æ®åº“é”®å¯¹åº”çš„å€¼å¯¹è±¡çš„ç±»å‹ï¼Œè€Œä¸æ˜¯é”®å¯¹è±¡çš„ç±»å‹ å¯¹ä¸€ä¸ªæ•°æ®åº“é”®æ‰§è¡Œ OBJECT ENCODING å‘½ä»¤ï¼ŒæŸ¥çœ‹æ•°æ®åº“é”®å¯¹åº”çš„å€¼å¯¹è±¡çš„ç¼–ç  å‘½ä»¤å¤šæ€Redis ä¸­ç”¨äºæ“ä½œé”®çš„å‘½ä»¤åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š ä¸€ç§å‘½ä»¤å¯ä»¥å¯¹ä»»ä½•ç±»å‹çš„é”®æ‰§è¡Œï¼Œæ¯”å¦‚è¯´ DEL ã€EXPIREã€RENAMEã€ TYPE ç­‰ï¼ˆåŸºäºç±»å‹çš„å¤šæ€ï¼‰ åªèƒ½å¯¹ç‰¹å®šç±»å‹çš„é”®æ‰§è¡Œï¼Œæ¯”å¦‚ SET åªèƒ½å¯¹å­—ç¬¦ä¸²é”®æ‰§è¡Œã€HSET å¯¹å“ˆå¸Œé”®æ‰§è¡Œã€SADD å¯¹é›†åˆé”®æ‰§è¡Œï¼Œå¦‚æœç±»å‹æ­¥åŒ¹é…ä¼šæŠ¥ç±»å‹é”™è¯¯ï¼š (error) WRONGTYPE Operation against a key holding the wrong kind of value Redis ä¸ºäº†ç¡®ä¿åªæœ‰æŒ‡å®šç±»å‹çš„é”®å¯ä»¥æ‰§è¡ŒæŸäº›ç‰¹å®šçš„å‘½ä»¤ï¼Œåœ¨æ‰§è¡Œç±»å‹ç‰¹å®šçš„å‘½ä»¤ä¹‹å‰ï¼Œå…ˆé€šè¿‡å€¼å¯¹è±¡ redisObject ç»“æ„ type å±æ€§æ£€æŸ¥æ“ä½œç±»å‹æ˜¯å¦æ­£ç¡®ï¼Œç„¶åå†å†³å®šæ˜¯å¦æ‰§è¡ŒæŒ‡å®šçš„å‘½ä»¤ å¯¹äºå¤šæ€å‘½ä»¤ï¼Œæ¯”å¦‚åˆ—è¡¨å¯¹è±¡æœ‰ ziplist å’Œ linkedlist ä¸¤ç§å®ç°æ–¹å¼ï¼Œé€šè¿‡ redisObject ç»“æ„ encoding å±æ€§ç¡®å®šå…·ä½“çš„ç¼–ç ç±»å‹ï¼Œåº•å±‚è°ƒç”¨å¯¹åº”çš„ API å®ç°å…·ä½“çš„æ“ä½œï¼ˆåŸºäºç¼–ç çš„å¤šæ€ï¼‰ å†…å­˜å›æ”¶å¯¹è±¡çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå¯ä»¥åˆ’åˆ†ä¸ºåˆ›å»ºå¯¹è±¡ã€ æ“ä½œå¯¹è±¡ã€ é‡Šæ”¾å¯¹è±¡ä¸‰ä¸ªé˜¶æ®µ C è¯­è¨€æ²¡æœ‰è‡ªåŠ¨å›æ”¶å†…å­˜çš„åŠŸèƒ½ï¼Œæ‰€ä»¥ Redis åœ¨å¯¹è±¡ç³»ç»Ÿä¸­æ„å»ºäº†å¼•ç”¨è®¡æ•°ï¼ˆreference countingï¼‰æŠ€æœ¯å®ç°çš„å†…å­˜å›æ”¶æœºåˆ¶ï¼Œç¨‹åºå¯ä»¥è·Ÿè¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¿¡æ¯ï¼Œåœ¨é€‚å½“çš„æ—¶å€™è‡ªåŠ¨é‡Šæ”¾å¯¹è±¡å¹¶è¿›è¡Œå†…å­˜å›æ”¶ 1234typedef struct redisObiect &#123; // å¼•ç”¨è®¡æ•° int refcount;&#125; robj; å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¿¡æ¯ä¼šéšç€å¯¹è±¡çš„ä½¿ç”¨çŠ¶æ€è€Œä¸æ–­å˜åŒ–ï¼Œåˆ›å»ºæ—¶å¼•ç”¨è®¡æ•° refcount åˆå§‹åŒ–ä¸º 1ï¼Œæ¯æ¬¡è¢«ä¸€ä¸ªæ–°ç¨‹åºä½¿ç”¨æ—¶å¼•ç”¨è®¡æ•°åŠ  1ï¼Œå½“å¯¹è±¡ä¸å†è¢«ä¸€ä¸ªç¨‹åºä½¿ç”¨æ—¶å¼•ç”¨è®¡æ•°å€¼ä¼šè¢«å‡ 1ï¼Œå½“å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å€¼å˜ä¸º 0 æ—¶ï¼Œå¯¹è±¡æ‰€å ç”¨çš„å†…å­˜ä¼šè¢«é‡Šæ”¾ å¯¹è±¡å…±äº«å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å±æ€§å¸¦æœ‰å¯¹è±¡å…±äº«çš„ä½œç”¨ï¼Œå…±äº«å¯¹è±¡æœºåˆ¶æ›´èŠ‚çº¦å†…å­˜ï¼Œæ•°æ®åº“ä¸­ä¿å­˜çš„ç›¸åŒå€¼å¯¹è±¡è¶Šå¤šï¼ŒèŠ‚çº¦çš„å†…å­˜å°±è¶Šå¤š è®©å¤šä¸ªé”®å…±äº«ä¸€ä¸ªå¯¹è±¡çš„æ­¥éª¤ï¼š å°†æ•°æ®åº“é”®çš„å€¼æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªç°æœ‰çš„å€¼å¯¹è±¡ å°†è¢«å…±äº«çš„å€¼å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å¢ä¸€ Redis åœ¨åˆå§‹åŒ–æœåŠ¡å™¨æ—¶åˆ›å»ºä¸€ä¸‡ä¸ªï¼ˆé…ç½®æ–‡ä»¶å¯ä»¥ä¿®æ”¹ï¼‰å­—ç¬¦ä¸²å¯¹è±¡ï¼ŒåŒ…å«äº†ä» 0 åˆ° 9999 çš„æ‰€æœ‰æ•´æ•°å€¼ï¼Œå½“æœåŠ¡å™¨éœ€è¦ç”¨åˆ°å€¼ä¸º 0 åˆ° 9999 çš„å­—ç¬¦ä¸²å¯¹è±¡æ—¶ï¼ŒæœåŠ¡å™¨å°±ä¼šä½¿ç”¨è¿™äº›å…±äº«å¯¹è±¡ï¼Œè€Œä¸æ˜¯æ–°åˆ›å»ºå¯¹è±¡ æ¯”å¦‚åˆ›å»ºä¸€ä¸ªå€¼ä¸º 100 çš„é”® Aï¼Œå¹¶ä½¿ç”¨ OBJECT REFCOUNT å‘½ä»¤æŸ¥çœ‹é”® A çš„å€¼å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œä¼šå‘ç°å€¼å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸º 2ï¼Œå¼•ç”¨è¿™ä¸ªå€¼å¯¹è±¡çš„ä¸¤ä¸ªç¨‹åºåˆ†åˆ«æ˜¯æŒæœ‰è¿™ä¸ªå€¼å¯¹è±¡çš„æœåŠ¡å™¨ç¨‹åºï¼Œä»¥åŠå…±äº«è¿™ä¸ªå€¼å¯¹è±¡çš„é”® A å…±äº«å¯¹è±¡åœ¨åµŒå¥—äº†å­—ç¬¦ä¸²å¯¹è±¡çš„å¯¹è±¡ï¼ˆlinkedlist ç¼–ç çš„åˆ—è¡¨ã€hashtable ç¼–ç çš„å“ˆå¸Œã€zset ç¼–ç çš„æœ‰åºé›†åˆï¼‰ä¸­ä¹Ÿèƒ½ä½¿ç”¨ Redis ä¸å…±äº«åŒ…å«å­—ç¬¦ä¸²å¯¹è±¡çš„åŸå› ï¼šéªŒè¯å…±äº«å¯¹è±¡å’Œç›®æ ‡å¯¹è±¡æ˜¯å¦ç›¸åŒçš„å¤æ‚åº¦è¶Šé«˜ï¼Œæ¶ˆè€—çš„ CPU æ—¶é—´ä¹Ÿä¼šè¶Šå¤š æ•´æ•°å€¼çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œ éªŒè¯æ“ä½œçš„å¤æ‚åº¦ä¸º O(1) å­—ç¬¦ä¸²å€¼çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œ éªŒè¯æ“ä½œçš„å¤æ‚åº¦ä¸º O(N) å¦‚æœå…±äº«å¯¹è±¡æ˜¯åŒ…å«äº†å¤šä¸ªå€¼ï¼ˆæˆ–è€…å¯¹è±¡çš„ï¼‰å¯¹è±¡ï¼Œæ¯”å¦‚åˆ—è¡¨å¯¹è±¡æˆ–è€…å“ˆå¸Œå¯¹è±¡ï¼ŒéªŒè¯æ“ä½œçš„å¤æ‚åº¦ä¸º O(N^2) ç©ºè½¬æ—¶é•¿redisObject ç»“æ„åŒ…å«ä¸€ä¸ª lru å±æ€§ï¼Œè¯¥å±æ€§è®°å½•äº†å¯¹è±¡æœ€åä¸€æ¬¡è¢«å‘½ä»¤ç¨‹åºè®¿é—®çš„æ—¶é—´ 123typedef struct redisObiect &#123; unsigned lru:22; &#125; robj; OBJECT IDLETIME å‘½ä»¤å¯ä»¥æ‰“å°å‡ºç»™å®šé”®çš„ç©ºè½¬æ—¶é•¿ï¼Œè¯¥å€¼å°±æ˜¯é€šè¿‡å°†å½“å‰æ—¶é—´å‡å»é”®çš„å€¼å¯¹è±¡çš„ lru æ—¶é—´è®¡ç®—å¾—å‡ºçš„ï¼Œè¿™ä¸ªå‘½ä»¤åœ¨è®¿é—®é”®çš„å€¼å¯¹è±¡æ—¶ï¼Œä¸ä¼šä¿®æ”¹å€¼å¯¹è±¡çš„ lru å±æ€§ 1234567891011redis&gt; OBJECT IDLETIME msg(integer) 10# ç­‰å¾…ä¸€åˆ†é’Ÿredis&gt; OBJECT IDLETIME msg(integer) 70# è®¿é—® msgredis&gt; GET msg&quot;hello world&quot;# é”®å¤„äºæ´»è·ƒçŠ¶æ€ï¼Œç©ºè½¬æ—¶é•¿ä¸º 0redis&gt; OBJECT IDLETIME msg(integer) 0 ç©ºè½¬æ—¶é•¿çš„ä½œç”¨ï¼šå¦‚æœæœåŠ¡å™¨å¼€å¯ maxmemory é€‰é¡¹ï¼Œå¹¶ä¸”å›æ”¶å†…å­˜çš„ç®—æ³•ä¸º volatile-lru æˆ–è€… allkeys-lruï¼Œé‚£ä¹ˆå½“æœåŠ¡å™¨å ç”¨çš„å†…å­˜æ•°è¶…è¿‡äº† maxmemory æ‰€è®¾ç½®çš„ä¸Šé™å€¼æ—¶ï¼Œç©ºè½¬æ—¶é•¿è¾ƒé«˜çš„é‚£éƒ¨åˆ†é”®ä¼šä¼˜å…ˆè¢«æœåŠ¡å™¨é‡Šæ”¾ï¼Œä»è€Œå›æ”¶å†…å­˜ï¼ˆLRU ç®—æ³•ï¼‰ stringç®€ä»‹å­˜å‚¨çš„æ•°æ®ï¼šå•ä¸ªæ•°æ®ï¼Œæœ€ç®€å•çš„æ•°æ®å­˜å‚¨ç±»å‹ï¼Œä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„æ•°æ®å­˜å‚¨ç±»å‹ï¼Œå®è´¨ä¸Šæ˜¯å­˜ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œstring ç±»å‹æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ï¼Œå¯ä»¥åŒ…å«ä»»ä½•æ•°æ®ï¼Œæ¯”å¦‚å›¾ç‰‡æˆ–è€…åºåˆ—åŒ–çš„å¯¹è±¡ å­˜å‚¨æ•°æ®çš„æ ¼å¼ï¼šä¸€ä¸ªå­˜å‚¨ç©ºé—´ä¿å­˜ä¸€ä¸ªæ•°æ®ï¼Œæ¯ä¸€ä¸ªç©ºé—´ä¸­åªèƒ½ä¿å­˜ä¸€ä¸ªå­—ç¬¦ä¸²ä¿¡æ¯ å­˜å‚¨å†…å®¹ï¼šé€šå¸¸ä½¿ç”¨å­—ç¬¦ä¸²ï¼Œå¦‚æœå­—ç¬¦ä¸²ä»¥æ•´æ•°çš„å½¢å¼å±•ç¤ºï¼Œå¯ä»¥ä½œä¸ºæ•°å­—æ“ä½œä½¿ç”¨ Redis æ‰€æœ‰æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ï¼Œé‡‡ç”¨å•çº¿ç¨‹æœºåˆ¶ï¼Œå‘½ä»¤æ˜¯å•ä¸ªé¡ºåºæ‰§è¡Œï¼Œæ— éœ€è€ƒè™‘å¹¶å‘å¸¦æ¥å½±å“ï¼ŒåŸå­æ€§å°±æ˜¯æœ‰ä¸€ä¸ªå¤±è´¥åˆ™éƒ½å¤±è´¥ å­—ç¬¦ä¸²å¯¹è±¡å¯ä»¥æ˜¯ intã€rawã€embstr ä¸‰ç§å®ç°æ–¹å¼ æ“ä½œæŒ‡ä»¤æ“ä½œï¼š æ•°æ®æ“ä½œï¼š 12345set key value #æ·»åŠ /ä¿®æ”¹æ•°æ®æ·»åŠ /ä¿®æ”¹æ•°æ®del key #åˆ é™¤æ•°æ®setnx key value #åˆ¤å®šæ€§æ·»åŠ æ•°æ®ï¼Œé”®å€¼ä¸ºç©ºåˆ™è®¾æ·»åŠ mset k1 v1 k2 v2... #æ·»åŠ /ä¿®æ”¹å¤šä¸ªæ•°æ®ï¼Œmï¼šMultipleappend key value #è¿½åŠ ä¿¡æ¯åˆ°åŸå§‹ä¿¡æ¯åéƒ¨ï¼ˆå¦‚æœåŸå§‹ä¿¡æ¯å­˜åœ¨å°±è¿½åŠ ï¼Œå¦åˆ™æ–°å»ºï¼‰ æŸ¥è¯¢æ“ä½œ 123get key #è·å–æ•°æ®ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œè¿”å›ç©ºï¼ˆnilï¼‰mget key1 key2... #è·å–å¤šä¸ªæ•°æ®strlen key #è·å–æ•°æ®å­—ç¬¦ä¸ªæ•°ï¼ˆå­—ç¬¦ä¸²é•¿åº¦ï¼‰ è®¾ç½®æ•°å€¼æ•°æ®å¢åŠ &#x2F;å‡å°‘æŒ‡å®šèŒƒå›´çš„å€¼ 12345incr key #key++incrby key increment #key+incrementincrbyfloat key increment #å¯¹å°æ•°æ“ä½œdecr key #key--decrby key increment #key-increment è®¾ç½®æ•°æ®å…·æœ‰æŒ‡å®šçš„ç”Ÿå‘½å‘¨æœŸ 12setex key seconds value #è®¾ç½®key-valueå­˜æ´»æ—¶é—´ï¼Œsecondså•ä½æ˜¯ç§’psetex key milliseconds value #æ¯«ç§’çº§ æ³¨æ„äº‹é¡¹ï¼š æ•°æ®æ“ä½œä¸æˆåŠŸçš„åé¦ˆä¸æ•°æ®æ­£å¸¸æ“ä½œä¹‹é—´çš„å·®å¼‚ è¡¨ç¤ºè¿è¡Œç»“æœæ˜¯å¦æˆåŠŸ (integer) 0 â†’ false ï¼Œå¤±è´¥ (integer) 1 â†’ trueï¼ŒæˆåŠŸ è¡¨ç¤ºè¿è¡Œç»“æœå€¼ (integer) 3 â†’ 3 ä¸ª (integer) 1 â†’ 1 ä¸ª æ•°æ®æœªè·å–åˆ°æ—¶ï¼Œå¯¹åº”çš„æ•°æ®ä¸ºï¼ˆnilï¼‰ï¼Œç­‰åŒäºnull æ•°æ®æœ€å¤§å­˜å‚¨é‡ï¼š512MB string åœ¨ Redis å†…éƒ¨å­˜å‚¨é»˜è®¤å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå½“é‡åˆ°å¢å‡ç±»æ“ä½œ incrï¼Œdecr æ—¶ä¼šè½¬æˆæ•°å€¼å‹è¿›è¡Œè®¡ç®— æŒ‰æ•°å€¼è¿›è¡Œæ“ä½œçš„æ•°æ®ï¼Œå¦‚æœåŸå§‹æ•°æ®ä¸èƒ½è½¬æˆæ•°å€¼ï¼Œæˆ–è¶…è¶Šäº†Redis æ•°å€¼ä¸Šé™èŒƒå›´ï¼Œå°†æŠ¥é”™9223372036854775807ï¼ˆjava ä¸­ Long å‹æ•°æ®æœ€å¤§å€¼ï¼ŒLong.MAX_VALUEï¼‰ Redis å¯ç”¨äºæ§åˆ¶æ•°æ®åº“è¡¨ä¸»é”® IDï¼Œä¸ºæ•°æ®åº“è¡¨ä¸»é”®æä¾›ç”Ÿæˆç­–ç•¥ï¼Œä¿éšœæ•°æ®åº“è¡¨çš„ä¸»é”®å”¯ä¸€æ€§ å•æ•°æ®å’Œå¤šæ•°æ®çš„é€‰æ‹©ï¼š å•æ•°æ®æ‰§è¡Œ 3 æ¡æŒ‡ä»¤çš„è¿‡ç¨‹ï¼š3 æ¬¡å‘é€ + 3 æ¬¡å¤„ç† + 3 æ¬¡è¿”å› å¤šæ•°æ®æ‰§è¡Œ 1 æ¡æŒ‡ä»¤çš„è¿‡ç¨‹ï¼š1 æ¬¡å‘é€ + 3 æ¬¡å¤„ç† + 1 æ¬¡è¿”å›ï¼ˆå‘é€å’Œè¿”å›çš„äº‹ä»¶ç•¥é«˜äºå•æ•°æ®ï¼‰ å®ç°å­—ç¬¦ä¸²å¯¹è±¡çš„ç¼–ç å¯ä»¥æ˜¯ intã€rawã€embstr ä¸‰ç§ intï¼šå­—ç¬¦ä¸²å¯¹è±¡ä¿å­˜çš„æ˜¯æ•´æ•°å€¼ï¼Œå¹¶ä¸”æ•´æ•°å€¼å¯ä»¥ç”¨ long ç±»å‹æ¥è¡¨ç¤ºï¼Œé‚£ä¹ˆå¯¹è±¡ä¼šå°†æ•´æ•°å€¼ä¿å­˜åœ¨å­—ç¬¦ä¸²å¯¹è±¡ç»“æ„çš„ ptr å±æ€§é¢ï¼ˆå°† void * è½¬æ¢æˆ long)ï¼Œå¹¶å°†å­—ç¬¦ä¸²å¯¹è±¡çš„ç¼–ç è®¾ç½®ä¸º intï¼ˆæµ®ç‚¹æ•°ç”¨å¦å¤–ä¸¤ç§æ–¹å¼ï¼‰ rawï¼šå­—ç¬¦ä¸²å¯¹è±¡ä¿å­˜çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œå¹¶ä¸”å€¼çš„é•¿åº¦å¤§äº 39 å­—èŠ‚ï¼Œé‚£ä¹ˆå¯¹è±¡å°†ä½¿ç”¨ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰æ¥ä¿å­˜è¯¥å€¼ï¼Œå¹¶å°†å¯¹è±¡çš„ç¼–ç è®¾ç½®ä¸º raw embstrï¼šå­—ç¬¦ä¸²å¯¹è±¡ä¿å­˜çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œå¹¶ä¸”å€¼çš„é•¿åº¦å°äºç­‰äº 39 å­—èŠ‚ï¼Œé‚£ä¹ˆå¯¹è±¡å°†ä½¿ç”¨ embstr ç¼–ç çš„æ–¹å¼æ¥ä¿å­˜è¿™ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œå¹¶å°†å¯¹è±¡çš„ç¼–ç è®¾ç½®ä¸º embstr ä¸Šå›¾æ‰€ç¤ºï¼Œembstr ä¸ raw éƒ½ä½¿ç”¨äº† redisObject å’Œ sdshdr æ¥è¡¨ç¤ºå­—ç¬¦ä¸²å¯¹è±¡ï¼Œä½†æ˜¯ raw éœ€è¦è°ƒç”¨ä¸¤æ¬¡å†…å­˜åˆ†é…å‡½æ•°åˆ†åˆ«åˆ›å»ºä¸¤ç§ç»“æ„ï¼Œembstr åªéœ€è¦ä¸€æ¬¡å†…å­˜åˆ†é…æ¥åˆ†é…ä¸€å—è¿ç»­çš„ç©ºé—´ embstr æ˜¯ç”¨äºä¿å­˜çŸ­å­—ç¬¦ä¸²çš„ä¸€ç§ç¼–ç æ–¹å¼ï¼Œå¯¹æ¯” raw çš„ä¼˜ç‚¹ï¼š å†…å­˜åˆ†é…æ¬¡æ•°ä»ä¸¤æ¬¡é™ä½ä¸ºä¸€æ¬¡ï¼ŒåŒæ ·é‡Šæ”¾å†…å­˜çš„æ¬¡æ•°ä¹Ÿä»ä¸¤æ¬¡å˜ä¸ºä¸€æ¬¡ embstr ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡çš„æ•°æ®éƒ½ä¿å­˜åœ¨åŒä¸€å—è¿ç»­å†…å­˜ï¼Œæ‰€ä»¥æ¯” raw ç¼–ç èƒ½å¤Ÿæ›´å¥½åœ°åˆ©ç”¨ç¼“å­˜ä¼˜åŠ¿ï¼ˆå±€éƒ¨æ€§åŸç†ï¼‰ int å’Œ embstr ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡åœ¨æ¡ä»¶æ»¡è¶³çš„æƒ…å†µä¸‹ï¼Œä¼šè¢«è½¬æ¢ä¸º raw ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼š int ç¼–ç çš„æ•´æ•°å€¼ï¼Œæ‰§è¡Œ APPEND å‘½ä»¤è¿½åŠ ä¸€ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œå…ˆå°†æ•´æ•°å€¼è½¬ä¸ºå­—ç¬¦ä¸²ç„¶åè¿½åŠ ï¼Œæœ€åå¾—åˆ°ä¸€ä¸ª raw ç¼–ç çš„å¯¹è±¡ Redis æ²¡æœ‰ä¸º embstr ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡ç¼–å†™ä»»ä½•ç›¸åº”çš„ä¿®æ”¹ç¨‹åºï¼Œæ‰€ä»¥ embstr å¯¹è±¡å®é™…ä¸Šæ˜¯åªè¯»çš„ï¼Œæ‰§è¡Œä¿®æ”¹å‘½ä»¤ä¼šå°†å¯¹è±¡çš„ç¼–ç ä» embstr è½¬æ¢æˆ rawï¼Œæ“ä½œå®Œæˆåå¾—åˆ°ä¸€ä¸ª raw ç¼–ç çš„å¯¹è±¡ æŸäº›æƒ…å†µä¸‹ï¼Œç¨‹åºä¼šå°†å­—ç¬¦ä¸²å¯¹è±¡é‡Œé¢çš„å­—ç¬¦ä¸²å€¼è½¬æ¢å›æµ®ç‚¹æ•°å€¼ï¼Œæ‰§è¡ŒæŸäº›æ“ä½œåå†å°†æµ®ç‚¹æ•°å€¼è½¬æ¢å›å­—ç¬¦ä¸²å€¼ï¼š 12345678redis&gt; SET pi 3.14 OK redis&gt; OBJECT ENCODING pi&quot;embstr&quot; redis&gt; INCRBYFLOAT pi 2.0 # è½¬ä¸ºæµ®ç‚¹æ•°æ‰§è¡Œå¢åŠ çš„æ“ä½œ&quot;5. 14&quot; redis&gt; OBJECT ENCODING pi &quot;embstr&quot; åº”ç”¨ä¸»é¡µé«˜é¢‘è®¿é—®ä¿¡æ¯æ˜¾ç¤ºæ§åˆ¶ï¼Œä¾‹å¦‚æ–°æµªå¾®åšå¤§ V ä¸»é¡µæ˜¾ç¤ºç²‰ä¸æ•°ä¸å¾®åšæ•°é‡ åœ¨ Redis ä¸­ä¸ºå¤§ V ç”¨æˆ·è®¾å®šç”¨æˆ·ä¿¡æ¯ï¼Œä»¥ç”¨æˆ·ä¸»é”®å’Œå±æ€§å€¼ä½œä¸º keyï¼Œåå°è®¾å®šå®šæ—¶åˆ·æ–°ç­–ç•¥ 123set user:id:3506728370:fans 12210947set user:id:3506728370:blogs 6164set user:id:3506728370:focuses 83 ä½¿ç”¨ JSON æ ¼å¼ä¿å­˜æ•°æ® 1user:id:3506728370 â†’ &#123;&quot;fans&quot;:12210947,&quot;blogs&quot;:6164,&quot;focuses&quot;:83&#125; keyçš„è®¾ç½®çº¦å®šï¼šè¡¨å : ä¸»é”®å : ä¸»é”®å€¼ : å­—æ®µå è¡¨å ä¸»é”®å ä¸»é”®å€¼ å­—æ®µå order id 29437595 name equip id 390472345 type news id 202004150 title hashç®€ä»‹æ•°æ®å­˜å‚¨éœ€æ±‚ï¼šå¯¹ä¸€ç³»åˆ—å­˜å‚¨çš„æ•°æ®è¿›è¡Œç¼–ç»„ï¼Œæ–¹ä¾¿ç®¡ç†ï¼Œå…¸å‹åº”ç”¨å­˜å‚¨å¯¹è±¡ä¿¡æ¯ æ•°æ®å­˜å‚¨ç»“æ„ï¼šä¸€ä¸ªå­˜å‚¨ç©ºé—´ä¿å­˜å¤šä¸ªé”®å€¼å¯¹æ•°æ® hash ç±»å‹ï¼šåº•å±‚ä½¿ç”¨å“ˆå¸Œè¡¨ç»“æ„å®ç°æ•°æ®å­˜å‚¨ Redis ä¸­çš„ hash ç±»ä¼¼äº Java ä¸­çš„ Map&lt;String, Map&lt;Object,object&gt;&gt;ï¼Œå·¦è¾¹æ˜¯ keyï¼Œå³è¾¹æ˜¯å€¼ï¼Œä¸­é—´å« field å­—æ®µï¼Œæœ¬è´¨ä¸Š hash å­˜äº†ä¸€ä¸ª key-value çš„å­˜å‚¨ç©ºé—´ hash æ˜¯æŒ‡çš„ä¸€ä¸ªæ•°æ®ç±»å‹ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªæ•°æ® å¦‚æœ field æ•°é‡è¾ƒå°‘ï¼Œå­˜å‚¨ç»“æ„ä¼˜åŒ–ä¸ºå‹ç¼©åˆ—è¡¨ç»“æ„ï¼ˆæœ‰åºï¼‰ å¦‚æœ field æ•°é‡è¾ƒå¤šï¼Œå­˜å‚¨ç»“æ„ä½¿ç”¨ HashMap ç»“æ„ï¼ˆæ— åºï¼‰ æ“ä½œæŒ‡ä»¤æ“ä½œï¼š æ•°æ®æ“ä½œ 1234hset key field value #æ·»åŠ /ä¿®æ”¹æ•°æ®hdel key field1 [field2] #åˆ é™¤æ•°æ®ï¼Œ[]ä»£è¡¨å¯é€‰hsetnx key field value #è®¾ç½®fieldçš„å€¼ï¼Œå¦‚æœè¯¥fieldå­˜åœ¨åˆ™ä¸åšä»»ä½•æ“ä½œhmset key f1 v1 f2 v2... #æ·»åŠ /ä¿®æ”¹å¤šä¸ªæ•°æ® æŸ¥è¯¢æ“ä½œ 12345hget key field #è·å–æŒ‡å®šfieldå¯¹åº”æ•°æ®hgetall key #è·å–æŒ‡å®škeyæ‰€æœ‰æ•°æ®hmget key field1 field2... #è·å–å¤šä¸ªæ•°æ®hexists key field #è·å–å“ˆå¸Œè¡¨ä¸­æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„å­—æ®µhlen key #è·å–å“ˆå¸Œè¡¨ä¸­å­—æ®µçš„æ•°é‡ è·å–å“ˆå¸Œè¡¨ä¸­æ‰€æœ‰çš„å­—æ®µåæˆ–å­—æ®µå€¼ 12hkeys key #è·å–æ‰€æœ‰çš„field hvals key #è·å–æ‰€æœ‰çš„value è®¾ç½®æŒ‡å®šå­—æ®µçš„æ•°å€¼æ•°æ®å¢åŠ æŒ‡å®šèŒƒå›´çš„å€¼ 12hincrby key field increment #æŒ‡å®šå­—æ®µçš„æ•°å€¼æ•°æ®å¢åŠ æŒ‡å®šçš„å€¼ï¼Œincrementä¸ºè´Ÿæ•°åˆ™å‡å°‘hincrbyfloat key field increment#æ“ä½œå°æ•° æ³¨æ„äº‹é¡¹ hash ç±»å‹ä¸­ value åªèƒ½å­˜å‚¨å­—ç¬¦ä¸²ï¼Œä¸å…è®¸å­˜å‚¨å…¶ä»–æ•°æ®ç±»å‹ï¼Œä¸å­˜åœ¨åµŒå¥—ç°è±¡ï¼Œå¦‚æœæ•°æ®æœªè·å–åˆ°ï¼Œå¯¹åº”çš„å€¼ä¸ºï¼ˆnilï¼‰ æ¯ä¸ª hash å¯ä»¥å­˜å‚¨ 2^32 - 1 ä¸ªé”®å€¼å¯¹ hash ç±»å‹å’Œå¯¹è±¡çš„æ•°æ®å­˜å‚¨å½¢å¼ç›¸ä¼¼ï¼Œå¹¶ä¸”å¯ä»¥çµæ´»æ·»åŠ åˆ é™¤å¯¹è±¡å±æ€§ã€‚ä½† hash è®¾è®¡åˆè¡·ä¸æ˜¯ä¸ºäº†å­˜å‚¨å¤§é‡å¯¹è±¡è€Œè®¾è®¡çš„ï¼Œä¸å¯æ»¥ç”¨ï¼Œä¸å¯å°† hash ä½œä¸ºå¯¹è±¡åˆ—è¡¨ä½¿ç”¨ hgetall æ“ä½œå¯ä»¥è·å–å…¨éƒ¨å±æ€§ï¼Œå¦‚æœå†…éƒ¨ field è¿‡å¤šï¼Œéå†æ•´ä½“æ•°æ®æ•ˆç‡å°±å¾ˆä¼šä½ï¼Œæœ‰å¯èƒ½æˆä¸ºæ•°æ®è®¿é—®ç“¶é¢ˆ å®ç°å“ˆå¸Œå¯¹è±¡çš„å†…éƒ¨ç¼–ç æœ‰ä¸¤ç§ï¼šziplistï¼ˆå‹ç¼©åˆ—è¡¨ï¼‰ã€hashtableï¼ˆå“ˆå¸Œè¡¨ã€å­—å…¸ï¼‰ å‹ç¼©åˆ—è¡¨å®ç°å“ˆå¸Œå¯¹è±¡ï¼šåŒä¸€é”®å€¼å¯¹çš„èŠ‚ç‚¹æ€»æ˜¯æŒ¨åœ¨ä¸€èµ·ï¼Œä¿å­˜é”®çš„èŠ‚ç‚¹åœ¨å‰ï¼Œä¿å­˜å€¼çš„èŠ‚ç‚¹åœ¨å å­—å…¸å®ç°å“ˆå¸Œå¯¹è±¡ï¼šå­—å…¸çš„æ¯ä¸€ä¸ªé”®éƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œæ¯ä¸ªå€¼ä¹Ÿæ˜¯ å½“å­˜å‚¨çš„æ•°æ®é‡æ¯”è¾ƒå°çš„æƒ…å†µä¸‹ï¼ŒRedis æ‰ä½¿ç”¨å‹ç¼©åˆ—è¡¨æ¥å®ç°å­—å…¸ç±»å‹ï¼Œå…·ä½“éœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š å½“é”®å€¼å¯¹æ•°é‡å°äº hash-max-ziplist-entries é…ç½®ï¼ˆé»˜è®¤ 512 ä¸ªï¼‰ æ‰€æœ‰é”®å’Œå€¼çš„é•¿åº¦éƒ½å°äº hash-max-ziplist-value é…ç½®ï¼ˆé»˜è®¤ 64 å­—èŠ‚ï¼‰ ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶çš„ä¸Šé™å€¼æ˜¯å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶ä¿®æ”¹çš„ï¼Œå½“ä¸¤ä¸ªæ¡ä»¶çš„ä»»æ„ä¸€ä¸ªä¸èƒ½è¢«æ»¡è¶³æ—¶ï¼Œå¯¹è±¡çš„ç¼–ç è½¬æ¢æ“ä½œå°±ä¼šè¢«æ‰§è¡Œ ziplist ä½¿ç”¨æ›´åŠ ç´§å‡‘çš„ç»“æ„å®ç°å¤šä¸ªå…ƒç´ çš„è¿ç»­å­˜å‚¨ï¼Œæ‰€ä»¥åœ¨èŠ‚çœå†…å­˜æ–¹é¢æ¯” hashtable æ›´åŠ ä¼˜ç§€ï¼Œå½“ ziplist æ— æ³•æ»¡è¶³å“ˆå¸Œç±»å‹æ—¶ï¼ŒRedis ä¼šä½¿ç”¨ hashtable ä½œä¸ºå“ˆå¸Œçš„å†…éƒ¨å®ç°ï¼Œå› ä¸ºæ­¤æ—¶ ziplist çš„è¯»å†™æ•ˆç‡ä¼šä¸‹é™ï¼Œè€Œ hashtable çš„è¯»å†™æ—¶é—´å¤æ‚åº¦ä¸º O(1) åº”ç”¨1user:id:3506728370 â†’ &#123;&quot;name&quot;:&quot;æ˜¥æ™š&quot;,&quot;fans&quot;:12210862,&quot;blogs&quot;:83&#125; å¯¹äºä»¥ä¸Šæ•°æ®ï¼Œä½¿ç”¨å•æ¡å»å­˜çš„è¯ï¼Œå­˜çš„æ¡æ•°ä¼šå¾ˆå¤šã€‚ä½†å¦‚æœç”¨ json æ ¼å¼ï¼Œå­˜ä¸€æ¡æ•°æ®å°±å¤Ÿäº†ã€‚ å‡å¦‚ç°åœ¨ç²‰ä¸æ•°é‡å‘ç”Ÿäº†å˜åŒ–ï¼Œè¦æŠŠæ•´ä¸ªå€¼éƒ½æ”¹å˜ï¼Œä½†æ˜¯ç”¨å•æ¡å­˜å°±ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œåªéœ€è¦æ”¹å…¶ä¸­ä¸€ä¸ªå°±å¯ä»¥ å¯ä»¥å®ç°è´­ç‰©è½¦çš„åŠŸèƒ½ï¼Œkey å¯¹åº”ç€æ¯ä¸ªç”¨æˆ·ï¼Œå­˜å‚¨ç©ºé—´å­˜å‚¨è´­ç‰©è½¦çš„ä¿¡æ¯ listç®€ä»‹æ•°æ®å­˜å‚¨éœ€æ±‚ï¼šå­˜å‚¨å¤šä¸ªæ•°æ®ï¼Œå¹¶å¯¹æ•°æ®è¿›å…¥å­˜å‚¨ç©ºé—´çš„é¡ºåºè¿›è¡ŒåŒºåˆ† æ•°æ®å­˜å‚¨ç»“æ„ï¼šä¸€ä¸ªå­˜å‚¨ç©ºé—´ä¿å­˜å¤šä¸ªæ•°æ®ï¼Œä¸”é€šè¿‡æ•°æ®å¯ä»¥ä½“ç°è¿›å…¥é¡ºåºï¼Œå…è®¸é‡å¤å…ƒç´  list ç±»å‹ï¼šä¿å­˜å¤šä¸ªæ•°æ®ï¼Œåº•å±‚ä½¿ç”¨åŒå‘é“¾è¡¨å­˜å‚¨ç»“æ„å®ç°ï¼Œç±»ä¼¼äº LinkedList å¦‚æœä¸¤ç«¯éƒ½èƒ½å­˜å–æ•°æ®çš„è¯ï¼Œè¿™å°±æ˜¯åŒç«¯é˜Ÿåˆ—ï¼Œå¦‚æœåªèƒ½ä»ä¸€ç«¯è¿›ä¸€ç«¯å‡ºï¼Œè¿™ä¸ªæ¨¡å‹å«æ ˆ æ“ä½œæŒ‡ä»¤æ“ä½œï¼š æ•°æ®æ“ä½œ 12345lpush key value1 [value2]...#ä»å·¦è¾¹æ·»åŠ /ä¿®æ”¹æ•°æ®(è¡¨å¤´)rpush key value1 [value2]...#ä»å³è¾¹æ·»åŠ /ä¿®æ”¹æ•°æ®(è¡¨å°¾)lpop key #ä»å·¦è¾¹è·å–å¹¶ç§»é™¤ç¬¬ä¸€ä¸ªæ•°æ®ï¼Œç±»ä¼¼äºå‡ºæ ˆ/å‡ºé˜Ÿrpop key #ä»å³è¾¹è·å–å¹¶ç§»é™¤ç¬¬ä¸€ä¸ªæ•°æ®lrem key count value #åˆ é™¤æŒ‡å®šæ•°æ®ï¼Œcount=2åˆ é™¤2ä¸ªï¼Œè¯¥valueå¯èƒ½æœ‰å¤šä¸ª(é‡å¤æ•°æ®) æŸ¥è¯¢æ“ä½œ 123lrange key start stop #ä»å·¦è¾¹éå†æ•°æ®å¹¶æŒ‡å®šå¼€å§‹å’Œç»“æŸç´¢å¼•ï¼Œ0æ˜¯ç¬¬ä¸€ä¸ªç´¢å¼•ï¼Œ-1æ˜¯ç»ˆç´¢å¼•lindex key index #è·å–æŒ‡å®šç´¢å¼•æ•°æ®ï¼Œæ²¡æœ‰åˆ™ä¸ºnilï¼Œæ²¡æœ‰ç´¢å¼•è¶Šç•Œllen key #listä¸­æ•°æ®é•¿åº¦/ä¸ªæ•° è§„å®šæ—¶é—´å†…è·å–å¹¶ç§»é™¤æ•°æ® 1234b #ä»£è¡¨é˜»å¡blpop key1 [key2] timeout #åœ¨æŒ‡å®šæ—¶é—´å†…è·å–æŒ‡å®škey(å¯ä»¥å¤šä¸ª)çš„æ•°æ®ï¼Œè¶…æ—¶åˆ™ä¸º(nil) #å¯ä»¥ä»å…¶ä»–å®¢æˆ·ç«¯å†™æ•°æ®ï¼Œå½“å‰å®¢æˆ·ç«¯é˜»å¡è¯»å–æ•°æ®brpop key1 [key2] timeout #ä»å³è¾¹æ“ä½œ å¤åˆ¶æ“ä½œ 1brpoplpush source destination timeout #ä»sourceè·å–æ•°æ®æ”¾å…¥destinationï¼Œå‡å¦‚åœ¨æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰ä»»ä½•å…ƒç´ è¢«å¼¹å‡ºï¼Œåˆ™è¿”å›ä¸€ä¸ªnilå’Œç­‰å¾…æ—¶é•¿ã€‚åä¹‹ï¼Œè¿”å›ä¸€ä¸ªå«æœ‰ä¸¤ä¸ªå…ƒç´ çš„åˆ—è¡¨ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯è¢«å¼¹å‡ºå…ƒç´ çš„å€¼ï¼Œç¬¬äºŒä¸ªå…ƒç´ æ˜¯ç­‰å¾…æ—¶é•¿ æ³¨æ„äº‹é¡¹ list ä¸­ä¿å­˜çš„æ•°æ®éƒ½æ˜¯ string ç±»å‹çš„ï¼Œæ•°æ®æ€»å®¹é‡æ˜¯æœ‰é™çš„ï¼Œæœ€å¤š 2^32 - 1 ä¸ªå…ƒç´ ï¼ˆ4294967295ï¼‰ list å…·æœ‰ç´¢å¼•çš„æ¦‚å¿µï¼Œä½†æ“ä½œæ•°æ®æ—¶é€šå¸¸ä»¥é˜Ÿåˆ—çš„å½¢å¼è¿›è¡Œå…¥é˜Ÿå‡ºé˜Ÿï¼Œæˆ–ä»¥æ ˆçš„å½¢å¼è¿›è¡Œå…¥æ ˆå‡ºæ ˆ è·å–å…¨éƒ¨æ•°æ®æ“ä½œç»“æŸç´¢å¼•è®¾ç½®ä¸º -1 list å¯ä»¥å¯¹æ•°æ®è¿›è¡Œåˆ†é¡µæ“ä½œï¼Œé€šå¸¸ç¬¬ä¸€é¡µçš„ä¿¡æ¯æ¥è‡ªäº listï¼Œç¬¬ 2 é¡µåŠæ›´å¤šçš„ä¿¡æ¯é€šè¿‡æ•°æ®åº“çš„å½¢å¼åŠ è½½ å®ç°åœ¨ Redis3.2 ç‰ˆæœ¬ä»¥å‰åˆ—è¡¨å¯¹è±¡çš„å†…éƒ¨ç¼–ç æœ‰ä¸¤ç§ï¼šziplistï¼ˆå‹ç¼©åˆ—è¡¨ï¼‰å’Œ linkedlistï¼ˆé“¾è¡¨ï¼‰ å‹ç¼©åˆ—è¡¨å®ç°çš„åˆ—è¡¨å¯¹è±¡ï¼šPUSH 1ã€threeã€5 ä¸‰ä¸ªå…ƒç´  é“¾è¡¨å®ç°çš„åˆ—è¡¨å¯¹è±¡ï¼šä¸ºäº†ç®€åŒ–å­—ç¬¦ä¸²å¯¹è±¡çš„è¡¨ç¤ºï¼Œä½¿ç”¨äº† StringObject çš„ç»“æ„ï¼Œåº•å±‚å…¶å®æ˜¯ sdshdr ç»“æ„ åˆ—è¡¨ä¸­å­˜å‚¨çš„æ•°æ®é‡æ¯”è¾ƒå°çš„æ—¶å€™ï¼Œåˆ—è¡¨å°±ä¼šä½¿ç”¨ä¸€å—è¿ç»­çš„å†…å­˜å­˜å‚¨ï¼Œé‡‡ç”¨å‹ç¼©åˆ—è¡¨çš„æ–¹å¼å®ç°çš„æ¡ä»¶ï¼š åˆ—è¡¨å¯¹è±¡ä¿å­˜çš„æ‰€æœ‰å­—ç¬¦ä¸²å…ƒç´ çš„é•¿åº¦éƒ½å°äº 64 å­—èŠ‚ åˆ—è¡¨å¯¹è±¡ä¿å­˜çš„å…ƒç´ æ•°é‡å°äº 512 ä¸ª ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶çš„ä¸Šé™å€¼æ˜¯å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶ä¿®æ”¹çš„ï¼Œå½“ä¸¤ä¸ªæ¡ä»¶çš„ä»»æ„ä¸€ä¸ªä¸èƒ½è¢«æ»¡è¶³æ—¶ï¼Œå¯¹è±¡çš„ç¼–ç è½¬æ¢æ“ä½œå°±ä¼šè¢«æ‰§è¡Œ åœ¨ Redis3.2 ç‰ˆæœ¬ ä»¥åå¯¹åˆ—è¡¨æ•°æ®ç»“æ„è¿›è¡Œäº†æ”¹é€ ï¼Œä½¿ç”¨ quicklistï¼ˆå¿«é€Ÿåˆ—è¡¨ï¼‰ä»£æ›¿äº† linkedlistï¼Œquicklist å®é™…ä¸Šæ˜¯ ziplist å’Œ linkedlist çš„æ··åˆä½“ï¼Œå°† linkedlist æŒ‰æ®µåˆ‡åˆ†ï¼Œæ¯ä¸€æ®µä½¿ç”¨ ziplist æ¥ç´§å‡‘å­˜å‚¨ï¼Œå¤šä¸ª ziplist ä¹‹é—´ä½¿ç”¨åŒå‘æŒ‡é’ˆä¸²æ¥èµ·æ¥ï¼Œæ—¢æ»¡è¶³äº†å¿«é€Ÿçš„æ’å…¥åˆ é™¤æ€§èƒ½ï¼Œåˆä¸ä¼šå‡ºç°å¤ªå¤§çš„ç©ºé—´å†—ä½™ åº”ç”¨ä¼ä¸šè¿è¥è¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿå°†äº§ç”Ÿå‡ºå¤§é‡çš„è¿è¥æ•°æ®ï¼Œå¦‚ä½•ä¿éšœå¤šå°æœåŠ¡å™¨æ“ä½œæ—¥å¿—çš„ç»Ÿä¸€é¡ºåºè¾“å‡ºï¼Ÿ ä¾èµ– list çš„æ•°æ®å…·æœ‰é¡ºåºçš„ç‰¹å¾å¯¹ä¿¡æ¯è¿›è¡Œç®¡ç†ï¼Œå³è¿›å·¦æŸ¥æˆ–è€…å·¦è¿‘å·¦æŸ¥ ä½¿ç”¨é˜Ÿåˆ—æ¨¡å‹è§£å†³å¤šè·¯ä¿¡æ¯æ±‡æ€»åˆå¹¶çš„é—®é¢˜ ä½¿ç”¨æ ˆæ¨¡å‹è§£å†³æœ€æ–°æ¶ˆæ¯çš„é—®é¢˜ å¾®ä¿¡æ–‡ç« è®¢é˜…å…¬ä¼—å·ï¼š æ¯”å¦‚è®¢é˜…äº†ä¸¤ä¸ªå…¬ä¼—å·ï¼Œå®ƒä»¬å‘å¸ƒäº†ä¸¤ç¯‡æ–‡ç« ï¼Œæ–‡ç«  ID åˆ†åˆ«ä¸º 666 å’Œ 888ï¼Œå¯ä»¥é€šè¿‡æ‰§è¡Œ LPUSH key 666 888 å‘½ä»¤æ¨é€ç»™æˆ‘ setç®€ä»‹æ•°æ®å­˜å‚¨éœ€æ±‚ï¼šå­˜å‚¨å¤§é‡çš„æ•°æ®ï¼Œåœ¨æŸ¥è¯¢æ–¹é¢æä¾›æ›´é«˜çš„æ•ˆç‡ æ•°æ®å­˜å‚¨ç»“æ„ï¼šèƒ½å¤Ÿä¿å­˜å¤§é‡çš„æ•°æ®ï¼Œé«˜æ•ˆçš„å†…éƒ¨å­˜å‚¨æœºåˆ¶ï¼Œä¾¿äºæŸ¥è¯¢ set ç±»å‹ï¼šä¸ hash å­˜å‚¨ç»“æ„å“ˆå¸Œè¡¨å®Œå…¨ç›¸åŒï¼Œåªæ˜¯ä»…å­˜å‚¨é”®ä¸å­˜å‚¨å€¼ï¼ˆnilï¼‰ï¼Œæ‰€ä»¥æ·»åŠ ï¼Œåˆ é™¤ï¼ŒæŸ¥æ‰¾çš„å¤æ‚åº¦éƒ½æ˜¯ O(1)ï¼Œå¹¶ä¸”å€¼æ˜¯ä¸å…è®¸é‡å¤ä¸”æ— åºçš„ æ“ä½œæŒ‡ä»¤æ“ä½œï¼š æ•°æ®æ“ä½œ 12sadd key member1 [member2] #æ·»åŠ æ•°æ®srem key member1 [member2] #åˆ é™¤æ•°æ® æŸ¥è¯¢æ“ä½œ 123smembers key #è·å–å…¨éƒ¨æ•°æ®scard key #è·å–é›†åˆæ•°æ®æ€»é‡sismember key member #åˆ¤æ–­é›†åˆä¸­æ˜¯å¦åŒ…å«æŒ‡å®šæ•°æ® éšæœºæ“ä½œ 12345678910111213 spop key [count] #éšæœºè·å–é›†ä¸­çš„æŸä¸ªæ•°æ®å¹¶å°†è¯¥æ•°æ®ç§»é™¤é›†åˆ srandmember key [count] #éšæœºè·å–é›†åˆä¸­æŒ‡å®š(æ•°é‡)çš„æ•°æ®* é›†åˆçš„äº¤ã€å¹¶ã€å·® ```sh sinter key1 [key2...] #ä¸¤ä¸ªé›†åˆçš„äº¤é›†ï¼Œä¸å­˜åœ¨ä¸º(empty list or set) sunion key1 [key2...] #ä¸¤ä¸ªé›†åˆçš„å¹¶é›† sdiff key1 [key2...] #ä¸¤ä¸ªé›†åˆçš„å·®é›† sinterstore destination key1 [key2...] #ä¸¤ä¸ªé›†åˆçš„äº¤é›†å¹¶å­˜å‚¨åˆ°æŒ‡å®šé›†åˆä¸­ sunionstore destination key1 [key2...] #ä¸¤ä¸ªé›†åˆçš„å¹¶é›†å¹¶å­˜å‚¨åˆ°æŒ‡å®šé›†åˆä¸­ sdiffstore destination key1 [key2...] #ä¸¤ä¸ªé›†åˆçš„å·®é›†å¹¶å­˜å‚¨åˆ°æŒ‡å®šé›†åˆä¸­ å¤åˆ¶ 1smove source destination member #å°†æŒ‡å®šæ•°æ®ä»åŸå§‹é›†åˆä¸­ç§»åŠ¨åˆ°ç›®æ ‡é›†åˆä¸­ æ³¨æ„äº‹é¡¹ set ç±»å‹ä¸å…è®¸æ•°æ®é‡å¤ï¼Œå¦‚æœæ·»åŠ çš„æ•°æ®åœ¨ set ä¸­å·²ç»å­˜åœ¨ï¼Œå°†åªä¿ç•™ä¸€ä»½ set è™½ç„¶ä¸ hash çš„å­˜å‚¨ç»“æ„ç›¸åŒï¼Œä½†æ˜¯æ— æ³•å¯ç”¨ hash ä¸­å­˜å‚¨å€¼çš„ç©ºé—´ å®ç°é›†åˆå¯¹è±¡çš„å†…éƒ¨ç¼–ç æœ‰ä¸¤ç§ï¼šintsetï¼ˆæ•´æ•°é›†åˆï¼‰ã€hashtableï¼ˆå“ˆå¸Œè¡¨ã€å­—å…¸ï¼‰ æ•´æ•°é›†åˆå®ç°çš„é›†åˆå¯¹è±¡ï¼š å­—å…¸å®ç°çš„é›†åˆå¯¹è±¡ï¼šé”®å€¼å¯¹çš„å€¼ä¸º NULL å½“é›†åˆå¯¹è±¡å¯ä»¥åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œå¯¹è±¡ä½¿ç”¨ intset ç¼–ç ï¼š é›†åˆä¸­çš„å…ƒç´ éƒ½æ˜¯æ•´æ•°å€¼ é›†åˆä¸­çš„å…ƒç´ æ•°é‡å°äº set-maxintset-entriesé…ç½®ï¼ˆé»˜è®¤ 512 ä¸ªï¼‰ ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶çš„ä¸Šé™å€¼æ˜¯å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶ä¿®æ”¹çš„ åº”ç”¨åº”ç”¨åœºæ™¯ï¼š é»‘åå•ï¼šèµ„è®¯ç±»ä¿¡æ¯ç±»ç½‘ç«™è¿½æ±‚é«˜è®¿é—®é‡ï¼Œä½†æ˜¯ç”±äºå…¶ä¿¡æ¯çš„ä»·å€¼ï¼Œå¾€å¾€å®¹æ˜“è¢«ä¸æ³•åˆ†å­åˆ©ç”¨ï¼Œé€šè¿‡çˆ¬è™«æŠ€æœ¯ï¼Œå¿«é€Ÿè·å–ä¿¡æ¯ï¼Œä¸ªåˆ«ç‰¹ç§è¡Œä¸šç½‘ç«™ä¿¡æ¯é€šè¿‡çˆ¬è™«è·å–åˆ†æåï¼Œå¯ä»¥è½¬æ¢æˆå•†ä¸šæœºå¯†ã€‚ æ³¨æ„ï¼šçˆ¬è™«ä¸ä¸€å®šåšæ‘§æ¯æ€§çš„å·¥ä½œï¼Œæœ‰äº›å°å‹ç½‘ç«™éœ€è¦çˆ¬è™«ä¸ºå…¶å¸¦æ¥ä¸€äº›æµé‡ã€‚ ç™½åå•ï¼šå¯¹äºå®‰å…¨æ€§æ›´é«˜çš„åº”ç”¨è®¿é—®ï¼Œä»…ä»…é é»‘åå•æ˜¯ä¸èƒ½è§£å†³å®‰å…¨é—®é¢˜çš„ï¼Œæ­¤æ—¶éœ€è¦è®¾å®šå¯è®¿é—®çš„ç”¨æˆ·ç¾¤ä½“ï¼Œ ä¾èµ–ç™½åå•åšæ›´ä¸ºè‹›åˆ»çš„è®¿é—®éªŒè¯ éšæœºæ“ä½œå¯ä»¥å®ç°æŠ½å¥–åŠŸèƒ½ é›†åˆçš„äº¤å¹¶è¡¥å¯ä»¥å®ç°å¾®åšå…±åŒå…³æ³¨çš„æŸ¥çœ‹ï¼Œå¯ä»¥æ ¹æ®å…±åŒå…³æ³¨æˆ–è€…å…±åŒå–œæ¬¢æ¨èç›¸å…³å†…å®¹ zsetç®€ä»‹æ•°æ®å­˜å‚¨éœ€æ±‚ï¼šæ•°æ®æ’åºæœ‰åˆ©äºæ•°æ®çš„æœ‰æ•ˆå±•ç¤ºï¼Œéœ€è¦æä¾›ä¸€ç§å¯ä»¥æ ¹æ®è‡ªèº«ç‰¹å¾è¿›è¡Œæ’åºçš„æ–¹å¼ æ•°æ®å­˜å‚¨ç»“æ„ï¼šæ–°çš„å­˜å‚¨æ¨¡å‹ï¼Œå¯ä»¥ä¿å­˜å¯æ’åºçš„æ•°æ® æ“ä½œæŒ‡ä»¤æ“ä½œï¼š æ•°æ®æ“ä½œ 123456zadd key score1 member1 [score2 member2] #æ·»åŠ æ•°æ®zrem key member [member ...] #åˆ é™¤æ•°æ®zremrangebyrank key start stop #åˆ é™¤æŒ‡å®šç´¢å¼•èŒƒå›´çš„æ•°æ®zremrangebyscore key min max #åˆ é™¤æŒ‡å®šåˆ†æ•°åŒºé—´å†…çš„æ•°æ®zscore key member #è·å–æŒ‡å®šå€¼çš„åˆ†æ•°zincrby key increment member #æŒ‡å®šå€¼çš„åˆ†æ•°å¢åŠ increment æŸ¥è¯¢æ“ä½œ 12345678910zrange key start stop [WITHSCORES] #è·å–æŒ‡å®šèŒƒå›´çš„æ•°æ®ï¼Œå‡åºï¼ŒWITHSCORES ä»£è¡¨æ˜¾ç¤ºåˆ†æ•°zrevrange key start stop [WITHSCORES] #è·å–æŒ‡å®šèŒƒå›´çš„æ•°æ®ï¼Œé™åºzrangebyscore key min max [WITHSCORES] [LIMIT offset count] #æŒ‰æ¡ä»¶è·å–æ•°æ®ï¼Œä»å°åˆ°å¤§zrevrangebyscore key max min [WITHSCORES] [...] #ä»å¤§åˆ°å°zcard key #è·å–é›†åˆæ•°æ®çš„æ€»é‡zcount key min max #è·å–æŒ‡å®šåˆ†æ•°åŒºé—´å†…çš„æ•°æ®æ€»é‡zrank key member #è·å–æ•°æ®å¯¹åº”çš„ç´¢å¼•ï¼ˆæ’åï¼‰å‡åºzrevrank key member #è·å–æ•°æ®å¯¹åº”çš„ç´¢å¼•ï¼ˆæ’åï¼‰é™åº min ä¸ max ç”¨äºé™å®šæœç´¢æŸ¥è¯¢çš„æ¡ä»¶ start ä¸ stop ç”¨äºé™å®šæŸ¥è¯¢èŒƒå›´ï¼Œä½œç”¨äºç´¢å¼•ï¼Œè¡¨ç¤ºå¼€å§‹å’Œç»“æŸç´¢å¼• offset ä¸ count ç”¨äºé™å®šæŸ¥è¯¢èŒƒå›´ï¼Œä½œç”¨äºæŸ¥è¯¢ç»“æœï¼Œè¡¨ç¤ºå¼€å§‹ä½ç½®å’Œæ•°æ®æ€»é‡ é›†åˆçš„äº¤ã€å¹¶æ“ä½œ 12zinterstore destination numkeys key [key ...] #ä¸¤ä¸ªé›†åˆçš„äº¤é›†å¹¶å­˜å‚¨åˆ°æŒ‡å®šé›†åˆä¸­zunionstore destination numkeys key [key ...] #ä¸¤ä¸ªé›†åˆçš„å¹¶é›†å¹¶å­˜å‚¨åˆ°æŒ‡å®šé›†åˆä¸­ æ³¨æ„äº‹é¡¹ï¼š score ä¿å­˜çš„æ•°æ®å­˜å‚¨ç©ºé—´æ˜¯ 64 ä½ï¼Œå¦‚æœæ˜¯æ•´æ•°èŒƒå›´æ˜¯ -9007199254740992~9007199254740992 score ä¿å­˜çš„æ•°æ®ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªåŒç²¾åº¦çš„ double å€¼ï¼ŒåŸºäºåŒç²¾åº¦æµ®ç‚¹æ•°çš„ç‰¹å¾å¯èƒ½ä¼šä¸¢å¤±ç²¾åº¦ï¼Œæ…é‡ä½¿ç”¨ sorted_set åº•å±‚å­˜å‚¨è¿˜æ˜¯åŸºäº set ç»“æ„çš„ï¼Œå› æ­¤æ•°æ®ä¸èƒ½é‡å¤ï¼Œå¦‚æœé‡å¤æ·»åŠ ç›¸åŒçš„æ•°æ®ï¼Œscore å€¼å°†è¢«åå¤è¦†ç›–ï¼Œä¿ç•™æœ€åä¸€æ¬¡ä¿®æ”¹çš„ç»“æœ å®ç°æœ‰åºé›†åˆå¯¹è±¡çš„å†…éƒ¨ç¼–ç æœ‰ä¸¤ç§ï¼šziplistï¼ˆå‹ç¼©åˆ—è¡¨ï¼‰å’Œ skiplistï¼ˆè·³è·ƒè¡¨ï¼‰ å‹ç¼©åˆ—è¡¨å®ç°æœ‰åºé›†åˆå¯¹è±¡ï¼šziplist æœ¬èº«æ˜¯æœ‰åºã€ä¸å¯é‡å¤çš„ï¼Œç¬¦åˆæœ‰åºé›†åˆçš„ç‰¹æ€§ è·³è·ƒè¡¨å®ç°æœ‰åºé›†åˆå¯¹è±¡ï¼šåº•å±‚æ˜¯ zset ç»“æ„ï¼Œzset åŒæ—¶åŒ…å«å­—å…¸å’Œè·³è·ƒè¡¨çš„ç»“æ„ï¼Œå›¾ç¤ºå­—å…¸å’Œè·³è·ƒè¡¨ä¸­é‡å¤å±•ç¤ºäº†å„ä¸ªå…ƒç´ çš„æˆå‘˜å’Œåˆ†å€¼ï¼Œä½†å®é™…ä¸Šä¸¤è€…ä¼šé€šè¿‡æŒ‡é’ˆæ¥å…±äº«ç›¸åŒå…ƒç´ çš„æˆå‘˜å’Œåˆ†å€¼ï¼Œä¸ä¼šäº§ç”Ÿç©ºé—´æµªè´¹ 1234typedef struct zset &#123; zskiplist *zsl; dict *dict;&#125; zset; ä½¿ç”¨å­—å…¸åŠ è·³è·ƒè¡¨çš„ä¼˜åŠ¿ï¼š å­—å…¸ä¸ºæœ‰åºé›†åˆåˆ›å»ºäº†ä¸€ä¸ªä»æˆå‘˜åˆ°åˆ†å€¼çš„æ˜ å°„ï¼Œç”¨ O(1) å¤æ‚åº¦æŸ¥æ‰¾ç»™å®šæˆå‘˜çš„åˆ†å€¼ æ’åºæ“ä½œä½¿ç”¨è·³è·ƒè¡¨å®Œæˆï¼ŒèŠ‚çœæ¯æ¬¡é‡æ–°æ’åºå¸¦æ¥çš„æ—¶é—´æˆæœ¬å’Œç©ºé—´æˆæœ¬ ä½¿ç”¨ ziplist æ ¼å¼å­˜å‚¨éœ€è¦æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š æœ‰åºé›†åˆä¿å­˜çš„å…ƒç´ ä¸ªæ•°è¦å°äº 128 ä¸ªï¼› æœ‰åºé›†åˆä¿å­˜çš„æ‰€æœ‰å…ƒç´ å¤§å°éƒ½å°äº 64 å­—èŠ‚ å½“å…ƒç´ æ¯”è¾ƒå¤šæ—¶ï¼Œæ­¤æ—¶ ziplist çš„è¯»å†™æ•ˆç‡ä¼šä¸‹é™ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ O(n)ï¼Œè·³è¡¨çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(logn) ä¸ºä»€ä¹ˆç”¨è·³è¡¨è€Œä¸ç”¨å¹³è¡¡æ ‘ï¼Ÿ åœ¨åšèŒƒå›´æŸ¥æ‰¾çš„æ—¶å€™ï¼Œè·³è¡¨æ“ä½œç®€å•ï¼ˆå‰è¿›æŒ‡é’ˆæˆ–åé€€æŒ‡é’ˆï¼‰ï¼Œå¹³è¡¡æ ‘éœ€è¦å›æ—‹æŸ¥æ‰¾ è·³è¡¨æ¯”å¹³è¡¡æ ‘å®ç°ç®€å•ï¼Œå¹³è¡¡æ ‘çš„æ’å…¥å’Œåˆ é™¤æ“ä½œå¯èƒ½å¼•å‘å­æ ‘çš„æ—‹è½¬è°ƒæ•´ï¼Œè€Œè·³è¡¨çš„æ’å…¥å’Œåˆ é™¤åªéœ€è¦ä¿®æ”¹ç›¸é‚»èŠ‚ç‚¹çš„æŒ‡é’ˆ åº”ç”¨ æ’è¡Œæ¦œ å¯¹äºåŸºäºæ—¶é—´çº¿é™å®šçš„ä»»åŠ¡å¤„ç†ï¼Œå°†å¤„ç†æ—¶é—´è®°å½•ä¸º score å€¼ï¼Œåˆ©ç”¨æ’åºåŠŸèƒ½åŒºåˆ†å¤„ç†çš„å…ˆåé¡ºåº å½“ä»»åŠ¡æˆ–è€…æ¶ˆæ¯å¾…å¤„ç†ï¼Œå½¢æˆäº†ä»»åŠ¡é˜Ÿåˆ—æˆ–æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œå¯¹äºé«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡è¦ä¿éšœå¯¹å…¶ä¼˜å…ˆå¤„ç†ï¼Œé‡‡ç”¨ score è®°å½•æƒé‡ BitmapsåŸºæœ¬æ“ä½œBitmaps æ˜¯äºŒè¿›åˆ¶ä½æ•°ç»„ï¼ˆbit arrayï¼‰ï¼Œåº•å±‚ä½¿ç”¨ SDS å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œå› ä¸º SDS æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ buf æ•°ç»„çš„æ¯ä¸ªå­—èŠ‚ç”¨ä¸€è¡Œè¡¨ç¤ºï¼Œbuf[1] æ˜¯ &#39;\\0&#39;ï¼Œä¿å­˜ä½æ•°ç»„çš„é¡ºåºå’Œä¹¦å†™ä½æ•°ç»„çš„é¡ºåºæ˜¯å®Œå…¨ç›¸åçš„ï¼Œå›¾ç¤ºçš„ä½æ•°ç»„ 0100 1101 æ•°æ®ç»“æ„çš„è¯¦è§£æŸ¥çœ‹ Java â†’ Algorithm â†’ ä½å›¾ å‘½ä»¤å®ç°GETBITGETBIT å‘½ä»¤è·å–ä½æ•°ç»„ bitarray åœ¨ offset åç§»é‡ä¸Šçš„äºŒè¿›åˆ¶ä½çš„å€¼ 1GETBIT &lt;bitarray&gt; &lt;offset&gt; æ‰§è¡Œè¿‡ç¨‹ï¼š è®¡ç®— byte = offset/8ï¼ˆå‘ä¸‹å–æ•´ï¼‰, byte å€¼è®°å½•æ•°æ®ä¿å­˜åœ¨ä½æ•°ç»„ä¸­çš„ç´¢å¼• è®¡ç®— bit = (offset mod 8) + 1ï¼Œbit å€¼è®°å½•æ•°æ®åœ¨ä½æ•°ç»„ä¸­çš„ç¬¬å‡ ä¸ªäºŒè¿›åˆ¶ä½ æ ¹æ® byte å’Œ bit å€¼ï¼Œåœ¨ä½æ•°ç»„ bitarray ä¸­å®šä½ offset åç§»é‡æŒ‡å®šçš„äºŒè¿›åˆ¶ä½ï¼Œå¹¶è¿”å›è¿™ä¸ªä½çš„å€¼ GETBIT å‘½ä»¤æ‰§è¡Œçš„æ‰€æœ‰æ“ä½œéƒ½å¯ä»¥åœ¨å¸¸æ•°æ—¶é—´å†…å®Œæˆï¼Œæ‰€ä»¥æ—¶é—´å¤æ‚åº¦ä¸º O(1) SETBITSETBIT å°†ä½æ•°ç»„ bitarray åœ¨ offset åç§»é‡ä¸Šçš„äºŒè¿›åˆ¶ä½çš„å€¼è®¾ç½®ä¸º valueï¼Œå¹¶å‘å®¢æˆ·ç«¯è¿”å›äºŒè¿›åˆ¶ä½çš„æ—§å€¼ 1SETBIT &lt;bitarray&gt; &lt;offset&gt; &lt;value&gt; æ‰§è¡Œè¿‡ç¨‹ï¼š è®¡ç®— len = offset/8 + 1ï¼Œlen å€¼è®°å½•äº†ä¿å­˜è¯¥æ•°æ®è‡³å°‘éœ€è¦å¤šå°‘ä¸ªå­—èŠ‚ æ£€æŸ¥ bitarray é”®ä¿å­˜çš„ä½æ•°ç»„çš„é•¿åº¦æ˜¯å¦å°äº lenï¼Œæˆç«‹å°±ä¼šå°† SDS æ‰©å±•ä¸º len å­—èŠ‚ï¼ˆæ³¨æ„ç©ºé—´é¢„åˆ†é…æœºåˆ¶ï¼‰ï¼Œæ‰€æœ‰æ–°æ‰©å±•ç©ºé—´çš„äºŒè¿›åˆ¶ä½çš„å€¼ç½®ä¸º 0 è®¡ç®— byte = offset/8ï¼ˆå‘ä¸‹å–æ•´ï¼‰, byte å€¼è®°å½•æ•°æ®ä¿å­˜åœ¨ä½æ•°ç»„ä¸­çš„ç´¢å¼• è®¡ç®— bit = (offset mod 8) + 1ï¼Œbit å€¼è®°å½•æ•°æ®åœ¨ä½æ•°ç»„ä¸­çš„ç¬¬å‡ ä¸ªäºŒè¿›åˆ¶ä½ æ ¹æ® byte å’Œ bit å€¼ï¼Œåœ¨ä½æ•°ç»„ bitarray ä¸­å®šä½ offset åç§»é‡æŒ‡å®šçš„äºŒè¿›åˆ¶ä½ï¼Œé¦–å…ˆå°†æŒ‡å®šä½ç°å­˜çš„å€¼ä¿å­˜åœ¨ oldvalue å˜é‡ï¼Œç„¶åå°†æ–°å€¼ value è®¾ç½®ä¸ºè¿™ä¸ªäºŒè¿›åˆ¶ä½çš„å€¼ å‘å®¢æˆ·ç«¯è¿”å› oldvalue å˜é‡çš„å€¼ BITCOUNTBITCOUNT å‘½ä»¤ç”¨äºç»Ÿè®¡ç»™å®šä½æ•°ç»„ä¸­ï¼Œå€¼ä¸º 1 çš„äºŒè¿›åˆ¶ä½çš„æ•°é‡ 1BITCOUNT &lt;bitarray&gt; [start end] äºŒè¿›åˆ¶ä½ç»Ÿè®¡ç®—æ³•ï¼š éå†æ³•ï¼šéå†ä½æ•°ç»„ä¸­çš„æ¯ä¸ªäºŒè¿›åˆ¶ä½ æŸ¥è¡¨ç®—æ³•ï¼šè¯»å–æ¯ä¸ªå­—èŠ‚ï¼ˆ8 ä½ï¼‰çš„æ•°æ®ï¼ŒæŸ¥è¡¨è·å–æ•°å€¼å¯¹åº”çš„äºŒè¿›åˆ¶ä¸­æœ‰å‡ ä¸ª 1 variable-precision SWARç®—æ³•ï¼šè®¡ç®—æ±‰æ˜è·ç¦» Redis å®ç°ï¼š å¦‚æœäºŒè¿›åˆ¶ä½çš„æ•°é‡å¤§äºç­‰äº 128 ä½ï¼Œ é‚£ä¹ˆä½¿ç”¨ variable-precision SWAR ç®—æ³•æ¥è®¡ç®—äºŒè¿›åˆ¶ä½çš„æ±‰æ˜é‡é‡ å¦‚æœäºŒè¿›åˆ¶ä½çš„æ•°é‡å°äº 128 ä½ï¼Œé‚£ä¹ˆä½¿ç”¨æŸ¥è¡¨ç®—æ³•æ¥è®¡ç®—äºŒè¿›åˆ¶ä½çš„æ±‰æ˜é‡é‡ BITOPBITOP å‘½ä»¤å¯¹æŒ‡å®š key æŒ‰ä½è¿›è¡Œäº¤ã€å¹¶ã€éã€å¼‚æˆ–æ“ä½œï¼Œå¹¶å°†ç»“æœä¿å­˜åˆ°æŒ‡å®šçš„é”®ä¸­ 1BITOP OPTION destKey key1 [key2...] OPTION æœ‰ ANDï¼ˆä¸ï¼‰ã€ORï¼ˆæˆ–ï¼‰ã€ XORï¼ˆå¼‚æˆ–ï¼‰å’Œ NOTï¼ˆéï¼‰å››ä¸ªé€‰é¡¹ ANDã€ORã€XOR ä¸‰ä¸ªå‘½ä»¤å¯ä»¥æ¥å—å¤šä¸ªä½æ•°ç»„ä½œä¸ºè¾“å…¥ï¼Œéœ€è¦éå†è¾“å…¥çš„æ¯ä¸ªä½æ•°ç»„çš„æ¯ä¸ªå­—èŠ‚æ¥è¿›è¡Œè®¡ç®—ï¼Œæ‰€ä»¥å‘½ä»¤çš„å¤æ‚åº¦ä¸º O(n^2)ï¼›ä¸æ­¤ç›¸åï¼ŒNOT å‘½ä»¤åªæ¥å—ä¸€ä¸ªä½æ•°ç»„è¾“å…¥ï¼Œæ‰€ä»¥æ—¶é—´å¤æ‚åº¦ä¸º O(n) åº”ç”¨åœºæ™¯ è§£å†³ Redis ç¼“å­˜ç©¿é€ï¼Œåˆ¤æ–­ç»™å®šæ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œ é˜²æ­¢ç¼“å­˜ç©¿é€ åƒåœ¾é‚®ä»¶è¿‡æ»¤ï¼Œå¯¹æ¯ä¸€ä¸ªå‘é€é‚®ä»¶çš„åœ°å€è¿›è¡Œåˆ¤æ–­æ˜¯å¦åœ¨å¸ƒéš†çš„é»‘åå•ä¸­ï¼Œå¦‚æœåœ¨å°±åˆ¤æ–­ä¸ºåƒåœ¾é‚®ä»¶ çˆ¬è™«å»é‡ï¼Œçˆ¬ç»™å®šç½‘å€çš„æ—¶å€™å¯¹å·²ç»çˆ¬å–è¿‡çš„ URL å»é‡ ä¿¡æ¯çŠ¶æ€ç»Ÿè®¡ HyperåŸºæ•°æ˜¯æ•°æ®é›†å»é‡åå…ƒç´ ä¸ªæ•°ï¼ŒHyperLogLog æ˜¯ç”¨æ¥åšåŸºæ•°ç»Ÿè®¡çš„ï¼Œè¿ç”¨äº† LogLog çš„ç®—æ³• 12&#123;1, 3, 5, 7, 5, 7, 8&#125; åŸºæ•°é›†ï¼š &#123;1, 3, 5 ,7, 8&#125; åŸºæ•°ï¼š5&#123;1, 1, 1, 1, 1, 7, 1&#125; åŸºæ•°é›†ï¼š &#123;1,7&#125; åŸºæ•°ï¼š2 ç›¸å…³æŒ‡ä»¤ï¼š æ·»åŠ æ•°æ® 1pfadd key element [element ...] ç»Ÿè®¡æ•°æ® 1pfcount key [key ...] åˆå¹¶æ•°æ® 1pfmerge destkey sourcekey [sourcekey...] åº”ç”¨åœºæ™¯ï¼š ç”¨äºè¿›è¡ŒåŸºæ•°ç»Ÿè®¡ï¼Œä¸æ˜¯é›†åˆä¸ä¿å­˜æ•°æ®ï¼Œåªè®°å½•æ•°é‡è€Œä¸æ˜¯å…·ä½“æ•°æ®ï¼Œæ¯”å¦‚ç½‘ç«™çš„è®¿é—®é‡ æ ¸å¿ƒæ˜¯åŸºæ•°ä¼°ç®—ç®—æ³•ï¼Œæœ€ç»ˆæ•°å€¼å­˜åœ¨ä¸€å®šè¯¯å·® è¯¯å·®èŒƒå›´ï¼šåŸºæ•°ä¼°è®¡çš„ç»“æœæ˜¯ä¸€ä¸ªå¸¦æœ‰ 0.81% æ ‡å‡†é”™è¯¯çš„è¿‘ä¼¼å€¼ è€—ç©ºé—´æå°ï¼Œæ¯ä¸ª hyperloglog key å ç”¨äº†12Kçš„å†…å­˜ç”¨äºæ ‡è®°åŸºæ•° pfadd å‘½ä»¤ä¸æ˜¯ä¸€æ¬¡æ€§åˆ†é…12Kå†…å­˜ä½¿ç”¨ï¼Œä¼šéšç€åŸºæ•°çš„å¢åŠ å†…å­˜é€æ¸å¢å¤§ Pfmerge å‘½ä»¤åˆå¹¶åå ç”¨çš„å­˜å‚¨ç©ºé—´ä¸º12Kï¼Œæ— è®ºåˆå¹¶ä¹‹å‰æ•°æ®é‡å¤šå°‘ GEOGeoHash æ˜¯ä¸€ç§åœ°å€ç¼–ç æ–¹æ³•ï¼ŒæŠŠäºŒç»´çš„ç©ºé—´ç»çº¬åº¦æ•°æ®ç¼–ç æˆä¸€ä¸ªå­—ç¬¦ä¸² æ·»åŠ åæ ‡ç‚¹ 12geoadd key longitude latitude member [longitude latitude member ...]georadius key longitude latitude radius m|km|ft|mi [withcoord] [withdist] [withhash] [count count] è·å–åæ ‡ç‚¹ 12geopos key member [member ...]georadiusbymember key member radius m|km|ft|mi [withcoord] [withdist] [withhash] [count count] è®¡ç®—è·ç¦» 12geodist key member1 member2 [unit] #è®¡ç®—åæ ‡ç‚¹è·ç¦»geohash key member [member ...] #è®¡ç®—ç»çº¬åº¦ Redis åº”ç”¨äºåœ°ç†ä½ç½®è®¡ç®— æŒä¹…æœºåˆ¶æ¦‚è¿°æŒä¹…åŒ–ï¼šåˆ©ç”¨æ°¸ä¹…æ€§å­˜å‚¨ä»‹è´¨å°†æ•°æ®è¿›è¡Œä¿å­˜ï¼Œåœ¨ç‰¹å®šçš„æ—¶é—´å°†ä¿å­˜çš„æ•°æ®è¿›è¡Œæ¢å¤çš„å·¥ä½œæœºåˆ¶ç§°ä¸ºæŒä¹…åŒ– ä½œç”¨ï¼šæŒä¹…åŒ–ç”¨äºé˜²æ­¢æ•°æ®çš„æ„å¤–ä¸¢å¤±ï¼Œç¡®ä¿æ•°æ®å®‰å…¨æ€§ï¼Œå› ä¸º Redis æ˜¯å†…å­˜çº§ï¼Œæ‰€ä»¥éœ€è¦æŒä¹…åŒ–åˆ°ç£ç›˜ è®¡ç®—æœºä¸­çš„æ•°æ®å…¨éƒ¨éƒ½æ˜¯äºŒè¿›åˆ¶ï¼Œä¿å­˜ä¸€ç»„æ•°æ®æœ‰ä¸¤ç§æ–¹å¼ RDBï¼šå°†å½“å‰æ•°æ®çŠ¶æ€è¿›è¡Œä¿å­˜ï¼Œå¿«ç…§å½¢å¼ï¼Œå­˜å‚¨æ•°æ®ç»“æœï¼Œå­˜å‚¨æ ¼å¼ç®€å• AOFï¼šå°†æ•°æ®çš„æ“ä½œè¿‡ç¨‹è¿›è¡Œä¿å­˜ï¼Œæ—¥å¿—å½¢å¼ï¼Œå­˜å‚¨æ“ä½œè¿‡ç¨‹ï¼Œå­˜å‚¨æ ¼å¼å¤æ‚ RDBæ–‡ä»¶åˆ›å»ºRDB æŒä¹…åŒ–åŠŸèƒ½æ‰€ç”Ÿæˆçš„ RDB æ–‡ä»¶æ˜¯ä¸€ä¸ªç»è¿‡å‹ç¼©çš„ç´§å‡‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œé€šè¿‡è¯¥æ–‡ä»¶å¯ä»¥è¿˜åŸç”Ÿæˆ RDB æ–‡ä»¶æ—¶çš„æ•°æ®åº“çŠ¶æ€ï¼Œæœ‰ä¸¤ä¸ª Redis å‘½ä»¤å¯ä»¥ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯ SAVEï¼Œå¦ä¸€ä¸ªæ˜¯ BGSAVE SAVESAVE æŒ‡ä»¤ï¼šæ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡ä¿å­˜æ“ä½œï¼Œè¯¥æŒ‡ä»¤çš„æ‰§è¡Œä¼šé˜»å¡å½“å‰ Redis æœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯å‘é€çš„æ‰€æœ‰å‘½ä»¤è¯·æ±‚éƒ½ä¼šè¢«æ‹’ç»ï¼Œç›´åˆ°å½“å‰ RDB è¿‡ç¨‹å®Œæˆä¸ºæ­¢ï¼Œæœ‰å¯èƒ½ä¼šé€ æˆé•¿æ—¶é—´é˜»å¡ï¼Œçº¿ä¸Šç¯å¢ƒä¸å»ºè®®ä½¿ç”¨ å·¥ä½œåŸç†ï¼šRedis æ˜¯ä¸ªå•çº¿ç¨‹çš„å·¥ä½œæ¨¡å¼ï¼Œä¼šåˆ›å»ºä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œæ‰€æœ‰çš„å‘½ä»¤éƒ½ä¼šè¿›åˆ°è¿™ä¸ªé˜Ÿåˆ—æ’é˜Ÿæ‰§è¡Œã€‚å½“æŸä¸ªæŒ‡ä»¤åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œé˜Ÿåˆ—åé¢çš„æŒ‡ä»¤éƒ½è¦ç­‰å¾…ï¼Œæ‰€ä»¥è¿™ç§æ‰§è¡Œæ–¹å¼ä¼šéå¸¸è€—æ—¶ é…ç½® redis.confï¼š 1234dir path #è®¾ç½®å­˜å‚¨.rdbæ–‡ä»¶çš„è·¯å¾„ï¼Œé€šå¸¸è®¾ç½®æˆå­˜å‚¨ç©ºé—´è¾ƒå¤§çš„ç›®å½•ä¸­ï¼Œç›®å½•åç§°datadbfilename &quot;x.rdb&quot; #è®¾ç½®æœ¬åœ°æ•°æ®åº“æ–‡ä»¶åï¼Œé»˜è®¤å€¼ä¸ºdump.rdbï¼Œé€šå¸¸è®¾ç½®ä¸ºdump-ç«¯å£å·.rdbrdbcompression yes|no #è®¾ç½®å­˜å‚¨è‡³æœ¬åœ°æ•°æ®åº“æ—¶æ˜¯å¦å‹ç¼©æ•°æ®ï¼Œé»˜è®¤yesï¼Œè®¾ç½®ä¸ºnoèŠ‚çœCPUè¿è¡Œæ—¶é—´rdbchecksum yes|no #è®¾ç½®è¯»å†™æ–‡ä»¶è¿‡ç¨‹æ˜¯å¦è¿›è¡ŒRDBæ ¼å¼æ ¡éªŒï¼Œé»˜è®¤yes BGSAVEBGSAVEï¼šbg æ˜¯ backgroundï¼Œä»£è¡¨åå°æ‰§è¡Œï¼Œå‘½ä»¤çš„å®Œæˆéœ€è¦ä¸¤ä¸ªè¿›ç¨‹ï¼Œè¿›ç¨‹ä¹‹é—´ä¸ç›¸äº’å½±å“ï¼Œæ‰€ä»¥æŒä¹…åŒ–æœŸé—´ Redis æ­£å¸¸å·¥ä½œ å·¥ä½œåŸç†ï¼š æµç¨‹ï¼šå®¢æˆ·ç«¯å‘å‡º BGSAVE æŒ‡ä»¤ï¼ŒRedis æœåŠ¡å™¨ä½¿ç”¨ fork å‡½æ•°åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œç„¶åå“åº”åå°å·²ç»å¼€å§‹æ‰§è¡Œçš„ä¿¡æ¯ç»™å®¢æˆ·ç«¯ã€‚å­è¿›ç¨‹ä¼šå¼‚æ­¥æ‰§è¡ŒæŒä¹…åŒ–çš„æ“ä½œï¼ŒæŒä¹…åŒ–è¿‡ç¨‹æ˜¯å…ˆå°†æ•°æ®å†™å…¥åˆ°ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ä¸­ï¼ŒæŒä¹…åŒ–æ“ä½œç»“æŸå†ç”¨è¿™ä¸ªä¸´æ—¶æ–‡ä»¶æ›¿æ¢ä¸Šæ¬¡æŒä¹…åŒ–çš„æ–‡ä»¶ 12345678910111213# åˆ›å»ºå­è¿›ç¨‹pid = fork()if pid == 0: # å­è¿›ç¨‹è´Ÿè´£åˆ›å»º RDB æ–‡ä»¶ rdbSave() # å®Œæˆä¹‹åå‘çˆ¶è¿›ç¨‹å‘é€ä¿¡å· signal_parent()elif pid &gt; 0: # çˆ¶è¿›ç¨‹ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚ï¼Œå¹¶é€šè¿‡è½®è¯¢ç­‰å¾…å­è¿›ç¨‹çš„ä¿¡å· handle_request_and_wait_signal()else: # å¤„ç†å‡ºé”™æƒå†µ handle_fork_error() é…ç½® redis.conf 12345stop-writes-on-bgsave-error yes|no #åå°å­˜å‚¨è¿‡ç¨‹ä¸­å¦‚æœå‡ºç°é”™è¯¯ï¼Œæ˜¯å¦åœæ­¢ä¿å­˜æ“ä½œï¼Œé»˜è®¤yesdbfilename filename dir path rdbcompression yes|no rdbchecksum yes|no æ³¨æ„ï¼šBGSAVE å‘½ä»¤æ˜¯é’ˆå¯¹ SAVE é˜»å¡é—®é¢˜åšçš„ä¼˜åŒ–ï¼ŒRedis å†…éƒ¨æ‰€æœ‰æ¶‰åŠåˆ° RDB æ“ä½œéƒ½é‡‡ç”¨ BGSAVE çš„æ–¹å¼ï¼ŒSAVE å‘½ä»¤æ”¾å¼ƒä½¿ç”¨ åœ¨ BGSAVE å‘½ä»¤æ‰§è¡ŒæœŸé—´ï¼ŒæœåŠ¡å™¨å¤„ç† SAVEã€BGSAVEã€BGREWRITEAOF ä¸‰ä¸ªå‘½ä»¤çš„æ–¹å¼ä¼šå’Œå¹³æ—¶æœ‰æ‰€ä¸åŒ SAVE å‘½ä»¤ä¼šè¢«æœåŠ¡å™¨æ‹’ç»ï¼ŒæœåŠ¡å™¨ç¦æ­¢ SAVE å’Œ BGSAVE å‘½ä»¤åŒæ—¶æ‰§è¡Œæ˜¯ä¸ºäº†é¿å…çˆ¶è¿›ç¨‹ï¼ˆæœåŠ¡å™¨è¿›ç¨‹ï¼‰å’Œå­è¿›ç¨‹åŒæ—¶æ‰§è¡Œä¸¤ä¸ª rdbSave è°ƒç”¨ï¼Œäº§ç”Ÿç«äº‰æ¡ä»¶ BGSAVE å‘½ä»¤ä¹Ÿä¼šè¢«æœåŠ¡å™¨æ‹’ç»ï¼Œä¹Ÿä¼šäº§ç”Ÿç«äº‰æ¡ä»¶ BGREWRITEAOF å’Œ BGSAVE ä¸¤ä¸ªå‘½ä»¤ä¸èƒ½åŒæ—¶æ‰§è¡Œ å¦‚æœ BGSAVE å‘½ä»¤æ­£åœ¨æ‰§è¡Œï¼Œé‚£ä¹ˆ BGREWRITEAOF å‘½ä»¤ä¼šè¢«å»¶è¿Ÿåˆ° BGSAVE å‘½ä»¤æ‰§è¡Œå®Œæ¯•ä¹‹åæ‰§è¡Œ å¦‚æœ BGREWRITEAOF å‘½ä»¤æ­£åœ¨æ‰§è¡Œï¼Œé‚£ä¹ˆ BGSAVE å‘½ä»¤ä¼šè¢«æœåŠ¡å™¨æ‹’ç» ç‰¹æ®ŠæŒ‡ä»¤RDB ç‰¹æ®Šå¯åŠ¨å½¢å¼çš„æŒ‡ä»¤ï¼ˆå®¢æˆ·ç«¯è¾“å…¥ï¼‰ æœåŠ¡å™¨è¿è¡Œè¿‡ç¨‹ä¸­é‡å¯ 1debug reload å…³é—­æœåŠ¡å™¨æ—¶æŒ‡å®šä¿å­˜æ•°æ® 1shutdown save é»˜è®¤æƒ…å†µä¸‹æ‰§è¡Œ shutdown å‘½ä»¤æ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œ bgsaveï¼ˆå¦‚æœæ²¡æœ‰å¼€å¯ AOF æŒä¹…åŒ–åŠŸèƒ½ï¼‰ å…¨é‡å¤åˆ¶ï¼šä¸»ä»å¤åˆ¶éƒ¨åˆ†è¯¦è§£ æ–‡ä»¶è½½å…¥RDB æ–‡ä»¶çš„è½½å…¥å·¥ä½œæ˜¯åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œï¼ŒæœŸé—´ Redis ä¼šä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ï¼Œç›´åˆ°è½½å…¥å®Œæˆ Redis å¹¶æ²¡æœ‰ä¸“é—¨ç”¨äºè½½å…¥ RDB æ–‡ä»¶çš„å‘½ä»¤ï¼Œåªè¦æœåŠ¡å™¨åœ¨å¯åŠ¨æ—¶æ£€æµ‹åˆ° RDB æ–‡ä»¶å­˜åœ¨ï¼Œå°±ä¼šè‡ªåŠ¨è½½å…¥ RDB æ–‡ä»¶ 1[7379] 30 Aug 21:07:01.289 * DB loaded from disk: 0.018 seconds # æœåŠ¡å™¨åœ¨æˆåŠŸè½½å…¥ RDB æ–‡ä»¶ä¹‹åæ‰“å° AOF æ–‡ä»¶çš„æ›´æ–°é¢‘ç‡é€šå¸¸æ¯” RDB æ–‡ä»¶çš„æ›´æ–°é¢‘ç‡é«˜ï¼š å¦‚æœæœåŠ¡å™¨å¼€å¯äº† AOF æŒä¹…åŒ–åŠŸèƒ½ï¼Œé‚£ä¹ˆä¼šä¼˜å…ˆä½¿ç”¨ AOF æ–‡ä»¶æ¥è¿˜åŸæ•°æ®åº“çŠ¶æ€ åªæœ‰åœ¨ AOF æŒä¹…åŒ–åŠŸèƒ½å¤„äºå…³é—­çŠ¶æ€æ—¶ï¼ŒæœåŠ¡å™¨æ‰ä¼šä½¿ç”¨ RDB æ–‡ä»¶æ¥è¿˜åŸæ•°æ®åº“çŠ¶æ€ è‡ªåŠ¨ä¿å­˜é…ç½®æ–‡ä»¶Redis æ”¯æŒé€šè¿‡é…ç½®æœåŠ¡å™¨çš„ save é€‰é¡¹ï¼Œè®©æœåŠ¡å™¨æ¯éš”ä¸€æ®µæ—¶é—´è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡ BGSAVE å‘½ä»¤ é…ç½® redis.confï¼š 1save second changes #è®¾ç½®è‡ªåŠ¨æŒä¹…åŒ–æ¡ä»¶ï¼Œæ»¡è¶³é™å®šæ—¶é—´èŒƒå›´å†…keyçš„å˜åŒ–æ•°é‡å°±è¿›è¡ŒæŒä¹…åŒ–(bgsave) secondï¼šç›‘æ§æ—¶é—´èŒƒå›´ changesï¼šç›‘æ§ key çš„å˜åŒ–é‡ é»˜è®¤ä¸‰ä¸ªæ¡ä»¶ï¼š 123save 900 1 # 900så†…1ä¸ªkeyå‘ç”Ÿå˜åŒ–å°±è¿›è¡ŒæŒä¹…åŒ–save 300 10save 60 10000 åˆ¤å®š key å˜åŒ–çš„ä¾æ®ï¼š å¯¹æ•°æ®äº§ç”Ÿäº†å½±å“ï¼Œä¸åŒ…æ‹¬æŸ¥è¯¢ ä¸è¿›è¡Œæ•°æ®æ¯”å¯¹ï¼Œæ¯”å¦‚ name é”®å­˜åœ¨ï¼Œé‡æ–° set name seazean ä¹Ÿç®—ä¸€æ¬¡å˜åŒ– save é…ç½®è¦æ ¹æ®å®é™…ä¸šåŠ¡æƒ…å†µè¿›è¡Œè®¾ç½®ï¼Œé¢‘åº¦è¿‡é«˜æˆ–è¿‡ä½éƒ½ä¼šå‡ºç°æ€§èƒ½é—®é¢˜ï¼Œç»“æœå¯èƒ½æ˜¯ç¾éš¾æ€§çš„ è‡ªåŠ¨åŸç†æœåŠ¡å™¨çŠ¶æ€ç›¸å…³çš„å±æ€§ï¼š 12345678910struct redisServer &#123; // è®°å½•äº†ä¿å­˜æ¡ä»¶çš„æ•°ç»„ struct saveparam *saveparams; // ä¿®æ”¹è®¡æ•°å™¨ long long dirty; // ä¸Šä¸€æ¬¡æ‰§è¡Œä¿å­˜çš„æ—¶é—´ time_t lastsave;&#125;; Redis æœåŠ¡å™¨å¯åŠ¨æ—¶ï¼Œå¯ä»¥é€šè¿‡æŒ‡å®šé…ç½®æ–‡ä»¶æˆ–è€…ä¼ å…¥å¯åŠ¨å‚æ•°çš„æ–¹å¼è®¾ç½® save é€‰é¡¹ï¼Œ å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰å°±è®¾ç½®ä¸ºä¸‰ä¸ªé»˜è®¤å€¼ï¼ˆä¸ŠèŠ‚æåŠï¼‰ï¼Œè®¾ç½®æœåŠ¡å™¨çŠ¶æ€ redisServe.saveparams å±æ€§ï¼Œè¯¥æ•°ç»„æ¯ä¸€é¡¹ä¸ºä¸€ä¸ª saveparam ç»“æ„ï¼Œä»£è¡¨ save çš„é€‰é¡¹è®¾ç½® 123456struct saveparam &#123; // ç§’æ•° time_t seconds // ä¿®æ”¹æ•° int changes;&#125;; dirty è®¡æ•°å™¨è®°å½•è·ç¦»ä¸Šä¸€æ¬¡æˆåŠŸæ‰§è¡Œ SAVE æˆ–è€… BGSAVE å‘½ä»¤ä¹‹åï¼ŒæœåŠ¡å™¨ä¸­çš„æ‰€æœ‰æ•°æ®åº“è¿›è¡Œäº†å¤šå°‘æ¬¡ä¿®æ”¹ï¼ˆåŒ…æ‹¬å†™å…¥ã€åˆ é™¤ã€æ›´æ–°ç­‰æ“ä½œï¼‰ï¼Œå½“æœåŠ¡å™¨æˆåŠŸæ‰§è¡Œä¸€ä¸ªä¿®æ”¹æŒ‡ä»¤ï¼Œè¯¥å‘½ä»¤ä¿®æ”¹äº†å¤šå°‘æ¬¡æ•°æ®åº“ï¼Œ dirty çš„å€¼å°±å¢åŠ å¤šå°‘ lastsave å±æ€§æ˜¯ä¸€ä¸ª UNIX æ—¶é—´æˆ³ï¼Œè®°å½•äº†æœåŠ¡å™¨ä¸Šä¸€æ¬¡æˆåŠŸæ‰§è¡Œ SAVE æˆ–è€… BGSAVE å‘½ä»¤çš„æ—¶é—´ Redis çš„æœåŠ¡å™¨å‘¨æœŸæ€§æ“ä½œå‡½æ•° serverCron é»˜è®¤æ¯éš” 100 æ¯«ç§’å°±ä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œè¯¥å‡½æ•°ç”¨äºå¯¹æ­£åœ¨è¿è¡Œçš„æœåŠ¡å™¨è¿›è¡Œç»´æŠ¤ serverCron å‡½æ•°çš„å…¶ä¸­ä¸€é¡¹å·¥ä½œæ˜¯æ£€æŸ¥ save é€‰é¡¹æ‰€è®¾ç½®çš„ä¿å­˜æ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼Œä¼šéå† saveparams æ•°ç»„ä¸­çš„æ‰€æœ‰ä¿å­˜æ¡ä»¶ï¼Œåªè¦æœ‰ä»»æ„ä¸€ä¸ªæ¡ä»¶è¢«æ»¡è¶³æœåŠ¡å™¨å°±ä¼šæ‰§è¡Œ BGSAVE å‘½ä»¤ æ–‡ä»¶ç»“æ„RDB çš„å­˜å‚¨ç»“æ„ï¼šå›¾ç¤ºå…¨å¤§å†™å•è¯æ ‡ç¤ºå¸¸é‡ï¼Œç”¨å…¨å°å†™å•è¯æ ‡ç¤ºå˜é‡å’Œæ•°æ® REDISï¼šé•¿åº¦ä¸º 5 å­—èŠ‚ï¼Œä¿å­˜ç€ REDIS äº”ä¸ªå­—ç¬¦ï¼Œæ˜¯ RDB æ–‡ä»¶çš„å¼€å¤´ï¼Œåœ¨è½½å…¥æ–‡ä»¶æ—¶å¯ä»¥å¿«é€Ÿæ£€æŸ¥æ‰€è½½å…¥çš„æ–‡ä»¶æ˜¯å¦ RDB æ–‡ä»¶ db_versionï¼šé•¿åº¦ä¸º 4 å­—èŠ‚ï¼Œæ˜¯ä¸€ä¸ªç”¨å­—ç¬¦ä¸²è¡¨ç¤ºçš„æ•´æ•°ï¼Œè®°å½• RDB çš„ç‰ˆæœ¬å· databaseï¼šåŒ…å«ç€é›¶ä¸ªæˆ–ä»»æ„å¤šä¸ªæ•°æ®åº“ï¼Œä»¥åŠå„ä¸ªæ•°æ®åº“ä¸­çš„é”®å€¼å¯¹æ•°æ® EOFï¼šé•¿åº¦ä¸º 1 å­—èŠ‚çš„å¸¸é‡ï¼Œæ ‡å¿—ç€ RDB æ–‡ä»¶æ­£æ–‡å†…å®¹çš„ç»“æŸï¼Œå½“è¯»å…¥é‡åˆ°è¿™ä¸ªå€¼æ—¶ï¼Œä»£è¡¨æ‰€æœ‰æ•°æ®åº“çš„é”®å€¼å¯¹éƒ½å·²ç»è½½å…¥å®Œæ¯• check_sumï¼šé•¿åº¦ä¸º 8 å­—èŠ‚çš„æ— ç¬¦å·æ•´æ•°ï¼Œä¿å­˜ç€ä¸€ä¸ªæ ¡éªŒå’Œï¼Œè¯¥å€¼æ˜¯é€šè¿‡ REDISã€db_versionã€databasesã€EOF å››ä¸ªéƒ¨åˆ†çš„å†…å®¹è¿›è¡Œè®¡ç®—å¾—å‡ºã€‚æœåŠ¡å™¨åœ¨è½½å…¥ RDB æ–‡ä»¶æ—¶ï¼Œä¼šå°†è½½å…¥æ•°æ®æ‰€è®¡ç®—å‡ºçš„æ ¡éªŒå’Œä¸ check_sum æ‰€è®°å½•çš„æ ¡éªŒå’Œè¿›è¡Œå¯¹æ¯”ï¼Œæ¥æ£€æŸ¥ RDB æ–‡ä»¶æ˜¯å¦æœ‰å‡ºé”™æˆ–è€…æŸå Redis æœ¬èº«å¸¦æœ‰ RDB æ–‡ä»¶æ£€æŸ¥å·¥å…· redis-check-dump AOFåŸºæœ¬æ¦‚è¿°AOFï¼ˆappend only fileï¼‰æŒä¹…åŒ–ï¼šä»¥ç‹¬ç«‹æ—¥å¿—çš„æ–¹å¼è®°å½•æ¯æ¬¡å†™å‘½ä»¤ï¼ˆä¸è®°å½•è¯»ï¼‰æ¥è®°å½•æ•°æ®åº“çŠ¶æ€ï¼Œå¢é‡ä¿å­˜åªè®¸è¿½åŠ æ–‡ä»¶ä½†ä¸å¯ä»¥æ”¹å†™æ–‡ä»¶ï¼Œä¸ RDB ç›¸æ¯”å¯ä»¥ç†è§£ä¸ºç”±è®°å½•æ•°æ®æ”¹ä¸ºè®°å½•æ•°æ®çš„å˜åŒ– AOF ä¸»è¦ä½œç”¨æ˜¯è§£å†³äº†æ•°æ®æŒä¹…åŒ–çš„å®æ—¶æ€§ï¼Œç›®å‰å·²ç»æ˜¯ Redis æŒä¹…åŒ–çš„ä¸»æµæ–¹å¼ AOF å†™æ•°æ®è¿‡ç¨‹ï¼š Redis åªä¼šå°†å¯¹æ•°æ®åº“è¿›è¡Œäº†ä¿®æ”¹çš„å‘½ä»¤å†™å…¥åˆ° AOF æ–‡ä»¶ï¼Œå¹¶å¤åˆ¶åˆ°å„ä¸ªä»æœåŠ¡å™¨ï¼Œä½†æ˜¯ PUBSUB å’Œ SCRIPT LOAD å‘½ä»¤ä¾‹å¤–ï¼š PUBSUB å‘½ä»¤è™½ç„¶æ²¡æœ‰ä¿®æ”¹æ•°æ®åº“ï¼Œä½† PUBSUB å‘½ä»¤å‘é¢‘é“çš„æ‰€æœ‰è®¢é˜…è€…å‘é€æ¶ˆæ¯è¿™ä¸€è¡Œä¸ºå¸¦æœ‰å‰¯ä½œç”¨ï¼Œæ¥æ”¶åˆ°æ¶ˆæ¯çš„æ‰€æœ‰å®¢æˆ·ç«¯çš„çŠ¶æ€éƒ½ä¼šå› ä¸ºè¿™ä¸ªå‘½ä»¤è€Œæ”¹å˜ï¼Œæ‰€ä»¥æœåŠ¡å™¨éœ€è¦ä½¿ç”¨ REDIS_FORCE_AOF æ ‡å¿—å¼ºåˆ¶å°†è¿™ä¸ªå‘½ä»¤å†™å…¥ AOF æ–‡ä»¶ã€‚è¿™æ ·åœ¨å°†æ¥è½½å…¥ AOF æ–‡ä»¶æ—¶ï¼ŒæœåŠ¡å™¨å°±å¯ä»¥å†æ¬¡æ‰§è¡Œç›¸åŒçš„ PUBSUB å‘½ä»¤ï¼Œå¹¶äº§ç”Ÿç›¸åŒçš„å‰¯ä½œç”¨ SCRIPT LOAD å‘½ä»¤è™½ç„¶æ²¡æœ‰ä¿®æ”¹æ•°æ®åº“ï¼Œä½†å®ƒä¿®æ”¹äº†æœåŠ¡å™¨çŠ¶æ€ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯ä¸€ä¸ªå¸¦æœ‰å‰¯ä½œç”¨çš„å‘½ä»¤ï¼Œéœ€è¦ä½¿ç”¨ REDIS_FORCE_AOF æŒä¹…å®ç°AOF æŒä¹…åŒ–åŠŸèƒ½çš„å®ç°å¯ä»¥åˆ†ä¸ºå‘½ä»¤è¿½åŠ ï¼ˆappendï¼‰ã€æ–‡ä»¶å†™å…¥ã€æ–‡ä»¶åŒæ­¥ï¼ˆsyncï¼‰ä¸‰ä¸ªæ­¥éª¤ å‘½ä»¤è¿½åŠ å¯åŠ¨ AOF çš„åŸºæœ¬é…ç½®ï¼š 123appendonly yes|no #å¼€å¯AOFæŒä¹…åŒ–åŠŸèƒ½ï¼Œé»˜è®¤noï¼Œå³ä¸å¼€å¯çŠ¶æ€appendfilename filename #AOFæŒä¹…åŒ–æ–‡ä»¶åï¼Œé»˜è®¤appendonly.aofï¼Œå»ºè®®è®¾ç½®appendonly-ç«¯å£å·.aofdir #AOFæŒä¹…åŒ–æ–‡ä»¶ä¿å­˜è·¯å¾„ï¼Œä¸RDBæŒä¹…åŒ–æ–‡ä»¶è·¯å¾„ä¿æŒä¸€è‡´å³å¯ å½“ AOF æŒä¹…åŒ–åŠŸèƒ½å¤„äºæ‰“å¼€çŠ¶æ€æ—¶ï¼ŒæœåŠ¡å™¨åœ¨æ‰§è¡Œå®Œä¸€ä¸ªå†™å‘½ä»¤ä¹‹åï¼Œä¼šä»¥åè®®æ ¼å¼å°†è¢«æ‰§è¡Œçš„å†™å‘½ä»¤è¿½åŠ åˆ°æœåŠ¡å™¨çŠ¶æ€çš„ aof_buf ç¼“å†²åŒºçš„æœ«å°¾ 1234struct redisServer &#123; // AOF ç¼“å†²åŒº sds aof_buf;&#125;; æ–‡ä»¶å†™å…¥æœåŠ¡å™¨åœ¨å¤„ç†æ–‡ä»¶äº‹ä»¶æ—¶ä¼šæ‰§è¡Œå†™å‘½ä»¤ï¼Œè¿½åŠ ä¸€äº›å†…å®¹åˆ° aof_buf ç¼“å†²åŒºé‡Œï¼Œæ‰€ä»¥æœåŠ¡å™¨æ¯æ¬¡ç»“æŸä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¹‹å‰ï¼Œå°±ä¼šæ‰§è¡Œ flushAppendOnlyFile å‡½æ•°ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦å°† aof_buf ç¼“å†²åŒºä¸­çš„å†…å®¹å†™å…¥å’Œä¿å­˜åˆ° AOF æ–‡ä»¶é‡Œ flushAppendOnlyFile å‡½æ•°çš„è¡Œä¸ºç”±æœåŠ¡å™¨é…ç½®çš„ appendfsync é€‰é¡¹çš„å€¼æ¥å†³å®š 1appendfsync always|everysec|no #AOFå†™æ•°æ®ç­–ç•¥ï¼šé»˜è®¤ä¸ºeverysec alwaysï¼šæ¯æ¬¡å†™å…¥æ“ä½œéƒ½å°† aof_buf ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹å†™å…¥å¹¶åŒæ­¥åˆ° AOF æ–‡ä»¶ ç‰¹ç‚¹ï¼šå®‰å…¨æ€§æœ€é«˜ï¼Œæ•°æ®é›¶è¯¯å·®ï¼Œä½†æ˜¯æ€§èƒ½è¾ƒä½ï¼Œä¸å»ºè®®ä½¿ç”¨ everysecï¼šå…ˆå°† aof_buf ç¼“å†²åŒºä¸­çš„å†…å®¹å†™å…¥åˆ°æ“ä½œç³»ç»Ÿç¼“å­˜ï¼Œåˆ¤æ–­ä¸Šæ¬¡åŒæ­¥ AOF æ–‡ä»¶çš„æ—¶é—´è·ç¦»ç°åœ¨è¶…è¿‡ä¸€ç§’é’Ÿï¼Œå†æ¬¡è¿›è¡ŒåŒæ­¥ fsyncï¼Œè¿™ä¸ªåŒæ­¥æ“ä½œæ˜¯ç”±ä¸€ä¸ªï¼ˆå­ï¼‰çº¿ç¨‹ä¸“é—¨è´Ÿè´£æ‰§è¡Œçš„ ç‰¹ç‚¹ï¼šåœ¨ç³»ç»Ÿçªç„¶å®•æœºçš„æƒ…å†µä¸‹ä¸¢å¤± 1 ç§’å†…çš„æ•°æ®ï¼Œå‡†ç¡®æ€§è¾ƒé«˜ï¼Œæ€§èƒ½è¾ƒé«˜ï¼Œå»ºè®®ä½¿ç”¨ï¼Œä¹Ÿæ˜¯é»˜è®¤é…ç½® noï¼šå°† aof_buf ç¼“å†²åŒºä¸­çš„å†…å®¹å†™å…¥åˆ°æ“ä½œç³»ç»Ÿç¼“å­˜ï¼Œä½†å¹¶ä¸è¿›è¡ŒåŒæ­¥ï¼Œä½•æ—¶åŒæ­¥ç”±æ“ä½œç³»ç»Ÿæ¥å†³å®š ç‰¹ç‚¹ï¼šæ•´ä½“ä¸å¯æ§ï¼ŒæœåŠ¡å™¨å®•æœºä¼šä¸¢å¤±ä¸Šæ¬¡åŒæ­¥ AOF åçš„æ‰€æœ‰å†™æŒ‡ä»¤ æ–‡ä»¶åŒæ­¥åœ¨ç°ä»£æ“ä½œç³»ç»Ÿä¸­ï¼Œå½“ç”¨æˆ·è°ƒç”¨ write å‡½æ•°å°†æ•°æ®å†™å…¥æ–‡ä»¶æ—¶ï¼Œæ“ä½œç³»ç»Ÿé€šå¸¸ä¼šå°†å†™å…¥æ•°æ®æš‚æ—¶ä¿å­˜åœ¨ä¸€ä¸ªå†…å­˜ç¼“å†²åŒºç©ºé—´ï¼Œç­‰åˆ°ç¼“å†²åŒºå†™æ»¡æˆ–è€…åˆ°è¾¾ç‰¹å®šæ—¶é—´å‘¨æœŸï¼Œæ‰çœŸæ­£åœ°å°†ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥åˆ°ç£ç›˜é‡Œé¢ï¼ˆåˆ·è„ï¼‰ ä¼˜ç‚¹ï¼šæé«˜æ–‡ä»¶çš„å†™å…¥æ•ˆç‡ ç¼ºç‚¹ï¼šä¸ºå†™å…¥æ•°æ®å¸¦æ¥äº†å®‰å…¨é—®é¢˜ï¼Œå¦‚æœè®¡ç®—æœºå‘ç”Ÿåœæœºï¼Œé‚£ä¹ˆä¿å­˜åœ¨å†…å­˜ç¼“å†²åŒºé‡Œé¢çš„å†™å…¥æ•°æ®å°†ä¼šä¸¢å¤± ç³»ç»Ÿæä¾›äº† fsync å’Œ fdatasync ä¸¤ä¸ªåŒæ­¥å‡½æ•°åšå¼ºåˆ¶ç¡¬ç›˜åŒæ­¥ï¼Œå¯ä»¥è®©æ“ä½œç³»ç»Ÿç«‹å³å°†ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥åˆ°ç¡¬ç›˜é‡Œé¢ï¼Œå‡½æ•°ä¼šé˜»å¡åˆ°å†™å…¥ç¡¬ç›˜å®Œæˆåè¿”å›ï¼Œä¿è¯äº†æ•°æ®æŒä¹…åŒ– å¼‚å¸¸æ¢å¤ï¼šAOF æ–‡ä»¶æŸåï¼Œé€šè¿‡ redis-check-aofâ€“fix appendonly.aof è¿›è¡Œæ¢å¤ï¼Œé‡å¯ Redisï¼Œç„¶åé‡æ–°åŠ è½½ æ–‡ä»¶è½½å…¥AOF æ–‡ä»¶é‡ŒåŒ…å«äº†é‡å»ºæ•°æ®åº“çŠ¶æ€æ‰€éœ€çš„æ‰€æœ‰å†™å‘½ä»¤ï¼Œæ‰€ä»¥æœåŠ¡å™¨åªè¦è¯»å…¥å¹¶é‡æ–°æ‰§è¡Œä¸€é AOF æ–‡ä»¶é‡Œçš„å‘½ä»¤ï¼Œå°±è¿˜åŸæœåŠ¡å™¨å…³é—­ä¹‹å‰çš„æ•°æ®åº“çŠ¶æ€ï¼ŒæœåŠ¡å™¨åœ¨å¯åŠ¨æ—¶ï¼Œè¿˜åŸæ•°æ®åº“çŠ¶æ€æ‰“å°çš„æ—¥å¿—ï¼š 1[8321] 05 Sep 11:58:50.449 * DB loaded from append only file: 0.000 seconds AOF æ–‡ä»¶é‡Œé¢é™¤äº†ç”¨äºæŒ‡å®šæ•°æ®åº“çš„ SELECT å‘½ä»¤æ˜¯æœåŠ¡å™¨è‡ªåŠ¨æ·»åŠ çš„ï¼Œå…¶ä»–éƒ½æ˜¯é€šè¿‡å®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤ 123* 2\\r\\n$6\\r\\nSELECT\\r\\n$1\\r\\n0\\r\\n # æœåŠ¡å™¨è‡ªåŠ¨æ·»åŠ * 3\\r\\n$3\\r\\nSET\\r\\n$3\\r\\nmsg\\r\\n$5\\r\\nhello\\r\\n* 5\\r\\n$4\\r\\nSADD\\r\\n$6\\r\\nfruits\\r\\n$5\\r\\napple\\r\\n$6\\r\\nbanana\\r\\n$6\\r\\ncherry\\r\\n Redis è¯»å– AOF æ–‡ä»¶å¹¶è¿˜åŸæ•°æ®åº“çŠ¶æ€çš„æ­¥éª¤ï¼š åˆ›å»ºä¸€ä¸ªä¸å¸¦ç½‘ç»œè¿æ¥çš„ä¼ªå®¢æˆ·ç«¯ï¼ˆfake clientï¼‰æ‰§è¡Œå‘½ä»¤ï¼Œå› ä¸º Redis çš„å‘½ä»¤åªèƒ½åœ¨å®¢æˆ·ç«¯ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œ è€Œè½½å…¥ AOF æ–‡ä»¶æ—¶æ‰€ä½¿ç”¨çš„å‘½ä»¤æ¥æºäºæœ¬åœ° AOF æ–‡ä»¶è€Œä¸æ˜¯ç½‘ç»œè¿æ¥ ä» AOF æ–‡ä»¶åˆ†æå¹¶è¯»å–ä¸€æ¡å†™å‘½ä»¤ ä½¿ç”¨ä¼ªå®¢æˆ·ç«¯æ‰§è¡Œè¢«è¯»å‡ºçš„å†™å‘½ä»¤ï¼Œç„¶åé‡å¤ä¸Šè¿°æ­¥éª¤ é‡å†™å®ç°é‡å†™ç­–ç•¥AOF é‡å†™ï¼šè¯»å–æœåŠ¡å™¨å½“å‰çš„æ•°æ®åº“çŠ¶æ€ï¼Œç”Ÿæˆæ–° AOF æ–‡ä»¶æ¥æ›¿æ¢æ—§ AOF æ–‡ä»¶ï¼Œä¸ä¼šå¯¹ç°æœ‰çš„ AOF æ–‡ä»¶è¿›è¡Œä»»ä½•è¯»å–ã€åˆ†ææˆ–è€…å†™å…¥æ“ä½œï¼Œè€Œæ˜¯ç›´æ¥åŸå­æ›¿æ¢ã€‚æ–° AOF æ–‡ä»¶ä¸ä¼šåŒ…å«ä»»ä½•æµªè´¹ç©ºé—´çš„å†—ä½™å‘½ä»¤ï¼Œæ‰€ä»¥ä½“ç§¯é€šå¸¸ä¼šæ¯”æ—§ AOF æ–‡ä»¶å°å¾—å¤š AOF é‡å†™è§„åˆ™ï¼š è¿›ç¨‹å†…å…·æœ‰æ—¶æ•ˆæ€§çš„æ•°æ®ï¼Œå¹¶ä¸”æ•°æ®å·²è¶…æ—¶å°†ä¸å†å†™å…¥æ–‡ä»¶ å¯¹åŒä¸€æ•°æ®çš„å¤šæ¡å†™å‘½ä»¤åˆå¹¶ä¸ºä¸€æ¡å‘½ä»¤ï¼Œå› ä¸ºä¼šè¯»å–å½“å‰çš„çŠ¶æ€ï¼Œæ‰€ä»¥ç›´æ¥å°†å½“å‰çŠ¶æ€è½¬æ¢ä¸ºä¸€æ¡å‘½ä»¤å³å¯ã€‚ä¸ºé˜²æ­¢æ•°æ®é‡è¿‡å¤§é€ æˆå®¢æˆ·ç«¯ç¼“å†²åŒºæº¢å‡ºï¼Œå¯¹ listã€setã€hashã€zset ç­‰é›†åˆç±»å‹ï¼Œå•æ¡æŒ‡ä»¤æœ€å¤šå†™å…¥ 64 ä¸ªå…ƒç´  å¦‚ lpushlist1 aã€lpush list1 bã€lpush list1 c å¯ä»¥è½¬åŒ–ä¸ºï¼šlpush list1 a b c éå†™å…¥ç±»çš„æ— æ•ˆæŒ‡ä»¤å°†è¢«å¿½ç•¥ï¼Œåªä¿ç•™æœ€ç»ˆæ•°æ®çš„å†™å…¥å‘½ä»¤ï¼Œä½†æ˜¯ select æŒ‡ä»¤è™½ç„¶ä¸æ›´æ”¹æ•°æ®ï¼Œä½†æ˜¯æ›´æ”¹äº†æ•°æ®çš„å­˜å‚¨ä½ç½®ï¼Œæ­¤ç±»å‘½ä»¤åŒæ ·éœ€è¦è®°å½• AOF é‡å†™ä½œç”¨ï¼š é™ä½ç£ç›˜å ç”¨é‡ï¼Œæé«˜ç£ç›˜åˆ©ç”¨ç‡ æé«˜æŒä¹…åŒ–æ•ˆç‡ï¼Œé™ä½æŒä¹…åŒ–å†™æ—¶é—´ï¼Œæé«˜ IO æ€§èƒ½ é™ä½æ•°æ®æ¢å¤çš„ç”¨æ—¶ï¼Œæé«˜æ•°æ®æ¢å¤æ•ˆç‡ é‡å†™åŸç†AOF é‡å†™ç¨‹åº aof_rewrite å‡½æ•°å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–° AOF æ–‡ä»¶ï¼Œ ä½†æ˜¯è¯¥å‡½æ•°ä¼šè¿›è¡Œå¤§é‡çš„å†™å…¥æ“ä½œï¼Œè°ƒç”¨è¿™ä¸ªå‡½æ•°çš„çº¿ç¨‹å°†è¢«é•¿æ—¶é—´é˜»å¡ï¼Œæ‰€ä»¥ Redis å°† AOF é‡å†™ç¨‹åºæ”¾åˆ° fork çš„å­è¿›ç¨‹é‡Œæ‰§è¡Œï¼Œä¸ä¼šé˜»å¡çˆ¶è¿›ç¨‹ï¼Œé‡å†™å‘½ä»¤ï¼š 1bgrewriteaof å­è¿›ç¨‹è¿›è¡Œ AOF é‡å†™æœŸé—´ï¼ŒæœåŠ¡å™¨è¿›ç¨‹ï¼ˆçˆ¶è¿›ç¨‹ï¼‰å¯ä»¥ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚ å­è¿›ç¨‹å¸¦æœ‰æœåŠ¡å™¨è¿›ç¨‹çš„æ•°æ®å‰¯æœ¬ï¼Œä½¿ç”¨å­è¿›ç¨‹è€Œä¸æ˜¯çº¿ç¨‹ï¼Œå¯ä»¥åœ¨é¿å…ä½¿ç”¨é”çš„æƒ…å†µä¸‹ï¼Œ ä¿è¯æ•°æ®å®‰å…¨æ€§ å­è¿›ç¨‹åœ¨è¿›è¡Œ AOF é‡å†™æœŸé—´ï¼ŒæœåŠ¡å™¨è¿›ç¨‹è¿˜éœ€è¦ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚ï¼Œè€Œæ–°å‘½ä»¤å¯èƒ½ä¼šå¯¹ç°æœ‰çš„æ•°æ®åº“çŠ¶æ€è¿›è¡Œä¿®æ”¹ï¼Œä»è€Œä½¿å¾—æœåŠ¡å™¨å½“å‰çš„æ•°æ®åº“çŠ¶æ€å’Œé‡å†™åçš„ AOF æ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€ä¸ä¸€è‡´ï¼Œæ‰€ä»¥ Redis è®¾ç½®äº† AOF é‡å†™ç¼“å†²åŒº å·¥ä½œæµç¨‹ï¼š Redis æœåŠ¡å™¨æ‰§è¡Œå®Œä¸€ä¸ªå†™å‘½ä»¤ï¼Œä¼šåŒæ—¶å°†è¯¥å‘½ä»¤è¿½åŠ åˆ° AOF ç¼“å†²åŒºå’Œ AOF é‡å†™ç¼“å†²åŒºï¼ˆä»åˆ›å»ºå­è¿›ç¨‹åæ‰å¼€å§‹å†™å…¥ï¼‰ å½“å­è¿›ç¨‹å®Œæˆ AOF é‡å†™å·¥ä½œä¹‹åï¼Œä¼šå‘çˆ¶è¿›ç¨‹å‘é€ä¸€ä¸ªä¿¡å·ï¼Œçˆ¶è¿›ç¨‹åœ¨æ¥åˆ°è¯¥ä¿¡å·ä¹‹åï¼Œ ä¼šè°ƒç”¨ä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ï¼Œè¯¥å‡½æ•°æ‰§è¡Œæ—¶ä¼šå¯¹æœåŠ¡å™¨è¿›ç¨‹ï¼ˆçˆ¶è¿›ç¨‹ï¼‰é€ æˆé˜»å¡ï¼ˆå½±å“å¾ˆå°ï¼Œç±»ä¼¼ JVM STWï¼‰ï¼Œä¸»è¦å·¥ä½œï¼š å°† AOF é‡å†™ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹å†™å…¥åˆ°æ–° AOF æ–‡ä»¶ä¸­ï¼Œ è¿™æ—¶æ–° AOF æ–‡ä»¶æ‰€ä¿å­˜çš„çŠ¶æ€å°†å’ŒæœåŠ¡å™¨å½“å‰çš„æ•°æ®åº“çŠ¶æ€ä¸€è‡´ å¯¹æ–°çš„ AOF æ–‡ä»¶è¿›è¡Œæ”¹åï¼ŒåŸå­åœ°ï¼ˆatomicï¼‰è¦†ç›–ç°æœ‰çš„ AOF æ–‡ä»¶ï¼Œå®Œæˆæ–°æ—§ä¸¤ä¸ª AOF æ–‡ä»¶çš„æ›¿æ¢ è‡ªåŠ¨é‡å†™è§¦å‘æ—¶æœºï¼šRedis ä¼šè®°å½•ä¸Šæ¬¡é‡å†™æ—¶çš„ AOF å¤§å°ï¼Œé»˜è®¤é…ç½®æ˜¯å½“ AOF æ–‡ä»¶å¤§å°æ˜¯ä¸Šæ¬¡é‡å†™åå¤§å°çš„ä¸€å€ä¸”æ–‡ä»¶å¤§äº 64M æ—¶è§¦å‘ 12auto-aof-rewrite-min-size size #è®¾ç½®é‡å†™çš„åŸºå‡†å€¼ï¼Œæœ€å°æ–‡ä»¶ 64MBï¼Œè¾¾åˆ°è¿™ä¸ªå€¼å¼€å§‹é‡å†™auto-aof-rewrite-percentage percent #è§¦å‘AOFæ–‡ä»¶æ‰§è¡Œé‡å†™çš„å¢é•¿ç‡ï¼Œå½“å‰AOFæ–‡ä»¶å¤§å°è¶…è¿‡ä¸Šä¸€æ¬¡é‡å†™çš„AOFæ–‡ä»¶å¤§å°çš„ç™¾åˆ†ä¹‹å¤šå°‘æ‰ä¼šé‡å†™ï¼Œæ¯”å¦‚æ–‡ä»¶è¾¾åˆ° 100% æ—¶å¼€å§‹é‡å†™å°±æ˜¯ä¸¤å€æ—¶è§¦å‘ è‡ªåŠ¨é‡å†™è§¦å‘æ¯”å¯¹å‚æ•°ï¼ˆ è¿è¡ŒæŒ‡ä»¤ info Persistence è·å–å…·ä½“ä¿¡æ¯ ï¼‰ï¼š 12aof_current_size #AOFæ–‡ä»¶å½“å‰å°ºå¯¸å¤§å°ï¼ˆå•ä½:å­—èŠ‚ï¼‰aof_base_size #AOFæ–‡ä»¶ä¸Šæ¬¡å¯åŠ¨å’Œé‡å†™æ—¶çš„å°ºå¯¸å¤§å°ï¼ˆå•ä½:å­—èŠ‚ï¼‰ è‡ªåŠ¨é‡å†™è§¦å‘æ¡ä»¶å…¬å¼ï¼š aof_current_size &gt; auto-aof-rewrite-min-size (aof_current_size - aof_base_size) &#x2F; aof_base_size &gt;&#x3D; auto-aof-rewrite-percentage å¯¹æ¯”RDB çš„ç‰¹ç‚¹ RDB ä¼˜ç‚¹ï¼š RDB æ˜¯ä¸€ä¸ªç´§å‡‘å‹ç¼©çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå­˜å‚¨æ•ˆç‡è¾ƒé«˜ï¼Œä½†å­˜å‚¨æ•°æ®é‡è¾ƒå¤§æ—¶ï¼Œå­˜å‚¨æ•ˆç‡è¾ƒä½ RDB å†…éƒ¨å­˜å‚¨çš„æ˜¯ Redis åœ¨æŸä¸ªæ—¶é—´ç‚¹çš„æ•°æ®å¿«ç…§ï¼Œéå¸¸é€‚åˆç”¨äºæ•°æ®å¤‡ä»½ï¼Œå…¨é‡å¤åˆ¶ã€ç¾éš¾æ¢å¤ RDB æ¢å¤æ•°æ®çš„é€Ÿåº¦è¦æ¯” AOF å¿«å¾ˆå¤šï¼Œå› ä¸ºæ˜¯å¿«ç…§ï¼Œç›´æ¥æ¢å¤ RDB ç¼ºç‚¹ï¼š BGSAVE æŒ‡ä»¤æ¯æ¬¡è¿è¡Œè¦æ‰§è¡Œ fork æ“ä½œåˆ›å»ºå­è¿›ç¨‹ï¼Œä¼šç‰ºç‰²ä¸€äº›æ€§èƒ½ RDB æ–¹å¼æ— è®ºæ˜¯æ‰§è¡ŒæŒ‡ä»¤è¿˜æ˜¯åˆ©ç”¨é…ç½®ï¼Œæ— æ³•åšåˆ°å®æ—¶æŒä¹…åŒ–ï¼Œå…·æœ‰ä¸¢å¤±æ•°æ®çš„å¯èƒ½æ€§ï¼Œæœ€åä¸€æ¬¡æŒä¹…åŒ–åçš„æ•°æ®å¯èƒ½ä¸¢å¤± Redis çš„ä¼—å¤šç‰ˆæœ¬ä¸­æœªè¿›è¡Œ RDB æ–‡ä»¶æ ¼å¼çš„ç‰ˆæœ¬ç»Ÿä¸€ï¼Œå¯èƒ½å‡ºç°å„ç‰ˆæœ¬ä¹‹é—´æ•°æ®æ ¼å¼æ— æ³•å…¼å®¹ AOF ç‰¹ç‚¹ï¼š AOF çš„ä¼˜ç‚¹ï¼šæ•°æ®æŒä¹…åŒ–æœ‰è¾ƒå¥½çš„å®æ—¶æ€§ï¼Œé€šè¿‡ AOF é‡å†™å¯ä»¥é™ä½æ–‡ä»¶çš„ä½“ç§¯ AOF çš„ç¼ºç‚¹ï¼šæ–‡ä»¶è¾ƒå¤§æ—¶æ¢å¤è¾ƒæ…¢ AOF å’Œ RDB åŒæ—¶å¼€å¯ï¼Œç³»ç»Ÿé»˜è®¤å– AOF çš„æ•°æ®ï¼ˆæ•°æ®ä¸ä¼šå­˜åœ¨ä¸¢å¤±ï¼‰ åº”ç”¨åœºæ™¯ï¼š å¯¹æ•°æ®éå¸¸æ•æ„Ÿï¼Œå»ºè®®ä½¿ç”¨é»˜è®¤çš„ AOF æŒä¹…åŒ–æ–¹æ¡ˆï¼ŒAOF æŒä¹…åŒ–ç­–ç•¥ä½¿ç”¨ everysecondï¼Œæ¯ç§’é’Ÿ fsync ä¸€æ¬¡ï¼Œè¯¥ç­–ç•¥ Redis ä»å¯ä»¥ä¿æŒå¾ˆå¥½çš„å¤„ç†æ€§èƒ½ æ³¨æ„ï¼šAOF æ–‡ä»¶å­˜å‚¨ä½“ç§¯è¾ƒå¤§ï¼Œæ¢å¤é€Ÿåº¦è¾ƒæ…¢ï¼Œå› ä¸ºè¦æ‰§è¡Œæ¯æ¡æŒ‡ä»¤ æ•°æ®å‘ˆç°é˜¶æ®µæœ‰æ•ˆæ€§ï¼Œå»ºè®®ä½¿ç”¨ RDB æŒä¹…åŒ–æ–¹æ¡ˆï¼Œå¯ä»¥åšåˆ°é˜¶æ®µå†…æ— ä¸¢å¤±ï¼Œä¸”æ¢å¤é€Ÿåº¦è¾ƒå¿« æ³¨æ„ï¼šåˆ©ç”¨ RDB å®ç°ç´§å‡‘çš„æ•°æ®æŒä¹…åŒ–ï¼Œå­˜å‚¨æ•°æ®é‡è¾ƒå¤§æ—¶ï¼Œå­˜å‚¨æ•ˆç‡è¾ƒä½ ç»¼åˆå¯¹æ¯”ï¼š RDB ä¸ AOF çš„é€‰æ‹©å®é™…ä¸Šæ˜¯åœ¨åšä¸€ç§æƒè¡¡ï¼Œæ¯ç§éƒ½æœ‰åˆ©æœ‰å¼Š ç¾éš¾æ¢å¤é€‰ç”¨ RDB å¦‚ä¸èƒ½æ‰¿å—æ•°åˆ†é’Ÿä»¥å†…çš„æ•°æ®ä¸¢å¤±ï¼Œå¯¹ä¸šåŠ¡æ•°æ®éå¸¸æ•æ„Ÿï¼Œé€‰ç”¨ AOFï¼›å¦‚èƒ½æ‰¿å—æ•°åˆ†é’Ÿä»¥å†…çš„æ•°æ®ä¸¢å¤±ï¼Œä¸”è¿½æ±‚å¤§æ•°æ®é›†çš„æ¢å¤é€Ÿåº¦ï¼Œé€‰ç”¨ RDB åŒä¿é™©ç­–ç•¥ï¼ŒåŒæ—¶å¼€å¯ RDB å’Œ AOFï¼Œé‡å¯å Redis ä¼˜å…ˆä½¿ç”¨ AOF æ¥æ¢å¤æ•°æ®ï¼Œé™ä½ä¸¢å¤±æ•°æ®çš„é‡ ä¸å»ºè®®å•ç‹¬ç”¨ AOFï¼Œå› ä¸ºå¯èƒ½ä¼šå‡ºç° Bugï¼Œå¦‚æœåªæ˜¯åšçº¯å†…å­˜ç¼“å­˜ï¼Œå¯ä»¥éƒ½ä¸ç”¨ forkä»‹ç»fork() å‡½æ•°åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹å‡ ä¹æ˜¯å®Œå…¨ç›¸åŒçš„è¿›ç¨‹ï¼Œç³»ç»Ÿå…ˆç»™å­è¿›ç¨‹åˆ†é…èµ„æºï¼Œç„¶åæŠŠçˆ¶è¿›ç¨‹çš„æ‰€æœ‰æ•°æ®éƒ½å¤åˆ¶åˆ°å­è¿›ç¨‹ä¸­ï¼Œåªæœ‰å°‘æ•°å€¼ä¸çˆ¶è¿›ç¨‹çš„å€¼ä¸åŒï¼Œç›¸å½“äºå…‹éš†äº†ä¸€ä¸ªè¿›ç¨‹ åœ¨å®Œæˆå¯¹å…¶è°ƒç”¨ä¹‹åï¼Œä¼šäº§ç”Ÿ 2 ä¸ªè¿›ç¨‹ï¼Œä¸”æ¯ä¸ªè¿›ç¨‹éƒ½ä¼šä» fork() çš„è¿”å›å¤„å¼€å§‹æ‰§è¡Œï¼Œè¿™ä¸¤ä¸ªè¿›ç¨‹å°†æ‰§è¡Œç›¸åŒçš„ç¨‹åºæ®µï¼Œä½†æ˜¯æ‹¥æœ‰å„è‡ªä¸åŒçš„å †æ®µï¼Œæ ˆæ®µï¼Œæ•°æ®æ®µï¼Œæ¯ä¸ªå­è¿›ç¨‹éƒ½å¯ä¿®æ”¹å„è‡ªçš„æ•°æ®æ®µï¼Œå †æ®µï¼Œå’Œæ ˆæ®µ 123#include&lt;unistd.h&gt;pid_t fork(void);// çˆ¶è¿›ç¨‹è¿”å›å­è¿›ç¨‹çš„pidï¼Œå­è¿›ç¨‹è¿”å›0ï¼Œé”™è¯¯è¿”å›è´Ÿå€¼ï¼Œæ ¹æ®è¿”å›å€¼çš„ä¸åŒè¿›è¡Œå¯¹åº”çš„é€»è¾‘å¤„ç† fork è°ƒç”¨ä¸€æ¬¡ï¼Œå´èƒ½å¤Ÿè¿”å›ä¸¤æ¬¡ï¼Œå¯èƒ½æœ‰ä¸‰ç§ä¸åŒçš„è¿”å›å€¼ï¼š åœ¨çˆ¶è¿›ç¨‹ä¸­ï¼Œfork è¿”å›æ–°åˆ›å»ºå­è¿›ç¨‹çš„è¿›ç¨‹ ID åœ¨å­è¿›ç¨‹ä¸­ï¼Œfork è¿”å› 0 å¦‚æœå‡ºç°é”™è¯¯ï¼Œfork è¿”å›ä¸€ä¸ªè´Ÿå€¼ï¼Œé”™è¯¯åŸå› ï¼š å½“å‰çš„è¿›ç¨‹æ•°å·²ç»è¾¾åˆ°äº†ç³»ç»Ÿè§„å®šçš„ä¸Šé™ï¼Œè¿™æ—¶ errno çš„å€¼è¢«è®¾ç½®ä¸º EAGAIN ç³»ç»Ÿå†…å­˜ä¸è¶³ï¼Œè¿™æ—¶ errno çš„å€¼è¢«è®¾ç½®ä¸º ENOMEM fpid çš„å€¼åœ¨çˆ¶å­è¿›ç¨‹ä¸­ä¸åŒï¼šè¿›ç¨‹å½¢æˆäº†é“¾è¡¨ï¼Œçˆ¶è¿›ç¨‹çš„ fpid æŒ‡å‘å­è¿›ç¨‹çš„è¿›ç¨‹ idï¼Œå› ä¸ºå­è¿›ç¨‹æ²¡æœ‰å­è¿›ç¨‹ï¼Œæ‰€ä»¥å…¶ fpid ä¸º0 åˆ›å»ºæ–°è¿›ç¨‹æˆåŠŸåï¼Œç³»ç»Ÿä¸­å‡ºç°ä¸¤ä¸ªåŸºæœ¬å®Œå…¨ç›¸åŒçš„è¿›ç¨‹ï¼Œè¿™ä¸¤ä¸ªè¿›ç¨‹æ‰§è¡Œæ²¡æœ‰å›ºå®šçš„å…ˆåé¡ºåºï¼Œå“ªä¸ªè¿›ç¨‹å…ˆæ‰§è¡Œè¦çœ‹ç³»ç»Ÿçš„è°ƒåº¦ç­–ç•¥ æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªç‹¬ç‰¹ï¼ˆäº’ä¸ç›¸åŒï¼‰çš„è¿›ç¨‹æ ‡è¯†ç¬¦ process IDï¼Œå¯ä»¥é€šè¿‡ getpid() å‡½æ•°è·å¾—ï¼›è¿˜æœ‰ä¸€ä¸ªè®°å½•çˆ¶è¿›ç¨‹ pid çš„å˜é‡ï¼Œå¯ä»¥é€šè¿‡ getppid() å‡½æ•°è·å¾—å˜é‡çš„å€¼ ä½¿ç”¨åŸºæœ¬ä½¿ç”¨ï¼š 1234567891011121314151617181920212223242526#include &lt;unistd.h&gt; #include &lt;stdio.h&gt; int main () &#123; pid_t fpid; // fpidè¡¨ç¤ºforkå‡½æ•°è¿”å›çš„å€¼ int count = 0; fpid = fork(); if (fpid &lt; 0) printf(&quot;error in fork!&quot;); else if (fpid == 0) &#123; printf(&quot;i am the child process, my process id is %d/n&quot;, getpid()); count++; &#125; else &#123; printf(&quot;i am the parent process, my process id is %d/n&quot;, getpid()); count++; &#125; printf(&quot;count: %d/n&quot;,count);// 1 return 0; &#125; /* è¾“å‡ºå†…å®¹ï¼š i am the child process, my process id is 5574 count: 1 i am the parent process, my process id is 5573 count: 1*/ è¿›é˜¶ä½¿ç”¨ï¼š 1234567891011121314151617181920212223242526#include &lt;unistd.h&gt; #include &lt;stdio.h&gt; int main(void) &#123; int i = 0; // ppid æŒ‡å½“å‰è¿›ç¨‹çš„çˆ¶è¿›ç¨‹pid // pid æŒ‡å½“å‰è¿›ç¨‹çš„pid, // fpid æŒ‡forkè¿”å›ç»™å½“å‰è¿›ç¨‹çš„å€¼ï¼Œåœ¨è¿™å¯ä»¥è¡¨ç¤ºå­è¿›ç¨‹ for(i = 0; i &lt; 2; i++)&#123; pid_t fpid = fork(); if(fpid == 0) printf(&quot;%d child %4d %4d %4d/n&quot;,i, getppid(), getpid(), fpid); else printf(&quot;%d parent %4d %4d %4d/n&quot;,i, getppid(), getpid(),fpid); &#125; return 0; &#125; /*è¾“å‡ºå†…å®¹ï¼š i çˆ¶id id å­id 0 parent 2043 3224 3225 0 child 3224 3225 0 1 parent 2043 3224 3226 1 parent 3224 3225 3227 1 child 1 3227 0 1 child 1 3226 0 */ åœ¨ p3224 å’Œ p3225 æ‰§è¡Œå®Œç¬¬äºŒä¸ªå¾ªç¯åï¼Œmain å‡½æ•°é€€å‡ºï¼Œè¿›ç¨‹æ­»äº¡ã€‚æ‰€ä»¥ p3226ï¼Œp3227 å°±æ²¡æœ‰çˆ¶è¿›ç¨‹äº†ï¼Œæˆä¸ºå­¤å„¿è¿›ç¨‹ï¼Œæ‰€ä»¥ p3226 å’Œ p3227 çš„çˆ¶è¿›ç¨‹å°±è¢«ç½®ä¸º ID ä¸º 1 çš„ init è¿›ç¨‹ï¼ˆç¬”è®° Tool â†’ Linux â†’ è¿›ç¨‹ç®¡ç†è¯¦è§£ï¼‰ å‚è€ƒæ–‡ç« ï¼šhttps://blog.csdn.net/love_gaohz/article/details/41727415 å†…å­˜fork() è°ƒç”¨ä¹‹åçˆ¶å­è¿›ç¨‹çš„å†…å­˜å…³ç³» æ—©æœŸ Linux çš„ fork() å®ç°æ—¶ï¼Œå°±æ˜¯å…¨éƒ¨å¤åˆ¶ï¼Œè¿™ç§æ–¹æ³•æ•ˆç‡å¤ªä½ï¼Œè€Œä¸”é€ æˆäº†å¾ˆå¤§çš„å†…å­˜æµªè´¹ï¼Œç°åœ¨ Linux å®ç°é‡‡ç”¨äº†ä¸¤ç§æ–¹æ³•ï¼š çˆ¶å­è¿›ç¨‹çš„ä»£ç æ®µæ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥ä»£ç æ®µæ˜¯æ²¡å¿…è¦å¤åˆ¶çš„ï¼Œåªéœ€å†…æ ¸å°†ä»£ç æ®µæ ‡è®°ä¸ºåªè¯»ï¼Œçˆ¶å­è¿›ç¨‹å°±å…±äº«æ­¤ä»£ç æ®µã€‚fork() ä¹‹ååœ¨è¿›ç¨‹åˆ›å»ºä»£ç æ®µæ—¶ï¼Œå­è¿›ç¨‹çš„è¿›ç¨‹çº§é¡µè¡¨é¡¹éƒ½æŒ‡å‘å’Œçˆ¶è¿›ç¨‹ç›¸åŒçš„ç‰©ç†é¡µå¸§ å¯¹äºçˆ¶è¿›ç¨‹çš„æ•°æ®æ®µï¼Œå †æ®µï¼Œæ ˆæ®µä¸­çš„å„é¡µï¼Œç”±äºçˆ¶å­è¿›ç¨‹ç›¸äº’ç‹¬ç«‹ï¼Œé‡‡ç”¨å†™æ—¶å¤åˆ¶ COW çš„æŠ€æœ¯ï¼Œæ¥æé«˜å†…å­˜ä»¥åŠå†…æ ¸çš„åˆ©ç”¨ç‡ åœ¨ fork ä¹‹åä¸¤ä¸ªè¿›ç¨‹ç”¨çš„æ˜¯ç›¸åŒçš„ç‰©ç†ç©ºé—´ï¼ˆå†…å­˜åŒºï¼‰ï¼Œå­è¿›ç¨‹çš„ä»£ç æ®µã€æ•°æ®æ®µã€å †æ ˆéƒ½æ˜¯æŒ‡å‘çˆ¶è¿›ç¨‹çš„ç‰©ç†ç©ºé—´ï¼Œä¸¤è€…çš„è™šæ‹Ÿç©ºé—´ä¸åŒï¼Œä½†å…¶å¯¹åº”çš„ç‰©ç†ç©ºé—´æ˜¯åŒä¸€ä¸ªï¼Œå½“çˆ¶å­è¿›ç¨‹ä¸­æœ‰æ›´æ”¹ç›¸åº”æ®µçš„è¡Œä¸ºå‘ç”Ÿæ—¶ï¼Œå†ä¸ºå­è¿›ç¨‹ç›¸åº”çš„æ®µåˆ†é…ç‰©ç†ç©ºé—´ã€‚å¦‚æœä¸¤è€…çš„ä»£ç å®Œå…¨ç›¸åŒï¼Œä»£ç æ®µç»§ç»­å…±äº«çˆ¶è¿›ç¨‹çš„ç‰©ç†ç©ºé—´ï¼›è€Œå¦‚æœä¸¤è€…æ‰§è¡Œçš„ä»£ç ä¸åŒï¼Œå­è¿›ç¨‹çš„ä»£ç æ®µä¹Ÿä¼šåˆ†é…å•ç‹¬çš„ç‰©ç†ç©ºé—´ã€‚ fork ä¹‹åå†…æ ¸ä¼šå°†å­è¿›ç¨‹æ”¾åœ¨é˜Ÿåˆ—çš„å‰é¢ï¼Œè®©å­è¿›ç¨‹å…ˆæ‰§è¡Œï¼Œä»¥å…çˆ¶è¿›ç¨‹æ‰§è¡Œå¯¼è‡´å†™æ—¶å¤åˆ¶ï¼Œè€Œåå­è¿›ç¨‹å†æ‰§è¡Œï¼Œå› æ— æ„ä¹‰çš„å¤åˆ¶è€Œé€ æˆæ•ˆç‡çš„ä¸‹é™ è¡¥å……çŸ¥è¯†ï¼š vforkï¼ˆè™šæ‹Ÿå†…å­˜ fork virtual memory forkï¼‰ï¼šè°ƒç”¨ vfork() çˆ¶è¿›ç¨‹è¢«æŒ‚èµ·ï¼Œå­è¿›ç¨‹ä½¿ç”¨çˆ¶è¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚ä¸é‡‡ç”¨å†™æ—¶å¤åˆ¶ï¼Œå¦‚æœå­è¿›ç¨‹ä¿®æ”¹çˆ¶åœ°å€ç©ºé—´çš„ä»»ä½•é¡µé¢ï¼Œè¿™äº›ä¿®æ”¹è¿‡çš„é¡µé¢å¯¹äºæ¢å¤çš„çˆ¶è¿›ç¨‹æ˜¯å¯è§çš„ å‚è€ƒæ–‡ç« ï¼šhttps://blog.csdn.net/Shreck66/article/details/47039937 äº‹åŠ¡æœºåˆ¶äº‹åŠ¡ç‰¹å¾Redis äº‹åŠ¡å°±æ˜¯å°†å¤šä¸ªå‘½ä»¤è¯·æ±‚æ‰“åŒ…ï¼Œç„¶åä¸€æ¬¡æ€§ã€æŒ‰é¡ºåºåœ°æ‰§è¡Œå¤šä¸ªå‘½ä»¤çš„æœºåˆ¶ï¼Œå¹¶ä¸”åœ¨äº‹åŠ¡æ‰§è¡ŒæœŸé—´ï¼ŒæœåŠ¡å™¨ä¸ä¼šä¸­æ–­äº‹åŠ¡å»æ‰§è¡Œå…¶ä»–çš„å‘½ä»¤è¯·æ±‚ï¼Œä¼šå°†äº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½æ‰§è¡Œå®Œæ¯•ï¼Œç„¶åæ‰å»å¤„ç†å…¶ä»–å®¢æˆ·ç«¯çš„å‘½ä»¤è¯·æ±‚ï¼ŒRedis äº‹åŠ¡çš„ç‰¹æ€§ï¼š Redis äº‹åŠ¡æ²¡æœ‰éš”ç¦»çº§åˆ«çš„æ¦‚å¿µï¼Œé˜Ÿåˆ—ä¸­çš„å‘½ä»¤åœ¨äº‹åŠ¡æ²¡æœ‰æäº¤ä¹‹å‰éƒ½ä¸ä¼šå®é™…è¢«æ‰§è¡Œ Redis å•æ¡å‘½ä»¤å¼ä¿å­˜åŸå­æ€§çš„ï¼Œä½†æ˜¯äº‹åŠ¡ä¸ä¿è¯åŸå­æ€§ï¼Œäº‹åŠ¡ä¸­å¦‚æœæœ‰ä¸€æ¡å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå…¶åçš„å‘½ä»¤ä»ç„¶ä¼šè¢«æ‰§è¡Œï¼Œæ²¡æœ‰å›æ»š å·¥ä½œæµç¨‹äº‹åŠ¡çš„æ‰§è¡Œæµç¨‹åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š äº‹åŠ¡å¼€å§‹ï¼šMULTI å‘½ä»¤çš„æ‰§è¡Œæ ‡å¿—ç€äº‹åŠ¡çš„å¼€å§‹ï¼Œé€šè¿‡åœ¨å®¢æˆ·ç«¯çŠ¶æ€çš„ flags å±æ€§ä¸­æ‰“å¼€ REDIS_MULTI æ ‡è¯†ï¼Œå°†æ‰§è¡Œè¯¥å‘½ä»¤çš„å®¢æˆ·ç«¯ä»éäº‹åŠ¡çŠ¶æ€åˆ‡æ¢è‡³äº‹åŠ¡çŠ¶æ€ 1MULTI # è®¾å®šäº‹åŠ¡çš„å¼€å¯ä½ç½®ï¼Œæ­¤æŒ‡ä»¤æ‰§è¡Œåï¼Œåç»­çš„æ‰€æœ‰æŒ‡ä»¤å‡åŠ å…¥åˆ°äº‹åŠ¡ä¸­ å‘½ä»¤å…¥é˜Ÿï¼šäº‹åŠ¡é˜Ÿåˆ—ä»¥å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„æ–¹å¼ä¿å­˜å…¥é˜Ÿçš„å‘½ä»¤ï¼Œæ¯ä¸ª Redis å®¢æˆ·ç«¯éƒ½æœ‰äº‹åŠ¡çŠ¶æ€ï¼ŒåŒ…å«ç€äº‹åŠ¡é˜Ÿåˆ—ï¼š 123456789101112typedef struct redisClient &#123; // äº‹åŠ¡çŠ¶æ€ multiState mstate; /* MULTI/EXEC state */ &#125;typedef struct multiState &#123; // äº‹åŠ¡é˜Ÿåˆ—ï¼ŒFIFOé¡ºåº multiCmd *commands; // å·²å…¥é˜Ÿå‘½ä»¤è®¡æ•° int countï¼›&#125; å¦‚æœå‘½ä»¤ä¸º EXECã€DISCARDã€WATCHã€MULTI å››ä¸ªå‘½ä¸­çš„ä¸€ä¸ªï¼Œé‚£ä¹ˆæœåŠ¡å™¨ç«‹å³æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ å…¶ä»–å‘½ä»¤æœåŠ¡å™¨ä¸æ‰§è¡Œï¼Œè€Œæ˜¯å°†å‘½ä»¤æ”¾å…¥ä¸€ä¸ªäº‹åŠ¡é˜Ÿåˆ—é‡Œé¢ï¼Œç„¶åå‘å®¢æˆ·ç«¯è¿”å› QUEUED å›å¤ äº‹åŠ¡æ‰§è¡Œï¼šEXEC æäº¤äº‹åŠ¡ç»™æœåŠ¡å™¨æ‰§è¡Œï¼ŒæœåŠ¡å™¨ä¼šéå†è¿™ä¸ªå®¢æˆ·ç«¯çš„äº‹åŠ¡é˜Ÿåˆ—ï¼Œæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„å‘½ä»¤å¹¶å°†æ‰§è¡Œç»“æœè¿”å› 1EXEC # Commit æäº¤ï¼Œæ‰§è¡Œäº‹åŠ¡ï¼Œä¸multiæˆå¯¹å‡ºç°ï¼Œæˆå¯¹ä½¿ç”¨ äº‹åŠ¡å–æ¶ˆçš„æ–¹æ³•ï¼š å–æ¶ˆäº‹åŠ¡ï¼š 1DISCARD # ç»ˆæ­¢å½“å‰äº‹åŠ¡çš„å®šä¹‰ï¼Œå‘ç”Ÿåœ¨multiä¹‹åï¼Œexecä¹‹å‰ ä¸€èˆ¬ç”¨äºäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­è¾“å…¥äº†é”™è¯¯çš„æŒ‡ä»¤ï¼Œç›´æ¥å–æ¶ˆè¿™æ¬¡äº‹åŠ¡ï¼Œç±»ä¼¼äºå›æ»š WATCHç›‘è§†æœºåˆ¶WATCH å‘½ä»¤æ˜¯ä¸€ä¸ªä¹è§‚é”ï¼ˆoptimistic lockingï¼‰ï¼Œå¯ä»¥åœ¨ EXEC å‘½ä»¤æ‰§è¡Œä¹‹å‰ï¼Œç›‘è§†ä»»æ„æ•°é‡çš„æ•°æ®åº“é”®ï¼Œå¹¶åœ¨ EXEC å‘½ä»¤æ‰§è¡Œæ—¶ï¼Œæ£€æŸ¥è¢«ç›‘è§†çš„é”®æ˜¯å¦è‡³å°‘æœ‰ä¸€ä¸ªå·²ç»è¢«ä¿®æ”¹è¿‡äº†ï¼Œå¦‚æœæ˜¯æœåŠ¡å™¨å°†æ‹’ç»æ‰§è¡Œäº‹åŠ¡ï¼Œå¹¶å‘å®¢æˆ·ç«¯è¿”å›ä»£è¡¨äº‹åŠ¡æ‰§è¡Œå¤±è´¥çš„ç©ºå›å¤ æ·»åŠ ç›‘æ§é” 1WATCH key1 [key2â€¦â€¦] #å¯ä»¥ç›‘æ§ä¸€ä¸ªæˆ–è€…å¤šä¸ªkey å–æ¶ˆå¯¹æ‰€æœ‰ key çš„ç›‘è§† 1UNWATCH å®ç°åŸç†æ¯ä¸ª Redis æ•°æ®åº“éƒ½ä¿å­˜ç€ä¸€ä¸ª watched_keys å­—å…¸ï¼Œé”®æ˜¯æŸä¸ªè¢« WATCH ç›‘è§†çš„æ•°æ®åº“é”®ï¼Œå€¼åˆ™æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œè®°å½•äº†æ‰€æœ‰ç›‘è§†ç›¸åº”æ•°æ®åº“é”®çš„å®¢æˆ·ç«¯ï¼š 1234typedef struct redisDb &#123; // æ­£åœ¨è¢« WATCH å‘½ä»¤ç›‘è§†çš„é”® dict *watched_keys;&#125; æ‰€æœ‰å¯¹æ•°æ®åº“è¿›è¡Œä¿®æ”¹çš„å‘½ä»¤ï¼Œåœ¨æ‰§è¡Œåéƒ½ä¼šè°ƒç”¨ multi.c/touchWatchKey å‡½æ•°å¯¹ watched_keys å­—å…¸è¿›è¡Œæ£€æŸ¥ï¼Œæ˜¯å¦æœ‰å®¢æˆ·ç«¯æ­£åœ¨ç›‘è§†åˆšè¢«å‘½ä»¤ä¿®æ”¹è¿‡çš„æ•°æ®åº“é”®ï¼Œå¦‚æœæœ‰çš„è¯å‡½æ•°ä¼šå°†ç›‘è§†è¢«ä¿®æ”¹é”®çš„å®¢æˆ·ç«¯çš„ REDIS_DIRTY_CAS æ ‡è¯†æ‰“å¼€ï¼Œè¡¨ç¤ºè¯¥å®¢æˆ·ç«¯çš„äº‹åŠ¡å®‰å…¨æ€§å·²ç»è¢«ç ´å æœåŠ¡å™¨æ¥æ”¶åˆ°ä¸ªå®¢æˆ·ç«¯ EXEC å‘½ä»¤æ—¶ï¼Œä¼šæ ¹æ®è¿™ä¸ªå®¢æˆ·ç«¯æ˜¯å¦æ‰“å¼€äº† REDIS_DIRTY_CAS æ ‡è¯†ï¼Œå¦‚æœæ‰“å¼€äº†è¯´æ˜å®¢æˆ·ç«¯æäº¤äº‹åŠ¡ä¸å®‰å…¨ï¼ŒæœåŠ¡å™¨ä¼šæ‹’ç»æ‰§è¡Œ ACIDåŸå­æ€§äº‹åŠ¡å…·æœ‰åŸå­æ€§ï¼ˆAtomicityï¼‰ã€ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€éš”ç¦»æ€§ï¼ˆIsolationï¼‰ã€æŒä¹…æ€§ï¼ˆDurabilityï¼‰ åŸå­æ€§æŒ‡äº‹åŠ¡é˜Ÿåˆ—ä¸­çš„å‘½ä»¤è¦ä¹ˆå°±å…¨éƒ¨éƒ½æ‰§è¡Œï¼Œè¦ä¹ˆä¸€ä¸ªéƒ½ä¸æ‰§è¡Œï¼Œä½†æ˜¯åœ¨å‘½ä»¤æ‰§è¡Œå‡ºé”™æ—¶ï¼Œä¸ä¼šä¿è¯åŸå­æ€§ï¼ˆä¸‹ä¸€èŠ‚è¯¦è§£ï¼‰ Redis ä¸æ”¯æŒäº‹åŠ¡å›æ»šæœºåˆ¶ï¼ˆrollbackï¼‰ï¼Œå³ä½¿äº‹åŠ¡é˜Ÿåˆ—ä¸­çš„æŸä¸ªå‘½ä»¤åœ¨æ‰§è¡ŒæœŸé—´å‡ºç°äº†é”™è¯¯ï¼Œæ•´ä¸ªäº‹åŠ¡ä¹Ÿä¼šç»§ç»­æ‰§è¡Œä¸‹å»ï¼Œç›´åˆ°å°†äº‹åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½æ‰§è¡Œå®Œæ¯•ä¸ºæ­¢ å›æ»šéœ€è¦ç¨‹åºå‘˜åœ¨ä»£ç ä¸­å®ç°ï¼Œåº”è¯¥å°½å¯èƒ½é¿å…ï¼š äº‹åŠ¡æ“ä½œä¹‹å‰è®°å½•æ•°æ®çš„çŠ¶æ€ å•æ•°æ®ï¼šstring å¤šæ•°æ®ï¼šhashã€listã€setã€zset è®¾ç½®æŒ‡ä»¤æ¢å¤æ‰€æœ‰çš„è¢«ä¿®æ”¹çš„é¡¹ å•æ•°æ®ï¼šç›´æ¥ setï¼ˆæ³¨æ„å‘¨è¾¹å±æ€§ï¼Œä¾‹å¦‚æ—¶æ•ˆï¼‰ å¤šæ•°æ®ï¼šä¿®æ”¹å¯¹åº”å€¼æˆ–æ•´ä½“å…‹éš†å¤åˆ¶ ä¸€è‡´æ€§äº‹åŠ¡å…·æœ‰ä¸€è‡´æ€§æŒ‡çš„æ˜¯ï¼Œæ•°æ®åº“åœ¨æ‰§è¡Œäº‹åŠ¡ä¹‹å‰æ˜¯ä¸€è‡´çš„ï¼Œé‚£ä¹ˆåœ¨äº‹åŠ¡æ‰§è¡Œä¹‹åï¼Œæ— è®ºäº‹åŠ¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸï¼Œæ•°æ®åº“ä¹Ÿåº”è¯¥ä»ç„¶æ˜¯ä¸€è‡´çš„ ä¸€è‡´æ˜¯æ•°æ®ç¬¦åˆæ•°æ®åº“çš„å®šä¹‰å’Œè¦æ±‚ï¼Œæ²¡æœ‰åŒ…å«éæ³•æˆ–è€…æ— æ•ˆçš„é”™è¯¯æ•°æ®ï¼ŒRedis é€šè¿‡é”™è¯¯æ£€æµ‹å’Œç®€å•çš„è®¾è®¡æ¥ä¿è¯äº‹åŠ¡çš„ä¸€è‡´æ€§ï¼š å…¥é˜Ÿé”™è¯¯ï¼šå‘½ä»¤æ ¼å¼è¾“å…¥é”™è¯¯ï¼Œå‡ºç°è¯­æ³•é”™è¯¯é€ æˆï¼Œæ•´ä½“äº‹åŠ¡ä¸­æ‰€æœ‰å‘½ä»¤å‡ä¸ä¼šæ‰§è¡Œï¼ŒåŒ…æ‹¬é‚£äº›è¯­æ³•æ­£ç¡®çš„å‘½ä»¤ æ‰§è¡Œé”™è¯¯ï¼šå‘½ä»¤æ‰§è¡Œå‡ºç°é”™è¯¯ï¼Œä¾‹å¦‚å¯¹å­—ç¬¦ä¸²è¿›è¡Œ incr æ“ä½œï¼Œäº‹åŠ¡ä¸­æ­£ç¡®çš„å‘½ä»¤ä¼šè¢«æ‰§è¡Œï¼Œè¿è¡Œé”™è¯¯çš„å‘½ä»¤ä¸ä¼šè¢«æ‰§è¡Œ æœåŠ¡å™¨åœæœºï¼š å¦‚æœæœåŠ¡å™¨è¿è¡Œåœ¨æ— æŒä¹…åŒ–çš„å†…å­˜æ¨¡å¼ä¸‹ï¼Œé‚£ä¹ˆé‡å¯ä¹‹åçš„æ•°æ®åº“å°†æ˜¯ç©ºç™½çš„ï¼Œå› æ­¤æ•°æ®åº“æ˜¯ä¸€è‡´çš„ å¦‚æœæœåŠ¡å™¨è¿è¡Œåœ¨æŒä¹…åŒ–æ¨¡å¼ä¸‹ï¼Œé‡å¯ä¹‹åå°†æ•°æ®åº“è¿˜åŸåˆ°ä¸€è‡´çš„çŠ¶æ€ éš”ç¦»æ€§Redis æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„æ‰§è¡ŒåŸç†ï¼Œæ‰€ä»¥å¯¹äºéš”ç¦»æ€§ï¼Œåˆ†ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š å¹¶å‘æ“ä½œåœ¨ EXEC å‘½ä»¤å‰æ‰§è¡Œï¼Œéš”ç¦»æ€§çš„ä¿è¯è¦ä½¿ç”¨ WATCH æœºåˆ¶æ¥å®ç°ï¼Œå¦åˆ™éš”ç¦»æ€§æ— æ³•ä¿è¯ å¹¶å‘æ“ä½œåœ¨ EXEC å‘½ä»¤åæ‰§è¡Œï¼Œéš”ç¦»æ€§å¯ä»¥ä¿è¯ æŒä¹…æ€§Redis å¹¶æ²¡æœ‰ä¸ºäº‹åŠ¡æä¾›ä»»ä½•é¢å¤–çš„æŒä¹…åŒ–åŠŸèƒ½ï¼Œäº‹åŠ¡çš„æŒä¹…æ€§ç”± Redis æ‰€ä½¿ç”¨çš„æŒä¹…åŒ–æ¨¡å¼å†³å®š é…ç½®é€‰é¡¹ no-appendfsync-on-rewrite å¯ä»¥é…åˆ appendfsync é€‰é¡¹åœ¨ AOF æŒä¹…åŒ–æ¨¡å¼ä½¿ç”¨ï¼š é€‰é¡¹æ‰“å¼€æ—¶åœ¨æ‰§è¡Œ BGSAVE æˆ–è€… BGREWRITEAOF æœŸé—´ï¼ŒæœåŠ¡å™¨ä¼šæš‚æ—¶åœæ­¢å¯¹ AOF æ–‡ä»¶è¿›è¡ŒåŒæ­¥ï¼Œä»è€Œå°½å¯èƒ½åœ°å‡å°‘ I&#x2F;O é˜»å¡ é€‰é¡¹æ‰“å¼€æ—¶è¿è¡Œåœ¨ always æ¨¡å¼çš„ AOF æŒä¹…åŒ–ï¼Œäº‹åŠ¡ä¹Ÿä¸å…·æœ‰æŒä¹…æ€§ï¼Œæ‰€ä»¥è¯¥é€‰é¡¹é»˜è®¤å…³é—­ åœ¨ä¸€ä¸ªäº‹åŠ¡çš„æœ€ååŠ ä¸Š SAVE å‘½ä»¤æ€»å¯ä»¥ä¿è¯äº‹åŠ¡çš„è€ä¹…æ€§ Lua è„šæœ¬ç¯å¢ƒåˆ›å»ºåŸºæœ¬ä»‹ç»Redis å¯¹ Lua è„šæœ¬æ”¯æŒï¼Œé€šè¿‡åœ¨æœåŠ¡å™¨ä¸­åµŒå…¥ Lua ç¯å¢ƒï¼Œå®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨ Lua è„šæœ¬ç›´æ¥åœ¨æœåŠ¡å™¨ç«¯åŸå­åœ°æ‰§è¡Œå¤šä¸ªå‘½ä»¤ 12EVAL &lt;script&gt; &lt;numkeys&gt; [key ...] [arg ...]EVALSHA &lt;sha1&gt; &lt;numkeys&gt; [key ...] [arg ...] EVAL å‘½ä»¤å¯ä»¥ç›´æ¥å¯¹è¾“å…¥çš„è„šæœ¬è®¡ç®—ï¼š 12redis&gt; EVAL &quot;return 1 + 1&quot; 0 # 0ä»£è¡¨éœ€è¦çš„å‚æ•°(integer) 2 EVALSHA å‘½ä»¤æ ¹æ®è„šæœ¬çš„ SHA1 æ ¡éªŒå’Œæ¥å¯¹è„šæœ¬è®¡ç®—ï¼š 12redis&gt; EVALSHA &quot;2f3lba2bb6d6a0f42ccl59d2e2dad55440778de3&quot; 0(integer) 2 åº”ç”¨åœºæ™¯ï¼šRedis åªä¿è¯å•æ¡å‘½ä»¤çš„åŸå­æ€§ï¼Œæ‰€ä»¥ä¸ºäº†å®ç°åŸå­æ“ä½œï¼Œå°†å¤šæ¡çš„å¯¹ Redis çš„æ“ä½œæ•´åˆåˆ°ä¸€ä¸ªè„šæœ¬é‡Œï¼Œä½†æ˜¯é¿å…æŠŠä¸éœ€è¦åšå¹¶å‘æ§åˆ¶çš„æ“ä½œå†™å…¥è„šæœ¬ä¸­ Lua è¯­æ³•ç‰¹ç‚¹ï¼š å£°æ˜å˜é‡çš„æ—¶å€™æ— éœ€æŒ‡å®šæ•°æ®ç±»å‹ï¼Œè€Œæ˜¯ç”¨ local æ¥å£°æ˜å˜é‡ä¸ºå±€éƒ¨å˜é‡ æ•°ç»„ä¸‹æ ‡æ˜¯ä» 1 å¼€å§‹ åˆ›å»ºè¿‡ç¨‹Redis æœåŠ¡å™¨åˆ›å»ºå¹¶ä¿®æ”¹ Lua ç¯å¢ƒçš„æ•´ä¸ªè¿‡ç¨‹ï¼š åˆ›å»ºä¸€ä¸ªåŸºç¡€çš„ Lua ç¯å¢ƒï¼Œè°ƒç”¨ Lua çš„ API å‡½æ•° lua_open è½½å…¥å¤šä¸ªå‡½æ•°åº“åˆ° Lua ç¯å¢ƒé‡Œé¢ï¼Œè®© Lua è„šæœ¬å¯ä»¥ä½¿ç”¨è¿™äº›å‡½æ•°åº“æ¥è¿›è¡Œæ•°æ®æ“ä½œï¼ŒåŒ…æ‹¬åŸºç¡€æ ¸å¿ƒå‡½æ•° åˆ›å»ºå…¨å±€å˜é‡ redis è¡¨æ ¼ï¼Œè¡¨æ ¼åŒ…å«ä»¥ä¸‹å‡½æ•°ï¼š æ‰§è¡Œ Redis å‘½ä»¤çš„ redis.call å’Œ redis.pcall å‡½æ•° è®°å½• Redis æ—¥å¿—çš„ redis.log å‡½æ•°ï¼Œä»¥åŠç›¸åº”çš„æ—¥å¿—çº§åˆ« (level) å¸¸é‡ redis.LOG_DEBUG ç­‰ è®¡ç®— SHAl æ ¡éªŒå’Œçš„ redis.shalhex å‡½æ•° è¿”å›é”™è¯¯ä¿¡æ¯çš„ redis.error_reply å‡½æ•°å’Œ redis.status_reply å‡½æ•° ä½¿ç”¨ Redis è‡ªåˆ¶çš„éšæœºå‡½æ•°æ¥æ›¿æ¢ Lua åŸæœ‰çš„å¸¦æœ‰å‰¯ä½œç”¨çš„éšæœºå‡½æ•°ï¼Œä»è€Œé¿å…åœ¨è„šæœ¬ä¸­å¼•å…¥å‰¯ä½œç”¨ Redis è¦æ±‚æ‰€æœ‰ä¼ å…¥æœåŠ¡å™¨çš„ Lua è„šæœ¬ï¼Œä»¥åŠ Lua ç¯å¢ƒä¸­çš„æ‰€æœ‰å‡½æ•°ï¼Œéƒ½å¿…é¡»æ˜¯æ— å‰¯ä½œç”¨ï¼ˆside effectï¼‰çš„çº¯å‡½æ•°ï¼ˆpure functionï¼‰ï¼Œæ‰€ä»¥å¯¹æœ‰å‰¯ä½œç”¨çš„éšæœºå‡½æ•° math.random å’Œ math.randornseed è¿›è¡Œæ›¿æ¢ åˆ›å»ºæ’åºè¾…åŠ©å‡½æ•° _redis_compare_helperï¼Œä½¿ç”¨è¾…åŠ©å‡½æ•°æ¥å¯¹ä¸€éƒ¨åˆ† Redis å‘½ä»¤çš„ç»“æœè¿›è¡Œæ’åºï¼Œä»è€Œæ¶ˆé™¤å‘½ä»¤çš„ä¸ç¡®å®šæ€§ æ¯”å¦‚é›†åˆå…ƒç´ çš„æ’åˆ—æ˜¯æ— åºçš„ï¼Œ æ‰€ä»¥å³ä½¿ä¸¤ä¸ªé›†åˆçš„å…ƒç´ å®Œå…¨ç›¸åŒï¼Œè¾“å‡ºç»“æœä¹Ÿä¸ä¸€å®šç›¸åŒï¼ŒRedis å°† SMEMBERS è¿™ç±»åœ¨ç›¸åŒæ•°æ®é›†ä¸Šäº§ç”Ÿä¸åŒè¾“å‡ºçš„å‘½ä»¤ç§°ä¸ºå¸¦æœ‰ä¸ç¡®å®šæ€§çš„å‘½ä»¤ åˆ›å»º redis.pcall å‡½æ•°çš„é”™è¯¯æŠ¥å‘Šè¾…åŠ©å‡½æ•° _redis_err_handler ï¼Œè¿™ä¸ªå‡½æ•°å¯ä»¥æ‰“å°å‡ºé”™ä»£ç çš„æ¥æºå’Œå‘ç”Ÿé”™è¯¯çš„è¡Œæ•° å¯¹ Lua ç¯å¢ƒä¸­çš„å…¨å±€ç¯å¢ƒè¿›è¡Œä¿æŠ¤ï¼Œç¡®ä¿ä¼ å…¥æœåŠ¡å™¨çš„è„šæœ¬ä¸ä¼šå› å¿˜è®°ä½¿ç”¨ local å…³é”®å­—ï¼Œè€Œå°†é¢å¤–çš„å…¨å±€å˜é‡æ·»åŠ åˆ° Lua ç¯å¢ƒ å°†å®Œæˆä¿®æ”¹çš„ Lua ç¯å¢ƒä¿å­˜åˆ°æœåŠ¡å™¨çŠ¶æ€çš„ lua å±æ€§ä¸­ï¼Œç­‰å¾…æ‰§è¡ŒæœåŠ¡å™¨ä¼ æ¥çš„ Lua è„šæœ¬ 123struct redisServer &#123; Lua *lua;&#125;; Redis ä½¿ç”¨ä¸²è¡ŒåŒ–çš„æ–¹å¼æ¥æ‰§è¡Œ Redis å‘½ä»¤ï¼Œæ‰€ä»¥åœ¨ä»»ä½•æ—¶é—´é‡Œæœ€å¤šéƒ½åªä¼šæœ‰ä¸€ä¸ªè„šæœ¬èƒ½å¤Ÿè¢«æ”¾è¿› Lua ç¯å¢ƒé‡Œé¢è¿è¡Œï¼Œå› æ­¤æ•´ä¸ª Redis æœåŠ¡å™¨åªéœ€è¦åˆ›å»ºä¸€ä¸ª Lua ç¯å¢ƒå³å¯ åä½œç»„ä»¶ä¼ªå®¢æˆ·ç«¯Redis æœåŠ¡å™¨ä¸º Lua ç¯å¢ƒåˆ›å»ºäº†ä¸€ä¸ªä¼ªå®¢æˆ·ç«¯è´Ÿè´£å¤„ç† Lua è„šæœ¬ä¸­åŒ…å«çš„æ‰€æœ‰ Redis å‘½ä»¤ï¼Œå·¥ä½œæµç¨‹ï¼š Lua ç¯å¢ƒå°† redis.call æˆ–è€… redis.pcall å‡½æ•°æƒ³è¦æ‰§è¡Œçš„å‘½ä»¤ä¼ ç»™ä¼ªå®¢æˆ·ç«¯ ä¼ªå®¢æˆ·ç«¯å°†å‘½ä»¤ä¼ ç»™å‘½ä»¤æ‰§è¡Œå™¨ å‘½ä»¤æ‰§è¡Œå™¨æ‰§è¡Œå‘½ä»¤å¹¶å°†å‘½ä»¤çš„æ‰§è¡Œç»“æœè¿”å›ç»™ä¼ªå®¢æˆ·ç«¯ ä¼ªå®¢æˆ·ç«¯æ¥æ”¶å‘½ä»¤æ‰§è¡Œå™¨è¿”å›çš„å‘½ä»¤ç»“æœï¼Œå¹¶å°†ç»“æœè¿”å›ç»™ Lua ç¯å¢ƒ Lua å°†å‘½ä»¤ç»“æœè¿”å›ç»™ redis.call å‡½æ•°æˆ–è€… redis.pcall å‡½æ•° redis.call å‡½æ•°æˆ–è€… redis.pcall å‡½æ•°ä¼šå°†å‘½ä»¤ç»“æœä½œä¸ºè¿”å›å€¼è¿”å›ç»™è„šæœ¬çš„è°ƒç”¨è€… è„šæœ¬å­—å…¸Redis æœåŠ¡å™¨ä¸º Lua ç¯å¢ƒåˆ›å»º lua_scripts å­—å…¸ï¼Œé”®ä¸ºæŸä¸ª Lua è„šæœ¬çš„ SHA1 æ ¡éªŒå’Œï¼ˆchecksumï¼‰ï¼Œå€¼åˆ™æ˜¯æ ¡éªŒå’Œå¯¹åº”çš„ Lua è„šæœ¬ 123struct redisServer &#123; dict *lua_scripts;&#125;; æœåŠ¡å™¨ä¼šå°†æ‰€æœ‰è¢« EVAL å‘½ä»¤æ‰§è¡Œè¿‡çš„ Lua è„šæœ¬ï¼Œä»¥åŠæ‰€æœ‰è¢« SCRIPT LOAD å‘½ä»¤è½½å…¥è¿‡çš„ Lua è„šæœ¬éƒ½ä¿å­˜åˆ° lua_scripts å­—å…¸ 12redis&gt; SCRIPT LOAD &quot;return &#x27;hi&#x27;&quot;&quot;2f3lba2bb6d6a0f42ccl59d2e2dad55440778de3&quot; # å­—å…¸çš„é”®ï¼ŒSHA1 æ ¡éªŒå’Œ å‘½ä»¤å®ç°è„šæœ¬å‡½æ•°EVAL å‘½ä»¤çš„æ‰§è¡Œçš„ç¬¬ä¸€æ­¥æ˜¯ä¸ºä¼ å…¥çš„è„šæœ¬å®šä¹‰ä¸€ä¸ªç›¸å¯¹åº”çš„ Lua å‡½æ•°ï¼ŒLua å‡½æ•°çš„åå­—ç”± f_ å‰ç¼€åŠ ä¸Šè„šæœ¬çš„ SHA1 æ ¡éªŒå’Œï¼ˆå››åä¸ªå­—ç¬¦é•¿ï¼‰ç»„æˆï¼Œè€Œå‡½æ•°çš„ä½“ï¼ˆbodyï¼‰åˆ™æ˜¯è„šæœ¬æœ¬èº« 12345EVAL &quot;return &#x27;hello world&#x27;&quot; 0 # å‘½ä»¤å°†ä¼šå®šä¹‰ä»¥ä¸‹çš„å‡½æ•°function f_533203lc6b470dc5a0dd9b4bf2030dea6d65de91() &#123; return &#x27;hello world&#x27;&#125; ä½¿ç”¨å‡½æ•°æ¥ä¿å­˜å®¢æˆ·ç«¯ä¼ å…¥çš„è„šæœ¬æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š é€šè¿‡å‡½æ•°çš„å±€éƒ¨æ€§æ¥è®© Lua ç¯å¢ƒä¿æŒæ¸…æ´ï¼Œå‡å°‘äº†åƒåœ¾å›æ”¶çš„å·¥ä½œæœ€ï¼Œ å¹¶ä¸”é¿å…äº†ä½¿ç”¨å…¨å±€å˜é‡ å¦‚æœæŸä¸ªè„šæœ¬åœ¨ Lua ç¯å¢ƒä¸­è¢«å®šä¹‰è¿‡è‡³å°‘ä¸€æ¬¡ï¼Œé‚£ä¹ˆåªéœ€è¦ SHA1 æ ¡éªŒå’Œï¼ŒæœåŠ¡å™¨å°±å¯ä»¥åœ¨ä¸çŸ¥é“è„šæœ¬æœ¬èº«çš„æƒ…å†µä¸‹ï¼Œç›´æ¥é€šè¿‡è°ƒç”¨ Lua å‡½æ•°æ¥æ‰§è¡Œè„šæœ¬ EVAL å‘½ä»¤ç¬¬äºŒæ­¥æ˜¯å°†å®¢æˆ·ç«¯ä¼ å…¥çš„è„šæœ¬ä¿å­˜åˆ°æœåŠ¡å™¨çš„ lua_scripts å­—å…¸é‡Œï¼Œåœ¨å­—å…¸ä¸­æ–°æ·»åŠ ä¸€ä¸ªé”®å€¼å¯¹ æ‰§è¡Œå‡½æ•°EVAL å‘½ä»¤ç¬¬ä¸‰æ­¥æ˜¯æ‰§è¡Œè„šæœ¬å‡½æ•° å°† EVAL å‘½ä»¤ä¸­ä¼ å…¥çš„é”®åå‚æ•°å’Œè„šæœ¬å‚æ•°åˆ†åˆ«ä¿å­˜åˆ° KEYS æ•°ç»„å’Œ ARGV æ•°ç»„ï¼Œå°†è¿™ä¸¤ä¸ªæ•°ç»„ä½œä¸ºå…¨å±€å˜é‡ä¼ å…¥åˆ° Lua ç¯å¢ƒ ä¸º Lua ç¯å¢ƒè£…è½½è¶…æ—¶å¤„ç†é’©å­ï¼ˆhookï¼‰ï¼Œè¿™ä¸ªé’©å­å¯ä»¥åœ¨è„šæœ¬å‡ºç°è¶…æ—¶è¿è¡Œæƒ…å†µæ—¶ï¼Œè®©å®¢æˆ·ç«¯é€šè¿‡ SCRIPT KILL å‘½ä»¤åœæ­¢è„šæœ¬ï¼Œæˆ–è€…é€šè¿‡ SHUTDOWN å‘½ä»¤ç›´æ¥å…³é—­æœåŠ¡å™¨ å› ä¸º Redis æ˜¯å•çº¿ç¨‹çš„æ‰§è¡Œå‘½ä»¤ï¼Œå½“ Lua è„šæœ¬é˜»å¡æ—¶éœ€è¦å…œåº•ç­–ç•¥ï¼Œå¯ä»¥ä¸­æ–­æ‰§è¡Œ æ‰§è¡Œè„šæœ¬å‡½æ•° ç§»é™¤ä¹‹å‰è£…è½½çš„è¶…æ—¶é’©å­ å°†æ‰§è¡Œè„šæœ¬å‡½æ•°çš„ç»“æœä¿å­˜åˆ°å®¢æˆ·ç«¯çŠ¶æ€çš„è¾“å‡ºç¼“å†²åŒºé‡Œï¼Œç­‰å¾…æœåŠ¡å™¨å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ EVALSHAEVALSHA å‘½ä»¤çš„å®ç°åŸç†å°±æ˜¯æ ¹æ®è„šæœ¬çš„ SHA1 æ ¡éªŒå’Œæ¥è°ƒç”¨è„šæœ¬å¯¹åº”çš„å‡½æ•°ï¼Œå¦‚æœå‡½æ•°åœ¨ Lua ç¯å¢ƒä¸­ä¸å­˜åœ¨ï¼Œæ‰¾ä¸åˆ° f_ å¼€å¤´çš„å‡½æ•°ï¼Œå°±ä¼šè¿”å› SCRIPT NOT FOUND ç®¡ç†å‘½ä»¤Redis ä¸­ä¸ Lua è„šæœ¬æœ‰å…³çš„ç®¡ç†å‘½ä»¤æœ‰å››ä¸ªï¼š SCRIPT FLUSHï¼šç”¨äºæ¸…é™¤æœåŠ¡å™¨ä¸­æ‰€æœ‰å’Œ Lua è„šæœ¬æœ‰å…³çš„ä¿¡æ¯ï¼Œä¼šé‡Šæ”¾å¹¶é‡å»º lua_scripts å­—å…¸ï¼Œå…³é—­ç°æœ‰çš„ Lua ç¯å¢ƒå¹¶é‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„ Lua ç¯å¢ƒ SCRIPT EXISTSï¼šæ ¹æ®è¾“å…¥çš„ SHA1 æ ¡éªŒå’Œï¼ˆå…è®¸ä¸€æ¬¡ä¼ å…¥å¤šä¸ªæ ¡éªŒå’Œï¼‰ï¼Œæ£€æŸ¥æ ¡éªŒå’Œå¯¹åº”çš„è„šæœ¬æ˜¯å¦å­˜åœ¨äºæœåŠ¡å™¨ä¸­ï¼Œé€šè¿‡æ£€æŸ¥ lua_scripts å­—å…¸å®ç° SCRIPT LOADï¼šåœ¨ Lua ç¯å¢ƒä¸­ä¸ºè„šæœ¬åˆ›å»ºç›¸å¯¹åº”çš„å‡½æ•°ï¼Œç„¶åå°†è„šæœ¬ä¿å­˜åˆ° lua_scriptså­—å…¸é‡Œ 12redis&gt; SCRIPT LOAD &quot;return &#x27;hi&#x27;&quot;&quot;2f3lba2bb6d6a0f42ccl59d2e2dad55440778de3&quot; SCRIPT KILLï¼šåœæ­¢è„šæœ¬ å¦‚æœæœåŠ¡å™¨é…ç½®äº† lua-time-liÂ­mit é€‰é¡¹ï¼Œé‚£ä¹ˆåœ¨æ¯æ¬¡æ‰§è¡Œ Lua è„šæœ¬ä¹‹å‰ï¼Œéƒ½ä¼šè®¾ç½®ä¸€ä¸ªè¶…æ—¶å¤„ç†çš„é’©å­ã€‚é’©å­ä¼šåœ¨è„šæœ¬è¿è¡ŒæœŸé—´ä¼šå®šæœŸæ£€æŸ¥è¿è¡Œæ—¶é—´æ˜¯å¦è¶…è¿‡é…ç½®æ—¶é—´ï¼Œå¦‚æœè¶…æ—¶é’©å­å°†å®šæœŸåœ¨è„šæœ¬è¿è¡Œçš„é—´éš™ä¸­ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰ SCRIPT KILL æˆ–è€… SHUTDOWN åˆ°è¾¾ï¼š å¦‚æœè¶…æ—¶è¿è¡Œçš„è„šæœ¬æ²¡æœ‰æ‰§è¡Œè¿‡å†™å…¥æ“ä½œï¼Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡ SCRIPT KILL æ¥åœæ­¢è¿™ä¸ªè„šæœ¬ å¦‚æœæ‰§è¡Œè¿‡å†™å…¥æ“ä½œï¼Œå®¢æˆ·ç«¯åªèƒ½ç”¨ SHUTDOWN nosave å‘½ä»¤æ¥åœæ­¢æœåŠ¡å™¨ï¼Œé˜²æ­¢ä¸åˆæ³•çš„æ•°æ®è¢«å†™å…¥æ•°æ®åº“ä¸­ è„šæœ¬å¤åˆ¶å‘½ä»¤å¤åˆ¶å½“æœåŠ¡å™¨è¿è¡Œåœ¨å¤åˆ¶æ¨¡å¼æ—¶ï¼Œå…·æœ‰å†™æ€§è´¨çš„è„šæœ¬å‘½ä»¤ä¹Ÿä¼šè¢«å¤åˆ¶åˆ°ä»æœåŠ¡å™¨ï¼ŒåŒ…æ‹¬ EVALã€EVALSHAã€SCRIPT FLUSHï¼Œä»¥åŠ SCRIPT LOAD å‘½ä»¤ Redis å¤åˆ¶ EVALã€SCRIPT FLUSHã€SCRIPT LOAD ä¸‰ä¸ªå‘½ä»¤çš„æ–¹æ³•å’Œå¤åˆ¶æ™®é€š Redis å‘½ä»¤çš„æ–¹æ³•ä¸€æ ·ï¼Œå½“ä¸»æœåŠ¡å™¨æ‰§è¡Œå®Œä»¥ä¸Šä¸‰ä¸ªå‘½ä»¤çš„å…¶ä¸­ä¸€ä¸ªæ—¶ï¼Œä¼šç›´æ¥å°†è¢«æ‰§è¡Œçš„å‘½ä»¤ä¼ æ’­ï¼ˆpropagateï¼‰ç»™æ‰€æœ‰ä»æœåŠ¡å™¨ï¼Œåœ¨ä»æœåŠ¡å™¨ä¸­äº§ç”Ÿç›¸åŒçš„æ•ˆæœ EVALSHAEVALSHA å‘½ä»¤çš„å¤åˆ¶æ“ä½œç›¸å¯¹å¤æ‚ï¼Œå› ä¸ºå¤šä¸ªä»æœåŠ¡å™¨ä¹‹é—´è½½å…¥ Lua è„šæœ¬çš„æ¸…å†µå„æœ‰ä¸åŒï¼Œä¸€ä¸ªåœ¨ä¸»æœåŠ¡å™¨è¢«æˆåŠŸæ‰§è¡Œçš„ EVALSHA å‘½ä»¤ï¼Œåœ¨ä»æœåŠ¡å™¨æ‰§è¡Œæ—¶å¯èƒ½ä¼šå‡ºç°è„šæœ¬æœªæ‰¾åˆ°ï¼ˆnot foundï¼‰é”™è¯¯ Redis è¦æ±‚ä¸»æœåŠ¡å™¨åœ¨ä¼ æ’­ EVALSHA å‘½ä»¤æ—¶ï¼Œå¿…é¡»ç¡®ä¿ EVALSHA å‘½ä»¤è¦æ‰§è¡Œçš„è„šæœ¬å·²ç»è¢«æ‰€æœ‰ä»æœåŠ¡å™¨è½½å…¥è¿‡ï¼Œå¦‚æœä¸èƒ½ç¡®ä¿ä¸»æœåŠ¡å™¨ä¼šå°† EVALSHA å‘½ä»¤è½¬æ¢æˆä¸€ä¸ªç­‰ä»·çš„ EVAL å‘½ä»¤ï¼Œç„¶åé€šè¿‡ä¼ æ’­ EVAL å‘½ä»¤æ¥ä»£æ›¿ EVALSHA å‘½ä»¤ ä¸»æœåŠ¡å™¨ä½¿ç”¨æœåŠ¡å™¨çŠ¶æ€çš„ repl_scriptcache_dict å­—å…¸è®°å½•å·²ç»å°†å“ªäº›è„šæœ¬ä¼ æ’­ç»™äº†æ‰€æœ‰ä»æœåŠ¡å™¨ï¼Œå½“ä¸€ä¸ªæ ¡éªŒå’Œå‡ºç°åœ¨å­—å…¸æ—¶ï¼Œè¯´æ˜æ ¡éªŒå’Œå¯¹åº”çš„ Lua è„šæœ¬å·²ç»ä¼ æ’­ç»™äº†æ‰€æœ‰ä»æœåŠ¡å™¨ï¼Œä¸»æœåŠ¡å™¨å¯ä»¥ç›´æ¥ä¼ æ’­ EVALSHA å‘½ä»¤ 1234struct redisServer &#123; // é”®æ˜¯ä¸€ä¸ªä¸ª Lua è„šæœ¬çš„ SHA1 æ ¡éªŒå’Œï¼Œå€¼åˆ™å…¨éƒ¨éƒ½æ˜¯ NULL dict *repl_scriptcache_dict;&#125; æ³¨æ„ï¼šæ¯å½“ä¸»æœåŠ¡å™¨æ·»åŠ ä¸€ä¸ªæ–°çš„ä»æœåŠ¡å™¨æ—¶ï¼Œéƒ½ä¼šæ¸…ç©º repl_scriptcache_dict å­—å…¸ï¼Œå› ä¸ºå­—å…¸é‡Œé¢è®°å½•çš„è„šæœ¬å·²ç»ä¸å†è¢«æ‰€æœ‰ä»æœåŠ¡å™¨è½½å…¥è¿‡ï¼Œæ‰€ä»¥æœåŠ¡å™¨ä»¥æ¸…ç©ºå­—å…¸çš„æ–¹å¼ï¼Œå¼ºåˆ¶é‡æ–°å‘æ‰€æœ‰ä»æœåŠ¡å™¨ä¼ æ’­è„šæœ¬ é€šè¿‡ä½¿ç”¨ EVALSHA å‘½ä»¤æŒ‡å®šçš„ SHA1 æ ¡éªŒå’Œï¼Œä»¥åŠ lua_scripts å­—å…¸ä¿å­˜çš„ Lua è„šæœ¬ï¼Œå¯ä»¥å°†ä¸€ä¸ª EVALSHA å‘½ä»¤è½¬åŒ–ä¸º EVAL å‘½ä»¤ 123EVALSHA &quot;533203lc6b470dc5a0dd9b4bf2030dea6d65de91&quot; 0 # -&gt; è½¬æ¢EVAL &quot;return&#x27;hello world&#x27;&quot; 0 è„šæœ¬å†…å®¹ &quot;return&#39;hello world&#39;&quot; æ¥æºäº lua_scripts å­—å…¸ 533203lc6b470dc5a0dd9b4bf2030dea6d65de91 é”®çš„å€¼ åˆ†å¸ƒå¼é”åŸºæœ¬æ“ä½œåœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸‹ï¼Œé”å˜é‡éœ€è¦ç”±ä¸€ä¸ªå…±äº«å­˜å‚¨ç³»ç»Ÿæ¥ç»´æŠ¤ï¼Œå¤šä¸ªå®¢æˆ·ç«¯æ‰å¯ä»¥é€šè¿‡è®¿é—®å…±äº«å­˜å‚¨ç³»ç»Ÿæ¥è®¿é—®é”å˜é‡ï¼ŒåŠ é”å’Œé‡Šæ”¾é”çš„æ“ä½œå°±å˜æˆäº†è¯»å–ã€åˆ¤æ–­å’Œè®¾ç½®å…±äº«å­˜å‚¨ç³»ç»Ÿä¸­çš„é”å˜é‡å€¼å¤šæ­¥æ“ä½œ Redis åˆ†å¸ƒå¼é”çš„åŸºæœ¬ä½¿ç”¨ï¼Œæ‚²è§‚é” ä½¿ç”¨ SETNX è®¾ç½®ä¸€ä¸ªå…¬å…±é” 1SETNX lock-key value # valueä»»æ„æ•°ï¼Œè¿”å›ä¸º1è®¾ç½®æˆåŠŸï¼Œè¿”å›ä¸º0è®¾ç½®å¤±è´¥ NXï¼šåªåœ¨é”®ä¸å­˜åœ¨æ—¶ï¼Œæ‰å¯¹é”®è¿›è¡Œè®¾ç½®æ“ä½œï¼ŒSET key value NX æ•ˆæœç­‰åŒäº SETNX key value XXï¼šåªåœ¨é”®å·²ç»å­˜åœ¨æ—¶ï¼Œæ‰å¯¹é”®è¿›è¡Œè®¾ç½®æ“ä½œ EXï¼šè®¾ç½®é”® key çš„è¿‡æœŸæ—¶é—´ï¼Œå•ä½æ—¶ç§’ PXï¼šè®¾ç½®é”® key çš„è¿‡æœŸæ—¶é—´ï¼Œå•ä½æ—¶æ¯«ç§’ è¯´æ˜ï¼šç”±äº SET å‘½ä»¤åŠ ä¸Šé€‰é¡¹å·²ç»å¯ä»¥å®Œå…¨å–ä»£ SETNXã€SETEXã€PSETEX çš„åŠŸèƒ½ï¼ŒRedis ä¸æ¨èä½¿ç”¨è¿™å‡ ä¸ªå‘½ä»¤ æ“ä½œå®Œæ¯•é€šè¿‡ DEL æ“ä½œé‡Šæ”¾é” 1DEL lock-key ä½¿ç”¨ EXPIRE ä¸ºé” key æ·»åŠ å­˜æ´»ï¼ˆæŒæœ‰ï¼‰æ—¶é—´ï¼Œè¿‡æœŸè‡ªåŠ¨åˆ é™¤ï¼ˆæ”¾å¼ƒï¼‰é”ï¼Œé˜²æ­¢çº¿ç¨‹å‡ºç°å¼‚å¸¸ï¼Œæ— æ³•é‡Šæ”¾é” 12EXPIRE lock-key second PEXPIRE lock-key milliseconds é€šè¿‡ EXPIRE è®¾ç½®è¿‡æœŸæ—¶é—´ç¼ºä¹åŸå­æ€§ï¼Œå¦‚æœåœ¨ SETNX å’Œ EXPIRE ä¹‹é—´å‡ºç°å¼‚å¸¸ï¼Œé”ä¹Ÿæ— æ³•é‡Šæ”¾ åœ¨ SET æ—¶æŒ‡å®šè¿‡æœŸæ—¶é—´ï¼Œä¿è¯åŸå­æ€§ 1234567891011121314151617181920 SET key value NX [EX seconds | PX milliseconds]****### é˜²è¯¯åˆ åœºæ™¯æè¿°ï¼šçº¿ç¨‹ A æ­£åœ¨æ‰§è¡Œï¼Œä½†æ˜¯ä¸šåŠ¡é˜»å¡ï¼Œåœ¨é”çš„è¿‡æœŸæ—¶é—´å†…æœªæ‰§è¡Œå®Œæˆï¼Œè¿‡æœŸåˆ é™¤åçº¿ç¨‹ B é‡æ–°è·å–åˆ°é”ï¼Œæ­¤æ—¶çº¿ç¨‹ A æ‰§è¡Œå®Œæˆï¼Œåˆ é™¤é”ï¼Œå¯¼è‡´çº¿ç¨‹ B çš„é”è¢«çº¿ç¨‹ A è¯¯åˆ SETNX è·å–é”æ—¶ï¼Œè®¾ç½®ä¸€ä¸ªæŒ‡å®šçš„å”¯ä¸€å€¼ï¼ˆUUIDï¼‰ï¼Œé‡Šæ”¾å‰è·å–è¿™ä¸ªå€¼ï¼Œåˆ¤æ–­æ˜¯å¦è‡ªå·±çš„é”ï¼Œé˜²æ­¢å‡ºç°çº¿ç¨‹ä¹‹é—´è¯¯åˆ äº†å…¶ä»–çº¿ç¨‹çš„é”```java// åŠ é”, unique_valueä½œä¸ºå®¢æˆ·ç«¯å”¯ä¸€æ€§çš„æ ‡è¯†ï¼Œ// PX 10000 åˆ™è¡¨ç¤º lock_key ä¼šåœ¨ 10s åè¿‡æœŸï¼Œä»¥å…å®¢æˆ·ç«¯åœ¨è¿™æœŸé—´å‘ç”Ÿå¼‚å¸¸è€Œæ— æ³•é‡Šæ”¾é”SET lock_key unique_value NX PX 10000 Lua è„šæœ¬ï¼ˆunlock.scriptï¼‰å®ç°çš„é‡Šæ”¾é”æ“ä½œçš„ä¼ªä»£ç ï¼škey ç±»å‹å‚æ•°ä¼šæ”¾å…¥ KEYS æ•°ç»„ï¼Œå…¶å®ƒå‚æ•°ä¼šæ”¾å…¥ ARGV æ•°ç»„ï¼Œåœ¨è„šæœ¬ä¸­é€šè¿‡ KEYS å’Œ ARGV ä¼ é€’å‚æ•°ï¼Œä¿è¯åˆ¤æ–­æ ‡è¯†å’Œé‡Šæ”¾é”è¿™ä¸¤ä¸ªæ“ä½œçš„åŸå­æ€§ 1EVAL &quot;return redis.call(&#x27;set&#x27;, KEYS[1], ARGV[1])&quot; 1 lock_key unique_value # 1 ä»£è¡¨éœ€è¦ä¸€ä¸ªå‚æ•° 1234567// é‡Šæ”¾é”ï¼ŒKEYS[1] å°±æ˜¯é”çš„ keyï¼ŒARGV[1] å°±æ˜¯æ ‡è¯†å€¼ï¼Œé¿å…è¯¯é‡Šæ”¾// è·å–æ ‡è¯†å€¼ï¼Œåˆ¤æ–­æ˜¯å¦ä¸å½“å‰çº¿ç¨‹æ ‡ç¤ºä¸€è‡´if redis.call(&quot;get&quot;, KEYS[1]) == ARGV[1] then return redis.call(&quot;del&quot;, KEYS[1])else return 0end ä¼˜åŒ–é”ä¸å¯é‡å…¥ä¸å¯é‡å…¥ï¼šåŒä¸€ä¸ªçº¿ç¨‹æ— æ³•å¤šæ¬¡è·å–åŒä¸€æŠŠé” ä½¿ç”¨ hash é”®ï¼Œfiled æ˜¯åŠ é”çš„çº¿ç¨‹æ ‡è¯†ï¼Œ value æ˜¯é”é‡å…¥æ¬¡æ•° 1234| key | value || | filed | value ||-------------------------------|| lock_key | thread1 | 1 | é”é‡å…¥ï¼š åŠ é”æ—¶åˆ¤æ–­é”çš„ filed å±æ€§æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯å°† value åŠ  1 è§£é”æ—¶åˆ¤æ–­é”çš„ filed å±æ€§æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹ï¼Œé¦–å…ˆå°† value å‡ä¸€ï¼Œå¦‚æœ value ä¸º 0 ç›´æ¥é‡Šæ”¾é” ä½¿ç”¨ Lua è„šæœ¬ä¿è¯å¤šæ¡å‘½ä»¤çš„åŸå­æ€§ ä¸å¯é‡è¯•ä¸å¯é‡è¯•ï¼šè·å–é”åªå°è¯•ä¸€æ¬¡å°±è¿”å› falseï¼Œæ²¡æœ‰é‡è¯•æœºåˆ¶ åˆ©ç”¨ Lua è„šæœ¬å°è¯•è·å–é”ï¼Œè·å–å¤±è´¥è·å–é”çš„å‰©ä½™è¶…æ—¶æ—¶é—´ ttlï¼Œæˆ–è€…é€šè¿‡å‚æ•°ä¼ å…¥çº¿ç¨‹æŠ¢é”å…è®¸ç­‰å¾…çš„æ—¶é—´ åˆ©ç”¨è®¢é˜…åŠŸèƒ½è®¢é˜…é”é‡Šæ”¾çš„ä¿¡æ¯ï¼Œç„¶åçº¿ç¨‹æŒ‚èµ·ç­‰å¾… ttl æ—¶é—´ åˆ©ç”¨ Lua è„šæœ¬åœ¨é‡Šæ”¾é”æ—¶ï¼Œå‘å¸ƒä¸€æ¡é”é‡Šæ”¾çš„æ¶ˆæ¯ è¶…æ—¶é‡Šæ”¾è¶…æ—¶é‡Šæ”¾ï¼šé”è¶…æ—¶é‡Šæ”¾å¯ä»¥é¿å…æ­»é”ï¼Œä½†å¦‚æœæ˜¯ä¸šåŠ¡æ‰§è¡Œè€—æ—¶è¾ƒé•¿ï¼Œéœ€è¦è¿›è¡Œé”ç»­æ—¶ï¼Œé˜²æ­¢ä¸šåŠ¡æœªæ‰§è¡Œå®Œæå‰é‡Šæ”¾é” çœ‹é—¨ç‹— Watch Dog æœºåˆ¶ï¼š è·å–é”æˆåŠŸåï¼Œæäº¤å‘¨æœŸä»»åŠ¡ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´ï¼ˆRedisson ä¸­é»˜è®¤ä¸ºè¿‡æœŸæ—¶é—´ &#x2F; 3ï¼‰ï¼Œé‡ç½®ä¸€æ¬¡è¶…æ—¶æ—¶é—´ å¦‚æœæœåŠ¡å®•æœºï¼ŒWatch Dog æœºåˆ¶çº¿ç¨‹å°±åœæ­¢ï¼Œå°±ä¸ä¼šå†å»¶é•¿ key çš„è¿‡æœŸæ—¶é—´ é‡Šæ”¾é”åï¼Œç»ˆæ­¢å‘¨æœŸä»»åŠ¡ ä¸»ä»ä¸€è‡´ä¸»ä»ä¸€è‡´æ€§ï¼šé›†ç¾¤æ¨¡å¼ä¸‹ï¼Œä¸»ä»åŒæ­¥å­˜åœ¨å»¶è¿Ÿï¼Œå½“åŠ é”åä¸»æœåŠ¡å™¨å®•æœºæ—¶ï¼Œä»æœåŠ¡å™¨è¿˜æ²¡åŒæ­¥ä¸»æœåŠ¡å™¨ä¸­çš„é”æ•°æ®ï¼Œæ­¤æ—¶ä»æœåŠ¡å™¨å‡çº§ä¸ºä¸»æœåŠ¡å™¨ï¼Œå…¶ä»–çº¿ç¨‹åˆå¯ä»¥è·å–åˆ°é” å°†æœåŠ¡å™¨å‡çº§ä¸ºå¤šä¸»å¤šä»ï¼š è·å–é”éœ€è¦ä»æ‰€æœ‰ä¸»æœåŠ¡å™¨ SET æˆåŠŸæ‰ç®—è·å–æˆåŠŸ æŸä¸ª master å®•æœºï¼Œslave è¿˜æ²¡æœ‰åŒæ­¥é”æ•°æ®å°±å‡çº§ä¸º masterï¼Œå…¶ä»–çº¿ç¨‹å°è¯•åŠ é”ä¼šåŠ é”å¤±è´¥ï¼Œå› ä¸ºå…¶ä»– master ä¸Šå·²ç»å­˜åœ¨è¯¥é” ä¸»ä»å¤åˆ¶åŸºæœ¬æ“ä½œä¸»ä»ä»‹ç»ä¸»ä»å¤åˆ¶ï¼šä¸€ä¸ªæœåŠ¡å™¨å»å¤åˆ¶å¦ä¸€ä¸ªæœåŠ¡å™¨ï¼Œè¢«å¤åˆ¶çš„æœåŠ¡å™¨ä¸ºä¸»æœåŠ¡å™¨ masterï¼Œå¤åˆ¶çš„æœåŠ¡å™¨ä¸ºä»æœåŠ¡å™¨ slave master ç”¨æ¥å†™æ•°æ®ï¼Œæ‰§è¡Œå†™æ“ä½œæ—¶ï¼Œå°†å‡ºç°å˜åŒ–çš„æ•°æ®è‡ªåŠ¨åŒæ­¥åˆ° slaveï¼Œå¾ˆå°‘ä¼šè¿›è¡Œè¯»å–æ“ä½œ slave ç”¨æ¥è¯»æ•°æ®ï¼Œç¦æ­¢åœ¨ slave æœåŠ¡å™¨ä¸Šè¿›è¡Œè¯»æ“ä½œ è¿›è¡Œå¤åˆ¶ä¸­çš„ä¸»ä»æœåŠ¡å™¨åŒæ–¹çš„æ•°æ®åº“å°†ä¿å­˜ç›¸åŒçš„æ•°æ®ï¼Œå°†è¿™ç§ç°è±¡ç§°ä½œæ•°æ®åº“çŠ¶æ€ä¸€è‡´ ä¸»ä»å¤åˆ¶çš„ç‰¹ç‚¹ï¼š è–ªç«ç›¸ä¼ ï¼šä¸€ä¸ª slave å¯ä»¥æ˜¯ä¸‹ä¸€ä¸ª slave çš„ masterï¼Œslave åŒæ ·å¯ä»¥æ¥æ”¶å…¶ä»– slave çš„è¿æ¥å’ŒåŒæ­¥è¯·æ±‚ï¼Œé‚£ä¹ˆè¯¥ slave ä½œä¸ºäº†é“¾æ¡ä¸­ä¸‹ä¸€ä¸ªçš„ masterï¼Œå¯ä»¥æœ‰æ•ˆå‡è½» master çš„å†™å‹åŠ›ï¼Œå»ä¸­å¿ƒåŒ–é™ä½é£é™© æ³¨æ„ï¼šä¸»æœºæŒ‚äº†ï¼Œä»æœºè¿˜æ˜¯ä»æœºï¼Œæ— æ³•å†™æ•°æ®äº† åå®¢ä¸ºä¸»ï¼šå½“ä¸€ä¸ª master å®•æœºåï¼Œåé¢çš„ slave å¯ä»¥ç«‹åˆ»å‡ä¸º masterï¼Œå…¶åé¢çš„ slave ä¸åšä»»ä½•ä¿®æ”¹ ä¸»ä»å¤åˆ¶çš„ä½œç”¨ï¼š è¯»å†™åˆ†ç¦»ï¼šmaster å†™ã€slave è¯»ï¼Œæé«˜æœåŠ¡å™¨çš„è¯»å†™è´Ÿè½½èƒ½åŠ› è´Ÿè½½å‡è¡¡ï¼šåŸºäºä¸»ä»ç»“æ„ï¼Œé…åˆè¯»å†™åˆ†ç¦»ï¼Œç”± slave åˆ†æ‹… master è´Ÿè½½ï¼Œå¹¶æ ¹æ®éœ€æ±‚çš„å˜åŒ–ï¼Œæ”¹å˜ slave çš„æ•°é‡ï¼Œé€šè¿‡å¤šä¸ªä»èŠ‚ç‚¹åˆ†æ‹…æ•°æ®è¯»å–è´Ÿè½½ï¼Œå¤§å¤§æé«˜ Redis æœåŠ¡å™¨å¹¶å‘é‡ä¸æ•°æ®ååé‡ æ•…éšœæ¢å¤ï¼šå½“ master å‡ºç°é—®é¢˜æ—¶ï¼Œç”± slave æä¾›æœåŠ¡ï¼Œå®ç°å¿«é€Ÿçš„æ•…éšœæ¢å¤ æ•°æ®å†—ä½™ï¼šå®ç°æ•°æ®çƒ­å¤‡ä»½ï¼Œæ˜¯æŒä¹…åŒ–ä¹‹å¤–çš„ä¸€ç§æ•°æ®å†—ä½™æ–¹å¼ é«˜å¯ç”¨åŸºçŸ³ï¼šåŸºäºä¸»ä»å¤åˆ¶ï¼Œæ„å»ºå“¨å…µæ¨¡å¼ä¸é›†ç¾¤ï¼Œå®ç° Redis çš„é«˜å¯ç”¨æ–¹æ¡ˆ ä¸‰é«˜æ¶æ„ï¼š é«˜å¹¶å‘ï¼šåº”ç”¨æä¾›æŸä¸€ä¸šåŠ¡è¦èƒ½æ”¯æŒå¾ˆå¤šå®¢æˆ·ç«¯åŒæ—¶è®¿é—®çš„èƒ½åŠ›ï¼Œç§°ä¸ºå¹¶å‘ é«˜æ€§èƒ½ï¼šæ€§èƒ½æœ€ç›´è§‚çš„æ„Ÿå—å°±æ˜¯é€Ÿåº¦å¿«ï¼Œæ—¶é—´çŸ­ é«˜å¯ç”¨ï¼š å¯ç”¨æ€§ï¼šåº”ç”¨æœåŠ¡åœ¨å…¨å¹´å®•æœºçš„æ—¶é—´åŠ åœ¨ä¸€èµ·å°±æ˜¯å…¨å¹´åº”ç”¨æœåŠ¡ä¸å¯ç”¨çš„æ—¶é—´ ä¸šç•Œå¯ç”¨æ€§ç›®æ ‡ 5 ä¸ª 9ï¼Œå³ 99.999%ï¼Œå³æœåŠ¡å™¨å¹´å®•æœºæ—¶é•¿ä½äº 315 ç§’ï¼Œçº¦ 5.25 åˆ†é’Ÿ æ“ä½œæŒ‡ä»¤ç³»ç»ŸçŠ¶æ€æŒ‡ä»¤ï¼š 1INFO replication master å’Œ slave äº’è¿ï¼š æ–¹å¼ä¸€ï¼šå®¢æˆ·ç«¯å‘é€å‘½ä»¤ï¼Œè®¾ç½® slaveof é€‰é¡¹ï¼Œäº§ç”Ÿä¸»ä»ç»“æ„ 1slaveof masterip masterport æ–¹å¼äºŒï¼šæœåŠ¡å™¨å¸¦å‚å¯åŠ¨ 1redis-server --slaveof masterip masterport æ–¹å¼ä¸‰ï¼šæœåŠ¡å™¨é…ç½®ï¼ˆä¸»æµæ–¹å¼ï¼‰ 1slaveof masterip masterport ä¸»ä»æ–­å¼€è¿æ¥ï¼š slave æ–­å¼€è¿æ¥åï¼Œä¸ä¼šåˆ é™¤å·²æœ‰æ•°æ®ï¼Œåªæ˜¯ä¸å†æ¥å— master å‘é€çš„æ•°æ®ï¼Œå¯ä»¥ä½œä¸ºä»æœåŠ¡å™¨å‡çº§ä¸ºä¸»æœåŠ¡å™¨çš„æŒ‡ä»¤ 1slaveof no one æˆæƒè®¿é—®ï¼šmaster æœ‰æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼Œslave ä¹Ÿæœ‰æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼Œä¸ä»…æœåŠ¡ç«¯ä¹‹é—´å¯ä»¥å‘å‘½ä»¤ï¼Œå®¢æˆ·ç«¯ä¹Ÿå¯ä»¥ master å®¢æˆ·ç«¯å‘é€å‘½ä»¤è®¾ç½®å¯†ç ï¼š 1requirepass password master é…ç½®æ–‡ä»¶è®¾ç½®å¯†ç ï¼š 12config set requirepass passwordconfig get requirepass slave å®¢æˆ·ç«¯å‘é€å‘½ä»¤è®¾ç½®å¯†ç ï¼š 1auth password slave é…ç½®æ–‡ä»¶è®¾ç½®å¯†ç ï¼š 1masterauth password slave å¯åŠ¨æœåŠ¡å™¨è®¾ç½®å¯†ç ï¼š 1redis-server â€“a password å¤åˆ¶æµç¨‹æ—§ç‰ˆå¤åˆ¶Redis çš„å¤åˆ¶åŠŸèƒ½åˆ†ä¸ºåŒæ­¥ï¼ˆsyncï¼‰å’Œå‘½ä»¤ä¼ æ’­ï¼ˆcommand propagateï¼‰ä¸¤ä¸ªæ“ä½œï¼Œä¸»ä»åº“é—´çš„å¤åˆ¶æ˜¯å¼‚æ­¥è¿›è¡Œçš„ åŒæ­¥æ“ä½œç”¨äºå°†ä»æœåŠ¡å™¨çš„æ•°æ®åº“çŠ¶æ€æ›´æ–°è‡³ä¸»æœåŠ¡å™¨å½“å‰æ‰€å¤„çš„æ•°æ®åº“çŠ¶æ€ï¼Œè¯¥è¿‡ç¨‹åˆå«å…¨é‡å¤åˆ¶ï¼š ä»æœåŠ¡å™¨å‘ä¸»æœåŠ¡å™¨å‘é€ SYNC å‘½ä»¤æ¥è¿›è¡ŒåŒæ­¥ æ”¶åˆ° SYNC çš„ä¸»æœåŠ¡å™¨æ‰§è¡Œ BGSAVE å‘½ä»¤ï¼Œåœ¨åå°ç”Ÿæˆä¸€ä¸ª RDB æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªç¼“å†²åŒºè®°å½•ä»ç°åœ¨å¼€å§‹æ‰§è¡Œçš„æ‰€æœ‰å†™å‘½ä»¤ å½“ BGSAVE å‘½ä»¤æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œä¸»æœåŠ¡å™¨ä¼šå°† RDB æ–‡ä»¶å‘é€ç»™ä»æœåŠ¡å™¨ ä»æœåŠ¡æ¥æ”¶å¹¶è½½å…¥ RDB æ–‡ä»¶ï¼ˆä»æœåŠ¡å™¨ä¼šæ¸…ç©ºåŸæœ‰æ•°æ®ï¼‰ ç¼“å†²åŒºè®°å½•äº† RDB æ–‡ä»¶æ‰€åœ¨çŠ¶æ€åçš„æ‰€æœ‰å†™å‘½ä»¤ï¼Œä¸»æœåŠ¡å™¨å°†åœ¨ç¼“å†²åŒºçš„æ‰€æœ‰å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œä»æœåŠ¡å™¨æ‰§è¡Œè¿™äº›å†™å‘½ä»¤ è‡³æ­¤ä»æœåŠ¡å™¨çš„æ•°æ®åº“çŠ¶æ€å’Œä¸»æœåŠ¡å™¨ä¸€è‡´ å‘½ä»¤ä¼ æ’­ç”¨äºåœ¨ä¸»æœåŠ¡å™¨çš„æ•°æ®åº“çŠ¶æ€è¢«ä¿®æ”¹ï¼Œå¯¼è‡´ä¸»ä»æ•°æ®åº“çŠ¶æ€å‡ºç°ä¸ä¸€è‡´æ—¶ï¼Œ è®©ä¸»ä»æœåŠ¡å™¨çš„æ•°æ®åº“é‡æ–°å›åˆ°ä¸€è‡´çŠ¶æ€ ä¸»æœåŠ¡å™¨ä¼šå°†è‡ªå·±æ‰§è¡Œçš„å†™å‘½ä»¤ï¼Œä¹Ÿå³æ˜¯é€ æˆä¸»ä»æœåŠ¡å™¨ä¸ä¸€è‡´çš„é‚£æ¡å†™å‘½ä»¤ï¼Œå‘é€ç»™ä»æœåŠ¡å™¨ ä»æœåŠ¡å™¨æ¥å—å‘½ä»¤å¹¶æ‰§è¡Œï¼Œä¸»ä»æœåŠ¡å™¨å°†å†æ¬¡å›åˆ°ä¸€è‡´çŠ¶æ€ åŠŸèƒ½ç¼ºé™·SYNC æœ¬èº«å°±æ˜¯ä¸€ä¸ªéå¸¸æ¶ˆè€—èµ„æºçš„æ“ä½œï¼Œæ¯æ¬¡æ‰§è¡Œ SYNC å‘½ä»¤ï¼Œéƒ½éœ€è¦æ‰§è¡Œä»¥ä¸‹åŠ¨ä½œï¼š ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œè€—è´¹ä¸»æœåŠ¡å™¨å¤§é‡ CPU ã€å†…å­˜å’Œç£ç›˜ I&#x2F;O èµ„æº RDB æ–‡ä»¶å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œè€—è´¹ä¸»ä»æœåŠ¡å™¨å¤§é‡çš„ç½‘ç»œèµ„æºï¼ˆå¸¦å®½å’Œæµé‡ï¼‰ï¼Œå¹¶å¯¹ä¸»æœåŠ¡å™¨å“åº”å‘½ä»¤è¯·æ±‚çš„æ—¶é—´äº§ç”Ÿå½±å“ ä»æœåŠ¡å™¨è½½å…¥ RDB æ–‡ä»¶ï¼ŒæœŸé—´ä¼šå› ä¸ºé˜»å¡è€Œæ²¡åŠæ³•å¤„ç†å‘½ä»¤è¯·æ±‚ SYNC å‘½ä»¤ä¸‹çš„ä»æœåŠ¡å™¨å¯¹ä¸»æœåŠ¡å™¨çš„å¤åˆ¶åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š åˆæ¬¡å¤åˆ¶ï¼šä»æœåŠ¡å™¨æ²¡æœ‰å¤åˆ¶è¿‡ä»»ä½•ä¸»æœåŠ¡å™¨ï¼Œæˆ–è€…ä»æœåŠ¡å™¨å½“å‰è¦å¤åˆ¶çš„ä¸»æœåŠ¡å™¨å’Œä¸Šä¸€æ¬¡å¤åˆ¶çš„ä¸»æœåŠ¡å™¨ä¸åŒ æ–­çº¿åé‡å¤åˆ¶ï¼šå¤„äºå‘½ä»¤ä¼ æ’­é˜¶æ®µçš„ä¸»ä»æœåŠ¡å™¨å› ä¸ºç½‘ç»œåŸå› è€Œä¸­æ–­äº†å¤åˆ¶ï¼Œè‡ªåŠ¨é‡è¿åå¹¶ç»§ç»­å¤åˆ¶ä¸»æœåŠ¡å™¨ æ—§ç‰ˆå¤åˆ¶åœ¨æ–­çº¿åé‡å¤åˆ¶æ—¶ï¼Œä¹Ÿä¼šåˆ›å»º RDB æ–‡ä»¶è¿›è¡Œå…¨é‡å¤åˆ¶ï¼Œä½†æ˜¯ä»æœåŠ¡å™¨åªéœ€è¦æ–­çº¿æ—¶é—´å†…çš„è¿™éƒ¨åˆ†æ•°æ®ï¼Œæ‰€ä»¥æ—§ç‰ˆå¤åˆ¶çš„å®ç°æ–¹å¼éå¸¸æµªè´¹èµ„æº æ–°ç‰ˆå¤åˆ¶Redis ä» 2.8 ç‰ˆæœ¬å¼€å§‹ï¼Œä½¿ç”¨ PSYNC å‘½ä»¤ä»£æ›¿ SYNC å‘½ä»¤æ¥æ‰§è¡Œå¤åˆ¶æ—¶çš„åŒæ­¥æ“ä½œï¼ˆå‘½ä»¤ä¼ æ’­é˜¶æ®µç›¸åŒï¼‰ï¼Œè§£å†³äº†æ—§ç‰ˆå¤åˆ¶åœ¨å¤„ç†æ–­çº¿é‡å¤åˆ¶æƒ…å†µçš„ä½æ•ˆé—®é¢˜ PSYNC å‘½ä»¤å…·æœ‰å®Œæ•´é‡åŒæ­¥ï¼ˆfull resynchronizationï¼‰å’Œéƒ¨åˆ†é‡åŒæ­¥ï¼ˆpartial resynchronizationï¼‰ä¸¤ç§æ¨¡å¼ï¼š å®Œæ•´é‡åŒæ­¥ï¼šå¤„ç†åˆæ¬¡å¤åˆ¶æƒ…å†µï¼Œæ‰§è¡Œæ­¥éª¤å’Œ SYNCå‘½ä»¤åŸºæœ¬ä¸€æ · éƒ¨åˆ†é‡åŒæ­¥ï¼šå¤„ç†æ–­çº¿åé‡å¤åˆ¶æƒ…å†µï¼Œä¸»æœåŠ¡å™¨å¯ä»¥å°†ä¸»ä»è¿æ¥æ–­å¼€æœŸé—´æ‰§è¡Œçš„å†™å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œä»æœåŠ¡å™¨åªè¦æ¥æ”¶å¹¶æ‰§è¡Œè¿™äº›å†™å‘½ä»¤ï¼Œå°±å¯ä»¥å°†æ•°æ®åº“æ›´æ–°è‡³ä¸»æœåŠ¡å™¨å½“å‰æ‰€å¤„çš„çŠ¶æ€ï¼Œè¯¥è¿‡ç¨‹åˆå«éƒ¨åˆ†å¤åˆ¶ éƒ¨åˆ†åŒæ­¥éƒ¨åˆ†é‡åŒæ­¥åŠŸèƒ½ç”±ä»¥ä¸‹ä¸‰ä¸ªéƒ¨åˆ†æ„æˆï¼š ä¸»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡ï¼ˆreplication offsetï¼‰å’Œä»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡ ä¸»æœåŠ¡å™¨çš„å¤åˆ¶ç§¯å‹ç¼“å†²åŒºï¼ˆreplication backlogï¼‰ æœåŠ¡å™¨çš„è¿è¡Œ ID (run ID) åç§»é‡ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨ä¼šåˆ†åˆ«ç»´æŠ¤ä¸€ä¸ªå¤åˆ¶åç§»é‡ï¼š ä¸»æœåŠ¡å™¨æ¯æ¬¡å‘ä»æœåŠ¡å™¨ä¼ æ’­ N ä¸ªå­—èŠ‚çš„æ•°æ®æ—¶ï¼Œå°±å°†è‡ªå·±çš„å¤åˆ¶åç§»é‡çš„å€¼åŠ ä¸Š N ä»æœåŠ¡å™¨æ¯æ¬¡æ”¶åˆ°ä¸»æœåŠ¡å™¨ä¼ æ’­æ¥çš„ N ä¸ªå­—èŠ‚çš„æ•°æ®æ—¶ï¼Œå°±å°†è‡ªå·±çš„å¤åˆ¶åç§»é‡çš„å€¼åŠ ä¸Š N é€šè¿‡å¯¹æ¯”ä¸»ä»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡ï¼Œå¯ä»¥åˆ¤æ–­ä¸»ä»æœåŠ¡å™¨æ˜¯å¦å¤„äºä¸€è‡´çŠ¶æ€ ä¸»ä»æœåŠ¡å™¨çš„åç§»é‡æ˜¯ç›¸åŒçš„ï¼Œè¯´æ˜ä¸»ä»æœåŠ¡å™¨å¤„äºä¸€è‡´çŠ¶æ€ ä¸»ä»æœåŠ¡å™¨çš„åç§»é‡æ˜¯ä¸åŒçš„ï¼Œè¯´æ˜ä¸»ä»æœåŠ¡å™¨å¤„äºä¸ä¸€è‡´çŠ¶æ€ ç¼“å†²åŒºå¤åˆ¶ç§¯å‹ç¼“å†²åŒºæ˜¯ç”±ä¸»æœåŠ¡å™¨ç»´æŠ¤çš„ä¸€ä¸ªå›ºå®šé•¿åº¦ï¼ˆfixed-sizeï¼‰å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰é˜Ÿåˆ—ï¼Œé»˜è®¤å¤§å°ä¸º 1MB å‡ºé˜Ÿè§„åˆ™è·Ÿæ™®é€šçš„å…ˆè¿›å…ˆå‡ºé˜Ÿåˆ—ä¸€æ · å…¥é˜Ÿè§„åˆ™æ˜¯å½“å…¥é˜Ÿå…ƒç´ çš„æ•°é‡å¤§äºé˜Ÿåˆ—é•¿åº¦æ—¶ï¼Œæœ€å…ˆå…¥é˜Ÿçš„å…ƒç´ ä¼šè¢«å¼¹å‡ºï¼Œç„¶åæ–°å…ƒç´ æ‰ä¼šè¢«æ”¾å…¥é˜Ÿåˆ— å½“ä¸»æœåŠ¡å™¨è¿›è¡Œå‘½ä»¤ä¼ æ’­æ—¶ï¼Œä¸ä»…ä¼šå°†å†™å‘½ä»¤å‘é€ç»™æ‰€æœ‰ä»æœåŠ¡å™¨ï¼Œè¿˜ä¼šå°†å†™å‘½ä»¤å…¥é˜Ÿåˆ°å¤åˆ¶ç§¯å‹ç¼“å†²åŒºï¼Œç¼“å†²åŒºä¼šä¿å­˜ç€ä¸€éƒ¨åˆ†æœ€è¿‘ä¼ æ’­çš„å†™å‘½ä»¤ï¼Œå¹¶ä¸”ç¼“å†²åŒºä¼šä¸ºé˜Ÿåˆ—ä¸­çš„æ¯ä¸ªå­—èŠ‚è®°å½•ç›¸åº”çš„å¤åˆ¶åç§»é‡ ä»æœåŠ¡å™¨ä¼šé€šè¿‡ PSYNC å‘½ä»¤å°†è‡ªå·±çš„å¤åˆ¶åç§»é‡ offset å‘é€ç»™ä¸»æœåŠ¡å™¨ï¼Œä¸»æœåŠ¡å™¨ä¼šæ ¹æ®è¿™ä¸ªå¤åˆ¶åç§»é‡æ¥å†³å®šå¯¹ä»æœåŠ¡å™¨æ‰§è¡Œä½•ç§åŒæ­¥æ“ä½œï¼š offset ä¹‹åçš„æ•°æ®ï¼ˆå³ offset+1ï¼‰ä»ç„¶å­˜åœ¨äºå¤åˆ¶ç§¯å‹ç¼“å†²åŒºé‡Œï¼Œé‚£ä¹ˆä¸»æœåŠ¡å™¨å°†å¯¹ä»æœåŠ¡å™¨æ‰§è¡Œéƒ¨åˆ†é‡åŒæ­¥æ“ä½œ offset ä¹‹åçš„æ•°æ®å·²ç»ä¸åœ¨å¤åˆ¶ç§¯å‹ç¼“å†²åŒºï¼Œè¯´æ˜éƒ¨åˆ†æ•°æ®å·²ç»ä¸¢å¤±ï¼Œé‚£ä¹ˆä¸»æœåŠ¡å™¨å°†å¯¹ä»æœåŠ¡å™¨æ‰§è¡Œå®Œæ•´é‡åŒæ­¥æ“ä½œ å¤åˆ¶ç¼“å†²åŒºå¤§å°è®¾å®šä¸åˆç†ï¼Œä¼šå¯¼è‡´æ•°æ®æº¢å‡ºã€‚æ¯”å¦‚ä¸»æœåŠ¡å™¨éœ€è¦æ‰§è¡Œå¤§é‡å†™å‘½ä»¤ï¼Œåˆæˆ–è€…ä¸»ä»æœåŠ¡å™¨æ–­çº¿åé‡è¿æ¥æ‰€éœ€çš„æ—¶é—´è¾ƒé•¿ï¼Œå¯¼è‡´ç¼“å†²åŒºä¸­çš„æ•°æ®å·²ç»ä¸¢å¤±ï¼Œåˆ™å¿…é¡»è¿›è¡Œå®Œæ•´é‡åŒæ­¥ 1repl-backlog-size ?mb å»ºè®®è®¾ç½®å¦‚ä¸‹ï¼Œè¿™æ ·å¯ä»¥ä¿è¯ç»å¤§éƒ¨åˆ†æ–­çº¿æƒ…å†µéƒ½èƒ½ç”¨éƒ¨åˆ†é‡åŒæ­¥æ¥å¤„ç†ï¼š ä»æœåŠ¡å™¨æ–­çº¿åé‡æ–°è¿æ¥ä¸Šä¸»æœåŠ¡å™¨æ‰€éœ€çš„å¹³å‡æ—¶é—´ second è·å– master å¹³å‡æ¯ç§’äº§ç”Ÿå†™å‘½ä»¤æ•°æ®æ€»é‡ write_size_per_second æœ€ä¼˜å¤åˆ¶ç¼“å†²åŒºç©ºé—´ &#x3D; 2 * second * write_size_per_second è¿è¡ŒIDæœåŠ¡å™¨è¿è¡Œ IDï¼ˆrun IDï¼‰ï¼šæ˜¯æ¯ä¸€å°æœåŠ¡å™¨æ¯æ¬¡è¿è¡Œçš„èº«ä»½è¯†åˆ«ç ï¼Œåœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶è‡ªåŠ¨ç”Ÿæˆï¼Œç”± 40 ä½éšæœºçš„åå…­è¿›åˆ¶å­—ç¬¦ç»„æˆï¼Œä¸€å°æœåŠ¡å™¨å¤šæ¬¡è¿è¡Œå¯ä»¥ç”Ÿæˆå¤šä¸ªè¿è¡Œ ID ä½œç”¨ï¼šæœåŠ¡å™¨é—´è¿›è¡Œä¼ è¾“è¯†åˆ«èº«ä»½ï¼Œå¦‚æœæƒ³ä¸¤æ¬¡æ“ä½œå‡å¯¹åŒä¸€å°æœåŠ¡å™¨è¿›è¡Œï¼Œæ¯æ¬¡å¿…é¡»æ“ä½œæºå¸¦å¯¹åº”çš„è¿è¡Œ IDï¼Œç”¨äºå¯¹æ–¹è¯†åˆ« ä»æœåŠ¡å™¨å¯¹ä¸»æœåŠ¡å™¨è¿›è¡Œåˆæ¬¡å¤åˆ¶æ—¶ï¼Œä¸»æœåŠ¡å™¨å°†è‡ªå·±çš„è¿è¡Œ ID ä¼ é€ç»™ä»æœåŠ¡å™¨ï¼Œç„¶åä»æœåŠ¡å™¨ä¼šå°†è¯¥è¿è¡Œ ID ä¿å­˜ã€‚å½“ä»æœåŠ¡å™¨æ–­çº¿å¹¶é‡æ–°è¿ä¸Šä¸€ä¸ªä¸»æœåŠ¡å™¨æ—¶ï¼Œä¼šå‘å½“å‰è¿æ¥çš„ä¸»æœåŠ¡å™¨å‘é€ä¹‹å‰ä¿å­˜çš„è¿è¡Œ IDï¼š å¦‚æœè¿è¡Œ ID å’Œå½“å‰è¿æ¥çš„ä¸»æœåŠ¡å™¨çš„è¿è¡Œ ID ç›¸åŒï¼Œè¯´æ˜ä»æœåŠ¡å™¨æ–­çº¿ä¹‹å‰å¤åˆ¶çš„å°±æ˜¯å½“å‰è¿æ¥çš„è¿™ä¸ªä¸»æœåŠ¡å™¨ï¼Œæ‰§è¡Œéƒ¨åˆ†é‡åŒæ­¥ å¦‚æœä¸åŒï¼Œéœ€è¦æ‰§è¡Œå®Œæ•´é‡åŒæ­¥æ“ä½œ PSYNCPSYNC å‘½ä»¤çš„è°ƒç”¨æ–¹æ³•æœ‰ä¸¤ç§ å¦‚æœä»æœåŠ¡å™¨ä¹‹å‰æ²¡æœ‰å¤åˆ¶è¿‡ä»»ä½•ä¸»æœåŠ¡å™¨ï¼Œæˆ–è€…æ‰§è¡Œäº† SLAVEOF no oneï¼Œå¼€å§‹ä¸€æ¬¡æ–°çš„å¤åˆ¶æ—¶å°†å‘ä¸»æœåŠ¡å™¨å‘é€ PSYNC ? -1 å‘½ä»¤ï¼Œä¸»åŠ¨è¯·æ±‚ä¸»æœåŠ¡å™¨è¿›è¡Œå®Œæ•´é‡åŒæ­¥ å¦‚æœä»æœåŠ¡å™¨å·²ç»å¤åˆ¶è¿‡æŸä¸ªä¸»æœåŠ¡å™¨ï¼Œé‚£ä¹ˆä»æœåŠ¡å™¨åœ¨å¼€å§‹ä¸€æ¬¡æ–°çš„å¤åˆ¶æ—¶å°†å‘ä¸»æœåŠ¡å™¨å‘é€ PSYNC &lt;runid&gt; &lt;offset&gt; å‘½ä»¤ï¼Œrunid æ˜¯ä¸Šä¸€æ¬¡å¤åˆ¶çš„ä¸»æœåŠ¡å™¨çš„è¿è¡Œ IDï¼Œoffset æ˜¯å¤åˆ¶çš„åç§»é‡ æ¥æ”¶åˆ° PSYNC å‘½ä»¤çš„ä¸»æœåŠ¡å™¨ä¼šå‘ä»æœåŠ¡å™¨è¿”å›ä»¥ä¸‹ä¸‰ç§å›å¤çš„å…¶ä¸­ä¸€ç§ï¼š æ‰§è¡Œå®Œæ•´é‡åŒæ­¥æ“ä½œï¼šè¿”å› +FULLRESYNC &lt;runid&gt; &lt;offset&gt;ï¼Œrunid æ˜¯ä¸»æœåŠ¡å™¨çš„è¿è¡Œ IDï¼Œoffset æ˜¯ä¸»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡ æ‰§è¡Œéƒ¨åˆ†é‡åŒæ­¥æ“ä½œï¼šè¿”å› +CONTINUEï¼Œä»æœåŠ¡å™¨æ”¶åˆ°è¯¥å›å¤è¯´æ˜åªéœ€è¦ç­‰å¾…ä¸»æœåŠ¡å™¨å‘é€ç¼ºå¤±çš„éƒ¨åˆ†æ•°æ®å³å¯ ä¸»æœåŠ¡å™¨çš„ç‰ˆæœ¬ä½äº Redis2.8ï¼šè¿”å› -ERRï¼Œç‰ˆæœ¬è¿‡ä½è¯†åˆ«ä¸äº† PSYNCï¼Œä»æœåŠ¡å™¨å°†å‘ä¸»æœåŠ¡å™¨å‘é€ SYNC å‘½ä»¤ å¤åˆ¶å®ç°å®ç°æµç¨‹é€šè¿‡å‘ä»æœåŠ¡å™¨å‘é€ SLAVEOF å‘½ä»¤ï¼Œå¯ä»¥è®©ä»æœåŠ¡å™¨å»å¤åˆ¶ä¸€ä¸ªä¸»æœåŠ¡å™¨ è®¾ç½®ä¸»æœåŠ¡å™¨çš„åœ°å€å’Œç«¯å£ï¼šå°† SLAVEOF å‘½ä»¤æŒ‡å®šçš„ ip å’Œ port ä¿å­˜åˆ°æœåŠ¡å™¨çŠ¶æ€ redisServer 123456struct redisServer &#123; // ä¸»æœåŠ¡å™¨çš„åœ°å€ char *masterhost; //ä¸»æœåŠ¡å™¨çš„ç«¯å£ int masterport; &#125;; SLAVEOF å‘½ä»¤æ˜¯ä¸€ä¸ªå¼‚æ­¥å‘½ä»¤ï¼Œåœ¨å®Œæˆå±æ€§çš„è®¾ç½®åæœåŠ¡å™¨ç›´æ¥è¿”å› OKï¼Œè€Œå®é™…çš„å¤åˆ¶å·¥ä½œå°†åœ¨ OK è¿”å›ä¹‹åæ‰çœŸæ­£å¼€å§‹æ‰§è¡Œ å»ºç«‹å¥—æ¥å­—è¿æ¥ï¼š ä»æœåŠ¡å™¨ connect ä¸»æœåŠ¡å™¨å»ºç«‹å¥—æ¥å­—è¿æ¥ï¼ŒæˆåŠŸåä»æœåŠ¡å™¨å°†ä¸ºè¿™ä¸ªå¥—æ¥å­—å…³è”ä¸€ä¸ªç”¨äºå¤åˆ¶å·¥ä½œçš„æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼Œè´Ÿè´£æ‰§è¡Œåç»­çš„å¤åˆ¶å·¥ä½œï¼Œå¦‚æ¥æ”¶ RDB æ–‡ä»¶ã€æ¥æ”¶ä¸»æœåŠ¡å™¨ä¼ æ’­æ¥çš„å†™å‘½ä»¤ç­‰ ä¸»æœåŠ¡å™¨åœ¨æ¥å— accept ä»åŠ¡å™¨çš„å¥—æ¥å­—è¿æ¥åï¼Œå°†ä¸ºè¯¥å¥—æ¥å­—åˆ›å»ºç›¸åº”çš„å®¢æˆ·ç«¯çŠ¶æ€ï¼Œå°†ä»æœåŠ¡å™¨çœ‹ä½œä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œä»æœåŠ¡å™¨å°†åŒæ—¶å…·æœ‰ server å’Œ clientï¼ˆå¯ä»¥å‘å‘½ä»¤ï¼‰ä¸¤ä¸ªèº«ä»½ å‘é€ PING å‘½ä»¤ï¼šä»æœåŠ¡å™¨å‘ä¸»æœåŠ¡å™¨å‘é€ä¸€ä¸ª PING å‘½ä»¤ï¼Œæ£€æŸ¥ä¸»ä»ä¹‹é—´çš„é€šä¿¡æ˜¯å¦æ­£å¸¸ã€ä¸»æœåŠ¡å™¨å¤„ç†å‘½ä»¤çš„èƒ½åŠ›æ˜¯å¦æ­£å¸¸ è¿”å›é”™è¯¯ï¼Œè¡¨ç¤ºä¸»æœåŠ¡å™¨æ— æ³•å¤„ç†ä»æœåŠ¡å™¨çš„å‘½ä»¤è¯·æ±‚ï¼ˆå¿™ç¢Œï¼‰ï¼Œä»æœåŠ¡å™¨æ–­å¼€å¹¶é‡æ–°åˆ›å»ºè¿å‘ä¸»æœåŠ¡å™¨çš„å¥—æ¥å­— è¿”å›å‘½ä»¤å›å¤ï¼Œä½†ä»æœåŠ¡å™¨ä¸èƒ½åœ¨è§„å®šçš„æ—¶é—´å†…è¯»å–å‡ºå‘½ä»¤å›å¤çš„å†…å®¹ï¼Œè¡¨ç¤ºä¸»ä»ä¹‹é—´çš„ç½‘ç»œçŠ¶æ€ä¸ä½³ï¼Œéœ€è¦æ–­å¼€é‡è¿ è¯»å–åˆ° PONGï¼Œè¡¨ç¤ºä¸€åˆ‡çŠ¶æ€æ­£å¸¸ï¼Œå¯ä»¥æ‰§è¡Œå¤åˆ¶ èº«ä»½éªŒè¯ï¼šå¦‚æœä»æœåŠ¡å™¨è®¾ç½®äº† masterauth é€‰é¡¹å°±è¿›è¡Œèº«ä»½éªŒè¯ï¼Œå°†å‘ä¸»æœåŠ¡å™¨å‘é€ä¸€æ¡ AUTH å‘½ä»¤ï¼Œå‘½ä»¤å‚æ•°ä¸ºä»æœåŠ¡å™¨ masterauth é€‰é¡¹çš„å€¼ï¼Œå¦‚æœä¸»ä»è®¾ç½®çš„å¯†ç ä¸ç›¸åŒï¼Œé‚£ä¹ˆä¸»å°†è¿”å›ä¸€ä¸ª invalid password é”™è¯¯ å‘é€ç«¯å£ä¿¡æ¯ï¼šèº«ä»½éªŒè¯å ä»æœåŠ¡å™¨æ‰§è¡Œå‘½ä»¤ REPLCONF listening-port &lt;portÂ­number&gt;ï¼Œ å‘ä¸»æœåŠ¡å™¨å‘é€ä»æœåŠ¡å™¨çš„ç›‘å¬ç«¯å£å· ä¸»æœåŠ¡å™¨åœ¨æ¥æ”¶åˆ°è¿™ä¸ªå‘½ä»¤åï¼Œä¼šå°†ç«¯å£å·è®°å½•åœ¨å¯¹åº”çš„å®¢æˆ·ç«¯çŠ¶æ€ redisClient.slave_listening_port å±æ€§ä¸­ï¼š åŒæ­¥ï¼šä»æœåŠ¡å™¨å°†å‘ä¸»æœåŠ¡å™¨å‘é€ PSYNC å‘½ä»¤ï¼Œåœ¨åŒæ­¥æ“ä½œæ‰§è¡Œä¹‹åï¼Œä¸»ä»æœåŠ¡å™¨åŒæ–¹éƒ½æ˜¯å¯¹æ–¹çš„å®¢æˆ·ç«¯ï¼Œå¯ä»¥ç›¸äº’å‘é€å‘½ä»¤ å®Œæ•´é‡åŒæ­¥ï¼šä¸»æœåŠ¡å™¨éœ€è¦æˆä¸ºä»æœåŠ¡å™¨çš„å®¢æˆ·ç«¯ï¼Œæ‰èƒ½å°†ä¿å­˜åœ¨ç¼“å†²åŒºé‡Œé¢çš„å†™å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨æ‰§è¡Œ éƒ¨åˆ†é‡åŒæ­¥ï¼šä¸»æœåŠ¡å™¨éœ€è¦æˆä¸ºä»æœåŠ¡å™¨çš„å®¢æˆ·ç«¯ï¼Œæ‰èƒ½å‘ä»æœåŠ¡å™¨å‘é€ä¿å­˜åœ¨å¤åˆ¶ç§¯å‹ç¼“å†²åŒºé‡Œé¢çš„å†™å‘½ä»¤ å‘½ä»¤ä¼ æ’­ï¼šä¸»æœåŠ¡å™¨å°†å†™å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œä¿æŒæ•°æ®åº“çš„çŠ¶æ€ä¸€è‡´ å¤åˆ¶å›¾ç¤º å¿ƒè·³æ£€æµ‹å¿ƒè·³æœºåˆ¶å¿ƒè·³æœºåˆ¶ï¼šè¿›å…¥å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼Œä»æœåŠ¡å™¨é»˜è®¤ä¼šä»¥æ¯ç§’ä¸€æ¬¡çš„é¢‘ç‡ï¼Œå‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤ï¼šREPLCONF ACK &lt;replication_offset&gt;ï¼Œreplication_offset æ˜¯ä»æœåŠ¡å™¨å½“å‰çš„å¤åˆ¶åç§»é‡ å¿ƒè·³çš„ä½œç”¨ï¼š æ£€æµ‹ä¸»ä»æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥çŠ¶æ€ è¾…åŠ©å®ç° min-slaves é€‰é¡¹ æ£€æµ‹å‘½ä»¤ä¸¢å¤± ç½‘ç»œçŠ¶æ€å¦‚æœä¸»æœåŠ¡å™¨è¶…è¿‡ä¸€ç§’é’Ÿæ²¡æœ‰æ”¶åˆ°ä»æœåŠ¡å™¨å‘æ¥çš„ REPLCONF ACK å‘½ä»¤ï¼Œä¸»æœåŠ¡å°±è®¤ä¸ºä¸»ä»æœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥å‡ºç°é—®é¢˜ å‘ä¸»æœåŠ¡å™¨å‘é€ INFO replication å‘½ä»¤ï¼Œlag ä¸€æ è¡¨ç¤ºä»æœåŠ¡å™¨æœ€åä¸€æ¬¡å‘ä¸»æœåŠ¡å™¨å‘é€ ACK å‘½ä»¤è·ç¦»ç°åœ¨å¤šå°‘ç§’ï¼š 123456127.0.0.1:6379&gt; INFO replication # Replication role:master connected_slaves:2 slave0: ip=127.0.0.1,port=11111,state=online,offset=123,lag=0 # åˆšåˆšå‘é€è¿‡ REPLCONF ACK slavel: ip=127.0.0.1,port=22222,state=online,offset=456,lag=3 # 3ç§’ä¹‹å‰å‘é€è¿‡REPLCONF ACK åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œlag çš„å€¼åº”è¯¥åœ¨ 0 æˆ–è€… 1 ç§’ä¹‹é—´è·³åŠ¨ï¼Œå¦‚æœè¶…è¿‡ 1 ç§’è¯´æ˜ä¸»ä»æœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥å‡ºç°äº†æ•…éšœ é…ç½®é€‰é¡¹Redis çš„ min-slaves-to-write å’Œ min-slaves-max-lag ä¸¤ä¸ªé€‰é¡¹å¯ä»¥é˜²æ­¢ä¸»æœåŠ¡å™¨åœ¨ä¸å®‰å…¨çš„æƒ…å†µä¸‹æ‹’ç»æ‰§è¡Œå†™å‘½ä»¤ æ¯”å¦‚å‘ä¸»æœåŠ¡å™¨è®¾ç½®ï¼š min-slaves-to-writeï¼šä¸»åº“æœ€å°‘æœ‰ N ä¸ªå¥åº·çš„ä»åº“å­˜æ´»æ‰èƒ½æ‰§è¡Œå†™å‘½ä»¤ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„ä»åº“ç›´æ¥æ‹’ç»å†™å…¥ min-slaves-max-lagï¼šä»åº“å’Œä¸»åº“è¿›è¡Œæ•°æ®å¤åˆ¶æ—¶çš„ ACK æ¶ˆæ¯å»¶è¿Ÿçš„æœ€å¤§æ—¶é—´ 12min-slaves-to-write 5min-slaves-max-lag 10 é‚£ä¹ˆåœ¨ä»æœåŠ¡å™¨çš„æ•°å°‘äº 5 ä¸ªï¼Œæˆ–è€… 5 ä¸ªä»æœåŠ¡å™¨çš„å»¶è¿Ÿï¼ˆlagï¼‰å€¼éƒ½å¤§äºæˆ–ç­‰äº10 ç§’æ—¶ï¼Œä¸»æœåŠ¡å™¨å°†æ‹’ç»æ‰§è¡Œå†™å‘½ä»¤ å‘½ä»¤ä¸¢å¤±æ£€æµ‹å‘½ä»¤ä¸¢å¤±ï¼šç”±äºç½‘ç»œæˆ–è€…å…¶ä»–åŸå› ï¼Œä¸»æœåŠ¡å™¨ä¼ æ’­ç»™ä»æœåŠ¡å™¨çš„å†™å‘½ä»¤ä¸¢å¤±ï¼Œé‚£ä¹ˆå½“ä»æœåŠ¡å™¨å‘ä¸»æœåŠ¡å™¨å‘é€ REPLCONF ACK å‘½ä»¤æ—¶ï¼Œä¸»æœåŠ¡å™¨ä¼šæ£€æŸ¥ä»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡æ˜¯å¦å°äºè‡ªå·±çš„ï¼Œç„¶ååœ¨å¤åˆ¶ç§¯å‹ç¼“å†²åŒºé‡Œæ‰¾åˆ°ä»æœåŠ¡å™¨ç¼ºå°‘çš„æ•°æ®ï¼Œå¹¶å°†è¿™äº›æ•°æ®é‡æ–°å‘é€ç»™ä»æœåŠ¡å™¨ è¯´æ˜ï¼šREPLCONF ACK å‘½ä»¤å’Œå¤åˆ¶ç§¯å‹ç¼“å†²åŒºéƒ½æ˜¯ Redis 2.8 ç‰ˆæœ¬æ–°å¢çš„ï¼Œåœ¨ Redis 2.8 ç‰ˆæœ¬ä»¥å‰ï¼Œå³ä½¿å‘½ä»¤åœ¨ä¼ æ’­è¿‡ç¨‹ä¸­ä¸¢å¤±ï¼Œä¸»ä»æœåŠ¡å™¨éƒ½ä¸ä¼šæ³¨æ„åˆ°ï¼Œä¹Ÿä¸ä¼šå‘ä»æœåŠ¡å™¨è¡¥å‘ä¸¢å¤±çš„æ•°æ®ï¼Œæ‰€ä»¥ä¸ºäº†ä¿è¯ä¸»ä»å¤åˆ¶çš„æ•°æ®ä¸€è‡´æ€§ï¼Œæœ€å¥½ä½¿ç”¨ 2.8 æˆ–ä»¥ä¸Šç‰ˆæœ¬çš„ Redis å¸¸è§é—®é¢˜é‡å¯æ¢å¤ç³»ç»Ÿä¸æ–­è¿è¡Œï¼Œmaster çš„æ•°æ®é‡ä¼šè¶Šæ¥è¶Šå¤§ï¼Œä¸€æ—¦ master é‡å¯ï¼Œrunid å°†å‘ç”Ÿå˜åŒ–ï¼Œä¼šå¯¼è‡´å…¨éƒ¨ slave çš„å…¨é‡å¤åˆ¶æ“ä½œ è§£å†³æ–¹æ³•ï¼šæœ¬æœºä¿å­˜ä¸Šæ¬¡ runidï¼Œé‡å¯åæ¢å¤è¯¥å€¼ï¼Œä½¿æ‰€æœ‰ slave è®¤ä¸ºè¿˜æ˜¯ä¹‹å‰çš„ master ä¼˜åŒ–æ–¹æ¡ˆï¼š master å†…éƒ¨åˆ›å»º master_replid å˜é‡ï¼Œä½¿ç”¨ runid ç›¸åŒçš„ç­–ç•¥ç”Ÿæˆï¼Œå¹¶å‘é€ç»™æ‰€æœ‰ slave åœ¨ master å…³é—­æ—¶æ‰§è¡Œå‘½ä»¤ shutdown saveï¼Œè¿›è¡Œ RDB æŒä¹…åŒ–ï¼Œå°† runid ä¸ offset ä¿å­˜åˆ° RDB æ–‡ä»¶ä¸­ redis-check-rdb dump.rdb å‘½ä»¤å¯ä»¥æŸ¥çœ‹è¯¥ä¿¡æ¯ï¼Œä¿å­˜ä¸º repl-id å’Œ repl-offset master é‡å¯ååŠ è½½ RDB æ–‡ä»¶ï¼Œæ¢å¤æ•°æ®ï¼Œå°† RDB æ–‡ä»¶ä¸­ä¿å­˜çš„ repl-id ä¸ repl-offset åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œmaster_repl_id &#x3D; repl-idï¼Œmaster_repl_offset &#x3D; repl-offset é€šè¿‡ info å‘½ä»¤å¯ä»¥æŸ¥çœ‹è¯¥ä¿¡æ¯ ç½‘ç»œä¸­æ–­master çš„ CPU å ç”¨è¿‡é«˜æˆ– slave é¢‘ç¹æ–­å¼€è¿æ¥ å‡ºç°çš„åŸå› ï¼š slave æ¯ 1 ç§’å‘é€ REPLCONF ACK å‘½ä»¤åˆ° master å½“ slave æ¥åˆ°äº†æ…¢æŸ¥è¯¢æ—¶ï¼ˆkeys * ï¼Œhgetall ç­‰ï¼‰ï¼Œä¼šå¤§é‡å ç”¨ CPU æ€§èƒ½ master æ¯ 1 ç§’è°ƒç”¨å¤åˆ¶å®šæ—¶å‡½æ•° replicationCron()ï¼Œæ¯”å¯¹ slave å‘ç°é•¿æ—¶é—´æ²¡æœ‰è¿›è¡Œå“åº” æœ€ç»ˆå¯¼è‡´ master å„ç§èµ„æºï¼ˆè¾“å‡ºç¼“å†²åŒºã€å¸¦å®½ã€è¿æ¥ç­‰ï¼‰è¢«ä¸¥é‡å ç”¨ è§£å†³æ–¹æ³•ï¼šé€šè¿‡è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼Œç¡®è®¤æ˜¯å¦é‡Šæ”¾ slave 1repl-timeout # è¯¥å‚æ•°å®šä¹‰äº†è¶…æ—¶æ—¶é—´çš„é˜ˆå€¼ï¼ˆé»˜è®¤60ç§’ï¼‰ï¼Œè¶…è¿‡è¯¥å€¼ï¼Œé‡Šæ”¾slave slave ä¸ master è¿æ¥æ–­å¼€ å‡ºç°çš„åŸå› ï¼š master å‘é€ ping æŒ‡ä»¤é¢‘åº¦è¾ƒä½ master è®¾å®šè¶…æ—¶æ—¶é—´è¾ƒçŸ­ ping æŒ‡ä»¤åœ¨ç½‘ç»œä¸­å­˜åœ¨ä¸¢åŒ… è§£å†³æ–¹æ³•ï¼šæé«˜ ping æŒ‡ä»¤å‘é€çš„é¢‘åº¦ 1repl-ping-slave-period è¶…æ—¶æ—¶é—´ repl-time çš„æ—¶é—´è‡³å°‘æ˜¯ ping æŒ‡ä»¤é¢‘åº¦çš„5åˆ°10å€ï¼Œå¦åˆ™ slave å¾ˆå®¹æ˜“åˆ¤å®šè¶…æ—¶ ä¸€è‡´æ€§ç½‘ç»œä¿¡æ¯ä¸åŒæ­¥ï¼Œæ•°æ®å‘é€æœ‰å»¶è¿Ÿï¼Œå¯¼è‡´å¤šä¸ª slave è·å–ç›¸åŒæ•°æ®ä¸åŒæ­¥ è§£å†³æ–¹æ¡ˆï¼š ä¼˜åŒ–ä¸»ä»é—´çš„ç½‘ç»œç¯å¢ƒï¼Œé€šå¸¸æ”¾ç½®åœ¨åŒä¸€ä¸ªæœºæˆ¿éƒ¨ç½²ï¼Œå¦‚ä½¿ç”¨é˜¿é‡Œäº‘ç­‰äº‘æœåŠ¡å™¨æ—¶è¦æ³¨æ„æ­¤ç°è±¡ ç›‘æ§ä¸»ä»èŠ‚ç‚¹å»¶è¿Ÿï¼ˆé€šè¿‡offsetï¼‰åˆ¤æ–­ï¼Œå¦‚æœ slave å»¶è¿Ÿè¿‡å¤§ï¼Œæš‚æ—¶å±è”½ç¨‹åºå¯¹è¯¥ slave çš„æ•°æ®è®¿é—® 1slave-serve-stale-data yes|no å¼€å¯åä»…å“åº” infoã€slaveof ç­‰å°‘æ•°å‘½ä»¤ï¼ˆæ…ç”¨ï¼Œé™¤éå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚å¾ˆé«˜ï¼‰ å¤šä¸ª slave åŒæ—¶å¯¹ master è¯·æ±‚æ•°æ®åŒæ­¥ï¼Œmaster å‘é€çš„ RDB æ–‡ä»¶å¢å¤šï¼Œä¼šå¯¹å¸¦å®½é€ æˆå·¨å¤§å†²å‡»ï¼Œé€ æˆ master å¸¦å®½ä¸è¶³ï¼Œå› æ­¤æ•°æ®åŒæ­¥éœ€è¦æ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œé€‚é‡é”™å³° å“¨å…µæ¨¡å¼å“¨å…µæ¦‚è¿°Sentinelï¼ˆå“¨å…µï¼‰æ˜¯ Redis çš„é«˜å¯ç”¨æ€§ï¼ˆhigh availabilityï¼‰è§£å†³æ–¹æ¡ˆï¼Œç”±ä¸€ä¸ªæˆ–å¤šä¸ª Sentinel å®ä¾‹ instance ç»„æˆçš„ Sentinel ç³»ç»Ÿå¯ä»¥ç›‘è§†ä»»æ„å¤šä¸ªä¸»æœåŠ¡å™¨ï¼Œä»¥åŠè¿™äº›ä¸»æœåŠ¡å™¨çš„æ‰€æœ‰ä»æœåŠ¡å™¨ï¼Œå¹¶åœ¨è¢«ç›‘è§†çš„ä¸»æœåŠ¡å™¨ä¸‹çº¿æ—¶è¿›è¡Œæ•…éšœè½¬ç§» åŒç¯å›¾æ¡ˆè¡¨ç¤ºä¸»æœåŠ¡å™¨ å•ç¯å›¾æ¡ˆè¡¨ç¤ºä¸‰ä¸ªä»æœåŠ¡å™¨ å“¨å…µçš„ä½œç”¨ï¼š ç›‘æ§ï¼šç›‘æ§ master å’Œ slaveï¼Œä¸æ–­çš„æ£€æŸ¥ master å’Œ slave æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œmaster å­˜æ´»æ£€æµ‹ã€master ä¸ slave è¿è¡Œæƒ…å†µæ£€æµ‹ é€šçŸ¥ï¼šå½“è¢«ç›‘æ§çš„æœåŠ¡å™¨å‡ºç°é—®é¢˜æ—¶ï¼Œå‘å…¶ä»–å“¨å…µå‘é€é€šçŸ¥ è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼šæ–­å¼€ master ä¸ slave è¿æ¥ï¼Œé€‰å–ä¸€ä¸ª slave ä½œä¸º masterï¼Œå°†å…¶ä»– slave è¿æ¥æ–°çš„ masterï¼Œå¹¶å‘ŠçŸ¥å®¢æˆ·ç«¯æ–°çš„æœåŠ¡å™¨åœ°å€ å¯ç”¨å“¨å…µé…ç½®æ–¹å¼é…ç½®ä¸‰ä¸ªå“¨å…µ sentinel.confï¼šä¸€èˆ¬å¤šä¸ªå“¨å…µé…ç½®ç›¸åŒã€ç«¯å£ä¸åŒï¼Œç‰¹æ®Šéœ€æ±‚å¯ä»¥é…ç½®ä¸åŒçš„å±æ€§ 1234567port 26401dir &quot;/redis/data&quot;sentinel monitor mymaster 127.0.0.1 6401 2sentinel down-after-milliseconds mymaster 5000sentinel failover-timeout mymaster 20000sentinel parallel-sync mymaster 1sentinel deny-scripts-reconfig yes é…ç½®è¯´æ˜ï¼š è®¾ç½®å“¨å…µç›‘å¬çš„ä¸»æœåŠ¡å™¨ä¿¡æ¯ï¼Œåˆ¤æ–­ä¸»è§‚ä¸‹çº¿æ‰€éœ€è¦çš„ç¥¨æ•° 1sentinel monitor &lt;master-name&gt; &lt;master_ip&gt; &lt;master_port&gt; &lt;quorum&gt; æŒ‡å®šå“¨å…µåœ¨ç›‘æ§ Redis æœåŠ¡æ—¶ï¼Œè®¾ç½®åˆ¤å®šæœåŠ¡å™¨å®•æœºçš„æ—¶é•¿ï¼Œè¯¥è®¾ç½®æ§åˆ¶æ˜¯å¦è¿›è¡Œä¸»ä»åˆ‡æ¢ 1sentinel down-after-milliseconds &lt;master-name&gt; &lt;million_seconds&gt; å‡ºç°æ•…éšœåï¼Œæ•…éšœåˆ‡æ¢çš„æœ€å¤§è¶…æ—¶æ—¶é—´ï¼Œè¶…è¿‡è¯¥å€¼ï¼Œè®¤å®šåˆ‡æ¢å¤±è´¥ï¼Œé»˜è®¤ 3 åˆ†é’Ÿ 1sentinel failover-timeout &lt;master_name&gt; &lt;million_seconds&gt; æ•…éšœè½¬ç§»æ—¶ï¼ŒåŒæ—¶è¿›è¡Œä¸»ä»åŒæ­¥çš„ slave æ•°é‡ï¼Œæ•°å€¼è¶Šå¤§ï¼Œè¦æ±‚ç½‘ç»œèµ„æºè¶Šé«˜ 1sentinel parallel-syncs &lt;master_name&gt; &lt;sync_slave_number&gt; å¯åŠ¨å“¨å…µï¼šæœåŠ¡ç«¯å‘½ä»¤ï¼ˆLinux å‘½ä»¤ï¼‰ 1redis-sentinel filename åˆå§‹åŒ–Sentinel æœ¬è´¨ä¸Šåªæ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ç‰¹æ®Šæ¨¡å¼ä¸‹çš„ Redis æœåŠ¡å™¨ï¼Œå½“ä¸€ä¸ª Sentinel å¯åŠ¨æ—¶ï¼Œé¦–å…ˆåˆå§‹åŒ– Redis æœåŠ¡å™¨ï¼Œä½†æ˜¯åˆå§‹åŒ–è¿‡ç¨‹å’Œæ™®é€š Redis æœåŠ¡å™¨çš„åˆå§‹åŒ–è¿‡ç¨‹å¹¶ä¸å®Œå…¨ç›¸åŒï¼Œå“¨å…µä¸æä¾›æ•°æ®ç›¸å…³æœåŠ¡ï¼Œæ‰€ä»¥ä¸ä¼šè½½å…¥ RDBã€AOF æ–‡ä»¶ æ•´ä½“æµç¨‹ï¼š åˆå§‹åŒ–æœåŠ¡å™¨ å°†æ™®é€š Redis æœåŠ¡å™¨ä½¿ç”¨çš„ä»£ç æ›¿æ¢æˆ Sentinel ä¸“ç”¨ä»£ç  åˆå§‹åŒ– Sentinel çŠ¶æ€ æ ¹æ®ç»™å®šçš„é…ç½®æ–‡ä»¶ï¼Œåˆå§‹åŒ– Sentinel çš„ç›‘è§†ä¸»æœåŠ¡å™¨åˆ—è¡¨ åˆ›å»ºè¿å‘ä¸»æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥ ä»£ç æ›¿æ¢å°†ä¸€éƒ¨åˆ†æ™®é€š Redis æœåŠ¡å™¨ä½¿ç”¨çš„ä»£ç æ›¿æ¢æˆ Sentinel ä¸“ç”¨ä»£ç  Redis æœåŠ¡å™¨ç«¯å£ï¼š 12# define REDIS_SERVERPORT 6379 // æ™®é€šæœåŠ¡å™¨ç«¯å£# define REDIS_SENTINEL_PORT 26379 // å“¨å…µç«¯å£ æœåŠ¡å™¨çš„å‘½ä»¤è¡¨ï¼š 12345678910111213// æ™®é€š Redis æœåŠ¡å™¨struct redisCommand redisCommandTable[] = &#123; &#123;&quot;get&quot;, getCommand, 2, &quot;r&quot;, 0, NULL, 1, 1, 1, 0, 0&#125;, &#123;&quot;set&quot;, setCommand, -3, &quot;wm&quot;, 0, noPreloadGetKeys, 1, 1, 1, 0, 0&#125;, //....&#125;// å“¨å…µstruct redisCommand sentinelcmds[] = &#123; &#123;&quot;ping&quot;, pingCommand, 1, &quot;&quot;, 0, NULL, 0, 0, 0, 0, 0&#125;, &#123;&quot;sentinel&quot;, sentinelCommand, -2,&quot;&quot;,0,NULL,0,0,0,0,0&#125;, &#123;&quot;subscribe&quot;,...&#125;, &#123;&quot;unsubscribe&quot;,...O&#125;, &#123;&quot;psubscribe&quot;,...&#125;, &#123;&quot;punsubscribe&quot;,...&#125;, &#123;&quot;info&quot;,...&#125;&#125;; ä¸Šè¿°è¡¨æ˜¯å“¨å…µæ¨¡å¼ä¸‹å®¢æˆ·ç«¯å¯ä»¥æ‰§è¡Œçš„å‘½ä»¤ï¼Œæ‰€ä»¥å¯¹äº GETã€SET ç­‰å‘½ä»¤ï¼ŒæœåŠ¡å™¨æ ¹æœ¬å°±æ²¡æœ‰è½½å…¥ å“¨å…µçŠ¶æ€æœåŠ¡å™¨ä¼šåˆå§‹åŒ–ä¸€ä¸ª sentinelState ç»“æ„ï¼Œåˆå« Sentinel çŠ¶æ€ï¼Œç»“æ„ä¿å­˜äº†æœåŠ¡å™¨ä¸­æ‰€æœ‰å’Œ Sentinel åŠŸèƒ½æœ‰å…³çš„çŠ¶æ€ï¼ˆæœåŠ¡å™¨çš„ä¸€èˆ¬çŠ¶æ€ä»ç„¶ç”± redisServer ç»“æ„ä¿å­˜ï¼‰ 123456789101112131415161718192021struct sentinelState &#123; // å½“å‰çºªå…ƒï¼Œç”¨äºå®ç°æ•…éšœè½¬ç§» uint64_t current_epoch; // ã€ä¿å­˜äº†æ‰€æœ‰è¢«è¿™ä¸ªsentinelç›‘è§†çš„ä¸»æœåŠ¡å™¨ã€‘ dict *masters; // æ˜¯å¦è¿›å…¥äº† TILT æ¨¡å¼ int tilt; // è¿›å…¥ TILT æ¨¡å¼çš„æ—¶é—´ mstime_t tilt_start_time; // æœ€åä¸€æ¬¡æ‰§è¡Œæ—¶é—´å¤„ç†çš„äº‹ä»¶ mstime_t previous_time; // ç›®å‰æ­£åœ¨æ‰§è¡Œçš„è„šæœ¬æ•°é‡ int running_scripts; // ä¸€ä¸ªFIFOé˜Ÿåˆ—ï¼ŒåŒ…å«äº†æ‰€æœ‰éœ€è¦æ‰§è¡Œçš„ç”¨æˆ·è„šæœ¬ list *scripts_queue; &#125; sentinel; ç›‘æ§åˆ—è¡¨Sentinel çŠ¶æ€çš„åˆå§‹åŒ–å°† masters å­—å…¸çš„åˆå§‹åŒ–ï¼Œæ ¹æ®è¢«è½½å…¥çš„ Sentinel é…ç½®æ–‡ä»¶ conf æ¥è¿›è¡Œå±æ€§èµ‹å€¼ Sentinel çŠ¶æ€ä¸­çš„ masters å­—å…¸è®°å½•äº†æ‰€æœ‰è¢« Sentinel ç›‘è§†çš„ä¸»æœåŠ¡å™¨çš„ç›¸å…³ä¿¡æ¯ï¼Œå­—å…¸çš„é”®æ˜¯è¢«ç›‘è§†ä¸»æœåŠ¡å™¨çš„åå­—ï¼Œå€¼æ˜¯ä¸»æœåŠ¡å™¨å¯¹åº”çš„å®ä¾‹ç»“æ„ å®ä¾‹ç»“æ„æ˜¯ä¸€ä¸ª sentinelRedisinstance æ•°æ®ç±»å‹ï¼Œä»£è¡¨è¢« Sentinel ç›‘è§†çš„å®ä¾‹ï¼Œè¿™ä¸ªå®ä¾‹å¯ä»¥æ˜¯ä¸»ã€ä»æœåŠ¡å™¨ï¼Œæˆ–è€…å…¶ä»– Sentinel 1234567891011121314151617181920212223242526272829303132333435typedef struct sentinelRedisinstance &#123; // æ ‡è¯†å€¼ï¼Œè®°å½•äº†å®ä¾‹çš„ç±»å‹ï¼Œä»¥åŠè¯¥å®ä¾‹çš„å½“å‰çŠ¶æ€ int flags; // å®ä¾‹çš„åå­—ï¼Œä¸»æœåŠ¡å™¨çš„åå­—ç”±ç”¨æˆ·åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ï¼Œ // ä»æœåŠ¡å™¨å’Œå“¨å…µçš„åå­—ç”± Sentinel è‡ªåŠ¨è®¾ç½®ï¼Œæ ¼å¼ä¸º ip:portï¼Œä¾‹å¦‚ 127.0.0.1:6379 char *name; // å®ä¾‹è¿è¡Œçš„ ID char *runid; // é…ç½®çºªå…ƒï¼Œç”¨äºå®ç°æ•…éšœè½¬ç§» uint64_t config_epoch; // å®ä¾‹åœ°å€ sentinelAddr *addr; // å¦‚æœå½“å‰å®ä¾‹æ—¶ä¸»æœåŠ¡å™¨ï¼Œè¯¥å­—æ®µä¿å­˜ä»æœåŠ¡å™¨ä¿¡æ¯ï¼Œé”®æ˜¯åå­—æ ¼å¼ä¸º ip:portï¼Œå€¼æ˜¯å®ä¾‹ç»“æ„ dict *slaves; // æ‰€æœ‰ç›‘è§†å½“å‰æœåŠ¡å™¨çš„ Sentinel å®ä¾‹ï¼Œé”®æ˜¯åå­—æ ¼å¼ä¸º ip:portï¼Œå€¼æ˜¯å®ä¾‹ç»“æ„ dict *sentinels; // sentinel down-after-milliseconds çš„å€¼ï¼Œè¡¨ç¤ºå®ä¾‹æ— å“åº”å¤šå°‘æ¯«ç§’åä¼šè¢«åˆ¤æ–­ä¸ºä¸»è§‚ä¸‹çº¿(subjectively down) mstime_t down_after_period; // sentinel monitor é€‰é¡¹ä¸­çš„quorumå‚æ•°ï¼Œåˆ¤æ–­è¿™ä¸ªå®ä¾‹ä¸ºå®¢è§‚ä¸‹çº¿(objectively down)æ‰€éœ€çš„æ”¯æŒæŠ•ç¥¨æ•°é‡ int quorum; // sentinel parallel-syncs çš„å€¼ï¼Œåœ¨æ‰§è¡Œæ•…éšœè½¬ç§»æ“ä½œæ—¶ï¼Œå¯ä»¥åŒæ—¶å¯¹æ–°çš„ä¸»æœåŠ¡å™¨è¿›è¡ŒåŒæ­¥çš„ä»æœåŠ¡å™¨æ•°é‡ int parallel-syncs; // sentinel failover-timeoutçš„å€¼ï¼Œåˆ·æ–°æ•…éšœè¿ç§»çŠ¶æ€çš„æœ€å¤§æ—¶é™ mstime_t failover_timeout;&#125; addr å±æ€§æ˜¯ä¸€ä¸ªæŒ‡å‘ sentinelAddr çš„æŒ‡é’ˆï¼š 1234typedef struct sentinelAddr &#123; char *ip; int port;&#125; ç½‘ç»œè¿æ¥åˆå§‹åŒ– Sentinel çš„æœ€åä¸€æ­¥æ˜¯åˆ›å»ºè¿å‘è¢«ç›‘è§†ä¸»æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥ï¼ŒSentinel å°†æˆä¸ºä¸»æœåŠ¡å™¨çš„å®¢æˆ·ç«¯ï¼Œå¯ä»¥å‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤ï¼Œå¹¶ä»å‘½ä»¤å›å¤ä¸­è·å–ç›¸å…³çš„ä¿¡æ¯ æ¯ä¸ªè¢« Sentinel ç›‘è§†çš„ä¸»æœåŠ¡å™¨ï¼ŒSentinel ä¼šåˆ›å»ºä¸¤ä¸ªè¿å‘ä¸»æœåŠ¡å™¨çš„å¼‚æ­¥ç½‘ç»œè¿æ¥ï¼š å‘½ä»¤è¿æ¥ï¼šç”¨äºå‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤ï¼Œå¹¶æ¥æ”¶å‘½ä»¤å›å¤ è®¢é˜…è¿æ¥ï¼šç”¨äºè®¢é˜…ä¸»æœåŠ¡å™¨çš„ _sentinel_:hello é¢‘é“ å»ºç«‹ä¸¤ä¸ªè¿æ¥çš„åŸå› ï¼š åœ¨ Redis ç›®å‰çš„å‘å¸ƒä¸è®¢é˜…åŠŸèƒ½ä¸­ï¼Œè¢«å‘é€çš„ä¿¡æ¯éƒ½ä¸ä¼šä¿å­˜åœ¨ Redis æœåŠ¡å™¨é‡Œï¼Œ å¦‚æœåœ¨ä¿¡æ¯å‘é€æ—¶æ¥æ”¶ä¿¡æ¯çš„å®¢æˆ·ç«¯ç¦»çº¿æˆ–æ–­çº¿ï¼Œé‚£ä¹ˆè¿™ä¸ªå®¢æˆ·ç«¯å°±ä¼šä¸¢å¤±è¿™æ¡ä¿¡æ¯ï¼Œä¸ºäº†ä¸ä¸¢å¤± hello é¢‘é“çš„ä»»ä½•ä¿¡æ¯ï¼ŒSentinel å¿…é¡»ç”¨ä¸€ä¸ªè®¢é˜…è¿æ¥æ¥æ¥æ”¶è¯¥é¢‘é“çš„ä¿¡æ¯ Sentinel è¿˜å¿…é¡»å‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤ï¼Œä»¥æ­¤æ¥ä¸ä¸»æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ï¼Œæ‰€ä»¥ Sentinel è¿˜å¿…é¡»å‘ä¸»æœåŠ¡å™¨åˆ›å»ºå‘½ä»¤è¿æ¥ è¯´æ˜ï¼šæ–­çº¿çš„æ„æ€å°±æ˜¯ç½‘ç»œè¿æ¥æ–­å¼€ ä¿¡æ¯äº¤äº’è·å–ä¿¡æ¯ä¸»æœåŠ¡å™¨Sentinel é»˜è®¤ä¼šä»¥æ¯åç§’ä¸€æ¬¡çš„é¢‘ç‡ï¼Œé€šè¿‡å‘½ä»¤è¿æ¥å‘è¢«ç›‘è§†çš„ä¸»æœåŠ¡å™¨å‘é€ INFO å‘½ä»¤ï¼Œæ¥è·å–ä¸»æœåŠ¡å™¨çš„ä¿¡æ¯ ä¸€éƒ¨åˆ†æ˜¯ä¸»æœåŠ¡å™¨æœ¬èº«çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ runid åŸŸè®°å½•çš„æœåŠ¡å™¨è¿è¡Œ IDï¼Œä»¥åŠ role åŸŸè®°å½•çš„æœåŠ¡å™¨è§’è‰² å¦ä¸€éƒ¨åˆ†æ˜¯æœåŠ¡å™¨å±ä¸‹æ‰€æœ‰ä»æœåŠ¡å™¨çš„ä¿¡æ¯ï¼Œæ¯ä¸ªä»æœåŠ¡å™¨éƒ½ç”±ä¸€ä¸ª slave å­—ç¬¦ä¸²å¼€å¤´çš„è¡Œè®°å½•ï¼Œæ ¹æ®è¿™äº› IP åœ°å€å’Œç«¯å£å·ï¼ŒSentinel æ— é¡»ç”¨æˆ·æä¾›ä»æœåŠ¡å™¨çš„åœ°å€ä¿¡æ¯ï¼Œå°±å¯ä»¥è‡ªåŠ¨å‘ç°ä»æœåŠ¡å™¨ 123456789# Server run_id:76llc59dc3a29aa6fa0609f84lbb6al019008a9c...# Replication role:master ...slave0: ip=l27.0.0.1, port=11111, state=online, offset=22, lag=0slave1: ip=l27.0.0.1, port=22222, state=online, offset=22, lag=0... æ ¹æ® run_id å’Œ role è®°å½•çš„ä¿¡æ¯ Sentinel å°†å¯¹ä¸»æœåŠ¡å™¨çš„å®ä¾‹ç»“æ„è¿›è¡Œæ›´æ–°ï¼Œæ¯”å¦‚ä¸»æœåŠ¡å™¨é‡å¯ä¹‹åï¼Œè¿è¡Œ ID å°±ä¼šå’Œå®ä¾‹ç»“æ„ä¹‹å‰ä¿å­˜çš„è¿è¡Œ ID ä¸åŒï¼Œå“¨å…µæ£€æµ‹åˆ°è¿™ä¸€æƒ…å†µä¹‹åå°±ä¼šå¯¹å®ä¾‹ç»“æ„çš„è¿è¡Œ ID è¿›è¡Œæ›´æ–° å¯¹äºä¸»æœåŠ¡å™¨è¿”å›çš„ä»æœåŠ¡å™¨ä¿¡æ¯ï¼Œç”¨å®ä¾‹ç»“æ„çš„ slaves å­—å…¸è®°å½•äº†ä»æœåŠ¡å™¨çš„ä¿¡æ¯ï¼š å¦‚æœä»æœåŠ¡å™¨å¯¹åº”çš„å®ä¾‹ç»“æ„å·²ç»å­˜åœ¨ï¼Œé‚£ä¹ˆ Sentinel å¯¹ä»æœåŠ¡å™¨çš„å®ä¾‹ç»“æ„è¿›è¡Œæ›´æ–° å¦‚æœä¸å­˜åœ¨ï¼Œä¸ºè¿™ä¸ªä»æœåŠ¡å™¨æ–°åˆ›å»ºä¸€ä¸ªå®ä¾‹ç»“æ„åŠ å…¥å­—å…¸ï¼Œå­—å…¸é”®ä¸º ip:port ä»æœåŠ¡å™¨å½“ Sentinel å‘ç°ä¸»æœåŠ¡å™¨æœ‰æ–°çš„ä»æœåŠ¡å™¨å‡ºç°æ—¶ï¼Œä¼šä¸ºè¿™ä¸ªæ–°çš„ä»æœåŠ¡å™¨åˆ›å»ºç›¸åº”çš„å®ä¾‹ç»“æ„ï¼Œè¿˜ä¼šåˆ›å»ºåˆ°ä»æœåŠ¡å™¨çš„å‘½ä»¤è¿æ¥å’Œè®¢é˜…è¿æ¥ï¼Œæ‰€ä»¥ Sentinel å¯¹æ‰€æœ‰çš„ä»æœåŠ¡å™¨ä¹‹é—´éƒ½å¯ä»¥è¿›è¡Œå‘½ä»¤æ“ä½œ Sentinel é»˜è®¤ä¼šä»¥æ¯åç§’ä¸€æ¬¡çš„é¢‘ç‡ï¼Œå‘ä»æœåŠ¡å™¨å‘é€ INFO å‘½ä»¤ï¼š 123456789101112# Server run_id:76llc59dc3a29aa6fa0609f84lbb6al019008a9c #ä»æœåŠ¡å™¨çš„è¿è¡Œ id...# Replication role:slave # ä»æœåŠ¡å™¨è§’è‰²...master_host:127.0.0.1 # ä¸»æœåŠ¡å™¨çš„ ipmaster_port:6379 # ä¸»æœåŠ¡å™¨çš„ portmaster_link_status:up # ä¸»ä»æœåŠ¡å™¨çš„è¿æ¥çŠ¶æ€slave_repl_offset:11111 # ä»æœåŠ¡å™¨çš„å¤åˆ¶åç§»èœ‡slave_priority:100 # ä»æœåŠ¡å™¨çš„ä¼˜å…ˆçº§... ä¼˜å…ˆçº§å±æ€§åœ¨æ•…éšœè½¬ç§»æ—¶ä¼šç”¨åˆ° æ ¹æ®è¿™äº›ä¿¡æ¯ï¼ŒSentinel ä¼šå¯¹ä»æœåŠ¡å™¨çš„å®ä¾‹ç»“æ„è¿›è¡Œæ›´æ–° å‘é€ä¿¡æ¯Sentinel åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šä»¥æ¯ä¸¤ç§’ä¸€æ¬¡çš„é¢‘ç‡ï¼Œé€šè¿‡å‘½ä»¤è¿æ¥å‘æ‰€æœ‰è¢«ç›‘è§†çš„ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨å‘é€ä»¥ä¸‹æ ¼å¼çš„å‘½ä»¤ï¼š 1PUBLISH _sentinel_:hello &quot;&lt;s_ip&gt;, &lt;s_port&gt;, &lt;s_runid&gt;, &lt;s_epoch&gt;, &lt;m_name&gt;, &lt;m_ip&gt;, &lt;m_port&gt;, &lt;m_epoch&gt; è¿™æ¡å‘½ä»¤å‘æœåŠ¡å™¨çš„ _sentinel_:hello é¢‘é“å‘é€äº†ä¸€æ¡ä¿¡æ¯ï¼Œä¿¡æ¯çš„å†…å®¹ç”±å¤šä¸ªå‚æ•°ç»„æˆï¼š ä»¥ s_ å¼€å¤´çš„å‚æ•°è®°å½•çš„æ˜¯ Sentinel æœ¬èº«çš„ä¿¡æ¯ ä»¥ m_ å¼€å¤´çš„å‚æ•°è®°å½•çš„åˆ™æ˜¯ä¸»æœåŠ¡å™¨çš„ä¿¡æ¯ è¯´æ˜ï¼šé€šè¿‡å‘½ä»¤è¿æ¥å‘é€çš„é¢‘é“ä¿¡æ¯ æ¥å—ä¿¡æ¯è®¢é˜…é¢‘é“Sentinel ä¸ä¸€ä¸ªä¸»æˆ–ä»æœåŠ¡å™¨å»ºç«‹èµ·è®¢é˜…è¿æ¥ä¹‹åï¼Œå°±ä¼šé€šè¿‡è®¢é˜…è¿æ¥å‘æœåŠ¡å™¨å‘é€è®¢é˜…å‘½ä»¤ï¼Œé¢‘é“çš„è®¢é˜…ä¼šä¸€ç›´æŒç»­åˆ° Sentinel ä¸æœåŠ¡å™¨çš„è¿æ¥æ–­å¼€ä¸ºæ­¢ 1SUBSCRIBE _sentinel_:hello è®¢é˜…æˆåŠŸåï¼ŒSentinel å°±å¯ä»¥é€šè¿‡è®¢é˜…è¿æ¥ä»æœåŠ¡å™¨çš„ _sentinel_:hello é¢‘é“æ¥æ”¶ä¿¡æ¯ï¼Œå¯¹æ¶ˆæ¯åˆ†æï¼š å¦‚æœä¿¡æ¯ä¸­è®°å½•çš„ Sentinel è¿è¡Œ ID ä¸è‡ªå·±çš„ç›¸åŒï¼Œä¸åšè¿›ä¸€æ­¥å¤„ç† å¦‚æœä¸åŒï¼Œå°†æ ¹æ®ä¿¡æ¯ä¸­çš„å„ä¸ªå‚æ•°ï¼Œå¯¹ç›¸åº”ä¸»æœåŠ¡å™¨çš„å®ä¾‹ç»“æ„è¿›è¡Œæ›´æ–° Sentinel ä¸ºä¸»æœåŠ¡å™¨åˆ›å»ºçš„å®ä¾‹ç»“æ„çš„ sentinels å­—å…¸ä¿å­˜æ‰€æœ‰åŒæ ·ç›‘è§†è¿™ä¸ªä¸»æœåŠ¡å™¨çš„ Sentinel ä¿¡æ¯ï¼ˆåŒ…æ‹¬ Sentinel è‡ªå·±ï¼‰ï¼Œå­—å…¸çš„é”®æ˜¯ Sentinel çš„åå­—ï¼Œæ ¼å¼ä¸º ip:portï¼Œå€¼æ˜¯é”®æ‰€å¯¹åº” Sentinel çš„å®ä¾‹ç»“æ„ ç›‘è§†åŒä¸€ä¸ªæœåŠ¡å™¨çš„ Sentinel è®¢é˜…çš„é¢‘é“ç›¸åŒï¼ŒSentinel å‘é€çš„ä¿¡æ¯ä¼šè¢«å…¶ä»– Sentinel æ¥æ”¶åˆ°ï¼ˆå‘é€ä¿¡æ¯çš„ä¸ºæº Sentinelï¼Œæ¥æ”¶ä¿¡æ¯çš„ä¸ºç›®æ ‡ Sentinelï¼‰ï¼Œç›®æ ‡ Sentinel åœ¨è‡ªå·±çš„ sentinelState.masters ä¸­æŸ¥æ‰¾æº Sentinel æœåŠ¡å™¨çš„å®ä¾‹ç»“æ„è¿›è¡Œæ·»åŠ æˆ–æ›´æ–° å› ä¸º Sentinel å¯ä»¥æ¥æ”¶åˆ°çš„é¢‘é“ä¿¡æ¯æ¥æ„ŸçŸ¥å…¶ä»– Sentinel çš„å­˜åœ¨ï¼Œå¹¶é€šè¿‡å‘é€é¢‘é“ä¿¡æ¯æ¥è®©å…¶ä»– Sentinel çŸ¥é“è‡ªå·±çš„å­˜åœ¨ï¼Œæ‰€ä»¥ç”¨æˆ·åœ¨ä½¿ç”¨ Sentinel æ—¶å¹¶ä¸éœ€è¦æä¾›å„ä¸ª Sentinel çš„åœ°å€ä¿¡æ¯ï¼Œç›‘è§†åŒä¸€ä¸ªä¸»æœåŠ¡å™¨çš„å¤šä¸ª Sentinel å¯ä»¥ç›¸äº’å‘ç°å¯¹æ–¹ å“¨å…µå®ä¾‹ä¹‹é—´å¯ä»¥ç›¸äº’å‘ç°ï¼Œè¦å½’åŠŸäº Redis æä¾›å‘å¸ƒè®¢é˜…æœºåˆ¶ å‘½ä»¤è¿æ¥Sentinel é€šè¿‡é¢‘é“ä¿¡æ¯å‘ç°æ–°çš„ Sentinelï¼Œé™¤äº†åˆ›å»ºå®ä¾‹ç»“æ„ï¼Œè¿˜ä¼šåˆ›å»ºä¸€ä¸ªè¿å‘æ–° Sentinel çš„å‘½ä»¤è¿æ¥ï¼Œè€Œæ–° Sentinel ä¹ŸåŒæ ·ä¼šåˆ›å»ºè¿å‘è¿™ä¸ª Sentinel çš„å‘½ä»¤è¿æ¥ï¼Œæœ€ç»ˆç›‘è§†åŒä¸€ä¸»æœåŠ¡å™¨çš„å¤šä¸ª Sentinel å°†å½¢æˆç›¸äº’è¿æ¥çš„ç½‘ç»œ ä½œç”¨ï¼šé€šè¿‡å‘½ä»¤è¿æ¥ç›¸è¿çš„å„ä¸ª Sentinel å¯ä»¥å‘å…¶ä»– Sentinel å‘é€å‘½ä»¤è¯·æ±‚æ¥è¿›è¡Œä¿¡æ¯äº¤æ¢ Sentinel ä¹‹é—´ä¸ä¼šåˆ›å»ºè®¢é˜…è¿æ¥ï¼š Sentinel éœ€è¦é€šè¿‡æ¥æ”¶ä¸»æœåŠ¡å™¨æˆ–è€…ä»æœåŠ¡å™¨å‘æ¥çš„é¢‘é“ä¿¡æ¯æ¥å‘ç°æœªçŸ¥çš„æ–° Sentinelï¼Œæ‰€ä»¥æ‰åˆ›å»ºè®¢é˜…è¿æ¥ ç›¸äº’å·²çŸ¥çš„ Sentinel åªè¦ä½¿ç”¨å‘½ä»¤è¿æ¥æ¥è¿›è¡Œé€šä¿¡å°±è¶³å¤Ÿäº† ä¸‹çº¿æ£€æµ‹ä¸»è§‚ä¸‹çº¿Sentinel åœ¨é»˜è®¤æƒ…å†µä¸‹ä¼šä»¥æ¯ç§’ä¸€æ¬¡çš„é¢‘ç‡å‘æ‰€æœ‰ä¸å®ƒåˆ›å»ºäº†å‘½ä»¤è¿æ¥çš„å®ä¾‹ï¼ˆåŒ…æ‹¬ä¸»ä»æœåŠ¡å™¨ã€å…¶ä»– Sentinelï¼‰å‘é€ PING å‘½ä»¤ï¼Œé€šè¿‡å®ä¾‹è¿”å›çš„ PING å‘½ä»¤å›å¤æ¥åˆ¤æ–­å®ä¾‹æ˜¯å¦åœ¨çº¿ æœ‰æ•ˆå›å¤ï¼šå®ä¾‹è¿”å› +PONGã€-LOADINGã€-MASTERDOWN ä¸‰ç§å›å¤çš„å…¶ä¸­ä¸€ç§ æ— æ•ˆå›å¤ï¼šå®ä¾‹è¿”å›é™¤ä¸Šè¿°ä¸‰ç§ä»¥å¤–çš„ä»»ä½•æ•°æ® Sentinel é…ç½®æ–‡ä»¶ä¸­ down-after-milliseconds é€‰é¡¹æŒ‡å®šäº†åˆ¤æ–­å®ä¾‹è¿›å…¥ä¸»è§‚ä¸‹çº¿æ‰€éœ€çš„æ—¶é•¿ï¼Œå¦‚æœä¸»æœåŠ¡å™¨åœ¨è¯¥æ—¶é—´å†…ä¸€ç›´å‘ Sentinel è¿”å›æ— æ•ˆå›å¤ï¼ŒSentinel å°±ä¼šåœ¨è¯¥æœåŠ¡å™¨å¯¹åº”å®ä¾‹ç»“æ„çš„ flags å±æ€§æ‰“å¼€ SRI_S_DOWN æ ‡è¯†ï¼Œè¡¨ç¤ºè¯¥ä¸»æœåŠ¡å™¨è¿›å…¥ä¸»è§‚ä¸‹çº¿çŠ¶æ€ é…ç½®çš„ down-after-milliseconds å€¼ä¸ä»…é€‚ç”¨äºä¸»æœåŠ¡å™¨ï¼Œè¿˜ä¼šè¢«ç”¨äºå½“å‰ Sentinel åˆ¤æ–­ä¸»æœåŠ¡å™¨å±ä¸‹çš„æ‰€æœ‰ä»æœåŠ¡å™¨ï¼Œä»¥åŠæ‰€æœ‰åŒæ ·ç›‘è§†è¿™ä¸ªä¸»æœåŠ¡å™¨çš„å…¶ä»– Sentinel çš„ä¸»è§‚ä¸‹çº¿çŠ¶æ€ æ³¨æ„ï¼šå¯¹äºç›‘è§†åŒä¸€ä¸ªä¸»æœåŠ¡å™¨çš„å¤šä¸ª Sentinel æ¥è¯´ï¼Œè®¾ç½®çš„ down-after-milliseconds é€‰é¡¹çš„å€¼å¯èƒ½ä¸åŒï¼Œæ‰€ä»¥å½“ä¸€ä¸ª Sentinel å°†ä¸»æœåŠ¡å™¨åˆ¤æ–­ä¸ºä¸»è§‚ä¸‹çº¿æ—¶ï¼Œå…¶ä»– Sentinel å¯èƒ½ä»ç„¶ä¼šè®¤ä¸ºä¸»æœåŠ¡å™¨å¤„äºåœ¨çº¿çŠ¶æ€ å®¢è§‚ä¸‹çº¿å½“ Sentinel å°†ä¸€ä¸ªä¸»æœåŠ¡å™¨åˆ¤æ–­ä¸ºä¸»è§‚ä¸‹çº¿ä¹‹åï¼Œä¼šå‘åŒæ ·ç›‘è§†è¿™ä¸€ä¸»æœåŠ¡å™¨çš„å…¶ä»– Sentinel è¿›è¡Œè¯¢é—® Sentinel ä½¿ç”¨å‘½ä»¤è¯¢é—®å…¶ä»– Sentinel æ˜¯å¦åŒæ„ä¸»æœåŠ¡å™¨å·²ä¸‹çº¿ï¼š 1SENTINEL is-master-down-by-addr &lt;ip&gt; &lt;port&gt; &lt;current_epoch&gt; &lt;runid&gt; ipï¼šè¢« Sentinel åˆ¤æ–­ä¸ºä¸»è§‚ä¸‹çº¿çš„ä¸»æœåŠ¡å™¨çš„ IP åœ°å€ portï¼šè¢« Sentinel åˆ¤æ–­ä¸ºä¸»è§‚ä¸‹çº¿çš„ä¸»æœåŠ¡å™¨çš„ç«¯å£å· current_epochï¼šSentinel å½“å‰çš„é…ç½®çºªå…ƒï¼Œç”¨äºé€‰ä¸¾é¢†å¤´ Sentinel runidï¼šå–å€¼ä¸º * ç¬¦å·ä»£è¡¨å‘½ä»¤ä»…ä»…ç”¨äºæ£€æµ‹ä¸»æœåŠ¡å™¨çš„å®¢è§‚ä¸‹çº¿çŠ¶æ€ï¼›å–å€¼ä¸º Sentinel çš„è¿è¡Œ ID åˆ™ç”¨äºé€‰ä¸¾é¢†å¤´ Sentinel ç›®æ ‡ Sentinel æ¥æ”¶åˆ°æº Sentinel çš„å‘½ä»¤æ—¶ï¼Œä¼šæ ¹æ®å‚æ•°çš„ lP å’Œç«¯å£å·ï¼Œæ£€æŸ¥ä¸»æœåŠ¡å™¨æ˜¯å¦å·²ä¸‹çº¿ï¼Œç„¶åè¿”å›ä¸€æ¡åŒ…å«ä¸‰ä¸ªå‚æ•°çš„ Multi Bulk å›å¤ï¼š down_stateï¼šè¿”å›ç›®æ ‡ Sentinel å¯¹æœåŠ¡å™¨çš„æ£€æŸ¥ç»“æœï¼Œ1 ä»£è¡¨ä¸»æœåŠ¡å™¨å·²ä¸‹çº¿ï¼Œ0 ä»£è¡¨æœªä¸‹çº¿ leader_runidï¼šå–å€¼ä¸º * ç¬¦å·ä»£è¡¨å‘½ä»¤ä»…ç”¨äºæ£€æµ‹æœåŠ¡å™¨çš„ä¸‹çº¿çŠ¶æ€ï¼›è€Œå±€éƒ¨é¢†å¤´ Sentinel çš„è¿è¡Œ ID åˆ™ç”¨äºé€‰ä¸¾é¢†å¤´ Sentinel leader_epochï¼šç›®æ ‡ Sentinel çš„å±€éƒ¨é¢†å¤´ Sentinel çš„é…ç½®çºªå…ƒ æº Sentinel å°†ç»Ÿè®¡å…¶ä»– Sentinel åŒæ„ä¸»æœåŠ¡å™¨å·²ä¸‹çº¿çš„æ•°é‡ï¼Œå½“è¿™ä¸€æ•°é‡è¾¾åˆ°é…ç½®æŒ‡å®šçš„åˆ¤æ–­å®¢è§‚ä¸‹çº¿æ‰€éœ€çš„æ•°é‡ï¼ˆquorumï¼‰æ—¶ï¼ŒSentinel ä¼šå°†ä¸»æœåŠ¡å™¨å¯¹åº”å®ä¾‹ç»“æ„ flags å±æ€§çš„ SRI_O_DOWN æ ‡è¯†æ‰“å¼€ï¼Œä»£è¡¨å®¢è§‚ä¸‹çº¿ï¼Œå¹¶å¯¹ä¸»æœåŠ¡å™¨æ‰§è¡Œæ•…éšœè½¬ç§»æ“ä½œ æ³¨æ„ï¼šä¸åŒ Sentinel åˆ¤æ–­å®¢è§‚ä¸‹çº¿çš„æ¡ä»¶å¯èƒ½ä¸åŒï¼Œå› ä¸ºè½½å…¥çš„é…ç½®æ–‡ä»¶ä¸­çš„å±æ€§ quorum å¯èƒ½ä¸åŒ é¢†å¤´é€‰ä¸¾ä¸»æœåŠ¡å™¨è¢«åˆ¤æ–­ä¸ºå®¢è§‚ä¸‹çº¿æ—¶ï¼Œç›‘è§†è¯¥ä¸»æœåŠ¡å™¨çš„å„ä¸ª Sentinel ä¼šè¿›è¡Œåå•†ï¼Œé€‰ä¸¾å‡ºä¸€ä¸ªé¢†å¤´ Sentinel å¯¹ä¸‹çº¿æœåŠ¡å™¨æ‰§è¡Œæ•…éšœè½¬ç§» Redis é€‰ä¸¾é¢†å¤´ Sentinel çš„è§„åˆ™ï¼š æ‰€æœ‰åœ¨çº¿çš„ Sentinel éƒ½æœ‰è¢«é€‰ä¸ºé¢†å¤´ Sentinel çš„èµ„æ ¼ æ¯ä¸ªå‘ç°ä¸»æœåŠ¡å™¨è¿›å…¥å®¢è§‚ä¸‹çº¿çš„ Sentinel éƒ½ä¼šè¦æ±‚å…¶ä»– Sentinel å°†è‡ªå·±è®¾ç½®ä¸ºå±€éƒ¨é¢†å¤´ Sentinel åœ¨ä¸€ä¸ªé…ç½®çºªå…ƒé‡Œï¼Œæ‰€æœ‰ Sentinel éƒ½åªæœ‰ä¸€æ¬¡å°†æŸä¸ª Sentinel è®¾ç½®ä¸ºå±€éƒ¨é¢†å¤´ Sentinel çš„æœºä¼šï¼Œå¹¶ä¸”å±€éƒ¨é¢†å¤´ä¸€æ—¦è®¾ç½®ï¼Œåœ¨è¿™ä¸ªé…ç½®çºªå…ƒé‡Œå°±ä¸èƒ½å†æ›´æ”¹ Sentinel è®¾ç½®å±€éƒ¨é¢†å¤´ Sentinel çš„è§„åˆ™æ˜¯å…ˆåˆ°å…ˆå¾—ï¼Œæœ€å…ˆå‘ç›®æ ‡ Sentinel å‘é€è®¾ç½®è¦æ±‚çš„æº Sentinel å°†æˆä¸ºç›®æ ‡ Sentinel çš„å±€éƒ¨é¢†å¤´ Sentinelï¼Œä¹‹åæ¥æ”¶åˆ°çš„æ‰€æœ‰è®¾ç½®è¦æ±‚éƒ½ä¼šè¢«ç›®æ ‡ Sentinel æ‹’ç» é¢†å¤´ Sentinel çš„äº§ç”Ÿéœ€è¦åŠæ•°ä»¥ä¸Š Sentinel çš„æ”¯æŒï¼Œå¹¶ä¸”æ¯ä¸ª Sentinel åªæœ‰ä¸€ç¥¨ï¼Œæ‰€ä»¥ä¸€ä¸ªé…ç½®çºªå…ƒåªä¼šå‡ºç°ä¸€ä¸ªé¢†å¤´ Sentinelï¼Œæ¯”å¦‚ 10 ä¸ª Sentinel çš„ç³»ç»Ÿä¸­ï¼Œè‡³å°‘éœ€è¦ 10/2 + 1 = 6 ç¥¨ é€‰ä¸¾è¿‡ç¨‹ï¼š ä¸€ä¸ª Sentinel å‘ç›®æ ‡ Sentinel å‘é€ SENTINEL is-master-down-by-addr å‘½ä»¤ï¼Œå‘½ä»¤ä¸­çš„ runid å‚æ•°ä¸æ˜¯ï¼Šç¬¦å·è€Œæ˜¯æº Sentinel çš„è¿è¡Œ IDï¼Œè¡¨ç¤ºæº Sentinel è¦æ±‚ç›®æ ‡ Sentinel å°†è‡ªå·±è®¾ç½®ä¸ºå®ƒçš„å±€éƒ¨é¢†å¤´ Sentinel ç›®æ ‡ Sentinel æ¥å—å‘½ä»¤å¤„ç†å®Œæˆåï¼Œå°†è¿”å›ä¸€æ¡å‘½ä»¤å›å¤ï¼Œå›å¤ä¸­çš„ leader_runid å’Œ leader_epoch å‚æ•°åˆ†åˆ«è®°å½•äº†ç›®æ ‡ Sentinel çš„å±€éƒ¨é¢†å¤´ Sentinel çš„è¿è¡Œ ID å’Œé…ç½®çºªå…ƒ æº Sentinel æ¥æ”¶ç›®æ ‡ Sentinel å‘½ä»¤å›å¤ä¹‹åï¼Œä¼šåˆ¤æ–­ leader_epoch æ˜¯å¦å’Œè‡ªå·±çš„ç›¸åŒï¼Œç›¸åŒå°±ç»§ç»­åˆ¤æ–­ leader_runid æ˜¯å¦å’Œè‡ªå·±çš„è¿è¡Œ ID ä¸€è‡´ï¼Œæˆç«‹è¡¨ç¤ºç›®æ ‡ Sentinel å°†æº Sentinel è®¾ç½®æˆäº†å±€éƒ¨é¢†å¤´ Sentinelï¼Œå³è·å¾—ä¸€ç¥¨ å¦‚æœæŸä¸ª Sentinel è¢«åŠæ•°ä»¥ä¸Šçš„ Sentinel è®¾ç½®æˆäº†å±€éƒ¨é¢†å¤´ Sentinelï¼Œé‚£ä¹ˆè¿™ä¸ª Sentinel æˆä¸ºé¢†å¤´ Sentinel å¦‚æœåœ¨ç»™å®šæ—¶é™å†…ï¼Œæ²¡æœ‰ä¸€ä¸ª Sentinel è¢«é€‰ä¸¾ä¸ºé¢†å¤´ Sentinelï¼Œé‚£ä¹ˆå„ä¸ª Sentinel å°†åœ¨ä¸€æ®µæ—¶é—´åå†æ¬¡é€‰ä¸¾ï¼Œç›´åˆ°é€‰å‡ºé¢†å¤´ æ¯æ¬¡è¿›è¡Œé¢†å¤´ Sentinel é€‰ä¸¾ä¹‹åï¼Œä¸è®ºé€‰ä¸¾æ˜¯å¦æˆåŠŸï¼Œæ‰€æœ‰ Sentinel çš„é…ç½®çºªå…ƒï¼ˆconfiguration epochï¼‰éƒ½è¦è‡ªå¢ä¸€æ¬¡ Sentinel é›†ç¾¤è‡³å°‘ 3 ä¸ªèŠ‚ç‚¹çš„åŸå› ï¼š å¦‚æœ Sentinel é›†ç¾¤åªæœ‰ 2 ä¸ª Sentinel èŠ‚ç‚¹ï¼Œåˆ™é¢†å¤´é€‰ä¸¾éœ€è¦ 2/2 + 1 = 2 ç¥¨ï¼Œå¦‚æœä¸€ä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œé‚£å°±æ°¸è¿œé€‰ä¸å‡ºé¢†å¤´ Sentinel é›†ç¾¤å…è®¸ 1 ä¸ª Sentinel èŠ‚ç‚¹æ•…éšœåˆ™éœ€è¦ 3 ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œå…è®¸ 2 ä¸ªèŠ‚ç‚¹æ•…éšœåˆ™éœ€è¦ 5 ä¸ªèŠ‚ç‚¹é›†ç¾¤ å¦‚ä½•è·å–å“¨å…µèŠ‚ç‚¹çš„åŠæ•°æ•°é‡ï¼Ÿ å®¢è§‚ä¸‹çº¿æ˜¯é€šè¿‡é…ç½®æ–‡ä»¶è·å–çš„æ•°é‡ï¼Œè¾¾åˆ° quorum å°±å®¢è§‚ä¸‹çº¿ å“¨å…µæ•°é‡æ˜¯é€šè¿‡ä¸»èŠ‚ç‚¹æ˜¯å®ä¾‹ç»“æ„ä¸­ï¼Œä¿å­˜ç€ç›‘è§†è¯¥ä¸»èŠ‚ç‚¹çš„æ‰€æœ‰å“¨å…µä¿¡æ¯ï¼Œä»è€Œè·å–å¾—åˆ° æ•…éšœè½¬ç§»æ‰§è¡Œæµç¨‹é¢†å¤´ Sentinel å°†å¯¹å·²ä¸‹çº¿çš„ä¸»æœåŠ¡å™¨æ‰§è¡Œæ•…éšœè½¬ç§»æ“ä½œï¼Œè¯¥æ“ä½œåŒ…å«ä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤ ä»ä¸‹çº¿ä¸»æœåŠ¡å™¨å±ä¸‹çš„æ‰€æœ‰ä»æœåŠ¡å™¨é‡Œé¢ï¼ŒæŒ‘é€‰å‡ºä¸€ä¸ªä»æœåŠ¡å™¨ï¼Œæ‰§è¡Œ SLAVEOF no oneï¼Œå°†ä»æœåŠ¡å™¨å‡çº§ä¸ºä¸»æœåŠ¡å™¨ åœ¨å‘é€ SLAVEOF no one å‘½ä»¤åï¼Œé¢†å¤´ Sentinel ä¼šä»¥æ¯ç§’ä¸€æ¬¡çš„é¢‘ç‡ï¼ˆä¸€èˆ¬æ˜¯ 10s&#x2F;æ¬¡ï¼‰å‘è¢«å‡çº§çš„ä»æœåŠ¡å™¨å‘é€ INFO å‘½ä»¤ï¼Œè§‚å¯Ÿå‘½ä»¤å›å¤ä¸­çš„è§’è‰²ä¿¡æ¯ï¼Œå½“è¢«å‡çº§æœåŠ¡å™¨çš„ role ä» slave å˜ä¸º master æ—¶ï¼Œè¯´æ˜ä»æœåŠ¡å™¨å·²ç»é¡ºåˆ©å‡çº§ä¸ºä¸»æœåŠ¡å™¨ å°†å·²ä¸‹çº¿çš„ä¸»æœåŠ¡å™¨çš„æ‰€æœ‰ä»æœåŠ¡å™¨æ”¹ä¸ºå¤åˆ¶æ–°çš„ä¸»æœåŠ¡å™¨ï¼Œé€šè¿‡å‘ä»æœåŠ¡å™¨å‘é€ SLAVEOF å‘½ä»¤å®ç° å°†å·²ç»ä¸‹çº¿çš„ä¸»æœåŠ¡å™¨è®¾ç½®ä¸ºæ–°çš„ä¸»æœåŠ¡å™¨çš„ä»æœåŠ¡å™¨ï¼Œè®¾ç½®æ˜¯ä¿å­˜åœ¨æœåŠ¡å™¨å¯¹åº”çš„å®ä¾‹ç»“æ„ä¸­ï¼Œå½“æ—§çš„ä¸»æœåŠ¡å™¨é‡æ–°ä¸Šçº¿æ—¶ï¼ŒSentinel å°±ä¼šå‘å®ƒå‘é€ SLAVEOF å‘½ä»¤ï¼Œæˆä¸ºæ–°çš„ä¸»æœåŠ¡å™¨çš„ä»æœåŠ¡å™¨ ç¤ºä¾‹ï¼šsever1 æ˜¯ä¸»ï¼Œsever2ã€sever3ã€sever4 æ˜¯ä»æœåŠ¡å™¨ï¼Œsever1 æ•…éšœåé€‰ä¸­ sever2 å‡çº§ é€‰æ‹©ç®—æ³•é¢†å¤´ Sentinel ä¼šå°†å·²ä¸‹çº¿ä¸»æœåŠ¡å™¨çš„æ‰€æœ‰ä»æœåŠ¡å™¨ä¿å­˜åˆ°ä¸€ä¸ªåˆ—è¡¨é‡Œï¼Œç„¶åæŒ‰ç…§ä»¥ä¸‹è§„åˆ™å¯¹åˆ—è¡¨è¿›è¡Œè¿‡æ»¤ï¼Œæœ€åæŒ‘é€‰å‡ºä¸€ä¸ªçŠ¶æ€è‰¯å¥½ã€æ•°æ®å®Œæ•´çš„ä»æœåŠ¡å™¨ åˆ é™¤åˆ—è¡¨ä¸­æ‰€æœ‰å¤„äºä¸‹çº¿æˆ–è€…æ–­çº¿çŠ¶æ€çš„ä»æœåŠ¡å™¨ï¼Œä¿è¯åˆ—è¡¨ä¸­çš„ä»æœåŠ¡å™¨éƒ½æ˜¯æ­£å¸¸åœ¨çº¿çš„ åˆ é™¤åˆ—è¡¨ä¸­æ‰€æœ‰æœ€è¿‘äº”ç§’å†…æ²¡æœ‰å›å¤è¿‡é¢†å¤´ Sentinel çš„ INFO å‘½ä»¤çš„ä»æœåŠ¡å™¨ï¼Œä¿è¯åˆ—è¡¨ä¸­çš„ä»æœåŠ¡å™¨æœ€è¿‘æˆåŠŸè¿›è¡Œè¿‡é€šä¿¡ åˆ é™¤æ‰€æœ‰ä¸å·²ä¸‹çº¿ä¸»æœåŠ¡å™¨è¿æ¥æ–­å¼€è¶…è¿‡ down-after-milliseconds * 10 æ¯«ç§’çš„ä»æœåŠ¡å™¨ï¼Œä¿è¯åˆ—è¡¨ä¸­å‰©ä½™çš„ä»æœåŠ¡å™¨éƒ½æ²¡æœ‰è¿‡æ—©åœ°ä¸ä¸»æœåŠ¡å™¨æ–­å¼€è¿æ¥ï¼Œä¿å­˜çš„æ•°æ®éƒ½æ˜¯æ¯”è¾ƒæ–°çš„ down-after-milliseconds æ—¶é—´ç”¨æ¥åˆ¤æ–­æ˜¯å¦ä¸»è§‚ä¸‹çº¿ï¼Œå…¶ä½™çš„æ—¶é—´å®Œå…¨å¯ä»¥å®Œæˆå®¢è§‚ä¸‹çº¿å’Œé¢†å¤´é€‰ä¸¾ æ ¹æ®ä»æœåŠ¡å™¨çš„ä¼˜å…ˆçº§ï¼Œå¯¹åˆ—è¡¨ä¸­å‰©ä½™çš„ä»æœåŠ¡å™¨è¿›è¡Œæ’åºï¼Œå¹¶é€‰å‡ºå…¶ä¸­ä¼˜å…ˆçº§æœ€é«˜çš„ä»æœåŠ¡å™¨ å¦‚æœæœ‰å¤šä¸ªå…·æœ‰ç›¸åŒæœ€é«˜ä¼˜å…ˆçº§çš„ä»æœåŠ¡å™¨ï¼Œé¢†å¤´ Sentinel å°†å¯¹è¿™äº›ç›¸åŒä¼˜å…ˆçº§çš„æœåŠ¡å™¨æŒ‰ç…§å¤åˆ¶åç§»é‡è¿›è¡Œæ’åºï¼Œé€‰å‡ºå…¶ä¸­åç§»é‡æœ€å¤§çš„ä»æœåŠ¡å™¨ï¼Œä¹Ÿå°±æ˜¯ä¿å­˜ç€æœ€æ–°æ•°æ®çš„ä»æœåŠ¡å™¨ å¦‚æœè¿˜æ²¡é€‰å‡ºæ¥ï¼Œå°±æŒ‰ç…§è¿è¡Œ ID å¯¹è¿™äº›ä»æœåŠ¡å™¨è¿›è¡Œæ’åºï¼Œå¹¶é€‰å‡ºå…¶ä¸­è¿è¡Œ ID æœ€å°çš„ä»æœåŠ¡å™¨ é›†ç¾¤æ¨¡å¼é›†ç¾¤èŠ‚ç‚¹èŠ‚ç‚¹æ¦‚è¿°Redis é›†ç¾¤æ˜¯ Redis æä¾›çš„åˆ†å¸ƒå¼æ•°æ®åº“æ–¹æ¡ˆï¼Œé›†ç¾¤é€šè¿‡åˆ†ç‰‡ï¼ˆshardingï¼‰æ¥è¿›è¡Œæ•°æ®å…±äº«ï¼Œ å¹¶æä¾›å¤åˆ¶å’Œæ•…éšœè½¬ç§»åŠŸèƒ½ï¼Œä¸€ä¸ª Redis é›†ç¾¤é€šå¸¸ç”±å¤šä¸ªèŠ‚ç‚¹ï¼ˆnodeï¼‰ç»„æˆï¼Œå°†å„ä¸ªç‹¬ç«‹çš„èŠ‚ç‚¹è¿æ¥èµ·æ¥ï¼Œæ„æˆä¸€ä¸ªåŒ…å«å¤šèŠ‚ç‚¹çš„é›†ç¾¤ ä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨é›†ç¾¤æ¨¡å¼ä¸‹çš„ Redis æœåŠ¡å™¨ï¼ŒRedis åœ¨å¯åŠ¨æ—¶ä¼šæ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„ cluster-enabled é…ç½®é€‰é¡¹æ˜¯å¦ä¸º yes æ¥å†³å®šæ˜¯å¦å¼€å¯æœåŠ¡å™¨çš„é›†ç¾¤æ¨¡å¼ èŠ‚ç‚¹ä¼šç»§ç»­ä½¿ç”¨æ‰€æœ‰åœ¨å•æœºæ¨¡å¼ä¸­ä½¿ç”¨çš„æœåŠ¡å™¨ç»„ä»¶ï¼Œä½¿ç”¨ redisServer ç»“æ„æ¥ä¿å­˜æœåŠ¡å™¨çš„çŠ¶æ€ï¼Œä½¿ç”¨ redisClient ç»“æ„æ¥ä¿å­˜å®¢æˆ·ç«¯çš„çŠ¶æ€ï¼Œä¹Ÿæœ‰é›†ç¾¤ç‰¹æœ‰çš„æ•°æ®ç»“æ„ æ•°æ®ç»“æ„æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¿å­˜ç€ä¸€ä¸ªé›†ç¾¤çŠ¶æ€ clusterState ç»“æ„ï¼Œè¿™ä¸ªç»“æ„è®°å½•äº†åœ¨å½“å‰èŠ‚ç‚¹çš„è§†è§’ä¸‹ï¼Œé›†ç¾¤ç›®å‰æ‰€å¤„çš„çŠ¶æ€ 1234567891011121314151617typedef struct clusterState &#123; // æŒ‡å‘å½“å‰èŠ‚ç‚¹çš„æŒ‡é’ˆ clusterNode *myself; // é›†ç¾¤å½“å‰çš„é…ç½®çºªå…ƒï¼Œç”¨äºå®ç°æ•…éšœè½¬ç§» uint64_t currentEpoch; // é›†ç¾¤å½“å‰çš„çŠ¶æ€ï¼Œæ˜¯åœ¨çº¿è¿˜æ˜¯ä¸‹çº¿ int state; // é›†ç¾¤ä¸­è‡³å°‘å¤„ç†ç€ä¸€ä¸ªæ§½çš„ï¼ˆä¸»ï¼‰èŠ‚ç‚¹çš„æ•°é‡ï¼Œä¸º0è¡¨ç¤ºé›†ç¾¤ç›®å‰æ²¡æœ‰ä»»ä½•èŠ‚ç‚¹åœ¨å¤„ç†æ§½ // ã€é€‰ä¸¾æ—¶æŠ•ç¥¨æ•°é‡è¶…è¿‡åŠæ•°ï¼Œä»è¿™é‡Œè·å–çš„ã€‘ int size; // é›†ç¾¤èŠ‚ç‚¹åå•ï¼ˆåŒ…æ‹¬ myself èŠ‚ç‚¹ï¼‰ï¼Œå­—å…¸çš„é”®ä¸ºèŠ‚ç‚¹çš„åå­—ï¼Œå­—å…¸çš„å€¼ä¸ºèŠ‚ç‚¹å¯¹åº”çš„clusterNodeç»“æ„ dict *nodes;&#125; æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šä½¿ç”¨ clusterNode ç»“æ„è®°å½•å½“å‰çŠ¶æ€ï¼Œå¹¶ä¸ºé›†ç¾¤ä¸­çš„æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹ï¼‰éƒ½åˆ›å»ºä¸€ä¸ªç›¸åº”çš„ clusterNode ç»“æ„ï¼Œä»¥æ­¤æ¥è®°å½•å…¶ä»–èŠ‚ç‚¹çš„çŠ¶æ€ 12345678910111213141516171819202122struct clusterNode &#123; // åˆ›å»ºèŠ‚ç‚¹çš„æ—¶é—´ mstime_t ctime; // èŠ‚ç‚¹çš„åå­—ï¼Œç”± 40 ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ç»„æˆ char name[REDIS_CLUSTER_NAMELEN]; // èŠ‚ç‚¹æ ‡è¯†ï¼Œä½¿ç”¨å„ç§ä¸åŒçš„æ ‡è¯†å€¼è®°å½•èŠ‚ç‚¹çš„è§’è‰²ï¼ˆæ¯”å¦‚ä¸»èŠ‚ç‚¹æˆ–è€…ä»èŠ‚ç‚¹ï¼‰ä»¥åŠèŠ‚ç‚¹ç›®å‰æ‰€å¤„çš„çŠ¶æ€ï¼ˆæ¯”å¦‚åœ¨çº¿æˆ–è€…ä¸‹çº¿ï¼‰ int flags; // èŠ‚ç‚¹å½“å‰çš„é…ç½®çºªå…ƒï¼Œç”¨äºå®ç°æ•…éšœè½¬ç§» uint64_t configEpoch; // èŠ‚ç‚¹çš„IPåœ°å€ char ip[REDIS_IP_STR_LEN]; // èŠ‚ç‚¹çš„ç«¯å£å· int port; // ä¿å­˜è¿æ¥èŠ‚ç‚¹æ‰€éœ€çš„æœ‰å…³ä¿¡æ¯ clusterLink *link;&#125; clusterNode ç»“æ„çš„ link å±æ€§æ˜¯ä¸€ä¸ª clusterLink ç»“æ„ï¼Œè¯¥ç»“æ„ä¿å­˜äº†è¿æ¥èŠ‚ç‚¹æ‰€éœ€çš„æœ‰å…³ä¿¡æ¯ 12345678910111213141516typedef struct clusterLink &#123; // è¿æ¥çš„åˆ›å»ºæ—¶é—´ mstime_t ctime; // TCPå¥—æ¥å­—æè¿°ç¬¦ int fd; // è¾“å‡ºç¼“å†²åŒºï¼Œä¿å­˜ç€ç­‰å¾…å‘é€ç»™å…¶ä»–èŠ‚ç‚¹çš„æ¶ˆæ¯(message)ã€‚ sds sndbuf; // è¾“å…¥ç¼“å†²åŒºï¼Œä¿å­˜ç€ä»å…¶ä»–èŠ‚ç‚¹æ¥æ”¶åˆ°çš„æ¶ˆæ¯ã€‚ sds rcvbuf; // ä¸è¿™ä¸ªè¿æ¥ç›¸å…³è”çš„èŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æœ‰çš„è¯å°±ä¸ºNULL struct clusterNode *node; &#125; redisClient ç»“æ„ä¸­çš„å¥—æ¥å®‡å’Œç¼“å†²åŒºæ˜¯ç”¨äºè¿æ¥å®¢æˆ·ç«¯çš„ clusterLink ç»“æ„ä¸­çš„å¥—æ¥å®‡å’Œç¼“å†²åŒºåˆ™æ˜¯ç”¨äºè¿æ¥èŠ‚ç‚¹çš„ MEETCLUSTER MEET å‘½ä»¤ç”¨æ¥å°† ip å’Œ port æ‰€æŒ‡å®šçš„èŠ‚ç‚¹æ·»åŠ åˆ°æ¥å—å‘½ä»¤çš„èŠ‚ç‚¹æ‰€åœ¨çš„é›†ç¾¤ä¸­ 1CLUSTER MEET &lt;ip&gt; &lt;port&gt; å‡è®¾å‘èŠ‚ç‚¹ A å‘é€ CLUSTER MEET å‘½ä»¤ï¼Œè®©èŠ‚ç‚¹ A å°†å¦ä¸€ä¸ªèŠ‚ç‚¹ B æ·»åŠ åˆ°èŠ‚ç‚¹ A å½“å‰æ‰€åœ¨çš„é›†ç¾¤é‡Œï¼Œæ”¶åˆ°å‘½ä»¤çš„èŠ‚ç‚¹ A å°†ä¸æ ¹æ® ip å’Œ port å‘èŠ‚ç‚¹ B è¿›è¡Œæ¡æ‰‹ï¼ˆhandshakeï¼‰ï¼š èŠ‚ç‚¹ A ä¼šä¸ºèŠ‚ç‚¹ B åˆ›å»ºä¸€ä¸ª clusterNode ç»“æ„ï¼Œå¹¶å°†è¯¥ç»“æ„æ·»åŠ åˆ°è‡ªå·±çš„ clusterState.nodes å­—å…¸é‡Œï¼Œç„¶åèŠ‚ç‚¹ A å‘èŠ‚ç‚¹ B å‘é€ MEET æ¶ˆæ¯ï¼ˆmessageï¼‰ èŠ‚ç‚¹ B æ”¶åˆ° MEET æ¶ˆæ¯åï¼ŒèŠ‚ç‚¹ B ä¼šä¸ºèŠ‚ç‚¹ A åˆ›å»ºä¸€ä¸ª clusterNode ç»“æ„ï¼Œå¹¶å°†è¯¥ç»“æ„æ·»åŠ åˆ°è‡ªå·±çš„ clusterState.nodes å­—å…¸é‡Œï¼Œä¹‹åèŠ‚ç‚¹ B å°†å‘èŠ‚ç‚¹ A è¿”å›ä¸€æ¡ PONG æ¶ˆæ¯ èŠ‚ç‚¹ A æ”¶åˆ° PONG æ¶ˆæ¯åï¼Œä»£è¡¨èŠ‚ç‚¹ A å¯ä»¥çŸ¥é“èŠ‚ç‚¹ B å·²ç»æˆåŠŸåœ°æ¥æ”¶åˆ°äº†è‡ªå·²å‘é€çš„ MEET æ¶ˆæ¯ï¼Œæ­¤æ—¶èŠ‚ç‚¹ A å°†å‘èŠ‚ç‚¹ B è¿”å›ä¸€æ¡ PING æ¶ˆæ¯ èŠ‚ç‚¹ B æ”¶åˆ° PING æ¶ˆæ¯åï¼Œ ä»£è¡¨èŠ‚ç‚¹ B å¯ä»¥çŸ¥é“èŠ‚ç‚¹ A å·²ç»æˆåŠŸåœ°æ¥æ”¶åˆ°äº†è‡ªå·±è¿”å›çš„ PONG æ¶ˆæ¯ï¼Œæ¡æ‰‹å®Œæˆ èŠ‚ç‚¹ A ä¼šå°†èŠ‚ç‚¹ B çš„ä¿¡æ¯é€šè¿‡ Gossip åè®®ä¼ æ’­ç»™é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹ï¼Œè®©å…¶ä»–èŠ‚ç‚¹ä¹Ÿä¸èŠ‚ç‚¹ B è¿›è¡Œæ¡æ‰‹ï¼Œæœ€ç»ˆç»è¿‡ä¸€æ®µæ—¶é—´ä¹‹åï¼ŒèŠ‚ç‚¹ B ä¼šè¢«é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹è®¤è¯† æ§½æŒ‡æ´¾åŸºæœ¬æ“ä½œRedis é›†ç¾¤é€šè¿‡åˆ†ç‰‡çš„æ–¹å¼æ¥ä¿å­˜æ•°æ®åº“ä¸­çš„é”®å€¼å¯¹ï¼Œé›†ç¾¤çš„æ•´ä¸ªæ•°æ®åº“è¢«åˆ†ä¸º 16384 ä¸ªæ§½ï¼ˆslotï¼‰ï¼Œæ•°æ®åº“ä¸­çš„æ¯ä¸ªé”®éƒ½å±äº 16384 ä¸ªæ§½ä¸­çš„ä¸€ä¸ªï¼Œé›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹å¯ä»¥å¤„ç† 0 ä¸ªæˆ–æœ€å¤š 16384 ä¸ªæ§½ï¼ˆæ¯ä¸ªä¸»èŠ‚ç‚¹å­˜å‚¨çš„æ•°æ®å¹¶ä¸ä¸€æ ·ï¼‰ å½“æ•°æ®åº“ä¸­çš„ 16384 ä¸ªæ§½éƒ½æœ‰èŠ‚ç‚¹åœ¨å¤„ç†æ—¶ï¼Œé›†ç¾¤å¤„äºä¸Šçº¿çŠ¶æ€ï¼ˆokï¼‰ å¦‚æœæ•°æ®åº“ä¸­æœ‰ä»»ä½•ä¸€ä¸ªæ§½å¾—åˆ°å¤„ç†ï¼Œé‚£ä¹ˆé›†ç¾¤å¤„äºä¸‹çº¿çŠ¶æ€ï¼ˆfailï¼‰ é€šè¿‡å‘èŠ‚ç‚¹å‘é€ CLUSTER ADDSLOTS å‘½ä»¤ï¼Œå¯ä»¥å°†ä¸€ä¸ªæˆ–å¤šä¸ªæ§½æŒ‡æ´¾ï¼ˆassignï¼‰ç»™èŠ‚ç‚¹è´Ÿè´£ 1CLUSTER ADDSLOTS &lt;slot&gt; [slot ... ] 12127.0.0.1:7000&gt; CLUSTER ADDSLOTS 0 1 2 3 4 ... 5000 # å°†æ§½0è‡³æ§½5000æŒ‡æ´¾ç»™èŠ‚ç‚¹7000è´Ÿè´£OK å‘½ä»¤æ‰§è¡Œç»†èŠ‚ï¼š å¦‚æœå‘½ä»¤å‚æ•°ä¸­æœ‰ä¸€ä¸ªæ§½å·²ç»è¢«æŒ‡æ´¾ç»™äº†æŸä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆä¼šå‘å®¢æˆ·ç«¯è¿”å›é”™è¯¯ï¼Œå¹¶ç»ˆæ­¢å‘½ä»¤æ‰§è¡Œ å°† slots æ•°ç»„ä¸­çš„ç´¢å¼• i ä¸Šçš„äºŒè¿›åˆ¶ä½è®¾ç½®ä¸º 1ï¼Œå°±ä»£è¡¨æŒ‡æ´¾æˆåŠŸ èŠ‚ç‚¹æŒ‡æ´¾clusterNode ç»“æ„çš„ slots å±æ€§å’Œ numslot å±æ€§è®°å½•äº†èŠ‚ç‚¹è´Ÿè´£å¤„ç†å“ªäº›æ§½ï¼š 123456struct clusterNode &#123; // å¤„ç†ä¿¡æ¯ï¼Œä¸€å­—èŠ‚ç­‰äº 8 ä½ unsigned char slots[l6384/8]; // è®°å½•èŠ‚ç‚¹è´Ÿè´£å¤„ç†çš„æ§½çš„æ•°é‡ï¼Œå°±æ˜¯ slots æ•°ç»„ä¸­å€¼ä¸º 1 çš„äºŒè¿›åˆ¶ä½æ•°é‡ int numslots;&#125; slots æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶ä½æ•°ç»„ï¼ˆbit arrayï¼‰ï¼Œé•¿åº¦ä¸º 16384/8 = 2048 ä¸ªå­—èŠ‚ï¼ŒåŒ…å« 16384 ä¸ªäºŒè¿›åˆ¶ä½ï¼ŒRedis ä»¥ 0 ä¸ºèµ·å§‹ç´¢å¼•ï¼Œ16383 ä¸ºç»ˆæ­¢ç´¢å¼•ï¼Œå¯¹ slots æ•°ç»„çš„ 16384 ä¸ªäºŒè¿›åˆ¶ä½è¿›è¡Œç¼–å·ï¼Œå¹¶æ ¹æ®ç´¢å¼• i ä¸Šçš„äºŒè¿›åˆ¶ä½çš„å€¼æ¥åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦è´Ÿè´£å¤„ç†æ§½ iï¼š åœ¨ç´¢å¼• i ä¸Šçš„äºŒè¿›åˆ¶ä½çš„å€¼ä¸º 1ï¼Œé‚£ä¹ˆè¡¨ç¤ºèŠ‚ç‚¹è´Ÿè´£å¤„ç†æ§½ i åœ¨ç´¢å¼• i ä¸Šçš„äºŒè¿›åˆ¶ä½çš„å€¼ä¸º 0ï¼Œé‚£ä¹ˆè¡¨ç¤ºèŠ‚ç‚¹ä¸è´Ÿè´£å¤„ç†æ§½ i å–å‡ºå’Œè®¾ç½® slots æ•°ç»„ä¸­çš„ä»»æ„ä¸€ä¸ªäºŒè¿›åˆ¶ä½çš„å€¼çš„**å¤æ‚åº¦ä»…ä¸º O(1)**ï¼Œæ‰€ä»¥å¯¹äºä¸€ä¸ªç»™å®šèŠ‚ç‚¹çš„ slots æ•°ç»„æ¥è¯´ï¼Œæ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦è´Ÿè´£å¤„ç†æŸä¸ªæ§½æˆ–è€…å°†æŸä¸ªæ§½æŒ‡æ´¾ç»™èŠ‚ç‚¹è´Ÿè´£ï¼Œè¿™ä¸¤ä¸ªåŠ¨ä½œçš„å¤æ‚åº¦éƒ½æ˜¯ O(1) ä¼ æ’­èŠ‚ç‚¹çš„æ§½æŒ‡æ´¾ä¿¡æ¯ï¼šä¸€ä¸ªèŠ‚ç‚¹é™¤äº†ä¼šå°†è‡ªå·±è´Ÿè´£å¤„ç†çš„æ§½è®°å½•åœ¨ clusterNode ä¸­ï¼Œè¿˜ä¼šå°†è‡ªå·±çš„ slots æ•°ç»„é€šè¿‡æ¶ˆæ¯å‘é€ç»™é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹ï¼Œæ¯ä¸ªæ¥æ”¶åˆ° slots æ•°ç»„çš„èŠ‚ç‚¹éƒ½ä¼šå°†æ•°ç»„ä¿å­˜åˆ°ç›¸åº”èŠ‚ç‚¹çš„ clusterNode ç»“æ„é‡Œé¢ï¼Œå› æ­¤é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šçŸ¥é“æ•°æ®åº“ä¸­çš„ 16384 ä¸ªæ§½åˆ†åˆ«è¢«æŒ‡æ´¾ç»™äº†é›†ç¾¤ä¸­çš„å“ªäº›èŠ‚ç‚¹ é›†ç¾¤æŒ‡æ´¾é›†ç¾¤çŠ¶æ€ clusterState ç»“æ„ä¸­çš„ slots æ•°ç»„è®°å½•äº†é›†ç¾¤ä¸­æ‰€æœ‰ 16384 ä¸ªæ§½çš„æŒ‡æ´¾ä¿¡æ¯ï¼Œæ•°ç»„æ¯ä¸€é¡¹éƒ½æ˜¯ä¸€ä¸ªæŒ‡å‘ clusterNode çš„æŒ‡é’ˆ 1234typedef struct clusterState &#123; // ... clusterNode *slots[16384];&#125; å¦‚æœ slots[i] æŒ‡é’ˆæŒ‡å‘ NULLï¼Œé‚£ä¹ˆè¡¨ç¤ºæ§½ i å°šæœªæŒ‡æ´¾ç»™ä»»ä½•èŠ‚ç‚¹ å¦‚æœ slots[i] æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ª clusterNode ç»“æ„ï¼Œé‚£ä¹ˆè¡¨ç¤ºæ§½ i å·²ç»æŒ‡æ´¾ç»™è¯¥èŠ‚ç‚¹æ‰€ä»£è¡¨çš„èŠ‚ç‚¹ é€šè¿‡è¯¥èŠ‚ç‚¹ï¼Œç¨‹åºæ£€æŸ¥æ§½ i æ˜¯å¦å·²ç»è¢«æŒ‡æ´¾æˆ–è€…å–å¾—è´Ÿè´£å¤„ç†æ§½ i çš„èŠ‚ç‚¹ï¼Œåªéœ€è¦è®¿é—® clusterState. slots[i] å³å¯ï¼Œæ—¶é—´å¤æ‚åº¦ä»…ä¸º O(1) é›†ç¾¤æ•°æ®é›†ç¾¤èŠ‚ç‚¹ä¿å­˜é”®å€¼å¯¹ä»¥åŠé”®å€¼å¯¹è¿‡æœŸæ—¶é—´çš„æ–¹å¼ï¼Œä¸å•æœº Redis æœåŠ¡å™¨ä¿å­˜é”®å€¼å¯¹ä»¥åŠé”®å€¼å¯¹è¿‡æœŸæ—¶é—´çš„æ–¹å¼å®Œå…¨ç›¸åŒï¼Œä½†æ˜¯é›†ç¾¤èŠ‚ç‚¹åªèƒ½ä½¿ç”¨ 0 å·æ•°æ®åº“ï¼Œå•æœºæœåŠ¡å™¨å¯ä»¥ä»»æ„ä½¿ç”¨ é™¤äº†å°†é”®å€¼å¯¹ä¿å­˜åœ¨æ•°æ®åº“é‡Œé¢ä¹‹å¤–ï¼ŒèŠ‚ç‚¹è¿˜ä¼šç”¨ clusterState ç»“æ„ä¸­çš„ slots_to_keys è·³è·ƒè¡¨æ¥ä¿å­˜æ§½å’Œé”®ä¹‹é—´çš„å…³ç³» 1234typedef struct clusterState &#123; // ... zskiplist *slots_to_keys;&#125; slots_to_keys è·³è·ƒè¡¨æ¯ä¸ªèŠ‚ç‚¹çš„åˆ†å€¼ï¼ˆscoreï¼‰éƒ½æ˜¯ä¸€ä¸ªæ§½å·ï¼Œè€Œæ¯ä¸ªèŠ‚ç‚¹çš„æˆå‘˜ï¼ˆmemberï¼‰éƒ½æ˜¯ä¸€ä¸ªæ•°æ®åº“é”®ï¼ˆæŒ‰æ§½å·å‡åºï¼‰ å½“èŠ‚ç‚¹å¾€æ•°æ®åº“ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„é”®å€¼å¯¹æ—¶ï¼ŒèŠ‚ç‚¹å°±ä¼šå°†è¿™ä¸ªé”®ä»¥åŠé”®çš„æ§½å·å…³è”åˆ° slots_to_keys è·³è·ƒè¡¨ å½“èŠ‚ç‚¹åˆ é™¤æ•°æ®åº“ä¸­çš„æŸä¸ªé”®å€¼å¯¹æ—¶ï¼ŒèŠ‚ç‚¹å°±ä¼šåœ¨ slots_to_keys è·³è·ƒè¡¨è§£é™¤è¢«åˆ é™¤é”®ä¸æ§½å·çš„å…³è” é€šè¿‡åœ¨ slots_to_keys è·³è·ƒè¡¨ä¸­è®°å½•å„ä¸ªæ•°æ®åº“é”®æ‰€å±çš„æ§½ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¯¹å±äºæŸä¸ªæˆ–æŸäº›æ§½çš„æ‰€æœ‰æ•°æ®åº“é”®è¿›è¡Œæ‰¹é‡æ“ä½œï¼Œæ¯”å¦‚ CLUSTER GETKEYSINSLOT &lt;slot&gt; &lt;count&gt; å‘½ä»¤è¿”å›æœ€å¤š count ä¸ªå±äºæ§½ slot çš„æ•°æ®åº“é”®ï¼Œå°±æ˜¯é€šè¿‡è¯¥è·³è¡¨å®ç° é›†ç¾¤å‘½ä»¤æ‰§è¡Œå‘½ä»¤é›†ç¾¤å¤„äºä¸Šçº¿çŠ¶æ€ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥å‘é›†ç¾¤ä¸­çš„èŠ‚ç‚¹å‘é€å‘½ä»¤ï¼ˆ16384 ä¸ªæ§½å…¨éƒ¨æŒ‡æ´¾å°±è¿›å…¥ä¸Šçº¿çŠ¶æ€ï¼‰ å½“å®¢æˆ·ç«¯å‘èŠ‚ç‚¹å‘é€ä¸æ•°æ®åº“é”®æœ‰å…³çš„å‘½ä»¤æ—¶ï¼Œæ¥æ”¶å‘½ä»¤çš„èŠ‚ç‚¹ä¼šè®¡ç®—å‡ºå‘½ä»¤è¯¥é”®å±äºå“ªä¸ªæ§½ï¼Œå¹¶æ£€æŸ¥è¿™ä¸ªæ§½æ˜¯å¦æŒ‡æ´¾ç»™äº†è‡ªå·± å¦‚æœé”®æ‰€åœ¨çš„æ§½æ­£å¥½å°±æŒ‡æ´¾ç»™äº†å½“å‰èŠ‚ç‚¹ï¼Œé‚£ä¹ˆèŠ‚ç‚¹ç›´æ¥æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ åä¹‹ï¼ŒèŠ‚ç‚¹ä¼šå‘å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ª MOVED é”™è¯¯ï¼ŒæŒ‡å¼•å®¢æˆ·ç«¯è½¬å‘ï¼ˆredirectï¼‰è‡³æ­£ç¡®çš„èŠ‚ç‚¹ï¼Œå†æ¬¡å‘é€è¯¥å‘½ä»¤ è®¡ç®—é”®å½’å±å“ªä¸ªæ§½çš„å¯»å€ç®—æ³•ï¼š 12def slot_number(key): // CRC16(key) è¯­å¥è®¡ç®—é”® key çš„ CRC-16 æ ¡éªŒå’Œ return CRC16(key) &amp; 16383; // å–æ¨¡ï¼Œåè¿›åˆ¶å¯¹16384çš„å–ä½™ ä½¿ç”¨ CLUSTER KEYSLOT &lt;key&gt; å‘½ä»¤å¯ä»¥æŸ¥çœ‹ä¸€ä¸ªç»™å®šé”®å±äºå“ªä¸ªæ§½ï¼Œåº•å±‚å®ç°ï¼š 12345def CLUSTER_KEYSLOT(key): // è®¡ç®—æ§½å· slot = slot_number(key); // å°†æ§½å·è¿”å›ç»™å®¢æˆ·ç«¯ reply_client(slot); åˆ¤æ–­æ§½æ˜¯å¦ç”±å½“å‰èŠ‚ç‚¹è´Ÿè´£å¤„ç†ï¼šå¦‚æœ clusterState.slots[i] ä¸ç­‰äº clusterState.myselfï¼Œé‚£ä¹ˆè¯´æ˜æ§½ i å¹¶éç”±å½“å‰èŠ‚ç‚¹è´Ÿè´£ï¼ŒèŠ‚ç‚¹ä¼šæ ¹æ® clusterState.slots[i] æŒ‡å‘çš„ clusterNode ç»“æ„æ‰€è®°å½•çš„èŠ‚ç‚¹ IP å’Œç«¯å£å·ï¼Œå‘å®¢æˆ·ç«¯è¿”å› MOVED é”™è¯¯ MOVEDMOVED é”™è¯¯çš„æ ¼å¼ä¸ºï¼š 1MOVED &lt;slot&gt; &lt;ip&gt;:&lt;portï¼ å‚æ•° slot ä¸ºé”®æ‰€åœ¨çš„æ§½ï¼Œip å’Œ port æ˜¯è´Ÿè´£å¤„ç†æ§½ slot çš„èŠ‚ç‚¹çš„ ip åœ°å€å’Œç«¯å£å· 1MOVED 12345 127.0.0.1:6380 # è¡¨ç¤ºæ§½ 12345 æ­£ç”± IPåœ°å€ä¸º 127.0.0.1, ç«¯å£å·ä¸º 6380 çš„èŠ‚ç‚¹è´Ÿè´£ å½“å®¢æˆ·ç«¯æ¥æ”¶åˆ°èŠ‚ç‚¹è¿”å›çš„ MOVED é”™è¯¯æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šæ ¹æ® MOVED é”™è¯¯ä¸­æä¾›çš„ IP åœ°å€å’Œç«¯å£å·ï¼Œè½¬è‡³è´Ÿè´£å¤„ç†æ§½ slot çš„èŠ‚ç‚¹é‡æ–°å‘é€æ‰§è¡Œçš„å‘½ä»¤ ä¸€ä¸ªé›†ç¾¤å®¢æˆ·ç«¯é€šå¸¸ä¼šä¸é›†ç¾¤ä¸­çš„å¤šä¸ªèŠ‚ç‚¹åˆ›å»ºå¥—æ¥å­—è¿æ¥ï¼ŒèŠ‚ç‚¹è½¬å‘å®é™…ä¸Šå°±æ˜¯æ¢ä¸€ä¸ªå¥—æ¥å­—æ¥å‘é€å‘½ä»¤ å¦‚æœå®¢æˆ·ç«¯å°šæœªä¸è½¬å‘çš„èŠ‚ç‚¹åˆ›å»ºå¥—æ¥å­—è¿æ¥ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ä¼šå…ˆæ ¹æ® IP åœ°å€å’Œç«¯å£å·æ¥è¿æ¥èŠ‚ç‚¹ï¼Œç„¶åå†è¿›è¡Œè½¬å‘ é›†ç¾¤æ¨¡å¼çš„ redis-cli åœ¨æ¥æ”¶åˆ° MOVED é”™è¯¯æ—¶ï¼Œå¹¶ä¸ä¼šæ‰“å°å‡º MOVED é”™è¯¯ï¼Œè€Œæ˜¯æ ¹æ®é”™è¯¯è‡ªåŠ¨è¿›è¡ŒèŠ‚ç‚¹è½¬å‘ï¼Œå¹¶æ‰“å°å‡ºè½¬å‘ä¿¡æ¯ï¼š 123456$ redis-cli -c -p 6379 #é›†ç¾¤æ¨¡å¼127.0.0.1:6379&gt; SET msg &quot;happy&quot; -&gt; Redirected to slot [6257] located at 127.0.0.1:6380OK 127.0.0.1:6379&gt; ä½¿ç”¨å•æœºï¼ˆstand aloneï¼‰æ¨¡å¼çš„ redis-cli ä¼šæ‰“å°é”™è¯¯ï¼Œå› ä¸ºå•æœºæ¨¡å¼å®¢æˆ·ç«¯ä¸æ¸…æ¥š MOVED é”™è¯¯çš„ä½œç”¨ï¼Œä¸ä¼šè¿›è¡Œè‡ªåŠ¨è½¬å‘ï¼š 12345$ redis-cli -c -p 6379 #é›†ç¾¤æ¨¡å¼127.0.0.1:6379&gt; SET msg &quot;happy&quot; (error) MOVED 6257 127.0.0.1:6380127.0.0.1:6379&gt; é‡æ–°åˆ†ç‰‡å®ç°åŸç†Redis é›†ç¾¤çš„é‡æ–°åˆ†ç‰‡æ“ä½œå¯ä»¥å°†ä»»æ„æ•°é‡å·²ç»æŒ‡æ´¾ç»™æŸä¸ªèŠ‚ç‚¹ï¼ˆæºèŠ‚ç‚¹ï¼‰çš„æ§½æ”¹ä¸ºæŒ‡æ´¾ç»™å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆç›®æ ‡èŠ‚ç‚¹ï¼‰ï¼Œå¹¶ä¸”ç›¸å…³æ§½çš„é”®å€¼å¯¹ä¹Ÿä¼šä»æºèŠ‚ç‚¹è¢«ç§»åŠ¨åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œè¯¥æ“ä½œæ˜¯å¯ä»¥åœ¨çº¿ï¼ˆonlineï¼‰è¿›è¡Œï¼Œåœ¨é‡æ–°åˆ†ç‰‡çš„è¿‡ç¨‹ä¸­æºèŠ‚ç‚¹å’Œç›®æ ‡èŠ‚ç‚¹éƒ½å¯ä»¥å¤„ç†å‘½ä»¤è¯·æ±‚ Redis çš„é›†ç¾¤ç®¡ç†è½¯ä»¶ redis-trib è´Ÿè´£æ‰§è¡Œé‡æ–°åˆ†ç‰‡æ“ä½œï¼Œredis-trib é€šè¿‡å‘æºèŠ‚ç‚¹å’Œç›®æ ‡èŠ‚ç‚¹å‘é€å‘½ä»¤æ¥è¿›è¡Œé‡æ–°åˆ†ç‰‡æ“ä½œ å‘ç›®æ ‡èŠ‚ç‚¹å‘é€ CLUSTER SETSLOT &lt;slot&gt; IMPORTING &lt;source_id&gt; å‘½ä»¤ï¼Œå‡†å¤‡å¥½ä»æºèŠ‚ç‚¹å¯¼å…¥å±äºæ§½ slot çš„é”®å€¼å¯¹ å‘æºèŠ‚ç‚¹å‘é€ CLUSTER SETSLOT &lt;slot&gt; MIGRATING &lt;target_id&gt; å‘½ä»¤ï¼Œè®©æºèŠ‚ç‚¹å‡†å¤‡å¥½å°†å±äºæ§½ slot çš„é”®å€¼å¯¹è¿ç§» redis-trib å‘æºèŠ‚ç‚¹å‘é€ CLUSTER GETKEYSINSLOT &lt;slot&gt; &lt;count&gt; å‘½ä»¤ï¼Œè·å¾—æœ€å¤š count ä¸ªå±äºæ§½ slot çš„é”®å€¼å¯¹çš„é”®å å¯¹äºæ¯ä¸ª keyï¼Œredis-trib éƒ½å‘æºèŠ‚ç‚¹å‘é€ä¸€ä¸ª MIGRATE &lt;target_ip&gt; &lt;target_port&gt; &lt;key_name&gt; 0 &lt;timeoutï¼ å‘½ä»¤ï¼Œå°†è¢«é€‰ä¸­çš„é”®åŸå­åœ°ä»æºèŠ‚ç‚¹è¿ç§»è‡³ç›®æ ‡èŠ‚ç‚¹ é‡å¤ä¸Šè¿°æ­¥éª¤ï¼Œç›´åˆ°æºèŠ‚ç‚¹ä¿å­˜çš„æ‰€æœ‰æ§½ slot çš„é”®å€¼å¯¹éƒ½è¢«è¿ç§»è‡³ç›®æ ‡èŠ‚ç‚¹ä¸ºæ­¢ redis-trib å‘é›†ç¾¤ä¸­çš„ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹å‘é€ CLUSTER SETSLOT &lt;slot&gt; NODE &lt;target _id&gt; å‘½ä»¤ï¼Œå°†æ§½ slot æŒ‡æ´¾ç»™ç›®æ ‡èŠ‚ç‚¹ï¼Œè¿™ä¸€æŒ‡æ´¾ä¿¡æ¯ä¼šé€šè¿‡æ¶ˆæ¯ä¼ æ’­è‡³æ•´ä¸ªé›†ç¾¤ï¼Œæœ€ç»ˆé›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½ç›´åˆ°æ§½ slot å·²ç»æŒ‡æ´¾ç»™äº†ç›®æ ‡èŠ‚ç‚¹ å¦‚æœé‡æ–°åˆ†ç‰‡æ¶‰åŠå¤šä¸ªæ§½ï¼Œé‚£ä¹ˆ redis-trib å°†å¯¹æ¯ä¸ªç»™å®šçš„æ§½åˆ†åˆ«æ‰§è¡Œä¸Šé¢ç»™å‡ºçš„æ­¥éª¤ å‘½ä»¤åŸç†clusterState ç»“æ„çš„ importing_slots_from æ•°ç»„è®°å½•äº†å½“å‰èŠ‚ç‚¹æ­£åœ¨ä»å…¶ä»–èŠ‚ç‚¹å¯¼å…¥çš„æ§½ï¼Œmigrating_slots_to æ•°ç»„è®°å½•äº†å½“å‰èŠ‚ç‚¹æ­£åœ¨è¿ç§»è‡³å…¶ä»–èŠ‚ç‚¹çš„æ§½ï¼š 12345678typedef struct clusterState &#123; // å¦‚æœ importing_slots_from[i] çš„å€¼ä¸ä¸º NULLï¼Œè€Œæ˜¯æŒ‡å‘ä¸€ä¸ª clusterNode ç»“æ„ï¼Œ // é‚£ä¹ˆè¡¨ç¤ºå½“å‰èŠ‚ç‚¹æ­£åœ¨ä» clusterNode æ‰€ä»£è¡¨çš„èŠ‚ç‚¹å¯¼å…¥æ§½ i clusterNode *importing_slots_from[16384]; // è¡¨ç¤ºå½“å‰èŠ‚ç‚¹æ­£åœ¨å°†æ§½ i è¿ç§»è‡³ clusterNode æ‰€ä»£è¡¨çš„èŠ‚ç‚¹ clusterNode *migrating_slots_to[16384];&#125; CLUSTER SETSLOT &lt;slot&gt; IMPORTING &lt;source_id&gt; å‘½ä»¤ï¼šå°†ç›®æ ‡èŠ‚ç‚¹ clusterState.importing_slots_from[slot] çš„å€¼è®¾ç½®ä¸º source_id æ‰€ä»£è¡¨èŠ‚ç‚¹çš„ clusterNode ç»“æ„ CLUSTER SETSLOT &lt;slot&gt; MIGRATING &lt;target_id&gt; å‘½ä»¤ï¼šå°†æºèŠ‚ç‚¹ clusterState.migrating_slots_to[slot] çš„å€¼è®¾ç½®ä¸ºtarget_id æ‰€ä»£è¡¨èŠ‚ç‚¹çš„ clusterNode ç»“æ„ ASK é”™è¯¯é‡æ–°åˆ†ç‰‡æœŸé—´ï¼ŒæºèŠ‚ç‚¹å‘ç›®æ ‡èŠ‚ç‚¹è¿ç§»ä¸€ä¸ªæ§½çš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½å‡ºç°è¢«è¿ç§»æ§½çš„ä¸€éƒ¨åˆ†é”®å€¼å¯¹ä¿å­˜åœ¨æºèŠ‚ç‚¹ï¼Œå¦ä¸€éƒ¨åˆ†ä¿å­˜åœ¨ç›®æ ‡èŠ‚ç‚¹ å®¢æˆ·ç«¯å‘æºèŠ‚ç‚¹å‘é€å‘½ä»¤è¯·æ±‚ï¼Œå¹¶ä¸”å‘½ä»¤è¦å¤„ç†çš„æ•°æ®åº“é”®å±äºè¢«è¿ç§»çš„æ§½ï¼š æºèŠ‚ç‚¹ä¼šå…ˆåœ¨æ•°æ®åº“é‡Œé¢æŸ¥æ‰¾æŒ‡å®šé”®ï¼Œå¦‚æœæ‰¾åˆ°çš„è¯ï¼Œå°±ç›´æ¥æ‰§è¡Œå®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤ æœªæ‰¾åˆ°ä¼šæ£€æŸ¥ clusterState.migrating_slots_to[slot]ï¼Œçœ‹é”® key æ‰€å±çš„æ§½ slot æ˜¯å¦æ­£åœ¨è¿›è¡Œè¿ç§» æ§½ slot æ­£åœ¨è¿ç§»åˆ™æºèŠ‚ç‚¹å°†å‘å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ª ASK é”™è¯¯ï¼ŒæŒ‡å¼•å®¢æˆ·ç«¯è½¬å‘æ­£åœ¨å¯¼å…¥æ§½çš„ç›®æ ‡èŠ‚ç‚¹ 1ASK &lt;slot&gt; &lt;ip:port&gt; æ¥åˆ° ASK é”™è¯¯çš„å®¢æˆ·ç«¯ï¼Œä¼šæ ¹æ®é”™è¯¯æä¾›çš„ IP åœ°å€å’Œç«¯å£å·è½¬å‘ç›®æ ‡èŠ‚ç‚¹ï¼Œé¦–å…ˆå‘ç›®æ ‡èŠ‚ç‚¹å‘é€ä¸€ä¸ª ASKING å‘½ä»¤ï¼Œå†é‡æ–°å‘é€åŸæœ¬æƒ³è¦æ‰§è¡Œçš„å‘½ä»¤ å’Œ MOVED é”™è¯¯æƒ…å†µç±»ä¼¼ï¼Œé›†ç¾¤æ¨¡å¼çš„ redis-cli åœ¨æ¥åˆ° ASK é”™è¯¯æ—¶ä¸ä¼šæ‰“å°é”™è¯¯è¿›è¡Œè‡ªåŠ¨è½¬å‘ï¼›å•æœºæ¨¡å¼çš„ redis-cli ä¼šæ‰“å°é”™è¯¯ å¯¹æ¯” MOVED é”™è¯¯ï¼š MOVED é”™è¯¯ä»£è¡¨æ§½çš„è´Ÿè´£æƒå·²ç»ä»ä¸€ä¸ªèŠ‚ç‚¹è½¬ç§»åˆ°äº†å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè½¬å‘æ˜¯ä¸€ç§æŒä¹…æ€§çš„è½¬å‘ ASK é”™è¯¯åªæ˜¯ä¸¤ä¸ªèŠ‚ç‚¹åœ¨è¿ç§»æ§½çš„è¿‡ç¨‹ä¸­ä½¿ç”¨çš„ä¸€ç§ä¸´æ—¶æªæ–½ï¼ŒASK çš„è½¬å‘ä¸ä¼šå¯¹å®¢æˆ·ç«¯ä»Šåå‘é€å…³äºæ§½ slot çš„å‘½ä»¤è¯·æ±‚äº§ç”Ÿä»»ä½•å½±å“ï¼Œå®¢æˆ·ç«¯ä»ç„¶ä¼šå°†æ§½ slot çš„å‘½ä»¤è¯·æ±‚å‘é€è‡³ç›®å‰è´Ÿè´£å¤„ç†æ§½ slot çš„èŠ‚ç‚¹ï¼Œé™¤é ASK é”™è¯¯å†æ¬¡å‡ºç° ASKINGå®¢æˆ·ç«¯ä¸å‘é€ ASKING å‘½ä»¤ï¼Œè€Œæ˜¯ç›´æ¥å‘é€æ‰§è¡Œçš„å‘½ä»¤ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤å°†è¢«èŠ‚ç‚¹æ‹’ç»æ‰§è¡Œï¼Œå¹¶è¿”å› MOVED é”™è¯¯ ASKING å‘½ä»¤ä½œç”¨æ˜¯æ‰“å¼€å‘é€è¯¥å‘½ä»¤çš„å®¢æˆ·ç«¯çš„ REDIS_ASKING æ ‡è¯†ï¼Œè¯¥å‘½ä»¤çš„ä¼ªä»£ç å®ç°ï¼š 12345def ASKING (): // æ‰“å¼€æ ‡è¯† client.flags |= REDIS_ASKING // å‘å®¢æˆ·ç«¯è¿”å›OKå›å¤ reply(&quot;OK&quot;) å½“å‰èŠ‚ç‚¹æ­£åœ¨å¯¼å…¥æ§½ slotï¼Œå¹¶ä¸”å‘é€å‘½ä»¤çš„å®¢æˆ·ç«¯å¸¦æœ‰ REDIS_ASKING æ ‡è¯†ï¼Œé‚£ä¹ˆèŠ‚ç‚¹å°†ç ´ä¾‹æ‰§è¡Œè¿™ä¸ªå…³äºæ§½ slot çš„å‘½ä»¤ä¸€æ¬¡ å®¢æˆ·ç«¯çš„ REDIS_ASKING æ ‡è¯†æ˜¯ä¸€æ¬¡æ€§æ ‡è¯†ï¼Œå½“èŠ‚ç‚¹æ‰§è¡Œäº†ä¸€ä¸ªå¸¦æœ‰ REDIS_ASKING æ ‡è¯†çš„å®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤ä¹‹åï¼Œè¯¥å®¢æˆ·ç«¯çš„ REDIS_ASKING æ ‡è¯†å°±ä¼šè¢«ç§»é™¤ é«˜å¯ç”¨èŠ‚ç‚¹å¤åˆ¶Redis é›†ç¾¤ä¸­çš„èŠ‚ç‚¹åˆ†ä¸ºä¸»èŠ‚ç‚¹ï¼ˆmasterï¼‰å’Œä»èŠ‚ç‚¹ï¼ˆslaveï¼‰ï¼Œå…¶ä¸­ä¸»èŠ‚ç‚¹ç”¨äºå¤„ç†æ§½ï¼Œè€Œä»èŠ‚ç‚¹åˆ™ç”¨äºå¤åˆ¶ä¸»èŠ‚ç‚¹ï¼Œå¹¶åœ¨è¢«å¤åˆ¶çš„ä¸»èŠ‚ç‚¹ä¸‹çº¿æ—¶ï¼Œä»£æ›¿ä¸‹çº¿ä¸»èŠ‚ç‚¹ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚ 1CLUSTER REPLICATE &lt;node_id&gt; å‘ä¸€ä¸ªèŠ‚ç‚¹å‘é€å‘½ä»¤å¯ä»¥è®©æ¥æ”¶å‘½ä»¤çš„èŠ‚ç‚¹æˆä¸º node_id æ‰€æŒ‡å®šèŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ï¼Œå¹¶å¼€å§‹å¯¹ä¸»èŠ‚ç‚¹è¿›è¡Œå¤åˆ¶ æ¥å—å‘½ä»¤çš„èŠ‚ç‚¹é¦–å…ˆä¼šåœ¨çš„ clusterState.nodes å­—å…¸ä¸­æ‰¾åˆ° node_id æ‰€å¯¹åº”èŠ‚ç‚¹çš„ clusterNode ç»“æ„ï¼Œå¹¶å°†è‡ªå·±çš„èŠ‚ç‚¹ä¸­çš„ clusterState.myself.slaveof æŒ‡é’ˆæŒ‡å‘è¿™ä¸ªç»“æ„ï¼Œè®°å½•è¿™ä¸ªèŠ‚ç‚¹æ­£åœ¨å¤åˆ¶çš„ä¸»èŠ‚ç‚¹ èŠ‚ç‚¹ä¼šä¿®æ”¹ clusterState.myself.flags ä¸­çš„å±æ€§ï¼Œå…³é—­ REDIS_NODE_MASTER æ ‡è¯†ï¼Œæ‰“å¼€ REDIS_NODE_SLAVE æ ‡è¯† èŠ‚ç‚¹ä¼šè°ƒç”¨å¤åˆ¶ä»£ç ï¼Œå¯¹ä¸»èŠ‚ç‚¹è¿›è¡Œå¤åˆ¶ï¼ˆèŠ‚ç‚¹çš„å¤åˆ¶åŠŸèƒ½å’Œå•æœº Redis æœåŠ¡å™¨çš„ä½¿ç”¨äº†ç›¸åŒçš„ä»£ç ï¼‰ ä¸€ä¸ªèŠ‚ç‚¹æˆä¸ºä»èŠ‚ç‚¹ï¼Œå¹¶å¼€å§‹å¤åˆ¶æŸä¸ªä¸»èŠ‚ç‚¹è¿™ä¸€ä¿¡æ¯ä¼šé€šè¿‡æ¶ˆæ¯å‘é€ç»™é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹ï¼Œæœ€ç»ˆé›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½ä¼šçŸ¥é“æŸä¸ªä»èŠ‚ç‚¹æ­£åœ¨å¤åˆ¶æŸä¸ªä¸»èŠ‚ç‚¹ ä¸»èŠ‚ç‚¹çš„ clusterNode ç»“æ„çš„ slaves å±æ€§å’Œ numslaves å±æ€§ä¸­è®°å½•æ­£åœ¨å¤åˆ¶è¿™ä¸ªä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹åå•ï¼š 1234567struct clusterNode &#123; // æ­£åœ¨å¤åˆ¶è¿™ä¸ªä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹æ•°é‡ int numslaves; // æ•°ç»„é¡¹æŒ‡å‘ä¸€ä¸ªæ­£åœ¨å¤åˆ¶è¿™ä¸ªä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹çš„clusterNodeç»“æ„ struct clusterNode **slaves; &#125; æ•…éšœæ£€æµ‹é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šå®šæœŸåœ°å‘é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹å‘é€ PING æ¶ˆæ¯ï¼Œæ¥æ£€æµ‹å¯¹æ–¹æ˜¯å¦åœ¨çº¿ï¼Œå¦‚æœæ¥æ”¶ PING çš„èŠ‚ç‚¹æ²¡æœ‰åœ¨è§„å®šçš„æ—¶é—´å†…è¿”å› PONG æ¶ˆæ¯ï¼Œé‚£ä¹ˆå‘é€æ¶ˆæ¯èŠ‚ç‚¹å°±ä¼šå°†æ¥æ”¶èŠ‚ç‚¹æ ‡è®°ä¸ºç–‘ä¼¼ä¸‹çº¿ï¼ˆprobable failï¼‰ é›†ç¾¤ä¸­çš„èŠ‚ç‚¹ä¼šäº’ç›¸å‘é€æ¶ˆæ¯ï¼Œæ¥äº¤æ¢é›†ç¾¤ä¸­å„ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ä¿¡æ¯ï¼Œå½“ä¸€ä¸ªä¸»èŠ‚ç‚¹ A é€šè¿‡æ¶ˆæ¯å¾—çŸ¥ä¸»èŠ‚ç‚¹ B è®¤ä¸ºä¸»èŠ‚ç‚¹ C è¿›å…¥äº†ç–‘ä¼¼ä¸‹çº¿çŠ¶æ€æ—¶ï¼Œä¸»èŠ‚ç‚¹ A ä¼šåœ¨ clusterState.nodes å­—å…¸ä¸­æ‰¾åˆ°ä¸»èŠ‚ç‚¹ C æ‰€å¯¹åº”çš„èŠ‚ç‚¹ï¼Œå¹¶å°†ä¸»èŠ‚ç‚¹ B çš„ä¸‹çº¿æŠ¥å‘Šï¼ˆfailure reportï¼‰æ·»åŠ åˆ° clusterNode.fail_reports é“¾è¡¨é‡Œé¢ 12345678910111213struct clusterNode &#123; // ä¸€ä¸ªé“¾è¡¨ï¼Œè®°å½•äº†æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹å¯¹è¯¥èŠ‚ç‚¹çš„ä¸‹çº¿æŠ¥å‘Š list *fail_reports;&#125;// æ¯ä¸ªä¸‹çº¿æŠ¥å‘Šç”±ä¸€ä¸ª clusterNodeFailReport ç»“æ„è¡¨ç¤ºstruct clusterNodeFailReport &#123; // æŠ¥å‘Šç›®æ ‡èŠ‚ç‚¹å·³ç»ä¸‹çº¿çš„èŠ‚ç‚¹ struct clusterNode *node; // æœ€åä¸€æ¬¡ä»nodeèŠ‚ç‚¹æ”¶åˆ°ä¸‹çº¿æŠ¥å‘Šçš„æ—¶é—´ // ç¨‹åºä½¿ç”¨è¿™ä¸ªæ—¶é—´æˆ³æ¥æ£€æŸ¥ä¸‹çº¿æŠ¥å‘Šæ˜¯å¦è¿‡æœŸï¼Œä¸å½“å‰æ—¶é—´ç›¸å·®å¤ªä¹…çš„ä¸‹çº¿æŠ¥å‘Šä¼šè¢«åˆ é™¤ mstime_t time; &#125;; é›†ç¾¤é‡ŒåŠæ•°ä»¥ä¸Šè´Ÿè´£å¤„ç†æ§½çš„ä¸»èŠ‚ç‚¹éƒ½å°†æŸä¸ªä¸»èŠ‚ç‚¹ X æŠ¥å‘Šä¸ºç–‘ä¼¼ä¸‹çº¿ï¼Œé‚£ä¹ˆ X å°†è¢«æ ‡è®°ä¸ºå·²ä¸‹çº¿ï¼ˆFAILï¼‰ï¼Œå°† X æ ‡è®°ä¸ºå·²ä¸‹çº¿çš„èŠ‚ç‚¹ä¼šå‘é›†ç¾¤å¹¿æ’­ä¸€æ¡å…³äºä¸»èŠ‚ç‚¹ X çš„ FAIL æ¶ˆæ¯ï¼Œæ‰€æœ‰æ”¶åˆ°æ¶ˆæ¯çš„èŠ‚ç‚¹éƒ½ä¼šå°† X æ ‡è®°ä¸ºå·²ä¸‹çº¿ æ•…éšœè½¬ç§»å½“ä¸€ä¸ªä»èŠ‚ç‚¹å‘ç°æ‰€å±çš„ä¸»èŠ‚ç‚¹è¿›å…¥äº†å·²ä¸‹çº¿çŠ¶æ€ï¼Œä»èŠ‚ç‚¹å°†å¼€å§‹å¯¹ä¸‹çº¿ä¸»èŠ‚ç‚¹è¿›è¡Œæ•…éšœè½¬ç§»ï¼Œæ‰§è¡Œæ­¥éª¤ï¼š ä¸‹å±çš„ä»èŠ‚ç‚¹é€šè¿‡é€‰ä¸¾äº§ç”Ÿä¸€ä¸ªèŠ‚ç‚¹ è¢«é€‰ä¸­çš„ä»èŠ‚ç‚¹ä¼šæ‰§è¡Œ SLAVEOF no one å‘½ä»¤ï¼Œæˆä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ æ–°çš„ä¸»èŠ‚ç‚¹ä¼šæ’¤é”€æ‰€æœ‰å¯¹å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹çš„æ§½æŒ‡æ´¾ï¼Œå¹¶å°†è¿™äº›æ§½å…¨éƒ¨æŒ‡æ´¾ç»™è‡ªå·± æ–°çš„ä¸»èŠ‚ç‚¹å‘é›†ç¾¤å¹¿æ’­ä¸€æ¡ PONG æ¶ˆæ¯ï¼Œè®©é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹çŸ¥é“å½“å‰èŠ‚ç‚¹å˜æˆäº†ä¸»èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ¥ç®¡äº†ä¸‹çº¿èŠ‚ç‚¹è´Ÿè´£å¤„ç†çš„æ§½ æ–°çš„ä¸»èŠ‚ç‚¹å¼€å§‹æ¥æ”¶æœ‰å…³çš„å‘½ä»¤è¯·æ±‚ï¼Œæ•…éšœè½¬ç§»å®Œæˆ é€‰ä¸¾ç®—æ³•é›†ç¾¤é€‰ä¸¾æ–°çš„ä¸»èŠ‚ç‚¹çš„è§„åˆ™ï¼š é›†ç¾¤çš„é…ç½®çºªå…ƒæ˜¯ä¸€ä¸ªè‡ªå¢çš„è®¡æ•°å™¨ï¼Œåˆå§‹å€¼ä¸º 0 å½“é›†ç¾¤é‡ŒæŸä¸ªèŠ‚ç‚¹å¼€å§‹ä¸€æ¬¡æ•…éšœè½¬ç§»ï¼Œé›†ç¾¤çš„é…ç½®çºªå…ƒå°±æ˜¯å¢åŠ ä¸€ æ¯ä¸ªé…ç½®çºªå…ƒé‡Œï¼Œé›†ç¾¤ä¸­æ¯ä¸ªä¸»èŠ‚ç‚¹éƒ½æœ‰ä¸€æ¬¡æŠ•ç¥¨çš„æœºä¼šï¼Œè€Œç¬¬ä¸€ä¸ªå‘ä¸»èŠ‚ç‚¹è¦æ±‚æŠ•ç¥¨çš„ä»èŠ‚ç‚¹å°†è·å¾—è¯¥ä¸»èŠ‚ç‚¹çš„æŠ•ç¥¨ å…·æœ‰æŠ•ç¥¨æƒçš„ä¸»èŠ‚ç‚¹æ˜¯å¿…é¡»å…·æœ‰æ­£åœ¨å¤„ç†çš„æ§½ é›†ç¾¤é‡Œæœ‰ N ä¸ªå…·æœ‰æŠ•ç¥¨æƒçš„ä¸»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå½“ä¸€ä¸ªä»èŠ‚ç‚¹æ”¶é›†åˆ°å¤§äºç­‰äº N/2+1 å¼ æ”¯æŒç¥¨æ—¶ï¼Œä»èŠ‚ç‚¹å°±ä¼šå½“é€‰ æ¯ä¸ªé…ç½®çºªå…ƒé‡Œï¼Œå…·æœ‰æŠ•ç¥¨æƒçš„ä¸»èŠ‚ç‚¹åªèƒ½æŠ•ä¸€æ¬¡ç¥¨ï¼Œæ‰€ä»¥è·å¾—ä¸€åŠä»¥ä¸Šç¥¨çš„èŠ‚ç‚¹åªä¼šæœ‰ä¸€ä¸ª é€‰ä¸¾æµç¨‹ï¼š å½“æŸä¸ªä»èŠ‚ç‚¹å‘ç°æ­£åœ¨å¤åˆ¶çš„ä¸»èŠ‚ç‚¹è¿›å…¥å·²ä¸‹çº¿çŠ¶æ€æ—¶ï¼Œä¼šå‘é›†ç¾¤å¹¿æ’­ä¸€æ¡ CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUEST æ¶ˆæ¯ï¼Œè¦æ±‚æ‰€æœ‰æ”¶åˆ°è¿™æ¡æ¶ˆæ¯ã€å¹¶ä¸”å…·æœ‰æŠ•ç¥¨æƒçš„ä¸»èŠ‚ç‚¹å‘è¿™ä¸ªä»èŠ‚ç‚¹æŠ•ç¥¨ å¦‚æœä¸»èŠ‚ç‚¹å°šæœªæŠ•ç¥¨ç»™å…¶ä»–ä»èŠ‚ç‚¹ï¼Œå°†å‘è¦æ±‚æŠ•ç¥¨çš„ä»èŠ‚ç‚¹è¿”å›ä¸€æ¡ CLUSTERMSG_TYPE_FAILOVER_AUTH_ACK æ¶ˆæ¯ï¼Œè¡¨ç¤ºè¿™ä¸ªä¸»èŠ‚ç‚¹æ”¯æŒä»èŠ‚ç‚¹æˆä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ å¦‚æœä»èŠ‚ç‚¹è·å–åˆ°äº†åŠæ•°ä»¥ä¸Šçš„é€‰ç¥¨ï¼Œåˆ™ä¼šå½“é€‰æ–°çš„ä¸»èŠ‚ç‚¹ å¦‚æœä¸€ä¸ªé…ç½®çºªå…ƒé‡Œæ²¡æœ‰ä»èŠ‚ç‚¹èƒ½æ”¶é›†åˆ°è¶³å¤Ÿå¤šçš„æ”¯å¾…ç¥¨ï¼Œé‚£ä¹ˆé›†ç¾¤è¿›å…¥ä¸€ä¸ªæ–°çš„é…ç½®çºªå…ƒï¼Œå¹¶å†æ¬¡è¿›è¡Œé€‰ä¸¾ï¼Œç›´åˆ°é€‰å‡ºæ–°çš„ä¸»èŠ‚ç‚¹ é€‰ä¸¾æ–°ä¸»èŠ‚ç‚¹çš„æ–¹æ³•å’Œé€‰ä¸¾é¢†å¤´ Sentinel çš„æ–¹æ³•éå¸¸ç›¸ä¼¼ï¼Œä¸¤è€…éƒ½æ˜¯åŸºäº Raft ç®—æ³•çš„é¢†å¤´é€‰ä¸¾ï¼ˆleader electionï¼‰æ–¹æ³•å®ç°çš„ æ¶ˆæ¯æœºåˆ¶æ¶ˆæ¯ç»“æ„é›†ç¾¤ä¸­çš„å„ä¸ªèŠ‚ç‚¹é€šè¿‡å‘é€å’Œæ¥æ”¶æ¶ˆæ¯ï¼ˆmessageï¼‰æ¥è¿›è¡Œé€šä¿¡ï¼Œå°†å‘é€æ¶ˆæ¯çš„èŠ‚ç‚¹ç§°ä¸ºå‘é€è€…ï¼ˆsenderï¼‰ï¼Œæ¥æ”¶æ¶ˆæ¯çš„èŠ‚ç‚¹ç§°ä¸ºæ¥æ”¶è€…ï¼ˆreceiverï¼‰ èŠ‚ç‚¹å‘é€çš„æ¶ˆæ¯ä¸»è¦æœ‰ï¼š MEET æ¶ˆæ¯ï¼šå½“å‘é€è€…æ¥åˆ°å®¢æˆ·ç«¯å‘é€çš„ CLUSTER MEET å‘½ä»¤æ—¶ï¼Œä¼šå‘æ¥æ”¶è€…å‘é€ MEET æ¶ˆæ¯ï¼Œè¯·æ±‚æ¥æ”¶è€…åŠ å…¥åˆ°å‘é€è€…å½“å‰æ‰€å¤„çš„é›†ç¾¤é‡Œ PING æ¶ˆæ¯ï¼šé›†ç¾¤é‡Œçš„æ¯ä¸ªèŠ‚ç‚¹é»˜è®¤æ¯éš”ä¸€ç§’é’Ÿå°±ä¼šä»å·²çŸ¥èŠ‚ç‚¹åˆ—è¡¨ä¸­éšæœºé€‰å‡ºäº”ä¸ªï¼Œç„¶åå¯¹è¿™äº”ä¸ªèŠ‚ç‚¹ä¸­æœ€é•¿æ—¶é—´æ²¡æœ‰å‘é€è¿‡ PING æ¶ˆæ¯çš„èŠ‚ç‚¹å‘é€ PINGï¼Œä»¥æ­¤æ¥éšæœºæ£€æµ‹è¢«é€‰ä¸­çš„èŠ‚ç‚¹æ˜¯å¦åœ¨çº¿ å¦‚æœèŠ‚ç‚¹ A æœ€åä¸€æ¬¡æ”¶åˆ°èŠ‚ç‚¹ B å‘é€çš„ PONG æ¶ˆæ¯çš„æ—¶é—´ï¼Œè·ç¦»å½“å‰å·²ç»è¶…è¿‡äº†èŠ‚ç‚¹ A çš„ cluster-nodeÂ­-timeout è®¾ç½®æ—¶é•¿çš„ä¸€åŠï¼Œé‚£ä¹ˆ A ä¹Ÿä¼šå‘ B å‘é€ PING æ¶ˆæ¯ï¼Œé˜²æ­¢ A å› ä¸ºé•¿æ—¶é—´æ²¡æœ‰éšæœºé€‰ä¸­ B å‘é€ PINGï¼Œè€Œå¯¼è‡´å¯¹èŠ‚ç‚¹ B çš„ä¿¡æ¯æ›´æ–°æ»å PONG æ¶ˆæ¯ï¼šå½“æ¥æ”¶è€…æ”¶åˆ° MEET æ¶ˆæ¯æˆ–è€… PING æ¶ˆæ¯æ—¶ï¼Œä¸ºäº†è®©å‘é€è€…ç¡®è®¤å·²ç»æˆåŠŸæ¥æ”¶æ¶ˆæ¯ï¼Œä¼šå‘å‘é€è€…è¿”å›ä¸€æ¡ PONGï¼›èŠ‚ç‚¹ä¹Ÿå¯ä»¥é€šè¿‡å‘é›†ç¾¤å¹¿æ’­ PONG æ¶ˆæ¯æ¥è®©é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹ç«‹å³åˆ·æ–°å…³äºè¿™ä¸ªèŠ‚ç‚¹çš„è®¤è¯†ï¼ˆä»å‡çº§ä¸ºä¸»ï¼‰ FAIL æ¶ˆæ¯ï¼šå½“ä¸€ä¸ªä¸»èŠ‚ç‚¹ A åˆ¤æ–­å¦ä¸€ä¸ªä¸»èŠ‚ç‚¹ B å·²ç»è¿›å…¥ FAIL çŠ¶æ€æ—¶ï¼ŒèŠ‚ç‚¹ A ä¼šå‘é›†ç¾¤å¹¿æ’­ä¸€æ¡ B èŠ‚ç‚¹çš„ FAIL ä¿¡æ¯ PUBLISH æ¶ˆæ¯ï¼šå½“èŠ‚ç‚¹æ¥æ”¶åˆ°ä¸€ä¸ª PUBLISH å‘½ä»¤æ—¶ï¼ŒèŠ‚ç‚¹ä¼šæ‰§è¡Œè¿™ä¸ªå‘½ä»¤å¹¶å‘é›†ç¾¤å¹¿æ’­ä¸€æ¡ PUBLISH æ¶ˆæ¯ï¼Œæ¥æ”¶åˆ° PUBLISH æ¶ˆæ¯çš„èŠ‚ç‚¹éƒ½ä¼šæ‰§è¡Œç›¸åŒçš„ PUBLISH å‘½ä»¤ æ¶ˆæ¯å¤´èŠ‚ç‚¹å‘é€çš„æ‰€æœ‰æ¶ˆæ¯éƒ½ç”±ä¸€ä¸ªæ¶ˆæ¯å¤´åŒ…è£¹ï¼Œæ¶ˆæ¯å¤´é™¤äº†åŒ…å«æ¶ˆæ¯æ­£æ–‡ä¹‹å¤–ï¼Œè¿˜è®°å½•äº†æ¶ˆæ¯å‘é€è€…è‡ªèº«çš„ä¸€äº›ä¿¡æ¯ æ¶ˆæ¯å¤´ï¼š 1234567891011121314151617181920212223242526272829303132typedef struct clusterMsg &#123; // æ¶ˆæ¯çš„é•¿åº¦ï¼ˆåŒ…æ‹¬è¿™ä¸ªæ¶ˆæ¯å¤´çš„é•¿åº¦å’Œæ¶ˆæ¯æ­£æ–‡çš„é•¿åº¦ï¼‰ uint32_t totlen; // æ¶ˆæ¯çš„ç±»å‹ uint16_t type; // æ¶ˆæ¯æ­£æ–‡åŒ…å«çš„èŠ‚ç‚¹ä¿¡æ¯æ•°é‡ï¼Œåªåœ¨å‘é€MEETã€PINGã€PONGè¿™ä¸‰ç§Gossipåè®®æ¶ˆæ¯æ—¶ä½¿ç”¨ uint16_t count; // å‘é€è€…æ‰€å¤„çš„é…ç½®çºªå…ƒ uint64_t currentEpoch; // å¦‚æœå‘é€è€…æ˜¯ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™é‡Œè®°å½•çš„æ˜¯å‘é€è€…çš„é…ç½®çºªå…ƒ // å¦‚æœå‘é€è€…æ˜¯ä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™é‡Œè®°å½•çš„æ˜¯å‘é€è€…æ­£åœ¨å¤åˆ¶çš„ä¸»èŠ‚ç‚¹çš„é…ç½®çºªå…ƒ uint64_t configEpoch; // å‘é€è€…çš„åå­—(ID) char sender[REDIS CLUSTER NAMELEN]; // å‘é€è€…ç›®å‰çš„æ§½æŒ‡æ´¾ä¿¡æ¯ unsigned char myslots[REDIS_CLUSTER_SLOTS/8]; // å¦‚æœå‘é€è€…æ˜¯ä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™é‡Œè®°å½•çš„æ˜¯å‘é€è€…æ­£åœ¨å¤åˆ¶çš„ä¸»èŠ‚ç‚¹çš„åå­— // å¦‚æœå‘é€è€…æ˜¯ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™é‡Œè®°å½•çš„æ˜¯ REDIS_NODE_NULL_NAMEï¼Œä¸€ä¸ª 40 å®‡èŠ‚é•¿å€¼å…¨ä¸º 0 çš„å­—èŠ‚æ•°ç»„ char slaveof[REDIS_CLUSTER_NAMELEN]; // å‘é€è€…çš„ç«¯å£å· uint16_t port; // å‘é€è€…çš„æ ‡è¯†å€¼ uint16_t flags; //å‘é€è€…æ‰€å¤„é›†ç¾¤çš„çŠ¶æ€ unsigned char state; // æ¶ˆæ¯çš„æ­£æ–‡ï¼ˆæˆ–è€…è¯´ï¼Œ å†…å®¹ï¼‰ union clusterMsgData data;&#125; clusterMsg ç»“æ„çš„ currentEpochã€senderã€myslots ç­‰å±æ€§è®°å½•äº†å‘é€è€…çš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œæ¥æ”¶è€…ä¼šæ ¹æ®è¿™äº›ä¿¡æ¯åœ¨ clusterState.nodes å­—å…¸é‡Œæ‰¾åˆ°å‘é€è€…å¯¹åº”çš„ clusterNode ç»“æ„ï¼Œå¹¶å¯¹ç»“æ„è¿›è¡Œæ›´æ–°ï¼Œæ¯”å¦‚ä¼ æ’­èŠ‚ç‚¹çš„æ§½æŒ‡æ´¾ä¿¡æ¯ æ¶ˆæ¯æ­£æ–‡ï¼š 12345678910111213141516171819union clusterMsgData &#123; // MEETã€PINGã€PONG æ¶ˆæ¯çš„æ­£æ–‡ struct &#123; // æ¯æ¡ MEETã€PINGã€PONG æ¶ˆæ¯éƒ½åŒ…å«ä¸¤ä¸ª clusterMsgDataGossip ç»“æ„ clusterMsgDataGossip gossip[1]; &#125; ping; // FAIL æ¶ˆæ¯çš„æ­£æ–‡ struct &#123; clusterMsgDataFail about; &#125; fail; // PUBLISH æ¶ˆæ¯çš„æ­£æ–‡ struct &#123; clusterMsgDataPublish msg; &#125; publish; // å…¶ä»–æ¶ˆæ¯æ­£æ–‡...&#125; GossipRedis é›†ç¾¤ä¸­çš„å„ä¸ªèŠ‚ç‚¹é€šè¿‡ Gossip åè®®æ¥äº¤æ¢å„è‡ªå…³äºä¸åŒèŠ‚ç‚¹çš„çŠ¶æ€ä¿¡æ¯ï¼Œå…¶ä¸­ Gossip åè®®ç”± MEETã€PINGã€PONG æ¶ˆæ¯å®ç°ï¼Œä¸‰ç§æ¶ˆæ¯ä½¿ç”¨ç›¸åŒçš„æ¶ˆæ¯æ­£æ–‡ï¼Œæ‰€ä»¥èŠ‚ç‚¹é€šè¿‡æ¶ˆæ¯å¤´çš„ type å±æ€§æ¥åˆ¤æ–­æ¶ˆæ¯çš„å…·ä½“ç±»å‹ å‘é€è€…å‘é€è¿™ä¸‰ç§æ¶ˆæ¯æ—¶ï¼Œä¼šä»å·²çŸ¥èŠ‚ç‚¹åˆ—è¡¨ä¸­éšæœºé€‰å‡ºä¸¤ä¸ªèŠ‚ç‚¹ï¼ˆä¸»ä»éƒ½å¯ä»¥ï¼‰ï¼Œå°†ä¸¤ä¸ªè¢«é€‰ä¸­èŠ‚ç‚¹ä¿¡æ¯ä¿å­˜åˆ°ä¸¤ä¸ª Gossip ç»“æ„ 12345678910111213141516typedef struct clusterMsgDataGossip &#123; // èŠ‚ç‚¹çš„åå­— char nodename[REDIS CLUSTER NAMELEN]; // æœ€åä¸€æ¬¡å‘è¯¥èŠ‚ç‚¹å‘é€PINGæ¶ˆæ¯çš„æ—¶é—´æˆ³ uint32_t ping_sent; // æœ€åä¸€æ¬¡ä»è¯¥èŠ‚ç‚¹æ¥æ”¶åˆ°PONGæ¶ˆæ¯çš„æ—¶é—´æˆ³ uint32_t pong_received; // èŠ‚ç‚¹çš„IPåœ°å€ char ip[16]; // èŠ‚ç‚¹çš„ç«¯å£å· uint16_t port; // èŠ‚ç‚¹çš„æ ‡è¯†å€¼ uint16_t flags;&#125; å½“æ¥æ”¶è€…æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œä¼šè®¿é—®æ¶ˆæ¯æ­£æ–‡ä¸­çš„ä¸¤ä¸ªæ•°æ®ç»“æ„ï¼Œæ¥è¿›è¡Œç›¸å…³æ“ä½œ å¦‚æœè¢«é€‰ä¸­èŠ‚ç‚¹ä¸å­˜åœ¨äºæ¥æ”¶è€…çš„å·²çŸ¥èŠ‚ç‚¹åˆ—è¡¨ï¼Œæ¥æ”¶è€…å°†æ ¹æ®ç»“æ„ä¸­è®°å½•çš„ IP åœ°å€å’Œç«¯å£å·ï¼Œä¸èŠ‚ç‚¹è¿›è¡Œæ¡æ‰‹ å¦‚æœå­˜åœ¨ï¼Œæ ¹æ® Gossip ç»“æ„è®°å½•çš„ä¿¡æ¯å¯¹èŠ‚ç‚¹æ‰€å¯¹åº”çš„ clusterNode ç»“æ„è¿›è¡Œæ›´æ–° FAILåœ¨é›†ç¾¤çš„èŠ‚ç‚¹æ•°é‡æ¯”è¾ƒå¤§çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ Gossip åè®®æ¥ä¼ æ’­èŠ‚ç‚¹çš„å·²ä¸‹çº¿ä¿¡æ¯ä¼šå¸¦æ¥ä¸€å®šå»¶è¿Ÿï¼Œå› ä¸º Gossip åè®®æ¶ˆæ¯é€šå¸¸éœ€è¦ä¸€æ®µæ—¶é—´æ‰èƒ½ä¼ æ’­è‡³æ•´ä¸ªé›†ç¾¤ï¼Œæ‰€ä»¥é€šè¿‡å‘é€ FAILæ¶ˆæ¯å¯ä»¥è®©é›†ç¾¤é‡Œçš„æ‰€æœ‰èŠ‚ç‚¹ç«‹å³çŸ¥é“æŸä¸ªä¸»èŠ‚ç‚¹å·²ä¸‹çº¿ï¼Œä»è€Œå°½å¿«è¿›è¡Œå…¶ä»–æ“ä½œ FAIL æ¶ˆæ¯çš„æ­£æ–‡ç”± clusterMsgDataFail ç»“æ„è¡¨ç¤ºï¼Œè¯¥ç»“æ„åªæœ‰ä¸€ä¸ªå±æ€§ï¼Œè®°å½•äº†å·²ä¸‹çº¿èŠ‚ç‚¹çš„åå­— 123typedef struct clusterMsgDataFail &#123; char nodename[REDIS_CLUSTER_NAMELEN)];&#125;; å› ä¸ºä¼ æ’­ä¸‹çº¿ä¿¡æ¯ä¸éœ€è¦å…¶ä»–å±æ€§ï¼Œæ‰€ä»¥èŠ‚çœäº†ä¼ æ’­çš„èµ„æº PUBLISHå½“å®¢æˆ·ç«¯å‘é›†ç¾¤ä¸­çš„æŸä¸ªèŠ‚ç‚¹å‘é€å‘½ä»¤ï¼Œæ¥æ”¶åˆ° PUBLISH å‘½ä»¤çš„èŠ‚ç‚¹ä¸ä»…ä¼šå‘ channel é¢‘é“å‘é€æ¶ˆæ¯ messageï¼Œè¿˜ä¼šå‘é›†ç¾¤å¹¿æ’­ä¸€æ¡ PUBLISH æ¶ˆæ¯ï¼Œæ‰€æœ‰æ¥æ”¶åˆ°è¿™æ¡ PUBLISH æ¶ˆæ¯çš„èŠ‚ç‚¹éƒ½ä¼šå‘ channel é¢‘é“å‘é€ message æ¶ˆæ¯ï¼Œæœ€ç»ˆé›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹éƒ½å‘äº† 1PUBLISH &lt;channel&gt; &lt;message&gt; PUBLISH æ¶ˆæ¯çš„æ­£æ–‡ç”± clusterMsgDataPublish ç»“æ„è¡¨ç¤ºï¼š 1234567891011typedef struct clusterMsgDataPublish &#123; // channelå‚æ•°çš„é•¿åº¦ uint32_t channel_len; // messageå‚æ•°çš„é•¿åº¦ uint32_t message_len; // å®šä¹‰ä¸º8å­—èŠ‚åªæ˜¯ä¸ºäº†å¯¹é½å…¶ä»–æ¶ˆæ¯ç»“æ„ï¼Œå®é™…çš„é•¿åº¦ç”±ä¿å­˜çš„å†…å®¹å†³å®š // bulk_data çš„ 0 è‡³ channel_len-1 å­—èŠ‚ä¿å­˜çš„æ˜¯channelå‚æ•° // bulk_dataçš„ channel_len å­—èŠ‚è‡³ channel_len + message_len-1 å­—èŠ‚ä¿å­˜çš„åˆ™æ˜¯messageå‚æ•° unsigned char bulk_data[8];&#125; è®©é›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œç›¸åŒçš„ PUBLISH å‘½ä»¤ï¼Œæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯å‘æ‰€æœ‰èŠ‚ç‚¹å¹¿æ’­ç›¸åŒçš„ PUBLISH å‘½ä»¤ï¼Œè¿™ä¹Ÿæ˜¯ Redis å¤åˆ¶ PUBLISH å‘½ä»¤æ—¶æ‰€ä½¿ç”¨çš„ï¼Œä½†æ˜¯è¿™ç§åšæ³•å¹¶ä¸ç¬¦åˆ Redis é›†ç¾¤çš„å„ä¸ªèŠ‚ç‚¹é€šè¿‡å‘é€å’Œæ¥æ”¶æ¶ˆæ¯æ¥è¿›è¡Œé€šä¿¡çš„è§„åˆ™ è„‘è£‚é—®é¢˜è„‘è£‚æŒ‡åœ¨ä¸»ä»é›†ç¾¤ä¸­ï¼ŒåŒæ—¶æœ‰ä¸¤ä¸ªç›¸åŒçš„ä¸»èŠ‚ç‚¹èƒ½æ¥æ”¶å†™è¯·æ±‚ï¼Œå¯¼è‡´å®¢æˆ·ç«¯ä¸çŸ¥é“åº”è¯¥å¾€å“ªä¸ªä¸»èŠ‚ç‚¹å†™å…¥æ•°æ®ï¼Œæœ€å ä¸åŒå®¢æˆ·ç«¯å¾€ä¸åŒçš„ä¸»èŠ‚ç‚¹ä¸Šå†™å…¥æ•°æ® åŸä¸»èŠ‚ç‚¹å¹¶æ²¡æœ‰çœŸçš„å‘ç”Ÿæ•…éšœï¼Œç”±äºæŸäº›åŸå› æ— æ³•å¤„ç†è¯·æ±‚ï¼ˆCPU åˆ©ç”¨ç‡å¾ˆé«˜ã€è‡ªèº«é˜»å¡ï¼‰ï¼Œæ— æ³•æŒ‰æ—¶å“åº”å¿ƒè·³è¯·æ±‚ï¼Œè¢«å“¨å…µ&#x2F;é›†ç¾¤ä¸»èŠ‚ç‚¹é”™è¯¯çš„åˆ¤æ–­ä¸ºä¸‹çº¿ åœ¨è¢«åˆ¤æ–­ä¸‹çº¿ä¹‹åï¼ŒåŸä¸»åº“åˆé‡æ–°å¼€å§‹å¤„ç†è¯·æ±‚äº†ï¼Œå“¨å…µ&#x2F;é›†ç¾¤ä¸»èŠ‚ç‚¹è¿˜æ²¡æœ‰å®Œæˆä¸»ä»åˆ‡æ¢ï¼Œå®¢æˆ·ç«¯ä»ç„¶å¯ä»¥å’ŒåŸä¸»åº“é€šä¿¡ï¼Œå®¢æˆ·ç«¯å‘é€çš„å†™æ“ä½œå°±ä¼šåœ¨åŸä¸»åº“ä¸Šå†™å…¥æ•°æ®ï¼Œé€ æˆè„‘è£‚é—®é¢˜ æ•°æ®ä¸¢å¤±é—®é¢˜ï¼šä»åº“ä¸€æ—¦å‡çº§ä¸ºæ–°ä¸»åº“ï¼Œå“¨å…µå°±ä¼šè®©åŸä¸»åº“æ‰§è¡Œ slave of å‘½ä»¤ï¼Œå’Œæ–°ä¸»åº“é‡æ–°è¿›è¡Œå…¨é‡åŒæ­¥ï¼ŒåŸä¸»åº“éœ€è¦æ¸…ç©ºæœ¬åœ°çš„æ•°æ®ï¼ŒåŠ è½½æ–°ä¸»åº“å‘é€çš„ RDB æ–‡ä»¶ï¼Œæ‰€ä»¥åŸä¸»åº“åœ¨ä¸»ä»åˆ‡æ¢æœŸé—´ä¿å­˜çš„æ–°å†™æ•°æ®å°±ä¸¢å¤±äº† é¢„é˜²è„‘è£‚ï¼šåœ¨ä¸»ä»é›†ç¾¤éƒ¨ç½²æ—¶ï¼Œåˆç†åœ°é…ç½®å‚æ•° min-slaves-to-write å’Œ min-slaves-max-lag å‡è®¾ä»åº“æœ‰ K ä¸ªï¼Œå¯ä»¥å°† min-slaves-to-write è®¾ç½®ä¸º K&#x2F;2+1ï¼ˆå¦‚æœ K ç­‰äº 1ï¼Œå°±è®¾ä¸º 1ï¼‰ å°† min-slaves-max-lag è®¾ç½®ä¸ºåå‡ ç§’ï¼ˆä¾‹å¦‚ 10ï½20sï¼‰ åœ¨å‡æ•…éšœæœŸé—´æ— æ³•å“åº”å“¨å…µå‘å‡ºçš„å¿ƒè·³æµ‹è¯•ï¼Œæ— æ³•å’Œä»åº“è¿›è¡Œ ACK ç¡®è®¤ï¼Œå¹¶ä¸”æ²¡æœ‰è¶³å¤Ÿçš„ä»åº“ï¼Œæ‹’ç»å®¢æˆ·ç«¯çš„å†™å…¥ ç»“æ„æ­å»ºæ•´ä½“æ¡†æ¶ï¼š é…ç½®æœåŠ¡å™¨ï¼ˆ3 ä¸» 3 ä»ï¼‰ å»ºç«‹é€šä¿¡ï¼ˆMeetï¼‰ åˆ†æ§½ï¼ˆSlotï¼‰ æ­å»ºä¸»ä»ï¼ˆmaster-slaveï¼‰ åˆ›å»ºé›†ç¾¤ conf é…ç½®æ–‡ä»¶ï¼š redis-6501.conf 12345678port 6501dir &quot;/redis/data&quot;dbfilename &quot;dump-6501.rdb&quot;cluster-enabled yescluster-config-file &quot;cluster-6501.conf&quot;cluster-node-timeout 5000#å…¶ä»–é…ç½®æ–‡ä»¶å‚ç…§ä¸Šé¢çš„ä¿®æ”¹ç«¯å£å³å¯ï¼Œå†…å®¹å®Œå…¨ä¸€æ · æœåŠ¡ç«¯å¯åŠ¨ï¼š 1redis-server config_file_name å®¢æˆ·ç«¯å¯åŠ¨ï¼š 1redis-cli -p 6504 -c cluster é…ç½®ï¼š æ˜¯å¦å¯ç”¨ clusterï¼ŒåŠ å…¥ cluster èŠ‚ç‚¹ 1cluster-enabled yes|no cluster é…ç½®æ–‡ä»¶åï¼Œè¯¥æ–‡ä»¶å±äºè‡ªåŠ¨ç”Ÿæˆï¼Œä»…ç”¨äºå¿«é€ŸæŸ¥æ‰¾æ–‡ä»¶å¹¶æŸ¥è¯¢æ–‡ä»¶å†…å®¹ 1cluster-config-file filename èŠ‚ç‚¹æœåŠ¡å“åº”è¶…æ—¶æ—¶é—´ï¼Œç”¨äºåˆ¤å®šè¯¥èŠ‚ç‚¹æ˜¯å¦ä¸‹çº¿æˆ–åˆ‡æ¢ä¸ºä»èŠ‚ç‚¹ 1cluster-node-timeout milliseconds master è¿æ¥çš„ slave æœ€å°æ•°é‡ 1cluster-migration-barrier min_slave_number å®¢æˆ·ç«¯å¯åŠ¨å‘½ä»¤ï¼š cluster èŠ‚ç‚¹æ“ä½œå‘½ä»¤ï¼ˆå®¢æˆ·ç«¯å‘½ä»¤ï¼‰ï¼š æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯ 1cluster nodes æ›´æ”¹ slave æŒ‡å‘æ–°çš„ master 1cluster replicate master-id å‘ç°ä¸€ä¸ªæ–°èŠ‚ç‚¹ï¼Œæ–°å¢ master 1cluster meet ip:port å¿½ç•¥ä¸€ä¸ªæ²¡æœ‰ solt çš„èŠ‚ç‚¹ 1cluster forget server_id æ‰‹åŠ¨æ•…éšœè½¬ç§» 1cluster failover é›†ç¾¤æ“ä½œå‘½ä»¤ï¼ˆLinuxï¼‰ï¼š åˆ›å»ºé›†ç¾¤ 1redis-cli â€“-cluster create masterhost1:masterport1 masterhost2:masterport2 masterhost3:masterport3 [masterhostn:masterportn â€¦] slavehost1:slaveport1 slavehost2:slaveport2 slavehost3:slaveport3 -â€“cluster-replicas n æ³¨æ„ï¼šmaster ä¸ slave çš„æ•°é‡è¦åŒ¹é…ï¼Œä¸€ä¸ª master å¯¹åº” n ä¸ª slaveï¼Œç”±æœ€åçš„å‚æ•° n å†³å®šã€‚master ä¸ slave çš„åŒ¹é…é¡ºåºä¸ºç¬¬ä¸€ä¸ª master ä¸å‰ n ä¸ª slave åˆ†ä¸ºä¸€ç»„ï¼Œå½¢æˆä¸»ä»ç»“æ„ æ·»åŠ  master åˆ°å½“å‰é›†ç¾¤ä¸­ï¼Œè¿æ¥æ—¶å¯ä»¥æŒ‡å®šä»»æ„ç°æœ‰èŠ‚ç‚¹åœ°å€ä¸ç«¯å£ 1redis-cli --cluster add-node new-master-host:new-master-port now-host:now-port æ·»åŠ  slave 1redis-cli --cluster add-node new-slave-host:new-slave-port master-host:master-port --cluster-slave --cluster-master-id masterid åˆ é™¤èŠ‚ç‚¹ï¼Œå¦‚æœåˆ é™¤çš„èŠ‚ç‚¹æ˜¯ masterï¼Œå¿…é¡»ä¿éšœå…¶ä¸­æ²¡æœ‰æ§½ slot 1redis-cli --cluster del-node del-slave-host:del-slave-port del-slave-id é‡æ–°åˆ†æ§½ï¼Œåˆ†æ§½æ˜¯ä»å…·æœ‰æ§½çš„ master ä¸­åˆ’åˆ†ä¸€éƒ¨åˆ†ç»™å…¶ä»– masterï¼Œè¿‡ç¨‹ä¸­ä¸åˆ›å»ºæ–°çš„æ§½ 1redis-cli --cluster reshard new-master-host:new-master:port --cluster-from src- master-id1, src-master-id2, src-master-idn --cluster-to target-master-id -- cluster-slots slots æ³¨æ„ï¼šå°†éœ€è¦å‚ä¸åˆ†æ§½çš„æ‰€æœ‰ masterid ä¸åˆ†å…ˆåé¡ºåºæ·»åŠ åˆ°å‚æ•°ä¸­ï¼Œä½¿ç”¨ , åˆ†éš”ï¼ŒæŒ‡å®šç›®æ ‡å¾—åˆ°çš„æ§½çš„æ•°é‡ï¼Œæ‰€æœ‰çš„æ§½å°†å¹³å‡ä»æ¯ä¸ªæ¥æºçš„ master å¤„è·å– é‡æ–°åˆ†é…æ§½ï¼Œä»å…·æœ‰æ§½çš„ master ä¸­åˆ†é…æŒ‡å®šæ•°é‡çš„æ§½åˆ°å¦ä¸€ä¸ª master ä¸­ï¼Œå¸¸ç”¨äºæ¸…ç©ºæŒ‡å®š master ä¸­çš„æ§½ 1redis-cli --cluster reshard src-master-host:src-master-port --cluster-from src- master-id --cluster-to target-master-id --cluster-slots slots --cluster-yes å…¶ä»–æ“ä½œå‘å¸ƒè®¢é˜…åŸºæœ¬æŒ‡ä»¤Redis å‘å¸ƒè®¢é˜…ï¼ˆpub&#x2F;subï¼‰æ˜¯ä¸€ç§æ¶ˆæ¯é€šä¿¡æ¨¡å¼ï¼šå‘é€è€…ï¼ˆpubï¼‰å‘é€æ¶ˆæ¯ï¼Œè®¢é˜…è€…ï¼ˆsubï¼‰æ¥æ”¶æ¶ˆæ¯ Redis å®¢æˆ·ç«¯å¯ä»¥è®¢é˜…ä»»æ„æ•°é‡çš„é¢‘é“ï¼Œæ¯å½“æœ‰å®¢æˆ·ç«¯å‘è¢«è®¢é˜…çš„é¢‘é“å‘é€æ¶ˆæ¯ï¼ˆmessageï¼‰æ—¶ï¼Œé¢‘é“çš„æ‰€æœ‰è®¢é˜…è€…éƒ½ä¼šæ”¶åˆ°æ¶ˆæ¯ æ“ä½œè¿‡ç¨‹ï¼š æ‰“å¼€ä¸€ä¸ªå®¢æˆ·ç«¯è®¢é˜… channel1ï¼šSUBSCRIBE channel1 æ‰“å¼€å¦ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œç»™ channel1 å‘å¸ƒæ¶ˆæ¯ helloï¼šPUBLISH channel1 hello ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯å¯ä»¥çœ‹åˆ°å‘é€çš„æ¶ˆæ¯ å®¢æˆ·ç«¯è¿˜å¯ä»¥é€šè¿‡ PSUBSCRIBE å‘½ä»¤è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å¼ï¼Œæ¯å½“æœ‰å…¶ä»–å®¢æˆ·ç«¯å‘æŸä¸ªé¢‘é“å‘é€æ¶ˆæ¯æ—¶ï¼Œæ¶ˆæ¯ä¸ä»…ä¼šè¢«å‘é€ç»™è¿™ä¸ªé¢‘é“çš„æ‰€æœ‰è®¢é˜…è€…ï¼Œè¿˜ä¼šè¢«å‘é€ç»™æ‰€æœ‰ä¸è¿™ä¸ªé¢‘é“ç›¸åŒ¹é…çš„æ¨¡å¼çš„è®¢é˜…è€…ï¼Œæ¯”å¦‚ PSUBSCRIBE channel* è®¢é˜…æ¨¡å¼ï¼Œä¸ channel1 åŒ¹é… æ³¨æ„ï¼šå‘å¸ƒçš„æ¶ˆæ¯æ²¡æœ‰æŒä¹…åŒ–ï¼Œæ‰€ä»¥è®¢é˜…çš„å®¢æˆ·ç«¯åªèƒ½æ”¶åˆ°è®¢é˜…åå‘å¸ƒçš„æ¶ˆæ¯ é¢‘é“æ“ä½œRedis å°†æ‰€æœ‰é¢‘é“çš„è®¢é˜…å…³ç³»éƒ½ä¿å­˜åœ¨æœåŠ¡å™¨çŠ¶æ€çš„ pubsub_channels å­—å…¸é‡Œï¼Œé”®æ˜¯æŸä¸ªè¢«è®¢é˜…çš„é¢‘é“ï¼Œå€¼æ˜¯ä¸€ä¸ªè®°å½•æ‰€æœ‰è®¢é˜…è¿™ä¸ªé¢‘é“çš„å®¢æˆ·ç«¯é“¾è¡¨ 1234struct redisServer &#123; // ä¿å­˜æ‰€æœ‰é¢‘é“çš„è®¢é˜…å…³ç³»ï¼Œ dict *pubsub_channels;&#125; å®¢æˆ·ç«¯æ‰§è¡Œ SUBSCRIBE å‘½ä»¤è®¢é˜…æŸä¸ªæˆ–æŸäº›é¢‘é“ï¼ŒæœåŠ¡å™¨ä¼šå°†å®¢æˆ·ç«¯ä¸é¢‘é“è¿›è¡Œå…³è”ï¼š é¢‘é“å·²ç»å­˜åœ¨ï¼Œç›´æ¥å°†å®¢æˆ·ç«¯æ·»åŠ åˆ°é“¾è¡¨æœ«å°¾ é¢‘é“è¿˜æœªæœ‰ä»»ä½•è®¢é˜…è€…ï¼Œåœ¨å­—å…¸ä¸­ä¸ºé¢‘é“åˆ›å»ºä¸€ä¸ªé”®å€¼å¯¹ï¼Œå†å°†å®¢æˆ·ç«¯æ·»åŠ åˆ°é“¾è¡¨ UNSUBSCRIBE å‘½ä»¤ç”¨æ¥é€€è®¢æŸä¸ªé¢‘é“ï¼ŒæœåŠ¡å™¨å°†ä» pubsub_channels ä¸­è§£é™¤å®¢æˆ·ç«¯ä¸è¢«é€€è®¢é¢‘é“ä¹‹é—´çš„å…³è” æ¨¡å¼æ“ä½œRedis æœåŠ¡å™¨å°†æ‰€æœ‰æ¨¡å¼çš„è®¢é˜…å…³ç³»éƒ½ä¿å­˜åœ¨æœåŠ¡å™¨çŠ¶æ€çš„ pubsub_patterns å±æ€§é‡Œ 1234567891011struct redisServer &#123; // ä¿å­˜æ‰€æœ‰æ¨¡å¼è®¢é˜…å…³ç³»ï¼Œé“¾è¡¨ä¸­æ¯ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ª pubsubPattern list *pubsub_patterns;&#125;typedef struct pubsubPattern &#123; // è®¢é˜…çš„å®¢æˆ·ç«¯ redisClient *client; // è¢«è®¢é˜…çš„æ¨¡å¼ï¼Œæ¯”å¦‚ channel* robj *pattern; &#125; å®¢æˆ·ç«¯æ‰§è¡Œ PSUBSCRIBE å‘½ä»¤è®¢é˜…æŸä¸ªæ¨¡å¼ï¼ŒæœåŠ¡å™¨ä¼šæ–°å»ºä¸€ä¸ª pubsubPattern ç»“æ„å¹¶èµ‹å€¼ï¼Œæ”¾å…¥ pubsub_patterns é“¾è¡¨ç»“å°¾ æ¨¡å¼çš„é€€è®¢å‘½ä»¤ PUNSUBSCRIBE æ˜¯è®¢é˜…å‘½ä»¤çš„åæ“ä½œï¼ŒæœåŠ¡å™¨åœ¨ pubsub_patterns é“¾è¡¨ä¸­æŸ¥æ‰¾å¹¶åˆ é™¤å¯¹åº”çš„ç»“æ„ å‘é€æ¶ˆæ¯Redis å®¢æˆ·ç«¯æ‰§è¡Œ PUBLISH &lt;channel&gt; &lt;message&gt; å‘½ä»¤å°†æ¶ˆæ¯ messageå‘é€ç»™é¢‘é“ channelï¼ŒæœåŠ¡å™¨ä¼šæ‰§è¡Œï¼š åœ¨ pubsub_channels å­—å…¸é‡Œæ‰¾åˆ°é¢‘é“ channel çš„è®¢é˜…è€…åå•ï¼Œå°†æ¶ˆæ¯ message å‘é€ç»™æ‰€æœ‰è®¢é˜…è€… éå†æ•´ä¸ª pubsub_patterns é“¾è¡¨ï¼ŒæŸ¥æ‰¾ä¸ channel é¢‘é“ç›¸åŒ¹é…çš„æ¨¡å¼ï¼Œå¹¶å°†æ¶ˆæ¯å‘é€ç»™æ‰€æœ‰è®¢é˜…äº†è¿™äº›æ¨¡å¼çš„å®¢æˆ·ç«¯ 12345// å¦‚æœé¢‘é“å’Œæ¨¡å¼ç›¸åŒ¹é…if match(channel, pubsubPattern.pattern) &#123; // å°†æ¶ˆæ¯å‘é€ç»™è®¢é˜…è¯¥æ¨¡å¼çš„å®¢æˆ·ç«¯ send_message(pubsubPattern.client, message);&#125; æŸ¥çœ‹ä¿¡æ¯PUBSUB å‘½ä»¤ç”¨æ¥æŸ¥çœ‹é¢‘é“æˆ–è€…æ¨¡å¼çš„ç›¸å…³ä¿¡æ¯ PUBSUB CHANNELS [pattern] è¿”å›æœåŠ¡å™¨å½“å‰è¢«è®¢é˜…çš„é¢‘é“ï¼Œå…¶ä¸­ pattern å‚æ•°æ˜¯å¯é€‰çš„ å¦‚æœä¸ç»™å®š pattern å‚æ•°ï¼Œé‚£ä¹ˆå‘½ä»¤è¿”å›æœåŠ¡å™¨å½“å‰è¢«è®¢é˜…çš„æ‰€æœ‰é¢‘é“ å¦‚æœç»™å®š pattern å‚æ•°ï¼Œé‚£ä¹ˆå‘½ä»¤è¿”å›æœåŠ¡å™¨å½“å‰è¢«è®¢é˜…çš„é¢‘é“ä¸­ä¸ pattern æ¨¡å¼ç›¸åŒ¹é…çš„é¢‘é“ PUBSUB NUMSUB [channel-1 channel-2 ... channel-n] å‘½ä»¤æ¥å—ä»»æ„å¤šä¸ªé¢‘é“ä½œä¸ºè¾“å…¥å‚æ•°ï¼Œå¹¶è¿”å›è¿™äº›é¢‘é“çš„è®¢é˜…è€…æ•°é‡ PUBSUB NUMPAT å‘½ä»¤ç”¨äºè¿”å›æœåŠ¡å™¨å½“å‰è¢«è®¢é˜…æ¨¡å¼çš„æ•°é‡ ACL æŒ‡ä»¤Redis ACL æ˜¯ Access Control Listï¼ˆè®¿é—®æ§åˆ¶åˆ—è¡¨ï¼‰çš„ç¼©å†™ï¼Œè¯¥åŠŸèƒ½å…è®¸æ ¹æ®å¯ä»¥æ‰§è¡Œçš„å‘½ä»¤å’Œå¯ä»¥è®¿é—®çš„é”®æ¥é™åˆ¶æŸäº›è¿æ¥ acl catï¼šæŸ¥çœ‹æ·»åŠ æƒé™æŒ‡ä»¤ç±»åˆ« acl whoamiï¼šæŸ¥çœ‹å½“å‰ç”¨æˆ· acl setuser username on &gt;password ~cached:* +getï¼šè®¾ç½®æœ‰ç”¨æˆ·åã€å¯†ç ã€ACL æƒé™ï¼ˆåªèƒ½ getï¼‰ ç›‘è§†å™¨MONITOR å‘½ä»¤ï¼Œå¯ä»¥å°†å®¢æˆ·ç«¯å˜ä¸ºä¸€ä¸ªç›‘è§†å™¨ï¼Œå®æ—¶åœ°æ¥æ”¶å¹¶æ‰“å°å‡ºæœåŠ¡å™¨å½“å‰å¤„ç†çš„å‘½ä»¤è¯·æ±‚çš„ç›¸å…³ä¿¡æ¯ 123456789// å®ç°åŸç†def MONITOR(): // æ‰“å¼€å®¢æˆ·ç«¯çš„ç›‘è§†å™¨æ ‡å¿— client.flags |= REDIS_MONITOR // å°†å®¢æˆ·ç«¯æ·»åŠ åˆ°æœåŠ¡å™¨çŠ¶æ€çš„ redisServer.monitorsé“¾è¡¨çš„æœ«å°¾ server.monitors.append(client) // å‘å®¢æˆ·ç«¯è¿”å› ok send_reply(&quot;OK&quot;) æœåŠ¡å™¨æ¯æ¬¡å¤„ç†å‘½ä»¤è¯·æ±‚éƒ½ä¼šè°ƒç”¨ replicationFeedMonitors å‡½æ•°ï¼Œå‡½æ•°å°†è¢«å¤„ç†çš„å‘½ä»¤è¯·æ±‚çš„ç›¸å…³ä¿¡æ¯å‘é€ç»™å„ä¸ªç›‘è§†å™¨ 123456789redis&gt; MONITOR OK 1378822099.421623 [0 127.0.0.1:56604] &quot;PING&quot; 1378822105.089572 [0 127.0.0.1:56604] &quot;SET&quot; &quot;msg&quot; &quot;hello world&quot; 1378822109.036925 [0 127.0.0.1:56604] &quot;SET&quot; &quot;number&quot; &quot;123&quot; 1378822140.649496 (0 127.0.0.1:56604] &quot;SADD&quot; &quot;fruits&quot; &quot;Apple&quot; &quot;Banana&quot; &quot;Cherry&quot; 1378822154.117160 [0 127.0.0.1:56604] &quot;EXPIRE&quot; &quot;msg&quot; &quot;10086&quot; 1378822257.329412 [0 127.0.0.1:56604] &quot;KEYS&quot; &quot;*&quot; 1378822258.690131 [0 127.0.0.1:56604] &quot;DBSIZE&quot; æ‰¹å¤„ç†Redis çš„ç®¡é“ Pipeline æœºåˆ¶å¯ä»¥ä¸€æ¬¡å¤„ç†å¤šæ¡æŒ‡ä»¤ Pipeline ä¸­çš„å¤šæ¡å‘½ä»¤éåŸå­æ€§ï¼Œå› ä¸ºåœ¨å‘ç®¡é“å†…æ·»åŠ å‘½ä»¤æ—¶ï¼Œå…¶ä»–å®¢æˆ·ç«¯çš„å‘é€çš„å‘½ä»¤ä»ç„¶åœ¨æ‰§è¡Œ åŸç”Ÿæ‰¹å‘½ä»¤ï¼ˆMSET ç­‰ï¼‰æ˜¯æœåŠ¡ç«¯å®ç°ï¼Œè€Œ Pipeline éœ€è¦æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯å…±åŒå®Œæˆ ä½¿ç”¨ Pipeline å°è£…çš„å‘½ä»¤æ•°é‡ä¸èƒ½å¤ªå¤šï¼Œæ•°æ®é‡è¿‡å¤§ä¼šå¢åŠ å®¢æˆ·ç«¯çš„ç­‰å¾…æ—¶é—´ï¼Œé€ æˆç½‘ç»œé˜»å¡ï¼ŒJedis ä¸­çš„ Pipeline ä½¿ç”¨æ–¹å¼ï¼š 12345678910// åˆ›å»ºç®¡é“Pipeline pipeline = jedis.pipelined();for (int i = 1; i &lt;= 100000; i++) &#123; // æ”¾å…¥å‘½ä»¤åˆ°ç®¡é“ pipeline.set(&quot;key_&quot; + i, &quot;value_&quot; + i); if (i % 1000 == 0) &#123; // æ¯æ”¾å…¥1000æ¡å‘½ä»¤ï¼Œæ‰¹é‡æ‰§è¡Œ pipeline.sync(); &#125;&#125; é›†ç¾¤ä¸‹æ¨¡å¼ä¸‹ï¼Œæ‰¹å¤„ç†å‘½ä»¤çš„å¤šä¸ª key å¿…é¡»è½åœ¨ä¸€ä¸ªæ’æ§½ä¸­ï¼Œå¦åˆ™å°±ä¼šå¯¼è‡´æ‰§è¡Œå¤±è´¥ï¼ŒN æ¡æ‰¹å¤„ç†å‘½ä»¤çš„ä¼˜åŒ–æ–¹å¼ï¼š ä¸²è¡Œå‘½ä»¤ï¼šfor å¾ªç¯éå†ï¼Œä¾æ¬¡æ‰§è¡Œæ¯ä¸ªå‘½ä»¤ ä¸²è¡Œ slotï¼šåœ¨å®¢æˆ·ç«¯è®¡ç®—æ¯ä¸ª key çš„ slotï¼Œå°† slot ä¸€è‡´çš„åˆ†ä¸ºä¸€ç»„ï¼Œæ¯ç»„éƒ½åˆ©ç”¨ Pipeline æ‰¹å¤„ç†ï¼Œä¸²è¡Œæ‰§è¡Œå„ç»„å‘½ä»¤ å¹¶è¡Œ slotï¼šåœ¨å®¢æˆ·ç«¯è®¡ç®—æ¯ä¸ª key çš„ slotï¼Œå°† slot ä¸€è‡´çš„åˆ†ä¸ºä¸€ç»„ï¼Œæ¯ç»„éƒ½åˆ©ç”¨ Pipeline æ‰¹å¤„ç†ï¼Œå¹¶è¡Œæ‰§è¡Œå„ç»„å‘½ä»¤ hash_tagï¼šå°†æ‰€æœ‰ key è®¾ç½®ç›¸åŒçš„ hash_tagï¼Œåˆ™æ‰€æœ‰ key çš„ slot ä¸€å®šç›¸åŒ è€—æ—¶ ä¼˜ç‚¹ ç¼ºç‚¹ ä¸²è¡Œå‘½ä»¤ N æ¬¡ç½‘ç»œè€—æ—¶ + N æ¬¡å‘½ä»¤è€—æ—¶ å®ç°ç®€å• è€—æ—¶ä¹… ä¸²è¡Œ slot m æ¬¡ç½‘ç»œè€—æ—¶ + N æ¬¡å‘½ä»¤è€—æ—¶ï¼Œm &#x3D; key çš„ slot ä¸ªæ•° è€—æ—¶è¾ƒçŸ­ å®ç°ç¨å¤æ‚ å¹¶è¡Œ slot 1 æ¬¡ç½‘ç»œè€—æ—¶ + N æ¬¡å‘½ä»¤è€—æ—¶ è€—æ—¶éå¸¸çŸ­ å®ç°å¤æ‚ hash_tag 1 æ¬¡ç½‘ç»œè€—æ—¶ + N æ¬¡å‘½ä»¤è€—æ—¶ è€—æ—¶éå¸¸çŸ­ã€å®ç°ç®€å• å®¹æ˜“å‡ºç°æ•°æ®å€¾æ–œ è§£å†³æ–¹æ¡ˆç¼“å­˜æ–¹æ¡ˆç¼“å­˜æ¨¡å¼æ—è·¯ç¼“å­˜ç¼“å­˜æœ¬è´¨ï¼šå¼¥è¡¥ CPU çš„é«˜ç®—åŠ›å’Œ IO çš„æ…¢è¯»å†™ä¹‹é—´å·¨å¤§çš„é¸¿æ²Ÿ æ—è·¯ç¼“å­˜æ¨¡å¼ Cache Aside Pattern æ˜¯å¹³æ—¶ä½¿ç”¨æ¯”è¾ƒå¤šçš„ä¸€ä¸ªç¼“å­˜è¯»å†™æ¨¡å¼ï¼Œæ¯”è¾ƒé€‚åˆè¯»è¯·æ±‚æ¯”è¾ƒå¤šçš„åœºæ™¯ Cache Aside Pattern ä¸­æœåŠ¡ç«¯éœ€è¦åŒæ—¶ç»´ç³» DB å’Œ cacheï¼Œå¹¶ä¸”æ˜¯ä»¥ DB çš„ç»“æœä¸ºå‡† å†™æ“ä½œï¼šå…ˆæ›´æ–° DBï¼Œç„¶åç›´æ¥åˆ é™¤ cache è¯»æ“ä½œï¼šä» cache ä¸­è¯»å–æ•°æ®ï¼Œè¯»å–åˆ°å°±ç›´æ¥è¿”å›ï¼›è¯»å–ä¸åˆ°å°±ä» DB ä¸­è¯»å–æ•°æ®è¿”å›ï¼Œå¹¶æ”¾åˆ° cache æ—¶åºå¯¼è‡´çš„ä¸ä¸€è‡´é—®é¢˜ï¼š åœ¨å†™æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œä¸èƒ½å…ˆåˆ é™¤ cache å†æ›´æ–° DBï¼Œå› ä¸ºä¼šé€ æˆç¼“å­˜çš„ä¸ä¸€è‡´ã€‚æ¯”å¦‚è¯·æ±‚ 1 å…ˆå†™æ•°æ® Aï¼Œè¯·æ±‚ 2 éšåè¯»æ•°æ® Aï¼Œå½“è¯·æ±‚ 1 åˆ é™¤ cache åï¼Œè¯·æ±‚ 2 ç›´æ¥è¯»å–äº† DBï¼Œæ­¤æ—¶è¯·æ±‚ 1 è¿˜æ²¡å†™å…¥ DBï¼ˆå»¶è¿ŸåŒåˆ ï¼‰ åœ¨å†™æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œå…ˆæ›´æ–° DB å†åˆ é™¤ cache ä¹Ÿä¼šå‡ºç°é—®é¢˜ï¼Œä½†æ˜¯æ¦‚ç‡å¾ˆå°ï¼Œå› ä¸ºç¼“å­˜çš„å†™å…¥é€Ÿåº¦éå¸¸å¿« æ—è·¯ç¼“å­˜çš„ç¼ºç‚¹ï¼š é¦–æ¬¡è¯·æ±‚æ•°æ®ä¸€å®šä¸åœ¨ cache çš„é—®é¢˜ï¼Œä¸€èˆ¬é‡‡ç”¨ç¼“å­˜é¢„çƒ­çš„æ–¹æ³•ï¼Œå°†çƒ­ç‚¹æ•°æ®å¯ä»¥æå‰æ”¾å…¥ cache ä¸­ å†™æ“ä½œæ¯”è¾ƒé¢‘ç¹çš„è¯å¯¼è‡´ cache ä¸­çš„æ•°æ®ä¼šè¢«é¢‘ç¹è¢«åˆ é™¤ï¼Œå½±å“ç¼“å­˜å‘½ä¸­ç‡ åˆ é™¤ç¼“å­˜è€Œä¸æ˜¯æ›´æ–°ç¼“å­˜çš„åŸå› ï¼šæ¯æ¬¡æ›´æ–°æ•°æ®åº“éƒ½æ›´æ–°ç¼“å­˜ï¼Œé€ æˆæ— æ•ˆå†™æ“ä½œè¾ƒå¤šï¼ˆæ‡’æƒ°åŠ è½½ï¼Œéœ€è¦çš„æ—¶å€™å†æ”¾å…¥ç¼“å­˜ï¼‰ è¯»å†™ç©¿é€è¯»å†™ç©¿é€æ¨¡å¼ Read&#x2F;Write Through Patternï¼šæœåŠ¡ç«¯æŠŠ cache è§†ä¸ºä¸»è¦æ•°æ®å­˜å‚¨ï¼Œä»ä¸­è¯»å–æ•°æ®å¹¶å°†æ•°æ®å†™å…¥å…¶ä¸­ï¼Œcache è´Ÿè´£å°†æ­¤æ•°æ®åŒæ­¥å†™å…¥ DBï¼Œä»è€Œå‡è½»äº†åº”ç”¨ç¨‹åºçš„èŒè´£ å†™æ“ä½œï¼šå…ˆæŸ¥ cacheï¼Œcache ä¸­ä¸å­˜åœ¨ï¼Œç›´æ¥æ›´æ–° DBï¼›cache ä¸­å­˜åœ¨åˆ™å…ˆæ›´æ–° cacheï¼Œç„¶å cache æœåŠ¡æ›´æ–° DBï¼ˆåŒæ­¥æ›´æ–° cache å’Œ DBï¼‰ è¯»æ“ä½œï¼šä» cache ä¸­è¯»å–æ•°æ®ï¼Œè¯»å–åˆ°å°±ç›´æ¥è¿”å› ï¼›è¯»å–ä¸åˆ°å…ˆä» DB åŠ è½½ï¼Œå†™å…¥åˆ° cache åè¿”å›å“åº” Read-Through Pattern å®é™…åªæ˜¯åœ¨ Cache-Aside Pattern ä¹‹ä¸Šè¿›è¡Œäº†å°è£…ã€‚åœ¨ Cache-Aside Pattern ä¸‹ï¼Œå‘ç”Ÿè¯»è¯·æ±‚çš„æ—¶å€™ï¼Œå¦‚æœ cache ä¸­ä¸å­˜åœ¨å¯¹åº”çš„æ•°æ®ï¼Œæ˜¯ç”±å®¢æˆ·ç«¯è´Ÿè´£æŠŠæ•°æ®å†™å…¥ cacheï¼Œè€Œ Read Through Pattern åˆ™æ˜¯ cache æœåŠ¡è‡ªå·±æ¥å†™å…¥ç¼“å­˜çš„ï¼Œå¯¹å®¢æˆ·ç«¯æ˜¯é€æ˜çš„ Read-Through Pattern ä¹Ÿå­˜åœ¨é¦–æ¬¡ä¸å‘½ä¸­çš„é—®é¢˜ï¼Œé‡‡ç”¨ç¼“å­˜é¢„çƒ­è§£å†³ å¼‚æ­¥ç¼“å­˜å¼‚æ­¥ç¼“å­˜å†™å…¥ Write Behind Pattern ç”± cache æœåŠ¡æ¥è´Ÿè´£ cache å’Œ DB çš„è¯»å†™ï¼Œå¯¹æ¯”è¯»å†™ç©¿é€ä¸åŒçš„æ˜¯ Write Behind Caching æ˜¯åªæ›´æ–°ç¼“å­˜ï¼Œä¸ç›´æ¥æ›´æ–° DBï¼Œæ”¹ä¸ºå¼‚æ­¥æ‰¹é‡çš„æ–¹å¼æ¥æ›´æ–° DBï¼Œå¯ä»¥å‡å°å†™çš„æˆæœ¬ ç¼ºç‚¹ï¼šè¿™ç§æ¨¡å¼å¯¹æ•°æ®ä¸€è‡´æ€§æ²¡æœ‰é«˜è¦æ±‚ï¼Œå¯èƒ½å‡ºç° cache è¿˜æ²¡å¼‚æ­¥æ›´æ–° DBï¼ŒæœåŠ¡å°±æŒ‚æ‰äº† åº”ç”¨ï¼š DB çš„å†™æ€§èƒ½éå¸¸é«˜ï¼Œé€‚åˆä¸€äº›æ•°æ®ç»å¸¸å˜åŒ–åˆå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯ï¼Œæ¯”å¦‚æµè§ˆé‡ã€ç‚¹èµé‡ MySQL çš„ InnoDB Buffer Pool æœºåˆ¶ç”¨åˆ°äº†è¿™ç§ç­–ç•¥ ç¼“å­˜ä¸€è‡´ä½¿ç”¨ç¼“å­˜ä»£è¡¨ä¸éœ€è¦å¼ºä¸€è‡´æ€§ï¼Œåªéœ€è¦æœ€ç»ˆä¸€è‡´æ€§ ç¼“å­˜ä¸ä¸€è‡´çš„æ–¹æ³•ï¼š æ•°æ®åº“å’Œç¼“å­˜æ•°æ®å¼ºä¸€è‡´åœºæ™¯ï¼š åŒæ­¥åŒå†™ï¼šæ›´æ–° DB æ—¶åŒæ ·æ›´æ–° cacheï¼Œä¿è¯åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œé€šè¿‡åŠ é”æ¥ä¿è¯æ›´æ–° cache æ—¶ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ å»¶è¿ŸåŒåˆ ï¼šå…ˆæ·˜æ±°ç¼“å­˜å†å†™æ•°æ®åº“ï¼Œä¼‘çœ  1 ç§’å†æ¬¡æ·˜æ±°ç¼“å­˜ï¼Œå¯ä»¥å°† 1 ç§’å†…é€ æˆçš„ç¼“å­˜è„æ•°æ®å†æ¬¡åˆ é™¤ å¼‚æ­¥é€šçŸ¥ï¼š åŸºäº MQ çš„å¼‚æ­¥é€šçŸ¥ï¼šå¯¹æ•°æ®çš„ä¿®æ”¹åï¼Œä»£ç éœ€è¦å‘é€ä¸€æ¡æ¶ˆæ¯åˆ° MQ ä¸­ï¼Œç¼“å­˜æœåŠ¡ç›‘å¬ MQ æ¶ˆæ¯ Canal è®¢é˜… MySQL binlog çš„å˜æ›´ä¸ŠæŠ¥ç»™ Kafkaï¼Œç³»ç»Ÿç›‘å¬ Kafka æ¶ˆæ¯è§¦å‘ç¼“å­˜å¤±æ•ˆï¼Œæˆ–è€…ç›´æ¥å°†å˜æ›´å‘é€åˆ°å¤„ç†æœåŠ¡ï¼Œæ²¡æœ‰ä»»ä½•ä»£ç ä¾µå…¥ ä½è€¦åˆï¼Œå¯ä»¥åŒæ—¶é€šçŸ¥å¤šä¸ªç¼“å­˜æœåŠ¡ï¼Œä½†æ˜¯æ—¶æ•ˆæ€§ä¸€èˆ¬ï¼Œå¯èƒ½å­˜åœ¨ä¸­é—´ä¸ä¸€è‡´çŠ¶æ€ ä½ä¸€è‡´æ€§åœºæ™¯ï¼š æ›´æ–° DB çš„æ—¶å€™åŒæ ·æ›´æ–° cacheï¼Œä½†æ˜¯ç»™ç¼“å­˜åŠ ä¸€ä¸ªæ¯”è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯å³ä½¿æ•°æ®ä¸ä¸€è‡´å½±å“ä¹Ÿæ¯”è¾ƒå° ä½¿ç”¨ Redis è‡ªå¸¦çš„å†…å­˜æ·˜æ±°æœºåˆ¶ ç¼“å­˜é—®é¢˜ç¼“å­˜é¢„çƒ­åœºæ™¯ï¼šå®•æœºï¼ŒæœåŠ¡å™¨å¯åŠ¨åè¿…é€Ÿå®•æœº é—®é¢˜æ’æŸ¥ï¼š è¯·æ±‚æ•°é‡è¾ƒé«˜ï¼Œå¤§é‡çš„è¯·æ±‚è¿‡æ¥ä¹‹åéƒ½éœ€è¦å»ä»ç¼“å­˜ä¸­è·å–æ•°æ®ï¼Œä½†æ˜¯ç¼“å­˜ä¸­åˆæ²¡æœ‰ï¼Œæ­¤æ—¶ä»æ•°æ®åº“ä¸­æŸ¥æ‰¾æ•°æ®ç„¶åå°†æ•°æ®å†å­˜å…¥ç¼“å­˜ï¼Œé€ æˆäº†çŸ­æœŸå†…å¯¹ redis çš„é«˜å¼ºåº¦æ“ä½œä»è€Œå¯¼è‡´é—®é¢˜ ä¸»ä»ä¹‹é—´æ•°æ®ååé‡è¾ƒå¤§ï¼Œæ•°æ®åŒæ­¥æ“ä½œé¢‘åº¦è¾ƒé«˜ è§£å†³æ–¹æ¡ˆï¼š å‰ç½®å‡†å¤‡å·¥ä½œï¼š æ—¥å¸¸ä¾‹è¡Œç»Ÿè®¡æ•°æ®è®¿é—®è®°å½•ï¼Œç»Ÿè®¡è®¿é—®é¢‘åº¦è¾ƒé«˜çš„çƒ­ç‚¹æ•°æ® åˆ©ç”¨ LRU æ•°æ®åˆ é™¤ç­–ç•¥ï¼Œæ„å»ºæ•°æ®ç•™å­˜é˜Ÿåˆ—ä¾‹å¦‚ï¼šstorm ä¸ kafka é…åˆ å‡†å¤‡å·¥ä½œï¼š å°†ç»Ÿè®¡ç»“æœä¸­çš„æ•°æ®åˆ†ç±»ï¼Œæ ¹æ®çº§åˆ«ï¼Œredis ä¼˜å…ˆåŠ è½½çº§åˆ«è¾ƒé«˜çš„çƒ­ç‚¹æ•°æ® åˆ©ç”¨åˆ†å¸ƒå¼å¤šæœåŠ¡å™¨åŒæ—¶è¿›è¡Œæ•°æ®è¯»å–ï¼Œæé€Ÿæ•°æ®åŠ è½½è¿‡ç¨‹ çƒ­ç‚¹æ•°æ®ä¸»ä»åŒæ—¶é¢„çƒ­ å®æ–½ï¼š ä½¿ç”¨è„šæœ¬ç¨‹åºå›ºå®šè§¦å‘æ•°æ®é¢„çƒ­è¿‡ç¨‹ å¦‚æœæ¡ä»¶å…è®¸ï¼Œä½¿ç”¨äº† CDNï¼ˆå†…å®¹åˆ†å‘ç½‘ç»œï¼‰ï¼Œæ•ˆæœä¼šæ›´å¥½ æ€»çš„æ¥è¯´ï¼šç¼“å­˜é¢„çƒ­å°±æ˜¯ç³»ç»Ÿå¯åŠ¨å‰ï¼Œæå‰å°†ç›¸å…³çš„ç¼“å­˜æ•°æ®ç›´æ¥åŠ è½½åˆ°ç¼“å­˜ç³»ç»Ÿã€‚é¿å…åœ¨ç”¨æˆ·è¯·æ±‚çš„æ—¶å€™ï¼Œå…ˆæŸ¥è¯¢æ•°æ®åº“ï¼Œç„¶åå†å°†æ•°æ®ç¼“å­˜çš„é—®é¢˜ï¼Œç”¨æˆ·ç›´æ¥æŸ¥è¯¢äº‹å…ˆè¢«é¢„çƒ­çš„ç¼“å­˜æ•°æ® ç¼“å­˜é›ªå´©åœºæ™¯ï¼šæ•°æ®åº“æœåŠ¡å™¨å´©æºƒï¼Œä¸€è¿ä¸²çš„é—®é¢˜ä¼šéšä¹‹è€Œæ¥ é—®é¢˜æ’æŸ¥ï¼šåœ¨ä¸€ä¸ªè¾ƒçŸ­çš„æ—¶é—´å†…ï¼Œç¼“å­˜ä¸­è¾ƒå¤šçš„ key é›†ä¸­è¿‡æœŸï¼Œæ­¤å‘¨æœŸå†…è¯·æ±‚è®¿é—®è¿‡æœŸçš„æ•°æ® Redis æœªå‘½ä¸­ï¼ŒRedis å‘æ•°æ®åº“è·å–æ•°æ®ï¼Œæ•°æ®åº“åŒæ—¶æ”¶åˆ°å¤§é‡çš„è¯·æ±‚æ— æ³•åŠæ—¶å¤„ç†ã€‚ è§£å†³æ–¹æ¡ˆï¼š åŠ é”ï¼Œæ…ç”¨ è®¾ç½®çƒ­ç‚¹æ•°æ®æ°¸è¿œä¸è¿‡æœŸï¼Œå¦‚æœç¼“å­˜æ•°æ®åº“æ˜¯åˆ†å¸ƒå¼éƒ¨ç½²ï¼Œå°†çƒ­ç‚¹æ•°æ®å‡åŒ€åˆ†å¸ƒåœ¨ä¸åŒæå¾—ç¼“å­˜æ•°æ®åº“ä¸­ ç¼“å­˜æ•°æ®çš„è¿‡æœŸæ—¶é—´è®¾ç½®éšæœºï¼Œé˜²æ­¢åŒä¸€æ—¶é—´å¤§é‡æ•°æ®è¿‡æœŸç°è±¡å‘ç”Ÿ æ„å»ºå¤šçº§ç¼“å­˜æ¶æ„ï¼ŒNginx ç¼“å­˜ + Redis ç¼“å­˜ + ehcache ç¼“å­˜ ç¾éš¾é¢„è­¦æœºåˆ¶ï¼Œç›‘æ§ Redis æœåŠ¡å™¨æ€§èƒ½æŒ‡æ ‡ï¼ŒCPU ä½¿ç”¨ç‡ã€å†…å­˜å®¹é‡ã€å¹³å‡å“åº”æ—¶é—´ã€çº¿ç¨‹æ•° é™æµã€é™çº§ï¼šçŸ­æ—¶é—´èŒƒå›´å†…ç‰ºç‰²ä¸€äº›å®¢æˆ·ä½“éªŒï¼Œé™åˆ¶ä¸€éƒ¨åˆ†è¯·æ±‚è®¿é—®ï¼Œé™ä½åº”ç”¨æœåŠ¡å™¨å‹åŠ›ï¼Œå¾…ä¸šåŠ¡ä½é€Ÿè¿è½¬åå†é€æ­¥æ”¾å¼€è®¿é—® æ€»çš„æ¥è¯´ï¼šç¼“å­˜é›ªå´©å°±æ˜¯ç¬é—´è¿‡æœŸæ•°æ®é‡å¤ªå¤§ï¼Œå¯¼è‡´å¯¹æ•°æ®åº“æœåŠ¡å™¨é€ æˆå‹åŠ›ã€‚å¦‚èƒ½å¤Ÿæœ‰æ•ˆé¿å…è¿‡æœŸæ—¶é—´é›†ä¸­ï¼Œå¯ä»¥æœ‰æ•ˆè§£å†³é›ªå´©ç°è±¡çš„å‡ºç°ï¼ˆçº¦ 40%ï¼‰ï¼Œé…åˆå…¶ä»–ç­–ç•¥ä¸€èµ·ä½¿ç”¨ï¼Œå¹¶ç›‘æ§æœåŠ¡å™¨çš„è¿è¡Œæ•°æ®ï¼Œæ ¹æ®è¿è¡Œè®°å½•åšå¿«é€Ÿè°ƒæ•´ã€‚ ç¼“å­˜å‡»ç©¿ç¼“å­˜å‡»ç©¿ä¹Ÿå«çƒ­ç‚¹ Key é—®é¢˜ Redis ä¸­æŸä¸ª key è¿‡æœŸï¼Œè¯¥ key è®¿é—®é‡å·¨å¤§ å¤šä¸ªæ•°æ®è¯·æ±‚ä»æœåŠ¡å™¨ç›´æ¥å‹åˆ° Redis åï¼Œå‡æœªå‘½ä¸­ Redis åœ¨çŸ­æ—¶é—´å†…å‘èµ·äº†å¤§é‡å¯¹æ•°æ®åº“ä¸­åŒä¸€æ•°æ®çš„è®¿é—® è§£å†³æ–¹æ¡ˆï¼š é¢„å…ˆè®¾å®šï¼šä»¥ç”µå•†ä¸ºä¾‹ï¼Œæ¯ä¸ªå•†å®¶æ ¹æ®åº—é“ºç­‰çº§ï¼ŒæŒ‡å®šè‹¥å¹²æ¬¾ä¸»æ‰“å•†å“ï¼Œåœ¨è´­ç‰©èŠ‚æœŸé—´ï¼ŒåŠ å¤§æ­¤ç±»ä¿¡æ¯ key çš„è¿‡æœŸæ—¶é•¿ æ³¨æ„ï¼šè´­ç‰©èŠ‚ä¸ä»…ä»…æŒ‡å½“å¤©ï¼Œä»¥åŠåç»­è‹¥å¹²å¤©ï¼Œè®¿é—®å³°å€¼å‘ˆç°é€æ¸é™ä½çš„è¶‹åŠ¿ ç°åœºè°ƒæ•´ï¼šç›‘æ§è®¿é—®é‡ï¼Œå¯¹è‡ªç„¶æµé‡æ¿€å¢çš„æ•°æ®å»¶é•¿è¿‡æœŸæ—¶é—´æˆ–è®¾ç½®ä¸ºæ°¸ä¹…æ€§ key åå°åˆ·æ–°æ•°æ®ï¼šå¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼Œé«˜å³°æœŸæ¥ä¸´ä¹‹å‰ï¼Œåˆ·æ–°æ•°æ®æœ‰æ•ˆæœŸï¼Œç¡®ä¿ä¸ä¸¢å¤± äºŒçº§ç¼“å­˜ï¼šè®¾ç½®ä¸åŒçš„å¤±æ•ˆæ—¶é—´ï¼Œä¿éšœä¸ä¼šè¢«åŒæ—¶æ·˜æ±°å°±è¡Œ åŠ é”ï¼šåˆ†å¸ƒå¼é”ï¼Œé˜²æ­¢è¢«å‡»ç©¿ï¼Œä½†æ˜¯è¦æ³¨æ„ä¹Ÿæ˜¯æ€§èƒ½ç“¶é¢ˆï¼Œæ…é‡ æ€»çš„æ¥è¯´ï¼šç¼“å­˜å‡»ç©¿å°±æ˜¯å•ä¸ªé«˜çƒ­æ•°æ®è¿‡æœŸçš„ç¬é—´ï¼Œæ•°æ®è®¿é—®é‡è¾ƒå¤§ï¼Œæœªå‘½ä¸­ Redis åï¼Œå‘èµ·äº†å¤§é‡å¯¹åŒä¸€æ•°æ®çš„æ•°æ®åº“è®¿é—®ï¼Œå¯¼è‡´å¯¹æ•°æ®åº“æœåŠ¡å™¨é€ æˆå‹åŠ›ã€‚åº”å¯¹ç­–ç•¥åº”è¯¥åœ¨ä¸šåŠ¡æ•°æ®åˆ†æä¸é¢„é˜²æ–¹é¢è¿›è¡Œï¼Œé…åˆè¿è¡Œç›‘æ§æµ‹è¯•ä¸å³æ—¶è°ƒæ•´ç­–ç•¥ï¼Œæ¯•ç«Ÿå•ä¸ª key çš„è¿‡æœŸç›‘æ§éš¾åº¦è¾ƒé«˜ï¼Œé…åˆé›ªå´©å¤„ç†ç­–ç•¥å³å¯ ç¼“å­˜ç©¿é€åœºæ™¯ï¼šç³»ç»Ÿå¹³ç¨³è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œåº”ç”¨æœåŠ¡å™¨æµé‡éšæ—¶é—´å¢é‡è¾ƒå¤§ï¼ŒRedis æœåŠ¡å™¨å‘½ä¸­ç‡éšæ—¶é—´é€æ­¥é™ä½ï¼ŒRedis å†…å­˜å¹³ç¨³ï¼Œå†…å­˜æ— å‹åŠ›ï¼ŒRedis æœåŠ¡å™¨ CPU å ç”¨æ¿€å¢ï¼Œæ•°æ®åº“æœåŠ¡å™¨å‹åŠ›æ¿€å¢ï¼Œæ•°æ®åº“å´©æºƒ é—®é¢˜æ’æŸ¥ï¼š Redis ä¸­å¤§é¢ç§¯å‡ºç°æœªå‘½ä¸­ å‡ºç°éæ­£å¸¸ URL è®¿é—® é—®é¢˜åˆ†æï¼š è®¿é—®äº†ä¸å­˜åœ¨çš„æ•°æ®ï¼Œè·³è¿‡äº† Redis ç¼“å­˜ï¼Œæ•°æ®åº“é¡µæŸ¥è¯¢ä¸åˆ°å¯¹åº”æ•°æ® Redis è·å–åˆ° null æ•°æ®æœªè¿›è¡ŒæŒä¹…åŒ–ï¼Œç›´æ¥è¿”å› å‡ºç°é»‘å®¢æ”»å‡»æœåŠ¡å™¨ è§£å†³æ–¹æ¡ˆï¼š ç¼“å­˜ nullï¼šå¯¹æŸ¥è¯¢ç»“æœä¸º null çš„æ•°æ®è¿›è¡Œç¼“å­˜ï¼Œè®¾å®šçŸ­æ—¶é™ï¼Œä¾‹å¦‚ 30-60 ç§’ï¼Œæœ€é«˜ 5 åˆ†é’Ÿ ç™½åå•ç­–ç•¥ï¼šæå‰é¢„çƒ­å„ç§åˆ†ç±»æ•°æ® id å¯¹åº”çš„ bitmapsï¼Œid ä½œä¸º bitmaps çš„ offsetï¼Œç›¸å½“äºè®¾ç½®äº†æ•°æ®ç™½åå•ã€‚å½“åŠ è½½æ­£å¸¸æ•°æ®æ—¶æ”¾è¡Œï¼ŒåŠ è½½å¼‚å¸¸æ•°æ®æ—¶ç›´æ¥æ‹¦æˆªï¼ˆæ•ˆç‡åä½ï¼‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆæœ‰å…³å¸ƒéš†è¿‡æ»¤å™¨çš„å‘½ä¸­é—®é¢˜å¯¹å½“å‰çŠ¶å†µå¯ä»¥å¿½ç•¥ï¼‰ å®æ—¶ç›‘æ§ï¼šå®æ—¶ç›‘æ§ Redis å‘½ä¸­ç‡ï¼ˆä¸šåŠ¡æ­£å¸¸èŒƒå›´æ—¶ï¼Œé€šå¸¸ä¼šæœ‰ä¸€ä¸ªæ³¢åŠ¨å€¼ï¼‰ä¸ null æ•°æ®çš„å æ¯” éæ´»åŠ¨æ—¶æ®µæ³¢åŠ¨ï¼šé€šå¸¸æ£€æµ‹ 3-5 å€ï¼Œè¶…è¿‡ 5 å€çº³å…¥é‡ç‚¹æ’æŸ¥å¯¹è±¡ æ´»åŠ¨æ—¶æ®µæ³¢åŠ¨ï¼šé€šå¸¸æ£€æµ‹10-50 å€ï¼Œè¶…è¿‡ 50 å€çº³å…¥é‡ç‚¹æ’æŸ¥å¯¹è±¡ æ ¹æ®å€æ•°ä¸åŒï¼Œå¯åŠ¨ä¸åŒçš„æ’æŸ¥æµç¨‹ã€‚ç„¶åä½¿ç”¨é»‘åå•è¿›è¡Œé˜²æ§ key åŠ å¯†ï¼šä¸´æ—¶å¯åŠ¨é˜²ç¾ä¸šåŠ¡ keyï¼Œå¯¹ key è¿›è¡Œä¸šåŠ¡å±‚ä¼ è¾“åŠ å¯†æœåŠ¡ï¼Œè®¾å®šæ ¡éªŒç¨‹åºï¼Œè¿‡æ¥çš„ key æ ¡éªŒï¼›ä¾‹å¦‚æ¯å¤©éšæœºåˆ†é… 60 ä¸ªåŠ å¯†ä¸²ï¼ŒæŒ‘é€‰ 2 åˆ° 3 ä¸ªï¼Œæ··æ·†åˆ°é¡µé¢æ•°æ® id ä¸­ï¼Œå‘ç°è®¿é—® key ä¸æ»¡è¶³è§„åˆ™ï¼Œé©³å›æ•°æ®è®¿é—® æ€»çš„æ¥è¯´ï¼šç¼“å­˜å‡»ç©¿æ˜¯æŒ‡è®¿é—®äº†ä¸å­˜åœ¨çš„æ•°æ®ï¼Œè·³è¿‡äº†åˆæ³•æ•°æ®çš„ Redis æ•°æ®ç¼“å­˜é˜¶æ®µï¼Œæ¯æ¬¡è®¿é—®æ•°æ®åº“ï¼Œå¯¼è‡´å¯¹æ•°æ®åº“æœåŠ¡å™¨é€ æˆå‹åŠ›ã€‚é€šå¸¸æ­¤ç±»æ•°æ®çš„å‡ºç°é‡æ˜¯ä¸€ä¸ªè¾ƒä½çš„å€¼ï¼Œå½“å‡ºç°æ­¤ç±»æƒ…å†µä»¥æ¯’æ”»æ¯’ï¼Œå¹¶åŠæ—¶æŠ¥è­¦ã€‚æ— è®ºæ˜¯é»‘åå•è¿˜æ˜¯ç™½åå•ï¼Œéƒ½æ˜¯å¯¹æ•´ä½“ç³»ç»Ÿçš„å‹åŠ›ï¼Œè­¦æŠ¥è§£é™¤åå°½å¿«ç§»é™¤ å‚è€ƒè§†é¢‘ï¼šhttps://www.bilibili.com/video/BV15y4y1r7X3 Key è®¾è®¡å¤§ Keyï¼šé€šå¸¸ä»¥ Key çš„å¤§å°å’Œ Key ä¸­æˆå‘˜çš„æ•°é‡æ¥ç»¼åˆåˆ¤å®šï¼Œå¼•å‘çš„é—®é¢˜ï¼š å®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤çš„æ—¶é•¿å˜æ…¢ Redis å†…å­˜è¾¾åˆ° maxmemory å®šä¹‰çš„ä¸Šé™å¼•å‘æ“ä½œé˜»å¡æˆ–é‡è¦çš„ Key è¢«é€å‡ºï¼Œç”šè‡³å¼•å‘å†…å­˜æº¢å‡ºï¼ˆOOMï¼‰ é›†ç¾¤æ¶æ„ä¸‹ï¼ŒæŸä¸ªæ•°æ®åˆ†ç‰‡çš„å†…å­˜ä½¿ç”¨ç‡è¿œè¶…å…¶ä»–æ•°æ®åˆ†ç‰‡ï¼Œä½¿æ•°æ®åˆ†ç‰‡çš„å†…å­˜èµ„æºä¸å‡è¡¡ å¯¹å¤§ Key æ‰§è¡Œè¯»è¯·æ±‚ï¼Œä¼šä½¿ Redis å®ä¾‹çš„å¸¦å®½ä½¿ç”¨ç‡è¢«å æ»¡ï¼Œå¯¼è‡´è‡ªèº«æœåŠ¡å˜æ…¢ï¼ŒåŒæ—¶æ˜“æ³¢åŠç›¸å…³çš„æœåŠ¡ å¯¹å¤§ Key æ‰§è¡Œåˆ é™¤æ“ä½œï¼Œä¼šé€ æˆä¸»åº“è¾ƒé•¿æ—¶é—´çš„é˜»å¡ï¼Œè¿›è€Œå¯èƒ½å¼•å‘åŒæ­¥ä¸­æ–­æˆ–ä¸»ä»åˆ‡æ¢ çƒ­ Keyï¼šé€šå¸¸ä»¥å…¶æ¥æ”¶åˆ°çš„ Key è¢«è¯·æ±‚é¢‘ç‡æ¥åˆ¤å®šï¼Œå¼•å‘çš„é—®é¢˜ï¼š å ç”¨å¤§é‡çš„ CPU èµ„æºï¼Œå½±å“å…¶ä»–è¯·æ±‚å¹¶å¯¼è‡´æ•´ä½“æ€§èƒ½é™ä½ åˆ†å¸ƒå¼é›†ç¾¤æ¶æ„ä¸‹ï¼Œäº§ç”Ÿè®¿é—®å€¾æ–œï¼Œå³æŸä¸ªæ•°æ®åˆ†ç‰‡è¢«å¤§é‡è®¿é—®ï¼Œè€Œå…¶ä»–æ•°æ®åˆ†ç‰‡å¤„äºç©ºé—²çŠ¶æ€ï¼Œå¯èƒ½å¼•èµ·è¯¥æ•°æ®åˆ†ç‰‡çš„è¿æ¥æ•°è¢«è€—å°½ï¼Œæ–°çš„è¿æ¥å»ºç«‹è¯·æ±‚è¢«æ‹’ç»ç­‰é—®é¢˜ åœ¨æŠ¢è´­æˆ–ç§’æ€åœºæ™¯ä¸‹ï¼Œå¯èƒ½å› å•†å“å¯¹åº”åº“å­˜ Key çš„è¯·æ±‚é‡è¿‡å¤§ï¼Œè¶…å‡º Redis å¤„ç†èƒ½åŠ›é€ æˆè¶…å– çƒ­ Key çš„è¯·æ±‚å‹åŠ›æ•°é‡è¶…å‡º Redis çš„æ‰¿å—èƒ½åŠ›æ˜“é€ æˆç¼“å­˜å‡»ç©¿ï¼Œå³å¤§é‡è¯·æ±‚å°†è¢«ç›´æ¥æŒ‡å‘åç«¯çš„å­˜å‚¨å±‚ï¼Œå¯¼è‡´å­˜å‚¨è®¿é—®é‡æ¿€å¢ç”šè‡³å®•æœºï¼Œä»è€Œå½±å“å…¶ä»–ä¸šåŠ¡ çƒ­ Key åˆ†ç±»ä¸¤ç§ï¼Œæ²»ç†æ–¹å¼å¦‚ä¸‹ï¼š ä¸€ç§æ˜¯å•ä¸€æ•°æ®ï¼Œæ¯”å¦‚ç§’æ€åœºæ™¯ï¼Œå‡è®¾æ€»é‡ 10000 å¯ä»¥æ‹†ä¸ºå¤šä¸ª Key è¿›è¡Œè®¿é—®ï¼Œæ¯æ¬¡å¯¹è¯·æ±‚è¿›è¡Œè·¯ç”±åˆ°ä¸åŒçš„ Key è®¿é—®ï¼Œä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œä½†æ˜¯ä¼šå‡ºç°è®¿é—®ä¸åŒ Key äº§ç”Ÿçš„å‰©ä½™é‡æ˜¯ä¸åŒçš„ï¼Œè¿™æ—¶å¯ä»¥é€šè¿‡å‰ç«¯è¿›è¡Œ Mock å‡æ•°æ® ä¸€ç§æ˜¯å¤šæ•°æ®é›†åˆï¼Œæ¯”å¦‚è¿›è¡Œ ID è¿‡æ»¤ï¼Œè¿™æ—¶å¯ä»¥æ·»åŠ æœ¬åœ° LRU ç¼“å­˜ï¼Œå‡å°‘å¯¹çƒ­ Key çš„è®¿é—® å‚è€ƒæ–‡æ¡£ï¼šhttps://help.aliyun.com/document_detail/353223.html æ…¢æŸ¥è¯¢ç¡®è®¤æœåŠ¡å’Œ Redis ä¹‹é—´çš„é“¾è·¯æ˜¯å¦æ­£å¸¸ï¼Œæ’é™¤ç½‘ç»œåŸå› åè¿›è¡Œ Redis çš„æ’æŸ¥ï¼š ä½¿ç”¨å¤æ‚åº¦è¿‡é«˜çš„å‘½ä»¤ æ“ä½œå¤§ keyï¼Œåˆ†é…å†…å­˜å’Œé‡Šæ”¾å†…å­˜ä¼šæ¯”è¾ƒè€—æ—¶ key é›†ä¸­è¿‡æœŸï¼Œå¯¼è‡´å®šæ—¶ä»»åŠ¡éœ€è¦æ›´é•¿çš„æ—¶é—´å»æ¸…ç† å®ä¾‹å†…å­˜è¾¾åˆ°ä¸Šé™ï¼Œæ¯æ¬¡å†™å…¥æ–°çš„æ•°æ®ä¹‹å‰ï¼ŒRedis å¿…é¡»å…ˆä»å®ä¾‹ä¸­è¸¢å‡ºä¸€éƒ¨åˆ†æ•°æ® å‚è€ƒæ–‡ç« ï¼šhttps://www.cnblogs.com/traditional/p/15633919.htmlï¼ˆéå¸¸å¥½ï¼‰ JavaJDBCæ¦‚è¿°JDBCï¼ˆJava DataBase Connectivityï¼ŒJava æ•°æ®åº“è¿æ¥ï¼‰æ˜¯ä¸€ç§ç”¨äºæ‰§è¡Œ SQL è¯­å¥çš„ Java APIï¼Œå¯ä»¥ä¸ºå¤šç§å…³ç³»å‹æ•°æ®åº“æä¾›ç»Ÿä¸€è®¿é—®ï¼Œæ˜¯ç”±ä¸€ç»„ç”¨ Java è¯­è¨€ç¼–å†™çš„ç±»å’Œæ¥å£ç»„æˆçš„ã€‚ JDBC æ˜¯ Java å®˜æ–¹æä¾›çš„ä¸€å¥—è§„èŒƒï¼ˆæ¥å£ï¼‰ï¼Œç”¨äºå¸®åŠ©å¼€å‘äººå‘˜å¿«é€Ÿå®ç°ä¸åŒå…³ç³»å‹æ•°æ®åº“çš„è¿æ¥ åŠŸèƒ½ç±»DriverManagerDriverManagerï¼šé©±åŠ¨ç®¡ç†å¯¹è±¡ æ³¨å†Œé©±åŠ¨ï¼š æ³¨å†Œç»™å®šçš„é©±åŠ¨ï¼špublic static void registerDriver(Driver driver) ä»£ç å®ç°è¯­æ³•ï¼šClass.forName(&quot;com.mysql.jdbc.Driver) com.mysql.jdbc.Driver ä¸­å­˜åœ¨é™æ€ä»£ç å— 1234567static &#123; try &#123; DriverManager.registerDriver(new Driver()); &#125; catch (SQLException var1) &#123; throw new RuntimeException(&quot;Can&#x27;t register driver!&quot;); &#125;&#125; ä¸éœ€è¦é€šè¿‡ DriverManager è°ƒç”¨é™æ€æ–¹æ³• registerDriverï¼Œå› ä¸º Driver ç±»è¢«ä½¿ç”¨ï¼Œåˆ™è‡ªåŠ¨æ‰§è¡Œé™æ€ä»£ç å—å®Œæˆæ³¨å†Œé©±åŠ¨ jar åŒ…ä¸­ META-INF ç›®å½•ä¸‹å­˜åœ¨ä¸€ä¸ª java.sql.Driver é…ç½®æ–‡ä»¶ï¼Œæ–‡ä»¶ä¸­æŒ‡å®šäº† com.mysql.jdbc.Driver è·å–æ•°æ®åº“è¿æ¥å¹¶è¿”å›è¿æ¥å¯¹è±¡ï¼š æ–¹æ³•ï¼špublic static Connection getConnection(String url, String user, String password) urlï¼šæŒ‡å®šè¿æ¥çš„è·¯å¾„ï¼Œè¯­æ³•ä¸º jdbc:mysql://ipåœ°å€(åŸŸå):ç«¯å£å·/æ•°æ®åº“åç§° userï¼šç”¨æˆ·å passwordï¼šå¯†ç  ConnectionConnectionï¼šæ•°æ®åº“è¿æ¥å¯¹è±¡ è·å–æ‰§è¡Œè€…å¯¹è±¡ è·å–æ™®é€šæ‰§è¡Œè€…å¯¹è±¡ï¼šStatement createStatement() è·å–é¢„ç¼–è¯‘æ‰§è¡Œè€…å¯¹è±¡ï¼šPreparedStatement prepareStatement(String sql) ç®¡ç†äº‹åŠ¡ å¼€å¯äº‹åŠ¡ï¼šsetAutoCommit(boolean autoCommit)ï¼Œfalse å¼€å¯äº‹åŠ¡ï¼Œtrue è‡ªåŠ¨æäº¤æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ æäº¤äº‹åŠ¡ï¼švoid commit() å›æ»šäº‹åŠ¡ï¼švoid rollback() é‡Šæ”¾èµ„æº é‡Šæ”¾æ­¤ Connection å¯¹è±¡çš„æ•°æ®åº“å’Œ JDBC èµ„æºï¼švoid close() StatementStatementï¼šæ‰§è¡Œ sql è¯­å¥çš„å¯¹è±¡ æ‰§è¡Œ DML è¯­å¥ï¼šint executeUpdate(String sql) è¿”å›å€¼ intï¼šè¿”å›å½±å“çš„è¡Œæ•° å‚æ•° sqlï¼šå¯ä»¥æ‰§è¡Œ insertã€updateã€delete è¯­å¥ æ‰§è¡Œ DQL è¯­å¥ï¼šResultSet executeQuery(String sql) è¿”å›å€¼ ResultSetï¼šå°è£…æŸ¥è¯¢çš„ç»“æœ å‚æ•° sqlï¼šå¯ä»¥æ‰§è¡Œ select è¯­å¥ é‡Šæ”¾èµ„æº é‡Šæ”¾æ­¤ Statement å¯¹è±¡çš„æ•°æ®åº“å’Œ JDBC èµ„æºï¼švoid close() ResultSetResultSetï¼šç»“æœé›†å¯¹è±¡ï¼ŒResultSet å¯¹è±¡ç»´æŠ¤äº†ä¸€ä¸ªæ¸¸æ ‡ï¼ŒæŒ‡å‘å½“å‰çš„æ•°æ®è¡Œï¼Œåˆå§‹åœ¨ç¬¬ä¸€è¡Œ åˆ¤æ–­ç»“æœé›†ä¸­æ˜¯å¦æœ‰æ•°æ®ï¼šboolean next() æœ‰æ•°æ®è¿”å› trueï¼Œå¹¶å°†ç´¢å¼•å‘ä¸‹ç§»åŠ¨ä¸€è¡Œ æ²¡æœ‰æ•°æ®è¿”å› false è·å–ç»“æœé›†ä¸­å½“å‰è¡Œçš„æ•°æ®ï¼šXXX getXxx(&quot;åˆ—å&quot;) XXX ä»£è¡¨æ•°æ®ç±»å‹ï¼ˆè¦è·å–æŸåˆ—æ•°æ®ï¼Œè¿™ä¸€åˆ—çš„æ•°æ®ç±»å‹ï¼‰ ä¾‹å¦‚ï¼šString getString(â€œnameâ€); int getInt(â€œageâ€); é‡Šæ”¾èµ„æº é‡Šæ”¾ ResultSet å¯¹è±¡çš„æ•°æ®åº“å’Œ JDBC èµ„æºï¼švoid close() ä»£ç å®ç°æ•°æ®å‡†å¤‡ 1234567891011121314151617-- åˆ›å»ºdb14æ•°æ®åº“CREATE DATABASE db14;-- ä½¿ç”¨db14æ•°æ®åº“USE db14;-- åˆ›å»ºstudentè¡¨CREATE TABLE student( sid INT PRIMARY KEY AUTO_INCREMENT, -- å­¦ç”Ÿid NAME VARCHAR(20), -- å­¦ç”Ÿå§“å age INT, -- å­¦ç”Ÿå¹´é¾„ birthday DATE, -- å­¦ç”Ÿç”Ÿæ—¥);-- æ·»åŠ æ•°æ®INSERT INTO student VALUES (NULL,&#x27;å¼ ä¸‰&#x27;,23,&#x27;1999-09-23&#x27;),(NULL,&#x27;æå››&#x27;,24,&#x27;1998-08-10&#x27;),(NULL,&#x27;ç‹äº”&#x27;,25,&#x27;1996-06-06&#x27;),(NULL,&#x27;èµµå…­&#x27;,26,&#x27;1994-10-20&#x27;); JDBC è¿æ¥ä»£ç ï¼š 12345678910111213141516171819202122232425262728public class JDBCDemo01 &#123; public static void main(String[] args) throws Exception&#123; //1.å¯¼å…¥jaråŒ… //2.æ³¨å†Œé©±åŠ¨ Class.forName(&quot;com.mysql.jdbc.Driver&quot;); //3.è·å–è¿æ¥ Connection con = DriverManager.getConnection(&quot;jdbc:mysql://192.168.2.184:3306/db2&quot;,&quot;root&quot;,&quot;123456&quot;); //4.è·å–æ‰§è¡Œè€…å¯¹è±¡ Statement stat = con.createStatement(); //5.æ‰§è¡Œsqlè¯­å¥ï¼Œå¹¶ä¸”æ¥æ”¶ç»“æœ String sql = &quot;SELECT * FROM user&quot;; ResultSet rs = stat.executeQuery(sql); //6.å¤„ç†ç»“æœ while(rs.next()) &#123; System.out.println(rs.getInt(&quot;id&quot;) + &quot;\\t&quot; + rs.getString(&quot;name&quot;)); &#125; //7.é‡Šæ”¾èµ„æº con.close(); stat.close(); con.close(); &#125;&#125; æ³¨å…¥æ”»å‡»æ”»å‡»æ¼”ç¤ºSQL æ³¨å…¥æ”»å‡»æ¼”ç¤º åœ¨ç™»å½•ç•Œé¢ï¼Œè¾“å…¥ä¸€ä¸ªé”™è¯¯çš„ç”¨æˆ·åæˆ–å¯†ç ï¼Œä¹Ÿå¯ä»¥ç™»å½•æˆåŠŸ åŸç†ï¼šæˆ‘ä»¬åœ¨å¯†ç å¤„è¾“å…¥çš„æ‰€æœ‰å†…å®¹ï¼Œéƒ½åº”è¯¥è®¤ä¸ºæ˜¯å¯†ç çš„ç»„æˆï¼Œä½†æ˜¯ Statement å¯¹è±¡åœ¨æ‰§è¡Œ SQL è¯­å¥æ—¶ï¼Œå°†ä¸€éƒ¨åˆ†å†…å®¹å½“åšæŸ¥è¯¢æ¡ä»¶æ¥æ‰§è¡Œ 1SELECT * FROM user WHERE loginname=&#x27;aaa&#x27; AND password=&#x27;aaa&#x27; OR &#x27;1&#x27;=&#x27;1&#x27;; æ”»å‡»è§£å†³PreparedStatementï¼šé¢„ç¼–è¯‘ sql è¯­å¥çš„æ‰§è¡Œè€…å¯¹è±¡ï¼Œç»§æ‰¿ PreparedStatement extends Statement åœ¨æ‰§è¡Œ sql è¯­å¥ä¹‹å‰ï¼Œå°† sql è¯­å¥è¿›è¡Œæå‰ç¼–è¯‘ï¼Œæ˜ç¡® sql è¯­å¥çš„æ ¼å¼ï¼Œå‰©ä½™çš„å†…å®¹éƒ½ä¼šè®¤ä¸ºæ˜¯å‚æ•° sql è¯­å¥ä¸­çš„å‚æ•°ä½¿ç”¨ ? ä½œä¸ºå ä½ç¬¦ ä¸º ? å ä½ç¬¦èµ‹å€¼çš„æ–¹æ³•ï¼šsetXxx(int parameterIndex, xxx data) å‚æ•°1ï¼š? çš„ä½ç½®ç¼–å·ï¼ˆç¼–å·ä» 1 å¼€å§‹ï¼‰ å‚æ•°2ï¼š? çš„å®é™…å‚æ•° 1234String sql = &quot;SELECT * FROM user WHERE loginname=? AND password=?&quot;;pst = con.prepareStatement(sql);pst.setString(1,loginName);pst.setString(2,password); æ‰§è¡Œ sql è¯­å¥çš„æ–¹æ³• æ‰§è¡Œ insertã€updateã€delete è¯­å¥ï¼šint executeUpdate() æ‰§è¡Œ select è¯­å¥ï¼šResultSet executeQuery() è¿æ¥æ± æ¦‚å¿µæ•°æ®åº“è¿æ¥èƒŒæ™¯ï¼šæ•°æ®åº“è¿æ¥æ˜¯ä¸€ç§å…³é”®çš„ã€æœ‰é™çš„ã€æ˜‚è´µçš„èµ„æºï¼Œè¿™ä¸€ç‚¹åœ¨å¤šç”¨æˆ·çš„ç½‘é¡µåº”ç”¨ç¨‹åºä¸­ä½“ç°å¾—å°¤ä¸ºçªå‡ºã€‚å¯¹æ•°æ®åº“è¿æ¥çš„ç®¡ç†èƒ½æ˜¾è‘—å½±å“åˆ°æ•´ä¸ªåº”ç”¨ç¨‹åºçš„ä¼¸ç¼©æ€§å’Œå¥å£®æ€§ï¼Œå½±å“åˆ°ç¨‹åºçš„æ€§èƒ½æŒ‡æ ‡ã€‚ æ•°æ®åº“è¿æ¥æ± ï¼šæ•°æ®åº“è¿æ¥æ± è´Ÿè´£åˆ†é…ã€ç®¡ç†å’Œé‡Šæ”¾æ•°æ®åº“è¿æ¥ï¼Œå®ƒå…è®¸åº”ç”¨ç¨‹åºé‡å¤ä½¿ç”¨ä¸€ä¸ªç°æœ‰çš„æ•°æ®åº“è¿æ¥ï¼Œè€Œä¸æ˜¯å†é‡æ–°å»ºç«‹ä¸€ä¸ªï¼Œè¿™é¡¹æŠ€æœ¯èƒ½æ˜æ˜¾æé«˜å¯¹æ•°æ®åº“æ“ä½œçš„æ€§èƒ½ã€‚ æ•°æ®åº“è¿æ¥æ± åŸç† å½’è¿˜è¿æ¥ä½¿ç”¨åŠ¨æ€ä»£ç†çš„æ–¹å¼æ¥æ”¹è¿› è‡ªå®šä¹‰æ•°æ®åº“è¿æ¥æ± ç±»ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public class MyDataSource implements DataSource &#123; //1.å‡†å¤‡ä¸€ä¸ªå®¹å™¨ã€‚ç”¨äºä¿å­˜å¤šä¸ªæ•°æ®åº“è¿æ¥å¯¹è±¡ private static List&lt;Connection&gt; pool = Collections.synchronizedList(new ArrayList&lt;&gt;()); //2.å®šä¹‰é™æ€ä»£ç å—,è·å–å¤šä¸ªè¿æ¥å¯¹è±¡ä¿å­˜åˆ°å®¹å™¨ä¸­ static&#123; for(int i = 1; i &lt;= 10; i++) &#123; Connection con = JDBCUtils.getConnection(); pool.add(con); &#125; &#125; //3.æä¾›ä¸€ä¸ªè·å–è¿æ¥æ± å¤§å°çš„æ–¹æ³• public int getSize() &#123; return pool.size(); &#125; //åŠ¨æ€ä»£ç†æ–¹å¼ @Override public Connection getConnection() throws SQLException &#123; if(pool.size() &gt; 0) &#123; Connection con = pool.remove(0); Connection proxyCon = (Connection) Proxy.newProxyInstance( con.getClass().getClassLoader(), new Class[]&#123;Connection.class&#125;, new InvocationHandler() &#123; /* æ‰§è¡ŒConnectionå®ç°ç±»è¿æ¥å¯¹è±¡æ‰€æœ‰çš„æ–¹æ³•éƒ½ä¼šç»è¿‡invoke å¦‚æœæ˜¯closeæ–¹æ³•ï¼Œå½’è¿˜è¿æ¥ å¦‚æœä¸æ˜¯ï¼Œç›´æ¥æ‰§è¡Œè¿æ¥å¯¹è±¡åŸæœ‰çš„åŠŸèƒ½å³å¯ */ @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; if(method.getName().equals(&quot;close&quot;)) &#123; //å½’è¿˜è¿æ¥ pool.add(con); return null; &#125;else &#123; return method.invoke(con,args); &#125; &#125; &#125;); return proxyCon; &#125;else &#123; throw new RuntimeException(&quot;è¿æ¥æ•°é‡å·²ç”¨å°½&quot;); &#125; &#125;&#125; å¼€æºé¡¹ç›®C3P0ä½¿ç”¨ C3P0 è¿æ¥æ± ï¼š é…ç½®æ–‡ä»¶åç§°ï¼šc3p0-config.xmlï¼Œå¿…é¡»æ”¾åœ¨ src ç›®å½•ä¸‹ 1234567891011121314151617181920212223&lt;c3p0-config&gt; &lt;!-- ä½¿ç”¨é»˜è®¤çš„é…ç½®è¯»å–è¿æ¥æ± å¯¹è±¡ --&gt; &lt;default-config&gt; &lt;!-- è¿æ¥å‚æ•° --&gt; &lt;property name=&quot;driverClass&quot;&gt;com.mysql.jdbc.Driver&lt;/property&gt; &lt;property name=&quot;jdbcUrl&quot;&gt;jdbc:mysql://192.168.2.184:3306/db14&lt;/property&gt; &lt;property name=&quot;user&quot;&gt;root&lt;/property&gt; &lt;property name=&quot;password&quot;&gt;123456&lt;/property&gt; &lt;!-- è¿æ¥æ± å‚æ•° --&gt; &lt;!--åˆå§‹åŒ–æ•°é‡--&gt; &lt;property name=&quot;initialPoolSize&quot;&gt;5&lt;/property&gt; &lt;!--æœ€å¤§è¿æ¥æ•°é‡--&gt; &lt;property name=&quot;maxPoolSize&quot;&gt;10&lt;/property&gt; &lt;!--è¶…æ—¶æ—¶é—´ 3000ms--&gt; &lt;property name=&quot;checkoutTimeout&quot;&gt;3000&lt;/property&gt; &lt;/default-config&gt; &lt;named-config name=&quot;otherc3p0&quot;&gt; &lt;!-- è¿æ¥å‚æ•° --&gt; &lt;!-- è¿æ¥æ± å‚æ•° --&gt; &lt;/named-config&gt;&lt;/c3p0-config&gt; ä»£ç æ¼”ç¤º 123456789101112131415161718192021222324public class C3P0Test1 &#123; public static void main(String[] args) throws Exception&#123; //1.åˆ›å»ºc3p0çš„æ•°æ®åº“è¿æ¥æ± å¯¹è±¡ DataSource dataSource = new ComboPooledDataSource(); //2.é€šè¿‡è¿æ¥æ± å¯¹è±¡è·å–æ•°æ®åº“è¿æ¥ Connection con = dataSource.getConnection(); //3.æ‰§è¡Œæ“ä½œ String sql = &quot;SELECT * FROM student&quot;; PreparedStatement pst = con.prepareStatement(sql); //4.æ‰§è¡Œsqlè¯­å¥ï¼Œæ¥æ”¶ç»“æœé›† ResultSet rs = pst.executeQuery(); //5.å¤„ç†ç»“æœé›† while(rs.next()) &#123; System.out.println(rs.getInt(&quot;sid&quot;) + &quot;\\t&quot; + rs.getString(&quot;name&quot;) + &quot;\\t&quot; + rs.getInt(&quot;age&quot;) + &quot;\\t&quot; + rs.getDate(&quot;birthday&quot;)); &#125; //6.é‡Šæ”¾èµ„æº rs.close(); pst.close(); con.close(); &#125;&#125; DruidDruid è¿æ¥æ± ï¼š é…ç½®æ–‡ä»¶ï¼šdruid.propertiesï¼Œå¿…é¡»æ”¾åœ¨ src ç›®å½•ä¸‹ 1234567driverClassName=com.mysql.jdbc.Driverurl=jdbc:mysql://192.168.2.184:3306/db14username=rootpassword=123456initialSize=5maxActive=10maxWait=3000 ä»£ç æ¼”ç¤º 123456789101112131415161718192021222324252627282930public class DruidTest1 &#123; public static void main(String[] args) throws Exception&#123; //è·å–é…ç½®æ–‡ä»¶çš„æµå¯¹è±¡ InputStream is = DruidTest1.class.getClassLoader().getResourceAsStream(&quot;druid.properties&quot;); //1.é€šè¿‡Propertiesé›†åˆï¼ŒåŠ è½½é…ç½®æ–‡ä»¶ Properties prop = new Properties(); prop.load(is); //2.é€šè¿‡Druidè¿æ¥æ± å·¥å‚ç±»è·å–æ•°æ®åº“è¿æ¥æ± å¯¹è±¡ DataSource dataSource = DruidDataSourceFactory.createDataSource(prop); //3.é€šè¿‡è¿æ¥æ± å¯¹è±¡è·å–æ•°æ®åº“è¿æ¥è¿›è¡Œä½¿ç”¨ Connection con = dataSource.getConnection(); //4.æ‰§è¡Œsqlè¯­å¥ï¼Œæ¥æ”¶ç»“æœé›† String sql = &quot;SELECT * FROM student&quot;; PreparedStatement pst = con.prepareStatement(sql); ResultSet rs = pst.executeQuery(); //5.å¤„ç†ç»“æœé›† while(rs.next()) &#123; System.out.println(rs.getInt(&quot;sid&quot;) + &quot;\\t&quot; + rs.getString(&quot;name&quot;) + &quot;\\t&quot; + rs.getInt(&quot;age&quot;) + &quot;\\t&quot; + rs.getDate(&quot;birthday&quot;)); &#125; //6.é‡Šæ”¾èµ„æº rs.close(); pst.close(); con.close(); &#125;&#125; JedisåŸºæœ¬ä½¿ç”¨Jedis ç”¨äº Java è¯­è¨€è¿æ¥ Redis æœåŠ¡ï¼Œå¹¶æä¾›å¯¹åº”çš„æ“ä½œ API jar åŒ…å¯¼å…¥ ä¸‹è½½åœ°å€ï¼šhttps://mvnrepository.com/artifact/redis.clients/jedis åŸºäº mavenï¼š 12345&lt;dependency&gt; &lt;groupId&gt;redis.clients&lt;/groupId&gt; &lt;artifactId&gt;jedis&lt;/artifactId&gt; &lt;version&gt;2.9.0&lt;/version&gt;&lt;/dependency&gt; å®¢æˆ·ç«¯è¿æ¥ Redisï¼šAPI æ–‡æ¡£ http://xetorthio.github.io/jedis/ è¿æ¥ redisï¼šJedis jedis = new Jedis(&quot;192.168.0.185&quot;, 6379) æ“ä½œ redisï¼šjedis.set(&quot;name&quot;, &quot;seazean&quot;); jedis.get(&quot;name&quot;) å…³é—­ redisï¼šjedis.close() ä»£ç å®ç°ï¼š 1234567891011121314151617181920public class JedisTest &#123; public static void main(String[] args) &#123; //1.è·å–è¿æ¥å¯¹è±¡ Jedis jedis = new Jedis(&quot;192.168.2.185&quot;,6379); //2.æ‰§è¡Œæ“ä½œ jedis.set(&quot;age&quot;,&quot;39&quot;); String hello = jedis.get(&quot;hello&quot;); System.out.println(hello); jedis.lpush(&quot;list1&quot;,&quot;a&quot;,&quot;b&quot;,&quot;c&quot;,&quot;d&quot;); List&lt;String&gt; list1 = jedis.lrange(&quot;list1&quot;, 0, -1); for (String s:list1 ) &#123; System.out.println(s); &#125; jedis.sadd(&quot;set1&quot;,&quot;abc&quot;,&quot;abc&quot;,&quot;def&quot;,&quot;poi&quot;,&quot;cba&quot;); Long len = jedis.scard(&quot;set1&quot;); System.out.println(len); //3.å…³é—­è¿æ¥ jedis.close(); &#125;&#125; å·¥å…·ç±»è¿æ¥æ± å¯¹è±¡ï¼š JedisPoolï¼šJedis æä¾›çš„è¿æ¥æ± æŠ€æœ¯ poolConfigï¼šè¿æ¥æ± é…ç½®å¯¹è±¡ hostï¼šRedis æœåŠ¡åœ°å€ portï¼šRedis æœåŠ¡ç«¯å£å· JedisPool çš„æ„é€ å™¨å¦‚ä¸‹ï¼š 123public JedisPool(GenericObjectPoolConfig poolConfig, String host, int port) &#123; this(poolConfig, host, port, 2000, (String)null, 0, (String)null);&#125; åˆ›å»ºé…ç½®æ–‡ä»¶ redis.properties 1234redis.maxTotal=50redis.maxIdel=10redis.host=192.168.2.185redis.port=6379 å·¥å…·ç±»ï¼š 123456789101112131415161718192021222324252627282930public class JedisUtils &#123; private static int maxTotal; private static int maxIdel; private static String host; private static int port; private static JedisPoolConfig jpc; private static JedisPool jp; static &#123; ResourceBundle bundle = ResourceBundle.getBundle(&quot;redis&quot;); //æœ€å¤§è¿æ¥æ•° maxTotal = Integer.parseInt(bundle.getString(&quot;redis.maxTotal&quot;)); //æ´»åŠ¨è¿æ¥æ•° maxIdel = Integer.parseInt(bundle.getString(&quot;redis.maxIdel&quot;)); host = bundle.getString(&quot;redis.host&quot;); port = Integer.parseInt(bundle.getString(&quot;redis.port&quot;)); //Jedisè¿æ¥é…ç½® jpc = new JedisPoolConfig(); jpc.setMaxTotal(maxTotal); jpc.setMaxIdle(maxIdel); //è¿æ¥æ± å¯¹è±¡ jp = new JedisPool(jpc, host, port); &#125; //å¯¹å¤–è®¿é—®æ¥å£ï¼Œæä¾›jedisè¿æ¥å¯¹è±¡ï¼Œè¿æ¥ä»è¿æ¥æ± è·å– public static Jedis getJedis() &#123; return jp.getResource(); &#125;&#125;","categories":[],"tags":[]},{"title":"","slug":"5-5/é¡¹ç›®_åç«¯","date":"2022-05-07T04:45:10.116Z","updated":"2022-05-14T09:17:55.534Z","comments":true,"path":"2022/05/07/5-5/é¡¹ç›®_åç«¯/","link":"","permalink":"https://dddwah11.github.io/2022/05/07/5-5/%E9%A1%B9%E7%9B%AE_%E5%90%8E%E7%AB%AF/","excerpt":"","text":"1ã€é…ç½®1.1ã€ç›¸å…³ä¾èµ–çˆ¶é¡¹ç›®pom.xmlä¸­çš„ç‰ˆæœ¬æ§åˆ¶ 12345678910111213141516 &lt;properties&gt;&lt;!-- mybatis-plus--&gt; &lt;mp.version&gt;3.5.0&lt;/mp.version&gt;&lt;!-- mybatis-plus-generator--&gt; &lt;mpg.version&gt;3.4.0&lt;/mpg.version&gt;&lt;!-- swagger--&gt; &lt;swagger.version&gt;2.9.2&lt;/swagger.version&gt;&lt;!-- velocityæ¨¡æ¿å¼•æ“--&gt; &lt;velocity.version&gt;2.3&lt;/velocity.version&gt;&lt;!-- mysql--&gt; &lt;mysql-java.version&gt;8.0.28&lt;/mysql-java.version&gt;&lt;!-- lombok--&gt; &lt;lombok.version&gt;1.18.22&lt;/lombok.version&gt;&lt;!-- knife4jå¢å¼ºæ–‡æœ¬--&gt; &lt;knife4j.version&gt;2.0.7&lt;/knife4j.version&gt; &lt;/properties&gt; ä¾èµ– 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354&lt;!-- mybatis-plus--&gt; &lt;dependency&gt; &lt;groupId&gt;com.baomidou&lt;/groupId&gt; &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt; &lt;version&gt;$&#123;mp.version&#125;&lt;/version&gt; &lt;/dependency&gt;&lt;!-- swagger ui--&gt; &lt;dependency&gt; &lt;groupId&gt;io.springfox&lt;/groupId&gt; &lt;artifactId&gt;springfox-swagger-ui&lt;/artifactId&gt; &lt;version&gt;$&#123;swagger.version&#125;&lt;/version&gt; &lt;/dependency&gt;&lt;!-- swagger2--&gt; &lt;dependency&gt; &lt;groupId&gt;io.springfox&lt;/groupId&gt; &lt;artifactId&gt;springfox-swagger2&lt;/artifactId&gt; &lt;version&gt;$&#123;swagger.version&#125;&lt;/version&gt; &lt;/dependency&gt;&lt;!-- mysqlæ•°æ®åº“--&gt; &lt;dependency&gt; &lt;groupId&gt;mysql&lt;/groupId&gt; &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt; &lt;version&gt;$&#123;mysql-java.version&#125;&lt;/version&gt; &lt;/dependency&gt;&lt;!-- mybatis-plusæ¨¡æ¿å¼•æ“--&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.velocity&lt;/groupId&gt; &lt;artifactId&gt;velocity-engine-core&lt;/artifactId&gt; &lt;version&gt;$&#123;velocity.version&#125;&lt;/version&gt; &lt;/dependency&gt;&lt;!-- ä»£ç è‡ªåŠ¨ç”Ÿæˆ--&gt; &lt;dependency&gt; &lt;groupId&gt;com.baomidou&lt;/groupId&gt; &lt;artifactId&gt;mybatis-plus-generator&lt;/artifactId&gt; &lt;version&gt;$&#123;mpg.version&#125;&lt;/version&gt; &lt;/dependency&gt;&lt;!-- lombok--&gt; &lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;version&gt;$&#123;lombok.version&#125;&lt;/version&gt; &lt;/dependency&gt;&lt;!-- knife4j--&gt; &lt;dependency&gt; &lt;groupId&gt;com.github.xiaoymin&lt;/groupId&gt; &lt;artifactId&gt;knife4j-spring-bootstarter&lt;/artifactId&gt; &lt;version&gt;$&#123;knife4j.version&#125;&lt;/version&gt; &lt;/dependency&gt; 1.2ã€åˆ›å»ºä¸¤ä¸ªå­mavené¡¹ç›®webï¼ˆspringbooté¡¹ç›®ï¼‰ ä¾èµ–äºcommonsé¡¹ç›® 1234567&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;com.xiaoliu&lt;/groupId&gt; &lt;artifactId&gt;helovue-base-common&lt;/artifactId&gt; &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt; &lt;/dependency&gt;&lt;/dependencies&gt; é…ç½®æ–‡ä»¶ 123456789101112131415161718192021222324spring: datasource: driver-class-name: com.mysql.cj.jdbc.Driver url: jdbc:mysql://localhost:3306/xinguan?useUnicode=true&amp;serveTimezone=UTC&amp;useSSL=false&amp;characterEncoding=utf8 username: root password: 123456 jackson: date-format: yyyy-MM-dd HH:mm:ss time-zone: GMT+8server: port: 8081mybatis-plus: configuration: log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl global-config: db-config: logic-delete-field: deleted # å…¨å±€é€»è¾‘åˆ é™¤çš„å®ä½“å­—æ®µå(since 3.3.0,é…ç½®åå¯ä»¥å¿½ç•¥ä¸é…ç½®æ­¥éª¤2) logic-delete-value: 1 # é€»è¾‘å·²åˆ é™¤å€¼(é»˜è®¤ä¸º 1) logic-not-delete-value: 0 # é€»è¾‘æœªåˆ é™¤å€¼(é»˜è®¤ä¸º 0) mapper-locations: classpath*:/mapper/*.xml å¯åŠ¨ç±»ï¼š 12345678@SpringBootApplication@MapperScan(&quot;com.xiaoliu.system.mapper&quot;)@EnableSwagger2public class xitongApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(xitongApplication.class,args); &#125;&#125; base-common(è®¾ç½®é…ç½®ç­‰ç»Ÿä¸€å¤„ç†)ä¾èµ–äºçˆ¶é¡¹ç›® 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455&lt;dependencies&gt; &lt;dependency&gt; &lt;!-- controllerå±‚--&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;!-- æ•°æ®è®¿é—®å±‚--&gt; &lt;dependency&gt; &lt;groupId&gt;com.baomidou&lt;/groupId&gt; &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt; &lt;/dependency&gt; &lt;!-- mybatisè‡ªåŠ¨ä»£ç ç”Ÿæˆ--&gt; &lt;dependency&gt; &lt;groupId&gt;com.baomidou&lt;/groupId&gt; &lt;artifactId&gt;mybatis-plus-generator&lt;/artifactId&gt; &lt;/dependency&gt; &lt;!-- mybatis-plusæ¨¡æ¿å¼•æ“--&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.velocity&lt;/groupId&gt; &lt;artifactId&gt;velocity-engine-core&lt;/artifactId&gt; &lt;/dependency&gt; &lt;!-- javaè¿æ¥mysql--&gt; &lt;dependency&gt; &lt;groupId&gt;mysql&lt;/groupId&gt; &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt; &lt;/dependency&gt; &lt;!-- swagger2--&gt; &lt;dependency&gt; &lt;groupId&gt;io.springfox&lt;/groupId&gt; &lt;artifactId&gt;springfox-swagger2&lt;/artifactId&gt; &lt;/dependency&gt; &lt;!-- swaggerui--&gt; &lt;dependency&gt; &lt;groupId&gt;io.springfox&lt;/groupId&gt; &lt;artifactId&gt;springfox-swagger-ui&lt;/artifactId&gt; &lt;/dependency&gt; &lt;!-- lombok--&gt; &lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;/dependency&gt;&lt;!-- knife4j--&gt; &lt;dependency&gt; &lt;groupId&gt;com.github.xiaoymin&lt;/groupId&gt; &lt;artifactId&gt;knife4j-spring-boot-starter&lt;/artifactId&gt; &lt;/dependency&gt; &lt;/dependencies&gt; 2ã€è‡ªåŠ¨ç”Ÿæˆä»£ç 2.1ã€éœ€è¦ä¾èµ–ï¼ˆé…ç½®æ—¶å·²å¯¼å…¥ï¼‰mybatis-plus(æŒä¹…å±‚æ¡†æ¶)ã€velocity(mybatis-plusæ¨¡æ¿å¼•æ“)ã€mybatis-plus-generator(ä»£ç è‡ªåŠ¨ç”Ÿæˆ) CodeGenerator.java 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091public class CodeGenerator &#123; /** * &lt;p&gt; * è¯»å–æ§åˆ¶å°å†…å®¹ * &lt;/p&gt; */ public static String scanner(String tip) &#123; Scanner scanner = new Scanner(System.in); StringBuilder help = new StringBuilder(); help.append(&quot;è¯·è¾“å…¥&quot; + tip + &quot;ï¼š&quot;); System.out.println(help.toString()); if (scanner.hasNext()) &#123; String ipt = scanner.next(); if (StringUtils.isNotBlank(ipt)) &#123; return ipt; &#125; &#125; throw new MybatisPlusException(&quot;æ­£ç¡®çš„&quot; + tip + &quot;ï¼&quot;); &#125; public static void main(String[] args) &#123; // åˆ›å»ºä»£ç ç”Ÿæˆå™¨å¯¹è±¡ AutoGenerator mpg = new AutoGenerator(); // å…¨å±€é…ç½® GlobalConfig gc = new GlobalConfig(); gc.setOutputDir(scanner(&quot;ä½ çš„é¡¹ç›®è·¯å¾„&quot;) + &quot;/src/main/java&quot;); gc.setAuthor(&quot;xiaoliu&quot;);// ç”Ÿæˆä¹‹åæ˜¯å¦æ‰“å¼€èµ„æºç®¡ç†å™¨ gc.setOpen(false);// æ˜¯å¦è¦†ç›–æ–‡ä»¶ gc.setFileOverride(false);// %så ä½ç¬¦// mpç”Ÿæˆserviceå±‚ä»£ç ï¼Œé»˜è®¤çš„æ¥å£åç§°ç¬¬ä¸€å¼ å­—æ¯æ˜¯æœ‰I gc.setServiceName(&quot;%sService&quot;);// è®¾ç½®ä¸»é”®ç”Ÿæˆç­–ç•¥ è‡ªåŠ¨å¢é•¿ gc.setIdType(IdType.AUTO);// è®¾ç½®dateçš„ç±»å‹ é»˜è®¤åªä½¿ç”¨ java.util.date ä»£æ›¿ gc.setDateType(DateType.ONLY_DATE); //å¼€å¯å®ä½“å±æ€§ Swagger2 æ³¨è§£ gc.setSwagger2(true); mpg.setGlobalConfig(gc); // æ•°æ®æºé…ç½® DataSourceConfig dsc = new DataSourceConfig(); dsc.setUrl(&quot;jdbc:mysql://localhost:3306/xinguan?useUnicode=true&amp;serveTimezone=UTC&amp;useSSL=false&amp;characterEncoding=utf8&quot;); dsc.setDriverName(&quot;com.mysql.cj.jdbc.Driver&quot;); dsc.setUsername(&quot;root&quot;); dsc.setPassword(&quot;123456&quot;);// è®¾ç½®æ•°æ®åº“ç±»å‹ dsc.setDbType(DbType.MYSQL); mpg.setDataSource(dsc); // åŒ…é…ç½® PackageConfig pc = new PackageConfig(); pc.setModuleName(scanner(&quot;æ¨¡å—å&quot;)); pc.setParent(&quot;com.xiaoliu&quot;); // è®¾ç½®åŒ… pc.setController(&quot;controller&quot;); pc.setService(&quot;service&quot;); pc.setServiceImpl(&quot;service.impl&quot;); pc.setMapper(&quot;mapper&quot;); pc.setEntity(&quot;pojo&quot;); pc.setXml(&quot;mapper&quot;); mpg.setPackageInfo(pc); // ç­–ç•¥é…ç½® StrategyConfig strategy = new StrategyConfig();//è®¾ç½®å“ªäº›è¡¨éœ€è¦è‡ªåŠ¨ç”Ÿæˆ strategy.setInclude(scanner(&quot;è¡¨åï¼Œå¤šä¸ªè‹±æ–‡é€—å·åˆ†å‰²&quot;).split(&quot;,&quot;));//å®ä½“ç±»åç§°é©¼å³°å‘½å strategy.setNaming(NamingStrategy.underline_to_camel);// åˆ—åé©¼å³°å‘½å strategy.setColumnNaming(NamingStrategy.underline_to_camel);// ä½¿ç”¨lombokæ¨¡å‹ strategy.setEntityLombokModel(true);// ä½¿ç”¨restfulé£æ ¼è®¾ç½®api strategy.setRestControllerStyle(true);//é©¼å³°è½¬è¿å­—ç¬¦ strategy.setControllerMappingHyphenStyle(true);// strategy.getFieldPrefix(&quot;å‰ç¼€&quot;); å¯å¿½ç•¥è¡¨ä¸­çš„å‰ç¼€ mpg.setStrategy(strategy); mpg.execute(); &#125;&#125; 3ã€ç»Ÿä¸€è¿”å›ç»“æœåœ¨commoné¡¹ç›®çš„responseç›®å½•ä¸‹ æ¥å£ CustomizeResultCode 1234567891011121314151617181920package com.xiaoliu.response;/** * @author: 61åˆ† * @date: 2022/5/7 12:52 * @description: */public interface CustomizeResultCode &#123; /** * è¿”å›é”™è¯¯ç  * @return */ Integer getCode(); /** * è¿”å›é”™è¯¯ä¿¡æ¯ * @return */ String getMessage();&#125; æšä¸¾ç±»ï¼ˆä¿æŠ¤å±æ€§ï¼‰ ResultCode 123456789101112131415161718192021222324252627282930313233343536373839404142public enum ResultCode implements CustomizeResultCode&#123; /** * 20000ï¼ŒæˆåŠŸ */ SUCCESS(20000,&quot;æˆåŠŸ&quot;), /** * 20001ï¼Œå¤±è´¥ */ ERROR(20001,&quot;å¤±è´¥&quot;), /** * 20002ï¼Œç®—æœ¯å¼‚å¸¸ */ ARITHMETICEXCEPTION(20002,&quot;ç®—æœ¯å¼‚å¸¸&quot;), /** * 20003ï¼Œç”¨æˆ·ä¸å­˜åœ¨ */ USER_NOFOUND_EXCEPTION(20003,&quot;ç”¨æˆ·ä¸å­˜åœ¨&quot;), ; private Integer code; private String message; ResultCode(Integer code,String message)&#123; this.code = code; this.message = message; &#125; @Override public Integer getCode() &#123; return code; &#125; @Override public String getMessage() &#123; return message; &#125;&#125; å®ç°ç±» Result 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273/** * @author: 61åˆ† * @date: 2022/5/7 13:00 * @description:å…¬å…±è¿”å›ç»“æœ */@Datapublic class Result &#123; @ApiModelProperty(value = &quot;æ˜¯å¦æˆåŠŸ&quot;) private boolean success; @ApiModelProperty(value = &quot;è¿”å›ç &quot;) private Integer code; @ApiModelProperty(value = &quot;è¿”å›æ¶ˆæ¯&quot;) private String message; @ApiModelProperty(value = &quot;è¿”å›çš„æ•°æ®&quot;) private Map&lt;String,Object&gt; data = new HashMap&lt;&gt;(); /** * æ„é€ æ–¹æ³•ç§æœ‰ï¼Œä¿æŠ¤å±æ€§ */ private Result()&#123;&#125;; public static Result ok()&#123; Result result = new Result(); result.setSuccess(true); result.setCode(ResultCode.SUCCESS.getCode()); result.setMessage(ResultCode.SUCCESS.getMessage()); return result; &#125;// ä½¿ç”¨é“¾å¼ç¼–ç¨‹ public static Result error()&#123; Result result = new Result(); result.setSuccess(false); result.setCode(ResultCode.ERROR.getCode()); result.setMessage(ResultCode.ERROR.getMessage()); return result; &#125; /** * è‡ªå®šä¹‰è¿”å› * @param success * @return */ public Result success(Boolean success)&#123; this.setSuccess(success); return this; &#125; public Result message(String message)&#123; this.setMessage(message); return this; &#125; public Result code(Integer code)&#123; this.setCode(code); return this; &#125; public Result data(String key,Object value)&#123; this.data.put(key, value); return this; &#125; public Result data(Map&lt;String,Object&gt; map)&#123; this.setData(map); return this; &#125;&#125; 4ã€ç»Ÿä¸€å¼‚å¸¸å¤„ç†commoné¡¹ç›®çš„handlerç›®å½•ä¸‹ å…¨å±€çš„å¼‚å¸¸å¤„ç† GlobalExceptionHandler 12345678910111213141516171819202122232425262728293031/** * @author: 61åˆ† * @date: 2022/5/7 14:52 * @description:ç»Ÿä¸€å¼‚å¸¸å¤„ç† */@ControllerAdvice@Slf4jpublic class GlobalExceptionHandler &#123; @ExceptionHandler(Exception.class) @ResponseBody public Result error(Exception e) &#123; log.error(e.getMessage()); return Result.error(); &#125; @ExceptionHandler(ArithmeticException.class) @ResponseBody public Result error(ArithmeticException e) &#123; log.error(e.getMessage()); return Result.error().code(ResultCode.ARITHMETICEXCEPTION.getCode()) .message(ResultCode.ARITHMETICEXCEPTION.getMessage()); &#125; @ExceptionHandler(BusinessException.class) @ResponseBody public Result error(BusinessException e) &#123; log.error(e.getErrMsg()); return Result.error().code(e.getCode()) .message(e.getErrMsg()); &#125;&#125; è¿”å›çŠ¶æ€ç æ¥å£çš„ä¿¡æ¯ BusinessException 12345678910@Data@AllArgsConstructor@NoArgsConstructorpublic class BusinessException extends RuntimeException&#123; @ApiModelProperty(value = &quot;çŠ¶æ€ç &quot;) private Integer code; @ApiModelProperty(value = &quot;é”™è¯¯ä¿¡æ¯&quot;) private String errMsg;&#125; 5ã€ç»Ÿä¸€æ—¥å¿—å¤„ç†ï¼ˆknife4jç¾åŒ–swagger2ï¼‰éœ€è¦knife4jä¾èµ–ï¼Œ åœ¨commoné¡¹ç›®çš„configç›®å½•ä¸‹ Knife4jConfiguration 1234567891011121314151617181920212223@Configurationpublic class Knife4jConfiguration &#123; @Bean(value = &quot;defaultApi2&quot;) public Docket defaultApi2() &#123; Docket docket=new Docket(DocumentationType.SWAGGER_2) .apiInfo(new ApiInfoBuilder() //.title(&quot;swagger-bootstrap-ui-demo RESTful APIs&quot;) .description(&quot;# swagger-bootstrap-ui-demo RESTful APIs&quot;) .termsOfServiceUrl(&quot;http://www.xx.com/&quot;) .contact(&quot;xx@qq.com&quot;) .version(&quot;1.0&quot;) .build()) //åˆ†ç»„åç§° .groupName(&quot;2.Xç‰ˆæœ¬&quot;) .select() //è¿™é‡ŒæŒ‡å®šControlleræ‰«æåŒ…è·¯å¾„ .apis(RequestHandlerSelectors.basePackage(&quot;com.xiaoliu.system.controller&quot;)) .paths(PathSelectors.any()) .build(); return docket; &#125;&#125; ä¹‹åè®¿é—®xxx&#x2F;doc.html 6ã€ç»Ÿä¸€ç”Ÿæˆçš„æ—¥å¿—ç®¡ç†LogBack 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;&lt;!-- çº§åˆ«ä»é«˜åˆ°ä½ OFF ã€ FATAL ã€ ERROR ã€ WARN ã€ INFO ã€ DEBUG ã€ TRACE ã€ ALL --&gt;&lt;!-- æ—¥å¿—è¾“å‡ºè§„åˆ™ æ ¹æ®å½“å‰ROOT çº§åˆ«ï¼Œæ—¥å¿—è¾“å‡ºæ—¶ï¼Œçº§åˆ«é«˜äºrooté»˜è®¤çš„çº§åˆ«æ—¶ ä¼šè¾“å‡º --&gt;&lt;!-- ä»¥ä¸‹ æ¯ä¸ªé…ç½®çš„ filter æ˜¯è¿‡æ»¤æ‰è¾“å‡ºæ–‡ä»¶é‡Œé¢ï¼Œä¼šå‡ºç°é«˜çº§åˆ«æ–‡ä»¶ï¼Œä¾ç„¶å‡ºç°ä½çº§åˆ«çš„æ—¥å¿—ä¿¡æ¯ï¼Œé€šè¿‡filter è¿‡æ»¤åªè®°å½•æœ¬çº§åˆ«çš„æ—¥å¿— --&gt;&lt;!-- scan å½“æ­¤å±æ€§è®¾ç½®ä¸ºtrueæ—¶ï¼Œé…ç½®æ–‡ä»¶å¦‚æœå‘ç”Ÿæ”¹å˜ï¼Œå°†ä¼šè¢«é‡æ–°åŠ è½½ï¼Œé»˜è®¤å€¼ä¸ºtrueã€‚ --&gt;&lt;!-- scanPeriod è®¾ç½®ç›‘æµ‹é…ç½®æ–‡ä»¶æ˜¯å¦æœ‰ä¿®æ”¹çš„æ—¶é—´é—´éš”ï¼Œå¦‚æœæ²¡æœ‰ç»™å‡ºæ—¶é—´å•ä½ï¼Œé»˜è®¤å•ä½æ˜¯æ¯«ç§’ã€‚å½“scanä¸ºtrueæ—¶ï¼Œæ­¤å±æ€§ç”Ÿæ•ˆã€‚é»˜è®¤çš„æ—¶é—´é—´éš”ä¸º1åˆ†é’Ÿã€‚ --&gt;&lt;!-- debug å½“æ­¤å±æ€§è®¾ç½®ä¸ºtrueæ—¶ï¼Œå°†æ‰“å°å‡ºlogbackå†…éƒ¨æ—¥å¿—ä¿¡æ¯ï¼Œå®æ—¶æŸ¥çœ‹logbackè¿è¡ŒçŠ¶æ€ã€‚é»˜è®¤å€¼ä¸ºfalseã€‚ --&gt;&lt;configuration scan=&quot;true&quot; scanPeriod=&quot;60 seconds&quot; debug=&quot;false&quot;&gt; &lt;!-- åŠ¨æ€æ—¥å¿—çº§åˆ« --&gt; &lt;jmxConfigurator/&gt; &lt;!--*****************************************************************************--&gt; &lt;!--è‡ªå®šä¹‰é¡¹ å¼€å§‹--&gt; &lt;!--*****************************************************************************--&gt; &lt;!-- å®šä¹‰æ—¥å¿—æ–‡ä»¶ è¾“å‡ºä½ç½® --&gt; &lt;property name=&quot;log.home_dir&quot; value=&quot;E:/BliBli/xinguan/logs&quot;/&gt; &lt;property name=&quot;log.app_name&quot; value=&quot;http-demo&quot;/&gt; &lt;!-- æ—¥å¿—æœ€å¤§çš„å†å² 30å¤© --&gt; &lt;property name=&quot;log.maxHistory&quot; value=&quot;30&quot;/&gt; &lt;property name=&quot;log.maxSize&quot; value=&quot;5MB&quot;/&gt; &lt;!-- æ—¥å¿—ç•Œåˆ« --&gt; &lt;property name=&quot;log.level&quot; value=&quot;info&quot;/&gt; &lt;!-- æ‰“å°sqlè¯­å¥ éœ€è¦æŒ‡å®šdao/mapperå±‚åŒ…çš„ä½ç½® --&gt; &lt;property name=&quot;mapper.package&quot; value=&quot;com.xiaoge.system.mapper&quot;/&gt; &lt;!-- å½©è‰²æ—¥å¿— --&gt; &lt;!-- é…ç½®æ ¼å¼å˜é‡ï¼šCONSOLE_LOG_PATTERN å½©è‰²æ—¥å¿—æ ¼å¼ --&gt; &lt;!-- magenta:æ´‹çº¢ --&gt; &lt;!-- boldMagenta:ç²—çº¢--&gt; &lt;!-- cyan:é’è‰² --&gt; &lt;!-- white:ç™½è‰² --&gt; &lt;!-- magenta:æ´‹çº¢ --&gt; &lt;property name=&quot;CONSOLE_LOG_PATTERN&quot; value=&quot;%yellow(%date&#123;yyyy-MM-dd HH:mm:ss&#125;) |%highlight(%-5level) |%blue(%thread) |%blue(%file:%line) |%green(%logger) |%cyan(%msg%n)&quot;/&gt; &lt;!--*****************************************************************************--&gt; &lt;!--è‡ªå®šä¹‰é¡¹ ç»“æŸ--&gt; &lt;!--*****************************************************************************--&gt; &lt;!-- ConsoleAppender æ§åˆ¶å°è¾“å‡ºæ—¥å¿— --&gt; &lt;appender name=&quot;CONSOLE&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt; &lt;encoder&gt; &lt;pattern&gt; &lt;!-- è®¾ç½®æ—¥å¿—è¾“å‡ºæ ¼å¼ --&gt; $&#123;CONSOLE_LOG_PATTERN&#125; &lt;/pattern&gt; &lt;/encoder&gt; &lt;/appender&gt; &lt;!-- ERRORçº§åˆ«æ—¥å¿— --&gt; &lt;!-- æ»šåŠ¨è®°å½•æ–‡ä»¶ï¼Œå…ˆå°†æ—¥å¿—è®°å½•åˆ°æŒ‡å®šæ–‡ä»¶ï¼Œå½“ç¬¦åˆæŸä¸ªæ¡ä»¶æ—¶ï¼Œå°†æ—¥å¿—è®°å½•åˆ°å…¶ä»–æ–‡ä»¶ RollingFileAppender --&gt; &lt;appender name=&quot;ERROR&quot; class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt; &lt;!-- è¿‡æ»¤å™¨ï¼Œåªè®°å½•WARNçº§åˆ«çš„æ—¥å¿— --&gt; &lt;!-- æœæ—¥å¿—çº§åˆ«ç­‰äºé…ç½®çº§åˆ«ï¼Œè¿‡æ»¤å™¨ä¼šæ ¹æ®onMath å’Œ onMismatchæ¥æ”¶æˆ–æ‹’ç»æ—¥å¿—ã€‚ --&gt; &lt;filter class=&quot;ch.qos.logback.classic.filter.LevelFilter&quot;&gt; &lt;!-- è®¾ç½®è¿‡æ»¤çº§åˆ« --&gt; &lt;level&gt;ERROR&lt;/level&gt; &lt;!-- ç”¨äºé…ç½®ç¬¦åˆè¿‡æ»¤æ¡ä»¶çš„æ“ä½œ --&gt; &lt;onMatch&gt;ACCEPT&lt;/onMatch&gt; &lt;!-- ç”¨äºé…ç½®ä¸ç¬¦åˆè¿‡æ»¤æ¡ä»¶çš„æ“ä½œ --&gt; &lt;onMismatch&gt;DENY&lt;/onMismatch&gt; &lt;/filter&gt; &lt;!-- æœ€å¸¸ç”¨çš„æ»šåŠ¨ç­–ç•¥ï¼Œå®ƒæ ¹æ®æ—¶é—´æ¥åˆ¶å®šæ»šåŠ¨ç­–ç•¥.æ—¢è´Ÿè´£æ»šåŠ¨ä¹Ÿè´Ÿè´£è§¦å‘æ»šåŠ¨ --&gt; &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt; &lt;!--æ—¥å¿—è¾“å‡ºä½ç½® å¯ç›¸å¯¹ã€å’Œç»å¯¹è·¯å¾„ --&gt; &lt;fileNamePattern&gt; $&#123;log.home_dir&#125;/error/%d&#123;yyyy-MM-dd&#125;/$&#123;log.app_name&#125;-%i.log &lt;/fileNamePattern&gt; &lt;!-- å¯é€‰èŠ‚ç‚¹ï¼Œæ§åˆ¶ä¿ç•™çš„å½’æ¡£æ–‡ä»¶çš„æœ€å¤§æ•°é‡ï¼Œè¶…å‡ºæ•°é‡å°±åˆ é™¤æ—§æ–‡ä»¶,å‡è®¾è®¾ç½®æ¯ä¸ªæœˆæ»šåŠ¨ï¼Œä¸”&lt;maxHistory&gt;æ˜¯6ï¼Œ åˆ™åªä¿å­˜æœ€è¿‘6ä¸ªæœˆçš„æ–‡ä»¶ï¼Œåˆ é™¤ä¹‹å‰çš„æ—§æ–‡ä»¶ã€‚æ³¨æ„ï¼Œåˆ é™¤æ—§æ–‡ä»¶æ˜¯ï¼Œé‚£äº›ä¸ºäº†å½’æ¡£è€Œåˆ›å»ºçš„ç›®å½•ä¹Ÿä¼šè¢«åˆ é™¤ --&gt; &lt;maxHistory&gt;$&#123;log.maxHistory&#125;&lt;/maxHistory&gt; &lt;!--æ—¥å¿—æ–‡ä»¶æœ€å¤§çš„å¤§å°--&gt; &lt;MaxFileSize&gt;$&#123;log.maxSize&#125;&lt;/MaxFileSize&gt; &lt;/rollingPolicy&gt; &lt;encoder&gt; &lt;pattern&gt; &lt;!-- è®¾ç½®æ—¥å¿—è¾“å‡ºæ ¼å¼ --&gt; %d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n &lt;/pattern&gt; &lt;/encoder&gt; &lt;/appender&gt; &lt;!-- WARNçº§åˆ«æ—¥å¿— appender --&gt; &lt;appender name=&quot;WARN&quot; class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt; &lt;!-- è¿‡æ»¤å™¨ï¼Œåªè®°å½•WARNçº§åˆ«çš„æ—¥å¿— --&gt; &lt;!-- æœæ—¥å¿—çº§åˆ«ç­‰äºé…ç½®çº§åˆ«ï¼Œè¿‡æ»¤å™¨ä¼šæ ¹æ®onMath å’Œ onMismatchæ¥æ”¶æˆ–æ‹’ç»æ—¥å¿—ã€‚ --&gt; &lt;filter class=&quot;ch.qos.logback.classic.filter.LevelFilter&quot;&gt; &lt;!-- è®¾ç½®è¿‡æ»¤çº§åˆ« --&gt; &lt;level&gt;WARN&lt;/level&gt; &lt;!-- ç”¨äºé…ç½®ç¬¦åˆè¿‡æ»¤æ¡ä»¶çš„æ“ä½œ --&gt; &lt;onMatch&gt;ACCEPT&lt;/onMatch&gt; &lt;!-- ç”¨äºé…ç½®ä¸ç¬¦åˆè¿‡æ»¤æ¡ä»¶çš„æ“ä½œ --&gt; &lt;onMismatch&gt;DENY&lt;/onMismatch&gt; &lt;/filter&gt; &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt; &lt;!--æ—¥å¿—è¾“å‡ºä½ç½® å¯ç›¸å¯¹ã€å’Œç»å¯¹è·¯å¾„ --&gt; &lt;fileNamePattern&gt;$&#123;log.home_dir&#125;/warn/%d&#123;yyyy-MM-dd&#125;/$&#123;log.app_name&#125;-%i.log&lt;/fileNamePattern&gt; &lt;maxHistory&gt;$&#123;log.maxHistory&#125;&lt;/maxHistory&gt; &lt;!--å½“å¤©çš„æ—¥å¿—å¤§å° è¶…è¿‡MaxFileSizeæ—¶,å‹ç¼©æ—¥å¿—å¹¶ä¿å­˜--&gt; &lt;MaxFileSize&gt;$&#123;log.maxSize&#125;&lt;/MaxFileSize&gt; &lt;/rollingPolicy&gt; &lt;encoder&gt; &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n&lt;/pattern&gt; &lt;/encoder&gt; &lt;/appender&gt; &lt;!-- INFOçº§åˆ«æ—¥å¿— appender --&gt; &lt;appender name=&quot;INFO&quot; class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt; &lt;filter class=&quot;ch.qos.logback.classic.filter.LevelFilter&quot;&gt; &lt;level&gt;INFO&lt;/level&gt; &lt;onMatch&gt;ACCEPT&lt;/onMatch&gt; &lt;onMismatch&gt;DENY&lt;/onMismatch&gt; &lt;/filter&gt; &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt; &lt;fileNamePattern&gt;$&#123;log.home_dir&#125;/info/%d&#123;yyyy-MM-dd&#125;/$&#123;log.app_name&#125;-%i.log&lt;/fileNamePattern&gt; &lt;maxHistory&gt;$&#123;log.maxHistory&#125;&lt;/maxHistory&gt; &lt;MaxFileSize&gt;$&#123;log.maxSize&#125;&lt;/MaxFileSize&gt; &lt;/rollingPolicy&gt; &lt;encoder&gt; &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%-5level] %logger - %msg%n&lt;/pattern&gt; &lt;/encoder&gt; &lt;/appender&gt; &lt;!-- DEBUGçº§åˆ«æ—¥å¿— appender --&gt; &lt;appender name=&quot;DEBUG&quot; class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt; &lt;filter class=&quot;ch.qos.logback.classic.filter.LevelFilter&quot;&gt; &lt;level&gt;DEBUG&lt;/level&gt; &lt;onMatch&gt;ACCEPT&lt;/onMatch&gt; &lt;onMismatch&gt;DENY&lt;/onMismatch&gt; &lt;/filter&gt; &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt; &lt;fileNamePattern&gt;$&#123;log.home_dir&#125;/debug/%d&#123;yyyy-MM-dd&#125;/$&#123;log.app_name&#125;-%i.log&lt;/fileNamePattern&gt; &lt;maxHistory&gt;$&#123;log.maxHistory&#125;&lt;/maxHistory&gt; &lt;MaxFileSize&gt;$&#123;log.maxSize&#125;&lt;/MaxFileSize&gt; &lt;/rollingPolicy&gt; &lt;encoder&gt; &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%-5level] %logger - %msg%n&lt;/pattern&gt; &lt;/encoder&gt; &lt;/appender&gt; &lt;!-- TRACEçº§åˆ«æ—¥å¿— appender --&gt; &lt;appender name=&quot;TRACE&quot; class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt; &lt;filter class=&quot;ch.qos.logback.classic.filter.LevelFilter&quot;&gt; &lt;level&gt;TRACE&lt;/level&gt; &lt;onMatch&gt;ACCEPT&lt;/onMatch&gt; &lt;onMismatch&gt;DENY&lt;/onMismatch&gt; &lt;/filter&gt; &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt; &lt;fileNamePattern&gt;$&#123;log.home_dir&#125;/trace/%d&#123;yyyy-MM-dd&#125;/$&#123;log.app_name&#125;-%i.log&lt;/fileNamePattern&gt; &lt;maxHistory&gt;$&#123;log.maxHistory&#125;&lt;/maxHistory&gt; &lt;MaxFileSize&gt;$&#123;log.maxSize&#125;&lt;/MaxFileSize&gt; &lt;/rollingPolicy&gt; &lt;encoder&gt; &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%-5level] %logger - %msg%n&lt;/pattern&gt; &lt;/encoder&gt; &lt;/appender&gt; &lt;!--è®¾ç½®ä¸€ä¸ªå‘ä¸Šä¼ é€’çš„appender,æ‰€æœ‰çº§åˆ«çš„æ—¥å¿—éƒ½ä¼šè¾“å‡º--&gt; &lt;appender name=&quot;app&quot; class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt; &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt; &lt;fileNamePattern&gt;$&#123;log.home_dir&#125;/app/%d&#123;yyyy-MM-dd&#125;/$&#123;log.app_name&#125;-%i.log&lt;/fileNamePattern&gt; &lt;maxHistory&gt;$&#123;log.maxHistory&#125;&lt;/maxHistory&gt; &lt;MaxFileSize&gt;$&#123;log.maxSize&#125;&lt;/MaxFileSize&gt; &lt;/rollingPolicy&gt; &lt;encoder&gt; &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%-5level] %logger - %msg%n&lt;/pattern&gt; &lt;/encoder&gt; &lt;/appender&gt; &lt;!--org.springframework.webåŒ…ä¸‹çš„ç±»çš„æ—¥å¿—è¾“å‡º--&gt; &lt;logger name=&quot;org.springframework.web&quot; additivity=&quot;false&quot; level=&quot;WARN&quot;&gt; &lt;appender-ref ref=&quot;WARN&quot;/&gt; &lt;/logger&gt; &lt;!--daoå±‚åŒ…ä¸‹çš„ç±»çš„æ—¥å¿—è¾“å‡º--&gt; &lt;logger name=&quot;$&#123;mapper.package&#125;&quot; additivity=&quot;false&quot; level=&quot;DEBUG&quot;&gt; &lt;appender-ref ref=&quot;app&quot;/&gt; &lt;appender-ref ref=&quot;ERROR&quot;/&gt; &lt;!--æ‰“å°æ§åˆ¶å°--&gt; &lt;appender-ref ref=&quot;CONSOLE&quot;/&gt; &lt;/logger&gt; &lt;!-- rootçº§åˆ« DEBUG --&gt; &lt;root&gt; &lt;!-- æ‰“å°debugçº§åˆ«æ—¥å¿—åŠä»¥ä¸Šçº§åˆ«æ—¥å¿— --&gt; &lt;level value=&quot;$&#123;log.level&#125;&quot;/&gt; &lt;!-- æ§åˆ¶å°è¾“å‡º --&gt; &lt;appender-ref ref=&quot;CONSOLE&quot;/&gt; &lt;!-- ä¸ç®¡ä»€ä¹ˆåŒ…ä¸‹çš„æ—¥å¿—éƒ½è¾“å‡ºæ–‡ä»¶ --&gt; &lt;appender-ref ref=&quot;ERROR&quot;/&gt; &lt;appender-ref ref=&quot;INFO&quot;/&gt; &lt;appender-ref ref=&quot;WARN&quot;/&gt; &lt;appender-ref ref=&quot;DEBUG&quot;/&gt; &lt;appender-ref ref=&quot;TRACE&quot;/&gt; &lt;/root&gt;&lt;/configuration&gt; 7ã€åå°æ•°æ®åˆ†é¡µæŸ¥è¯¢éœ€è¦mybatis-plusçš„åˆ†é¡µæ’ä»¶ åœ¨commoné¡¹ç›®ä¸‹çš„configç›®å½•ä¸‹ 123456789101112131415161718@Configurationpublic class MybatisPlusConfig &#123; /** * æ–°çš„åˆ†é¡µæ’ä»¶,ä¸€ç¼“å’ŒäºŒç¼“éµå¾ªmybatisçš„è§„åˆ™,éœ€è¦è®¾ç½® MybatisConfiguration#useDeprecatedExecutor = false é¿å…ç¼“å­˜å‡ºç°é—®é¢˜(è¯¥å±æ€§ä¼šåœ¨æ—§æ’ä»¶ç§»é™¤åä¸€åŒç§»é™¤) */ @Bean public MybatisPlusInterceptor mybatisPlusInterceptor() &#123; MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor(); interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.H2)); return interceptor; &#125; @Bean public ConfigurationCustomizer configurationCustomizer() &#123; return configuration -&gt; configuration.setUseDeprecatedExecutor(false); &#125;&#125; åˆ†é¡µæŸ¥è¯¢çš„controller 12345678910@GetMapping(&quot;/findUserList&quot;) public Result findUserList(@RequestParam(defaultValue = &quot;1&quot;)Integer current, @RequestParam(defaultValue = &quot;7&quot;)Integer size)&#123;// å¯¹ç”¨æˆ·åˆ†é¡µï¼Œæ³›å‹ä¸­æ³¨å…¥çš„æ˜¯ç”¨æˆ·å®ä½“ç±» Page&lt;User&gt; page = new Page&lt;&gt;(current,size); Page&lt;User&gt; userPage = userService.page(page); long total = userPage.getTotal(); List&lt;User&gt; records = userPage.getRecords(); return Result.ok().data(&quot;total&quot;,total).data(&quot;records&quot;,records); &#125;; 8ã€ä½¿ç”¨axiosè¯·æ±‚åå°æ¥å£å¼•å…¥axios npm install axios åœ¨å‰ç«¯é¡¹ç›®ä¸­æ–°å»ºä¸€ä¸ªutilsåŒ… request.js 12345678import axios from &#x27;axios&#x27;const instance = axios.create(&#123; baseURL: &#x27;http://localhost:8081&#x27;, timeout: 3000, &#125;); export default instance æ–°å»ºapiåŒ… users.js 12345678910import request from &#x27;../utils/request&#x27;// åé¢æ¯æ¬¡è¯·æ±‚éƒ½æ˜¯æºå¸¦tokençš„export const findUserList =()=&gt;&#123; return request(&#123; url: &quot;/user/findUserList&quot;, method: &#x27;get&#x27;, &#125;)&#125; åœ¨Uses.vueç»„ä»¶ä¸­ æ·»åŠ è·å–ç”¨æˆ·åˆ—è¡¨çš„æ–¹æ³•,å¹¶åœ¨æ§åˆ¶å°æ‰“å° 1234async getUserList()&#123; const &#123;data&#125; = await findUserList() console.log(data); &#125; é’©å­å‡½æ•°åŠ è½½ 123created()&#123; this.getUserList(); &#125;, 9ã€è·¨åŸŸé—®é¢˜ Access-Control-Allow-Origin 9.1ã€nginxåå‘ä»£ç†è§£å†³è·¨åŸŸ9.2ã€jsonpè§£å†³è·¨åŸŸï¼ˆaxiosä¸æ”¯æŒï¼‰9.3ã€springbootçš„@CrossOrign9.4ã€é…ç½®webmvcconfigureè§£å†³è·¨åŸŸ123456789101112131415@Configurationpublic class CrosConfig implements WebMvcConfigurer &#123; /** * * @param registry */ @Override public void addCorsMappings(CorsRegistry registry) &#123; registry.addMapping(&quot;/**&quot;).allowedOrigins(&quot;*&quot;) .allowedMethods(&quot;GET&quot;,&quot;POST&quot;,&quot;PUT&quot;,&quot;OPTIONS&quot;,&quot;HEAD&quot;) .allowCredentials(true) .maxAge(3600) .allowedHeaders(&quot;*&quot;); &#125;&#125; 10ã€ç”¨æˆ·æ•°æ®ç»‘å®šåŠåˆ†é¡µå±•ç¤º11ã€mybatispluså®ç°å¤šè¡¨è”æŸ¥ï¼ˆç”¨æˆ·éƒ¨é—¨ï¼‰12ã€ç¼–å†™æ·»åŠ ç”¨æˆ·ç•Œé¢13ã€å®ç°å¤´åƒä¸Šä¼ é˜¿é‡Œäº‘çš„OSS éœ€è¦joda-timeä¾èµ– 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475 //è·å–ä¸Šä¼ çš„æ–‡ä»¶æµ InputStream inputStream = file.getInputStream();// ä¿è¯æ–‡ä»¶åä¸ç›¸åŒ uuid redisåˆ†å¸ƒå¼ID é›ªèŠ±ç®—æ³• æ–¹ä¾¿åŒºåˆ† æ–‡ä»¶æ ¼å¼ yyyy/MM/dd+uuid// æ„å»ºæ—¥æœŸæ–‡ä»¶å¤¹çš„è·¯å¾„ avatar/2022/5/14 æ–‡ä»¶å String datePath = new DateTime().toString(&quot;yyyy/MM/dd&quot;);// è·å–æ–‡ä»¶çš„åç§° String original = file.getOriginalFilename();// è·å–uuid String fileName = UUID.randomUUID().toString().replaceAll(&quot;-&quot;, &quot;/&quot;);// è·å¾—æ–‡ä»¶ä¸Šä¼ çš„æ‰©å±•å .jpg String fileType = original.substring(original.lastIndexOf(&quot;.&quot;));// æ‹¼æ¥æ–‡ä»¶åç§° cfbf6d34d3e4465386f0e33d4595d52b.jpg String newName = fileName + fileType;// ç”Ÿæˆæ–‡ä»¶å¤¹ avatar/2022/5/14 + cfbf6d34d3e4465386f0e33d4595d52b.jpg fileName = datePath + &quot;/&quot; + newName;// ä¸Šä¼ æ–‡ä»¶ ossClient.putObject(bucketName, fileName,inputStream); //é»˜è®¤åå¹´ä¸è¿‡æœŸ Date expiration = new Date(System.currentTimeMillis() + 3600L * 1000 * 24 * 365 * 10); //bucketåç§° æ–‡ä»¶å è¿‡æœŸæ—¶é—´ uploadUrl = ossClient.generatePresignedUrl(bucketName, fileName, expiration).toString(); //è·å–urlåœ°å€ //uploadUrl = &quot;https://&quot; + bucketName + &quot;.&quot; + endPoint + &quot;/&quot; + fileName; return uploadUrl.substring(0, uploadUrl.indexOf(&quot;?&quot;)); ä¸èƒ½ç›´æ¥è¿”å›uploadUrl éœ€è¦å»é™¤ï¼Ÿåé¢çš„ç­¾åä¿¡æ¯ /** * Description: åˆ¤æ–­OSSæœåŠ¡æ–‡ä»¶ä¸Šä¼ æ—¶æ–‡ä»¶çš„contentType * * @param FilenameExtension æ–‡ä»¶åç¼€ * @return String */ public static String getcontentType(String FilenameExtension) &#123; if (FilenameExtension.equalsIgnoreCase(&quot;.bmp&quot;)) &#123; return &quot;image/bmp&quot;; &#125; if (FilenameExtension.equalsIgnoreCase(&quot;.gif&quot;)) &#123; return &quot;image/gif&quot;; &#125; if (FilenameExtension.equalsIgnoreCase(&quot;.jpeg&quot;) || FilenameExtension.equalsIgnoreCase(&quot;.jpg&quot;) || FilenameExtension.equalsIgnoreCase(&quot;.png&quot;)) &#123; return &quot;image/jpg&quot;; &#125; if (FilenameExtension.equalsIgnoreCase(&quot;.html&quot;)) &#123; return &quot;text/html&quot;; &#125; if (FilenameExtension.equalsIgnoreCase(&quot;.txt&quot;)) &#123; return &quot;text/plain&quot;; &#125; if (FilenameExtension.equalsIgnoreCase(&quot;.vsd&quot;)) &#123; return &quot;application/vnd.visio&quot;; &#125; if (FilenameExtension.equalsIgnoreCase(&quot;.pptx&quot;) || FilenameExtension.equalsIgnoreCase(&quot;.ppt&quot;)) &#123; return &quot;application/vnd.ms-powerpoint&quot;; &#125; if (FilenameExtension.equalsIgnoreCase(&quot;.docx&quot;) || FilenameExtension.equalsIgnoreCase(&quot;.doc&quot;)) &#123; return &quot;application/msword&quot;; &#125; if (FilenameExtension.equalsIgnoreCase(&quot;.xml&quot;)) &#123; return &quot;text/xml&quot;; &#125; return &quot;image/jpg&quot;; &#125;","categories":[],"tags":[]},{"title":"é¡¹ç›®-å‰ç«¯","slug":"5-5/é¡¹ç›®_å‰ç«¯","date":"2022-05-05T13:24:25.055Z","updated":"2022-05-09T05:28:05.769Z","comments":true,"path":"2022/05/05/5-5/é¡¹ç›®_å‰ç«¯/","link":"","permalink":"https://dddwah11.github.io/2022/05/05/5-5/%E9%A1%B9%E7%9B%AE_%E5%89%8D%E7%AB%AF/","excerpt":"","text":"æ­å¥½å‰ç«¯è„šæ‰‹æ¶router,vuex,elementpuls, é…ç½®å…¨å±€æ ·å¼cssæ–‡ä»¶ä¸‹ 123456/* å…¨å±€æ ·å¼è¡¨ */html,bodyï¼Œ#app&#123; height: 100%; margin: 0; padding: 0;&#125; main.jsä¸‹ 1import &#x27;@/assets/css/global.css&#x27; 1ã€ç™»å½•é¡µé¢ä½¿ç”¨less å®‰è£… 1npm install --save-dev less-loader less 1&lt;style lang=&quot;less&quot;&gt;&lt;/style&gt; vue3ä½¿ç”¨å›¾æ ‡éœ€è¦å…¨å±€æ³¨å†Œç»„ä»¶ 1npm install @element-plus/icons-vue main.jsä¸­ 1234import * as ElementPlusIconsVue from &#x27;@element-plus/icons-vue&#x27;for (const [key, component] of Object.entries(ElementPlusIconsVue)) &#123; app.component(key, component)&#125; ç›´æ¥å¼•ç”¨ ä½¿ç”¨iconçš„æ–¹æ³• 1import &#123; Avatar, Lock &#125; from &quot;@element-plus/icons-vue&quot;; 123456setup()&#123; return &#123; Avatar, Lock &#125; &#125; è¾“å…¥æ¡†ä¸­å¼•ç”¨ 12è´¦å· prefix-icon=&quot;Avatar&quot;å¯†ç  prefix-icon=&quot;Lock&quot; login.vueç™»å½•é¡µé¢ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157&lt;template&gt; &lt;!-- ç™»å½•å®¹å™¨ --&gt; &lt;div class=&quot;login_container&quot;&gt; &lt;!-- ç™»å½•åŒºåŸŸ --&gt; &lt;div class=&quot;login_box&quot;&gt; &lt;!-- å¤´åƒ --&gt; &lt;div class=&quot;avatar_box&quot;&gt; &lt;img src=&quot;@/assets/src.jpeg&quot; /&gt; &lt;/div&gt; &lt;!-- è¡¨å• --&gt; &lt;el-form :model=&quot;loginForm&quot; :rules=&quot;loginrules&quot; ref=&quot;loginForm&quot; label-width=&quot;0px&quot; class=&quot;login_form&quot; &gt; &lt;el-form-item prop=&quot;username&quot;&gt; &lt;el-input v-model=&quot;loginForm.username&quot; prefix-icon=&quot;Avatar&quot; &gt;&lt;/el-input&gt; &lt;/el-form-item&gt; &lt;el-form-item prop=&quot;password&quot;&gt; &lt;el-input v-model=&quot;loginForm.password&quot; prefix-icon=&quot;Lock&quot; type=&quot;password&quot; &gt;&lt;/el-input&gt; &lt;/el-form-item&gt; &lt;el-form-item prop=&quot;verifyCode&quot;&gt; &lt;el-input v-model=&quot;loginForm.verifyCode&quot; prefix-icon=&quot;Iphone&quot; class=&quot;verify_code&quot; &gt;&lt;/el-input&gt; &lt;img src=&quot;@/assets/msFvb6.gif&quot; class=&quot;verify_img&quot; /&gt; &lt;/el-form-item&gt; &lt;el-form-item class=&quot;login_btn&quot;&gt; &lt;el-button type=&quot;primary&quot; @click=&quot;submitForm(&#x27;loginForm&#x27;)&quot; &gt;ç™»å½•&lt;/el-button &gt; &lt;el-button @click=&quot;resetForm(&#x27;loginForm&#x27;)&quot;&gt;é‡ç½®&lt;/el-button&gt; &lt;/el-form-item&gt; &lt;/el-form&gt; &lt;/div&gt; &lt;/div&gt;&lt;/template&gt;&lt;script&gt;import &#123; Avatar, Lock, Iphone &#125; from &quot;@element-plus/icons-vue&quot;;export default &#123; setup() &#123; return &#123; Avatar, Lock, Iphone, &#125;; &#125;, data() &#123; return &#123; loginForm: &#123; username: &quot;&quot;, password: &quot;&quot;, verifyCode: &quot;&quot;, &#125;, loginrules: &#123; username: [ &#123; required: true, message: &quot;è¯·è¾“å…¥è´¦å·&quot;, trigger: &quot;blur&quot; &#125;, &#123; min: 3, max: 16, message: &quot;é•¿åº¦åœ¨ 3 åˆ° 16 ä¸ªå­—ç¬¦&quot;, trigger: &quot;blur&quot;, &#125;, ], password: [ &#123; required: true, message: &quot;è¯·è¾“å…¥å¯†ç &quot;, trigger: &quot;blur&quot; &#125;, &#123; min: 3, max: 16, message: &quot;é•¿åº¦åœ¨ 3 åˆ° 16 ä¸ªå­—ç¬¦&quot;, trigger: &quot;blur&quot;, &#125;, ], verifyCode: [ &#123; required: true, message: &quot;è¯·è¾“å…¥éªŒè¯ç &quot;, trigger: &quot;blur&quot; &#125;, &#123; min: 3, max: 16, trigger: &quot;blur&quot;, &#125;, ], &#125;, &#125;; &#125;, methods: &#123; submitForm(formName) &#123; this.$refs[formName].validate((valid) =&gt; &#123; if (valid) &#123; alert(&quot;submit!&quot;); &#125; else &#123; console.log(&quot;error submit!!&quot;); return false; &#125; &#125;); &#125;, resetForm(formName) &#123; this.$refs[formName].resetFields(); &#125;, &#125;,&#125;;&lt;/script&gt;&lt;style lang=&#x27;less&#x27; scoped&gt;.login_container &#123; height: 100%; background-color: aquamarine;&#125;.login_box &#123; width: 450px; height: 380px; background-color: #ffffff; border-radius: 3px; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); .avatar_box &#123; width: 130px; height: 130px; border: 1px solid #eeeeee; border-radius: 50%; padding: 10px; box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1); margin: -65px auto; background: #ffffff; img &#123; width: 100%; height: 100%; border-radius: 50%; background-color: #eeeeee; &#125; &#125; .login_form &#123; position: absolute; bottom: 0px; width: 100%; &#125; .login_btn &#123; display: flex; justify-content: flex-end; &#125; .verify_code &#123; width: 60%; &#125;&#125;&lt;/style&gt; 2ã€Mainé¡µé¢é¼ æ ‡æ”¾ä¸Šå›¾ç‰‡æ‹‰ä¸‹èœå• 123456.el-dropdown-menu,img&#123; height: 60px; width: 60px; border-radius: 50%; &#125; 1234567891011&lt;el-dropdown&gt; &lt;!-- å³è¾¹å¤´åƒ --&gt; &lt;img src=&quot;@/assets/src.jpeg&quot; /&gt; &lt;!-- ä¸‹æ‹‰èœå• --&gt; &lt;template #dropdown&gt; &lt;el-dropdown-menu&gt; &lt;el-dropdown-item icon=&quot;HomeFilled&quot;&gt;ç³»ç»Ÿä¸»é¡µ&lt;/el-dropdown-item&gt; &lt;el-dropdown-item icon=&quot;Warning&quot;&gt;é€€å‡ºç™»å½•&lt;/el-dropdown-item&gt; &lt;/el-dropdown-menu&gt; &lt;/template&gt; &lt;/el-dropdown&gt; æ³¨æ„ï¼šå»é™¤ä¾§è¾¹æ å±•å¼€å¤šå‡ºçš„è¾¹ç¼˜ï¼Œ 123.el-menu-vertical-demo&#123; border-right: none;&#125; Main.vueé¡µé¢ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429&lt;template&gt; &lt;el-container class=&quot;main_container&quot;&gt; &lt;el-header&gt; &lt;div class=&quot;left_box&quot;&gt; &lt;!-- å·¦è¾¹å¤´åƒ --&gt; &lt;img src=&quot;@/assets/src.jpeg&quot; /&gt; &lt;span&gt;ç³»ç»Ÿ&lt;/span&gt; &lt;/div&gt; &lt;div class=&quot;right_box&quot;&gt; &lt;el-dropdown&gt; &lt;!-- å³è¾¹å¤´åƒ --&gt; &lt;img src=&quot;@/assets/src.jpeg&quot; /&gt; &lt;!-- ä¸‹æ‹‰èœå• --&gt; &lt;template #dropdown&gt; &lt;el-dropdown-menu&gt; &lt;el-dropdown-item icon=&quot;HomeFilled&quot;&gt;ç³»ç»Ÿä¸»é¡µ&lt;/el-dropdown-item&gt; &lt;el-dropdown-item icon=&quot;Warning&quot;&gt;é€€å‡ºç™»å½•&lt;/el-dropdown-item&gt; &lt;/el-dropdown-menu&gt; &lt;/template&gt; &lt;/el-dropdown&gt; &lt;/div&gt; &lt;/el-header&gt; &lt;el-container&gt; &lt;!-- ä¾§è¾¹æ  --&gt; &lt;el-aside :width=&quot;iscollapse?&#x27;60px&#x27;:&#x27;200px&#x27;&quot;&gt; &lt;!-- å±•å¼€æ”¶èµ· --&gt; &lt;div class=&quot;toggle_box&quot; @click=&quot;toggleiscollapse&quot;&gt;|||&lt;/div&gt; &lt;el-menu active-text-color=&quot;#ffd04b&quot; background-color=&quot;#001529&quot; class=&quot;el-menu-vertical-demo&quot; :collapse=&quot;iscollapse&quot; :collapse-transition=&quot;iscollapsetransition&quot; :router=&quot;true&quot; default-active=&quot;2&quot; text-color=&quot;#fff&quot; @open=&quot;handleOpen&quot; @close=&quot;handleClose&quot; &gt; &lt;MenuTree :menuList=&quot;this.MenuList&quot;&gt;&lt;/MenuTree&gt; &lt;/el-menu&gt; &lt;/el-aside&gt; &lt;el-main&gt; &lt;router-view/&gt; &lt;/el-main&gt; &lt;/el-container&gt; &lt;/el-container&gt;&lt;/template&gt;&lt;script&gt;import MenuTree from &#x27;@/components/MenuTree.vue&#x27;export default &#123; name: &quot;Main&quot;, data() &#123; return &#123; iscollapse: false, iscollapsetransition: false, MenuList: [ &#123; &quot;id&quot;: 1, &quot;parentId&quot;: 0, &quot;menuName&quot;: &quot;ç³»ç»Ÿç®¡ç†&quot;, &quot;url&quot;: &quot;&quot;, &quot;icon&quot;: &quot;el-icon-setting&quot;, &quot;orderNum&quot;: 1, &quot;open&quot;: 1, &quot;disabled&quot;: false, &quot;perms&quot;: null, &quot;type&quot;: 0, &quot;children&quot;: [ &#123; &quot;id&quot;: 253, &quot;parentId&quot;: 1, &quot;menuName&quot;: &quot;æ¬¢è¿é¡µé¢&quot;, &quot;url&quot;: &quot;/welcome&quot;, &quot;icon&quot;: &quot;el-icon-star-off&quot;, &quot;orderNum&quot;: 1, &quot;open&quot;: 0, &quot;disabled&quot;: false, &quot;perms&quot;: &quot;welcome:view&quot;, &quot;type&quot;: 0, &quot;children&quot;: [] &#125;, &#123; &quot;id&quot;: 226, &quot;parentId&quot;: 1, &quot;menuName&quot;: &quot;ç”¨æˆ·ç®¡ç†&quot;, &quot;url&quot;: &quot;/users&quot;, &quot;icon&quot;: &quot;el-icon-user&quot;, &quot;orderNum&quot;: 2, &quot;open&quot;: 0, &quot;disabled&quot;: false, &quot;perms&quot;: &quot;users&quot;, &quot;type&quot;: 0, &quot;children&quot;: [] &#125;, &#123; &quot;id&quot;: 321, &quot;parentId&quot;: 1, &quot;menuName&quot;: &quot;é™„ä»¶ç®¡ç†&quot;, &quot;url&quot;: &quot;/attachments&quot;, &quot;icon&quot;: &quot;el-icon-picture-outline&quot;, &quot;orderNum&quot;: 2, &quot;open&quot;: 1, &quot;disabled&quot;: false, &quot;perms&quot;: &quot;&quot;, &quot;type&quot;: 0, &quot;children&quot;: [] &#125;, &#123; &quot;id&quot;: 4, &quot;parentId&quot;: 1, &quot;menuName&quot;: &quot;èœå•æƒé™&quot;, &quot;url&quot;: &quot;/menus&quot;, &quot;icon&quot;: &quot;el-icon-help&quot;, &quot;orderNum&quot;: 3, &quot;open&quot;: 0, &quot;disabled&quot;: false, &quot;perms&quot;: null, &quot;type&quot;: 0, &quot;children&quot;: [] &#125;, &#123; &quot;id&quot;: 235, &quot;parentId&quot;: 1, &quot;menuName&quot;: &quot;è§’è‰²ç®¡ç†&quot;, &quot;url&quot;: &quot;/roles&quot;, &quot;icon&quot;: &quot;el-icon-postcard&quot;, &quot;orderNum&quot;: 3, &quot;open&quot;: 0, &quot;disabled&quot;: false, &quot;perms&quot;: &quot;&quot;, &quot;type&quot;: 0, &quot;children&quot;: [] &#125;, &#123; &quot;id&quot;: 261, &quot;parentId&quot;: 1, &quot;menuName&quot;: &quot;éƒ¨é—¨ç®¡ç†&quot;, &quot;url&quot;: &quot;/departments&quot;, &quot;icon&quot;: &quot;el-icon-s-home&quot;, &quot;orderNum&quot;: 3, &quot;open&quot;: 0, &quot;disabled&quot;: false, &quot;perms&quot;: &quot;&quot;, &quot;type&quot;: 0, &quot;children&quot;: [] &#125;, &#123; &quot;id&quot;: 319, &quot;parentId&quot;: 1, &quot;menuName&quot;: &quot;å…¬å‘Šç®¡ç†&quot;, &quot;url&quot;: &quot;/notices&quot;, &quot;icon&quot;: &quot;el-icon-s-flag&quot;, &quot;orderNum&quot;: 4, &quot;open&quot;: 0, &quot;disabled&quot;: true, &quot;perms&quot;: &quot;&quot;, &quot;type&quot;: 0, &quot;children&quot;: [] &#125; ] &#125;, &#123; &quot;id&quot;: 303, &quot;parentId&quot;: 0, &quot;menuName&quot;: &quot;å¥åº·æŠ¥å¤‡&quot;, &quot;url&quot;: &quot;&quot;, &quot;icon&quot;: &quot;el-icon-platform-eleme&quot;, &quot;orderNum&quot;: 3, &quot;open&quot;: 0, &quot;disabled&quot;: false, &quot;perms&quot;: &quot;&quot;, &quot;type&quot;: 0, &quot;children&quot;: [ &#123; &quot;id&quot;: 273, &quot;parentId&quot;: 303, &quot;menuName&quot;: &quot;å…¨å›½ç–«æƒ…&quot;, &quot;url&quot;: &quot;/map&quot;, &quot;icon&quot;: &quot;el-icon-s-opportunity&quot;, &quot;orderNum&quot;: 1, &quot;open&quot;: 1, &quot;disabled&quot;: false, &quot;perms&quot;: &quot;map:view&quot;, &quot;type&quot;: 0, &quot;children&quot;: [] &#125;, &#123; &quot;id&quot;: 304, &quot;parentId&quot;: 303, &quot;menuName&quot;: &quot;å¥åº·æ‰“å¡&quot;, &quot;url&quot;: &quot;/health&quot;, &quot;icon&quot;: &quot;el-icon-s-cooperation&quot;, &quot;orderNum&quot;: 1, &quot;open&quot;: 0, &quot;disabled&quot;: false, &quot;perms&quot;: &quot;&quot;, &quot;type&quot;: 0, &quot;children&quot;: [] &#125;, &#123; &quot;id&quot;: 305, &quot;parentId&quot;: 303, &quot;menuName&quot;: &quot;æŸ¥çœ‹æƒ…å†µ&quot;, &quot;url&quot;: null, &quot;icon&quot;: &quot;el-icon-c-scale-to-original&quot;, &quot;orderNum&quot;: 2, &quot;open&quot;: 1, &quot;disabled&quot;: false, &quot;perms&quot;: null, &quot;type&quot;: 0, &quot;children&quot;: [] &#125;, &#123; &quot;id&quot;: 272, &quot;parentId&quot;: 303, &quot;menuName&quot;: &quot;ç–«æƒ…è¾Ÿè°£&quot;, &quot;url&quot;: &quot;/rumors&quot;, &quot;icon&quot;: &quot;el-icon-help&quot;, &quot;orderNum&quot;: 5, &quot;open&quot;: 0, &quot;disabled&quot;: false, &quot;perms&quot;: null, &quot;type&quot;: 0, &quot;children&quot;: [] &#125; ] &#125;, &#123; &quot;id&quot;: 295, &quot;parentId&quot;: 0, &quot;menuName&quot;: &quot;å…¶ä»–ç®¡ç†&quot;, &quot;url&quot;: &quot;&quot;, &quot;icon&quot;: &quot;el-icon-s-marketing&quot;, &quot;orderNum&quot;: 5, &quot;open&quot;: 0, &quot;disabled&quot;: false, &quot;perms&quot;: &quot;&quot;, &quot;type&quot;: 0, &quot;children&quot;: [ &#123; &quot;id&quot;: 297, &quot;parentId&quot;: 295, &quot;menuName&quot;: &quot;ç›‘æ§ç®¡ç†&quot;, &quot;url&quot;: &quot;&quot;, &quot;icon&quot;: &quot;el-icon-warning&quot;, &quot;orderNum&quot;: 1, &quot;open&quot;: 0, &quot;disabled&quot;: false, &quot;perms&quot;: &quot;&quot;, &quot;type&quot;: 0, &quot;children&quot;: [ &#123; &quot;id&quot;: 298, &quot;parentId&quot;: 297, &quot;menuName&quot;: &quot;SQLç›‘æ§&quot;, &quot;url&quot;: &quot;/druid&quot;, &quot;icon&quot;: &quot;el-icon-view&quot;, &quot;orderNum&quot;: 1, &quot;open&quot;: 0, &quot;disabled&quot;: false, &quot;perms&quot;: null, &quot;type&quot;: 0, &quot;children&quot;: [] &#125; ] &#125;, &#123; &quot;id&quot;: 341, &quot;parentId&quot;: 295, &quot;menuName&quot;: &quot;ä¸ªäººåšå®¢&quot;, &quot;url&quot;: &quot;/blog&quot;, &quot;icon&quot;: &quot;el-icon-view&quot;, &quot;orderNum&quot;: 1, &quot;open&quot;: 0, &quot;disabled&quot;: false, &quot;perms&quot;: &quot;&quot;, &quot;type&quot;: 0, &quot;children&quot;: [] &#125;, &#123; &quot;id&quot;: 296, &quot;parentId&quot;: 295, &quot;menuName&quot;: &quot;swaggeræ–‡æ¡£&quot;, &quot;url&quot;: &quot;/swagger&quot;, &quot;icon&quot;: &quot;el-icon-document&quot;, &quot;orderNum&quot;: 2, &quot;open&quot;: 0, &quot;disabled&quot;: false, &quot;perms&quot;: null, &quot;type&quot;: 0, &quot;children&quot;: [] &#125;, &#123; &quot;id&quot;: 318, &quot;parentId&quot;: 295, &quot;menuName&quot;: &quot;å›¾æ ‡ç®¡ç†&quot;, &quot;url&quot;: &quot;/icons&quot;, &quot;icon&quot;: &quot;el-icon-star-off&quot;, &quot;orderNum&quot;: 2, &quot;open&quot;: 1, &quot;disabled&quot;: false, &quot;perms&quot;: &quot;&quot;, &quot;type&quot;: 0, &quot;children&quot;: [] &#125; ] &#125;, &#123; &quot;id&quot;: 5, &quot;parentId&quot;: 0, &quot;menuName&quot;: &quot;æ—¥å¿—ç®¡ç†&quot;, &quot;url&quot;: &quot;/logs&quot;, &quot;icon&quot;: &quot;el-icon-camera&quot;, &quot;orderNum&quot;: 6, &quot;open&quot;: 0, &quot;disabled&quot;: false, &quot;perms&quot;: null, &quot;type&quot;: 0, &quot;children&quot;: [ &#123; &quot;id&quot;: 271, &quot;parentId&quot;: 5, &quot;menuName&quot;: &quot;ç™»å…¥æ—¥å¿—&quot;, &quot;url&quot;: &quot;/loginLog&quot;, &quot;icon&quot;: &quot;el-icon-date&quot;, &quot;orderNum&quot;: 1, &quot;open&quot;: 0, &quot;disabled&quot;: false, &quot;perms&quot;: &quot;login:log&quot;, &quot;type&quot;: 0, &quot;children&quot;: [] &#125;, &#123; &quot;id&quot;: 307, &quot;parentId&quot;: 5, &quot;menuName&quot;: &quot;æ“ä½œæ—¥å¿—&quot;, &quot;url&quot;: &quot;/logs&quot;, &quot;icon&quot;: &quot;el-icon-edit&quot;, &quot;orderNum&quot;: 1, &quot;open&quot;: 1, &quot;disabled&quot;: false, &quot;perms&quot;: &quot;&quot;, &quot;type&quot;: 0, &quot;children&quot;: [] &#125; ] &#125; ] &#125;; &#125;, methods: &#123; toggleiscollapse() &#123; this.iscollapse = !this.iscollapse; &#125;, &#125;, components: &#123; MenuTree,&#125;,&#125;;&lt;/script&gt;&lt;style lang=&#x27;less&#x27; scoped&gt;// å¤´éƒ¨å¸ƒå±€.el-header &#123; background-color: #001529; display: flex; justify-content: space-between; padding-left: 0; color: #ffffff; align-items: center; font-size: 20px; // å·¦è¾¹å¤´åƒæ ·å¼ .left_box &#123; display: flex; align-items: center; //æ–‡æœ¬å±…ä¸­ img &#123; width: 60px; height: 60px; margin: 0px 0px 10px 15px; //è¾¹ç¼˜ &#125; // æ–‡æœ¬ span &#123; margin-left: 15px; &#125; &#125; // å³è¾¹å¤´åƒæ ·å¼ .right_box &#123; .el-dropdown-menu, img &#123; height: 60px; width: 60px; border-radius: 50%; background-size: contain; //å®¹å™¨åŒ…è£¹å¤´åƒ &#125; &#125;&#125;// ä¾§è¾¹æ .el-aside &#123; background-color: #001529; .el-menu-vertical-demo&#123; border-right: none; &#125; // æ”¶èµ·åŠŸèƒ½æ ·å¼ .toggle_box &#123; background-color: #001529; color: #FFFFFF; text-align: center; cursor: pointer; font-size: 15px; font-weight: bold; line-height: 24px; &#125;&#125;// ä¸»ä½“å¸ƒå±€.el-main &#123; background-color: #e9eef3;&#125;// æ•´ä¸ªå®¹å™¨é«˜åº¦.main_container &#123; height: 100%;&#125;&lt;/style&gt; 2.1ã€MenuTree.vueç»„ä»¶1234567891011121314151617181920212223242526272829303132333435363738394041424344454647&lt;template &gt; &lt;div&gt; &lt;template v-for=&quot;item in this.menuList&quot;&gt; &lt;el-sub-menu :disabled=&quot;item.disabled&quot; :index=&quot;item.id + &#x27;&#x27;&quot; :key=&quot;item.id + &#x27;&#x27;&quot; v-if=&quot;item.children.length &gt; 0&quot; &gt; &lt;template #title&gt; &lt;el-icon class=&quot;is-loading&quot;&gt; &lt;loading /&gt; &lt;/el-icon&gt; &lt;span&gt;&#123;&#123; item.menuName &#125;&#125;&lt;/span&gt; &lt;/template&gt; &lt;MenuTree :menuList=&quot;item.children&quot;&gt;&lt;/MenuTree&gt; &lt;/el-sub-menu&gt; &lt;el-menu-item v-else :disabled=&quot;item.disabled&quot; :index=&quot;item.url+&#x27;&#x27;&quot; :router=&quot;true&quot; :key=&quot;item.id+&#x27;&#x27;&quot;&gt; &lt;el-icon class=&quot;is-loading&quot;&gt; &lt;loading /&gt; &lt;/el-icon&gt; &lt;span&gt;&#123;&#123; item.menuName &#125;&#125;&lt;/span&gt; &lt;/el-menu-item&gt; &lt;/template&gt; &lt;/div&gt;&lt;/template&gt;&lt;script&gt;export default &#123; name: &quot;MenuTree&quot;, props: [&quot;menuList&quot;],&#125;;&lt;/script&gt;&lt;style &gt;/* æº¢å‡ºæ•ˆæœè§£å†³ */ .el-menu--collapse span, .el-menu--collapse i.el-sub-menu__icon-arrow&#123; height: 0; width: 0; overflow: hidden; visibility: hidden; display: inline-block; &#125;&lt;/style&gt; 3ã€ç”¨æˆ·ç®¡ç†ç•Œé¢4ã€ç”¨æˆ·æ•°æ®ç»‘å®šåŠåˆ†é¡µå±•ç¤º5ã€å‰ç«¯ç»‘å®šéƒ¨é—¨ä¿¡æ¯6ã€ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢","categories":[],"tags":[]},{"title":"json","slug":"5-5/json","date":"2022-05-05T09:20:58.486Z","updated":"2022-05-05T10:08:28.422Z","comments":true,"path":"2022/05/05/5-5/json/","link":"","permalink":"https://dddwah11.github.io/2022/05/05/5-5/json/","excerpt":"","text":"Jacksonå¯¼å…¥ä¾èµ– 123456&lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt; &lt;version&gt;2.13.2.2&lt;/version&gt; &lt;type&gt;bundle&lt;/type&gt;&lt;/dependency&gt; Fastjson12345&lt;dependency&gt; &lt;groupId&gt;com.alibaba&lt;/groupId&gt; &lt;artifactId&gt;fastjson&lt;/artifactId&gt; &lt;version&gt;2.0.2.graal&lt;/version&gt;&lt;/dependency&gt;","categories":[],"tags":[]},{"title":"","slug":"5-5/vueå®ç°ç²’å­æ•ˆæœ","date":"2022-05-05T07:36:13.580Z","updated":"2022-05-05T09:20:21.194Z","comments":true,"path":"2022/05/05/5-5/vueå®ç°ç²’å­æ•ˆæœ/","link":"","permalink":"https://dddwah11.github.io/2022/05/05/5-5/vue%E5%AE%9E%E7%8E%B0%E7%B2%92%E5%AD%90%E6%95%88%E6%9E%9C/","excerpt":"","text":"Vue-particles1npm install vue-particles --save-dev mai.jsä¸­ 123import Vue from &#x27;vue&#x27;import VueParticles from &#x27;vue-particles&#x27;Vue.use(VueParticles) ç»„ä»¶ä¸­ 12345678910111213141516171819202122232425262728&lt;template&gt; &lt;div &gt; &lt;vue-particles class=&quot;login-background&quot; color=&quot;#97D0F2&quot; :particleOpacity=&quot;0.7&quot; :particlesNumber=&quot;80&quot; shapeType=&quot;circle&quot; :particleSize=&quot;4&quot; linesColor=&quot;#dedede&quot; :linesWidth=&quot;1&quot; :lineLinked=&quot;true&quot; :lineOpacity=&quot;0.4&quot; :linesDistance=&quot;150&quot; :moveSpeed=&quot;3&quot; :hoverEffect=&quot;true&quot; hoverMode=&quot;grab&quot; :clickEffect=&quot;true&quot; clickMode=&quot;push&quot; &gt; &lt;/vue-particles&gt; &lt;/div&gt; &lt;/template&gt;&lt;style scoped&gt;.login-background &#123; position: relative; &#125;&lt;/style&gt;","categories":[],"tags":[]},{"title":"Element-plus","slug":"5-1/Element-plus","date":"2022-05-01T13:50:54.423Z","updated":"2022-05-05T03:59:34.486Z","comments":true,"path":"2022/05/01/5-1/Element-plus/","link":"","permalink":"https://dddwah11.github.io/2022/05/01/5-1/Element-plus/","excerpt":"","text":"Element-pluså®‰è£…ï¼š 1npm install element-plus --save main.jséœ€å¯¼å…¥ä¸¤ä¸ªæ–‡ä»¶ 123456789import &#123; createApp &#125; from &#x27;vue&#x27;import ElementPlus from &#x27;element-plus&#x27;import &#x27;element-plus/dist/index.css&#x27;import App from &#x27;./App.vue&#x27;const app = createApp(App)app.use(ElementPlus)app.mount(&#x27;#app&#x27;) ä¾‹å­ï¼š ä½¿ç”¨é€‰é¡¹å¼çš„API DatePicker æ—¥æœŸé€‰æ‹©å™¨ APP.vueä¸­ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253&lt;template&gt; &lt;div&gt; &lt;el-date-picker v-model=&quot;value1&quot; type=&quot;date&quot; placeholder=&quot;Pick a day&quot; :disabled-date=&quot;disabledDate&quot; :shortcuts=&quot;shortcuts&quot; /&gt; &lt;/div&gt;&lt;/template&gt;&lt;script&gt;export default &#123; name: &quot;App&quot;, data() &#123; return &#123; value1: &quot;&quot;, shortcuts: [ &#123; text: &quot;Today&quot;, value: new Date(), &#125;, &#123; text: &quot;Yesterday&quot;, value: () =&gt; &#123; const date = new Date(); date.setTime(date.getTime() - 3600 * 1000 * 24); return date; &#125;, &#125;, &#123; text: &quot;A week ago&quot;, value: () =&gt; &#123; const date = new Date(); date.setTime(date.getTime() - 3600 * 1000 * 24 * 7); return date; &#125;, &#125;, ], &#125;; &#125;, methods: &#123; disabledDate: (time) =&gt; &#123; return time.getTime() &gt; Date.now(); &#125;, &#125;,&#125;;&lt;/script&gt;&lt;style &gt;&lt;/style&gt; ç»„åˆå¼ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960&lt;template&gt; &lt;div&gt; &lt;el-date-picker v-model=&quot;value&quot; type=&quot;date&quot; placeholder=&quot;é€‰ä¸€å¤©å§&quot; :disabled-date=&quot;disabledDate&quot; :shortcuts=&quot;shortcuts&quot; /&gt; &lt;/div&gt;&lt;/template&gt;&lt;script&gt;import &#123; ref &#125; from &#x27;vue&#x27;export default &#123; name: &quot;App&quot;, setup() &#123; const value = ref(&quot;&quot;); const shortcuts = [ &#123; text: &quot;Today&quot;, value: new Date(), &#125;, &#123; text: &quot;Yesterday&quot;, value: () =&gt; &#123; const date = new Date(); date.setTime(date.getTime() - 3600 * 1000 * 24); return date; &#125;, &#125;, &#123; text: &quot;A week ago&quot;, value: () =&gt; &#123; const date = new Date(); date.setTime(date.getTime() - 3600 * 1000 * 24 * 7); return date; &#125;, &#125;, ]; const disabledDate = (time) =&gt; &#123; return time.getTime() &gt; Date.now(); &#125;; return &#123;value,shortcuts,disabledDate&#125;; &#125;, methods: &#123; // disabledDate: (time) =&gt; &#123; // return time.getTime() &gt; Date.now(); // &#125;, &#125;,&#125;;&lt;/script&gt;&lt;style &gt;&lt;/style&gt; ç»„åˆå¼API1234&lt;template&gt;this is home &#123;&#123; count &#125;&#125;&lt;/template&gt;&lt;script lang=&quot;ts&quot; setup&gt;let count = ref(2);&lt;/script&gt; ç»„åˆå¼APIçš„åˆ†ç¦»æ–°å»ºcomposablesæ–‡ä»¶å¤¹ æ–°å»ºdatapacker.js 1234567891011121314151617181920212223242526272829import &#123; ref&#125; from &#x27;vue&#x27;export const value = ref(&quot;&quot;);export const shortcuts = [ &#123; text: &quot;Today&quot;, value: new Date(), &#125;, &#123; text: &quot;Yesterday&quot;, value: () =&gt; &#123; const date = new Date(); date.setTime(date.getTime() - 3600 * 1000 * 24); return date; &#125;, &#125;, &#123; text: &quot;A week ago&quot;, value: () =&gt; &#123; const date = new Date(); date.setTime(date.getTime() - 3600 * 1000 * 24 * 7); return date; &#125;, &#125;, ]; export const disabledDate = (time) =&gt; &#123; return time.getTime() &gt; Date.now(); &#125;; App.vueç»„ä»¶ä¸­ 123456789101112131415161718192021222324&lt;template&gt; &lt;div&gt; &lt;el-date-picker v-model=&quot;value&quot; type=&quot;date&quot; placeholder=&quot;é€‰ä¸€å¤©å§&quot; :disabled-date=&quot;disabledDate&quot; :shortcuts=&quot;shortcuts&quot; /&gt; &lt;/div&gt;&lt;/template&gt;&lt;script&gt;import &#123;value,shortcuts,disabledDate&#125; from &quot;@/composables/datepacker.js&quot;export default &#123; setup() &#123; return &#123;value,shortcuts,disabledDate&#125; &#125;,&#125;;&lt;/script&gt;&lt;style &gt;&lt;/style&gt; å®Œæˆç™»å½•é¡µé¢App.vue 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647&lt;template&gt; &lt;div&gt; &lt;el-row :gutter=&quot;20&quot;&gt; &lt;el-col :span=&quot;6&quot;&gt;&lt;div class=&quot;grid-content bg-purple&quot; /&gt;&lt;/el-col&gt; &lt;el-col :span=&quot;12&quot;&gt; &lt;el-form :model=&quot;form&quot; label-width=&quot;120px&quot;&gt; &lt;el-form-item label=&quot;ç”¨æˆ·å&quot;&gt; &lt;el-input v-model=&quot;user.username&quot; /&gt; &lt;/el-form-item&gt; &lt;el-form-item label=&quot;å¯†ç &quot;&gt; &lt;el-input v-model=&quot;user.password&quot; /&gt; &lt;/el-form-item&gt; &lt;el-form-item&gt; &lt;el-button type=&quot;primary&quot; @click=&quot;login&quot;&gt;ç™»å½•&lt;/el-button&gt; &lt;/el-form-item&gt; &lt;/el-form&gt; &lt;/el-col&gt; &lt;el-col :span=&quot;6&quot;&gt;&lt;div class=&quot;grid-content bg-purple&quot; /&gt;&lt;/el-col&gt; &lt;/el-row&gt; &lt;/div&gt;&lt;/template&gt;&lt;script&gt;export default &#123; name: &#x27;login&#x27;, data () &#123; return &#123; user: &#123; username:&#x27;&#x27;, password:&#x27;&#x27; &#125; &#125;; &#125;, methods: &#123; login()&#123; if(this.user.username === &#x27;root&#x27;)&#123; ElMessageBox.alert(&#x27;ç™»å½•æˆåŠŸ&#x27;, &#x27;æ¶ˆæ¯&#x27;); // this.$router.push(&quot;/main&quot;); &#125; &#125; &#125;,&#125;&lt;/script&gt;&lt;style&gt;&lt;/style&gt; å®Œå–„ç™»å½•é¡µé¢","categories":[],"tags":[]},{"title":"vue3","slug":"4-26/vue3","date":"2022-04-26T10:44:31.729Z","updated":"2022-05-05T14:49:13.264Z","comments":true,"path":"2022/04/26/4-26/vue3/","link":"","permalink":"https://dddwah11.github.io/2022/04/26/4-26/vue3/","excerpt":"","text":"vue cliè„šæ‰‹æ¶1npm install -g @vue/cli åˆ›å»ºä¸€ä¸ªvueé¡¹ç›®1vue create project-name é¡¹ç›®ç»“æ„main.js123456import &#123; createApp &#125; from &#x27;vue&#x27;import App from &#x27;./App.vue&#x27;// æ ¹ç»„ä»¶createApp(App).mount(&#x27;#app&#x27;) main.js ä¼šåˆ›å»ºæˆ‘ä»¬vueçš„å®ä¾‹ï¼ŒæŒ‚è½½ä¼šå¸®æˆ‘ä»¬åˆ›å»ºæ ¹ç»„ä»¶çš„å®ä¾‹vm APP.vue123456789101112131415161718192021222324252627&lt;template&gt; &lt;img alt=&quot;Vue logo&quot; src=&quot;./assets/logo.png&quot;&gt; &lt;HelloWorld msg=&quot;Welcome to Your Vue.js App&quot;/&gt;&lt;/template&gt;&lt;script&gt;import HelloWorld from &#x27;./components/HelloWorld.vue&#x27;export default &#123; name: &#x27;App&#x27;, components: &#123; HelloWorld &#125;&#125;&lt;/script&gt;&lt;style&gt;#app &#123; font-family: Avenir, Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; text-align: center; color: #2c3e50; margin-top: 60px;&#125;&lt;/style&gt; webpackViteVite æ˜¯ä¸€ä¸ª web å¼€å‘æ„å»ºå·¥å…·ï¼Œç”±äºå…¶åŸç”Ÿ ES æ¨¡å—å¯¼å…¥æ–¹å¼ï¼Œå¯ä»¥å®ç°é—ªç”µèˆ¬çš„å†·æœåŠ¡å™¨å¯åŠ¨ã€‚ é€šè¿‡åœ¨ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå¯ä»¥ä½¿ç”¨ Vite å¿«é€Ÿæ„å»º Vue é¡¹ç›®ã€‚ ä½¿ç”¨ npmï¼š 123456789# npm 6.x$ npm init vite@latest &lt;project-name&gt; --template vue# npm 7+ï¼Œéœ€è¦åŠ ä¸Šé¢å¤–çš„åŒçŸ­æ¨ªçº¿$ npm init vite@latest &lt;project-name&gt; -- --template vue$ cd &lt;project-name&gt;$ npm install$ npm run serve/dev å®‰è£…ä¾èµ– 123456789npm installå®‰è£…vue-routernpm install vue-router@4å®‰è£…element-uinpm install --legacy-peer-deps element-ui --saveå®‰è£… SASS åŠ è½½å™¨cnpm install sass-loader node-sass --save-devå¯åŠ¨æµ‹è¯•npm run serve/dev åˆ›å»ºmodulesç›®å½• åœ¨æ–‡ä»¶ç›®å½•ä¸‹ è¿è¡Œ webpack åˆ›å»ºindex.htmlå¹¶å¼•å…¥ 1&lt;script src =&quot;dist/js/bundle.js&quot;&gt;&lt;/script&gt; axios1npm add axois 1234567import axios from &#x27;axios&#x27;;mounted()&#123; getData()&#123; axios.get(&quot;xxx&quot;).then(res =&gt;&#123; &#125;) &#125; vue_routerå®‰è£…vue-routeråˆ°é¡¹ç›®ç›®å½• 1npm install vue-router@4 -s/å®‰è£…åœ¨æœ¬åœ°é¡¹ç›®ï¼Œåœ¨packge.jsonä¸­ use(router)ï¼› ä½¿ç”¨cdn 12345678910111213141516&lt;script src=&quot;https://unpkg.com/vue@3&quot;&gt;&lt;/script&gt;&lt;script src=&quot;https://unpkg.com/vue-router@4&quot;&gt;&lt;/script&gt;&lt;div id=&quot;app&quot;&gt; &lt;h1&gt;Hello App!&lt;/h1&gt; &lt;p&gt; &lt;!-- use the router-link component for navigation. --&gt; &lt;!-- specify the link by passing the `to` prop. --&gt; &lt;!-- `&lt;router-link&gt;` will render an `&lt;a&gt;` tag with the correct `href` attribute --&gt; &lt;router-link to=&quot;/&quot;&gt;Go to Home&lt;/router-link&gt; &lt;router-link to=&quot;/about&quot;&gt;Go to About&lt;/router-link&gt; &lt;/p&gt; &lt;!-- route outlet --&gt; &lt;!-- component matched by the route will render here --&gt; &lt;router-view&gt;&lt;/router-view&gt;&lt;/div&gt; åœ¨Vueè„šæ‰‹æ¶å½“ä¸­ main.jsä¸­ 1234567891011121314151617181920212223242526import &#123; createApp &#125; from &#x27;vue&#x27;import App from &#x27;./App.vue&#x27;import &#123; createRouter, createWebHashHistory&#125; from &#x27;vue-router&#x27; //ä»vue-routerä¸­è§£æ„ èŠ±æ‹¬å·ä¸­çš„ä¸¤ä¸ªæ–¹æ³•import Hhome from &#x27;./components/Hhome.vue&#x27;import Ahbout from &#x27;./components/Ahbout.vue&#x27;// 2. å®šä¹‰ä¸€äº›è·¯ç”±// æ¯ä¸ªè·¯ç”±éƒ½éœ€è¦æ˜ å°„åˆ°ä¸€ä¸ªç»„ä»¶ã€‚// æˆ‘ä»¬åé¢å†è®¨è®ºåµŒå¥—è·¯ç”±ã€‚const routes = [ &#123; path: &#x27;/&#x27;, component: Hhome &#125;, &#123; path: &#x27;/about&#x27;, component: Ahbout &#125;,]// 3. åˆ›å»ºè·¯ç”±å®ä¾‹å¹¶ä¼ é€’ `routes` é…ç½®// ä½ å¯ä»¥åœ¨è¿™é‡Œè¾“å…¥æ›´å¤šçš„é…ç½®ï¼Œä½†æˆ‘ä»¬åœ¨è¿™é‡Œ// æš‚æ—¶ä¿æŒç®€å•const router = createRouter(&#123; // 4. å†…éƒ¨æä¾›äº† history æ¨¡å¼çš„å®ç°ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨ hash æ¨¡å¼ã€‚ history: createWebHashHistory(), routes, // `routes: routes` çš„ç¼©å†™&#125;)// æ ¹ç»„ä»¶let app = createApp(App).use(router);app.mount(&#x27;#app&#x27;) APP.vueä¸­ 1234567891011121314151617181920212223242526272829303132333435363738&lt;template&gt; &lt;img alt=&quot;Vue logo&quot; src=&quot;./assets/logo.png&quot; /&gt; &lt;h1&gt;Hello App!&lt;/h1&gt; &lt;p&gt; &lt;!-- use the router-link component for navigation. --&gt; &lt;!-- specify the link by passing the `to` prop. --&gt; &lt;!-- `&lt;router-link&gt;` will render an `&lt;a&gt;` tag with the correct `href` attribute --&gt; &lt;router-link to=&quot;/&quot;&gt;Go to Home&lt;/router-link&gt; &lt;router-link to=&quot;/about&quot;&gt;Go to About&lt;/router-link&gt; &lt;/p&gt; &lt;!-- route outlet --&gt; &lt;!-- component matched by the route will render here --&gt; &lt;router-view&gt;&lt;/router-view&gt;&lt;/template&gt;&lt;script&gt;import home from &quot;./components/Hhome.vue&quot;;import about from &quot;./components/Ahbout.vue&quot;;export default &#123; name: &quot;App&quot;, components: &#123; home, about &#125;,&#125;;&lt;/script&gt;&lt;style&gt;#app &#123; font-family: Avenir, Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; text-align: center; color: #2c3e50; margin-top: 60px;&#125;&lt;/style&gt; ä»£ç æ”¹é€  è§£å†³è·¯ç”±è¿‡å¤š æ–°å»ºrouterç›®å½•ï¼Œåœ¨å…¶ä¸‹æ–°å»ºindex.jsæ”¹é€ ä»£ç  1234567891011121314151617181920212223//å®Œæˆè·¯ç”±ç›¸å…³çš„å·¥ä½œimport &#123; createRouter, createWebHashHistory&#125; from &#x27;vue-router&#x27; //ä»vue-routerä¸­è§£æ„ èŠ±æ‹¬å·ä¸­çš„ä¸¤ä¸ªæ–¹æ³•import Hhome from &#x27;../components/Hhome.vue&#x27;import Ahbout from &#x27;../components/Ahbout.vue&#x27;// 2. å®šä¹‰ä¸€äº›è·¯ç”±// æ¯ä¸ªè·¯ç”±éƒ½éœ€è¦æ˜ å°„åˆ°ä¸€ä¸ªç»„ä»¶ã€‚// æˆ‘ä»¬åé¢å†è®¨è®ºåµŒå¥—è·¯ç”±ã€‚const routes = [ &#123; path: &#x27;/&#x27;, component: Hhome &#125;, &#123; path: &#x27;/about&#x27;, component: Ahbout &#125;,]// 3. åˆ›å»ºè·¯ç”±å®ä¾‹å¹¶ä¼ é€’ `routes` é…ç½®// ä½ å¯ä»¥åœ¨è¿™é‡Œè¾“å…¥æ›´å¤šçš„é…ç½®ï¼Œä½†æˆ‘ä»¬åœ¨è¿™é‡Œ// æš‚æ—¶ä¿æŒç®€å•const router = createRouter(&#123; // 4. å†…éƒ¨æä¾›äº† history æ¨¡å¼çš„å®ç°ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨ hash æ¨¡å¼ã€‚ history: createWebHashHistory(), routes, // `routes: routes` çš„ç¼©å†™&#125;)//æš´éœ²ä¸€ä¸ªrouteræ–¹æ³•ç»™main.jsexport default router main.jsä¸­ 1234567import &#123; createApp &#125; from &#x27;vue&#x27;import App from &#x27;./App.vue&#x27;import router from &#x27;./router&#x27;// æ ¹ç»„ä»¶app.use(router); è¿™æ ·åˆ†å·¥å°±ååˆ†æ˜ç¡®äº†ï¼ åŠ¨æ€è·¯ç”±åŒ¹é…routerä¸‹çš„index.js 1&#123;path: &#x27;/user/:id&#x27;, component: use&#125; é€šè¿‡ç»„ä»¶ä¼ å‚ 1&lt;div&gt;my id is &#123;&#123;$router.params.id&#125;&#125;&lt;/div&gt; æ€»ç»„ä»¶ä¸­ 1234&lt;template&gt;&lt;router-link to=&quot;/user/13&quot;&gt;13&lt;/router-link&gt; | &lt;router-link to=&quot;/user/12&quot;&gt;12&lt;/router-link&gt; |&lt;/template&gt; ä¸€äº›è¯­æ³•é€šè¿‡è‡ªå®šä¹‰çš„æ­£åˆ™ï¼š path: &#39;/user/:id(//d+)&#39; ï¼ˆ&#x2F;&#x2F;d+ï¼‰è¡¨ç¤ºä¼ å…¥çš„å‚æ•°åªèƒ½æ˜¯æ•°å­— å¯é‡å¤çš„å‚æ•° path: &#39;/user/:id(//d+)*&#39; åœ¨å…¶åé¢åŠ *ç¬¦å·ï¼Œè¿™æä¾›äº†ä¸€ä¸ªå‚æ•°æ•°ç»„ï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸² å¯é€‰çš„å‚æ•° åœ¨idåé¢åŠ ï¼Ÿ å¯ä¸å¯æ—  åµŒå¥—è·¯ç”±åœ¨user.vueç»„ä»¶ä¸­åµŒå¥—ä¸¤ä¸ªç»„ä»¶ user.vueä¸­ 123456789&lt;template&gt; &lt;div&gt; &lt;p&gt;hello&lt;/p&gt; &lt;p&gt; my id is &#123;&#123;$router.params.id&#125;&#125; &lt;/p&gt; &lt;router-link v-bind:to=&quot;&#x27;/user/&#x27;+$router.params.id+&#x27;/profile&#x27;&quot;&gt;å¤´åƒ&lt;/router-link&gt; &lt;router-link v-bind:to=&quot;&#x27;/user/&#x27;+$router.params.id+&#x27;/posts&#x27;&quot;&gt;å²—ä½&lt;/router-link&gt; &lt;router-view&gt;&lt;/router-view&gt; &lt;/div&gt;&lt;/template&gt; routerä¸­çš„index.jsä¸­ 123456789101112131415161718&#123; path: &#x27;/user/:id&#x27;, component: user, children: [ &#123; // UserProfile will be rendered inside User&#x27;s &lt;router-view&gt; // when /user/:id/profile is matched path: &#x27;profile&#x27;, component: UserProfile, &#125;, &#123; // UserPosts will be rendered inside User&#x27;s &lt;router-view&gt; // when /user/:id/posts is matched path: &#x27;posts&#x27;, component: UserPosts, &#125;, ] &#125; å‘½åè·¯çº¿é™¤äº†pathï¼Œæ‚¨è¿˜å¯ä»¥æä¾›nameä»»ä½•è·¯çº¿ã€‚è¿™å…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š æ²¡æœ‰ç¡¬ç¼–ç çš„ URL è‡ªåŠ¨ç¼–ç &#x2F;è§£ç params é˜²æ­¢æ‚¨åœ¨ç½‘å€ä¸­å‡ºç°æ‹¼å†™é”™è¯¯ ç»•è¿‡è·¯å¾„æ’åï¼ˆä¾‹å¦‚æ˜¾ç¤º a ï¼‰ 1234567const routes = [ &#123; path: &#x27;/user/:username&#x27;, name: &#x27;user&#x27;, component: User &#125;] è¦é“¾æ¥åˆ°å‘½åè·¯ç”±ï¼Œæ‚¨å¯ä»¥å°†å¯¹è±¡ä¼ é€’ç»™router-linkç»„ä»¶çš„topropï¼š 123&lt;router-link :to=&quot;&#123; name: &#x27;user&#x27;, params: &#123; username: &#x27;erina&#x27; &#125;&#125;&quot;&gt; User&lt;/router-link&gt; å‘½åè§†å›¾æœ‰æ—¶æ‚¨éœ€è¦åŒæ—¶æ˜¾ç¤ºå¤šä¸ªè§†å›¾è€Œä¸æ˜¯åµŒå¥—å®ƒä»¬ï¼Œä¾‹å¦‚åˆ›å»ºä¸€ä¸ªå¸¦æœ‰sidebarè§†å›¾å’Œmainè§†å›¾çš„å¸ƒå±€ã€‚è¿™å°±æ˜¯å‘½åè§†å›¾æ´¾ä¸Šç”¨åœºçš„åœ°æ–¹ã€‚æ‚¨å¯ä»¥æ‹¥æœ‰å¤šä¸ªå¹¶ä¸ºæ¯ä¸ªæ’åº§å‘½åï¼Œè€Œä¸æ˜¯åœ¨æ‚¨çš„è§†å›¾ä¸­åªæœ‰ä¸€ä¸ªæ’åº§ã€‚æ²¡æœ‰åå­—çš„ Arouter-viewå°†defaultä½œä¸ºå®ƒçš„åå­—ã€‚ 123&lt;router-view class=&quot;view left-sidebar&quot; name=&quot;LeftSidebar&quot;&gt;&lt;/router-view&gt;&lt;router-view class=&quot;view main-content&quot;&gt;&lt;/router-view&gt;&lt;router-view class=&quot;view right-sidebar&quot; name=&quot;RightSidebar&quot;&gt;&lt;/router-view&gt; ä¸€ä¸ªè§†å›¾æ˜¯ä½¿ç”¨ä¸€ä¸ªç»„ä»¶æ¥æ¸²æŸ“çš„ï¼Œå› æ­¤å¤šä¸ªè§†å›¾éœ€è¦å¤šä¸ªç»„ä»¶ç”¨äºåŒä¸€æ¡è·¯çº¿ã€‚ç¡®ä¿ä½¿ç”¨componentsï¼ˆå¸¦æœ‰sï¼‰é€‰é¡¹ï¼š 123456789101112131415const router = createRouter(&#123; history: createWebHashHistory(), routes: [ &#123; path: &#x27;/&#x27;, components: &#123; default: Home, // short for LeftSidebar: LeftSidebar LeftSidebar, // they match the `name` attribute on `&lt;router-view&gt;` RightSidebar, &#125;, &#125;, ],&#125;) åµŒå¥—å‘½åè§†å›¾å¯ä»¥ä½¿ç”¨å¸¦æœ‰åµŒå¥—è§†å›¾çš„å‘½åè§†å›¾æ¥åˆ›å»ºå¤æ‚çš„å¸ƒå±€ã€‚è¿™æ ·åšæ—¶ï¼Œæ‚¨è¿˜éœ€è¦ä¸ºåµŒå¥—router-viewå‘½åã€‚è®©æˆ‘ä»¬ä»¥è®¾ç½®é¢æ¿ä¸ºä¾‹ï¼š 123456789/settings/emails /settings/profile+-----------------------------------+ +------------------------------+| UserSettings | | UserSettings || +-----+-------------------------+ | | +-----+--------------------+ || | Nav | UserEmailsSubscriptions | | +------------&gt; | | Nav | UserProfile | || | +-------------------------+ | | | +--------------------+ || | | | | | | | UserProfilePreview | || +-----+-------------------------+ | | +-----+--------------------+ |+-----------------------------------+ +------------------------------+ Navåªæ˜¯ä¸€ä¸ªå¸¸è§„ç»„ä»¶ UserSettingsæ˜¯çˆ¶è§†å›¾ç»„ä»¶ UserEmailsSubscriptions, UserProfile,UserProfilePreviewæ˜¯åµŒå¥—è§†å›¾ç»„ä»¶ æ³¨æ„ï¼šè®©æˆ‘ä»¬å¿˜è®° HTML&#x2F;CSS åº”è¯¥å¦‚ä½•è¡¨ç¤ºè¿™ç§å¸ƒå±€å¹¶å…³æ³¨æ‰€ä½¿ç”¨çš„ç»„ä»¶ã€‚ ä¸Šè¿°å¸ƒå±€ä¸­çš„ç»„ä»¶&lt;template&gt;éƒ¨åˆ†UserSettingså¦‚ä¸‹æ‰€ç¤ºï¼š 1234567&lt;!-- UserSettings.vue --&gt;&lt;div&gt; &lt;h1&gt;User Settings&lt;/h1&gt; &lt;NavBar /&gt; &lt;router-view /&gt; &lt;router-view name=&quot;helper&quot; /&gt;&lt;/div&gt; ç„¶åä½ å¯ä»¥ç”¨è¿™ä¸ªè·¯ç”±é…ç½®æ¥å®ç°ä¸Šé¢çš„å¸ƒå±€ï¼š 123456789101112131415&#123; path: &#x27;/settings&#x27;, // You could also have named views at the top component: UserSettings, children: [&#123; path: &#x27;emails&#x27;, component: UserEmailsSubscriptions &#125;, &#123; path: &#x27;profile&#x27;, components: &#123; default: UserProfile, helper: UserProfilePreview &#125; &#125;]&#125; ç¼–ç¨‹å¼å¯¼èˆªé™¤äº†ä½¿ç”¨ &lt;router-link&gt; åˆ›å»º a æ ‡ç­¾æ¥å®šä¹‰å¯¼èˆªé“¾æ¥ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å€ŸåŠ© router çš„å®ä¾‹æ–¹æ³•ï¼Œé€šè¿‡ç¼–å†™ä»£ç æ¥å®ç°ã€‚ å¯¼èˆªåˆ°ä¸åŒçš„ä½ç½® æ³¨æ„ï¼šåœ¨ Vue å®ä¾‹ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡ $router è®¿é—®è·¯ç”±å®ä¾‹ã€‚å› æ­¤ä½ å¯ä»¥è°ƒç”¨ this.$router.pushã€‚ æƒ³è¦å¯¼èˆªåˆ°ä¸åŒçš„ URLï¼Œå¯ä»¥ä½¿ç”¨ router.push æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•ä¼šå‘ history æ ˆæ·»åŠ ä¸€ä¸ªæ–°çš„è®°å½•ï¼Œæ‰€ä»¥ï¼Œå½“ç”¨æˆ·ç‚¹å‡»æµè§ˆå™¨åé€€æŒ‰é’®æ—¶ï¼Œä¼šå›åˆ°ä¹‹å‰çš„ URLã€‚ å½“ä½ ç‚¹å‡» &lt;router-link&gt; æ—¶ï¼Œå†…éƒ¨ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥ç‚¹å‡» &lt;router-link :to=&quot;...&quot;&gt; ç›¸å½“äºè°ƒç”¨ router.push(...) ï¼š å£°æ˜å¼ ç¼–ç¨‹å¼ &lt;router-link :to=&quot;...&quot;&gt; router.push(...) è¯¥æ–¹æ³•çš„å‚æ•°å¯ä»¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²è·¯å¾„ï¼Œæˆ–è€…ä¸€ä¸ªæè¿°åœ°å€çš„å¯¹è±¡ã€‚ä¾‹å¦‚ï¼š 1234567891011121314// å­—ç¬¦ä¸²è·¯å¾„router.push(&#x27;/users/eduardo&#x27;)// å¸¦æœ‰è·¯å¾„çš„å¯¹è±¡router.push(&#123; path: &#x27;/users/eduardo&#x27; &#125;)// å‘½åçš„è·¯ç”±ï¼Œå¹¶åŠ ä¸Šå‚æ•°ï¼Œè®©è·¯ç”±å»ºç«‹ urlrouter.push(&#123; name: &#x27;user&#x27;, params: &#123; username: &#x27;eduardo&#x27; &#125; &#125;)// å¸¦æŸ¥è¯¢å‚æ•°ï¼Œç»“æœæ˜¯ /register?plan=privaterouter.push(&#123; path: &#x27;/register&#x27;, query: &#123; plan: &#x27;private&#x27; &#125; &#125;)// å¸¦ hashï¼Œç»“æœæ˜¯ /about#teamrouter.push(&#123; path: &#x27;/about&#x27;, hash: &#x27;#team&#x27; &#125;) æ³¨æ„ï¼šå¦‚æœæä¾›äº† pathï¼Œparams ä¼šè¢«å¿½ç•¥ï¼Œä¸Šè¿°ä¾‹å­ä¸­çš„ query å¹¶ä¸å±äºè¿™ç§æƒ…å†µã€‚å–è€Œä»£ä¹‹çš„æ˜¯ä¸‹é¢ä¾‹å­çš„åšæ³•ï¼Œä½ éœ€è¦æä¾›è·¯ç”±çš„ name æˆ–æ‰‹å†™å®Œæ•´çš„å¸¦æœ‰å‚æ•°çš„ path ï¼š 123456789const username = &#x27;eduardo&#x27;// æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨å»ºç«‹ urlï¼Œä½†æˆ‘ä»¬å¿…é¡»è‡ªå·±å¤„ç†ç¼–ç router.push(`/user/$&#123;username&#125;`) // -&gt; /user/eduardo// åŒæ ·router.push(&#123; path: `/user/$&#123;username&#125;` &#125;) // -&gt; /user/eduardo// å¦‚æœå¯èƒ½çš„è¯ï¼Œä½¿ç”¨ `name` å’Œ `params` ä»è‡ªåŠ¨ URL ç¼–ç ä¸­è·ç›Šrouter.push(&#123; name: &#x27;user&#x27;, params: &#123; username &#125; &#125;) // -&gt; /user/eduardo// `params` ä¸èƒ½ä¸ `path` ä¸€èµ·ä½¿ç”¨router.push(&#123; path: &#x27;/user&#x27;, params: &#123; username &#125; &#125;) // -&gt; /user ç”±äºå±æ€§ to ä¸ router.push æ¥å—çš„å¯¹è±¡ç§ç±»ç›¸åŒï¼Œæ‰€ä»¥ä¸¤è€…çš„è§„åˆ™å®Œå…¨ç›¸åŒã€‚ router.push å’Œæ‰€æœ‰å…¶ä»–å¯¼èˆªæ–¹æ³•éƒ½ä¼šè¿”å›ä¸€ä¸ª Promiseï¼Œè®©æˆ‘ä»¬å¯ä»¥ç­‰åˆ°å¯¼èˆªå®Œæˆåæ‰çŸ¥é“æ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥ã€‚æˆ‘ä»¬å°†åœ¨ Navigation Handling ä¸­è¯¦ç»†ä»‹ç»ã€‚ æ›¿æ¢å½“å‰ä½ç½® å®ƒçš„ä½œç”¨ç±»ä¼¼äº router.pushï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯ï¼Œå®ƒåœ¨å¯¼èˆªæ—¶ä¸ä¼šå‘ history æ·»åŠ æ–°è®°å½•ï¼Œæ­£å¦‚å®ƒçš„åå­—æ‰€æš—ç¤ºçš„é‚£æ ·â€”â€”å®ƒå–ä»£äº†å½“å‰çš„æ¡ç›®ã€‚ å£°æ˜å¼ ç¼–ç¨‹å¼ &lt;router-link :to=&quot;...&quot; replace&gt; router.replace(...) ä¹Ÿå¯ä»¥ç›´æ¥åœ¨ä¼ é€’ç»™ router.push çš„ routeLocation ä¸­å¢åŠ ä¸€ä¸ªå±æ€§ replace: true ï¼š 123router.push(&#123; path: &#x27;/home&#x27;, replace: true &#125;)// ç›¸å½“äºrouter.replace(&#123; path: &#x27;/home&#x27; &#125;) æ¨ªè·¨å†å² è¯¥æ–¹æ³•é‡‡ç”¨ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºåœ¨å†å²å †æ ˆä¸­å‰è¿›æˆ–åé€€å¤šå°‘æ­¥ï¼Œç±»ä¼¼äº window.history.go(n)ã€‚ ä¾‹å­ 123456789101112// å‘å‰ç§»åŠ¨ä¸€æ¡è®°å½•ï¼Œä¸ router.forward() ç›¸åŒrouter.go(1)// è¿”å›ä¸€æ¡è®°å½•ï¼Œä¸router.back() ç›¸åŒrouter.go(-1)// å‰è¿› 3 æ¡è®°å½•router.go(3)// å¦‚æœæ²¡æœ‰é‚£ä¹ˆå¤šè®°å½•ï¼Œé™é»˜å¤±è´¥router.go(-100)router.go(100) ç¯¡æ”¹å†å² ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼Œrouter.pushã€router.replace å’Œ router.go æ˜¯ window.history.pushStateã€window.history.replaceState å’Œ window.history.go çš„ç¿»ç‰ˆï¼Œå®ƒä»¬ç¡®å®æ¨¡ä»¿äº† window.history çš„ APIã€‚ å› æ­¤ï¼Œå¦‚æœä½ å·²ç»ç†Ÿæ‚‰ Browser History APIsï¼Œåœ¨ä½¿ç”¨ Vue Router æ—¶ï¼Œæ“ä½œå†å²è®°å½•å°±ä¼šè§‰å¾—å¾ˆç†Ÿæ‚‰ã€‚ å€¼å¾—ä¸€æçš„æ˜¯ï¼Œæ— è®ºåœ¨åˆ›å»ºè·¯ç”±å™¨å®ä¾‹æ—¶ä¼ é€’ä»€ä¹ˆæ ·çš„history é…ç½®ï¼ŒVue Router çš„å¯¼èˆªæ–¹æ³•(pushã€replaceã€go)éƒ½èƒ½å§‹ç»ˆå¦‚ä¸€åœ°å·¥ä½œã€‚ é‡å®šå‘å’Œåˆ«åé‡å®šå‘#é‡å®šå‘ä¹Ÿæ˜¯é€šè¿‡ routes é…ç½®æ¥å®Œæˆï¼Œä¸‹é¢ä¾‹å­æ˜¯ä» /home é‡å®šå‘åˆ° /ï¼š 1const routes = [&#123; path: &#x27;/home&#x27;, redirect: &#x27;/&#x27; &#125;] é‡å®šå‘çš„ç›®æ ‡ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå‘½åçš„è·¯ç”±ï¼š 1const routes = [&#123; path: &#x27;/home&#x27;, redirect: &#123; name: &#x27;homepage&#x27; &#125; &#125;] ç”šè‡³æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼ŒåŠ¨æ€è¿”å›é‡å®šå‘ç›®æ ‡ï¼š 123456789101112131415const routes = [ &#123; // /search/screens -&gt; /search?q=screens path: &#x27;/search/:searchText&#x27;, redirect: to =&gt; &#123; // æ–¹æ³•æ¥æ”¶ç›®æ ‡è·¯ç”±ä½œä¸ºå‚æ•° // return é‡å®šå‘çš„å­—ç¬¦ä¸²è·¯å¾„/è·¯å¾„å¯¹è±¡ return &#123; path: &#x27;/search&#x27;, query: &#123; q: to.params.searchText &#125; &#125; &#125;, &#125;, &#123; path: &#x27;/search&#x27;, // ... &#125;,] è¯·æ³¨æ„ï¼Œ**å¯¼èˆªå®ˆå«å¹¶æ²¡æœ‰åº”ç”¨åœ¨è·³è½¬è·¯ç”±ä¸Šï¼Œè€Œä»…ä»…åº”ç”¨åœ¨å…¶ç›®æ ‡ä¸Š**ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œåœ¨ /home è·¯ç”±ä¸­æ·»åŠ  beforeEnter å®ˆå«ä¸ä¼šæœ‰ä»»ä½•æ•ˆæœã€‚ åœ¨å†™ redirect çš„æ—¶å€™ï¼Œå¯ä»¥çœç•¥ component é…ç½®ï¼Œå› ä¸ºå®ƒä»æ¥æ²¡æœ‰è¢«ç›´æ¥è®¿é—®è¿‡ï¼Œæ‰€ä»¥æ²¡æœ‰ç»„ä»¶è¦æ¸²æŸ“ã€‚å”¯ä¸€çš„ä¾‹å¤–æ˜¯åµŒå¥—è·¯ç”±ï¼šå¦‚æœä¸€ä¸ªè·¯ç”±è®°å½•æœ‰ children å’Œ redirect å±æ€§ï¼Œå®ƒä¹Ÿåº”è¯¥æœ‰ component å±æ€§ã€‚ ç›¸å¯¹é‡å®šå‘#ä¹Ÿå¯ä»¥é‡å®šå‘åˆ°ç›¸å¯¹ä½ç½®ï¼š 123456789const routes = [ &#123; path: &#x27;/users/:id/posts&#x27;, redirect: to =&gt; &#123; // æ–¹æ³•æ¥æ”¶ç›®æ ‡è·¯ç”±ä½œä¸ºå‚æ•° // return é‡å®šå‘çš„å­—ç¬¦ä¸²è·¯å¾„/è·¯å¾„å¯¹è±¡ &#125;, &#125;,] åˆ«å#é‡å®šå‘æ˜¯æŒ‡å½“ç”¨æˆ·è®¿é—® /home æ—¶ï¼ŒURL ä¼šè¢« / æ›¿æ¢ï¼Œç„¶ååŒ¹é…æˆ /ã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯åˆ«åå‘¢ï¼Ÿ å°† / åˆ«åä¸º /homeï¼Œæ„å‘³ç€å½“ç”¨æˆ·è®¿é—® /home æ—¶ï¼ŒURL ä»ç„¶æ˜¯ /homeï¼Œä½†ä¼šè¢«åŒ¹é…ä¸ºç”¨æˆ·æ­£åœ¨è®¿é—® /ã€‚ ä¸Šé¢å¯¹åº”çš„è·¯ç”±é…ç½®ä¸ºï¼š 1const routes = [&#123; path: &#x27;/&#x27;, component: Homepage, alias: &#x27;/home&#x27; &#125;] é€šè¿‡åˆ«åï¼Œä½ å¯ä»¥è‡ªç”±åœ°å°† UI ç»“æ„æ˜ å°„åˆ°ä¸€ä¸ªä»»æ„çš„ URLï¼Œè€Œä¸å—é…ç½®çš„åµŒå¥—ç»“æ„çš„é™åˆ¶ã€‚ä½¿åˆ«åä»¥ / å¼€å¤´ï¼Œä»¥ä½¿åµŒå¥—è·¯å¾„ä¸­çš„è·¯å¾„æˆä¸ºç»å¯¹è·¯å¾„ã€‚ä½ ç”šè‡³å¯ä»¥å°†ä¸¤è€…ç»“åˆèµ·æ¥ï¼Œç”¨ä¸€ä¸ªæ•°ç»„æä¾›å¤šä¸ªåˆ«åï¼š 12345678910111213const routes = [ &#123; path: &#x27;/users&#x27;, component: UsersLayout, children: [ // ä¸ºè¿™ 3 ä¸ª URL å‘ˆç° UserList // - /users // - /users/list // - /people &#123; path: &#x27;&#x27;, component: UserList, alias: [&#x27;/people&#x27;, &#x27;list&#x27;] &#125;, ], &#125;,] å¦‚æœä½ çš„è·¯ç”±æœ‰å‚æ•°ï¼Œè¯·ç¡®ä¿åœ¨ä»»ä½•ç»å¯¹åˆ«åä¸­åŒ…å«å®ƒä»¬ï¼š 12345678910111213const routes = [ &#123; path: &#x27;/users/:id&#x27;, component: UsersByIdLayout, children: [ // ä¸ºè¿™ 3 ä¸ª URL å‘ˆç° UserDetails // - /users/24 // - /users/24/profile // - /24 &#123; path: &#x27;profile&#x27;, component: UserDetails, alias: [&#x27;/:id&#x27;, &#x27;&#x27;] &#125;, ], &#125;,] è·¯ç”±ç»„ä»¶ä¼ å‚å°† props ä¼ é€’ç»™è·¯ç”±ç»„ä»¶# åœ¨ä½ çš„ç»„ä»¶ä¸­ä½¿ç”¨ $route ä¼šä¸è·¯ç”±ç´§å¯†è€¦åˆï¼Œè¿™é™åˆ¶äº†ç»„ä»¶çš„çµæ´»æ€§ï¼Œå› ä¸ºå®ƒåªèƒ½ç”¨äºç‰¹å®šçš„ URLã€‚è™½ç„¶è¿™ä¸ä¸€å®šæ˜¯ä»¶åäº‹ï¼Œä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡ props é…ç½®æ¥è§£é™¤è¿™ç§è¡Œä¸ºï¼š æˆ‘ä»¬å¯ä»¥å°†ä¸‹é¢çš„ä»£ç  1234const User = &#123; template: &#x27;&lt;div&gt;User &#123;&#123; $route.params.id &#125;&#125;&lt;/div&gt;&#x27;&#125;const routes = [&#123; path: &#x27;/user/:id&#x27;, component: User &#125;] æ›¿æ¢æˆ 12345const User = &#123; props: [&#x27;id&#x27;], template: &#x27;&lt;div&gt;User &#123;&#123; id &#125;&#125;&lt;/div&gt;&#x27;&#125;const routes = [&#123; path: &#x27;/user/:id&#x27;, component: User, props: true &#125;] å¸ƒå°”æ¨¡å¼#å½“ props è®¾ç½®ä¸º true æ—¶ï¼Œroute.params å°†è¢«è®¾ç½®ä¸ºç»„ä»¶çš„ propsã€‚ å‘½åè§†å›¾#å¯¹äºæœ‰å‘½åè§†å›¾çš„è·¯ç”±ï¼Œä½ å¿…é¡»ä¸ºæ¯ä¸ªå‘½åè§†å›¾å®šä¹‰ props é…ç½®ï¼š 1234567const routes = [ &#123; path: &#x27;/user/:id&#x27;, components: &#123; default: User, sidebar: Sidebar &#125;, props: &#123; default: true, sidebar: false &#125; &#125;] å¯¹è±¡æ¨¡å¼#å½“ props æ˜¯ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå®ƒå°†åŸæ ·è®¾ç½®ä¸ºç»„ä»¶ propsã€‚å½“ props æ˜¯é™æ€çš„æ—¶å€™å¾ˆæœ‰ç”¨ã€‚ 1234567const routes = [ &#123; path: &#x27;/promotion/from-newsletter&#x27;, component: Promotion, props: &#123; newsletterPopup: false &#125; &#125;] å‡½æ•°æ¨¡å¼#ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªè¿”å› props çš„å‡½æ•°ã€‚è¿™å…è®¸ä½ å°†å‚æ•°è½¬æ¢ä¸ºå…¶ä»–ç±»å‹ï¼Œå°†é™æ€å€¼ä¸åŸºäºè·¯ç”±çš„å€¼ç›¸ç»“åˆç­‰ç­‰ã€‚ 1234567const routes = [ &#123; path: &#x27;/search&#x27;, component: SearchUser, props: route =&gt; (&#123; query: route.query.q &#125;) &#125;] URL /search?q=vue å°†ä¼ é€’ &#123;query: &#39;vue&#39;&#125; ä½œä¸º props ä¼ ç»™ SearchUser ç»„ä»¶ã€‚ è¯·å°½å¯èƒ½ä¿æŒ props å‡½æ•°ä¸ºæ— çŠ¶æ€çš„ï¼Œå› ä¸ºå®ƒåªä¼šåœ¨è·¯ç”±å‘ç”Ÿå˜åŒ–æ—¶èµ·ä½œç”¨ã€‚å¦‚æœä½ éœ€è¦çŠ¶æ€æ¥å®šä¹‰ propsï¼Œè¯·ä½¿ç”¨åŒ…è£…ç»„ä»¶ï¼Œè¿™æ · vue æ‰å¯ä»¥å¯¹çŠ¶æ€å˜åŒ–åšå‡ºååº”ã€‚ ä¸åŒçš„å†å²è®°å½•æ¨¡å¼å®˜æ–¹æ¨èHTML5æ¨¡å¼12345678import &#123; createRouter, createWebHistory &#125; from &#x27;vue-router&#x27;const router = createRouter(&#123; history: createWebHistory(), routes: [ //... ],&#125;) å½“ä½¿ç”¨è¿™ç§å†å²æ¨¡å¼æ—¶ï¼ŒURL ä¼šçœ‹èµ·æ¥å¾ˆ â€œæ­£å¸¸â€ï¼Œä¾‹å¦‚ https://example.com/user/idã€‚æ¼‚äº®! ä¸è¿‡ï¼Œé—®é¢˜æ¥äº†ã€‚ç”±äºæˆ‘ä»¬çš„åº”ç”¨æ˜¯ä¸€ä¸ªå•é¡µçš„å®¢æˆ·ç«¯åº”ç”¨ï¼Œå¦‚æœæ²¡æœ‰é€‚å½“çš„æœåŠ¡å™¨é…ç½®ï¼Œç”¨æˆ·åœ¨æµè§ˆå™¨ä¸­ç›´æ¥è®¿é—® https://example.com/user/idï¼Œå°±ä¼šå¾—åˆ°ä¸€ä¸ª 404 é”™è¯¯ã€‚è¿™å°±ä¸‘äº†ã€‚ ä¸ç”¨æ‹…å¿ƒï¼šè¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½ éœ€è¦åšçš„å°±æ˜¯åœ¨ä½ çš„æœåŠ¡å™¨ä¸Šæ·»åŠ ä¸€ä¸ªç®€å•çš„å›é€€è·¯ç”±ã€‚å¦‚æœ URL ä¸åŒ¹é…ä»»ä½•é™æ€èµ„æºï¼Œå®ƒåº”æä¾›ä¸ä½ çš„åº”ç”¨ç¨‹åºä¸­çš„ index.html ç›¸åŒçš„é¡µé¢ã€‚æ¼‚äº®ä¾æ—§! å¯¼èˆªå«å£«åŠ¨æ€è·¯ç”±VuexVuex æ˜¯ä¸€ä¸ªä¸º Vue.js åº”ç”¨ç¨‹åºå¼€å‘çš„çŠ¶æ€ç®¡ç†æ¨¡å¼ + åº“ã€‚å®ƒé‡‡ç”¨é›†ä¸­å¼å­˜å‚¨ç®¡ç†åº”ç”¨ç¨‹åºçš„æ‰€æœ‰ç»„ä»¶çš„çŠ¶æ€ï¼Œå¹¶ä»¥ç›¸åº”çš„è§„åˆ™ä¿è¯ä»¥ä¸€ç§çŠ¶æ€å¯å‘ç”Ÿå˜åŒ–çš„æ–¹å¼ã€‚ å®‰è£… 1npm install vuex@next --save ä½¿ç”¨npm6å†è¿›è¡Œå®‰è£… 1npx -p npm@6 npm i --legacy-peer-deps å¯ä»¥å®šä¹‰å…¨å±€ä½¿ç”¨çš„å‚æ•°ï¼Œç»„ä»¶éƒ½èƒ½ä½¿ç”¨ 1234567891011121314// åˆ›å»ºä¸€ä¸ªæ–°çš„ store å®ä¾‹const store = createStore(&#123; // ç›¸å½“äºä¸€ä¸ªdataï¼Œæ‰€æœ‰ç»„ä»¶å…¨å±€éƒ½èƒ½è®¿é—® state () &#123; return &#123; count: 0 &#125; &#125;, mutations: &#123; increment (state) &#123; state.count++ &#125; &#125; &#125;) ä½†åˆå› ä¸ºå¯¹å…¨éƒ¨ç»„ä»¶å®ç°äº†å…±äº«ï¼Œå°±ä¸åº”è¯¥æ”¾åœ¨å…·ä½“çš„ç»„ä»¶é‡Œ 1234567// ä¿å­˜äº†å¯¹å…±äº«æ•°æ®çš„ä¿®æ”¹é€»è¾‘ mutations: &#123; increment (state) &#123; state.count++ &#125; &#125; &#125;) å…·ä½“æ–¹æ³•ä¸­ 123456methods: &#123; plus()&#123; // è¿™å°±æ˜¯å¯¹å…±äº«å˜é‡çš„ä¸€ä¸ªæ“ä½œé€»è¾‘ this.$store.commit(&#x27;increment&#x27;); &#125; &#125; async å’Œawaitawaitè¿”å›çš„æ˜¯ return new promise çš„å‡½æ•°å¹¶æ‰§è¡Œå®ƒ awaitåªèƒ½æ”¾åœ¨asyncå‡½æ•°é‡Œ 1234567891011121314151617let fun1 = function()&#123; let num = 10; return new Promise((resolve,reject)=&gt;&#123; setTimeout(()=&gt;&#123; num+=20; resolve(num); &#125;,2000) &#125;)&#125;let fun2 = async function()&#123; let num = await fun1(); console.log(num);&#125;fun2(); Statemap Stateå‡½æ•° å½“æ˜ å°„çš„è®¡ç®—å±æ€§çš„åç§°ä¸ state çš„å­èŠ‚ç‚¹åç§°ç›¸åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç»™ mapState ä¼ ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ã€‚ é‡Œé¢å¯ä»¥æ·»åŠ å¤šä¸ª 1234computed: mapState([ // æ˜ å°„ this.count ä¸º store.state.count &#x27;count&#x27;]) å¯ä»¥æ‹¼æ¥é‡Œé¢çš„å¯¹è±¡ Getter1234567getters: &#123; // è¿™æ ·å¯ä»¥å®Œæˆå¤ç”¨ doneCount(state)&#123; return state.todos.filter(todo =&gt; todo.done ===true).length &#125;&#125;, å±æ€§å¤šäº†ï¼Œä¹Ÿå¯ä»¥åƒstateé‚£æ ·ï¼Œæ”¾åœ¨è®¡ç®—å±æ€§ä¸­ï¼Œ Mutationæäº¤è½½è·ï¼ˆPayloadï¼‰ Actionåˆ†å‘action 12345actions: &#123; increment (context) &#123; context.commit(&#x27;increment&#x27;) &#125; &#125; è§¦å‘ï¼š this.$store.dispatch(&#39;increment&#39;) æ¨¡å—åŒ–12345678910111213141516171819202122const moduleA = &#123; state: () =&gt; (&#123; ... &#125;), mutations: &#123; ... &#125;, actions: &#123; ... &#125;, getters: &#123; ... &#125;&#125;const moduleB = &#123; state: () =&gt; (&#123; ... &#125;), mutations: &#123; ... &#125;, actions: &#123; ... &#125;&#125;const store = createStore(&#123; modules: &#123; a: moduleA, b: moduleB &#125;&#125;)store.state.a // -&gt; moduleA çš„çŠ¶æ€store.state.b // -&gt; moduleB çš„çŠ¶æ€","categories":[],"tags":[]},{"title":"Vue","slug":"4-25/Vue","date":"2022-04-25T06:36:06.433Z","updated":"2022-04-26T10:42:19.929Z","comments":true,"path":"2022/04/25/4-25/Vue/","link":"","permalink":"https://dddwah11.github.io/2022/04/25/4-25/Vue/","excerpt":"","text":"ç½‘ç»œé€šä¿¡: axios ç½‘é¡µè·³è½¬ï¼švue_router çŠ¶æ€ç®¡ç†ï¼švuex Vue-UI: ICE ElementUIã€ UIæ¡†æ¶ï¼šiview Ant-Designã€Bootstrap AmazeUIã€layuiã€vue-element-admin JavaScriptæ„å»ºå·¥å…·ï¼š WebPack:æ‰“åŒ…ã€å‹ç¼©ã€åˆå¹¶ã€æŒ‰åºåŠ è½½ MVVMæ¨¡å‹ view model view model æ¡ä»¶åˆ¤æ–­123456789101112131415161718&lt;div id=&quot;app&quot;&gt;&lt;li v-for=&quot;item in items&quot;&gt; &#123;&#123;item.message&#125;&#125;&lt;/li&gt;&lt;/div&gt;&lt;script src=&quot;https://cdn.jsdelivr.net/npm/vue@2.5.21/dist/vue.min.js&quot;&gt;&lt;/script&gt;&lt;script&gt; var vm = new Vue(&#123; el:&quot;#app&quot;, data: &#123; items: [ &#123;message: &#x27;xiaoliu&#x27;&#125;, &#123;message: &#x27;xiaoliuu&#x27;&#125; ] &#125; &#125;);&lt;/script&gt;&lt;/body&gt; é¼ æ ‡æ‚¬åœ123456789101112131415&lt;div id=&quot;app&quot;&gt; &lt;span v-bind:title=&quot;message&quot;&gt; é¼ æ ‡æ‚¬åœå‡ ç§’æŸ¥çœ‹æ­¤å¤„åŠ¨æ€ç»‘å®šçš„æç¤ºæ¶ˆæ¯!&lt;/span&gt;&lt;/div&gt;&lt;script src=&quot;https://cdn.jsdelivr.net/npm/vue@2.5.21/dist/vue.min.js&quot;&gt;&lt;/script&gt;&lt;script&gt; var vm = new Vue(&#123; el:&quot;#app&quot;, data:&#123; message:&quot;hello,vue&quot; &#125; &#125;);&lt;/script&gt; äº‹ä»¶123456789101112131415&lt;div id=&quot;app&quot;&gt; &lt;button v-on:click=&quot;sayHi&quot;&gt;ç‚¹æˆ‘&lt;/button&gt;&lt;/div&gt;&lt;script src=&quot;https://cdn.jsdelivr.net/npm/vue@2.5.21/dist/vue.min.js&quot;&gt;&lt;/script&gt;&lt;script&gt; var vm = new Vue(&#123; el:&quot;#app&quot;, data: &#123;&#125;, methods: &#123; //æ–¹æ³•å¿…é¡»å®šä¹‰åœ¨methodsæ–¹æ³•å¯¹è±¡ä¸­ sayHi: function () &#123; alert(this.message) &#125; &#125; &#125;);&lt;/script&gt; Vue7å¤§å±æ€§1.elå±æ€§ ç”¨æ¥æŒ‡ç¤ºvueç¼–è¯‘å™¨ä»ä»€ä¹ˆåœ°æ–¹å¼€å§‹è§£æ vueçš„è¯­æ³•ï¼Œå¯ä»¥è¯´æ˜¯ä¸€ä¸ªå ä½ç¬¦ã€‚ç›¸å½“äºä¸€ä¸ªå®¹å™¨ï¼Œè·Ÿä¸Šé¢çš„div id &#x3D; â€œappâ€åšå…³è”ï¼Œä»æ­¤ä»¥åä¸Šé¢div id &#x3D; â€œappâ€é‡Œé¢çš„å†…å®¹è¦é€šè¿‡vueæ¥æ¸²æŸ“,éƒ½è¦ç»è¿‡vueå¤„ç†æ‰èƒ½çœ‹å¾—åˆ°ä¸Šé¢divé‡Œé¢çš„å†…å®¹ 2.dataå±æ€§ç”¨æ¥ç»„ç»‡ä»viewä¸­æŠ½è±¡å‡ºæ¥çš„å±æ€§ï¼Œå¯ä»¥è¯´å°†è§†å›¾çš„æ•°æ®æŠ½è±¡å‡ºæ¥å­˜æ”¾åœ¨dataä¸­ã€‚è·Ÿå¾®ä¿¡å°ç¨‹åºä¸€æ ·ï¼Œæ‰€æœ‰çš„å˜é‡éƒ½è¦å†™åœ¨dataé‡Œé¢ 3.templateå±æ€§ç”¨æ¥è®¾ç½®æ¨¡æ¿ï¼Œä¼šæ›¿æ¢é¡µé¢å…ƒç´ ï¼ŒåŒ…æ‹¬å ä½ç¬¦ã€‚Vue.componentï¼ˆï¼‰ç»„ä»¶ä¸­ä¼šç”¨åˆ°ï¼Œå…¶å®å¾ˆå¤šåœ°æ–¹éƒ½ä¼šç”¨åˆ° 4.methodså±æ€§æ”¾ç½®é¡µé¢ä¸­çš„ä¸šåŠ¡é€»è¾‘ï¼Œjsæ–¹æ³•ä¸€èˆ¬éƒ½æ”¾ç½®åœ¨methodsä¸­ï¼Œç”¨æ¥å†™æ–¹æ³•ï¼Œå‡½æ•°çš„computedåé¢ä¼šä»‹ç»computedå’Œmethodsæ˜¯æœ‰åŒºåˆ«çš„ï¼šcomputedæ˜¯åœ¨å€¼å‘ç”Ÿæ”¹å˜çš„æ—¶å€™æ‰ä¼šè§¦å‘æ•ˆæœï¼Œè€Œmethodsåªè¦åˆ·æ–°æ‰§è¡Œäº†å°±ä¼šè§¦å‘ï¼Œæ‰€æœ‰å¹³æ—¶å†™VUEçš„æ—¶å€™ï¼Œèƒ½ç”¨computedçš„å°½é‡ä½¿ç”¨ 5.renderå±æ€§åˆ›å»ºçœŸæ­£çš„Virtual Dom 6.computedå±æ€§ç”¨æ¥è®¡ç®—æ ¹æ®å·²ç»å­˜åœ¨çš„å±æ€§è®¡ç®—å‡ºæ–°çš„å±æ€§ï¼Œå¯¹äºåŒæ ·çš„æ•°æ®ï¼Œä¼šç¼“å­˜ã€‚å½“å…¶ä¾èµ–å±æ€§çš„å€¼å‘ç”Ÿå˜åŒ–æ˜¯ï¼Œè¿™ä¸ªå±æ€§çš„å€¼ä¼šè‡ªåŠ¨æ›´æ–°ï¼Œä¸ä¹‹ç›¸å…³çš„DOMéƒ¨ä»½ä¹Ÿä¼šåŒæ­¥è‡ªåŠ¨æ›´æ–°ã€‚å…¶å®ä¸€èˆ¬æƒ…å†µï¼Œæˆ‘ä¹Ÿä¼šæŠŠä¸€äº›å…³äºé€»è¾‘çš„ä»£ç éƒ½å†™åœ¨computedä¸­ã€‚ 7.watchä¾¦å¬å±æ€§watch:function(new,old){}ç›‘å¬dataä¸­æ•°æ®çš„å˜åŒ–ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªè¿”å›æ–°å€¼ï¼Œä¸€ä¸ªè¿”å›æ—§å€¼å½“ä½ æœ‰ä¸€äº›æ•°æ®éœ€è¦éšç€å…¶å®ƒæ•°æ®å˜åŠ¨è€Œå˜åŠ¨æ—¶æˆ–è€…æ‰§è¡Œå¼‚æ­¥æ“ä½œæˆ–å¼€é”€è¾ƒå¤§æ“ä½œæ—¶ï¼Œå»ºè®®ä½¿ç”¨watchcomputedå’Œwatchæ˜¯æœ‰åŒºåˆ«çš„ï¼šwatch: ç›‘è§†,èƒ½å¤Ÿç›‘å¬åˆ°æ•°æ®çš„å˜åŒ–,åªè¦æ•°æ®å˜åŒ–çš„æ—¶å€™,éƒ½ä¼šè‡ªå®šæ‰§è¡Œå¯¹åº”çš„æ–¹æ³•,å…¶ä¸­å¯ä»¥æ£€æµ‹çš„æ•°æ®æ¥æºåˆ†ä¸ºä¸‰éƒ¨åˆ† data , computed , props computed: è®¡ç®—å±æ€§,å­˜åœ¨ä¸€ä¸ªè®¡ç®—ç¼“å­˜çš„ç‰¹æ€§,æ¯ä¸€æ¬¡è®¡ç®—ä¹‹å,åªè¦é‡Œé¢çš„é€»è¾‘ä¸å‘ç”Ÿå˜åŒ–,æ¯ä¸€æ¬¡é‡å¤è°ƒç”¨,éƒ½ä¼šä½¿ç”¨ä¸Šä¸€æ¬¡æ‰§è¡Œçš„ç»“æœ,èƒ½å¤ŸèŠ‚çœè®¡ç®—çš„æ—¶é—´ åœ¨è¡¨å•å®ç°æ•°æ®çš„åŒå‘ç»‘å®š 12345678910111213&lt;div id=&quot;app&quot;&gt; &lt;textarea name=&quot;&quot; id=&quot;&quot; cols=&quot;30&quot; rows=&quot;10&quot; v-model=&quot;message&quot;&gt;&lt;/textarea&gt; &#123;&#123;message&#125;&#125;&lt;/div&gt;&lt;script src=&quot;https://cdn.jsdelivr.net/npm/vue@2.5.21/dist/vue.min.js&quot;&gt;&lt;/script&gt;&lt;script&gt; var vm = new Vue(&#123; el:&quot;#app&quot;, data: &#123; message:&#x27;&#x27; &#125;, &#125;);&lt;/script&gt; åŒæ­¥è¾“å…¥æ¡† 12345678910111213141516&lt;div id=&quot;app&quot;&gt; æ€§åˆ«ï¼š &lt;input type=&quot;radio&quot; name=&quot;sex&quot; value=&quot;ç”·&quot; v-model=&quot;message&quot;&gt; ç”· &lt;input type=&quot;radio&quot; name=&quot;sex&quot; value=&quot;å¥³&quot; v-model=&quot;message&quot;&gt; å¥³ &lt;p&gt;é€‰ä¸­äº†ï¼š&#123;&#123;message&#125;&#125;&lt;/p&gt;&lt;/div&gt;&lt;script src=&quot;https://cdn.jsdelivr.net/npm/vue@2.5.21/dist/vue.min.js&quot;&gt;&lt;/script&gt;&lt;script&gt; var vm = new Vue(&#123; el:&quot;#app&quot;, data: &#123; message:&#x27;&#x27; &#125;, &#125;);&lt;/script&gt; ç»„ä»¶è‡ªå®šä¹‰ç»„ä»¶è·å–å€¼ï¼š 1234567891011121314151617&lt;div id=&quot;app&quot;&gt;&lt;xiaoliu v-for=&quot;item in items&quot; v-bind:item=&quot;item&quot;&gt;&lt;/xiaoliu&gt;&lt;/div&gt;&lt;script src=&quot;https://cdn.jsdelivr.net/npm/vue@2.5.21/dist/vue.min.js&quot;&gt;&lt;/script&gt;&lt;script&gt; Vue.component(&quot;xiaoliu&quot;,&#123; props: [&#x27;item&#x27;], template: &#x27;&lt;h1&gt;&#123;&#123;item&#125;&#125;&lt;/h1&gt;&#x27; //æ¨¡æ¿ &#125;) var vm = new Vue(&#123; el:&quot;#app&quot;, data: &#123; message:&#x27;&#x27;, items: [&quot;xiaoliu&quot;,&quot;xiaoliuu&quot;,&quot;xiaoliuuu&quot;] &#125;, &#125;);&lt;/script&gt; Axioså¼‚æ­¥é€šä¿¡jsonæ•°æ®ï¼š 12345678910111213141516171819202122232425&#123; &quot;name&quot;:&quot;ç‹‚ç¥è¯´java&quot;, &quot;url&quot;: &quot;http://baidu.com&quot;, &quot;page&quot;: &quot;1&quot;, &quot;isNonProfit&quot;:&quot;true&quot;, &quot;address&quot;: &#123; &quot;street&quot;: &quot;å«å…‰é—¨&quot;, &quot;city&quot;:&quot;é™•è¥¿è¥¿å®‰&quot;, &quot;country&quot;: &quot;ä¸­å›½&quot; &#125;, &quot;links&quot;: [ &#123; &quot;name&quot;: &quot;Bç«™&quot;, &quot;url&quot;: &quot;https://www.bilibili.com/&quot; &#125;, &#123; &quot;name&quot;: &quot;4399&quot;, &quot;url&quot;: &quot;https://www.4399.com/&quot; &#125;, &#123; &quot;name&quot;: &quot;ç™¾åº¦&quot;, &quot;url&quot;: &quot;https://www.baidu.com/&quot; &#125; ] 1234&lt;!--å¯¼å…¥JSæ–‡ä»¶--&gt;&lt;script src=&quot;https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;https://unpkg.com/axios/dist/axios.min.js&quot;&gt;&lt;/script&gt;&lt;script type=&quot;text/javascript&quot;&gt;&lt;/script&gt; 123456789101112131415161718192021222324&lt;div id=&quot;vue&quot;&gt;&lt;/div&gt;&lt;!--å¯¼å…¥JSæ–‡ä»¶--&gt;&lt;script src=&quot;https://cdn.jsdelivr.net/nmp/vue@2.5.21/dist/vue.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;https://unpkg.com/axios/dist/axios.min .js&quot;&gt;&lt;/script&gt;&lt;script type=&quot;text/javascript&quot;&gt; var vm = new Vue(&#123; el: &quot;#vue&quot;, data()&#123; return&#123; info:&#123; name:null, address:&#123; street:null, city: null, country: null &#125; &#125; &#125; &#125;, mounted()&#123;//é’©å­å‡½æ•°ï¼Œé“¾å¼ç¼–ç¨‹ axios.get(&#x27;data.json&#x27;).then(response=&gt;(this.info=response.data)); &#125; &#125;);&lt;/script&gt; è§£å†³æ•°æ®é—ªçƒé—®é¢˜ 12345&lt;style&gt; [v-clock]&#123; display: none; &#125;&lt;/style&gt; åœ¨headæ ‡ç­¾å†…ï¼Œæ²¡åŠ è½½æ•°æ®æ—¶ç™½å± è®¡ç®—å±æ€§12345computed:&#123;//è®¡ç®—å±æ€§ methods computedä¸­èƒ½é‡åï¼Œä¼˜å…ˆè°ƒç”¨æ–¹æ³• currentTime1: function () &#123; return Date.now(); &#125;&#125; è¿”å›çš„æ˜¯å±æ€§ slotï¼ˆæ’æ§½ï¼‰12345678910111213141516171819202122232425262728293031323334353637383940&lt;div id=&quot;vue&quot;&gt; &lt;todo&gt; &lt;todo-title slot=&quot;todo-title&quot; :title=&quot;title&quot;&gt;&lt;/todo-title&gt; &lt;todo-item slot=&quot;todo-item&quot; v-for=&quot;items in item&quot; :item=&quot;items&quot;&gt;&lt;/todo-item&gt; &lt;/todo&gt;&lt;/div&gt;&lt;!--å¯¼å…¥JSæ–‡ä»¶--&gt;&lt;script src=&quot;https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js&quot;&gt;&lt;/script&gt;&lt;script type=&quot;text/javascript&quot;&gt; Vue.component(&quot;todo&quot;,&#123; template: &#x27;&lt;div&gt;&#x27; + &#x27;&lt;slot name=&quot;todo-title&quot;&gt;&lt;/slot&gt;&#x27; + &#x27;&lt;ul&gt;&#x27; + &#x27;&lt;slot name=&quot;todo-item&quot;&gt;&lt;/slot&gt;&#x27; + &#x27;&lt;/ul&gt;&gt;&#x27; + &#x27;&lt;/div&gt;&#x27; &#125;); Vue.component(&quot;todo-title&quot;,&#123; props: [&#x27;title&#x27;], template: &#x27;&lt;div&gt;&#123;&#123;title&#125;&#125;&lt;/div&gt;&#x27; &#125;); Vue.component(&quot;todo-item&quot;,&#123; props: [&#x27;item&#x27;], template: &#x27;&lt;div&gt;&#123;&#123;item&#125;&#125; &lt;button @click=&quot;remove&quot;&gt;åˆ é™¤&lt;/button&gt; &lt;/div&gt;&#x27;, methods: &#123; remove: function () &#123; alert(&quot;åˆ é™¤æˆåŠŸ&quot;) &#125; &#125; &#125;); var vm = new Vue(&#123; el: &quot;#vue&quot;, data: &#123; title: &quot;xiaoliu&quot;, todo: [&#x27;æ•ˆç‡&#x27;,&#x27;å°åˆ˜&#x27;], item: [&#x27;wo&#x27;,&#x27;we&#x27;] &#125; &#125;);&lt;/script&gt; è‡ªå®šä¹‰äº‹ä»¶åˆ é™¤æ“ä½œè¦åœ¨ç»„ä»¶ä¸­å®Œæˆï¼Œæ¶‰åŠå‚æ•°ä¼ é€’ä¸äº‹ä»¶åˆ†å‘ï¼Œå¯ä»¥ä½¿ç”¨this.$emit( â€˜ è‡ªå®šä¹‰äº‹ä»¶å â€˜ , å‚æ•°) 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647&lt;div id=&quot;vue&quot;&gt; &lt;todo&gt; &lt;todo-title slot=&quot;todo-title&quot; :title=&quot;title&quot;&gt;&lt;/todo-title&gt; &lt;todo-item slot=&quot;todo-item&quot; v-for=&quot;(items,index) in item&quot; :item=&quot;items&quot; v-bind:index=&quot;index&quot; v-on:remove=&quot;removeItem(index)&quot; :key=&quot;index&quot;&gt;&lt;/todo-item&gt; &lt;/todo&gt;&lt;/div&gt;&lt;!--å¯¼å…¥JSæ–‡ä»¶--&gt;&lt;script src=&quot;https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js&quot;&gt;&lt;/script&gt;&lt;script type=&quot;text/javascript&quot;&gt; Vue.component(&quot;todo&quot;,&#123; template: &#x27;&lt;div&gt;&#x27; + &#x27;&lt;slot name=&quot;todo-title&quot;&gt;&lt;/slot&gt;&#x27; + &#x27;&lt;ul&gt;&#x27; + &#x27;&lt;slot name=&quot;todo-item&quot;&gt;&lt;/slot&gt;&#x27; + &#x27;&lt;/ul&gt;&gt;&#x27; + &#x27;&lt;/div&gt;&#x27; &#125;); Vue.component(&quot;todo-title&quot;,&#123; props: [&#x27;title&#x27;], template: &#x27;&lt;div&gt;&#123;&#123;title&#125;&#125;&lt;/div&gt;&#x27; &#125;); Vue.component(&quot;todo-item&quot;,&#123; props: [&#x27;item&#x27;,&#x27;index&#x27;], template: &#x27;&lt;div&gt;&#123;&#123;index&#125;&#125;----&#123;&#123;item&#125;&#125; &lt;button @click=&quot;remove&quot;&gt;åˆ é™¤&lt;/button&gt; &lt;/div&gt;&#x27;, methods: &#123; remove: function (index) &#123; this.$emit(&#x27;remove&#x27;,index); &#125; &#125; &#125;); var vm = new Vue(&#123; el: &quot;#vue&quot;, data: &#123; title: &quot;xiaoliu&quot;, todo: [&#x27;æ•ˆç‡&#x27;,&#x27;å°åˆ˜&#x27;], item: [&#x27;wo&#x27;,&#x27;we&#x27;] &#125;, methods: &#123; removeItem: function (index) &#123; console.log(&quot;shanchu&quot;+this.item[index]+&quot;ok&quot;); this.item.splice(index,1); &#125; &#125; &#125;);&lt;/script&gt;","categories":[],"tags":[]},{"title":"","slug":"4-24/å¾®æœåŠ¡","date":"2022-04-24T09:58:23.676Z","updated":"2022-04-24T10:49:48.540Z","comments":true,"path":"2022/04/24/4-24/å¾®æœåŠ¡/","link":"","permalink":"https://dddwah11.github.io/2022/04/24/4-24/%E5%BE%AE%E6%9C%8D%E5%8A%A1/","excerpt":"","text":"","categories":[],"tags":[]},{"title":"åˆ†å¸ƒå¼-Dubbo-Zookeeper","slug":"4-23/åˆ†å¸ƒå¼ç³»ç»Ÿç†è®º","date":"2022-04-23T09:00:14.508Z","updated":"2022-04-23T15:53:57.249Z","comments":true,"path":"2022/04/23/4-23/åˆ†å¸ƒå¼ç³»ç»Ÿç†è®º/","link":"","permalink":"https://dddwah11.github.io/2022/04/23/4-23/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E7%90%86%E8%AE%BA/","excerpt":"","text":"å®‰è£…zookeeper https://archive.apache.org/dist/zookeeper/zookeeper-3.7.0/ ä¸‹è½½ç¼–è¯‘åäºŒè¿›åˆ¶çš„åŒ… è¿è¡Œbinç›®å½•ä¸‹çš„zkServer.cmd windowsä¸‹ é—ªé€€è§£å†³ï¼šä¿®æ”¹é…ç½®æ–‡ä»¶ åŠ ä¸ªæš‚åœ(pause)æŸ¥çœ‹é”™è¯¯çš„åŸå›  åŸå› æ˜¯confç›®å½•ä¸‹æ²¡æœ‰ zoo.cfg å¤åˆ¶sampleè¿›è¡Œæ·»åŠ  è¿æ¥æœåŠ¡zkServer.cmd è¿æ¥å®¢æˆ·ç«¯zkCli.cmd åœ¨é¡¹ç›®ä¸­æ‰“åŒ…dubbo-admin mvn clean package -Dmaven.test.skip=true adminçš„åœ°å€ä¸º7001 é»˜è®¤è´¦å·å¯†ç éƒ½æ˜¯ root dubbo-adminæ˜¯ä¸€ä¸ªç›‘æ§ç®¡ç†åå°ï¼ŒæŸ¥çœ‹æˆ‘ä»¬å“ªäº›æœåŠ¡æ³¨å†Œï¼Œè¢«æ¶ˆè´¹ zookeeperæ˜¯ æ³¨å†Œä¸­å¿ƒ å¯¼å…¥ä¾èµ– 12345&lt;dependency&gt; &lt;groupId&gt;com.github.sgroschupf&lt;/groupId&gt; &lt;artifactId&gt;zkclient&lt;/artifactId&gt; &lt;version&gt;0.1&lt;/version&gt;&lt;/dependency&gt; 12345&lt;dependency&gt; &lt;groupId&gt;org.apache.dubbo&lt;/groupId&gt; &lt;artifactId&gt;dubbo-spring-boot-starter&lt;/artifactId&gt; &lt;version&gt;2.7.3&lt;/version&gt;&lt;/dependency&gt; æ—¥å¿—å†²çª 123456789101112&lt;dependency&gt; &lt;groupId&gt;org.apache.dubbo&lt;/groupId&gt; &lt;artifactId&gt;dubbo-spring-boot-starter&lt;/artifactId&gt; &lt;version&gt;2.7.3&lt;/version&gt; &lt;exclusions&gt; &lt;exclusion&gt; &lt;groupId&gt;org.slf4j&lt;/groupId&gt; &lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt; &lt;/exclusion&gt; &lt;/exclusions&gt;&lt;/dependency&gt; é…ç½®æ–‡ä»¶ 123456#æœåŠ¡åº”ç”¨åå­—dubbo.application.name=provider#æ³¨å†Œä¸­å¿ƒåœ°å€dubbo.registry.address=zookeeper://127.0.1:2181#å“ªäº›æœåŠ¡éœ€è¦è¢«æ³¨å†Œdubbo.scan.base-packages=com.xiaoliu.service æ¥ä¸‹æ¥å†å¯¼å…¥ä¾èµ– 12345&lt;dependency&gt; &lt;groupId&gt;org.apache.curator&lt;/groupId&gt; &lt;artifactId&gt;curator-recipes&lt;/artifactId&gt; &lt;version&gt;2.12.0&lt;/version&gt;&lt;/dependency&gt; 123456&lt;dependency&gt; &lt;groupId&gt;org.apache.zookeeper&lt;/groupId&gt; &lt;artifactId&gt;zookeeper&lt;/artifactId&gt; &lt;version&gt;3.4.14&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt;&lt;/dependency&gt; è¿™ä¸ªéœ€è¦æ’é™¤sl4jçš„ä¾èµ– 1234567#æ¶ˆè´¹è€…éœ€è¦å»å“ªæ‹¿æœåŠ¡éœ€è¦æš´éœ²åå­—dubbo.application.name=provider#å»æ³¨å†Œä¸­å¿ƒdubbo.registry.address=zookeeper://127.0.1:2181 æ¶ˆè´¹è€…ä¸šåŠ¡æ¥å£ 123456789101112æ¶ˆè´¹è€…ç”Ÿäº§è€…æ¥å£éƒ½å¿…é¡»ç›¸åŒ @Servicepublic class Service&#123; @Reference//å¼•ç”¨ï¼ŒPomåæ ‡ï¼Œå¯ä»¥å®šä¹‰è·¯å¾„ç›¸åŒçš„æ¥å£åï¼Œè¿œç¨‹å¼•ç”¨ TicketService ticketService; public void buyTicket()&#123; String ticket = ticketService.getTicket(); System.out.println(&quot;æ‹¿åˆ°ç¥¨&quot;+ticket); &#125;&#125; 1ã€æä¾›è€…æä¾›æœåŠ¡ â€‹ 1.å¯¼å…¥ä¾èµ– â€‹ 2.é…ç½®æ³¨å†Œä¸­å¿ƒåœ°å€ï¼Œä»¥åŠæœåŠ¡å‘ç°åï¼Œå’Œè¦æ‰«æçš„åŒ… â€‹ 3.åœ¨æƒ³è¦è¢«æ³¨å†Œçš„æœåŠ¡ä¸Šé¢ å¢åŠ ä¸€ä¸ªæ³¨è§£ @Service 2ã€æ¶ˆè´¹è€…å¦‚ä½•æ¶ˆè´¹ â€‹ 1.å¯¼å…¥ä¾èµ– â€‹ 2.é…ç½®æ³¨å†Œä¸­å¿ƒåœ°å€ï¼Œé…ç½®è‡ªå·±çš„æœåŠ¡å â€‹ 3.ä»è¿œç¨‹æ³¨å…¥æœåŠ¡ @Reference","categories":[],"tags":[]},{"title":"ä»»åŠ¡","slug":"4-23/å¼‚æ­¥ä»»åŠ¡","date":"2022-04-23T06:18:43.181Z","updated":"2022-04-23T08:59:16.750Z","comments":true,"path":"2022/04/23/4-23/å¼‚æ­¥ä»»åŠ¡/","link":"","permalink":"https://dddwah11.github.io/2022/04/23/4-23/%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1/","excerpt":"","text":"å¼‚æ­¥ä»»åŠ¡åœ¨ä¸šåŠ¡éœ€è¦å¼‚æ­¥å¤„ç†çš„æ–¹æ³•åŠ å…¥æ³¨è§£ @Async åœ¨å¯åŠ¨ç±»åŠ å…¥ @EnableAsync åœ¨æ§åˆ¶å±‚åŠ å…¥åŠ å…¥ä¸šåŠ¡å³å¯ é‚®ä»¶ä»»åŠ¡è¿™é‡Œç”¨qqé‚®ä»¶ é…ç½®æ–‡ä»¶ 123456#å¼€å¯åŠ å¯†éªŒè¯spring.mail.properties.mail.smtp.ssl.enable=truespring.mail.username=1937589397@qq.comspring.mail.password=ixxxxxxxxxxbspring.mail.host=smtp.qq.com 123456789101112131415161718@Autowired JavaMailSender mailSender; @Test void contextLoads() &#123;// å‘é€é‚®ä»¶// å‘ä»¶äºº// å†…å®¹ SimpleMailMessage message = new SimpleMailMessage(); message.setSubject(&quot;å°åˆ˜&quot;); message.setText(&quot;hello&quot;); message.setFrom(&quot;1937589397@qq.com&quot;); message.setTo(&quot;1937589397@qq.com&quot;); mailSender.send(message); &#125; å¤æ‚é‚®ä»¶ 1234567891011121314 MimeMessage mimeMessage = mailSender.createMimeMessage();// ç»„è£… MimeMessageHelper helper = new MimeMessageHelper(mimeMessage,true); helper.setSubject(subject); helper.setText(text,true);// é™„ä»¶ helper.addAttachment(&quot;1.jpg&quot;,new File(&quot;D:\\\\å£çº¸\\\\5b8b4cf6143640c98cd46cd77d26f292.jpg&quot;)); helper.setTo(&quot;1937589397@qq.com&quot;); helper.setFrom(&quot;1937589397@qq.com&quot;); mailSender.send(mimeMessage); å®šæ—¶æ‰§è¡Œä»»åŠ¡12345678TaskeScheduler ä»»åŠ¡è°ƒåº¦è€…TaskExecutor è®¤ä¸ºæ‰§è¡Œè€…@EnableScuedulingå¼€å¯å®šæ—¶åŠŸèƒ½çš„æ³¨è§£åœ¨å¯åŠ¨ç±»@Scheduled ä»€ä¹ˆæ—¶å€™æ‰§è¡Œ Cronè¡¨è¾¾å¼ 1234567891011121314@Servicepublic class ScheduleService &#123;// cronè¡¨è¾¾// ç§’ åˆ† æ—¶ æ—¥ æœˆ å‘¨å‡ // ä¸‹é¢è¡¨è¾¾å¼è¡¨ç¤ºæ˜¯ æ¯ä¸€å‘¨çš„æ¯0ç§’æ‰§è¡Œ//@Scheduled(cron = &quot;0 * * * * 0-7&quot;)// ä¸‹é¢è¡¨è¾¾çš„æ˜¯ æ¯ä¸€å¤©å¤©çš„16æ—¶ 44åˆ† æ‰§è¡Œ @Scheduled(cron = &quot;1 48 16 * * ?&quot;)// 30 0/5 10 18, * ? æ¯å¤© 10ç‚¹å’Œ18ç‚¹ æ¯éš”äº”åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ public void hello()&#123; System.out.println(&quot;æ‚¨è¢«æ‰§è¡Œäº†&quot;); &#125;&#125;","categories":[],"tags":[]},{"title":"swagger","slug":"4-22/swagger","date":"2022-04-22T08:42:39.305Z","updated":"2022-04-23T06:18:47.217Z","comments":true,"path":"2022/04/22/4-22/swagger/","link":"","permalink":"https://dddwah11.github.io/2022/04/22/4-22/swagger/","excerpt":"","text":"Swaggerç®€ä»‹ å‰åç«¯åˆ†ç¦» Vue + SpringBoot Swaggeræœ€æµè¡Œçš„APIæ¡†æ¶ åœ¨é¡¹ç›®ä¸­ä½¿ç”¨swaggeréœ€è¦springfoxï¼› swagger2 ui spirngbooté›†æˆswagger1ã€æ–°å»ºspringwebé¡¹ç›® 2ã€å¯¼å…¥ä¾èµ– 12345&lt;dependency&gt; &lt;groupId&gt;io.springfox&lt;/groupId&gt; &lt;artifactId&gt;springfox-swagger2&lt;/artifactId&gt; &lt;version&gt;3.0.0&lt;/version&gt;&lt;/dependency&gt; 12345&lt;dependency&gt; &lt;groupId&gt;io.springfox&lt;/groupId&gt; &lt;artifactId&gt;springfox-swagger-ui&lt;/artifactId&gt; &lt;version&gt;3.0.0&lt;/version&gt;&lt;/dependency&gt; 3ã€é…ç½®swagger 1234@Configuration@EnableSwagger2//å¼€å¯swagger2public class SwaggerConfig &#123;&#125; æµ‹è¯•é¡µé¢ http://localhost:8080/swagger-ui.html swaggerçš„beanå®ä¾‹ Docket SwaggerConfig 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849package com.xiaoliu.config;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import springfox.documentation.RequestHandler;import springfox.documentation.builders.RequestHandlerSelectors;import springfox.documentation.service.ApiInfo;import springfox.documentation.service.Contact;import springfox.documentation.spi.DocumentationType;import springfox.documentation.spring.web.plugins.Docket;import springfox.documentation.swagger2.annotations.EnableSwagger2;import java.util.ArrayList;/** * @author: 61åˆ† * @date: 2022/4/22 17:39 * @description: */@Configuration@EnableSwagger2//å¼€å¯swagger2public class SwaggerConfig &#123;// é…ç½®swaggerçš„Docket beanå®ä¾‹ @Bean public Docket docket()&#123; return new Docket(DocumentationType.SWAGGER_2) .apiInfo(apiInfo()) &#125;// é…ç½®swaggerä¿¡æ¯=apiinfo private ApiInfo apiInfo()&#123; System.out.println(&quot;doswagger&quot;);// ä½œè€…ä¿¡æ¯ Contact contact = new Contact(&quot;xiaoliu&quot;, &quot;https://dddwah11.github.io/&quot;, &quot;1937589397@qq.com&quot;); return new ApiInfo( &quot;APIInfo&quot;, &quot;swaggeré…ç½®&quot;, &quot;v1.0&quot;, &quot;https://dddwah11.github.io/&quot;, contact, &quot;Apache 2.0&quot;, &quot;http://www.apache.org/licenses/LINCENSE-2.0&quot;, new ArrayList&lt;&gt;() ); &#125;&#125; Swaggeré…ç½®æ‰«ææ¥å£Docket.select() 123456789101112 .enable(false);// .select()// RequestHandlerSelectorsé…ç½®éœ€è¦æ‰«ææ¥å£çš„æ–¹å¼// basePackageæŒ‡å®šè¦æ‰«æçš„åŒ…// any()æ‰«æå…¨éƒ¨// none()éƒ½ä¸æ‰«æ// withClassAnnotation;æ‰«æç±»ä¸Šçš„æ³¨è§£ï¼Œå‚æ•°æ˜¯ä¸€ä¸ªæ³¨è§£çš„åå°„å¯¹è±¡// withMethodAnnotation;æ‰«ææ–¹æ³•ä¸Šçš„æ³¨è§£ .apis(RequestHandlerSelectors.basePackage(&quot;com.xiaoliu.helloController&quot;))// path()è¿‡æ»¤è·¯å¾„ .build(); é…ç½®æ˜¯å¦å¯åŠ¨swagger 12.enable(false);//ä¸å¯åŠ¨swagger.select() æˆ‘ä»¬å¸Œæœ›swaggeråœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œåœ¨å‘å¸ƒæ—¶ä¸ä½¿ç”¨ åˆ¤æ–­æ˜¯ä¸æ˜¯ç”Ÿäº§ç¯å¢ƒ æ³¨å…¥ enable() 12345678910111213 @Bean public Docket docket(Environment environment)&#123;// è®¾ç½®è¦æ˜¾ç¤ºçš„flagç¯å¢ƒ Profiles profiles =Profiles.of(&quot;dev&quot;,&quot;test&quot;);// è·å–é¡¹ç›®ç¯å¢ƒ// é€šè¿‡environment.acceptsProfilesåˆ¤æ–­æ˜¯å¦å¤„åœ¨è‡ªå·±è®¾å®šçš„ç¯å¢ƒ boolean b = environment.acceptsProfiles(profiles); return new Docket(DocumentationType.SWAGGER_2) .apiInfo(apiInfo()) .enable(b) é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ç”Ÿäº§å’Œå‘å¸ƒç¯å¢ƒ ä¸»é…ç½®æ–‡ä»¶è®¾ç½® 1spring.profiles.active=å½“å‰ç¯å¢ƒ swaggeré…ç½®APIæ–‡æ¡£åˆ†ç»„12.apiInfo(apiInfo()).groupName(&quot;hello&quot;) å¦‚ä½•é…ç½®å¤šä¸ªåˆ†ç»„ 1234@Beanpublic Docket docket1()&#123; return new Docket(DocumentationType.SWAGGER_2).groupName(&quot;A&quot;);&#125; @ApiModel()//æ–‡æ¡£æ³¨é‡Š","categories":[],"tags":[]},{"title":"shiroå®‰å…¨æ¡†æ¶ -springbootä¸­é›†æˆ","slug":"4-21/shiro","date":"2022-04-21T07:14:33.034Z","updated":"2022-04-21T16:22:20.875Z","comments":true,"path":"2022/04/21/4-21/shiro/","link":"","permalink":"https://dddwah11.github.io/2022/04/21/4-21/shiro/","excerpt":"","text":"1ã€å¯¼å…¥ä¾èµ– 2ã€é…ç½®æ–‡ä»¶ 3ã€åº”ç”¨ç¨‹åº 12345678910111213141516è·å–å½“å‰å¯¹è±¡Subject currentUser = SecurityUtils.getSubject();è·å–å½“å‰sessionSession session = currentUser.getSession();åˆ¤æ–­ç”¨æˆ·æ˜¯å¦è¢«è®¤è¯currentUser.isAuthenticated()è·å–å½“å‰è®¤è¯currentUser.getPrincipal() ç”¨æˆ·è§’è‰²currentUser.hasRole ç²—ç²’åº¦ currentUser.isPermitted(&quot;lightsaber:wield&quot;)ç»†ç²’åº¦ currentUser.isPermitted(&quot;winnebago:drive:eagle5&quot;)ç™»å‡ºcurrentUser.logout() shiroç™»å½•è®¤è¯1ã€åˆ›å»ºrealmå¯¹è±¡ï¼Œéœ€è¦è‡ªå®šä¹‰ç±»ï¼š 123456789101112131415public class UserRealm extends AuthorizingRealm &#123;//æˆæƒ @Override protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principalCollection) &#123; System.out.println(&quot;æˆæƒdoGetAuthorizationInfo&quot;); return null; &#125;//è®¤è¯ @Override protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) throws AuthenticationException &#123; System.out.println(&quot;è®¤è¯doGetAuthenticationInfo&quot;); return null; &#125;&#125; 1234567891011@Configurationpublic class shiroConfig &#123;// ShiroFilterFactoryBean// Manager// åˆ›å»ºrealmå¯¹è±¡ @Bean public UserRealm userRealm()&#123; return new UserRealm(); &#125;&#125; 2ã€defaultWebSecurityManager 1234567@Bean public DefaultWebSecurityManager getDefaultWebSecurityManager(@Qualifier(&quot;userRealm&quot;) UserRealm userRealm)&#123; DefaultWebSecurityManager defaultWebSecurityManager = new DefaultWebSecurityManager(); defaultWebSecurityManager.setRealm(userRealm);// å…³è”realm return defaultWebSecurityManager; &#125; 3ã€shiroFiterFactoryBean 1234567 @Bean(name = &quot;DefaultWebSecurityManager&quot;) public ShiroFilterFactoryBean getShiroFilterFactoryBean(@Qualifier(&quot;DefaultWebSecurityManager&quot;) DefaultWebSecurityManager defaultWebSecurityManager)&#123; ShiroFilterFactoryBean shiroFilterFactoryBean = new ShiroFilterFactoryBean();// å…³è”webSecurityManager shiroFilterFactoryBean.setSecurityManager(defaultWebSecurityManager); return shiroFilterFactoryBean; &#125; ShiroFilterFactoryBean 12345678910111213141516171819202122232425@Bean public ShiroFilterFactoryBean getShiroFilterFactoryBean(@Qualifier(&quot;securityManager&quot;) DefaultWebSecurityManager defaultWebSecurityManager)&#123; ShiroFilterFactoryBean bean = new ShiroFilterFactoryBean();// å…³è”webSecurityManager// è®¾ç½®å®‰å…¨ç®¡ç†å™¨ bean.setSecurityManager(defaultWebSecurityManager);// æ·»åŠ shiroçš„å†…ç½®è¿‡æ»¤å™¨ /* anon:æ— éœ€è®¤è¯ authc: å¿…é¡»è®¤è¯ user: å¿…é¡»æ‹¥æœ‰ è®°ä½æˆ‘ åŠŸèƒ½æ‰èƒ½å®ç° perms: æ‹¥æœ‰å¯¹æŸä¸ªèµ„æºæƒé™åŠŸèƒ½æ‰èƒ½èƒ½è®¿é—® role: æ‹¥æœ‰æŸä¸ªè§’è‰²æƒé™ */ Map&lt;String, String&gt; filterMap = new LinkedHashMap&lt;&gt;(); filterMap.put(&quot;/user/add&quot;,&quot;authc&quot;); filterMap.put(&quot;/user/update&quot;,&quot;authc&quot;); System.out.println(&quot;filterMap&quot;); bean.setFilterChainDefinitionMap(filterMap); return bean; &#125; å¯åœ¨ShiroFilterFactoryBean è®¾ç½®ç™»å½• bean.setLoginUrl(&quot;/toLogin&quot;); shiroå®ç°ç”¨æˆ·è®¤è¯åœ¨Controllerä¸­ 12345678910111213141516171819202122@RequestMapping(&quot;/login&quot;) public String login(String username,String password)&#123; // è·å–å¯¹è±¡ Subject subject = SecurityUtils.getSubject();// å°è£…ç™»å½•å¯¹è±¡çš„æ•°æ®ä¸ºtoken UsernamePasswordToken token = new UsernamePasswordToken(username, password); subject.login(token); try &#123; subject.login(token);//æ‰§è¡Œç™»å½•æ–¹æ³•ï¼Œæ— å¼‚å¸¸å°±æ‰§è¡Œ return &quot;index&quot;; &#125; catch (UnknownAccountException e) &#123;//ç”¨æˆ·åä¸å­˜åœ¨ model.addAttribute(&quot;msg&quot;,&quot;ç”¨æˆ·åé”™è¯¯&quot;); return &quot;login&quot;; &#125; catch (IncorrectCredentialsException e)&#123;//å¯†ç ä¸å­˜åœ¨ model.addAttribute(&quot;msg&quot;,&quot;å¯†ç é”™è¯¯&quot;); return &quot;login&quot;; &#125; catch (LockedAccountException e)&#123; model.addAttribute(&quot;msg&quot;,&quot;è´¦å·è¢«é”å®š&quot;); return &quot;login&quot;; &#125; &#125; UserRealmç±»ä¸­ 1234567891011121314@Override protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) throws AuthenticationException &#123; System.out.println(&quot;è®¤è¯doGetAuthenticationInfo&quot;);// ç”¨æˆ·åï¼Œå¯†ç ï¼Œæ•°æ®åº“ä¸­å– String username= &quot;root&quot;; String password= &quot;123456&quot;; UsernamePasswordToken token = (UsernamePasswordToken) authenticationToken; if (!token.getUsername().equals(username))&#123; return null;//æŠ›å‡ºå¼‚å¸¸UnknownAccountException &#125;// å¯†ç è®¤è¯shiroåš return new SimpleAuthenticationInfo(&quot;&quot;,password,&quot;&quot;); &#125; Shiroæ•´åˆMybatisæ­å»ºè„šæ‰‹æ¶å¹¶æµ‹è¯•ï¼Œé€šè¿‡å†è¿›è¡Œä¸‹é¢çš„æµ‹è¯• åœ¨UserRealmä¸­å¯¼å…¥ä¸šåŠ¡å±‚æ¥å£ 12@AutowiredUserService userService; 123456789101112// è¿æ¥æ•°æ®åº“ UsernamePasswordToken userToken = (UsernamePasswordToken) authenticationToken; User user = userService.queryUserByName(userToken.getUsername()); if (user==null)&#123; //æŸ¥æ— æ­¤äºº return null;//UnknownAccountException &#125;// å¯†ç è®¤è¯shiroåš return new SimpleAuthenticationInfo(&quot;&quot;,user.getPassword(),&quot;&quot;); &#125; UserRealmç±»ä¸­ 123456789101112131415// è¿æ¥æ•°æ®åº“ UsernamePasswordToken userToken = (UsernamePasswordToken) authenticationToken; User user = userService.queryUserByName(userToken.getUsername()); if (user==null)&#123; //æŸ¥æ— æ­¤äºº return null;//UnknownAccountException &#125;// åŠ å¯†ï¼šMD5åŠ å¯†ï¼ŒMD5ç›å€¼åŠ å¯†// md5ï¼šxwefqbrb134513451223qwer md5+ç›å€¼ï¼š xwefqbrb134513451223qwerusername// å¯†ç è®¤è¯shiroåšï¼ŒåŠ å¯†äº†// å¯†ç è®¤è¯shiroåš return new SimpleAuthenticationInfo(&quot;&quot;,user.getPassword(),&quot;&quot;); &#125; Shiroè¯·æ±‚æˆæƒå®ç° åœ¨shiroConfigç±»ä¸­ 12// æˆæƒ filterMap.put(&quot;/user/add&quot;,&quot;perms[user:add]&quot;); è®¾ç½®æœªæˆæƒçš„è¯·æ±‚ 12// è®¾ç½®æœªæˆæƒçš„è¯·æ±‚ bean.setUnauthorizedUrl(&quot;/noauth&quot;); è®¾ç½®Controller 12345@RequestMapping(&quot;/noauth&quot;)@ResponseBodypublic String unauthorized()&#123; return &quot;æœªç»æˆæƒæ— æ³•è®¿é—®è¯¥é¡µé¢&quot;;&#125; ç¼–å†™controllerå±‚ 12345@RequestMapping(&quot;/noauth&quot;)@ResponseBodypublic String unauthorized()&#123; return &quot;æœªç»æˆæƒæ— æ³•è®¿é—®è¯¥é¡µé¢&quot;;&#125; æˆæƒã€12345678//æˆæƒ @Override protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principalCollection) &#123; System.out.println(&quot;æˆæƒdoGetAuthorizationInfo&quot;); SimpleAuthorizationInfo info = new SimpleAuthorizationInfo(); info.addStringPermission(&quot;user:add&quot;);//è¿™è¡Œæ˜¯å…¨éƒ¨äººéƒ½è·å–æˆæƒï¼Œæƒ³æŒ‡å®šçš„äººè·å¾—æˆæƒå°±æ³¨é‡Šè¿™è¡Œ return info; &#125; æŒ‡å®šæ•°æ®åº“ä¸­çš„æŸäº›ç”¨æˆ·è·å–æ•°æ® æ•°æ®åº“ä¸­è®¾å®šæƒé™ UserRealmç±»ä¸­ 123456// æ‹¿åˆ°å½“å‰ç™»å½•çš„å¯¹è±¡ Subject subject = SecurityUtils.getSubject(); User currentUser = (User)subject.getPrincipal();//æ‹¿åˆ°userå¯¹è±¡ info.addStringPermission(currentUser.getPerms()); return info; shiroConfigç±»ä¸­ 12filterMap.put(&quot;/user/add&quot;,&quot;perms[user:add]&quot;);filterMap.put(&quot;/user/update&quot;,&quot;perms[user:update]&quot;); Shiroæ•´åˆThymeleafå¯¼å…¥ä¾èµ– shiro-thymeleaf 12345&lt;dependency&gt; &lt;groupId&gt;com.github.theborakompanioni&lt;/groupId&gt; &lt;artifactId&gt;thymeleaf-extras-shiro&lt;/artifactId&gt; &lt;version&gt;2.1.0&lt;/version&gt;&lt;/dependency&gt; åœ¨UserRealmç±»ä¸­ 12345// æ•´åˆshirodialectï¼šæ•´åˆ th å’Œ shiro @Bean public ShiroDialect getshiroDialect()&#123; return new ShiroDialect(); &#125;","categories":[],"tags":[]},{"title":"æ•´åˆMybatis","slug":"4-18/æ•´åˆä¸­Mybatis","date":"2022-04-18T07:16:30.446Z","updated":"2022-04-18T13:44:42.616Z","comments":true,"path":"2022/04/18/4-18/æ•´åˆä¸­Mybatis/","link":"","permalink":"https://dddwah11.github.io/2022/04/18/4-18/%E6%95%B4%E5%90%88%E4%B8%ADMybatis/","excerpt":"","text":"å‡†å¤‡å·¥ä½œï¼šæ­å»ºç¯å¢ƒå¹¶æµ‹è¯•ï¼ˆå¯¼å…¥åŒ…ï¼Œé…ç½®æ–‡ä»¶ï¼Œmyabtisé…ç½®ï¼Œç¼–å†™sqlï¼‰ 1ã€ç¼–å†™å®ä½“ç±»1234567891011121314151617181920package com.xiaoliu.pojo;import lombok.AllArgsConstructor;import lombok.Data;import lombok.NoArgsConstructor;/** * @author: 61åˆ† * @date: 2022/4/18 15:29 * @description: */@Data@AllArgsConstructor@NoArgsConstructorpublic class User &#123; private Integer id; private String name; private String password;&#125; 2ã€ç¼–å†™æ¥å£1234567891011package com.xiaoliu.mapper;/** * @author: 61åˆ† * @date: 2022/4/18 15:32 * @description: */@org.apache.ibatis.annotations.Mapperpublic interface Mapper &#123;&#125; 1@Repository //Daoå±‚ ç”¨è¯¥æ³¨è§£ å†åˆ°resourceç›®å½•ä¸‹é…ç½®xmlæ–‡ä»¶ 123456789&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;&lt;mapper namespace=&quot;com.xiaoliu.mapper&quot;&gt; &lt;select id=&quot;selectBlog&quot; resultType=&quot;User&quot;&gt; select * from Blog where id = #&#123;id&#125; &lt;/select&gt;&lt;/mapper&gt; åœ¨springbootä¸­é…ç½®æ–‡ä»¶åˆ«ååŠmapper.xmlæ–‡ä»¶ 12mybatis.type-aliases-package=com.xiaoliu.pojomybatis.mapper-locations=classpath:/mybatis/mapper/*.xml å¢åˆ æ”¹æŸ¥ 1234567891011121314151617&lt;select id=&quot;queryUserListById&quot; resultType=&quot;User&quot;&gt; select * from mybatis.user where id = #&#123;id&#125;&lt;/select&gt;&lt;select id=&quot;queryUserList&quot; resultType=&quot;User&quot;&gt; select * from mybatis.user&lt;/select&gt;&lt;insert id=&quot;addUser&quot; parameterType=&quot;User&quot;&gt; insert into mybatis.user (id, name, password) values (#&#123;id&#125;,#&#123;name&#125;,#&#123;password&#125;);&lt;/insert&gt;&lt;update id=&quot;updateUser&quot; parameterType=&quot;User&quot;&gt; update mybatis.user set name = #&#123;name&#125;, password = #&#123;password&#125; where id = #&#123;id&#125;; é…ç½®æ–‡ä»¶ï¼š 12345678910111213141516# åº”ç”¨åç§°spring.application.name=mybatisSpringboot# æ•°æ®åº“é©±åŠ¨ï¼šspring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver# æ•°æ®æºåç§°spring.datasource.name=defaultDataSource# æ•°æ®åº“è¿æ¥åœ°å€spring.datasource.url=jdbc:mysql://localhost:3306/mybatis?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf-8# æ•°æ®åº“ç”¨æˆ·å&amp;å¯†ç ï¼šspring.datasource.username=rootspring.datasource.password=123456# åº”ç”¨æœåŠ¡ WEB è®¿é—®ç«¯å£server.port=8080mybatis.type-aliases-package=com.xiaoliu.pojomybatis.mapper-locations=classpath:/mybatis/mapper/*.xml","categories":[],"tags":[]},{"title":"æ•´åˆDruid","slug":"4-18/æ•´åˆdruid","date":"2022-04-18T06:31:03.389Z","updated":"2022-04-18T07:16:17.307Z","comments":true,"path":"2022/04/18/4-18/æ•´åˆdruid/","link":"","permalink":"https://dddwah11.github.io/2022/04/18/4-18/%E6%95%B4%E5%90%88druid/","excerpt":"","text":"1ã€å¯¼å…¥ç›¸å…³ä¾èµ–123456789101112&lt;dependency&gt; &lt;groupId&gt;log4j&lt;/groupId&gt; &lt;artifactId&gt;log4j&lt;/artifactId&gt; &lt;version&gt;1.2.12&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;com.alibaba&lt;/groupId&gt; &lt;artifactId&gt;druid&lt;/artifactId&gt; &lt;version&gt;1.2.9&lt;/version&gt;&lt;/dependency&gt; 2ã€é…ç½®æ–‡ä»¶1234567891011121314151617181920212223type: com.alibaba.druid.pool.DruidDataSource #SpringBooté»˜è®¤æ˜¯ä¸æ³¨å…¥è¿™äº›çš„ï¼Œéœ€è¦è‡ªå·±ç»‘å®š #druidæ•°æ®æºä¸“æœ‰é…ç½® initialSize: 5 minIdle: 5 maxActive: 20 maxWait: 60000 timeBetweenEvictionRunsMillis: 60000 minEvictableIdleTimeMillis: 300000 validationQuery: SELECT 1 FROM DUAL testWhileIdle: true testOnBorrow: false testOnReturn: false poolPreparedStatements: true #é…ç½®ç›‘æ§ç»Ÿè®¡æ‹¦æˆªçš„filtersï¼Œstatï¼šç›‘æ§ç»Ÿè®¡ã€log4jï¼šæ—¥å¿—è®°å½•ã€wallï¼šé˜²å¾¡sqlæ³¨å…¥ #å¦‚æœå…è®¸æŠ¥é”™ï¼Œjava.lang.ClassNotFoundException: org.apache.Log4j.Properity #åˆ™å¯¼å…¥log4j ä¾èµ–å°±è¡Œ filters: stat,wall,log4j maxPoolPreparedStatementPerConnectionSize: 20 useGlobalDataSourceStat: true connectionProperties: druid.stat.mergeSql=true;druid.stat.slowSqlMillis=500 é…ç½®è¿›å»æ²¡ç”¨ï¼Œä¹Ÿèƒ½è¿›å»ï¼Œå…ˆæ”¾ç€ 3ã€ç»‘å®šé…ç½®æ–‡ä»¶1234567891011121314151617181920212223package com.xiaoliu.config;import com.alibaba.druid.pool.DruidDataSource;import org.springframework.boot.context.properties.ConfigurationProperties;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import javax.sql.DataSource;/** * @author: 61åˆ† * @date: 2022/4/18 14:33 * @description: */@Configurationpublic class DruidConfig &#123; @ConfigurationProperties(prefix = &quot;spring.datasource&quot;) @Bean public DataSource DruidDataSource()&#123; return new DruidDataSource(); &#125;&#125; 4ã€DruidConfig12345678910111213141516171819202122232425262728293031323334353637383940414243444546package com.xiaoliu.config;import com.alibaba.druid.pool.DruidDataSource;import com.alibaba.druid.support.http.StatViewServlet;import org.springframework.boot.context.properties.ConfigurationProperties;import org.springframework.boot.web.servlet.ServletRegistrationBean;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import javax.sql.DataSource;import java.util.HashMap;/** * @author: 61åˆ† * @date: 2022/4/18 14:33 * @description: */@Configurationpublic class DruidConfig &#123; @ConfigurationProperties(prefix = &quot;spring.datasource&quot;) @Bean public DataSource DruidDataSource()&#123; return new DruidDataSource(); &#125;// åå°ç›‘æ§:web.xml// springbooté›†æˆäº†servletï¼Œæ²¡æœ‰web.xml å¯ä»¥ä½¿ç”¨ServletRegistrationBeanï¼Œæ³¨å†Œ @Bean public ServletRegistrationBean statViewServlet()&#123; ServletRegistrationBean&lt;StatViewServlet&gt; bean = new ServletRegistrationBean&lt;&gt;(new StatViewServlet(), &quot;/druid/*&quot;);// åå°æœ‰äººç™»é™†ï¼Œè´¦å·å¯†ç é…ç½® HashMap&lt;String, String&gt; initParameter = new HashMap&lt;&gt;();// è®¾ç½®å‚æ•° initParameter.put(&quot;loginUsername&quot;, &quot;admin&quot;);//é»˜è®¤çš„æ•°å€¼ initParameter.put(&quot;loginPassword&quot;,&quot;123456&quot;);//é»˜è®¤çš„æ•°å€¼// å…è®¸è°è®¿é—® initParameter.put(&quot;allow&quot;,&quot;&quot;);//åé¢å‚æ•°ä¸å†™ï¼Œä»»ä½•äººéƒ½èƒ½è®¿é—®// ç¦æ­¢è°è®¿é—® initParameter.put(&quot;xxx&quot;,&quot;ipåœ°å€&quot;); bean.setInitParameters(initParameter);//è®¾ç½®åˆå§‹åŒ–å‚æ•° return bean; &#125;&#125; è¿‡æ»¤å™¨ 12345678910111213// filter @Bean public FilterRegistrationBean filterStart()&#123; FilterRegistrationBean&lt;Filter&gt; bean = new FilterRegistrationBean&lt;&gt;(); bean.setFilter(new WebStatFilter());// è®¾ç½®è¿‡æ»¤è¯·æ±‚ HashMap&lt;String, String&gt; initParameters = new HashMap&lt;&gt;();// è®¾ç½®ä¸ç»Ÿè®¡çš„ä¸œè¥¿ initParameters.put(&quot;exclusions&quot;,&quot;*.js,*.css,/druid/*&quot;); bean.setInitParameters(initParameters); return bean; &#125;","categories":[],"tags":[]},{"title":"springWeb-02å¼€å‘","slug":"4-16/springboot-web-02","date":"2022-04-16T14:15:45.600Z","updated":"2022-04-17T14:46:06.241Z","comments":true,"path":"2022/04/16/4-16/springboot-web-02/","link":"","permalink":"https://dddwah11.github.io/2022/04/16/4-16/springboot-web-02/","excerpt":"","text":"å‘˜å·¥åˆ—è¡¨å±•ç¤º æå‰å…¬å…±é¡µé¢ &#96;th:replace&#x3D;â€~{commons&#x2F;commons::sidebar&#96;&#96; &#96;&#96;&#96; å¦‚æœè¦ä¼ å‚ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼ˆï¼‰ä¼ å‚ï¼Œæ¥å—åˆ¤æ–­ åˆ—è¡¨å¾ªåå±•ç¤º &#96; &lt;td th:text&#x3D;â€$","categories":[],"tags":[]},{"title":"springWebå¼€å‘","slug":"4-16/springboot-webå¼€å‘","date":"2022-04-16T05:16:40.666Z","updated":"2022-04-16T14:15:31.726Z","comments":true,"path":"2022/04/16/4-16/springboot-webå¼€å‘/","link":"","permalink":"https://dddwah11.github.io/2022/04/16/4-16/springboot-web%E5%BC%80%E5%8F%91/","excerpt":"","text":"1ã€é¦–é¡µé…ç½®ï¼šæ‰€æœ‰htmlé¡µé¢ä½¿ç”¨thymeleafæ¥ç®¡ï¼šurl:@&#123;&#125; é¦–é¡µï¼š 123456789101112131415161718192021222324252627282930313233343536&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot; xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt; &lt;head&gt; &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot;&gt; &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;&gt; &lt;meta name=&quot;description&quot; content=&quot;&quot;&gt; &lt;meta name=&quot;author&quot; content=&quot;&quot;&gt; &lt;title&gt;Signin Template for Bootstrap&lt;/title&gt; &lt;!-- Bootstrap core CSS --&gt; &lt;link th:href=&quot;@&#123;/css/bootstrap.min.css&#125;&quot; rel=&quot;stylesheet&quot;&gt; &lt;!-- Custom styles for this template --&gt; &lt;link th:href=&quot;@&#123;/css/signin.css&#125;&quot; rel=&quot;stylesheet&quot;&gt; &lt;/head&gt; &lt;body class=&quot;text-center&quot;&gt; &lt;form class=&quot;form-signin&quot; action=&quot;dashboard.html&quot;&gt; &lt;img class=&quot;mb-4&quot; th:src=&quot;@&#123;/img/bootstrap-solid.svg&#125;&quot; alt=&quot;&quot; width=&quot;72&quot; height=&quot;72&quot;&gt; &lt;h1 class=&quot;h3 mb-3 font-weight-normal&quot;&gt;Please sign in&lt;/h1&gt; &lt;label class=&quot;sr-only&quot;&gt;Username&lt;/label&gt; &lt;input type=&quot;text&quot; class=&quot;form-control&quot; placeholder=&quot;Username&quot; required=&quot;&quot; autofocus=&quot;&quot;&gt; &lt;label class=&quot;sr-only&quot;&gt;Password&lt;/label&gt; &lt;input type=&quot;password&quot; class=&quot;form-control&quot; placeholder=&quot;Password&quot; required=&quot;&quot;&gt; &lt;div class=&quot;checkbox mb-3&quot;&gt; &lt;label&gt; &lt;input type=&quot;checkbox&quot; value=&quot;remember-me&quot;&gt; Remember me &lt;/label&gt; &lt;/div&gt; &lt;button class=&quot;btn btn-lg btn-primary btn-block&quot; type=&quot;submit&quot;&gt;Sign in&lt;/button&gt; &lt;p class=&quot;mt-5 mb-3 text-muted&quot;&gt;Â© 2017-2018&lt;/p&gt; &lt;a class=&quot;btn btn-sm&quot;&gt;ä¸­æ–‡&lt;/a&gt; &lt;a class=&quot;btn btn-sm&quot;&gt;English&lt;/a&gt; &lt;/form&gt; &lt;/body&gt;&lt;/html&gt; controllerï¼š 1234567891011121314151617181920212223package com.xiaoliu.config;import org.springframework.context.annotation.Configuration;import org.springframework.web.servlet.config.annotation.ViewControllerRegistry;import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;/** * @author: 61åˆ† * @date: 2022/4/15 21:17 * @description: *///æ‰©å±• springmvc dispatcherservlet@Configurationpublic class MyMvcConfig implements WebMvcConfigurer &#123; //è§†å›¾è·³è½¬ @Override public void addViewControllers(ViewControllerRegistry registry) &#123; registry.addViewController(&quot;/&quot;).setViewName(&quot;index&quot;); registry.addViewController(&quot;/index.html&quot;).setViewName(&quot;index&quot;); &#125;&#125; 2ã€é¡µé¢å›½é™…åŒ–i18n è®¾ç½®login.propertiesæ–‡ä»¶ï¼Œ login.tip login.password login.username login.remember æ€ä¹ˆè¯†åˆ«å›½é™…åŒ– é€šè¿‡SpirngBootâ€”â€”MessageSourceAutofigurationç±» åœ¨é…ç½®application.properties spring.messages.basename=i18n.login thymeleafå›½é™…åŒ–æ¶ˆæ¯è¯­æ³•ï¼š#&#123;&#125; 1th:text=&quot;#&#123;login.password&#125;&quot; å®ç°è¯­è¨€åˆ‡æ¢ 1th:href=&quot;@&#123;/index.html(l=&#x27;zh_CN&#x27;)&#125;&quot;&gt;ä¸­æ–‡ 1th:href=&quot;@&#123;/index.html(l=&#x27;en_US&#x27;)&#125;&quot;&gt;Englis divè‡ªå·±çš„ç»„ä»¶åœ¨configä¸­çš„MyMvcConfigç±»ä¸­ å¹¶å°†å…¶é…ç½®åˆ°springbootå®¹å™¨ä¸­ @Bean 12345// å‘å®¹å™¨ä¸­æ³¨å…¥ç»„ä»¶ï¼Œè‡ªå®šä¹‰çš„å›½é™…åŒ–ç»„ä»¶ @Bean public LocaleResolver localeResolver()&#123; return new MylocalResolver(); &#125; è‡ªå®šä¹‰çš„ç»„ä»¶ 1234567891011121314151617181920212223242526272829303132333435package com.xiaoliu.config;import org.springframework.util.StringUtils;import org.springframework.web.servlet.LocaleResolver;import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpServletResponse;import java.util.Locale;/** * @author: 61åˆ† * @date: 2022/4/16 15:22 * @description: */public class MylocalResolver implements LocaleResolver &#123; @Override public Locale resolveLocale(HttpServletRequest httpServletRequest) &#123;// è·å–è¯­è¨€å‚æ•° String language = httpServletRequest.getParameter(&quot;l&quot;); Locale locale = Locale.getDefault(); //å¦‚æœæ²¡æœ‰å°±ä½¿ç”¨é»˜è®¤çš„// å¦‚æœè¯·æ±‚ä¸­æºå¸¦äº†åœ°åŒºåŒ–çš„å‚æ•° if (!StringUtils.isEmpty(language))&#123;// åˆ†å‰² zh_CN String[] split = language.split(&quot;_&quot;);// å›½å®¶ åœ°åŒº locale = new Locale(split[0], split[1]); &#125; return locale; &#125; @Override public void setLocale(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Locale locale) &#123; &#125;&#125; ä¿®æ”¹è¿”å›çš„urlåœ¨è‡ªå®šä¹‰çš„è§†å›¾è·³è½¬MyMvcConfigä¸­ è§†å›¾è·³è½¬åˆ°dashboardçš„æ—¶å€™ åå­—ä¸ºï¼šmain.html 1registry.addViewController(&quot;/main.html&quot;).setViewName(&quot;dashboard&quot;); åœ¨controllerè¿”å›é‡å®šå‘çš„é¡µé¢ä¸º&#x2F;main.html 12if (!StringUtils.isEmpty(username) &amp;&amp; &quot;123&quot;.equals(password)) &#123; return &quot;redirect:/main.html&quot;; æ‹¦æˆªå™¨åœ¨configä¸­ ç¼–å†™LoginHandlerInterceptoræ‹¦æˆªå™¨ 123456789101112131415161718192021222324252627package com.xiaoliu.config;import org.springframework.web.servlet.HandlerInterceptor;import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpServletResponse;/** * @author: 61åˆ† * @date: 2022/4/16 16:14 * @description: */public class LoginHandlerInterceptor implements HandlerInterceptor &#123; @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123;// ç™»å½•ä¹‹ååº”è¯¥æœ‰ç”¨æˆ·çš„session Object loginUser = request.getSession().getAttribute(&quot;loginUser&quot;); if (loginUser==null)&#123; request.setAttribute(&quot;msg&quot;,&quot;æ²¡æœ‰æƒé™ï¼Œè¯·å…ˆç™»å½•ï¼&quot;); request.getRequestDispatcher(&quot;/index.html&quot;).forward(request,response); return false; &#125;else return true; &#125;&#125; åœ¨mvcç±»ä¸­é‡å†™æ‹¦æˆªå™¨ 123456@Overridepublic void addInterceptors(InterceptorRegistry registry) &#123; registry.addInterceptor(new LoginHandlerInterceptor()) .addPathPatterns(&quot;/**&quot;)//æ‹¦æˆªçš„é¡µé¢ .excludePathPatterns(&quot;/&quot;,&quot;/index.html&quot;,&quot;/user/login&quot;,&quot;/css/**&quot;,&quot;/js/**&quot;,&quot;/img/**&quot;);//ä¸èƒ½è¢«æ‹¦æˆªçš„é¡µé¢&#125;","categories":[],"tags":[]},{"title":"é€šè¿‡javaè‡ªå»ºæ•°æ®è¡¨","slug":"4-16/åœ¨javavä¸­å»ºç«‹æ•°æ®è¡¨","date":"2022-04-15T16:12:57.936Z","updated":"2022-04-15T16:16:08.051Z","comments":true,"path":"2022/04/16/4-16/åœ¨javavä¸­å»ºç«‹æ•°æ®è¡¨/","link":"","permalink":"https://dddwah11.github.io/2022/04/16/4-16/%E5%9C%A8javav%E4%B8%AD%E5%BB%BA%E7%AB%8B%E6%95%B0%E6%8D%AE%E8%A1%A8/","excerpt":"","text":"å»ºç«‹ä¸€ä¸ªå‘˜å·¥éƒ¨é—¨è¡¨ï¼špojo:Employee: 123456789101112131415161718192021222324252627282930313233package com.xiaoliu.pojo;import lombok.AllArgsConstructor;import lombok.Data;import lombok.NoArgsConstructor;import java.util.Date;/** * @author: 61åˆ† * @date: 2022/4/15 23:12 * @description: */@Data@NoArgsConstructorpublic class Employee &#123; private Integer id; private String lastName; private String email; private Integer gender; private Department department; private Date birth; public Employee(Integer id, String lastName, String email, Integer gender, Department department) &#123; this.id = id; this.lastName = lastName; this.email = email; this.gender = gender; this.department = department; this.birth = new Date(); &#125;&#125; Department: 12345678910111213141516171819package com.xiaoliu.pojo;import lombok.AllArgsConstructor;import lombok.Data;import lombok.NoArgsConstructor;/** * @author: 61åˆ† * @date: 2022/4/15 22:17 * @description: */@Data@AllArgsConstructor@NoArgsConstructorpublic class Department &#123; private Integer id; private String department;&#125; Daoå±‚ï¼šEmployeeDaoï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859package com.xiaoliu.dao;import com.xiaoliu.pojo.Department;import com.xiaoliu.pojo.Employee;import org.springframework.beans.factory.annotation.Autowired;import java.util.Collection;import java.util.HashMap;import java.util.Map;/** * @author: 61åˆ† * @date: 2022/4/15 23:44 * @description: */public class EmployeeDao &#123; private static Map&lt;Integer, Employee&gt; employees; @Autowired private DepartmentDao departmentDao; static &#123; employees = new HashMap&lt;Integer, Employee&gt;();//åˆ›å»ºä¸€ä¸ªéƒ¨é—¨è¡¨ employees.put(1001, new Employee(1001,&quot;AA&quot;,&quot;A13151@ew.com&quot;,0,new Department(101,&quot;æ•™å­¦éƒ¨&quot;))); employees.put(1002, new Employee(1002,&quot;BB&quot;,&quot;B13151@ew.com&quot;,1,new Department(102,&quot;åå‹¤éƒ¨&quot;))); employees.put(1003, new Employee(1003,&quot;CC&quot;,&quot;C13151@ew.com&quot;,0,new Department(103,&quot;ä¿å«éƒ¨&quot;))); employees.put(1004, new Employee(1004,&quot;DD&quot;,&quot;D13151@ew.com&quot;,1,new Department(104,&quot;ç§‘ç ”éƒ¨&quot;))); employees.put(1005, new Employee(1005,&quot;EE&quot;,&quot;E13151@ew.com&quot;,0,new Department(105,&quot;å­¦ç”Ÿéƒ¨&quot;))); &#125;// ä¸»é”®è‡ªå¢ID private static Integer initId = 1006;// å¢åŠ ä¸€ä¸ªå‘˜å·¥ public void save(Employee employee)&#123; if (employee.getId()==0)&#123; employee.setId(initId++); &#125; employee.setDepartment(departmentDao.getDepartment(employee.getDepartment().getId())); employees.put(employee.getId(),employee); &#125;// æŸ¥è¯¢å…¨éƒ¨å‘˜å·¥ public Collection&lt;Employee&gt; getAll()&#123; return employees.values(); &#125;// é€šè¿‡idæŸ¥è¯¢å‘˜å·¥ public Employee getById(Integer id)&#123; return employees.get(id); &#125;// åˆ é™¤å‘˜å·¥é€šè¿‡id public Employee removeById(Integer id)&#123; return employees.remove(id); &#125;&#125; DepartmentDaoï¼š 1234567891011121314151617181920212223242526272829303132333435package com.xiaoliu.dao;import com.xiaoliu.pojo.Department;import java.util.Collection;import java.util.HashMap;import java.util.Map;/** * @author: 61åˆ† * @date: 2022/4/15 23:18 * @description: */public class DepartmentDao &#123;// æ¨¡æ‹Ÿæ•°æ®åº“ä¸­çš„æ•°æ® private static Map&lt;Integer, Department&gt; departments = null; static &#123; departments = new HashMap&lt;Integer, Department&gt;();//åˆ›å»ºä¸€ä¸ªéƒ¨é—¨æ•°æ®è¡¨ departments.put(101,new Department(101,&quot;æ•™å­¦éƒ¨&quot;)); departments.put(102,new Department(102,&quot;åå‹¤éƒ¨&quot;)); departments.put(103,new Department(103,&quot;ä¿å«éƒ¨&quot;)); departments.put(104,new Department(104,&quot;ç§‘ç ”éƒ¨&quot;)); departments.put(105,new Department(105,&quot;å­¦ç”Ÿéƒ¨&quot;)); &#125;// è·å¾—éƒ¨é—¨ä¿¡æ¯ public Collection&lt;Department&gt; getDepartments()&#123; return departments.values(); &#125;// é€šè¿‡idå¾—åˆ°éƒ¨é—¨ public Department getDepartment(Integer id)&#123; return departments.get(id); &#125;&#125;","categories":[],"tags":[]},{"title":"MVCé…ç½®åŸç†åŠthymeleaf","slug":"4-15/thymeleafè¯­æ³•","date":"2022-04-15T12:38:44.705Z","updated":"2022-04-15T15:59:59.772Z","comments":true,"path":"2022/04/15/4-15/thymeleafè¯­æ³•/","link":"","permalink":"https://dddwah11.github.io/2022/04/15/4-15/thymeleaf%E8%AF%AD%E6%B3%95/","excerpt":"","text":"MVCé…ç½®åŸç†å¦‚æœæƒ³è¦divä¸€äº›å®šåˆ¶åŒ–çš„åŠŸèƒ½ï¼Œåªè¦å†™ä¸€ä¸ªç»„ä»¶ï¼Œç„¶åå°†å®ƒäº¤ç»™springbootï¼Œspringbootå°±ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬è½¬é… 12345678910111213141516171819202122232425262728293031323334package com.xiaoliu.config;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.web.servlet.View;import org.springframework.web.servlet.ViewResolver;import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;import java.util.Locale;/** * @author: 61åˆ† * @date: 2022/4/15 21:17 * @description: *///æ‰©å±• springmvc dispatcherservlet@Configurationpublic class MyMvcConfig implements WebMvcConfigurer &#123; @Bean public ViewResolver myViewResolver()&#123; return new myViewResolver(); &#125;// è‡ªå®šä¹‰ä¸€ä¸ªè§†å›¾è§£æå™¨ public static class myViewResolver implements ViewResolver &#123; @Override public View resolveViewName(String s, Locale locale) throws Exception &#123; return null; &#125; &#125;&#125; åŸºæœ¬çš„è§†å›¾è·³è½¬ 12345678public class MyMvcConfig implements WebMvcConfigurer &#123; //è§†å›¾è·³è½¬ @Override public void addViewControllers(ViewControllerRegistry registry) &#123; registry.addViewController(&quot;/xiaoliu&quot;).setViewName(&quot;index&quot;); &#125;&#125; è¿™æ ·çš„è¯ï¼Œè§†å›¾è·³è½¬çš„æ–‡ä»¶ï¼Œåªèƒ½åœ¨templatesï¼Œ è€Œä¸”thymeleafä¹Ÿä¼šå¤±æ•ˆ å¦‚æœè¦æ‰©å±•çš„è¯ï¼Œå®˜æ–¹å»ºè®®è¿™æ ·å»åš springbootä¸­ï¼ŒxxxConfiguraion å¯ä»¥å®ç°å¾ˆå¤šæ‰©å±• thymeleafthymeleafå¸¸ç”¨å‘½åç©ºé—´ï¼š xmlns:th&#x3D;â€http://www.thymeleaf.org&quot;xmlns:sec&#x3D;â€http://www.thymeleaf.org/extras/spring-security&quot;xmlns:shiro&#x3D;â€http://www.pollix.at/thymeleaf/shiro&quot;","categories":[],"tags":[]},{"title":"SpringBoot Webå¼€å‘","slug":"4-14/SpringBoot-Webå¼€å‘","date":"2022-04-14T12:31:54.329Z","updated":"2022-04-14T14:35:21.083Z","comments":true,"path":"2022/04/14/4-14/SpringBoot-Webå¼€å‘/","link":"","permalink":"https://dddwah11.github.io/2022/04/14/4-14/SpringBoot-Web%E5%BC%80%E5%8F%91/","excerpt":"","text":"jar:webpp! å¯¼å…¥é™æ€èµ„æº é¦–é¡µ jspï¼Œæ¨¡æ¿å¼•æ“Thymeleaf è£…é…æ‰©å±•SpringMVC å¢åˆ æ”¹æŸ¥ æ‹¦æˆªå™¨ å›½é™…åŒ– åœ¨springbootï¼Œæˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹æ–¹å¼å¤„ç†é™æ€èµ„æº webjars localhost:8080/webjars/ publicï¼Œstaticï¼Œ&#x2F;**,resource localhost:8080/ ä¼˜å…ˆçº§ resource&gt;static(é»˜è®¤)&gt;public é¦–é¡µå¦‚ä½•å®šåˆ¶index.html æœ€å¥½è®¾ç½®åœ¨staticé‡Œ 12åœ¨templatesç›®å½•ä¸‹çš„é¡µé¢ï¼Œåªé€šè¿‡controlleræ¥è·³è½¬éœ€è¦æ¨¡æ¿å¼•æ“çš„æ”¯æŒ","categories":[],"tags":[]},{"title":"è‡ªåŠ¨è£…é…åŸç†","slug":"4-14/springbootä¸»å¯åŠ¨ç±»è¿è¡Œ","date":"2022-04-14T08:13:07.450Z","updated":"2022-04-15T11:45:51.337Z","comments":true,"path":"2022/04/14/4-14/springbootä¸»å¯åŠ¨ç±»è¿è¡Œ/","link":"","permalink":"https://dddwah11.github.io/2022/04/14/4-14/springboot%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB%E8%BF%90%E8%A1%8C/","excerpt":"","text":"ä¸»å¯åŠ¨ç±»è¿è¡Œ åˆå§‹åŒ– åˆ¤æ–­æ˜¯ä¸æ˜¯ä¸ºä¸€ä¸ªwebåº”ç”¨ æ‰“å¼€ç›‘å¬å™¨å…¨å±€å¤„ç†ä¸Šä¸‹æ–‡ é€šè¿‡ä¸»ç±»åŠ è½½ï¼Œé€šè¿‡ç±»åŠ è½½è·å–springã€‚factories è£…é…ç¯å¢ƒå‚æ•° yaml å¯ä»¥ç»™å®ä½“ç±»èµ‹å€¼ &#96;&#96;&#96;yaml k &#x3D; væ³¨å…¥åˆ°æˆ‘ä»¬é…ç½®ç±»ä¸­æ™®é€šçš„key-valuename : xiaoliu dog: name: xiaogou age: 3 å¯¹è±¡student: name: xiaoliu age: 3 è¡Œå†…å†™æ³•student1: {name: xialiu, age: 3} ##æ•°ç»„pets: dog vat cat pets1: [dog,we,zw] ##å¯¹è±¡ person: name: xiaoliu age: 3 happy: flase birth: 2022&#x2F;10&#x2F;2 map: {k2: v1,k1: v2} list: - code - music - book 12345```java@ConfigurationProperties(prefix = &quot;person&quot;) å¯ä»¥é€šè¿‡è¿™ä¸ªæ³¨è§£å°†é…ç½®æ–‡ä»¶ä¸­çš„å€¼æ˜ å°„åˆ°ç»„ä»¶ @component ä¸Š ä¹Ÿå¯ä»¥é€šè¿‡ @PropertySource(&quot;classpath:xiaoliu.properties&quot;) æ³¨è§£æ˜ å°„åˆ°ç»„ä»¶ä¸Š 12345//åŠ è½½æŒ‡å®šçš„é…ç½®æ–‡ä»¶@PropertySource(&quot;classpath:xiaoliu.properties&quot;)public class Person &#123;// SPELè¡¨è¾¾å¼å–å€¼ @Value(&quot;$&#123;name&#125;&quot;) æ¾æ•£ç»‘å®šåœ¨ymlä¸­ å†™çš„ä¸ºlast-name ä¸lastNameæ˜¯ä¸€æ ·çš„ jsr303æ ¡éªŒçº¦æŸæ³¨è§£åç§° çº¦æŸæ³¨è§£è¯´æ˜@Null éªŒè¯å¯¹è±¡æ˜¯å¦ä¸ºç©º@NotNull éªŒè¯å¯¹è±¡æ˜¯å¦ä¸ºéç©º@AssertTrue éªŒè¯ Boolean å¯¹è±¡æ˜¯å¦ä¸º true@AssertFalse éªŒè¯ Boolean å¯¹è±¡æ˜¯å¦ä¸º false@Min éªŒè¯ Number å’Œ String å¯¹è±¡æ˜¯å¦å¤§ç­‰äºæŒ‡å®šçš„å€¼@Max éªŒè¯ Number å’Œ String å¯¹è±¡æ˜¯å¦å°ç­‰äºæŒ‡å®šçš„å€¼@DecimalMin éªŒè¯ Number å’Œ String å¯¹è±¡æ˜¯å¦å¤§ç­‰äºæŒ‡å®šçš„å€¼ï¼Œå°æ•°å­˜åœ¨ç²¾åº¦@DecimalMax éªŒè¯ Number å’Œ String å¯¹è±¡æ˜¯å¦å°ç­‰äºæŒ‡å®šçš„å€¼ï¼Œå°æ•°å­˜åœ¨ç²¾åº¦@Size éªŒè¯å¯¹è±¡ï¼ˆArray,Collection,Map,Stringï¼‰é•¿åº¦æ˜¯å¦åœ¨ç»™å®šçš„èŒƒå›´ä¹‹å†…@Digits éªŒè¯ Number å’Œ String çš„æ„æˆæ˜¯å¦åˆæ³•@Past éªŒè¯ Date å’Œ Calendar å¯¹è±¡æ˜¯å¦åœ¨å½“å‰æ—¶é—´ä¹‹å‰@Future éªŒè¯ Date å’Œ Calendar å¯¹è±¡æ˜¯å¦åœ¨å½“å‰æ—¶é—´ä¹‹å@Pattern éªŒè¯ String å¯¹è±¡æ˜¯å¦ç¬¦åˆæ­£åˆ™è¡¨è¾¾å¼çš„è§„åˆ™ è‡ªåŠ¨é…ç½®åŸç†xxxAutoConfiguration: é»˜è®¤å€¼ xxxproperties å’Œé…ç½®æ–‡ä»¶ç»‘å®š æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„é…ç½® æ¯ä¸€ä¸ª xxxAutoConfiguration éƒ½æ˜¯å®¹å™¨ä¸­çš„ä¸€ä¸ªç»„ä»¶ï¼Œæœ€åéƒ½åŠ å…¥åˆ°å®¹å™¨ä¸­è®©ä»–ä»¬è‡ªåŠ¨é…ç½® è¿™å°±æ˜¯è‡ªåŠ¨è£…é…çš„åŸç†!ç²¾é«“:1)ã€SpringBootå¯åŠ¨ä¼šåŠ è½½å¤§é‡çš„è‡ªåŠ¨é…ç½®ç±»2)ã€æˆ‘ä»¬çœ‹æˆ‘ä»¬éœ€è¦çš„åŠŸèƒ½æœ‰æ²¡æœ‰åœ¨SpringBooté»˜è®¤å†™å¥½çš„è‡ªåŠ¨é…ç½®ç±»å½“ä¸­;3)ã€æˆ‘ä»¬å†æ¥çœ‹è¿™ä¸ªè‡ªåŠ¨é…ç½®ç±»ä¸­åˆ°åº•é…ç½®äº†å“ªäº›ç»„ä»¶; (åªè¦æˆ‘ä»¬è¦ç”¨çš„ç»„ä»¶å­˜åœ¨åœ¨å…¶ä¸­ï¼Œæˆ‘ä»¬å°±ä¸éœ€è¦å†æ‰‹åŠ¨é…ç½®äº†)4)ã€ç»™å®¹å™¨ä¸­è‡ªåŠ¨é…ç½®ç±»æ·»åŠ ç»„ä»¶çš„æ—¶å€™ï¼Œä¼šä»propertiesç±»ä¸­è·å–æŸäº›å±æ€§ã€‚æˆ‘ä»¬åªéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šè¿™äº›å±æ€§çš„å€¼å³å¯;xxxxAutoConfigurartion:è‡ªåŠ¨é…ç½®ç±»;ç»™å®¹å™¨ä¸­æ·»åŠ ç»„ä»¶xxxxProperties:å°è£…é…ç½®æ–‡ä»¶ä¸­ç›¸å…³å±æ€§æ–‡ä»¶","categories":[],"tags":[]},{"title":"æ¯æ—¥ç®—æ³•-quicksort","slug":"2022-4-13/æ¯æ—¥ç®—æ³•-quicksort","date":"2022-04-13T15:47:43.908Z","updated":"2022-04-14T02:25:40.470Z","comments":true,"path":"2022/04/13/2022-4-13/æ¯æ—¥ç®—æ³•-quicksort/","link":"","permalink":"https://dddwah11.github.io/2022/04/13/2022-4-13/%E6%AF%8F%E6%97%A5%E7%AE%97%E6%B3%95-quicksort/","excerpt":"","text":"æœ‰æ²¡æœ‰æ—¢ä¸æµªè´¹ç©ºé—´åˆå¯ä»¥å¿«ä¸€ç‚¹çš„æ’åºç®—æ³•å‘¢ï¼Ÿé‚£å°±æ˜¯å¿«é€Ÿæ’å•¦ï¼ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152/** * @author: 61åˆ† * @date: 2022/4/14 0:05 * @description: */public class quickSort &#123; public static void quickSort(int [] arr,int low,int high)&#123; int i,j,tmp,t; if (low&gt;high)&#123; return; &#125; i = low; j = high; tmp = arr[low]; while (i&lt;j)&#123; // å…ˆçœ‹å³è¾¹,ä»æœ€å³è¾¹é€’å‡ while (tmp&lt;=arr[j]&amp;&amp;i&lt;j)&#123; j--; &#125;// å†çœ‹å·¦è¾¹ï¼Œé€’åŠ  while (tmp&gt;=arr[i]&amp;&amp;i&lt;j)&#123; i++; &#125;// æ»¡è¶³æ¡ä»¶çš„è¯ï¼Œäº¤æ¢ä»–ä»¬çš„å€¼ if (i&lt;j)&#123; t = arr[j]; arr[j] = arr[i]; arr[i] = t; &#125; &#125; arr[low] = arr[i]; arr[i] = tmp;// ä¹‹åé€’å½’è°ƒç”¨ å¤„ç†å·¦è¾¹çš„ quickSort(arr,low,j-1);// å¤„ç†å³è¾¹çš„ quickSort(arr,j+1,high); &#125; public static void main(String[] args) &#123; int [] num= &#123;10,54,21,42,78,65,48&#125;; quickSort(num,0,num.length-1); for (int i = 0; i &lt; num.length; i++) &#123; System.out.println(num[i]); &#125; &#125;&#125;","categories":[],"tags":[]},{"title":"spirngbootåˆå­¦","slug":"2022-4-13/springboot","date":"2022-04-13T14:47:41.164Z","updated":"2022-04-14T02:25:29.426Z","comments":true,"path":"2022/04/13/2022-4-13/springboot/","link":"","permalink":"https://dddwah11.github.io/2022/04/13/2022-4-13/springboot/","excerpt":"","text":"SpringBootåŸç†1ã€è‡ªåŠ¨è£…é…åŸç†pom.xml spring-boot-dependencies:æ ¸å¿ƒä¾èµ–åœ¨çˆ¶å·¥ç¨‹ä¸­ æˆ‘ä»¬åœ¨å¼•å…¥ä¸€äº›springä¾èµ–çš„æ—¶å€™ï¼Œä¸éœ€è¦æŒ‡å®šç‰ˆæœ¬ï¼Œå› ä¸ºæœ‰è¿™äº›ç‰ˆæœ¬ä»“åº“ å¯åŠ¨å™¨ &#96;&#96;&#96;xml org.springframework.boot spring-boot-starter-web 123456789101112131415161718* æ˜¯springbootçš„å¯åŠ¨åœºæ™¯ * æ¯”å¦‚springbootwb å°±å¸®æˆ‘ä»¬è‡ªåŠ¨å¯¼å…¥webç¯å¢ƒæ‰€éœ€çš„æ‰€æœ‰ä¾èµ–ï¼* å°†æ‰€æœ‰çš„åŠŸèƒ½åœºæ™¯å˜æˆä¸€ä¸ªä¸ªå¯åŠ¨å™¨**springbootä¸»ç¨‹åº** ```java@SpringBootApplicationpublic class HelloWorldApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(HelloWorldApplication.class, args); &#125;&#125; æ³¨è§£ 12@SpringBootConfiguration@SpringBootConfiguration è‡ªåŠ¨é…ç½®çš„æ ¸å¿ƒæ–‡ä»¶ WEB-INF/spring.factories æ‰€æœ‰çš„èµ„æºåŠ è½½åˆ°é…ç½®ç±»ä¸­ 1Properties properties = PropertiesLoaderUtils.loadProperties(resource) æ ¸å¿ƒæ³¨è§£ 1@ConditionalOnXXX åœ¨æ»¡è¶³æ‰€æœ‰æ¡ä»¶æ‰ä¼šç”Ÿæ•ˆ springbootè‡ªåŠ¨é…ç½®éƒ½åœ¨å¯åŠ¨çš„æ—¶å€™æ‰«æå¹¶åŠ è½½ spirng.properties æ‰€æœ‰çš„è‡ªåŠ¨é…ç½®ç±»éƒ½åœ¨è¿™ä¸ªé…ç½®æ–‡ä»¶ä¸­ï¼Œé€šè¿‡åˆ¤æ–­æ ¸å¿ƒæ³¨è§£æ˜¯å¦æ»¡è¶³æ¡ä»¶æ‰èƒ½ç”Ÿæ•ˆ springbootåœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œé€šè¿‡ç±»è·¯å¾„ä¸‹çš„ WEB-INF/spirng.properties è·å¾—æŒ‡å®šçš„å€¼ å°†è¿™äº›è‡ªåŠ¨é…ç½®çš„ç±»å¯¼å…¥å®¹å™¨ï¼Œè‡ªåŠ¨é…ç½®å°±ä¼šç”Ÿæ•ˆ å³å®Œæˆè‡ªåŠ¨é…ç½® æ•´åˆjavaEE è§£å†³æ–¹æ¡ˆå’Œè‡ªåŠ¨é…ç½®çš„ä¸œè¥¿éƒ½åœ¨ spring-boot-test-autoconfigure-2.3.7.RELEASE.jar ä¸­","categories":[],"tags":[]},{"title":"Mybatis-03","slug":"2022-4-13/Mybatis-03","date":"2022-04-13T02:48:32.989Z","updated":"2022-04-14T02:28:18.256Z","comments":true,"path":"2022/04/13/2022-4-13/Mybatis-03/","link":"","permalink":"https://dddwah11.github.io/2022/04/13/2022-4-13/Mybatis-03/","excerpt":"","text":"Mybatis-03è®¾ç½®ï¼ˆsettingsï¼‰è¿™æ˜¯ MyBatis ä¸­æä¸ºé‡è¦çš„è°ƒæ•´è®¾ç½®ï¼Œå®ƒä»¬ä¼šæ”¹å˜ MyBatis çš„è¿è¡Œæ—¶è¡Œä¸ºã€‚ ä¸‹è¡¨æè¿°äº†è®¾ç½®ä¸­å„é¡¹è®¾ç½®çš„å«ä¹‰ã€é»˜è®¤å€¼ç­‰ã€‚ è®¾ç½®å æè¿° æœ‰æ•ˆå€¼ é»˜è®¤å€¼ cacheEnabled å…¨å±€æ€§åœ°å¼€å¯æˆ–å…³é—­æ‰€æœ‰æ˜ å°„å™¨é…ç½®æ–‡ä»¶ä¸­å·²é…ç½®çš„ä»»ä½•ç¼“å­˜ã€‚ true | false true lazyLoadingEnabled å»¶è¿ŸåŠ è½½çš„å…¨å±€å¼€å…³ã€‚å½“å¼€å¯æ—¶ï¼Œæ‰€æœ‰å…³è”å¯¹è±¡éƒ½ä¼šå»¶è¿ŸåŠ è½½ã€‚ ç‰¹å®šå…³è”å…³ç³»ä¸­å¯é€šè¿‡è®¾ç½® fetchType å±æ€§æ¥è¦†ç›–è¯¥é¡¹çš„å¼€å…³çŠ¶æ€ã€‚ true | false false aggressiveLazyLoading å¼€å¯æ—¶ï¼Œä»»ä¸€æ–¹æ³•çš„è°ƒç”¨éƒ½ä¼šåŠ è½½è¯¥å¯¹è±¡çš„æ‰€æœ‰å»¶è¿ŸåŠ è½½å±æ€§ã€‚ å¦åˆ™ï¼Œæ¯ä¸ªå»¶è¿ŸåŠ è½½å±æ€§ä¼šæŒ‰éœ€åŠ è½½ï¼ˆå‚è€ƒ lazyLoadTriggerMethods)ã€‚ true | false false ï¼ˆåœ¨ 3.4.1 åŠä¹‹å‰çš„ç‰ˆæœ¬ä¸­é»˜è®¤ä¸º trueï¼‰ multipleResultSetsEnabled æ˜¯å¦å…è®¸å•ä¸ªè¯­å¥è¿”å›å¤šç»“æœé›†ï¼ˆéœ€è¦æ•°æ®åº“é©±åŠ¨æ”¯æŒï¼‰ã€‚ true | false true useColumnLabel ä½¿ç”¨åˆ—æ ‡ç­¾ä»£æ›¿åˆ—åã€‚å®é™…è¡¨ç°ä¾èµ–äºæ•°æ®åº“é©±åŠ¨ï¼Œå…·ä½“å¯å‚è€ƒæ•°æ®åº“é©±åŠ¨çš„ç›¸å…³æ–‡æ¡£ï¼Œæˆ–é€šè¿‡å¯¹æ¯”æµ‹è¯•æ¥è§‚å¯Ÿã€‚ true | false true useGeneratedKeys å…è®¸ JDBC æ”¯æŒè‡ªåŠ¨ç”Ÿæˆä¸»é”®ï¼Œéœ€è¦æ•°æ®åº“é©±åŠ¨æ”¯æŒã€‚å¦‚æœè®¾ç½®ä¸º trueï¼Œå°†å¼ºåˆ¶ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆä¸»é”®ã€‚å°½ç®¡ä¸€äº›æ•°æ®åº“é©±åŠ¨ä¸æ”¯æŒæ­¤ç‰¹æ€§ï¼Œä½†ä»å¯æ­£å¸¸å·¥ä½œï¼ˆå¦‚ Derbyï¼‰ã€‚ true | false False autoMappingBehavior æŒ‡å®š MyBatis åº”å¦‚ä½•è‡ªåŠ¨æ˜ å°„åˆ—åˆ°å­—æ®µæˆ–å±æ€§ã€‚ NONE è¡¨ç¤ºå…³é—­è‡ªåŠ¨æ˜ å°„ï¼›PARTIAL åªä¼šè‡ªåŠ¨æ˜ å°„æ²¡æœ‰å®šä¹‰åµŒå¥—ç»“æœæ˜ å°„çš„å­—æ®µã€‚ FULL ä¼šè‡ªåŠ¨æ˜ å°„ä»»ä½•å¤æ‚çš„ç»“æœé›†ï¼ˆæ— è®ºæ˜¯å¦åµŒå¥—ï¼‰ã€‚ NONE, PARTIAL, FULL PARTIAL autoMappingUnknownColumnBehavior æŒ‡å®šå‘ç°è‡ªåŠ¨æ˜ å°„ç›®æ ‡æœªçŸ¥åˆ—ï¼ˆæˆ–æœªçŸ¥å±æ€§ç±»å‹ï¼‰çš„è¡Œä¸ºã€‚NONE: ä¸åšä»»ä½•ååº”WARNING: è¾“å‡ºè­¦å‘Šæ—¥å¿—ï¼ˆ&#39;org.apache.ibatis.session.AutoMappingUnknownColumnBehavior&#39; çš„æ—¥å¿—ç­‰çº§å¿…é¡»è®¾ç½®ä¸º WARNï¼‰FAILING: æ˜ å°„å¤±è´¥ (æŠ›å‡º SqlSessionException) NONE, WARNING, FAILING NONE defaultExecutorType é…ç½®é»˜è®¤çš„æ‰§è¡Œå™¨ã€‚SIMPLE å°±æ˜¯æ™®é€šçš„æ‰§è¡Œå™¨ï¼›REUSE æ‰§è¡Œå™¨ä¼šé‡ç”¨é¢„å¤„ç†è¯­å¥ï¼ˆPreparedStatementï¼‰ï¼› BATCH æ‰§è¡Œå™¨ä¸ä»…é‡ç”¨è¯­å¥è¿˜ä¼šæ‰§è¡Œæ‰¹é‡æ›´æ–°ã€‚ SIMPLE REUSE BATCH SIMPLE defaultStatementTimeout è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå®ƒå†³å®šæ•°æ®åº“é©±åŠ¨ç­‰å¾…æ•°æ®åº“å“åº”çš„ç§’æ•°ã€‚ ä»»æ„æ­£æ•´æ•° æœªè®¾ç½® (null) defaultFetchSize ä¸ºé©±åŠ¨çš„ç»“æœé›†è·å–æ•°é‡ï¼ˆfetchSizeï¼‰è®¾ç½®ä¸€ä¸ªå»ºè®®å€¼ã€‚æ­¤å‚æ•°åªå¯ä»¥åœ¨æŸ¥è¯¢è®¾ç½®ä¸­è¢«è¦†ç›–ã€‚ ä»»æ„æ­£æ•´æ•° æœªè®¾ç½® (null) defaultResultSetType æŒ‡å®šè¯­å¥é»˜è®¤çš„æ»šåŠ¨ç­–ç•¥ã€‚ï¼ˆæ–°å¢äº 3.5.2ï¼‰ FORWARD_ONLY | SCROLL_SENSITIVE | SCROLL_INSENSITIVE | DEFAULTï¼ˆç­‰åŒäºæœªè®¾ç½®ï¼‰ æœªè®¾ç½® (null) safeRowBoundsEnabled æ˜¯å¦å…è®¸åœ¨åµŒå¥—è¯­å¥ä¸­ä½¿ç”¨åˆ†é¡µï¼ˆRowBoundsï¼‰ã€‚å¦‚æœå…è®¸ä½¿ç”¨åˆ™è®¾ç½®ä¸º falseã€‚ true | false False safeResultHandlerEnabled æ˜¯å¦å…è®¸åœ¨åµŒå¥—è¯­å¥ä¸­ä½¿ç”¨ç»“æœå¤„ç†å™¨ï¼ˆResultHandlerï¼‰ã€‚å¦‚æœå…è®¸ä½¿ç”¨åˆ™è®¾ç½®ä¸º falseã€‚ true | false True mapUnderscoreToCamelCase æ˜¯å¦å¼€å¯é©¼å³°å‘½åè‡ªåŠ¨æ˜ å°„ï¼Œå³ä»ç»å…¸æ•°æ®åº“åˆ—å A_COLUMN æ˜ å°„åˆ°ç»å…¸ Java å±æ€§å aColumnã€‚ true | false False localCacheScope MyBatis åˆ©ç”¨æœ¬åœ°ç¼“å­˜æœºåˆ¶ï¼ˆLocal Cacheï¼‰é˜²æ­¢å¾ªç¯å¼•ç”¨å’ŒåŠ é€Ÿé‡å¤çš„åµŒå¥—æŸ¥è¯¢ã€‚ é»˜è®¤å€¼ä¸º SESSIONï¼Œä¼šç¼“å­˜ä¸€ä¸ªä¼šè¯ä¸­æ‰§è¡Œçš„æ‰€æœ‰æŸ¥è¯¢ã€‚ è‹¥è®¾ç½®å€¼ä¸º STATEMENTï¼Œæœ¬åœ°ç¼“å­˜å°†ä»…ç”¨äºæ‰§è¡Œè¯­å¥ï¼Œå¯¹ç›¸åŒ SqlSession çš„ä¸åŒæŸ¥è¯¢å°†ä¸ä¼šè¿›è¡Œç¼“å­˜ã€‚ SESSION | STATEMENT SESSION jdbcTypeForNull å½“æ²¡æœ‰ä¸ºå‚æ•°æŒ‡å®šç‰¹å®šçš„ JDBC ç±»å‹æ—¶ï¼Œç©ºå€¼çš„é»˜è®¤ JDBC ç±»å‹ã€‚ æŸäº›æ•°æ®åº“é©±åŠ¨éœ€è¦æŒ‡å®šåˆ—çš„ JDBC ç±»å‹ï¼Œå¤šæ•°æƒ…å†µç›´æ¥ç”¨ä¸€èˆ¬ç±»å‹å³å¯ï¼Œæ¯”å¦‚ NULLã€VARCHAR æˆ– OTHERã€‚ JdbcType å¸¸é‡ï¼Œå¸¸ç”¨å€¼ï¼šNULLã€VARCHAR æˆ– OTHERã€‚ OTHER lazyLoadTriggerMethods æŒ‡å®šå¯¹è±¡çš„å“ªäº›æ–¹æ³•è§¦å‘ä¸€æ¬¡å»¶è¿ŸåŠ è½½ã€‚ ç”¨é€—å·åˆ†éš”çš„æ–¹æ³•åˆ—è¡¨ã€‚ equals,clone,hashCode,toString defaultScriptingLanguage æŒ‡å®šåŠ¨æ€ SQL ç”Ÿæˆä½¿ç”¨çš„é»˜è®¤è„šæœ¬è¯­è¨€ã€‚ ä¸€ä¸ªç±»å‹åˆ«åæˆ–å…¨é™å®šç±»åã€‚ org.apache.ibatis.scripting.xmltags.XMLLanguageDriver defaultEnumTypeHandler æŒ‡å®š Enum ä½¿ç”¨çš„é»˜è®¤ TypeHandler ã€‚ï¼ˆæ–°å¢äº 3.4.5ï¼‰ ä¸€ä¸ªç±»å‹åˆ«åæˆ–å…¨é™å®šç±»åã€‚ org.apache.ibatis.type.EnumTypeHandler callSettersOnNulls æŒ‡å®šå½“ç»“æœé›†ä¸­å€¼ä¸º null çš„æ—¶å€™æ˜¯å¦è°ƒç”¨æ˜ å°„å¯¹è±¡çš„ setterï¼ˆmap å¯¹è±¡æ—¶ä¸º putï¼‰æ–¹æ³•ï¼Œè¿™åœ¨ä¾èµ–äº Map.keySet() æˆ– null å€¼è¿›è¡Œåˆå§‹åŒ–æ—¶æ¯”è¾ƒæœ‰ç”¨ã€‚æ³¨æ„åŸºæœ¬ç±»å‹ï¼ˆintã€boolean ç­‰ï¼‰æ˜¯ä¸èƒ½è®¾ç½®æˆ null çš„ã€‚ true | false false returnInstanceForEmptyRow å½“è¿”å›è¡Œçš„æ‰€æœ‰åˆ—éƒ½æ˜¯ç©ºæ—¶ï¼ŒMyBatisé»˜è®¤è¿”å› nullã€‚ å½“å¼€å¯è¿™ä¸ªè®¾ç½®æ—¶ï¼ŒMyBatisä¼šè¿”å›ä¸€ä¸ªç©ºå®ä¾‹ã€‚ è¯·æ³¨æ„ï¼Œå®ƒä¹Ÿé€‚ç”¨äºåµŒå¥—çš„ç»“æœé›†ï¼ˆå¦‚é›†åˆæˆ–å…³è”ï¼‰ã€‚ï¼ˆæ–°å¢äº 3.4.2ï¼‰ true | false false logPrefix æŒ‡å®š MyBatis å¢åŠ åˆ°æ—¥å¿—åç§°çš„å‰ç¼€ã€‚ ä»»ä½•å­—ç¬¦ä¸² æœªè®¾ç½® logImpl æŒ‡å®š MyBatis æ‰€ç”¨æ—¥å¿—çš„å…·ä½“å®ç°ï¼ŒæœªæŒ‡å®šæ—¶å°†è‡ªåŠ¨æŸ¥æ‰¾ã€‚ SLF4J | LOG4J | LOG4J2 | JDK_LOGGING | COMMONS_LOGGING | STDOUT_LOGGING | NO_LOGGING æœªè®¾ç½® proxyFactory æŒ‡å®š Mybatis åˆ›å»ºå¯å»¶è¿ŸåŠ è½½å¯¹è±¡æ‰€ç”¨åˆ°çš„ä»£ç†å·¥å…·ã€‚ CGLIB | JAVASSIST JAVASSIST ï¼ˆMyBatis 3.3 ä»¥ä¸Šï¼‰ vfsImpl æŒ‡å®š VFS çš„å®ç° è‡ªå®šä¹‰ VFS çš„å®ç°çš„ç±»å…¨é™å®šåï¼Œä»¥é€—å·åˆ†éš”ã€‚ æœªè®¾ç½® useActualParamName å…è®¸ä½¿ç”¨æ–¹æ³•ç­¾åä¸­çš„åç§°ä½œä¸ºè¯­å¥å‚æ•°åç§°ã€‚ ä¸ºäº†ä½¿ç”¨è¯¥ç‰¹æ€§ï¼Œä½ çš„é¡¹ç›®å¿…é¡»é‡‡ç”¨ Java 8 ç¼–è¯‘ï¼Œå¹¶ä¸”åŠ ä¸Š -parameters é€‰é¡¹ã€‚ï¼ˆæ–°å¢äº 3.4.1ï¼‰ true | false true configurationFactory æŒ‡å®šä¸€ä¸ªæä¾› Configuration å®ä¾‹çš„ç±»ã€‚ è¿™ä¸ªè¢«è¿”å›çš„ Configuration å®ä¾‹ç”¨æ¥åŠ è½½è¢«ååºåˆ—åŒ–å¯¹è±¡çš„å»¶è¿ŸåŠ è½½å±æ€§å€¼ã€‚ è¿™ä¸ªç±»å¿…é¡»åŒ…å«ä¸€ä¸ªç­¾åä¸ºstatic Configuration getConfiguration() çš„æ–¹æ³•ã€‚ï¼ˆæ–°å¢äº 3.2.3ï¼‰ ä¸€ä¸ªç±»å‹åˆ«åæˆ–å®Œå…¨é™å®šç±»åã€‚ æœªè®¾ç½® ä¸€ä¸ªé…ç½®å®Œæ•´çš„ settings å…ƒç´ çš„ç¤ºä¾‹å¦‚ä¸‹ï¼š 1234567891011121314151617&lt;settings&gt; &lt;setting name=&quot;cacheEnabled&quot; value=&quot;true&quot;/&gt; &lt;setting name=&quot;lazyLoadingEnabled&quot; value=&quot;true&quot;/&gt; &lt;setting name=&quot;multipleResultSetsEnabled&quot; value=&quot;true&quot;/&gt; &lt;setting name=&quot;useColumnLabel&quot; value=&quot;true&quot;/&gt; &lt;setting name=&quot;useGeneratedKeys&quot; value=&quot;false&quot;/&gt; &lt;setting name=&quot;autoMappingBehavior&quot; value=&quot;PARTIAL&quot;/&gt; &lt;setting name=&quot;autoMappingUnknownColumnBehavior&quot; value=&quot;WARNING&quot;/&gt; &lt;setting name=&quot;defaultExecutorType&quot; value=&quot;SIMPLE&quot;/&gt; &lt;setting name=&quot;defaultStatementTimeout&quot; value=&quot;25&quot;/&gt; &lt;setting name=&quot;defaultFetchSize&quot; value=&quot;100&quot;/&gt; &lt;setting name=&quot;safeRowBoundsEnabled&quot; value=&quot;false&quot;/&gt; &lt;setting name=&quot;mapUnderscoreToCamelCase&quot; value=&quot;false&quot;/&gt; &lt;setting name=&quot;localCacheScope&quot; value=&quot;SESSION&quot;/&gt; &lt;setting name=&quot;jdbcTypeForNull&quot; value=&quot;OTHER&quot;/&gt; &lt;setting name=&quot;lazyLoadTriggerMethods&quot; value=&quot;equals,clone,hashCode,toString&quot;/&gt;&lt;/settings&gt; 123&lt;settings&gt; &lt;setting name=&quot;logImpl&quot; value=&quot;STDOUT_LOGGING&quot;/&gt;&lt;/settings&gt; STDOUT_LOGGINGæ ‡å‡†æ—¥å¿—è¾“å‡ºï¼šLogging initialized using â€˜class org.apache.ibatis.logging.stdout.StdOutImplâ€™ adapter.PooledDataSource forcefully closed&#x2F;removed all connections.PooledDataSource forcefully closed&#x2F;removed all connections.PooledDataSource forcefully closed&#x2F;removed all connections.PooledDataSource forcefully closed&#x2F;removed all connections.Opening JDBC ConnectionCreated connection 775386112.Setting autocommit to false on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@2e377400]&#x3D;&#x3D;&gt; Preparing: select id,name,password from mybatis.user where id &#x3D; ?&#x3D;&#x3D;&gt; Parameters: 2(Integer)&lt;&#x3D;&#x3D; Columns: id, name, password&lt;&#x3D;&#x3D; Row: 2, å¤§åˆ˜å“¥, 1234&lt;&#x3D;&#x3D; Total: 1User{id&#x3D;2, name&#x3D;â€™å¤§åˆ˜å“¥â€™, pwd&#x3D;â€™1234â€™}Resetting autocommit to true on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@2e377400]Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@2e377400]Returned connection 775386112 to pool. Process finished with exit code 0 Log4j æ§åˆ¶æ—¥å¿—ä¿¡æ¯è¾“é€çš„ç›®çš„åœ°æ˜¯æ§åˆ¶å°ã€æ–‡ä»¶ã€GUIç»„ä»¶ï¼Œç”šè‡³æ˜¯å¥—æ¥å£æœåŠ¡å™¨ã€NTçš„äº‹ä»¶è®°å½•å™¨ã€UNIX Syslogå®ˆæŠ¤è¿›ç¨‹ç­‰ï¼› æˆ‘ä»¬ä¹Ÿå¯ä»¥æ§åˆ¶æ¯ä¸€æ¡æ—¥å¿—çš„è¾“å‡ºæ ¼å¼ï¼›é€šè¿‡å®šä¹‰æ¯ä¸€æ¡æ—¥å¿—ä¿¡æ¯çš„çº§åˆ«ï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ›´åŠ ç»†è‡´åœ°æ§åˆ¶æ—¥å¿—çš„ç”Ÿæˆè¿‡ç¨‹ã€‚ æœ€ä»¤äººæ„Ÿå…´è¶£çš„å°±æ˜¯ï¼Œè¿™äº›å¯ä»¥é€šè¿‡ä¸€ä¸ªé…ç½®æ–‡ä»¶æ¥çµæ´»åœ°è¿›è¡Œé…ç½®ï¼Œè€Œä¸éœ€è¦ä¿®æ”¹åº”ç”¨çš„ä»£ç ã€‚ â€‹ å¯¼å…¥ç›¸å…³ä¾èµ– log4j.properties 123456789101112131415161718192021222324#å°†ç­‰çº§ä¸ºDEBUGçš„æ—¥å¿—ä¿¡æ¯è¾“å‡ºåˆ°consoleå’Œfileè¿™ä¸¤ä¸ªç›®çš„åœ°ï¼Œconsoleå’Œfileçš„å®šä¹‰åœ¨ä¸‹é¢çš„ä»£ç log4j.rootLogger=DEBUG,console,file#æ§åˆ¶å°è¾“å‡ºçš„ç›¸å…³è®¾ç½®log4j.appender.console = org.apache.log4j.ConsoleAppenderlog4j.appender.console.Target = System.outlog4j.appender.console.Threshold=DEBUGlog4j.appender.console.layout = org.apache.log4j.PatternLayoutlog4j.appender.console.layout.ConversionPattern=[%c]-%m%n#æ–‡ä»¶è¾“å‡ºçš„ç›¸å…³è®¾ç½®log4j.appender.file = org.apache.log4j.RollingFileAppenderlog4j.appender.file.File=./log/xiaoliu.loglog4j.appender.file.MaxFileSize=10mblog4j.appender.file.Threshold=DEBUGlog4j.appender.file.layout=org.apache.log4j.PatternLayoutlog4j.appender.file.layout.ConversionPattern=[%p][%d&#123;yy-MM-dd&#125;][%c]%m%n#æ—¥å¿—è¾“å‡ºçº§åˆ«log4j.logger.org.mybatis=DEBUGlog4j.logger.java.sql=DEBUGlog4j.logger.java.sql.Statement=DEBUGlog4j.logger.java.sql.ResultSet=DEBUGlog4j.logger.java.sql.PreparedStatement=DEBUG é…ç½®æ–‡ä»¶çš„å®ç°ï¼š 123&lt;settings&gt; &lt;setting name=&quot;logImpl&quot; value=&quot;LOG4J&quot;/&gt; &lt;/settings&gt; D:\\Java\\jdk1.8.0_191\\bin\\java.exe -ea -Didea.test.cyclic.buffer.size&#x3D;1048576 â€œ-javaagent:D:\\IntelliJ?org.apache.ibatis.transaction.jdbc.JdbcTransaction?-Opening JDBC Connection?org.apache.ibatis.datasource.pooled.PooledDataSource?-Created connection 1151844284.?org.apache.ibatis.transaction.jdbc.JdbcTransaction?-Setting autocommit to false on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@44a7bfbc]?com.xiaoliu.Dao.UserMapper.getUserById?-&#x3D;&#x3D;&gt; Preparing: select id,name,password from mybatis.user where id &#x3D; ??com.xiaoliu.Dao.UserMapper.getUserById?-&#x3D;&#x3D;&gt; Parameters: 2(Integer)?com.xiaoliu.Dao.UserMapper.getUserById?-&lt;&#x3D;&#x3D; Total: 1User{id&#x3D;2, name&#x3D;â€™å¤§åˆ˜å“¥â€™, pwd&#x3D;â€™1234â€™}?org.apache.ibatis.transaction.jdbc.JdbcTransaction?-Resetting autocommit to true on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@44a7bfbc]?org.apache.ibatis.transaction.jdbc.JdbcTransaction?-Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@44a7bfbc]?org.apache.ibatis.datasource.pooled.PooledDataSource?-Returned connection 1151844284 to pool. Process finished with exit code 0 åœ¨ä½¿ç”¨æ—¶è¦è®°å¾—åˆ°å…¥åŒ… 1import org.apache.log4j.Logger; å¹¶åœ¨è¦ä½¿ç”¨çš„ç±»ä¸‹é¢ä½¿ç”¨å½“å‰çš„class 1static Logger logger = Logger.getLogger(UserMapperTest.class); åˆ†é¡µ","categories":[],"tags":[]},{"title":"æ¯æ—¥ç®—æ³•","slug":"2022-4-12/---","date":"2022-04-12T16:33:51.713Z","updated":"2022-04-13T02:34:51.169Z","comments":true,"path":"2022/04/13/2022-4-12/---/","link":"","permalink":"https://dddwah11.github.io/2022/04/13/2022-4-12/---/","excerpt":"","text":"1234567891011121314151617181920212223242526/** * @author: 61åˆ† * @date: 2022/4/13 0:23 * @description: */public class popSort &#123; public static void main(String[] args) &#123; int[] nums=&#123;1,2,3,4,5,6,89,77&#125;; int tmp = 0; for (int i = 0; i &lt; nums.length-1; i++) &#123; for (int j = 0; j &lt; nums.length-i-1; j++) &#123; if (nums[j]&lt;nums[j+1])&#123; tmp = nums[j]; nums[j] = nums[j+1]; nums[j+1] = tmp; &#125; &#125; &#125; for (int k = 0; k &lt; nums.length; k++) &#123; System.out.println(nums[k]); &#125; &#125;&#125;","categories":[],"tags":[]},{"title":"Mybatis02","slug":"2022-4-12/æ¥å£å¿…é¡»å’ŒMapperé…ç½®æ–‡ä»¶åŒåæ¥å£å¿…é¡»å’ŒMapperé…ç½®æ–‡ä»¶åœ¨åŒä¸€ä¸ªåŒ…ä¸‹","date":"2022-04-12T12:09:05.748Z","updated":"2022-04-13T06:25:59.754Z","comments":true,"path":"2022/04/12/2022-4-12/æ¥å£å¿…é¡»å’ŒMapperé…ç½®æ–‡ä»¶åŒåæ¥å£å¿…é¡»å’ŒMapperé…ç½®æ–‡ä»¶åœ¨åŒä¸€ä¸ªåŒ…ä¸‹/","link":"","permalink":"https://dddwah11.github.io/2022/04/12/2022-4-12/%E6%8E%A5%E5%8F%A3%E5%BF%85%E9%A1%BB%E5%92%8CMapper%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%90%8C%E5%90%8D%E6%8E%A5%E5%8F%A3%E5%BF%85%E9%A1%BB%E5%92%8CMapper%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%9C%A8%E5%90%8C%E4%B8%80%E4%B8%AA%E5%8C%85%E4%B8%8B/","excerpt":"","text":"æ˜ å°„å™¨ æ¥å£å¿…é¡»å’ŒMapperé…ç½®æ–‡ä»¶åŒå æ¥å£å¿…é¡»å’ŒMapperé…ç½®æ–‡ä»¶åœ¨åŒä¸€ä¸ªåŒ…ä¸‹ ç”Ÿå‘½å‘¨æœŸåŠå…¶ä½œç”¨åŸŸ ç”Ÿå‘½å‘¨æœŸç±»åˆ«æ˜¯è‡³å…³é‡è¦çš„ï¼Œå› ä¸ºé”™è¯¯çš„ä½¿ç”¨ä¼šå¯¼è‡´éå¸¸ä¸¥é‡çš„å¹¶å‘é—®é¢˜ã€‚ å±æ€§åå’Œå­—æ®µåçš„ä¸ä¸€è‡´ åˆ©ç”¨resultMapï¼ˆç»“æœé›†æ˜ å°„ï¼‰ UserMapper.xmlï¼š 12345678910111213141516171819&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;&lt;mapper namespace=&quot;com.xiaoliu.Dao.UserMapper&quot;&gt;&lt;!-- ç»“æœé›†æ˜ å°„--&gt; &lt;!-- columnä¸ºæ•°æ®åº“ä¸­çš„å­—æ®µåï¼Œpropertyä¸ºå®ä½“ç±»ä¸­çš„å±æ€§--&gt; &lt;resultMap id=&quot;UserMap&quot; type=&quot;com.xiaoliu.pojo.User&quot;&gt;&lt;!-- &lt;result property=&quot;id&quot; column=&quot;id&quot;/&gt;--&gt;&lt;!-- &lt;result property=&quot;name&quot; column=&quot;name&quot;/&gt;--&gt; &lt;result property=&quot;pwd&quot; column=&quot;password&quot;/&gt; &lt;/resultMap&gt; &lt;select id=&quot;getUserById&quot; resultMap=&quot;UserMap&quot;&gt; select id,name,password from mybatis.user where id = #&#123;id&#125; &lt;/select&gt;&lt;/mapper&gt; æµ‹è¯•ç±»ï¼š 1234567891011121314public class UserMapperTest &#123; @Test public void getUserById()&#123; SqlSession sqlSession = MybatisUtils.getSqlSession();// è·å–æ¥å£ UserMapper mapper = sqlSession.getMapper(UserMapper.class); User user = mapper.getUserById(2); System.out.println(user); sqlSession.close(); &#125;&#125; ç»“æœï¼š User{id&#x3D;2, name&#x3D;â€™å¤§åˆ˜å“¥â€™, pwd&#x3D;â€™1234â€™} Process finished with exit code 0","categories":[],"tags":[]},{"title":"Mybatisåˆå­¦","slug":"2022-4-11/Mybatis","date":"2022-04-11T14:31:27.955Z","updated":"2022-04-12T06:43:05.888Z","comments":true,"path":"2022/04/11/2022-4-11/Mybatis/","link":"","permalink":"https://dddwah11.github.io/2022/04/11/2022-4-11/Mybatis/","excerpt":"","text":"Mybatis1ã€ä»€ä¹ˆæ˜¯Mybatisâ€‹ MyBatisæœ¬æ˜¯apacheçš„ä¸€ä¸ªå¼€æºé¡¹ç›®iBatisï¼Œ2010å¹´è¿™ä¸ªé¡¹ç›®ç”±apache software foundationè¿ç§»åˆ°äº†[google code](https://baike.baidu.com/item/google code&#x2F;2346604)ï¼Œå¹¶ä¸”æ”¹åä¸ºMyBatisã€‚2013å¹´11æœˆè¿ç§»åˆ°Githubã€‚ â€‹ iBATISä¸€è¯æ¥æºäºâ€œinternetâ€å’Œâ€œabatisâ€çš„ç»„åˆï¼Œæ˜¯ä¸€ä¸ªåŸºäºJavaçš„æŒä¹…å±‚æ¡†æ¶ã€‚iBATISæä¾›çš„æŒä¹…å±‚æ¡†æ¶åŒ…æ‹¬SQL Mapså’ŒData Access Objectsï¼ˆDAOsï¼‰ã€‚ â€‹ å½“å‰ï¼Œæœ€æ–°ç‰ˆæœ¬æ˜¯MyBatis 3.5.9ï¼Œå…¶å‘å¸ƒæ—¶é—´æ˜¯2021å¹´12æœˆ26æ—¥ã€‚ 2ã€æŒä¹…åŒ–â€‹ æŒä¹…åŒ–æ˜¯å°†ç¨‹åºæ•°æ®åœ¨æŒä¹…çŠ¶æ€å’Œç¬æ—¶çŠ¶æ€é—´è½¬æ¢çš„æœºåˆ¶ã€‚é€šä¿—çš„è®²ï¼Œå°±æ˜¯ç¬æ—¶æ•°æ®ï¼ˆæ¯”å¦‚å†…å­˜ä¸­çš„æ•°æ®ï¼Œæ˜¯ä¸èƒ½æ°¸ä¹…ä¿å­˜çš„ï¼‰æŒä¹…åŒ–ä¸ºæŒä¹…æ•°æ®ï¼ˆæ¯”å¦‚æŒä¹…åŒ–è‡³æ•°æ®åº“ä¸­ï¼Œèƒ½å¤Ÿé•¿ä¹…ä¿å­˜ï¼‰ã€‚ 3ã€æŒä¹…å±‚â€‹ å¯ä»¥ç†è§£æˆæ•°æ® ä¿å­˜åœ¨ æ•°æ®åº“æˆ–è€… ç¡¬ç›˜ä¸€ç±»å¯ä»¥ä¿å­˜å¾ˆé•¿æ—¶é—´çš„è®¾å¤‡é‡Œé¢ï¼Œä¸åƒæ”¾åœ¨å†…å­˜ä¸­é‚£æ ·æ–­ç”µå°±æ¶ˆå¤±äº†ï¼Œä¹Ÿå°±æ˜¯æŠŠæ•°æ®å­˜åœ¨æŒä¹…åŒ–è®¾å¤‡ä¸Šï¼Œmybatiså°±æ˜¯æŒä¹…å±‚ã€‚ å†…å­˜ï¼šæ–­ç‚¹å³å¤± 4ã€Mavené¡¹ç›®ä¸‹åˆ›å»ºç¬¬ä¸€ä¸ªmybatisç¨‹åº4.1 å¯¼å…¥ä¾èµ–ï¼šmysqlé©±åŠ¨ã€mybatisã€lombokã€‚æ³¨æ„ï¼šmavenèµ„æºå¯¼å‡ºé—®é¢˜ï¼šæœ€å¥½ï¼Œçˆ¶ç±»ï¼Œå­ç±»éƒ½æ·»åŠ 1234567891011121314151617181920&lt;build&gt; &lt;resources&gt; &lt;resource&gt; &lt;directory&gt;src/main/resources&lt;/directory&gt; &lt;includes&gt; &lt;include&gt;**/*.properties&lt;/include&gt; &lt;include&gt;**/*.xml&lt;/include&gt; &lt;/includes&gt; &lt;filtering&gt;true&lt;/filtering&gt; &lt;/resource&gt; &lt;resource&gt; &lt;directory&gt;src/main/java&lt;/directory&gt; &lt;includes&gt; &lt;include&gt;**/*.properties&lt;/include&gt; &lt;include&gt;**/*.xml&lt;/include&gt; &lt;/includes&gt; &lt;filtering&gt;true&lt;/filtering&gt; &lt;/resource&gt; &lt;/resources&gt;&lt;/build&gt; æ­å¥½é¡¹ç›®ç»“æ„ï¼š 4.3ã€å»mybatisä¸­æ–‡æ–‡æ¡£ ç²˜è´´éœ€è¦ç”¨åˆ°çš„æ ¸å¿ƒé…ç½®æ–‡ä»¶123456789101112131415161718192021&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;&lt;!DOCTYPE configuration PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;&lt;configuration&gt; &lt;environments default=&quot;development&quot;&gt; &lt;environment id=&quot;development&quot;&gt; &lt;transactionManager type=&quot;JDBC&quot;/&gt; &lt;dataSource type=&quot;POOLED&quot;&gt; &lt;property name=&quot;driver&quot; value=&quot;com.mysql.cj.jdbc.Driver&quot;/&gt; &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://localhost:3306/mybatis?userSSL=true&amp;amp;userUnicode=true&amp;amp;characterEncoding=UTF-8&amp;amp;serverTimezone=UTC&quot;/&gt; &lt;property name=&quot;username&quot; value=&quot;root&quot;/&gt; &lt;property name=&quot;password&quot; value=&quot;123456&quot;/&gt; &lt;/dataSource&gt; &lt;/environment&gt; &lt;/environments&gt;&lt;!-- æ³¨å†ŒMapper--&gt; &lt;mappers&gt; &lt;mapper resource=&quot;com/xiaoliu/Mapper/UserMapper.xml&quot;/&gt; &lt;/mappers&gt;&lt;/configuration&gt; æ³¨æ„ï¼šæ³¨å†Œmapper 4.4ã€ç¼–å†™å®ä½“ç±»User123456789101112131415161718192021package com.xiaoliu.pojo;import lombok.AllArgsConstructor;import lombok.Data;import lombok.NoArgsConstructor;/** * @author: 61åˆ† * @date: 2022/4/11 17:35 * @description: */@Data@NoArgsConstructor@AllArgsConstructorpublic class User &#123; private int id; private String name; private String password;&#125; 4.5ã€ç¼–å†™Mapperæ¥å£åŠå®ç°çš„é…ç½®æ–‡ä»¶1234567891011&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;&lt;!--namespace=ç»‘å®šå¯¹åº”çš„Mapperæ¥å£--&gt;&lt;mapper namespace=&quot;com.xiaoliu.Mapper.UserMapper&quot;&gt;&lt;!-- idå¯¹åº”çš„æ˜¯æ–¹æ³•åç§°--&gt; &lt;select id=&quot;getUserList&quot; resultType=&quot;com.xiaoliu.pojo.User&quot;&gt; select * from mybatis.user &lt;/select&gt;&lt;/mapper&gt; é…ç½®æ–‡ä»¶ UserMappeæ¥å£ 123456789101112131415package com.xiaoliu.Mapper;import com.xiaoliu.pojo.User;import java.util.List;/** * @author: 61åˆ† * @date: 2022/4/11 17:41 * @description: */public interface UserMapper &#123; List&lt;User&gt; getUserList();&#125; â€‹ 4.6ã€ç¼–å†™MybatisUtilç±»è·å–SQLSession æ‰§è¡ŒSQLSession 123456789101112131415161718192021222324252627282930313233343536package com.xiaoliu.utils;import org.apache.ibatis.io.Resources;import org.apache.ibatis.session.SqlSession;import org.apache.ibatis.session.SqlSessionFactory;import org.apache.ibatis.session.SqlSessionFactoryBuilder;import java.io.IOException;import java.io.InputStream;/** * @author: 61åˆ† * @date: 2022/4/11 15:55 * @description:è·å–SQLSessionFactory */public class MybatisUtils &#123; private static SqlSessionFactory sqlSessionFactory; static &#123; try &#123;// è·å–SQLSessionFactory-ã€‹SQLSession String resource = &quot;mybatis-config.xml&quot;; InputStream inputStream = Resources.getResourceAsStream(resource); sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; &#125; // æ—¢ç„¶æœ‰äº† SqlSessionFactoryï¼Œé¡¾åæ€ä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥ä»ä¸­è·å¾— SqlSession çš„å®ä¾‹ã€‚ // SqlSession æä¾›äº†åœ¨æ•°æ®åº“æ‰§è¡Œ SQL å‘½ä»¤æ‰€éœ€çš„æ‰€æœ‰æ–¹æ³•ã€‚// ä½ å¯ä»¥é€šè¿‡ SqlSession å®ä¾‹æ¥ç›´æ¥æ‰§è¡Œå·²æ˜ å°„çš„ SQL è¯­å¥ã€‚ public static SqlSession getSqlSession()&#123; return sqlSessionFactory.openSession(); &#125;&#125; 4.7ã€ç¼–å†™Testç±»è¿›è¡Œæµ‹è¯•1234567891011121314151617181920212223242526272829303132333435package com.xiaoliu.Mapper;import com.xiaoliu.pojo.User;import com.xiaoliu.utils.MybatisUtils;import org.apache.ibatis.session.SqlSession;import org.junit.Test;import java.util.List;/** * @author: 61åˆ† * @date: 2022/4/11 18:00 * @description: */public class UserMapperTest &#123; @Test public void test()&#123;// ç¬¬ä¸€æ­¥ï¼šè·å¾—sqlSessionå¯¹è±¡ SqlSession sqlSession = MybatisUtils.getSqlSession(); System.out.println(&quot;getsqlSession&quot;);// ç¬¬äºŒæ­¥ï¼Œæ–¹å¼ä¸€ï¼šgetMapper UserMapper mapper = sqlSession.getMapper(UserMapper.class); List&lt;User&gt; userList = mapper.getUserList(); System.out.println(&quot;getMapper&quot;); for (User user : userList) &#123; System.out.println(user); &#125;// å…³é—­sqlSession System.out.println(&quot;close&quot;); sqlSession.close(); &#125;&#125; æµ‹è¯•æˆåŠŸï¼š 5ã€å­¦ä¹ æ€»ç»“â€‹ æ³¨æ„æ³¨å†ŒMapperï¼ŒåŠmavenèµ„æºå¯¼å‡ºçš„é—®é¢˜","categories":[],"tags":[]},{"title":"è¿™æ˜¯ä¸ªæµ‹è¯•å—","slug":"we","date":"2022-03-22T12:51:06.905Z","updated":"2022-04-13T02:33:54.749Z","comments":true,"path":"2022/03/22/we/","link":"","permalink":"https://dddwah11.github.io/2022/03/22/we/","excerpt":"","text":"è¿™æ˜¯ä¸ªæµ‹è¯•å—","categories":[],"tags":[]},{"title":"æ¬¢è¿æ¥åˆ°å°åˆ˜çš„åšå®¢","slug":"hello-world","date":"2022-03-21T10:01:26.447Z","updated":"2022-04-15T13:06:03.955Z","comments":true,"path":"2022/03/21/hello-world/","link":"","permalink":"https://dddwah11.github.io/2022/03/21/hello-world/","excerpt":"","text":"æš‚æ—¶ä¸çŸ¥é“å†™ç‚¹å•¥","categories":[],"tags":[]}],"categories":[],"tags":[]}